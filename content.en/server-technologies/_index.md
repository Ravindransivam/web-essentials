---
title: 'Rich Internet Application Server Technologies'
weight: 4
---

  

**PART**

_Rich Internet Application Server Technologies_

_One of the powerful things about networking technology like the Internet or the Web or the Se- mantic Web...is that the things we’ve just done with them far surpass the imagination of the peo- ple who invented them._

—Tim Berners-Lee, interviewed by Peter Moon, IDG Now

4  

21 Web Servers (IIS and Apache)

**O B J E C T I V E S** In this chapter you will learn:

■ To understand a web server’s functionality.

■ To introduce Microsoft Internet Information Services (IIS) and Apache HTTP Server.

■ To set up virtual directories from which content can be served.

■ To test whether you set up the virtual directory properly.

**_Stop abusing my verses, or publish some of your own._ —Martial**

**_There are three difficulties in authorship: to write anything worth the publishing, to find honest men to publish it, and to get sensible men to read it._ —Charles Caleb Colton**

**_When your Daemon is in charge, do not try to think consciously. Drift, wait and obey._ —Rudyard Kipling**  

21.1 Introduction **859 O**

**u tl**

**in e**

**21.1 Introduction** In this chapter, we discuss the specialized software—called a **web server**—that responds to client requests (typically from a web browser) by providing resources such as XHTML documents. For example, when users enter a Uniform Resource Locator (URL) address, such as www.deitel.com, into a web browser, they are requesting a specific document from a web server. The web server maps the URL to a resource on the server (or to a file on the server’s network) and returns the requested resource to the client. During this interaction, the web server and the client communicate using the platform-independent Hypertext Transfer Protocol (HTTP), a protocol for transferring requests and files over the Internet or a local intranet.

Our web server discussion introduces **Microsoft Internet Information Services (IIS)** and the open source **Apache HTTP Server**. Sections 21.6 and 21.7 discuss IIS and Apache, respectively.

**21.2 HTTP Transactions** In this section, we discuss what occurs behind the scenes when a user requests a web page in a browser. The HTTP protocol allows clients and servers to interact and exchange in- formation in a uniform and reliable manner.

In its simplest form, a web page is nothing more than an XHTML document that describes to a web browser how to display and format the document’s information. XHTML documents normally contain hyperlinks that link to different pages or to other parts of the same page. When the user clicks a hyperlink, the requested web page loads into the user’s web browser. Similarly, the user can type the address of a page into the browser’s address field.

**_URIs_** HTTP uses URIs (Uniform Resource Identifiers) to identify data on the Internet. URIs that specify document locations are called URLs (Uniform Resource Locators). Common URLs refer to files, directories or objects that perform complex tasks, such as database

**21.1** Introduction **21.2** HTTP Transactions **21.3** Multitier Application Architecture **21.4** Client-Side Scripting versus Server-Side Scripting **21.5** Accessing Web Servers **21.6** Microsoft Internet Information Services (IIS)

**21.6.1** Microsoft Internet Information Services (IIS) 5.1 and 6.0 **21.6.2** Microsoft Internet Information Services (IIS) 7.0

**21.7** Apache HTTP Server **21.8** Requesting Documents **21.9** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

**860** Chapter 21 Web Servers (IIS and Apache)

lookups and Internet searches. If you know the URL of a publicly available resource or file anywhere on the web, you can access it through HTTP.

**_Parts of a URL_** A URL contains information that directs a browser to the resource that the user wishes to access. Computers that run **web server** software make such resources available. Let’s exam- ine the components of the URL

http://www.deitel.com/books/downloads.html

The http:// indicates that the resource is to be obtained using the HTTP protocol. The middle portion, www.deitel.com, is the server’s fully qualified **hostname**—the name of the server on which the resource resides. This computer usually is referred to as the **host**, because it houses and maintains resources. The hostname www.deitel.com is translated into an **IP address**—a unique numerical value that identifies the server much as a tele- phone number uniquely defines a particular phone line. More information on IP addresses is available at en.wikipedia.org/wiki/IP\_address. This translation is performed by a **domain name system (DNS) server**—a computer that maintains a database of hostnames and their corresponding IP addresses—and the process is called a **DNS lookup**.

The remainder of the URL (i.e., /books/downloads.html) specifies both the name of the requested resource (the XHTML document downloads.html) and its path, or location (/books), on the web server. The path could specify the location of an actual directory on the web server’s file system. For security reasons, however, the path normally specifies the location of a **virtual directory**. The server translates the virtual directory into a real loca- tion on the server (or on another computer on the server’s network), thus hiding the true location of the resource. Some resources are created dynamically using other information stored on the server computer, such as a database. The hostname in the URL for such a resource specifies the correct server; the path and resource information identify the resource with which to interact to respond to the client’s request.

**_Making a Request and Receiving a Response_** When given a URL, a web browser performs a simple HTTP transaction to retrieve and display the web page found at that address. Figure 21.1 illustrates the transaction, showing the interaction between the web browser (the client side) and the web server application (the server side).

In Fig. 21.1, the web browser sends an HTTP request to the server. The request (in its simplest form) is

GET /books/downloads.html HTTP/1.1

The word **GET** is an **HTTP method** indicating that the client wishes to obtain a resource from the server. The remainder of the request provides the path name of the resource (e.g., an XHTML document) and the protocol’s name and version number (HTTP/1.1). The cli- ent’s request also contains some required and optional headers.

Any server that understands HTTP (version 1.1) can translate this request and respond appropriately. Figure 21.2 depicts the server responding to a request. The server first responds by sending a line of text that indicates the HTTP version, followed by a numeric code and a phrase describing the status of the transaction. For example,

HTTP/1.1 200 OK  

21.2 HTTP Transactions **861**

indicates success, whereas

HTTP/1.1 404 Not found

informs the client that the web server could not locate the requested resource. A complete list of numeric codes indicating the status of an HTTP transaction can be found at www.w3.org/Protocols/rfc2616/rfc2616-sec10.html.

**_HTTP Headers_** The server then sends one or more **HTTP headers**, which provide additional information about the data that will be sent. In this case, the server is sending an XHTML text docu- ment, so one HTTP header for this example would read:

Content-type: text/html

The information provided in this header specifies the **Multipurpose Internet Mail Exten- sions (MIME)** type of the content that the server is transmitting to the browser. MIME is an Internet standard that specifies data formats so that programs can interpret data cor- rectly. For example, the MIME type text/plain indicates that the sent information is text that can be displayed directly, without any interpretation of the content as XHTML mark-

**Fig. 21.1** | Client interacting with web server. _Step 1:_ The GET request.

**Fig. 21.2** | Client interacting with web server. _Step 2:_ The HTTP response.

After it receives the request, the web server uses information in the URL to locate the resource.

(b)

The GET request is sent from the client to the web server.

(a)

Web server

Internet

Client

The server responds to the request with an appropriate message and the resource's contents.

Web server

Internet

Client  

**862** Chapter 21 Web Servers (IIS and Apache)

up. Similarly, the MIME type image/jpeg indicates that the content is a JPEG image. When the browser receives this MIME type, it attempts to display the image.

The header or set of headers is followed by a blank line, which indicates to the client browser that the server is finished sending HTTP headers. The server then sends the con- tents of the requested XHTML document (downloads.html). The client-side browser parses the XHTML markup it receives and renders (or displays) the results. The server nor- mally keeps the connection open to process other requests from the client.

**_HTTP get and post Requests_** The two most common **HTTP request types** (also known as **request methods**) are get and post. A get request typically gets (or retrieves) information from a server. Common uses of get requests are to retrieve an XHTML document or an image, or to fetch search results based on a user-submitted search term. A post request typically posts (or sends) data to a server. Common uses of post requests are to send form data or documents to a server.

An HTTP request often posts data to a **server-side form handler** that processes the data. For example, when a user performs a search or participates in a web-based survey, the web server receives the information specified in the XHTML form as part of the request. Get requests and post requests can both be used to send form data to a web server, yet each request type sends the information differently.

A get request sends information to the server as part of the URL, e.g., www.google.com/search?q=deitel. In this case search is the name of Google’s server- side form handler, q is the name of a variable in Google’s search form and deitel is the search term. Notice the ? in the preceding URL. A ? separates the **query string** from the rest of the URL in a request. A _name_/_value_ pair is passed to the server with the _name_ and the _value_ separated by an equals sign (=). If more than one _name_/_value_ pair is submitted, each pair is separated by an ampersand (&). The server uses data passed in a query string to retrieve an appropriate resource from the server. The server then sends a **response** to the client. A get request may be initiated by submitting an XHTML form whose method

attribute is set to "get", or by typing the URL (possibly containing a query string) directly into the browser’s address bar (See Chapter 2 for more information on how various search engines operate and Chapter 4 for an in-depth discussion of XHTML forms.)

A post request is specified in an XHTML form by the method "post". The post

method sends form data as part of the HTTP message, not as part of the URL. A get

request typically limits the query string (i.e., everything to the right of the ?) to a specific number of characters (2083 in IE; more in other browsers), so it is often necessary to send large pieces of information using the post method. The post method is also sometimes preferred because it hides the submitted data from the user by embedding it in an HTTP message. If a form submits several hidden input values along with user-submitted data, the post method might generate a URL like www.searchengine.com/search. The form data still reaches the server and is processed in a similar fashion to a get request, but the user does not see the exact information sent.

**Software Engineering Observation 21.1** _The data sent in a post request is not part of the URL and the user can’t see the data by default. However there are tools available that expose this data, so you should not assume that the data is secure just because a post request is used._ 21.1  

21.3 Multitier Application Architecture **863**

**_Client-Side Caching_** Browsers often **cache** (save on disk) web pages for quick reloading. If there are no changes between the version stored in the cache and the current version on the web, this speeds up your browsing experience. An HTTP response can indicate the length of time for which the content remains “fresh.” If this amount of time has not been reached, the browser can avoid another request to the server. If not, the browser loads the document from the cache. Thus, the browser minimizes the amount of data that must be downloaded for you to view a web page. Browsers typically do not cache the server’s response to a post request, because the next post might not return the same result. For example, in a survey, many users could visit the same web page and answer to a question. The survey results could then be dis- played for the user. Each new answer changes the overall results of the survey.

When you use a web-based search engine, the browser normally supplies the informa- tion you specify in an HTML form to the search engine with a get request. The search engine performs the search, then returns the results to you as a web page. Such pages are sometimes cached by the browser in case you perform the same search again.

**21.3 Multitier Application Architecture** Web-based applications are **multitier applications** (sometimes referred to as **_n_\-tier appli- cations**) that divide functionality into separate **tiers** (i.e., logical groupings of functional- ity). Although tiers can be located on the same computer, the tiers of web-based applications often reside on separate computers. Figure 21.3 presents the basic structure of a **three-tier web-based application**.

The **bottom tier** (also called the data tier or the information tier) maintains the appli- cation’s data. This tier typically stores data in a relational database management system (RDBMS). We discuss RDBMSs in Chapter 22. For example, a retail store might have an inventory information database containing product descriptions, prices and quantities in stock. Another database might contain customer information, such as user names, billing addresses and credit card numbers. These may reside on one or more computers, which together comprise the application’s data.

The **middle tier** implements business logic, controller logic and presentation logic to control interactions between the application’s clients and its data. The middle tier acts as an intermediary between data in the information tier and the application’s clients. The middle-tier **controller logic** processes client requests (such as requests to view a product

**Fig. 21.3** | Three-tier architecture.

Web server Database

Middle tier Bottom tierTop tier

Browser XHTML JDBC

_also called also calledalso called_ Business logic tier Data tier _or_

Information tier User interface tier _or_

Client tier  

**864** Chapter 21 Web Servers (IIS and Apache)

catalog) and retrieves data from the database. The middle-tier **presentation logic** then pro- cesses data from the information tier and presents the content to the client. Web applica- tions typically present data to clients as XHTML documents.

**Business logic** in the middle tier enforces **business rules** and ensures that data is reli- able before the application updates a database or presents data to users. Business rules dic- tate how clients access data, and how applications process data. For example, a business rule in the middle tier of a retail store’s web-based application might ensure that all product quantities remain positive. A client request to set a negative quantity in the bottom tier’s product information database would be rejected by the middle tier’s business logic.

The **top tier**, or client tier, is the application’s user interface, which gathers input and displays output. Users interact directly with the application through the user interface, which is typically a web browser, keyboard and mouse, or a mobile device. In response to user actions (e.g., clicking a hyperlink), the client tier interacts with the middle tier to make requests and to retrieve data from the information tier. The client tier then displays the data retrieved for the user. The client tier never directly interacts with the information tier.

**21.4 Client-Side Scripting versus Server-Side Scripting** In earlier chapters, we focused on client-side scripting with JavaScript. Client-side script- ing can be used to validate user input, to interact with the browser, to enhance web pages by manipulating the DOM of a page, and to add Ajax functionality.

Client-side scripting does have limitations, such as browser dependency; the browser or **scripting host** must support the scripting language and capabilities. Scripts are restricted from accessing the local hardware and filesystem for security reasons. Another issue is that client-side scripts can be viewed by the client by using the browser’s source- viewing capability. Sensitive information, such as passwords or other personally identifi- able data, should not be on the client. All client-side data validation should be mirrored on the server. Also, placing certain operations in JavaScript on the client can open web applications to attack and other security issues.

Programmers have more flexibility with **server-side scripts**, which often generate custom responses for clients. For example, a client might connect to an airline’s web server and request a list of flights from Boston to San Antonio between April 19th and May 5th. The server queries the database, dynamically generates XHTML content containing the flight list and sends the XHTML to the client. This technology allows clients to obtain the most current flight information from the database by connecting to an airline’s web server.

Server-side scripting languages have a wider range of programmatic capabilities than their client-side equivalents. For example, server-side scripts often can access the server’s file directory structure, whereas client-side scripts cannot access the client’s directories.

Server-side scripts also have access to server-side software that extends server function- ality—Microsoft web servers use **ISAPI (Internet Server Application Program Interface) extensions** and Apache HTTP Servers use **modules**. Components and modules range from programming language support to counting the number of web-page hits. We dis- cuss some of these components and modules in the remaining chapters of the book.

**Software Engineering Observation 21.2** _Properly configured server-side script source code is not visible to the client; only XHTML and any client-side scripts are visible to the client._ 21.2  

21.5 Accessing Web Servers **865**

**21.5 Accessing Web Servers** To request documents from web servers, users must know the hostnames on which the web server software resides. Users can request documents from **local web servers** (i.e., ones residing on users’ machines) or **remote web servers** (i.e., ones residing on different ma- chines).

Local web servers can be accessed through your computer’s name or through the name **localhost**—a hostname that references the local machine and normally translates to the IP address 127.0.0.1 (known as the **loopback address**). We sometimes use localhost in this book for demonstration purposes. To display the machine name in Windows XP, Windows Server 2003, Windows Vista, Mac OS X or Linux, run the hostname command in a command prompt or terminal window.

A remote web server referenced by a fully qualified hostname or an IP address can also serve documents. In the URL http://www.deitel.com/books/downloads.html, the middle portion, www.deitel.com, is the server’s fully qualified hostname.

**_Windows Firewall Settings_** If you’d like to test your web server over a network, you may need to change your Win- dows Firewall settings. For security reasons, Windows Firewall does not allow remote ac- cess to a web server on your local computer by default. To change this, open the Windows Firewall utility in the Windows Control Panel. Click the **Advanced** tab and select your network connection from the **Network Connection Settings** list, then click **Settings…**. On the **Services** tab of the **Advanced Settings** dialog, ensure that **Web Server (HTTP)** is checked.

**21.6 Microsoft Internet Information Services (IIS) Microsoft Internet Information Services (IIS)** is a web server that is included with several versions of Windows. Installing IIS enables a computer to serve documents. To install IIS 5.1 on Windows XP Professional, open the **Add or Remove Programs** control panel, click **Add/Remove Windows Components**, check the checkbox next to **Internet Information Ser- vices (IIS)**, and click **Next >**. You may need the original operating system disk to complete the installation. For IIS 6.0 on Windows Server 2003 and IIS 7.0 on Windows Vista, the software should already be installed (but is also on your installation disk). The remainder of this section assumes that either IIS 5.1, IIS 6.0 or IIS 7.0 is installed on your system. In Windows Server 2003, you’ll need to use the **Manager Your Server** window to add the **Ap- plication Server** role. In Windows Vista, go to the **Control Panel**, select **Programs**, then se- lect **Turn Windows Features On or Off**.

The following subsections explain how to configure IIS 5.1, IIS 6.0 and IIS 7.0 to serve documents via HTTP. If you are using Windows XP or Windows Server 2003, see Section 21.6.1. If you are using Windows Vista, skip to Section 21.6.2.

**21.6.1 Microsoft Internet Information Services (IIS) 5.1 and 6.0** Start the Internet services manager by clicking the **Start** button and opening the **Control Panel**. If the **Control Panel** is currently in **Category View**, click **Switch to Classic View**. Then, double click the **Administrative Tools** icon and double click the **Internet Services Manager** icon (**Internet Information Services (IIS) Manager** in Windows Server 2003). For Windows XP, this opens the **Internet Information Services** window (Fig. 21.4)—the administration  

**866** Chapter 21 Web Servers (IIS and Apache)

program for IIS 5.1. For Windows Server 2003, this opens the (**Internet Information Ser- vices (IIS) Manager**, which provides the same capabilities. Alternatively, you can type inetmgr at the **Start** menu’s **Run...** command prompt to open this window. You place doc- uments that will be requested from IIS either in the website’s **default directory** (i.e., C:\\Inetpub\\wwwroot) or in a **virtual directory**. A virtual directory is an alias for an existing directory that resides on the local machine (e.g., C:\\) or on the network. When a server is accessed from a web browser, content in the default directory and virtual directories is vis- ible to the client.

In the window, the left pane contains the web server’s directory structure. The name of the machine running IIS (e.g., **RESILIANT**) is listed under **Internet Information Services**. Clicking the **\+** symbol to the left of the machine name displays **Default Web Site** (and pos- sibly several other nodes).

Expand the **Default Web Site** directory by clicking the **\+** to the left of it. In this direc- tory, we will create a virtual directory for the website. Most web documents are placed in the web server’s wwwroot directory or one of its subdirectories. For this example, we create a directory in the wwwroot directory and have our virtual directory point to it. To create a virtual directory in this directory, right click **Default Web Site** and select **New > Virtual Directory…**. This starts the **Virtual Directory Creation Wizard** (Fig. 21.5), which guides you through creating a virtual directory.

**Fig. 21.4** | **Internet Information Services** window of IIS 5.1.

**Fig. 21.5** | **Virtual Directory Creation Wizard** welcome page.  

21.6 Microsoft Internet Information Services (IIS) **867**

To begin, click **Next >** in the **Virtual Directory Creation Wizard** welcome page. In the **Virtual Directory Alias** page (Fig. 21.6), enter a name for the virtual directory and click **Next >**. We use the name Chapter21Test, although the virtual directory may have any name, provided that it does not conflict with an existing virtual directory name.

In the **Web Site Content Directory** page (Fig. 21.7), enter the path for the directory containing the documents that clients will view. We created a directory named C:\\Chapter21Examples that serves our documents. You can select the **Browse** button to navigate to the desired directory or to create a new one. Click **Next >**.

The **Access Permissions** page (Fig. 21.8) presents the virtual directory **security level** choices. Choose the access level appropriate for a web document. The **Read** option allows users to read and download files located in the directory. The **Run scripts (such as ASP)**

**Fig. 21.6** | **Virtual Directory Alias** page of the **Virtual Directory Creation Wizard.**

**Fig. 21.7** | **Web Site Content Directory** page of the **Virtual Directory Creation Wizard.**  

**868** Chapter 21 Web Servers (IIS and Apache)

option allows scripts to run in the directory. The **Execute (such as ISAPI applications or CGI)** option allows applications to run in the directory. The **Write** option allows a web page to write to files on the server, which could be a security risk. The **Browse** option allows users to see a full list of the folder’s files through a web browser. By default, **Read** and **Run scripts** are enabled. Click **Next >**.

Click **Finish** to complete the creation of the virtual directory and exit the **Virtual Direc- tory Creation Wizard**. The newly created virtual directory, Chapter21Test, is now part of the **Default Web Site**. The IIS server is configured to serve documents through the Chapter21Test virtual directory. The URL http://localhost/Chapter21Test now ref- erences the C:\\Chapter21Examples directory.

To start IIS so it can serve content, right click **Default Web Site** and select **Start**. If you need to stop IIS, right click **Default Web Site** and select **Stop**. The web server is not avail- able to serve content if it is stopped.

**21.6.2 Microsoft Internet Information Services (IIS) 7.0** To start the **Internet Information Services (IIS) Manager**, click the start ( ) button, se- lect the **Control Panel**, click **Classic View**, double click the **Administrative Tools** icon and double click the **Internet Information Services (IIS) Manager** icon. Click **Continue** in the di- alog that appears to display the **Internet Information Services (IIS) Manager** window (Fig. 21.9)—the administration program for IIS 7.0. You place documents that will be re- quested from IIS either in the **default directory** (i.e., C:\\Inetpub\\wwwroot) or in a **virtual directory**. A virtual directory is an alias for an existing directory that resides on the local machine (e.g., C:\\) or on the network. When a server is accessed from a browser, only the default directory and virtual directories are visible to the client.

In the **Internet Information Services (IIS) Manager** window, the left pane contains the web server’s directory structure. The name of the machine running IIS (e.g., **QUALIFLY**) is listed at the top of the **Connections** column. Clicking the arrow ( ) symbol to the left of the machine name displays **Application Pools** and **Web Sites**. The **Application Pools** folder contains tools for configuring advanced features of IIS 7.0.

**Fig. 21.8** | **Access Permissions** page of the **Virtual Directory Creation Wizard.**  

21.6 Microsoft Internet Information Services (IIS) **869**

Expand **Web Sites** by clicking the arrow ( ) to the left of it. This should display **Default Web Site.** Expand **Default Web Site** by clicking the arrow ( ) to the left of it. These are the folders and virtual directories in the default website. For this example, we create a virtual directory from which we request our documents. To create a virtual directory, right click **Default Web Site** and select **Add Virtual Directory…**. This displays the **Add Virtual Direc- tory** dialog (Fig. 21.10). In the **Alias:** field, enter a name for the virtual directory. We use the name Chapter21Test, although the virtual directory may have any name, provided that it does not conflict with an existing virtual directory. In the **Physical path:** field, enter the path for the directory containing the documents that clients will view. We created a directory named C:\\Chapter21Examples for our documents. If necessary, select the **…** button to navigate to the desired directory or to create a new one. Click **OK** to create the new virtual directory.

In Windows Vista, before you can use IIS, you must enable the World Wide Web Publishing Service (W3SVC). To do so, go to the start ( ) button, select **Control Panel**, select **Classic View**, double click **Administrative Tools** and double click **Services**. This dis- plays the **Services** window. Locate **World Wide Web Publishing Service** in the list of ser- vices, then right click it and select **Properties**. In the window that appears, change the **Startup type:** option to **Automatic**, then click **OK**. Next, right click **World Wide Web Pub- lishing Service** again and select **Start** to run IIS so that it can accept requests.

**Fig. 21.9** | **Internet Information (IIS) Services Manager** window (IIS 7.0).  

**870** Chapter 21 Web Servers (IIS and Apache)

**21.7 Apache HTTP Server** The Apache HTTP Server, maintained by the Apache Software Foundation, is currently the most popular web server because of its stability, efficiency, portability, security and small size. It is open source software that runs on UNIX, Linux, Mac OS X, Windows and numerous other platforms.

Mac OS X and many versions of Linux come preinstalled with Apache. If your system does not have Apache preinstalled, you can obtain the Apache HTTP Server for a variety of platforms from httpd.apache.org/download.cgi. For instructions on installing ver- sion 2.2 of the Apache HTTP Server on Windows, please visit

http://httpd.apache.org/docs-2.2/platform/windows.html

After installing the Apache HTTP Server, start the application. For Windows, open the **Start** menu, select **Programs > Apache HTTP Server** \[_version number_\] **\> Control Apache Server > Monitor Apache Servers**. Double click on the **Apache Service Monitor** that appears in your **Taskbar**, select **Apache2**, and click **Start** (Fig. 21.11). For Mac OS X, you can start Apache from the **System Preferences** by opening the **Sharing** preference pane and check- ing the checkbox next to **Web Sharing**. To stop Apache in Windows, open the **Apache Ser- vice Monitor**, select your server, and click **Stop**. For Mac OS X, open the **Sharing** preference pane and uncheck the checkbox next to **Web Sharing**.

All documents that will be requested from an Apache HTTP Server must either be in the default directory (i.e., C:\\Program Files\\Apache Software Foundation\\Apache2.2\\

htdocs for Windows, /Library/WebServer/Documents for Mac OS X, and /var/www/

html or /var/www for most Linux distros) or in a directory for which an Apache HTTP Server **alias** is configured. An alias is Apache’s equivalent to Microsoft IIS’s virtual direc- tory. It is a pointer to an existing directory that resides on the local machine or on the net- work. We will create an alias for the examples in this chapter.

Instead of using an administrative utility or set of wizards, we configure the Apache HTTP Server by editing the httpd.conf file. This file contains all the information that

**Fig. 21.10** | **Add Virtual Directory** dialog.  

21.7 Apache HTTP Server **871**

the Apache HTTP Server needs to run correctly and serve web documents. For Windows, the httpd.conf file is located in the conf subdirectory of Apache’s installation directory. For Mac OS X and most Linux distros, it is located in the /etc/apache2/ directory. To edit this file, either open the httpd.conf in a text editor, or in Windows go to the **Start** menu and select **Programs > Apache HTTP Server** \[_version number_\] **\> Configure Apache Server > Edit the Apache httpd.conf Configuration File**. httpd.conf is a large text file con- taining all of Apache HTTP Server’s configuration information. In this file, any line that starts with a # is a comment that explains the various configuration options.

**Good Programming Practice 21.1** _Place a small comment near any changes you make to the Apache httpd.conf file._ 21.1

An introductory comment at the top of the httpd.conf file explains how the file is organized. After this comment, the configuration information starts with the most impor- tant, global settings. These should have been configured correctly by the Apache installer. Scroll down in the file until you have reached the section titled DocumentRoot (using your text editor’s search function will save time). The DocumentRoot setting specifies Apache’s default directory. In Windows, the default setting is:

DocumentRoot "C:/Program Files/Apache Software Foundation/Apache2.2/ htdocs"

Now, find the section starting with <IfModule alias\_module> and ending with </

IfModule>. To create an alias, we add the following lines below the comment.

\# This alias is for the examples used in Chapter 21 Alias /Chapter21Test "C:/Chapter21Examples"

This creates an alias called Chapter21Test that points to the physical directory C:\\Chapter21Examples. We use the name Chapter21Test, but any name that does not

**Fig. 21.11** | **Apache Service Monitor**. (Courtesy of The Apache Software Foundation, <http://www.apache.org/>.)  

**872** Chapter 21 Web Servers (IIS and Apache)

conflict with an existing alias is allowed. We created a directory named C:\\Chapter21Examples that contains our documents (you should specify an appropriate path on Linux or Mac OS X). Note that in both the name of the alias and the path of the directory to which the alias points we must use forward slashes (/), not backslashes (\\).

**Error-Prevention Tip 21.1** _If you place a forward slash (/) at the end of the alias name, Apache will require this slash when a document is requested from the server. For example, if your alias is /myExamples/, then a user request for http://localhost/myExamples will not work as expected. The user will need to re- quest http://localhost/myExamples/ to access the alias. If the forward slash (/) is not placed at the end of the alias name, Apache will not require this slash, and will work as expected wheth- er or not it is present in the request._ 21.1

Once we have created the alias, we must set the access settings of that directory so that users have permission to access it. The default access settings for every directory are to deny access to everybody. In order to override those settings for our new directory, C:\\Chapter21Examples, we must create a new Directory entry. We append this new Directory entry to the end of the file:

\# Begin Chapter21Examples directory access settings <Directory "C:/Chapter21Examples">

Options Indexes Order allow,deny Allow from all

</Directory> # End Chapter21Examples directory access settings

We begin by specifying the location of the directory, then proceed to configure that directory. Indexes on the Options line specifies that if an index file, such as index.html, does not exist, Apache will generate one for you that contains the filenames of every doc- ument in the directory. Order allow,deny specifies that users are permitted access by default, and are denied only if they are specifically blocked. Allow from all specifies that all users are permitted access.

Now, the Apache HTTP Server is configured to serve our web document from the C:\\Chapter21Examples directory. We need to restart the server so that our changes to httpd.conf file will take effect. Then we will be ready to request documents from the Apache HTTP Server. To restart the server, we must first stop it and start it again. Please refer to the beginning of this section for instructions on how to stop and start the Apache HTTP Server.

**21.8 Requesting Documents** This section demonstrates how an HTTP server responds to requests for XHTML docu- ments. Requesting other types of documents is similar. We discuss serving these docu- ments using the IIS and Apache HTTP Servers. The server sends XHTML documents to the client as **static web pages**. The server response for a given XHTML document is always the same. For other types of documents, such as PHP, Ruby on Rails, ASP.NET and Java- Server Faces, the appropriate language interpreter or scripting engine first generates XHT- ML content, then transmits it to the client over HTTP. These are often referred to as  

21.9 Web Resources **873**

**dynamic web pages**, because the results of these requests might vary based on numerous factors, such as user input, the time of day and current database content.

Copy test.html from the Chapter 21 examples directory into the directory C:\\Chapter21Examples (or to the directory you created in Section 21.6 or 21.7). This is the directory that is referenced by our virtual directory (Chapter21Test). \[_Note_: A file cannot be copied directly to a virtual directory, because a virtual directory is only a name referring to a physical local directory.\] To request the document from IIS or Apache, start the server, launch a web browser and enter the XHTML document’s URL (i.e., http:// localhost/Chapter21Test/test.html) in the **Address** field. Figure 21.12 displays the result of requesting test.html in Internet Explorer 7.

**21.9 Web Resources** www.deitel.com/WebServers/

The Web Servers Resource Center guides you through learning the basics behind web servers, de- ciding which server is best suited to you, and configuring and maintaining your own web server. Start your search here for resources, downloads, tutorials, documentation, books, e-books, articles, blogs and more that will help you run your own web server. www.fiddlertool.com/fiddler/

Fiddler is a freeware web debugging proxy that logs all HTTP traffic between your computer and the Internet. Fiddler allows you to inspect traffic, set breakpoints, and "fiddle" with incoming or outgoing data. The tool includes a JavaScript-based scripting system, and can be extended using any .NET language. addons.mozilla.org/en-US/firefox/addon/3829

An add-on for Firefox that enables you to view HTTP traffic as you browse the web. This can help you learn more about HTTP.

**Fig. 21.12** | Requesting test.html.

**Summary _Section 21.1 Introduction_** • A web server responds to client requests (typically from a web browser) by providing resources

such as XHTML documents. When users enter a Uniform Resource Locator (URL) address, such as www.deitel.com, into a web browser, they are requesting a specific document from a web server. The web server maps the URL to a resource on the server (or to a file on the server’s net- work) and returns the requested resource to the client.

• A web server and a client communicate using the platform-independent Hypertext Transfer Pro- tocol (HTTP), a protocol for transferring requests and files over the Internet or an intranet.  

**874** Chapter 21 Web Servers (IIS and Apache)

**_Section 21.2 HTTP Transactions_** • The HTTP protocol allows clients and servers to interact and exchange information in a uniform

and reliable manner.

• HTTP uses URIs (Uniform Resource Identifiers) to identify data on the Internet.

• URIs that specify document locations are called URLs (Uniform Resource Locators). Common URLs refer to files, directories or objects that perform complex tasks, such as database lookups and Internet searches.

• A URL contains information that directs a browser to the resource that the user wishes to access.

• http:// indicates that the resource is to be obtained using the HTTP protocol.

• The server’s fully qualified hostname is the name of the server on which the resource resides, called the host.

• A hostname is translated into an IP address—a unique numerical value which identifies the server much as a telephone number uniquely defines a particular phone line. This translation is per- formed by a domain name system (DNS) server—a computer that maintains a database of host- names and their corresponding IP addresses—and the process is called a DNS lookup.

• The remainder of the URL after the hostname specifies both the name of the requested resource and its path, or location, on the web server.

• For security reasons the path normally specifies the location of a virtual directory. The server translates the virtual directory into a real location on the server (or on another computer on the server’s network), thus hiding the true location of the resource.

• Some resources are created dynamically and do not reside anywhere on the server.

• When given a URL, a web browser performs a simple HTTP transaction to retrieve and display the web page found at that address.

• HTTP method get indicates that the client wishes to obtain a resource from the server. The re- mainder of the request provides the path name of the resource (e.g., an XHTML document) and the protocol’s name and version number (HTTP/1.1).

• Any server that understands HTTP can receive a get request and respond appropriately.

• HTTP status code 200 indicates success. Status code 404 informs the client that the web server could not locate the requested resource. A complete list of numeric codes indicating the status of an HTTP transaction can be found at www.w3.org/Protocols/rfc2616/rfc2616-sec10.html.

• In a response, the server sends one or more HTTP headers, which provide additional informa- tion about the data that will be sent.

• Multipurpose Internet Mail Extensions (MIME) is an Internet standard that specifies data for- mats so that programs can interpret data correctly. The MIME type text/plain indicates that the sent information is text that can be displayed directly, without any interpretation of the con- tent as XHTML markup. The MIME type image/jpeg indicates that the content is a JPEG im- age. When the browser receives this MIME type, it attempts to display the image.

• The header or set of headers is followed by a blank line, which indicates to the client browser that the server is finished sending HTTP headers.

• The two most common HTTP request types (also known as request methods) are get and post.

• A get request typically gets (or retrieves) information from a server. Common uses of get re- quests are to retrieve an XHTML document or an image, or to fetch search results based on a user-submitted search term.

• A post request typically posts (or sends) data to a server. Common uses of post requests are to send information to a server, such as authentication information or data from a form that gathers user input.  

Summary **875**

• An HTTP request often posts data to a server-side form handler that processes the data.

• A get request sends information to the server as part of the URL in a query string. A ? separates the query string from the rest of the URL in a get request. A _name_/_value_ pair is passed to the server with the _name_ and the _value_ separated by an equals sign (=). If more than one _name_/_value_ pair is submitted, each pair is separated by an ampersand (&).

• A get request may be initiated by submitting an XHTML form whose method attribute is set to "get", or by typing the URL (possibly containing a query string) directly into the browser’s ad- dress bar.

• A post request is specified in an XHTML form by the method "post". The post method sends form data as an HTTP message, not as part of the URL.

• A get request limits the query string to a specific number of characters (2083 in IE; more in other browsers).

• Large pieces of information must be sent using the post method.

• Browsers often cache web pages so they can quickly reload the pages. If there are no changes be- tween the version stored in the cache and the current version on the web, this helps speed up your browsing experience.

**_Section 21.3 Multitier Application Architecture_** • Web-based applications are multitier applications that divide functionality into separate tiers. Al-

though tiers can be located on the same computer, the tiers of web-based applications typically reside on separate computers.

• The bottom tier (also called the data tier or the information tier) maintains the application’s data.

• The middle tier implements business logic, controller logic and presentation logic to control in- teractions between the application’s clients and its data.

• Business logic in the middle tier enforces business rules and ensures that data is reliable before the server application updates the database or presents the data to users. Business rules dictate how clients can and cannot access application data, and how applications process data.

• The top tier, or client tier, is the application’s user interface. In response to user actions, the client tier interacts with the middle tier to make requests and to retrieve data from the information tier. The client tier then displays the data retrieved for the user. The client tier never directly interacts with the information tier.

**_Section 21.4 Client-Side Scripting versus Server-Side Scripting_** • Client-side scripting can be used to validate user input, to interact with the browser, to enhance

web pages by manipulating the DOM of a page, and to add Ajax functionality.

• Client-side scripting does have limitations, such as browser dependency; the browser or scripting host must support the scripting language and capabilities.

• Client-side scripts can be viewed by the client by using the browser’s source-viewing capability.

• Sensitive information, such as passwords or other personally identifiable data, should not be stored or validated on the client.

• Placing large amounts of JavaScript on the client can open web applications to attack and other security issues.

• Code executed on the server often generate custom responses for clients.

• Server-side scripting languages have a wider range of programmatic capabilities than their client- side equivalents. For example, server-side scripts often can access the server’s file directory struc- ture, whereas client-side scripts cannot access the client’s directories.  

**876** Chapter 21 Web Servers (IIS and Apache)

• Properly configured server-side scripts are not visible to the client; only XHTML and any client- side scripts are visible to the client.

• To request documents from web servers, users must know the hostnames on which the web serv- er software resides.

• Users can request documents from local web servers or remote web servers.

• Local web servers can be accessed through your computer’s name or through the name local-

host—a hostname that references the local machine and normally translates to the IP address 127.0.0.1 (also known as the loopback address).

**_Section 21.6 Microsoft Internet Information Services (IIS)_** • Microsoft Internet Information Services (IIS) is a web server that is included with several versions

of Windows. Installing IIS on a machine allows that computer to serve documents.

• To install IIS 5.1 on Windows XP, you may need your original operating-system disk. For IIS 6.0 (Windows Server 2003) and IIS 7.0 (Windows Vista), the software should already be in- stalled, but is also available on your installation disk.

• You place documents that will be requested from IIS either in the default directory or in a virtual directory. A virtual directory is an alias for an existing directory that resides on the local machine or on the network.

• In Windows Vista, before you can use IIS, you must enable the World Wide Web Publishing Service (W3SVC).

**_Section 21.7 Apache HTTP Server_** • The Apache HTTP Server, maintained by the Apache Software Foundation, is currently the

most popular web server. It is open source software that runs on UNIX, Linux, Mac OS X, Win- dows and numerous other platforms.

• Mac OS X and many versions of Linux come preinstalled with Apache.

• You can obtain the Apache HTTP Server for a variety of platforms from httpd.apache.org/

download.cgi.

• All documents that will be requested from an Apache HTTP Server must be either in the default directory or in a directory for which an Apache HTTP Server alias is configured. An alias is Apache’s equivalent to Microsoft IIS’s virtual directory. It is a pointer to an existing directory that resides on the local machine or on the network.

• The httpd.conf file contains all the information that the Apache HTTP Server needs to run cor- rectly and serve web documents. An introductory comment at the top of the httpd.conf file ex- plains how the file is organized. After this comment, the configuration information starts with the most important, global settings.

**Terminology** Apache HTTP Server bottom tier business logic cache client-side scripting client tier controller logic data tier DNS lookup

DNS server domain name domain name system (DNS) dynamic web page fully qualified hostname get (HTTP request) hostname htdocs directory HTTP request type  

Self-Review Exercises **877**

Hypertext Transfer Protocol (HTTP) information tier IIS 5.1 IIS 6.0 IIS 7.0 Internet Information Services (IIS) Internet Protocol (IP) address Linux local web server localhost

Mac OS X middle tier module multitier application _n_\-tier application open source post (HTTP request) presentation logic

relational database management system (RDBMS)

remote web server request method request type scripting host security level server-side form handler server-side script static web page top tier Uniform Resource Locator (URL) validation virtual directory web server Windows XP Windows Server 2003 Windows Vista

**Self-Review Exercises 21.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) Web servers and clients communicate with each other through the platform-indepen- dent HTTP.

b) Web servers often cache web pages for quick reloading. c) The information tier implements business logic to control the type of information that

is presented to a particular client. d) Client-side scripts can access the browser, use features specific to that browser and ma-

nipulate browser documents. e) A virtual directory is an alias for an existing directory on a remote machine. f) The Apache HTTP Server is said to be platform independent because it runs on various

operating systems, such as UNIX, Linux, Windows and Max OS X. g) The path in a URL normally specifies the location of an actual directory on the server.

**21.2** Fill in the blanks in each of the following statements: a) The two most common HTTP request types are and . b) In a three-tier application, a web server is typically part of the tier. c) The most popular client-side scripting language is . d) A(n) translates a fully qualified hostname to an IP address. e) is a hostname that references the local computer. f) A(n) is Apache’s equivalent to Microsoft IIS’s virtual directory. g) The bottom tier (also called the or the ) maintains the application’s

data. h) is an Internet standard that specifies data formats so that programs can inter-

pret data correctly.

**Answers to Self-Review Exercises 21.1** a.) True. b) False. Web browsers cache web pages for quick reloading. c) False. The middle tier implements business logic and presentation logic to control interactions between application cli- ents and application data. d) True. e) False. A virtual directory is an alias for an existing directory  

**878** Chapter 21 Web Servers (IIS and Apache)

on the local machine or network. f) True. g) False. For security reasons the path normally specifies the location of a virtual directory.

**21.2** a) get, post. b) middle. c) JavaScript. d) domain name system (DNS) server. e) localhost. f) alias. g) data tier, information tier. h) Multipurpose Internet Mail Extensions (MIME).

**Exercises 21.3** Define the following terms:

a) HTTP. b) Multitier application. c) Request method. d) Virtual directory. e) Web server.

**21.4** In a three-tier application, explain how the middle tier (e.g., web server) interacts with the client tier (e.g., web browser).

**21.5** Explain the difference between the get request type and the post request type. When is it ideal to use the post request type?

**21.6** Configure Apache to serve a home page from your computer.

**21.7** Discuss the benefits and disadvantages of client-side vs. server-side scripting.  

22 Database:SQL, MySQL, ADO.NET 2.0 and Java DB

**O B J E C T I V E S** In this chapter you will learn:

■ Relational database concepts.

■ To use Structured Query Language (SQL) to retrieve data from and manipulate data in a database.

■ To install and configure MySQL.

■ To create a MySQL database.

■ The ADO.NET 2.0 object model.

**_It is a capital mistake to theorize before one has data._ —Arthur Conan Doyle**

**_Now go, write it before them in a table, and note it in a book, that it may be for the time to come for ever and ever._ —The Holy Bible, Isaiah 30:8**

**_Get your facts first, and then you can distort them as much as you please._ —Mark Twain**

**_I like two kinds of men: domestic and foreign._ —Mae West**  

**880** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB **O**

**u tl**

**in e**

**22.1 Introduction** A **database** is an organized collection of data. There are many different strategies for orga- nizing data to facilitate easy access and manipulation. A **database management system** (**DBMS**) provides mechanisms for storing, organizing, retrieving and modifying data. Database management systems allow for the access and storage of data without concern for the internal representation of the data in the database.

Today’s most popular database systems are relational databases, where the data is stored without consideration of its physical structure (Section 22.2). A language called **SQL**—pronounced “sequel,” or as its individual letters—is the international standard lan- guage used almost universally with relational databases to perform **queries** (i.e., to request information that satisfies given criteria) and to manipulate data. \[_Note:_ As you learn about SQL, you will see some authors writing “a SQL statement” (which assumes the pronunci- ation “sequel”) and others writing “an SQL statement” (which assumes that the individual letters are pronounced). In this book we pronounce SQL as “sequel.”\] Some popular **rela- tional database management systems** (**RDBMSs**) are Microsoft SQL Server, Oracle, Sybase, IBM DB2, Informix, PostgreSQL and MySQL.

Programs connect to, and interact with, a relational database via an **interface**—soft- ware that facilitates communication between a database management system and a pro- gram. For example, Java developers can use the JDBC interface to interact with databases. Similarly, ASP.NET programmers communicate with databases and manipulate their data through the interface provided by ADO.NET.

**22.1** Introduction **22.2** Relational Databases **25.3** Relational Database Overview: The books Database **22.4** SQL

**22.4.1** Basic SELECT Query **22.4.2** WHERE Clause **22.4.3** ORDER BY Clause **22.4.4** Combining Data from Multiple Tables: INNER JOIN **22.4.5** INSERT Statement **22.4.6** UPDATE Statement **22.4.7** DELETE Statement

**22.5** MySQL **22.6** Instructions for Installing MySQL **22.7** Instructions for Setting Up a MySQL User Account **22.8** Creating a Database in MySQL **22.9** ADO.NET Object Model

**22.10** Java DB/Apache Derby **22.11** Wrap-Up **22.12** Web Resources

Summary | Terminology | Self-Review Exercise | Answers to Self-Review Exercise | Exercises  

22.2 Relational Databases **881**

**22.2 Relational Databases** A **relational database** is a logical representation of data that allows the data to be accessed without consideration of its physical structure. A relational database stores data in **tables**. Figure 22.1 illustrates a sample table that might be used in a personnel system. The table name is Employee, and its primary purpose is to store the attributes of an employee. Tables are composed of **rows**, and rows are composed of **columns** in which values are stored. This table consists of six rows. The Number column of each row in this table is the table’s **pri- mary key**—a column (or group of columns) in a table with a unique value that cannot be duplicated in other rows. This guarantees that each row can be identified by its primary key. Good examples of primary key columns are a social security number, an employee ID number and a part number in an inventory system, as values in each of these columns are guaranteed to be unique. The rows in Fig. 22.1 are displayed in order by primary key. In this case, the rows are listed in increasing order, but we could also use decreasing order.

Rows in tables are not guaranteed to be stored in any particular order. As we will dem- onstrate in an upcoming example, programs can specify ordering criteria when requesting data from a database.

Each column represents a data attribute. Rows are normally unique (by primary key) within a table, but particular column values may be duplicated between rows—e.g., three different rows in the Employee table’s Department column contain number 413.

Different users of a database are often interested in different data and different rela- tionships among the data. Most users require only subsets of the rows and columns. To obtain these subsets, we use queries to specify which data to select from a table. We use SQL to define complex queries that select data from a table. For example, we might select data from the Employee table to create a result that shows where each department is located, and present the data sorted in increasing order by department number. This result is shown in Fig. 22.2. SQL queries are discussed in Section 22.4.

**Fig. 22.1** | Employee table sample data.

**Fig. 22.2** | Result of selecting distinct Department and Location data from table Employee.

23603

24568

34589

35761

47132

78321

Jones

Kerwin

Larson

Myers

Neumann

Stephens

Number

Primary key

Row

Column

Name

413

413

642

611

413

611

Department

1100

2000

1800

1400

9000

8500

Salary

New Jersey

New Jersey

Los Angeles

Orlando

New Jersey

Orlando

Location

413 611 642

New Jersey Orlando Los Angeles

Department Location  

**882** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**22.3 Relational Database Overview: A books Database** We now overview relational databases in the context of a sample books database we created for this chapter. Before we discuss SQL, we overview the tables of the books database. We use this database to introduce various database concepts, including how to use SQL to ob- tain information from the database and to manipulate the data. We provide a script to cre- ate the database. You can find the script in the examples directory for this chapter. Section 22.8 explains how to use this script.

The database consists of three tables—authors, authorISBN and titles. The authors table (described in Fig. 22.3) consists of three columns that maintain each author’s unique ID number, first name and last name. Figure 22.4 contains sample data from the authors table of the books database.

The authorISBN table (described in Fig. 22.5) has two columns that maintain each ISBN and the corresponding author’s ID number. This table associates authors with their books. The columns represent the relationship between the authors and titles tables—

Column Description

authorID Author’s ID number in the database. In the books database, this integer col- umn is defined as **autoincremented**—for each row inserted in this table, the authorID value is increased by 1 automatically to ensure that each row has a unique authorID. This column represents the table’s primary key.

firstName Author’s first name (a string).

lastName Author’s last name (a string).

**Fig. 22.3** | authors table from the books database.

authorID firstName lastName

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

4 David Choffnes

**Fig. 22.4** | Sample data from the authors table.

Column Description

authorID The author’s ID number, a foreign key to the authors table.

isbn The ISBN for a book, a foreign key to the titles table.

**Fig. 22.5** | authorISBN table from the books database.  

22.3 Relational Database Overview: A books Database **883**

one row in authors may be associated with many rows in titles, and vice versa. Figure 22.6 contains sample data from the authorISBN table. \[_Note:_ To save space, we split the table’s contents into two columns, each containing the authorID and isbn columns.\] The authorID column (and similarly, the isbn column) is a **foreign key**—a column in this table that matches the primary-key column in another table (i.e., authorID in the authors table). Foreign keys are specified when creating a table. The foreign key helps maintain the **Rule of Referential Integrity**—every foreign-key value must appear as another table’s pri- mary-key value. This enables the DBMS to determine whether the authorID value for a particular book is valid. Foreign keys also allow related data in multiple tables to be selected from those tables for analytic purposes—this is known as **joining** the data. If you were to remove an author from the authors table, you’d also want to remove the corre- sponding rows in the authorISBN table.

The titles table described in Fig. 22.7 consists of four columns that stand for each book’s ISBN, the title, the edition number and the copyright year. The table is in Fig. 22.8.

authorID isbn authorID isbn

1 0131869000 2 0131450913

2 0131869000 1 0131828274

1 0131483986 2 0131828274

2 0131483986 3 0131450913

1 0131450913 4 0131828274

**Fig. 22.6** | Sample data from the authorISBN table of books.

Column Description

isbn ISBN of the book (a string). The table’s primary key. ISBN is an abbrevia- tion for “International Standard Book Number”—a numbering scheme that publishers use to give every book a unique identification number.

title Title of the book (a string).

editionNumber Edition number of the book (an integer).

copyright Copyright year of the book (a string).

**Fig. 22.7** | titles table from the books database.

isbn title editionNumber copyright

0131869000 Visual Basic How to Program 3 2006

0131525239 Visual C# How to Program 2 2006

**Fig. 22.8** | Sample data from the titles table of the books database. (Part 1 of 2.)  

**884** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

There is a one-to-many relationship between a primary key and a corresponding for- eign key (e.g., one author can write many books). A foreign key creates a relationship between two tables in which the record with a given primary key can be referenced many times in the foreign key’s table. Figure 22.9 is an **entity-relationship** (**ER**) **diagram** for the books database. This diagram shows the database tables and the relationships among them. The first compartment in each box contains the table’s name. The names in italic are primary keys. A table’s primary key uniquely identifies each row in the table. Every row must have a primary-key value, and that value must be unique in the table. This is known as the **Rule of Entity Integrity**.

**Common Programming Error 22.1** _Not providing a value for every column in a primary key breaks the Rule of Entity Integrity and causes the DBMS to report an error._ 22.1

**Common Programming Error 22.2** _Providing the same value for the primary key in multiple rows causes the DBMS to report an error._ 22.2

The lines connecting the tables in Fig. 22.9 represent the relationships between the tables. Consider the line between the authorISBN and authors tables. On the authors end of the line, there is a 1, and on the authorISBN end, there is an infinity symbol (∞ ), indi- cating a **one-to-many relationship** in which every author in the authors table can have an arbitrary number of ISBNs in the authorISBN table. Note that the relationship line links the authorID column in the table authors (i.e., its primary key) to the authorID column in table authorISBN (i.e., its foreign key). The authorID column in the authorISBN table is a foreign key.

0132222205 Java How to Program 7 2007

0131857576 C++ How to Program 5 2005

0132404168 C How to Program 5 2007

0131450913 Internet and World Wide Web How to Program

3 2004

isbn title editionNumber copyright

**Fig. 22.8** | Sample data from the titles table of the books database. (Part 2 of 2.)

**Fig. 22.9** | Table relationships in the books database.

1 1 **Titles**

Copyright

EditionNumber

Title

_ISBN_

**AuthorISBN**

_ISBN_

_AuthorID_

**Authors**

LastName

FirstName

_AuthorID_  

22.4 SQL **885**

**Common Programming Error 22.3** _Providing a foreign-key value that does not appear as a primary-key value in another table breaks the Rule of Referential Integrity and causes the DBMS to report an error._ 22.3

The line between the titles and authorISBN tables illustrates another one-to-many relationship; a title can be written by any number of authors. In fact, the sole purpose of the authorISBN table is to provide a many-to-many relationship between the authors and titles tables—an author can write any number of books and a book can have any number of authors. The primary key for authorISBN is the combination of authorID and ISBN.

**22.4 SQL** We now provide an overview of SQL in the context of our books database. You will be able to use the SQL discussed here in the examples later in the chapter and in examples in Chapters 23–28.

The next several subsections discuss most of the SQL keywords listed in Fig. 22.10 in the context of SQL queries and statements. Other SQL keywords are beyond this text’s scope. To learn other keywords, refer to the SQL reference guide supplied by the vendor of the RDBMS you are using. \[_Note:_ For more information on SQL, refer to the web resources in Section 22.12.\]

**22.4.1 Basic SELECT Query** Let us consider several SQL queries that extract information from database books. A SQL query “selects” rows and columns from one or more tables in a database. Such selections are performed by queries with the SELECT keyword. The basic form of a SELECT query is

SELECT \* FROM _tableName_

SQL keyword Description

SELECT Retrieves data from one or more tables.

FROM Tables involved in the query. Required in every SELECT.

WHERE Criteria for selection that determine the rows to be retrieved, deleted or updated. Optional in a SQL query or a SQL statement.

GROUP BY Criteria for grouping rows. Optional in a SELECT query.

ORDER BY Criteria for ordering rows. Optional in a SELECT query.

INNER JOIN Combine rows from multiple tables.

INSERT Insert rows into a specified table.

UPDATE Update rows in a specified table.

DELETE Delete rows from a specified table.

**Fig. 22.10** | SQL query keywords.  

**886** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

in which the **asterisk (\*)** indicates that all rows and columns from the _tableName_ table should be retrieved. For example, to retrieve all the data in the authors table, use

SELECT \* FROM authors

Most programs do not require all the data in a table. To retrieve only specific columns from a table, replace the asterisk (\*) with a comma-separated list of the column names. For example, to retrieve only the columns authorID and lastName for all rows in the authors table, use the query

SELECT authorID, lastName FROM authors

This query returns the data listed in Fig. 22.11.

**Software Engineering Observation 22.1** _For most queries, the asterisk (\*) should not be used to specify column names. In general, you process results by knowing in advance the order of the columns in the result—for example, selecting authorID and lastName from table authors ensures that the columns will appear in the result with authorID as the first column and lastName as the second column. Programs typically process result columns by specifying the column number in the result (starting from number 1 for the first column). Selecting columns by name also avoids returning unneeded columns and protects against changes in the actual order of the columns in the table(s)._ 22.1

**Common Programming Error 22.4** _If you assume that the columns are always returned in the same order from a query that uses the asterisk (_\*_), the program may process the results incorrectly. If the column order in the table(s) changes or if additional columns are added at a later time, the order of the columns in the result changes accordingly._ 22.4

**22.4.2 WHERE Clause** In most cases, it is necessary to retrieve rows in a database that satisfy certain **selection cri- teria**. Only rows that satisfy the selection criteria (formally called **predicates**) are selected. SQL uses the optional WHERE **clause** in a query to specify the selection criteria for the query. The basic form of a query with selection criteria is

SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ WHERE _criteria_

For example, to select the title, editionNumber and copyright columns from table titles for which the copyright year is greater than 2005, use the query

authorID lastName

1 Deitel

2 Deitel

3 Goldberg

4 Choffnes

**Fig. 22.11** | Sample authorID and lastName data from the authors table.  

22.4 SQL **887**

SELECT title, editionNumber, copyright FROM titles WHERE copyright > '2005'

Figure 22.12 shows the result of the preceding query. The WHERE clause criteria can contain the operators <, >, <=, >=, =, <> and LIKE. Operator **LIKE** is used for **pattern matching** with wildcard characters **percent** (**%**) and **underscore** (\_). Pattern matching allows SQL to search for strings that match a given pattern.

A pattern that contains a percent character (%) searches for strings that have zero or more characters at the percent character’s position in the pattern. For example, the next query locates the rows of all the authors whose last name starts with the letter D:

SELECT authorID, firstName, lastName FROM authors WHERE lastName LIKE 'D%'

This query selects the two rows shown in Fig. 22.13—two of the four authors have a last name starting with the letter D (followed by zero or more characters). The % in the WHERE

clause’s LIKE pattern indicates that any number of characters can appear after the letter D in the lastName. Note that the pattern string is surrounded by single-quote characters.

**Portability Tip 22.1** _See the documentation for your database system to determine whether SQL is case sensitive on your system and to determine the syntax for SQL keywords (i.e., should they be all uppercase let- ters, all lowercase letters or some combination of the two?)._ 22.1

An underscore ( \_ ) in the pattern string indicates a single wildcard character at that position in the pattern. For example, the following query locates the rows of all the authors

title editionNumber copyright

Visual C# How to Program 2 2006

Visual Basic 2005 How to Program 3 2006

Java How to Program 7 2007

C How to Program 5 2007

**Fig. 22.12** | Sampling of titles with copyrights after 2005 from table titles.

authorID firstName lastName

1 Harvey Deitel

2 Paul Deitel

**Fig. 22.13** | Authors whose last name starts with D from the authors table.  

**888** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

whose last names start with any character (specified by \_), followed by the letter o, fol- lowed by any number of additional characters (specified by %):

SELECT authorID, firstName, lastName FROM authors WHERE lastName LIKE '\_o%'

The preceding query produces the row shown in Fig. 22.14, because only one author in our database has a last name that contains the letter o as its second letter.

**22.4.3 ORDER BY Clause** The rows in the result of a query can be sorted into ascending or descending order by using the optional **ORDER BY clause**. The basic form of a query with an ORDER BY clause is

SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ ORDER BY _column_ ASC SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ ORDER BY _column_ DESC

where ASC specifies ascending order (lowest to highest), DESC specifies descending order (highest to lowest) and _column_ specifies the column on which the sort is based. For exam- ple, to obtain the list of authors in ascending order by last name (Fig. 22.15), use the query

SELECT authorID, firstName, lastName FROM authors ORDER BY lastName ASC

Note that the default sorting order is ascending, so ASC is optional. To obtain the same list of authors in descending order by last name (Fig. 22.16), use the query

authorID firstName lastName

3 Andrew Goldberg

**Fig. 22.14** | The only author from the authors table whose last name contains o as the second letter.

authorID firstName lastName

4 David Choffnes

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

**Fig. 22.15** | authors sample data in ascending order by lastName.  

22.4 SQL **889**

SELECT authorID, firstName, lastName FROM authors ORDER BY lastName DESC

Multiple columns can be used for sorting with an ORDER BY clause of the form

ORDER BY _column1 sortingOrder_, _column2 sortingOrder_, _…_

where _sortingOrder_ is either ASC or DESC. Note that the _sortingOrder_ does not have to be identical for each column. The query

SELECT authorID, firstName, lastName FROM authors ORDER BY lastName, firstName

sorts all the rows in ascending order by last name, then by first name. If any rows have the same value in the lastName column, they are returned sorted by firstName (Fig. 22.17).

The WHERE and ORDER BY clauses can be combined in one query, as in

SELECT isbn, title, editionNumber, copyright FROM titles WHERE title LIKE '%How to Program' ORDER BY title ASC

which returns the isbn, title, editionNumber and copyright of each book in the titles table that has a title ending with "How to Program" and sorts them in ascending order by title. The query results are shown in Fig. 22.18.

authorID firstName lastName

3 Andrew Goldberg

1 Harvey Deitel

2 Paul Deitel

4 David Choffnes

**Fig. 22.16** | authors sample data in descending order by lastName.

authorID firstName lastName

4 David Choffnes

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

**Fig. 22.17** | authors sample data in ascending order by lastName and firstName.  

**890** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**22.4.4 Combining Data from Multiple Tables: INNER JOIN** Database designers often split related data into separate tables to ensure that a database does not store data redundantly. For example, the books database has tables authors and titles. We use an authorISBN table to store the relationship data between authors and their corresponding titles. If we did not separate this information into individual tables, we would need to include author information with each entry in the titles table. Then the database would store duplicate author information for authors who wrote multiple books. Often, it is necessary to combine data from multiple tables into a single result. Re- ferred to as joining the tables, this is specified by an INNER JOIN operator in the query. An INNER JOIN combines rows from two tables by matching values in columns that are com- mon to the tables. The basic form of an INNER JOIN is:

SELECT _columnName1, columnName2, …_ FROM _table1_ INNER JOIN _table2_

ON _table1_._columnName_ \= _table2_._columnName_

The **ON clause** of the INNER JOIN specifies a condition (often comparing columns from each table) that determines which rows are combined. For example, the following query produces a list of authors accompanied by the ISBNs for books written by each author:

SELECT firstName, lastName, isbn FROM authors INNER JOIN authorISBN

ON authors.authorID = authorISBN.authorID ORDER BY lastName, firstName

The query combines the firstName and lastName columns from table authors with the isbn column from table authorISBN, sorting the result in ascending order by lastName and firstName. Only rows in which the authorIDs match are combined. Note the use of the syntax _tableName_._columnName_ in the ON clause. This syntax, called a **qualified name**, specifies the columns from each table that should be compared to join the tables. The “_tableName_.” syntax is required if the columns have the same name in both tables. The

isbn title edition- Number

copy- right

0132404168 C How to Program 5 2007

0131857576 C++ How to Program 5 2005

0131450913 Internet and World Wide Web How to Program 3 2004

0132222205 Java How to Program 7 2007

0131869000 Visual Basic 2005 How to Program 3 2006

0131525239 Visual C# How to Program 2 2006

**Fig. 22.18** | Sampling of books from table titles whose titles end with How to Program in ascending order by title.  

22.4 SQL **891**

same syntax can be used in any query to distinguish columns in different tables that have the same name. In some systems, table names qualified with the database name can be used to perform cross-database queries. As always, the query can contain an ORDER BY clause. Figure 22.19 depicts a portion of the results of the preceding query, ordered by lastName

and firstName. \[_Note:_ To save space, we split the result of the query into two columns, each containing the firstName, lastName and isbn columns.\]

**Software Engineering Observation 22.2** _If a SQL statement includes columns with the same name from multiple tables, the statement must precede those column names with their table names and a dot (e.g., authors.authorID)._ 22.2

**Common Programming Error 22.5** _Failure to qualify names for columns that have the same name in two or more tables is an error._22.2

**22.4.5 INSERT Statement** The INSERT statement inserts a row into a table. The basic form of this statement is

INSERT INTO _tableName_ ( _columnName1_, _columnName2_, _…_, _columnNameN_ ) VALUES ( _value1_, _value2_, _…_, _valueN_ )

where _tableName_ is the table in which to insert the row. The _tableName_ is followed by a comma-separated list of column names in parentheses (this list is not required if the IN-

SERT operation specifies a value for every column of the table in the correct order). The list of column names is followed by the SQL keyword VALUES and a comma-separated list of values in parentheses. The values specified here must match the columns specified after the table name in both order and type (e.g., if _columnName1_ is supposed to be the firstName column, then _value1_ should be a string in single quotes representing the first name).

firstName lastName isbn firstName lastName isbn

David Choffnes 0131828274 Paul Deitel 0131869000

Harvey Deitel 0131869000 Paul Deitel 0131525239

Harvey Deitel 0131525239 Paul Deitel 0132222205

Harvey Deitel 0132222205 Paul Deitel 0131857576

Harvey Deitel 0131857576 Paul Deitel 0132404168

Harvey Deitel 0132404168 Paul Deitel 0131450913

Harvey Deitel 0131450913 Paul Deitel 0131869000

Harvey Deitel 0131869000 Paul Deitel 0131828274

Harvey Deitel 0131828274 Andrew Goldberg 0131450913

**Fig. 22.19** | Sampling of authors and ISBNs for the books they have written in ascending order by lastName and firstName.  

**892** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**Good Programming Practice 22.1** _Always explicitly list the columns when inserting rows. If the table’s column order changes or a new column is added, omitting the columns list may cause an error._ 22.1

The INSERT statement

INSERT INTO authors ( firstName, lastName ) VALUES ( 'Sue', 'Smith' )

inserts a row into the authors table. The statement indicates that values are provided for the firstName and lastName columns. The corresponding values are 'Sue' and 'Smith'. We do not specify an authorID in this example because authorID is an autoincremented column in the authors table. For every row added to this table, the database assigns a unique authorID value that is the next value in the autoincremented sequence (i.e., 1, 2, 3 and so on). In this case, Sue Smith would be assigned authorID number 5. Figure 22.20 shows the authors table after the INSERT operation. \[_Note:_ Not every database manage- ment system supports autoincremented columns. Check the documentation for your DBMS for alternatives to autoincremented columns.\]

**Common Programming Error 22.6** _It is normally an error to specify a value for an autoincrement column._ 22.2

**Common Programming Error 22.7** _SQL uses the single-quote (') character as a delimiter for strings. To specify a string containing a single quote (e.g., O’Malley) in a SQL statement, the string must have two single quotes in the position where the single-quote character appears in the string (e.g., 'O''Malley'). The first of the two single-quote characters acts as an escape character for the second. Not escaping single- quote characters in a string that is part of a SQL statement is a SQL syntax error._ 22.7

**22.4.6 UPDATE Statement** An UPDATE statement modifies data in a table. The basic form of the UPDATE statement is

UPDATE _tableName_ SET _columnName1_ \= _value1_, _columnName2_ \= _value2_, …, _columnNameN_ \= _valueN_ WHERE _criteria_

authorID firstName lastName

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

4 David Choffnes

5 Sue Smith

**Fig. 22.20** | Sample data from table Authors after an INSERT operation.  

22.4 SQL **893**

where _tableName_ is the table to update. The _tableName_ is followed by keyword SET and a comma-separated list of column name/value pairs in the format _columnName_ \= _value_. The _value_ can be an expression that yields a value. The optional WHERE clause provides criteria that determine which rows to update. Though not required, the WHERE clause is typically used, unless a change is to be made to every row. The UPDATE statement

UPDATE authors SET lastName = 'Jones' WHERE lastName = 'Smith' AND firstName = 'Sue'

updates a row in the authors table. The statement indicates that lastName will be assigned the value Jones for the row in which lastName is equal to Smith and firstName is equal to Sue. \[_Note:_ If there are multiple rows with the first name “Sue” and the last name “Smith,” this statement will modify all such rows to have the last name “Jones.”\] If we know the authorID in advance of the UPDATE operation (possibly because we searched for it previously), the WHERE clause can be simplified as follows:

WHERE authorID = 5

Figure 22.21 shows the authors table after the UPDATE operation has taken place.

**22.4.7 DELETE Statement** A SQL DELETE statement removes rows from a table. The basic form of a DELETE is

DELETE FROM _tableName_ WHERE _criteria_

where _tableName_ is the table from which to delete. The optional WHERE clause specifies the criteria used to determine which rows to delete. If this clause is omitted, all the table’s rows are deleted. The DELETE statement

DELETE FROM authors WHERE lastName = 'Jones' AND firstName = 'Sue'

deletes the row (or rows) for Sue Jones in the authors table. If we know the authorID in advance of the DELETE operation, the WHERE clause can be simplified as follows:

WHERE authorID = 5

Figure 22.22 shows the authors table after the DELETE operation has taken place.

authorID firstName lastName

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

4 David Choffnes

5 Sue Jones

**Fig. 22.21** | Sample data from table authors after an UPDATE operation.  

**894** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**22.5 MySQL** In 1994, TcX, a Swedish consulting firm, needed a fast and flexible way to access its tables. Unable to find a database server that could accomplish the required task adequately, Michael Widenius, the principal developer at TcX, decided to create his own database server. The resulting product was called _MySQL_ (pronounced “my sequel”), a robust and scalable relational database management system (RDBMS).

MySQL is a multiuser, multithreaded (i.e., allows multiple simultaneous connec- tions) RDBMS server that uses SQL to interact with and manipulate data. The MySQL Manual (www.mysql.com/why-mysql/topreasons.html) lists numerous benefits of MySQL. A few important benefits include:

**1\.** Scalability. You can embed in an application or use it in massive data warehous- ing environments.

**2\.** Performance. You can optimize performance based on the purpose of the data- base in your application.

**3\.** Support for many programming languages. Later chapters demonstrate how to ac- cess a MySQL database from PHP (Chapter 23) and Ruby on Rails (Chapter 24).

**4\.** Implementations of MySQL for Windows, Mac OS X, Linux and UNIX.

**5\.** Handling large databases (e.g., tens of thousands of tables with millions of rows).

For these reasons and more, MySQL is the database of choice for many businesses, universities and individuals. MySQL is an open source software product. \[_Note:_ Under certain situations, a commercial license is required for MySQL. See www.mysql.com/

company/legal/licensing/ for details\]

**22.6 Instructions for Installing MySQL MySQL 5.0 Community Edition** is an open source database management system that ex- ecutes on many platforms, including Windows, Solaris, Linux, and Macintosh. Complete information about MySQL is available from www.mysql.com.

**_Installing MySQL_** To install MySQL Community Edition:

**1\.** To learn about the installation requirements for your platform, visit the site dev.mysql.com/doc/refman/5.0/en/general-installation-issues.html.

authorID firstName lastName

1 Harvey Deitel

2 Paul Deitel

3 Andrew Goldberg

4 David Choffnes

**Fig. 22.22** | Sample data from table authors after a DELETE operation.  

22.7 Instructions for Setting Up a MySQL User Account **895**

**2\.** Visit dev.mysql.com/downloads/mysql/5.0.html and download the installer for your platform. For our MySQL examples, you need only the Windows Essen- tials package on Microsoft Windows, or the Standard package on most other plat- forms. \[_Note:_ For these instructions, we assume you are running Microsoft Windows. Complete installation instructions for other platforms are available at dev.mysql.com/doc/refman/5.0/en/installing.html.\]

**3\.** Double click mysql-essential-5.0.45-win32.msi to start the installer. \[_Note:_ This filename may differ, based on the current version of MySQL 5.0.\]

**4\.** Choose **Typical** for the **Setup Type** and click **Next >**. Then click **Install**.

When the installation completes, you will be asked to set up an account on MySQL.com. If you do not wish to do this, select **Skip Sign-up** and click **Next >**. After completing the sign-up process or skipping it, you can configure the MySQL Server. Click **Finish** to start the **MySQL Server Instance Configuration Wizard**. To configure the server:

**1\.** Click **Next >**, then select **Standard Configuration** and click **Next >** again.

**2\.** You have the option of installing MySQL as a Windows service, which enables the MySQL server to begin executing automatically each time your system starts. For our examples, this is unnecessary, so uncheck **Install as a Windows Service**, then check **Include Bin Directory in Windows PATH**. This will enable you to use the MySQL commands in the Windows Command Prompt.

**3\.** Click **Next >**, then click **Execute** to perform the server configuration.

**4\.** Click **Finish** to close the wizard.

**22.7 Instructions for Setting Up a MySQL User Account** For the MySQL examples to execute correctly, you need to set up a user account that al- lows users to create, delete and modify a database. After MySQL is installed, follow the steps below to set up a user account (these steps assume MySQL is installed in its default installation directory):

**1\.** Open a Command Prompt and start the database server by executing the com- mand mysqld-nt.exe. (On Linux, execute mysqld start from a shell or terminal window.) Note that this command has no output—it simply starts the MySQL server. Do not close this window—doing so terminates the server.

**2\.** Next, you’ll start the **MySQL command-line client tool** so you can set up a user account, open another Command Prompt and execute the command

mysql -h localhost -u root

The -h option indicates the host (i.e., computer) on which the MySQL server is running—in this case your local computer (localhost). The -u option indicates the user account that will be used to log in to the server—root is the default user account that is created during installation to allow you to configure the server. Once you’ve logged in, you’ll see a mysql> prompt at which you can type com- mands to interact with the MySQL server.  

**896** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**3\.** Next, you’ll add the iw3htp4 user account to the mysql built-in database. To cre- ate the iw3htp4 user account with the password iw3htp4, execute the following commands from the mysql> prompt:

create user 'iw3htp4'@'localhost' identified by 'iw3htp4';

grant select, insert, update, delete, create, drop, references, execute on \*.\* to 'iw3htp4'@'localhost';

This creates the iw3htp4 user with the privileges needed to create the databases used in this chapter and manipulate those databases.

**4\.** Type the command

exit;

to terminate the MySQL monitor.

**22.8 Creating a Database in MySQL** For each MySQL database we discuss in this book, we provide a SQL script in a file with the .sql extension that sets up the database and its tables. You can execute these scripts in the MySQL command-line client tool. In the examples directory for this chapter, you’ll find the SQL script books.sql to create the books database. For the following steps, we assume that the MySQL server (mysqld-nt.exe) is still running. To execute the books.sql script:

**1\.** Open a command prompt and use the cd command to change directories to the location that contains the books.sql script.

**2\.** Start the MySQL monitor by typing

mysql -h localhost -u iw3htp4 -p

The -p option prompts you for the password for the iw3htp4 user account. When prompted, enter the password iw3htp4.

**3\.** Execute the script by typing

source books.sql;

This creates a books database in the server’s data directory—located on Win- dows at C:\\Program Files\\MySQL\\MySQL Server 5.0\\data by default.

**4\.** Type the command

exit;

to terminate the MySQL command-line client tool. You are now ready to use your MySQL database.

**22.9 ADO.NET Object Model** Several examples in Chapter 25, ASP.NET 2.0 and ASP.NET Ajax, use ADO.NET 2.0 to access and manipulate SQL Server 2005 Express databases. The **ADO.NET object model** provides an API for accessing database management systems programmatically. ADO.NET was created for the .NET framework to replace Microsoft’s ActiveX Data Ob-  

22.9 ADO.NET Object Model **897**

jects™ (ADO) technology. Microsoft’s Visual Studio IDE features visual programming tools that simplify the process of using a database in your projects. While you may not need to work directly with many ADO.NET objects to develop simple applications, basic knowledge of how the ADO.NET object model works is important for understanding data access in Visual Basic (the programming language we use in Chapter 25).

**_Namespaces System.Data, System.Data.OleDb and System.Data.SqlClient_** Namespace **System.Data** is the root namespace for the ADO.NET API. The other impor- tant ADO.NET namespaces, **System.Data.OleDb** and **System.Data.SqlClient**, contain classes that enable programs to connect with and manipulate **data sources**—locations that contain data, such as a database or an XML file. Namespace System.Data.OleDb contains classes that are designed to work with any data source that supports the OLE DB API, whereas System.Data.SqlClient contains classes that are optimized to work with Mi- crosoft SQL Server databases. The Chapter 25 examples manipulate SQL Server 2005 Ex- press databases, so we use the classes of namespace System.Data.SqlClient. SQL Server 2005 Express is available at msdn.microsoft.com/vstudio/express/sql/default.aspx.

An object of class **SqlConnection** (namespace System.Data.SqlClient) represents a connection to a data source—specifically a Microsoft SQL Server database. A SqlConnec-

tion object keeps track of the location of the data source and any settings that specify how the data source is to be accessed. A connection is either **active** (i.e., open and permitting data to be sent to and retrieved from the data source) or **closed**.

An object of class **SqlCommand** (namespace System.Data.SqlClient) represents a SQL command that a DBMS can execute on a database. A program can use SqlCommand

objects to manipulate a data source through a SqlConnection. The program must open the connection to the data source before executing one or more SqlCommands and close the connection once no further access to the data source is required. A connection that remains active for some length of time to permit multiple data operations is known as a **persistent connection**.

Class **DataTable** (namespace System.Data) represents a table of data. A DataTable

contains a collection of **DataRows** that represent the table’s data. A DataTable also has a collection of **DataColumns** that describe the columns in a table. DataRow and DataColumn

are both located in namespace System.Data. An object of class **System.Data.DataSet**, which consists of a set of DataTables and the relationships among them, represents a **cache** of data—data that a program stores temporarily in local memory. The structure of a DataSet mimics the structure of a relational database.

**_ADO.NET’s Disconnected Model_** An advantage of using class DataSet is that it is **disconnected**—the program does not need a persistent connection to the data source to work with data in a DataSet. Instead, the pro- gram connects to the data source to **populate the DataSet** (i.e., fill the DataSet’s Data- Tables with data), but disconnects from the data source immediately after retrieving the desired data. The program then accesses and potentially manipulates the data stored in the DataSet. The program operates on this local cache of data, rather than the original data in the data source. If the program makes changes to the data in the DataSet that need to be permanently saved in the data source, the program reconnects to the data source to per- form an update, then disconnects promptly. Thus the program does not require any active, persistent connection to the data source.  

**898** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

An object of class **SqlDataAdapter** (namespace System.Data.SqlClient) connects to a SQL Server data source and executes SQL statements to both populate a DataSet and update the data source based on the current contents of a DataSet. A SqlDataAdapter

maintains a SqlConnection object that it opens and closes as needed to perform these operations, using SqlCommands.

**22.10 Java DB/Apache Derby** As of the Java SE 6 Development Kit (JDK), Sun Microsystems now bundles the open source, pure Java database **Java DB** (the Sun branded version of Apache Derby) with the JDK. Chapters 27–28 use Java DB in data-driven web applications. Similar to MySQL, Java DB has both an embedded version and a network (client/server) version. The tools we use in Chapters 27–28 come with Java DB. For those examples, we use Java DB’s net- work version, and we provide all the information you need to configure each example’s database. You can learn more about Apache Derby at db.apache.org/derby. You can learn more about Java DB at developers.sun.com/javadb/.

**22.11 Wrap-Up** In this chapter, you learned basic database concepts and how to interact with data in a da- tabase using SQL. You learned about the SQL statements SELECT, INSERT, UPDATE and DE-

LETE, as well as clauses such as WHERE, ORDER BY and INNER JOIN. You learned how to install MySQL, to create and configure a MySQL user account, and to execute scripts that create databases in MySQL. We also discussed ADO.NET 2.0 and introduced Java DB. In the next chapter, you’ll learn one of the most popular server-side scripting languages—PHP.

**22.12 Web Resources** Many database-related resources are available on the web. This section lists several data- base resources. www.sql.org

The sql.org site is an online resource that provides a tutorial on the SQL programming language. It offers links to news groups, discussion forums, free software and various database vendors. www.deitel.com/mysql/

The Deitel MySQL Resource Center focuses on the vast amount of free MySQL content available online, plus some for-sale items. Start your search here for tools, downloads, tutorials, podcasts, wikis, documentation, conferences, FAQs, books, sample chapters, articles, newsgroups, forums, jobs, contract opportunities, and more that will help you develop MySQL database applications. www.mysql.com

This site is the MySQL database home page. You can download the latest version of MySQL and access its online documentation. www.mysql.com/products/enterprise/server.html

Introduction to the MySQL database server and links to its documentation and download sites. dev.mysql.com/doc/mysql/en/index.html

MySQL reference manual. developers.sun.com/prodtech/javadb/reference/docs/10.2.1.6/devguide/index.html

The _Java DB Developer’s Guide_.  

22.12 Web Resources **899**

www.microsoft.com/sql

The _Microsoft SQL Server_ website contains product information, technical support, SQL news and tips on using the SQL Server to solve business problems. msdn.microsoft.com/vstudio/express/sql/

The _Microsoft SQL Server Express_ website. www.w3schools.com/sql

The _SQL School_ website provides a tutorial on basic to advanced SQL commands. The site contains a short quiz that reinforces SQL concepts. www.sqlmag.com

_SQL Server Magazine_ is an excellent SQL Server resource. Subscribers receive monthly issues filled with articles on SQL design and information on current developments involving SQL. Certain ar- ticles are available for free at the website. db.apache.org/derby/

The Apache Derby website provides downloads and resources for Apache Derby.

**Summary _Section 22.1 Introduction_** • A database is an integrated collection of data. A database management system (DBMS) provides

mechanisms for storing, organizing, retrieving and modifying data.

• Today’s most popular database management systems are relational database systems.

• SQL is the international standard language used almost universally with relational database sys- tems to perform queries and manipulate data.

• Programs connect to, and interact with, relational databases systems via an interface—software that facilitates communications between a database management system and a program.

**_Section 22.2 Relational Databases_** • A relational database stores data in tables. Tables are composed of rows, and rows are composed

of columns in which values are stored.

• A primary key provides a unique value that cannot be duplicated in other rows of the same table.

• Each column of a table represents a different attribute in a row of data.

• The primary key can be composed of more than one column.

• SQL provides a rich set of language constructs that enable you to define complex queries to re- trieve data from a database.

• Every column in a primary key must have a value, and the value of the primary key must be unique. This is known as the Rule of Entity Integrity.

• A one-to-many relationship between tables indicates that a row in one table can have many re- lated rows in a separate table.

• A foreign key is a column in a table that matches the primary-key column in another table.

• The foreign key helps maintain the Rule of Referential Integrity: Every foreign-key value must appear as another table’s primary-key value. Foreign keys can be used to combine information from multiple tables. There is a one-to-many relationship between a primary key and its corre- sponding foreign key.  

**900** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**_Section 22.4.1 Basic SELECT Query_** • The basic form of a query is

SELECT \* FROM _tableName_

where the asterisk (\*) indicates that all columns from _tableName_ should be selected, and _table- Name_ specifies the table in the database from which rows will be retrieved.

• To retrieve specific columns from a table, replace the asterisk (\*) with a comma-separated list of column names.

**_Section 22.4.2 WHERE Clause_** • The optional WHERE clause in a query specifies the selection criteria for the query. The basic form

of a query with selection criteria is

SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ WHERE _criteria_

• The WHERE clause can contain operators <, >, <=, >=, =, <> and LIKE. Operator LIKE is used for string pattern matching with wildcard characters percent (%) and underscore (\_).

• A percent character (%) in a pattern indicates that a string matching the pattern can have zero or more characters at the percent character’s location in the pattern.

• An underscore (\_) in the pattern string indicates a single character at that position in the pattern.

**_Section 22.4.3 ORDER BY Clause_** • The result of a query can be sorted in ascending or descending order using the optional ORDER BY

clause. The simplest form of an ORDER BY clause is

SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ ORDER BY _column_ ASC SELECT _columnName1_, _columnName2_, _…_ FROM _tableName_ ORDER BY _column_ DESC

where ASC specifies ascending order, DESC specifies descending order and _column_ specifies the col- umn on which the sort is based. The default sorting order is ascending, so ASC is optional.

• Multiple columns can be used for ordering purposes with an ORDER BY clause of the form

ORDER BY _column1 sortingOrder_, _column2 sortingOrder_, _…_

• The WHERE and ORDER BY clauses can be combined in one query. If used, ORDER BY must be the last clause in the query.

**_Section 22.4.4 Merging Data from Multiple Tables: INNER JOIN_** • An INNER JOIN combines rows from two tables by matching values in columns that are common

to the tables. The basic form for the INNER JOIN operator is:

SELECT _columnName1, columnName2, …_ FROM _table1_ INNER JOIN _table2_

ON _table1.columnName_ \= _table2.columnName_

The ON clause specifies a condition that determines which rows are joined. This condition often compares columns from each table If a SQL statement uses columns with the same name from multiple tables, the column names must be fully qualified by prefixing them with their table names and a dot (.).

**_Section 22.4.5 INSERT Statement_** • An INSERT statement inserts a new row into a table. The basic form of this statement is

INSERT INTO _tableName_ ( _columnName1_, _columnName2_, _…_, _columnNameN_ ) VALUES ( _value1_, _value2_, _…_, _valueN_ )  

Summary **901**

where _tableName_ is the table in which to insert the row. The _tableName_ is followed by a comma- separated list of column names in parentheses. The list of column names is followed by the SQL keyword VALUES and a comma-separated list of values in parentheses.

• SQL uses single quotes (') as the delimiter for strings. To specify a string containing a single quote in SQL, the single quote must be escaped with another single quote.

**_Section 22.4.6 UPDATE Statement_** • An UPDATE statement modifies data in a table. The basic form of an UPDATE statement is

UPDATE _tableName_ SET _columnName1_ \= _value1_, _columnName2_ \= _value2_, …, _columnNameN_ \= _valueN_ WHERE _criteria_

where _tableName_ is the table in which to update data. The _tableName_ is followed by keyword SET

and a comma-separated list of column name/value pairs in the format _columnName_ \= _value_. The optional WHERE clause _criteria_ determines which rows to update.

**_Section 22.4.7 DELETE Statement_** • A DELETE statement removes rows from a table. The simplest form for a DELETE statement is

DELETE FROM _tableName_ WHERE _criteria_

where _tableName_ is the table from which to delete a row (or rows). The optional WHERE _criteria_ determines which rows to delete. If this clause is omitted, all the table’s rows are deleted.

**_Section 22.5 MySQL_** • MySQL (pronounced “my sequel”) is a robust and scalable relational database management sys-

tem (RDBMS) that was created by the Swedish consulting firm TcX in 1994.

• MySQL is a multiuser, multithreaded RDBMS server that uses SQL to interact with and manip- ulate data.

• Multithreading capabilities enable MySQL database to perform multiple tasks concurrently, al- lowing the server to process client requests efficiently.

• Implementations of MySQL are available for Windows, Mac OS X, Linux and UNIX.

**_Section 22.9 ADO.NET Object Model_** • The ADO.NET object model provides an API for accessing database systems programmatically.

• ADO.NET was created for the .NET framework to replace Microsoft’s ActiveX Data Objects (ADO) technology.

• Namespace System.Data is the root namespace for the ADO.NET API.

• Namespace System.Data.OleDb contains classes that are designed to work with any data source that supports the OLE DB API, whereas System.Data.SqlClient contains classes that are opti- mized to work with Microsoft SQL Server databases.

• An object of class SqlConnection represents a connection to a SQL Server data source.

• A SqlConnection object keeps track of the location of the data source and any settings that spec- ify how the data source is to be accessed.

• A SqlCommand object represents a SQL command that a DBMS can execute on a database.

• A connection that remains active for some length of time to permit multiple data operations is known as a persistent connection.

• A DataTable contains a collection of DataRows that represent the table’s data. A DataTable also has a collection of DataColumns that describe the columns in a table.  

**902** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

• A DataSet, which consists of a set of DataTables and the relationships among them, represents a cache of data—data that a program stores temporarily in local memory.

• The structure of a DataSet mimics the structure of a relational database.

• An advantage of using class DataSet is that it is disconnected—the program does not need a per- sistent connection to the data source to work with data in a DataSet.

• A SqlDataAdapter object connects to a SQL Server data source and executes SQL statements to both populate a DataSet and update the data source based on the current contents of a DataSet.

**_Section 22.10 Java DB/Apache Derby_** • As of the Java SE 6 Development Kit (JDK), Sun Microsystems now bundles the open source,

pure Java database Java DB (the Sun branded version of Apache Derby) with the JDK.

**Terminology** % SQL wildcard character \* SQL wildcard character \_ SQL wildcard character active database connection ADO.NET object model AND SQL keyword Apache Derby ASC SQL keyword ascending order asterisk (\*) SQL wildcard character autoincremented column value column column number in a result set combine records from tables data source database database management system (DBMS) DataColumn class DataRow class DataSet class DataTable class DELETE SQL statement DESC SQL keyword disconnected object model entity-relationship diagram escape character foreign key FROM SQL clause GROUP BY SQL clause INNER JOIN SQL clause INSERT SQL statement Java DB joining database tables LIKE SQL clause many-to-many relationship Microsoft SQL Server

MySQL mysqld-nt.exe

ON SQL clause one-to-many relationship ORDER BY SQL clause pattern matching percent (%) SQL wildcard character persistent database connection populating a DataSet

predicate primary key qualified name query relational database relational database management system

(RDBMS) relational database table row Rule of Entity Integrity Rule of Referential Integrity SELECT SQL keyword selecting data from a table selection criteria SET SQL clause single-quote character .sql filename extension SQL script SqlCommand class SqlConnection class SqlDataAdapter class Structured Query Language (SQL) System.Data namespace System.Data.OleDb namespace System.Data.SqlClient namespace table underscore (\_) SQL wildcard character  

Self-Review Exercise **903**

UPDATE SQL statement VALUES SQL clause

WHERE SQL clause

**Self-Review Exercise 22.1** Fill in the blanks in each of the following statements:

a) The international standard database language is . b) A table in a database consists of and . c) The uniquely identifies each row in a table. d) SQL keyword is followed by the selection criteria that specify the rows to

select in a query. e) SQL keywords specify the order in which rows are sorted in a query. f) Merging rows from multiple database tables is called the tables. g) A(n) is an organized collection of data. h) A(n) is a set of columns whose values match the primary key values of an-

other table.

**Answers to Self-Review Exercise 22.1** a) SQL. b) rows, columns. c) primary key. d) WHERE. e) ORDER BY. f) joining. g) database. h) foreign key.

**Exercises 22.2** Define the following terms:

a) Qualified name. b) Rule of Referential Integrity. c) Rule of Entity Integrity. d) System.Data. e) selection criteria.

**22.3** State the purpose of the following SQL keywords: a) ASC

b) FROM

c) DESC

d) INSERT

e) LIKE

f) UPDATE

g) SET

h) VALUES

i) ON

**22.4** Write SQL queries for the books database (discussed in Section 22.3) that perform each of the following tasks:

a) Select all authors from the Authors table with the columns in the order lastName, firstName and authorID.

b) Select a specific author and list all books for that author. Include the title, year and ISBN number. Order the information alphabetically by title.

c) Add a new author to the Authors table. d) Add a new title for an author (remember that the book must have an entry in the

AuthorISBN table).  

**904** Chapter 22 Database: SQL, MySQL, ADO.NET 2.0 and Java DB

**22.5** Fill in the blanks in each of the following statements: a) The states that every column in a primary key must have a value, and the

value of the primary key must be unique b) The states that every foreign-key value must appear as another table’s prima-

ry-key value. c) A(n) in a pattern indicates that a string matching the pattern can have zero

or more characters at the percent character’s location in the pattern. d) Java DB is the Sun branded version of . e) A(n) in a LIKE pattern string indicates a single character at that position in

the pattern. f) There is a(n) relationship between a primary key and its corresponding for-

eign key. g) SQL uses as the delimiter for strings. h) Microsoft’s object model provides an API for accessing database systems pro-

grammatically.

**22.6** Correct each of the following SQL statements that refer to the books database. a) SELECT firstName FROM author WHERE authorID = 3 b) SELECT isbn, title FROM Titles ORDER WITH title DESC

c) INSERT INTO Authors ( authorID, firstName, lastName )

VALUES ( "2", "Jane", "Doe" )  

23 PHP

**O B J E C T I V E S** In this chapter you will learn:

■ To manipulate data of various types.

■ To use operators, arrays and control statements.

■ To use regular expressions to search for patterns.

■ To construct programs that process form data.

■ To store data on the client using cookies.

■ To create programs that interact with MySQL databases.

**_Conversion for me was not a Damascus Road experience. I slowly moved into an intellectual acceptance of what my intuition had always known._ —Madeleine L’Engle**

**_Be careful when reading health books; you may die of a misprint._ —Mark Twain**

**_Reckoners without their host must reckon twice._ —John Heywood**

**_There was a door to which I found no key; There was the veil through which I might not see._ —Omar Khayyam**  

**906** Chapter 23 PHP **O**

**u tl**

**in e**

**23.1 Introduction PHP**, or **PHP: Hypertext Preprocessor**, has become one of the most popular server-side scripting languages for creating dynamic web pages. PHP was created by Rasmus Lerdorf to track users at his website. In 1995, Lerdorf released it as a package called the “Personal Home Page Tools.” Two years later, PHP 2 featured built-in database support and form handling. In 1997, PHP 3 was released with a rewritten parser, which substantially in- creased performance and led to an explosion of PHP use. The release of PHP 4 featured the new _Zend Engine_ from Zend, a PHP software company. This version was considerably faster and more powerful than its predecessor, further increasing PHP’s popularity. It is estimated that over 15 million domains now use PHP, accounting for more than 20 per- cent of web pages.1 Currently, PHP 5 features the _Zend Engine 2_, which provides further speed increases, exception handling and a new object-oriented programming model.2

More information about the Zend Engine can be found at www.zend.com. PHP is an open-source technology that is supported by a large community of users

and developers. PHP is platform independent—implementations exist for all major UNIX, Linux, Mac and Windows operating systems. PHP also supports many databases, including MySQL.

After introducing the basics of the PHP scripting language, we discuss form pro- cessing and business logic, which are vital to e-commerce applications. Next, we build a three-tier web application that queries a MySQL database. We also show how PHP can use cookies to store information on the client that can be retrieved during future visits to the website. Finally, we revisit the form-processing example to demonstrate some of PHP’s more dynamic capabilities.

**23.1** Introduction **23.2** PHP Basics **23.3** String Processing and Regular Expressions

**23.3.1** Comparing Strings **23.3.2** Regular Expressions

**23.4** Form Processing and Business Logic **23.5** Connecting to a Database **23.6** Using Cookies **23.7** Dynamic Content **23.8** Operator Precedence Chart **23.9** Wrap-Up

**23.10** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises

1\. “History of PHP,” 30 June 2007, _PHP_ <us.php.net/history>. 2. Suraski, Z., “The OO Evolution of PHP,” 16 March 2004, _Zend_ <devzone.zend.com/node/view/

id/1717>.  

23.2 PHP Basics **907**

**23.2 PHP Basics** The power of the web resides not only in serving content to users, but also in responding to requests from users and generating web pages with dynamic content. Interactivity be- tween the user and the server has become a crucial part of web functionality, making PHP—a language written specifically for interacting with the web—a valuable tool.

**_Installing PHP_** PHP code is embedded directly into XHTML documents, though these script segments are interpreted by the server before being delivered to the client. This allows the document author to write XHTML in a clear, concise manner. PHP script file names end with .php.

To run a PHP script, PHP must first be installed on your system. All examples and exercises in this chapter have been verified using PHP 5.2.3, the most current release at the time of publication. The most recent version of PHP can be downloaded from www.php.net/downloads.php, and installation instructions are available at www.php.net/ manual/en/installation.php. Be sure to check for specific instructions that pertain to the server you want to use. During setup, when the **Choose Items to Install** window is dis- played, expand the **Extensions** menu by clicking the small plus sign to its left. Then click the down arrow to the left of the MySQL option, and select the **Will be installed on local hard drive** option. This will ensure that your PHP script will be able to access your MySQL database server for examples later in this chapter.

Although PHP can be used from the command line, a web server is necessary to take full advantage of the scripting language. Before continuing, files from the Chapter 23 examples directory to the web server’s root directory (e.g., C:\\Inetpub\\wwwroot for IIS or C:\\Program Files\\Apache Software Foundation\\Apache2\\htdocs for Apache on Win- dows or /var/www/html or similar on Linux).

**_Simple PHP Program_** Figure 23.1 presents a simple PHP program that displays a welcome message. In PHP, code is inserted between the scripting delimiters **<?php** and **?>**. PHP code can be placed anywhere in XHTML markup, as long as the code is enclosed in these delimiters. Line 1 uses function print to output the XML declaration. This avoids the <? in the XML dec-

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.1: first.php --> **6** <!-- Simple PHP program. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8 9**

**10 11** <head> **12** <title>Using PHP document</title> **13** </head> **14** <body style = "font-size: 2em">

**Fig. 23.1** | Simple PHP program. (Part 1 of 2.)

<?php $name = "Harvey"; // declaration and initialization

?><!-- end PHP script -->  

**908** Chapter 23 PHP

laration getting interpreted as an incorrect PHP scripting delimiter. Line 9 declares vari- able $name and assigns it the string “Harvey”. All variables are preceded by a **$** and are created the first time they are encountered by the PHP interpreter. PHP statements ter- minate with a **semicolon (;)**.

**Common Programming Error 23.1** _Failing to precede a variable name with a $ is a syntax error._ 23.1

**Common Programming Error 23.2** _Variable names in PHP are case sensitive. Failure to use the proper mixture of cases to refer to a variable will result in a logic error, since the script will create a new variable for any name it doesn’t recognize as a previously used variable._ 23.2

**Common Programming Error 23.3** _Forgetting to terminate a statement with a semicolon (;) is a syntax error._ 23.3

Line 9 also contains a **single-line comment**, which begins with two forward slashes (//). Text to the right of the slashes is ignored by the interpreter. Single-line comments can also begin with the pound sign (#). Multiline comments begin with delimiter **/\*** and end with delimiter **\*/**.

Line 18 outputs the value of variable $name by calling function **print**. The actual value of $name is printed, not the string "$name". When a variable is encountered inside a double-quoted ("") string, PHP **interpolates** the variable. In other words, PHP inserts the variable’s value where the variable name appears in the string. Thus, variable $name is replaced by Harvey for printing purposes. All operations of this type execute on the server before the XHTML document is sent to the client. You can see by viewing the source of a PHP document that the code sent to the client does not contain any PHP code.

**15** <p> **16** <strong> **17** <!-- print variable name’s value --> **18** Welcome to PHP, ! **19** </strong> **20** </p> **21** </body> **22** </html>

**Fig. 23.1** | Simple PHP program. (Part 2 of 2.)

<?php print( "$name" ); ?>  

23.2 PHP Basics **909**

PHP variables are loosely typed—they can contain different types of data (e.g., **inte- gers**, **doubles** or **strings**) at different times. Figure 23.2 introduces these data types.

**_Converting Between Data Types_** Converting between different data types may be necessary when performing arithmetic operations with variables. Type conversions can be performed using function settype. Figure 23.3 demonstrates type conversion of some types introduced in Fig. 23.2.

Type Description

int, integer Whole numbers (i.e., numbers without a decimal point).

float, double, real Real numbers (i.e., numbers containing a decimal point).

string Text enclosed in either single ('') or double ("") quotes. \[_Note:_ Using double quotes allows PHP to recognize more escape sequences.\]

bool, boolean True or false.

array Group of elements.

object Group of associated data and methods.

resource An external source—usually information from a database.

NULL No value.

**Fig. 23.2** | PHP types.

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.3: data.php --> **6** <!-- Data type conversion. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Data type conversion</title>

**10** </head> **11** <body> **12** <?php **13** // declare a string, double and integer **14 15 16 17** ?><!-- end PHP script --> **18 19** <!-- print each variable’s value and type --> **20** <?php **21** print( "$testString is a(n) " . gettype( $testString ) **22** . "<br />" );

**Fig. 23.3** | Data type conversion. (Part 1 of 2.)

$testString = "3.5 seconds"; $testDouble = 79.2; $testInteger = 12;  

**910** Chapter 23 PHP

**23** print( "$testDouble is a(n) " . gettype( $testDouble ) **24** . "<br />" ); **25** print( "$testInteger is a(n) " . gettype( $testInteger) **26** . "<br />" ); **27** ?><!-- end PHP script --> **28** <br /> **29** converting to other data types:<br /> **30** <?php **31** // call function settype to convert variable **32** // testString to different data types **33 34 35** print( " as a double is $testString <br />" ); **36** print( "$testString" ); **37 38** print( " as an integer is $testString <br />" ); **39 40** print( "converting back to a string results in **41** $testString <br /><br />" ); **42 43** // use type casting to cast variables to a different type **44 45** print( "before casting, $data is a " . **46** gettype( $data ) . "<br /><br />" ); **47** print( "using type casting instead: <br /> **48 49 50** print( "<br /><br />after casting, $data is a " . **51** gettype( $data ) ); **52** ?><!-- end PHP script --> **53** </body> **54** </html>

**Fig. 23.3** | Data type conversion. (Part 2 of 2.)

print( "$testString" ); settype( $testString, "double" );

settype( $testString, "integer" );

settype( $testString, "string" );

$data = "98.6 degrees";

as a double: " . (double) $data . "<br />as an integer: " . (integer) $data );  

23.2 PHP Basics **911**

Lines 14–16 of Fig. 23.3 assign a string to variable $testString, a floating-point number to variable $testDouble and an integer to variable $testInteger. Variables are automatically converted to the type of the value they are assigned. For example, variable $testString becomes a string when assigned the value "3.5 seconds". Lines 22–27 print the value of each variable and their types using function **gettype**, which returns the current type of its argument. Note that when a variable is in a print statement but not part of a string, enclosing the variable name in double quotes is unnecessary. Lines 35, 38 and 40 call **settype** to modify the type of each variable. Function settype takes two argu- ments—the variable whose type is to be changed and the variable’s new type.

Calling function settype can result in loss of data. For example, doubles are truncated when they are converted to integers. When converting from a string to a number, PHP uses the value of the number that appears at the beginning of the string. If no number appears at the beginning, the string evaluates to 0. In line 35, the string "3.5 seconds" is converted to a double, storing 3.5 in variable $testString. In line 38, double 3.5 is converted to integer 3. When we convert this variable to a string (line 40), the variable’s value becomes "3"—much of the original content from the variable’s declaration in line 14 is lost.

Another option for conversion between types is **casting** (or **type casting**). Unlike settype, casting does not change a variable’s content—it creates a temporary copy of a variable’s value in memory. Lines 48–49 cast variable $data’s value (declared in line 17) from a string to a double and an integer. Casting is useful when a different type is required in a specific operation but you would like to retain the variable’s original value and type. Lines 45–51 show that the type and value of $data remain unchanged even after it has been cast several times.

The **concatenation operator (.)** combines multiple strings in the same print state- ment, as demonstrated in lines 45–51. A print statement may be split over multiple lines—all data that is enclosed in the parentheses and terminated by a semicolon is printed to the XHTML document.

**Error-Prevention Tip 23.1** _Function print can be used to display the value of a variable at a particular point during a pro- gram’s execution. This is often helpful in debugging a script._ 23.1

**_Arithmetic Operators_** PHP provides several arithmetic operators, which we demonstrate in Fig. 23.4. Line 13 declares variable $a and assigns to it the value 5. Line 17 calls function define to create a **named constant**. Function define takes two arguments—the name and value of the con- stant. An optional third argument accepts a bool value that specifies whether the constant is case insensitive—constants are case sensitive by default.

**Common Programming Error 23.4** _Assigning a value to a constant after it is declared is a syntax error._ 23.4

Line 20 adds constant VALUE to variable $a. Line 25 uses the **multiplication assign- ment operator \*=** to yield an expression equivalent to $a = $a \* 2 (thus assigning $a the value 20). Arithmetic assignment operators—like the ones described in Chapter 7—are syntactical shortcuts. Line 33 adds 40 to the value of variable $a.  

**912** Chapter 23 PHP

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.4: operators.php --> **6** <!-- Using arithmetic operators. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Using arithmetic operators</title>

**10** </head> **11** <body> **12** <?php **13** $a = 5; **14** print( "The value of variable a is $a <br />" ); **15 16** // define constant VALUE **17 18 19** // add constant VALUE to variable $a **20** $a = $a + VALUE; **21** print( "Variable a after adding constant VALUE **22** is $a <br />" ); **23 24** // multiply variable $a by 2 **25 26** print( "Multiplying variable a by 2 yields $a <br />" ); **27 28** // test if variable $a is less than 50 **29** if ( $a < 50 ) **30** print( "Variable a is less than 50 <br />" ); **31 32** // add 40 to variable $a **33 34** print( "Variable a after adding 40 is $a <br />" ); **35 36** // test if variable $a is 50 or less **37 38** print( "Variable a is still 50 or less<br />" ); **39 40** // test if variable $a is between 50 and 100, inclusive **41 42** print( "Variable a is now between 50 and 100, **43** inclusive<br />" ); **44 45** print( "Variable a is now greater than 100 <br />" ); **46 47** // print an uninitialized variable **48** print( "Using a variable before initializing: **49** $nothing <br />" ); // nothing evaluates to "" **50 51** // add constant VALUE to an uninitialized variable **52** $test = + VALUE; // num evaluates to 0

**Fig. 23.4** | Using arithmetic operators. (Part 1 of 2.)

define( "VALUE", 5 );

$a \*= 2;

$a += 40;

if ( $a < 51 )

elseif ( $a < 101 )

else

$num  

23.2 PHP Basics **913**

Uninitialized variables have the value **undef**, which evaluates to different values, depending on its context. For example, when undef is used in a numeric context (e.g., $num in line 52), it evaluates to 0. In contrast, when undef is interpreted in a string context (e.g., $nothing in line 49), it evaluates to an empty string ("").

**Error-Prevention Tip 23.2** _Initialize variables before they are used to avoid subtle errors. For example, multiplying a num- ber by an uninitialized variable results in 0._ 23.4

Strings are automatically converted to integers or doubles when they are used in arith- metic operations. In line 58, a copy of the value of variable str, "3 dollars", is converted to the integer 3 for use in the calculation. The type and value of variable $str are left unchanged.

Keywords (examples from Fig. 23.4 include if, elseif and else) may not be used as identifiers. Figure 23.5 lists all keywords.

**_Initializing and Manipulating Arrays_** PHP provides the capability to store data in arrays. Arrays are divided into elements that behave as individual variables. Array names, like other variables, begin with the $ symbol. Figure 23.6 demonstrates initializing and manipulating arrays. Individual array elements are accessed by following the array’s variable name with an index enclosed in square brack- ets (\[\]). If a value is assigned to an array that does not exist, then the array is created (line

**53** print( "An uninitialized variable plus constant **54** VALUE yields $test <br />" ); **55 56** // add a string to an integer **57 58 59** print( "Adding a string to variable a yields $a <br />" ); **60** ?><!-- end PHP script --> **61** </body> **62** </html>

**Fig. 23.4** | Using arithmetic operators. (Part 2 of 2.)

$str = "3 dollars"; $a += $str;  

**914** Chapter 23 PHP

15). Likewise, assigning a value to an element where the index is omitted appends a new element to the end of the array (line 18). The for statement (lines 21–22) prints each element’s value. Function **count** returns the total number of elements in the array. In this example, the for statement terminates when the counter ($i) is equal to the number of array elements.

Line 28 demonstrates a second method of initializing arrays. Function **array** creates an array that contains the arguments passed to it. The first item in the argument list is stored as the first array element (recall that the first element’s index is 0), the second item is stored as the second array element and so on. Lines 30–31 display the array’s contents.

PHP keywords

abstract die exit interface require

and do extends isset require\_once

array echo \_\_FILE\_\_ \_\_LINE\_\_ return

as else file line static

break elseif final list switch

case empty for \_\_METHOD\_\_ throw

catch enddeclare foreach method try

\_\_CLASS\_\_ endfor \_\_FUNCTION\_\_ new unset

class endforeach function or use

clone endif global php\_user\_filter var

const endswitch if print while

continue endwhile implements private xor

declare eval include protected

default exception include\_once public

**Fig. 23.5** | PHP keywords.

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.6: arrays.php --> **6** <!-- Array manipulation. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Array manipulation</title>

**10** </head> **11** <body> **12** <?php

**Fig. 23.6** | Array manipulation. (Part 1 of 3.)  

23.2 PHP Basics **915**

**13** // create array first **14** print( "<strong>Creating the first array</strong><br />" ); **15 16** $first\[ 1 \] = "one"; **17** $first\[ 2 \] = "two"; **18 19 20** // print each element’s index and value **21** for ( $i = 0; $i < ; $i++ ) **22** print( "Element $i is $first\[$i\] <br />" ); **23 24** print( "<br /><strong>Creating the second array **25** </strong><br />" ); **26 27** // call function array to create array second **28** $second = **29 30** for ( $i = 0; $i < count( $second ); $i++ ) **31** print( "Element $i is $second\[$i\] <br />" ); **32 33** print( "<br /><strong>Creating the third array **34** </strong><br />" ); **35 36** // assign values to entries using nonnumeric indices **37 38** $third\[ "Bob" \] = 18; **39** $third\[ "Carol" \] = 23; **40 41** // iterate through the array elements and print each **42** // element’s name and value **43 44** print( "$element is $third\[$element\] <br />" ); **45 46** print( "<br /><strong>Creating the fourth array **47** </strong><br />" ); **48 49** // call function array to create array fourth using **50** // string indices **51** $fourth = array( **52** , "February" => "second", **53** "March" => "third", "April" => "fourth", **54** "May" => "fifth", "June" => "sixth", **55** "July" => "seventh", "August" => "eighth", **56** "September" => "ninth", "October" => "tenth", **57** "November" => "eleventh","December" => "twelfth" **58** ); **59 60** // print each element’s name and value **61 62** print( "$element is the $value month <br />" ); **63** ?><!-- end PHP script --> **64** </body> **65** </html>

**Fig. 23.6** | Array manipulation. (Part 2 of 3.)

$first\[ 0 \] = "zero";

$first\[\] = "three";

count( $first )

array( "zero", "one", "two", "three" );

$third\[ "Amy" \] = 21;

for ( reset( $third ); $element = key( $third ); next( $third ) )

"January" => "first"

foreach ( $fourth as $element => $value )  

**916** Chapter 23 PHP

In addition to integer indices, arrays can have float or nonnumeric indices (lines 37– 39). An array with noninteger indices is called an **associative array**. For example, indices Amy, Bob and Carol are assigned the values 21, 18 and 23, respectively.

PHP provides functions for **iterating** through the elements of an array (line 43). Each array has a built-in **internal pointer**, which points to the array element currently being ref- erenced. Function **reset** sets the internal pointer to the first array element. Function **key**

returns the index of the element currently referenced by the internal pointer, and function **next** moves the internal pointer to the next element and returns the element. In our script, the for statement continues to execute as long as function key returns an index. Function next returns false when there are no more elements in the array. When this occurs, func- tion key cannot return an index, $element is set to false and the for statement termi- nates. Line 44 prints the index and value of each element.

The array $fourth is also associative. To override the automatic numeric indexing performed by function array, you can use operator =>, as demonstrated in lines 51–58. The value to the left of the operator is the array index and the value to the right is the ele- ment’s value.

**Fig. 23.6** | Array manipulation. (Part 3 of 3.)  

23.3 String Processing and Regular Expressions **917**

The **foreach** control statement (lines 61–62) is specifically designed for iterating through arrays, especially associative arrays, because it does not assume that the array has consecutive integer indices that start at 0. The foreach statement starts with the array to iterate through, followed by the keyword **as**, followed by two variables—the first is assigned the index of the element, and the second is assigned the value of that index. (If there is only one variable listed after as, it is assigned the value of the array element.) We use the foreach statement to print the index and value of each element in array $fourth.

**23.3 String Processing and Regular Expressions** PHP can process text easily and efficiently, enabling straightforward searching, substitu- tion, extraction and concatenation of strings. Text manipulation is usually done with **reg- ular expressions**—a series of characters that serve as pattern-matching templates (or search criteria) in strings, text files and databases.

**23.3.1 Comparing Strings** Many string-processing tasks can be accomplished by using the **equality** and **comparison** operators, demonstrated in Fig. 23.7. Line 14 declares and initializes array $fruits. Lines 17–36 iterate through each element in the $fruits array.

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.7: compare.php --> **6** <!-- Using the string-comparison operators. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>String Comparison</title>

**10** </head> **11** <body> **12** <?php **13** // create array fruits **14** $fruits = array( "apple", "orange", "banana" ); **15 16** // iterate through each array element **17** for ( $i = 0; $i < count( $fruits ); $i++ ) **18** { **19** // call function strcmp to compare the array element **20** // to string "banana" **21** if ( < 0 ) **22** print( $fruits\[ $i \] . " is less than banana " ); **23** elseif ( strcmp( $fruits\[ $i \], "banana" ) > 0 ) **24** print( $fruits\[ $i \] . " is greater than banana " ); **25** else **26** print( $fruits\[ $i \] . " is equal to banana " ); **27 28** // use relational operators to compare each element **29** // to string "apple"

**Fig. 23.7** | Using the string-comparison operators. (Part 1 of 2.)

strcmp( $fruits\[ $i \], "banana" )  

**918** Chapter 23 PHP

Lines 21 and 23 call function **strcmp** to compare two strings. The function returns -1 if the first string alphabetically precedes the second string, 0 if the strings are equal, and 1 if the first string alphabetically follows the second. Lines 21–26 compare each element in the $fruits array to the string "banana", printing whether each is greater than, less than or equal to the string.

Relational operators (==, !=, <, <=, > and >=) can also be used to compare strings. Lines 30–35 use relational operators to compare each element of the array to the string "apple".

**23.3.2 Regular Expressions** Functions **ereg** and **preg\_match** use regular expressions to search a string for a specified pattern. Function ereg recognizes **Portable Operating System Interface (POSIX) extend- ed regular expressions**, while function preg\_match provides **Perl-compatible regular ex- pressions (PCRE)**. To use preg\_match, you must install the PCRE library on your web server and add support for the library to PHP. More information on PCRE can be found at www.pcre.org. PHP 5 supports POSIX regular expressions, so we use function ereg in this section. Figure 23.8 demonstrates regular expressions.

**30 31** print( "and less than apple! <br />" ); **32 33** print( "and greater than apple! <br />" ); **34 35** print( "and equal to apple! <br />" ); **36** } // end for **37** ?><!-- end PHP script --> **38** </body> **39** </html>

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.8: expression.php --> **6** <!-- Regular expressions. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head>

**Fig. 23.8** | Regular expressions. (Part 1 of 2.)

**Fig. 23.7** | Using the string-comparison operators. (Part 2 of 2.)

if ( $fruits\[ $i \] < "apple" )

elseif ( $fruits\[ $i \] > "apple" )

elseif ( $fruits\[ $i \] == "apple" )  

23.3 String Processing and Regular Expressions **919**

**9** <title>Regular expressions</title> **10** </head> **11** <body> **12** <?php **13 14** print( "Test string is: '$search'<br /><br />" ); **15 16** // call ereg to search for pattern 'Now' in variable search **17** if ( ) **18** print( "String 'Now' was found.<br />" ); **19 20** // search for pattern 'Now' in the beginning of the string **21** if ( ) **22** print( "String 'Now' found at beginning **23** of the line.<br />" ); **24 25** // search for pattern 'Now' at the end of the string **26** if ( ) **27** print( "String 'Now' was found at the end **28** of the line.<br />" ); **29 30** // search for any word ending in 'ow' **31 32** print( "Word found ending in 'ow': " . **33** . "<br />" ); **34 35** // search for any words beginning with 't' **36** print( "Words beginning with 't' found: "); **37 38 39 40** { **41** print( $match\[ 1 \] . " " ); **42 43** // remove the first occurrence of a word beginning **44** // with 't' to find other instances in the string **45 46** } // end while **47** ?><!-- end PHP script --> **48** </body> **49** </html>

**Fig. 23.8** | Regular expressions. (Part 2 of 2.)

$search = "Now is the time";

ereg( "Now", $search )

ereg( "^Now", $search )

ereg( "Now$", $search )

if ( ereg( "\[\[:<:\]\](\[a-zA-Z\]\*ow)\[\[:>:\]\]", $search, $match ) )

$match\[ 1 \]

while ( eregi( "\[\[:<:\]\](t\[\[:alpha:\]\]+)\[\[:>:\]\]", $search, $match ) )

$search = ereg\_replace( $match\[ 1 \], "", $search );  

**920** Chapter 23 PHP

**_Searching for Expressions_** Line 13 assigns the string "Now is the time" to variable $search. The condition in line 17 calls function ereg to search for the **literal characters** "Now" inside variable $search. If the pattern is found, ereg returns the length of the matched string—which evaluates to true in a boolean context—and line 18 prints a message indicating that the pattern was found. We use single quotes ('') inside the string in the print statement to emphasize the search pattern. Anything enclosed in single quotes is not interpolated (unless the single quotes are nested in a double-quoted string literal, as in line 14). For example, '$name' in a print statement would output $name, not variable $name’s value.

Function ereg takes two arguments—a regular expression pattern to search for and the string to search. Although case mixture is often significant in patterns, PHP provides function **eregi** for specifying case-insensitive pattern matches.

**_Representing Patterns_** In addition to literal characters, regular expressions can include **metacharacters** that spec- ify patterns. Examples of metacharacters include the ^, $ and . characters. The **caret (^)** metacharacter matches the beginning of a string (line 21), while the **dollar sign ($)** match- es the end of a string (line 26). The **period (.)** metacharacter matches any single character. Line 21 searches for the pattern "Now" at the beginning of $search. Line 26 searches for "Now" at the end of the string. Since the pattern is not found in this case, the body of the if statement (lines 27–28) does not execute. Note that Now$ is not a variable—it is a pat- tern that uses $ to search for the characters "Now" at the end of a string.

Line 31 searches (from left to right) for the first word ending with the letters ow. **Bracket expressions** are lists of characters enclosed in square brackets (\[\]) that match any single character from the list. Ranges can be specified by supplying the beginning and the end of the range separated by a **dash (-)**. For instance, the bracket expression \[a-z\]

matches any lowercase letter and \[A-Z\] matches any uppercase letter. In this example, we combine the two to create an expression that matches any letter. The special bracket expressions **\[\[:<:\]\]** and **\[\[:>:\]\]** match the beginning and end of a word, respectively.

The expression \[a-zA-Z\]\*ow inside the parentheses represents any word ending in ow. The **quantifier \*** matches the preceding pattern zero or more times. Thus, \[a-zA-Z\]\*ow matches any number of letters followed by the literal characters ow. Quantifiers are used in regular expressions to denote how often a particular character or set of characters can appear in a match. Some PHP quantifiers are listed in Fig. 23.9.

Quantifier Matches

{_n_} Exactly _n_ times.

{_m_,_n_} Between _m_ and _n_ times, inclusive.

{_n_,} _n_ or more times.

\+ One or more times (same as {1,}).

\* Zero or more times (same as {0,}).

? Zero or one time (same as {0,1}).

**Fig. 23.9** | Some PHP quantifiers.  

23.3 String Processing and Regular Expressions **921**

**_Finding Matches_** The optional third argument to function ereg is an array that stores matches to the regular expression. When the expression is broken down into parenthetical sub-expressions, func- tion ereg stores the first encountered instance of each expression in this array, starting from the leftmost parenthesis. The first element (i.e., index 0) stores the string matched for the entire pattern. The match to the first parenthetical pattern is stored in the second array element, the second in the third array element and so on. If the parenthetical pattern is not encountered, the value of the array element remains uninitialized. Because the state- ment in line 31 is the first parenthetical pattern, Now is stored in variable $match\[ 1 \] (and, because it is the _only_ parenthetical statement in this case, it is also stored in $match\[ 0 \]).

Searching for multiple instances of a single pattern in a string is slightly more compli- cated, because the ereg function returns only the first instance it encounters. To find mul- tiple instances of a given pattern, we must make multiple calls to ereg, and remove any matched instances before calling the function again. Lines 38–46 use a **while** statement and the **ereg\_replace** function to find all the words in the string that begin with t. We’ll say more about this function momentarily.

**_Character Classes_** The pattern in line 38, \[\[:<:\]\](t\[\[:alpha:\]\]+)\[\[:>:\]\], matches any word beginning with the character t followed by one or more letters. The pattern uses the **character class** \[\[:alpha:\]\] to recognize any letter—this is equivalent to the \[a-zA-Z\]. Figure 23.10 lists some character classes that can be matched with regular expressions.

Character classes are enclosed by the delimiters \[: and :\]. When this expression is placed in another set of brackets, such as \[\[:alpha:\]\] in line 38, it is a regular expression matching a single character that is a member of the class. A bracketed expression con- taining two or more adjacent character classes in the class delimiters represents those char- acter sets combined. For example, the expression \[\[:upper:\]\[:lower:\]\]\* represents all strings of uppercase and lowercase letters in any order, while \[\[:upper:\]\]\[\[:lower:\]\]\*

matches strings with a single uppercase letter followed by any number of lowercase char- acters. Also, note that (\[\[:upper:\]\]\[\[:lower:\]\])\* is an expression for all strings that alternate between uppercase and lowercase characters (starting with uppercase and ending with lowercase).

Character class Description

alnum Alphanumeric characters (i.e., letters \[a-zA-Z\] or digits \[0-9\]).

alpha Word characters (i.e., letters \[a-zA-Z\]).

digit Digits.

space White space.

lower Lowercase letters.

upper Uppercase letters.

**Fig. 23.10** | Some PHP character classes.  

**922** Chapter 23 PHP

**_Finding Multiple Instances of a Pattern_** The quantifier + matches one or more consecutive instances of the preceding expression. The result of the match is stored in $match\[ 1 \]. Once a match is found, we print it in line 41. We then remove it from the string in line 45, using function ereg\_replace. This function takes three arguments—the pattern to match, a string to replace the matched string and the string to search. The modified string is returned. Here, we search for the word that we matched with the regular expression, replace the word with an empty string, then assign the result back to $search. This allows us to match any other words beginning with the character t in the string and print them to the screen.

**23.4 Form Processing and Business Logic _Superglobal Arrays_** Knowledge of a client’s execution environment is useful to system administrators who want to access client-specific information such as the client’s web browser, the server name or the data sent to the server by the client. One way to obtain this data is by using a **su- perglobal array**. Superglobal arrays are associative arrays predefined by PHP that hold vari- ables acquired from user input, the environment or the web server, and are accessible in any variable scope. Some of PHP’s superglobal arrays are listed in Figure 23.11.

Superglobal arrays are useful for verifying user input. The arrays $\_GET and $\_POST

retrieve information sent to the server by HTTP get and post requests, respectively, making it possible for a script to have access to this data when it loads another page. For example, if data entered by a user into a form is posted to a script, the $\_POST array will contain all of this information in the new script. Thus, any information entered into the form can be accessed easily from a confirmation page, or a page that verifies whether fields have been entered correctly.

**_Using PHP to Process XHTML Forms_** XHTML forms enable web pages to collect data from users and send it to a web server for processing. Such capabilities allow users to purchase products, request information, send and receive web-based e-mail, create profiles in online networking services and take advan- tage of various other online services. The XHTML form in Fig. 23.12 gathers information to add a user to a mailing list.

Variable name Description

$\_SERVER Data about the currently running server.

$\_ENV Data about the client’s environment.

$\_GET Data sent to the server by a get request.

$\_POST Data sent to the server by a post request.

$\_COOKIE Data contained in cookies on the client’s computer.

$GLOBALS Array containing all global variables.

**Fig. 23.11** | Some useful superglobal arrays.  

23.4 Form Processing and Business Logic **923**

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.12: form.html --> **6** <!-- XHTML form for gathering user input. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Sample form to take user input in XHTML</title>

**10** <style type = "text/css"> **11** .prompt { color: blue; **12** font-family: sans-serif; **13** font-size: smaller } **14** </style> **15** </head> **16** <body> **17** <h1>Sample Registration Form</h1> **18** <p>Please fill in all fields and click Register.</p> **19 20** <!-- post form data to form.php --> **21 22** <div> **23** <img src = "images/user.gif" alt = "User" /><br /> **24** <span class = "prompt"> **25** Please fill out the fields below.<br /> **26** </span> **27 28** <!-- create four text boxes for user input --> **29** <img src = "images/fname.gif" alt = "First Name" /> **30 31 32** <img src = "images/lname.gif" alt = "Last Name" /> **33 34 35** <img src = "images/email.gif" alt = "Email" /> **36 37 38** <img src = "images/phone.gif" alt = "Phone" /> **39 40 41** <span style = "font-size: 10pt"> **42** Must be in the form (555)555-5555</span> **43** <br /><br /> **44 45** <img src = "images/downloads.gif" **46** alt = "Publications" /><br /> **47 48** <span class = "prompt"> **49** Which book would you like information about? **50** </span><br /> **51 52** <!-- create drop-down list containing book names --> **53**

**Fig. 23.12** | XHTML form for gathering user input. (Part 1 of 2.)

<form method = "post" action = "form.php">

<input type = "text" name = "fname" /><br />

<input type = "text" name = "lname" /><br />

<input type = "text" name = "email" /><br />

<input type = "text" name = "phone" /><br />

<select name = "book">  

**924** Chapter 23 PHP

**54** <option>Internet and WWW How to Program 4e</option> **55** <option>C++ How to Program 6e</option> **56** <option>Java How to Program 7e</option> **57** <option>Visual Basic 2005 How to Program 3e</option> **58** </select> **59** <br /><br /> **60 61** <img src = "images/os.gif" alt = "Operating System" /> **62** <br /><span class = "prompt"> **63** Which operating system are you currently using? **64** <br /></span> **65 66** <!-- create five radio buttons --> **67 68 69** <input type = "radio" name = "os" value = **70** "Windows Vista" /> Windows Vista<br /> **71** <input type = "radio" name = "os" value = **72** "Mac OS X" /> Mac OS X **73** <input type = "radio" name = "os" value = "Linux" /> Linux **74** <input type = "radio" name = "os" value = "Other" /> **75** Other<br /> **76 77** <!-- create a submit button --> **78** <input type = "submit" value = "Register" /> **79** </div> **80** </form> **81** </body> **82** </html>

**Fig. 23.12** | XHTML form for gathering user input. (Part 2 of 2.)

<input type = "radio" name = "os" value = "Windows XP" checked = "checked" /> Windows XP  

23.4 Form Processing and Business Logic **925**

The form’s action attribute (line 21) indicates that when the user clicks the **Register** button, the form data will be posted to form.php (Fig. 23.13) for processing. Using method = "post" appends form data to the browser request that contains the protocol (i.e., HTTP) and the URL of the requested resource (specified by the action attribute). Scripts located on the web server’s machine can access the form data sent as part of the request.

We assign a unique name (e.g., email) to each of the form’s controls. When **Register** is clicked, each field’s name and value are sent to the web server. Script form.php accesses the value for each field through the superglobal array **$\_POST**, which contains key/value pairs corresponding to name/value pairs for variables submitted through the form. \[_Note:_ The superglobal array **$\_GET** would contain these key/value pairs if the form had been sub- mitted using the HTTP _get_ method. In general, get is not as secure as post, because it appends the information directly to the URL, which is visible to the user.\] Figure 23.13 processes the data posted by form.html and sends XHTML back to the client.

**Good Programming Practice 23.1** _Use meaningful XHTML object names for input fields. This makes PHP scripts that retrieve form data easier to understand._ 23.1

Function **extract** (line 29 in Fig. 23.13) creates a variable/value pair corresponding to each key/value pair in the associative array passed as an argument (i.e., $\_POST). This creates variables whose respective names and values correspond to the names and values of each posted form field. For example, line 36 in Fig. 23.12 creates an XHTML text box with the name email. In line 70 of our PHP script (Fig. 23.13), after having called func- tion extract, we access the field’s value by using variable $email. Elements in $\_POST can also be accessed using standard array notation. For example, we could have accessed the form field email’s value by referring to $\_POST\[ 'email' \].

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.13: form.php --> **6** <!-- Process information sent from form.html. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Form Validation</title>

**10** <style type = "text/css"> **11** body { font-family: arial, sans-serif } **12** div { font-size: 10pt; **13** text-align: center } **14** table { border: 0 } **15** td { padding-top: 2px; **16** padding-bottom: 2px; **17** padding-left: 10px; **18** padding-right: 10px } **19** .error { color: red } **20** .distinct { color: blue } **21** .name { background-color: #ffffaa }

**Fig. 23.13** | Process information sent from form.html. (Part 1 of 4.)  

**926** Chapter 23 PHP

**22** .email { background-color: #ffffbb } **23** .phone { background-color: #ffffcc } **24** .os { background-color: #ffffdd } **25** </style> **26** </head> **27** <body> **28** <?php **29 30 31** // determine whether phone number is valid and print **32** // an error message if not **33 34** { **35** print( "<p><span class = 'error'> **36** Invalid phone number</span><br /> **37** A valid phone number must be in the form **38** <strong>(555)555-5555</strong><br /> **39** <span class = 'distinct'> **40** Click the Back button, enter a valid phone **41** number and resubmit.<br /><br /> **42** Thank You.</span></p>" ); **43** // terminate script execution **44** } **45** ?><!-- end PHP script --> **46** <p>Hi **47** <span class = "distinct"> **48** <strong><?php print( "$fname" ); ?></strong> **49** </span>. **50** Thank you for completing the survey.<br /> **51** You have been added to the **52** <span class = "distinct"> **53** <strong><?php print( "$book " ); ?></strong> **54** </span> **55** mailing list. **56** </p> **57** <p><strong>The following information has been saved **58** in our database:</strong></p> **59** <table> **60** <tr> **61** <td class = "name">Name </td> **62** <td class = "email">Email</td> **63** <td class = "phone">Phone</td> **64** <td class = "os">OS</td> **65** </tr> **66** <tr> **67** <?php **68** // print each form field’s value **69** print( "<td>$fname $lname</td> **70** <td> </td> **71** <td>$phone</td> **72** <td>$os</td>" ); **73** ?><!-- end PHP script --> **74** </tr>

**Fig. 23.13** | Process information sent from form.html. (Part 2 of 4.)

extract( $\_POST );

if ( !ereg( "^\\(\[0-9\]{3}\\)\[0-9\]{3}-\[0-9\]{4}$", $phone ) )

die( "</body></html>" );

$email  

23.4 Form Processing and Business Logic **927**

**75** </table> **76** <br /><br /><br /> **77** <div>This is only a sample form. **78** You have not been added to a mailing list.</div> **79** </body> **80** </html>

**Fig. 23.13** | Process information sent from form.html. (Part 3 of 4.)

a) The form in form.html is filled out with an incorrect phone number.

b) The user is redirected to form.php, which gives appropriate instructions.  

**928** Chapter 23 PHP

**Fig. 23.13** | Process information sent from form.html. (Part 4 of 4.)

c) The form is now filled out correctly.

d) The user is directed to an acceptance page, which displays the entered information.  

23.5 Connecting to a Database **929**

Line 33 determines whether the phone number entered by the user is valid. In this case, the phone number must begin with an opening parenthesis, followed by an area code, a closing parenthesis, an exchange, a hyphen and a line number. It is crucial to validate information that will be entered into databases or used in mailing lists. For example, val- idation can be used to ensure that credit card numbers contain the proper number of digits before the numbers are encrypted and sent to a merchant. This script implements the **busi- ness logic**, or **business rules**, of our application.

**Software Engineering Observation 23.1** _Use business logic to ensure that invalid information is not stored in databases. When possible, validate important or sensitive form data on the server, since JavaScript may be disabled by the client. Some data, such as passwords, must always be validated on the server side._ 23.1

The expression \\( matches the opening parenthesis of the phone number. We want to match the literal character (, so we **escape** its normal meaning by preceding it with the backslash character (\\). This parenthesis in the expression must be followed by three digits (\[0-9\]{3}), a closing parenthesis, three more digits, a literal hyphen and four additional digits. Note that we use the ^ and $ symbols to ensure that no extra characters appear at either end of the string.

If the regular expression is matched, the phone number has a valid format, and an XHTML document is sent to the client that thanks the user for completing the form. Oth- erwise, the body of the if statement executes and displays an error message.

Function **die** (line 43) terminates script execution. This function is called if the user did not enter a correct telephone number, since we do not want to continue executing the rest of the script. The function’s optional argument is a string, which is printed as the script exits.

**Error-Prevention Tip 23.3** _Be sure to close any open XHTML tags when calling function die. Not doing so can produce invalid XHTML output that will not display properly in the client browser. Function die has an optional parameter that specifies a message to output when exiting, so one technique for clos- ing tags is to close all open tags using die, as in die("</body></html>")._ 23.3

**23.5 Connecting to a Database** Databases enable companies to enter the world of e-commerce by maintaining crucial da- ta. Database connectivity allows system administrators to maintain and update such infor- mation as user accounts, passwords, credit card numbers, mailing lists and product inventories. PHP offers built-in support for many databases. In this example, we use MySQL. Install MySQL using the instructions in Sections 22.6–22.7. Then execute the Products script (refer to Section 22.8) from the Script Examples folder of the Chapter 23 examples directory at www.deitel.com/books/iw3HTP4.

In this example, the client selects the name of a column in the database. The PHP script then executes—it builds a SELECT query, queries the database to obtain the column’s data and sends a record set in the form of XHTML to the client. Chapter 22 discusses how to build SQL queries.

Figure 23.14 is a web page that posts form data consisting of a selected database column to the server. The script in Fig. 23.15 processes the form data.  

**930** Chapter 23 PHP

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.14: data.html --> **6** <!-- Form to query a MySQL database. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Sample Database Query</title>

**10** <style type = "text/css"> **11** body { background-color: #F0E68C } **12** h2 { font-family: arial, sans-serif; **13** color: blue } **14** input { background-color: blue; **15** color: yellow; **16** font-weight: bold } **17** </style> **18** </head> **19** <body> **20** <h2> Querying a MySQL database.</h2> **21 22** <div> **23** <p>Select a field to display: **24** <!-- add a select box containing options --> **25** <!-- for SELECT query --> **26 27 28 29 30 31 32 33** <input type = "submit" value = "Send Query" /> **34** </div> **35** </form> **36** </body> **37** </html>

**Fig. 23.14** | Form to query a MySQL database.

<form method = "post" action = "database.php">

<select name = "select"> <option selected = "selected">\*</option> <option>ID</option> <option>Title</option> <option>Category</option> <option>ISBN</option>

</select></p>  

23.5 Connecting to a Database **931**

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.15: database.php --> **6** <!-- Querying a database and displaying the results. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Search Results</title>

**10** <style type = "text/css"> **11** body { font-family: arial, sans-serif; **12** background-color: #F0E68C } **13** table { background-color: #ADD8E6 } **14** td { padding-top: 2px; **15** padding-bottom: 2px; **16** padding-left: 4px; **17** padding-right: 4px; **18** border-width: 1px; **19** border-style: inset } **20** </style> **21** </head> **22** <body> **23** <?php **24** extract( $\_POST ); **25 26** // build SELECT query **27 28 29** // Connect to MySQL **30 31 32** die( "Could not connect to database </body></html>" ); **33 34** // open Products database **35** if ( ) **36** die( "Could not open products database </body></html>" ); **37 38** // query Products database **39** if ( ) ) **40** { **41** print( "Could not execute query! <br />" ); **42** die( . "</body></html>" ); **43** } // end if **44 45 46** ?><!-- end PHP script --> **47** <h3>Search Results</h3> **48** <table> **49** <?php **50** // fetch each record in result set **51** for ( $counter = 0; $row = **52** $counter++ ) **53** {

**Fig. 23.15** | Querying a database and displaying the results. (Part 1 of 2.)

$query = "SELECT " . $select . " FROM books";

if ( !( $database = mysql\_connect( "localhost", "iw3htp4", "iw3htp4" ) ) )

!mysql\_select\_db( "products", $database )

!( $result = mysql\_query( $query, $database )

mysql\_error()

mysql\_close( $database );

mysql\_fetch\_row( $result );  

**932** Chapter 23 PHP

Line 21 of Fig. 23.14 creates an XHTML form, specifying that the data submitted from the form will be sent to script database.php (Fig. 23.15) in a post request. Lines 26–32 add a select box to the form, set the name of the select box to select and set its default selection to \*. This value specifies that all rows and columns are to be retrieved from the database. Each database column is set as an option in the select box.

Script database.php (Fig. 23.15) builds a SQL query with the specified field name and sends it to the database management system. Line 27 concatenates the posted field name to a SELECT query. Line 30 calls function **mysql\_connect** to connect to the MySQL database. We pass three arguments to function mysql\_connect—the server’s hostname, a username and a password (in this case, both our username and password are iw3htp4, based on the account we set up in Chapter 22). This function returns a **database handle**—

**54** // build table to display results **55** print( "<tr>" ); **56 57** foreach ( $row as $key => $value ) **58** print( "<td>$value</td>" ); **59 60** print( "</tr>" ); **61** } // end for **62** ?><!-- end PHP script --> **63** </table> **64** <br />Your search yielded <strong> **65** <?php print( "$counter" ) ?> results.<br /><br /></strong> **66** <h5>Please email comments to **67** <a href = "mailto:deitel@deitel.com"> **68** Deitel and Associates, Inc.</a> **69** </h5> **70** </body> **71** </html>

**Fig. 23.15** | Querying a database and displaying the results. (Part 2 of 2.)  

23.6 Using Cookies **933**

a representation of PHP’s connection to the database—which we assign to variable $data- base. If the connection to MySQL fails, the function returns false and function die is called to output an error message and terminate the script. Line 35 calls function **mysql\_select\_db** to specify the database to be queried (in this case, products), which returns true on success or false on failure. Function die is called if the database cannot be opened.

To query the database, line 39 calls function **mysql\_query**, specifying the query string and the database to query. If the query fails, the function returns false. Function die is then called with a call to function **mysql\_error** as an argument. Function mysql\_error

returns any error strings from the database. If the query succeeds, mysql\_query returns a resource containing the query result, which we assign to variable $result. Once we have stored the data in $result, we call **mysql\_close** in line 45 to close the connection to the database. Function mysql\_query can also execute SQL statements such as INSERT or DELETE that do not return results.

Lines 51–61 iterate through each record in the result set and construct an XHTML table from the results. The for statement’s condition calls function **mysql\_fetch\_row** to return an array containing the values for each column of the current row in the query result ($result). The array is stored in variable $row. Lines 57–58 construct individual cells for each column in the row. The foreach statement takes the name of the array ($row), iter- ates through each index value of the array ($key) and stores the value in variable $value. Each element of the array is then printed as an individual cell. When the result has no more rows, false is returned by function mysql\_fetch\_row, which terminates the for

statement. After all the rows in the result have been displayed, the table’s closing tag is written

(line 63). The number of rows contained in $counter is printed in line 65. Alternatively, calling function **mysql\_num\_rows**( $result ) would return the number of rows in the result.

**23.6 Using Cookies** A **cookie** is a piece of information stored in a text file on a client’s computer to maintain information about the client during and between browsing sessions. A website can store a cookie on a client’s computer to record user preferences and other information that the website can retrieve during the client’s subsequent visits. For example, a website can use cookies to store clients’ zip codes, so that it can provide weather reports and news updates tailored to the user’s region. Websites also can use cookies to track information about client activity. Analysis of information collected via cookies can reveal the popularity of websites or products. In addition, marketers can use cookies to determine the effects of advertising campaigns.

Websites store cookies on users’ hard drives, which raises issues regarding security and privacy. Websites should not store critical information, such as credit card numbers or passwords, in cookies, because cookies are typically stored in text files that any program can read. Several cookie features address security and privacy concerns. A server can access only the cookies that it has placed on the client. For example, a web application running on www.deitel.com cannot access cookies that the website www.prenhall.com has placed on the client’s computer. A cookie also has an expiration date, after which the web browser deletes it. Users who are concerned about the privacy and security implications of cookies  

**934** Chapter 23 PHP

can disable cookies in their web browsers. However, disabling cookies can make it impos- sible for the user to interact with websites that rely on cookies to function properly.

The information stored in a cookie is sent back to the web server from which it orig- inated whenever the user requests a web page from that particular server. The web server can send the client XHTML output that reflects the preferences or information that is stored in the cookie.

**_Writing Cookies_** Figure 23.16 uses a script to write a cookie to the client’s machine. The cookies.html file displays an XHTML form that allows a user to enter a name, height and favorite color. When the user clicks the **Write Cookie** button, the cookies.php script (Fig. 23.17) exe- cutes.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.16: cookies.html --> **6** <!-- Gathering data to be written as a cookie. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Writing a cookie to the client computer</title>

**10** <style type = "text/css"> **11** body { font-family: arial, sans-serif; **12** background-color: #99CCFF } **13** form { font-size: 10pt } **14** .submit { background-color: #F0E86C; **15** color: navy; **16** font-weight: bold } **17** </style> **18** </head> **19** <body> **20** <h2>Click Write Cookie to save your cookie data.</h2> **21 22** <div> **23** <strong>Name:</strong><br /> **24** <br /> **25 26** <strong>Height:</strong><br /> **27** <br /> **28 29** <strong>Favorite Color:</strong><br /> **30** <br /> **31 32** <input type = "submit" value = "Write Cookie" **33** class = "submit" /> **34** </div> **35** </form> **36** </body> **37** </html>

**Fig. 23.16** | Gathering data to be written as a cookie. (Part 1 of 2.)

<form method = "post" action = "cookies.php">

<input type = "text" name = "Name" />

<input type = "text" name = "Height" />

<input type = "text" name = "Color" />  

23.6 Using Cookies **935**

**1** <?php **2** // Fig. 23.17: cookies.php **3** // Writing a cookie to the client. **4** extract( $\_POST ); **5 6** // write each form field’s value to a cookie and set the **7** // cookie’s expiration date **8 9**

**10 11** ?><!-- end PHP script --> **12 13** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **14** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **15** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **16 17** <html xmlns = "http://www.w3.org/1999/xhtml"> **18** <head> **19** <title>Cookie Saved</title> **20** <style type = "text/css"> **21** body { font-family: arial, sans-serif } **22** span { color: blue } **23** </style> **24** </head> **25** <body> **26** <p>The cookie has been set with the following data:</p> **27 28** <!-- print each form field’s value --> **29** <br /><span>Name:</span><?php print( $Name ) ?><br />

**Fig. 23.17** | Writing a cookie to the client. (Part 1 of 2.)

**Fig. 23.16** | Gathering data to be written as a cookie. (Part 2 of 2.)

setcookie( "Name", $Name, time() + 60 \* 60 \* 24 \* 5 ); setcookie( "Height", $Height, time() + 60 \* 60 \* 24 \* 5 ); setcookie( "Color", $Color, time() + 60 \* 60 \* 24 \* 5 );  

**936** Chapter 23 PHP

**Software Engineering Observation 23.2** _Some clients do not accept cookies. When a client declines a cookie, the browser application normally informs the user that the site may not function correctly without cookies enabled._ 23.2

**Software Engineering Observation 23.3** _Cookies should not be used to store e-mail addresses or private data on a client’s computer._ 23.3

Script cookies.php (Fig. 23.17) calls function **setcookie** (lines 8–10) to set the cookies to the values passed from cookies.html. The cookies defined in function set-

cookie are sent to the client at the same time as the information in the HTTP header; therefore, setcookie needs to be called before any XHTML (including comments) is printed.

Function setcookie takes the name of the cookie to be set as the first argument, fol- lowed by the value to be stored in the cookie. For example, line 8 sets the name of the cookie to "Name" and the value to variable $Name, which is passed to the script from cookies.html. The optional third argument indicates the expiration date of the cookie. In this example, we set the cookies to expire in five days by taking the current time, which is returned by function **time**, and adding the number of seconds after which the cookie is to expire (60 seconds/minute \* 60 minutes/hour \* 24 hours/day \* 5 = 5 days). If no expi- ration date is specified, the cookie lasts only until the end of the current session, which is the total time until the user closes the browser. This type of cookie is known as a **session cookie**, while one with an expiration date is a **persistent cookie**. If only the name argument

**30** <span>Height:</span><?php print( $Height ) ?><br /> **31** <span>Favorite Color:</span> **32** <span style = "color: <?php print( "$Color\\">$Color" ) ?> **33** </span><br /> **34** <p>Click **35** to read the saved cookie.</p> **36** </body> **37** </html>

**Fig. 23.17** | Writing a cookie to the client. (Part 2 of 2.)

<a href = "readCookies.php">here</a>  

23.6 Using Cookies **937**

is passed to function setcookie, the cookie is deleted from the client’s computer. Lines 13–37 send a web page to the client indicating that the cookie has been written and listing the values that are stored in the cookie.

When using Internet Explorer, cookies are stored in a **Cookies** directory on the client’s machine, while Firefox stores them in a single file called cookies.txt. Figure 23.18 shows the contents of this directory (for a Windows XP and IE7 user harvey) prior to the execu- tion of cookies.php. After the cookie is written, a text file is added to the directory. In Fig. 23.19, the file harvey@localhost\[1\].txt appears in the **Cookies** directory. \[_Note:_ The name of the file created will vary from user to user.\]

**_Reading an Existing Cookie_** Figure 23.20 reads the cookie that was written in Fig. 23.17 and displays the cookie’s in- formation in a table. PHP creates the superglobal array **$\_COOKIE**, which contains all the cookie values indexed by their names, similar to the values stored in array $\_POST when an XHTML form is posted (see Section 23.4).

**Fig. 23.18** | IE7’s Cookies directory before a cookie is written.

**Fig. 23.19** | IE7’s Cookies directory after a cookie is written.  

**938** Chapter 23 PHP

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.20: readCookies.php --> **6** <!-- Displaying the cookie’s contents. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Read Cookies</title>

**10** <style type = "text/css"> **11** body { font-family: arial, sans-serif } **12** table { border-width: 5px; **13** border-style: outset } **14** td { padding: 10px } **15** .key { background-color: #F0E68C } **16** .value { background-color: #FFA500 } **17** </style> **18** </head> **19** <body> **20** <p> **21** <strong>The following data is saved in a cookie on your **22** computer.</strong> **23** </p> **24** <table> **25** <?php **26** // iterate through array $\_COOKIE and print **27** // name and value of each cookie **28 29 30 31** ?><!-- end PHP script --> **32** </table> **33** </body> **34** </html>

**Fig. 23.20** | Displaying the cookie’s contents.

foreach ( $\_COOKIE as $key => $value ) print( "<tr><td class = 'key' >$key</td>

<td class = 'value' >$value</td></tr>" );  

23.7 Dynamic Content **939**

Lines 28–30 iterate through the $\_COOKIE array using a foreach statement, printing out the name and value of each cookie in an XHTML table. The foreach statement takes the name of the array ($\_COOKIE) and iterates through each index value of the array ($key). In this case, the index values are the names of the cookies. Each element is then stored in variable $value, and these values become the individual cells of the table.

We could have also used the function extract to create individual variables out of the key-value pairs in $\_COOKIE, just as we did with $\_POST. For example, after the function extract( $\_COOKIE ) is called, the value of a cookie set with the name "Color" is assigned to variable $Color. Try closing your browser and revisiting readCookies.php to confirm that the cookie has persisted.

**23.7 Dynamic Content** PHP can dynamically change the XHTML it outputs based on a user’s input. We now build on Section 23.4’s example by combining the XHTML form of Fig. 23.12 and the PHP script of Fig. 23.13 into one dynamic document. The form in Fig. 23.21 is created using a series of loops, arrays and conditionals. We add error checking to each of the text input fields and inform the user of invalid entries on the form itself, rather than on an error page. If an error exists, the script maintains the previously submitted values in each form element. Finally, after the form has been successfully completed, we store the input from the user in a MySQL database. Before running the following example, make sure MySQL is installed, then execute the MailingList script (refer to Section 22.8) from the Script Ex- amples folder of the Chapter 23 examples directory at www.deitel.com/books/iw3HTP4.

Lines 36–47 create three arrays, $booklist, $systemlist and $inputlist, that are used to dynamically create the form’s input fields. We specify that the form created in this document is self-submitting (i.e., it posts to itself) by setting the action to 'dynamicForm.php' in line 148. \[_Note:_ We enclose XHTML attribute values in the string argument of a print statement in single quotes so that they do not interfere with the double quotes that delimit the string. We could alternatively have used the escape sequence \\" to print double quotes instead of single quotes.\] Line 50 uses function **isset**

to determine whether the **Register** button has been pressed. If it has, each of the text input fields’ values is validated. If an error is detected (e.g., a text field is blank or the phone number is improperly formatted), an entry is added to array $formerrors containing a key corresponding to the field name with the error and a value of true. Also, variable $iserror is set to true. If the **Register** button has not been pressed, we skip ahead to line 138.

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.21: dynamicForm.php --> **6** <!-- Dynamic form. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Sample form to take user input in XHTML</title>

**10** <style type = "text/css">

**Fig. 23.21** | Dynamic form. (Part 1 of 7.)  

**940** Chapter 23 PHP

**11** td { padding-top: 2px; **12** padding-bottom: 2px; **13** padding-left: 10px; **14** padding-right: 10px } **15** div { text-align: center } **16** div div { font-size: larger } **17** .name { background-color: #ffffaa } **18** .email { background-color: #ffffbb } **19** .phone { background-color: #ffffcc } **20** .os { background-color: #ffffdd } **21** .smalltext { font-size: smaller } **22** .prompt { color: blue; **23** font-family: sans-serif; **24** font-size: smaller } **25** .largeerror { color: red } **26** .error { color: red; **27** font-size: smaller } **28** </style> **29** </head> **30** <body> **31** <?php **32** extract( $\_POST ); **33** $iserror = false; **34 35** // array of book titles **36** $booklist = array( "Internet and WWW How to Program 4e", **37** "C++ How to Program 6e", "Java How to Program 7e", **38** "Visual Basic 2005 How to Program 3e" ); **39 40** // array of possible operating systems **41** $systemlist = array( "Windows XP", "Windows Vista", **42** "Mac OS X", "Linux", "Other"); **43 44** // array of name values for the text input fields **45** $inputlist = array( "fname" => "First Name", **46** "lname" => "Last Name", "email" => "Email", **47** "phone" => "Phone" ); **48 49** // ensure that all fields have been filled in correctly **50** if ( ) **51** { **52 53** { **54 55 56** } // end if **57 58** if ( $lname == "" ) **59** { **60** $formerrors\[ "lnameerror" \] = true; **61** $iserror = true; **62** } // end if **63**

**Fig. 23.21** | Dynamic form. (Part 2 of 7.)

isset ( $submit )

if ( $fname == "" )

$formerrors\[ "fnameerror" \] = true; $iserror = true;  

23.7 Dynamic Content **941**

**64** if ( $email == "" ) **65** { **66** $formerrors\[ "emailerror" \] = true; **67** $iserror = true; **68** } // end if **69 70** if ( !ereg( "^\\(\[0-9\]{3}\\)\[0-9\]{3}-\[0-9\]{4}$", $phone ) ) **71** { **72** $formerrors\[ "phoneerror" \] = true; **73** $iserror = true; **74** } // end if **75 76** if ( !$iserror ) **77** { **78** // build INSERT query **79** $query = "INSERT INTO contacts " . **80** "( LastName, FirstName, Email, Phone, Book, OS ) " . **81** "VALUES ( '$lname', '$fname', '$email', " . **82** "'" . . "', '$book', '$os' )"; **83 84** // Connect to MySQL **85** if ( !( $database = mysql\_connect( "localhost", **86** "iw3htp4", "iw3htp4" ) ) ) **87** die( "Could not connect to database" ); **88 89** // open MailingList database **90** if ( !mysql\_select\_db( "MailingList", $database ) ) **91** die( "Could not open MailingList database" ); **92 93** // execute query in MailingList database **94** if ( !( $result = mysql\_query( $query, $database ) ) ) **95** { **96** print( "Could not execute query! <br />" ); **97** die( mysql\_error() ); **98** } // end if **99 100** mysql\_close( $database ); **101 102** print( "<p>Hi<span class = 'prompt'> **103** <strong>$fname</strong></span>. **104** Thank you for completing the survey.<br /> **105 106** You have been added to the **107** <span class = 'prompt'> **108** <strong>$book</strong></span> **109** mailing list.</p> **110** <strong>The following information has been saved **111** in our database:</strong><br /> **112 113** <table><tr> **114** <td class = 'name'>Name </td> **115** <td class = 'email'>Email</td> **116** <td class = 'phone'>Phone</td>

**Fig. 23.21** | Dynamic form. (Part 3 of 7.)

quotemeta( $phone )  

**942** Chapter 23 PHP

**117** <td class = 'os'>OS</td> **118** </tr><tr> **119 120** <!-- print each form field’s value --> **121** <td>$fname $lname</td> **122** <td>$email</td> **123** <td>$phone</td> **124** <td>$os</td> **125** </tr></table> **126 127** <br /><br /><br /> **128** <div><div> **129** <a href = 'formDatabase.php'> **130** Click here to view entire database.</a> **131** </div>This is only a sample form. **132** You have not been added to a mailing list. **133** </div></body></html>" ); **134** die(); **135** } // end if **136** } // end if **137 138** print( "<h1>Sample Registration Form.</h1> **139** Please fill in all fields and click Register." ); **140 141 142** { **143 144 145** } // end if **146 147** print( "<!-- post form data to form.php --> **148** <form method = 'post' action = 'dynamicForm.php'> **149** <img src = 'images/user.gif' alt = 'User' /><br /> **150** <span class = 'prompt'> **151** Please fill out the fields below.<br /> </span> **152 153** <!-- create four text boxes for user input -->" ); **154 155** { **156** $inputtext = $inputvalues\[ $inputname \]; **157 158 159 160 161 162 163 164 165** print( "<br />" ); **166** } // end foreach **167 168** if ( $formerrors\[ "phoneerror" \] ) **169** print( "<span class = 'error'>" );

**Fig. 23.21** | Dynamic form. (Part 4 of 7.)

if ( $iserror )

print( "<br /><span class = 'largeerror'> Fields with \* need to be filled in properly.</span>" );

foreach ( $inputlist as $inputname => $inputalt )

print( "<img src = 'images/$inputname.gif' alt = '$inputalt' /><input type = 'text' name = '$inputname' value = '" . $$inputname . "' />" );

if ( $formerrors\[ ( $inputname )."error" \] == true ) print( "<span class = 'error'>\*</span>" );  

23.7 Dynamic Content **943**

**170** else **171** print("<span class = 'smalltext'>"); **172 173** print( "Must be in the form (555)555-5555 **174** </span><br /><br /> **175 176** <img src = 'images/downloads.gif' **177** alt = 'Publications' /><br /> **178 179** <span class = 'prompt'> **180** Which book would you like information about? **181** </span><br /> **182 183** <!-- create drop-down list containing book names --> **184** <select name = 'book'>" ); **185 186** foreach ( $booklist as $currbook ) **187** { **188** print( "<option" ); **189 190 191 192 193** print( ">$currbook</option>" ); **194** } // end foreach **195 196** print( "</select><br /><br /> **197** <img src = 'images/os.gif' alt = 'Operating System' /> **198** <br /><span class = 'prompt'> **199** Which operating system are you currently using? **200** <br /></span> **201 202** <!-- create five radio buttons -->" ); **203 204** $counter = 0; **205 206** foreach ( $systemlist as $currsystem ) **207** { **208** print( "<input type = 'radio' name = 'os' **209** value = '$currsystem'" ); **210 211 212 213 214 215 216** print( " />$currsystem" ); **217 218** // put a line break in list of operating systems **219** if ( $counter == 1 ) print( "<br />" ); **220** ++$counter; **221** } // end foreach **222**

**Fig. 23.21** | Dynamic form. (Part 5 of 7.)

if ( ( $currbook == $book ) ) print( " selected = 'true'" );

if ( $currsystem == $os ) print( "checked = 'checked'" );

elseif ( !$os && $counter == 0 ) print( "checked = 'checked'" );  

**944** Chapter 23 PHP

**223** print( "<!-- create a submit button --> **224** <br /><input type = 'submit' name = 'submit' **225** value = 'Register' /></form></body></html>" ); **226** ?><!-- end PHP script -->

**Fig. 23.21** | Dynamic form. (Part 6 of 7.)

a) A user enters a form with incorrect **Last Name** and **Phone**

information.

b) The incorrectly entered fields are

highlighted by the script.  

23.7 Dynamic Content **945**

Line 76 determines whether any errors were detected. If $iserror is false (i.e., there were no input errors), lines 79–133 display the page indicating that the form was sub- mitted successfully. We will say more about lines 79–133 later. If $iserror is true, the script from lines 79–133 is skipped, and the code from lines 138–224 executes. These lines include a series of print statements and conditionals to output the form, as seen in Fig. 23.21(a). Lines 154–166 iterate through each element in the $inputlist array. In line 156 the value of variable $inputtext is assigned to the text field’s value attribute. If the form has not yet been submitted, variable $inputtext’s value will be the empty string "". Lines 158–159 output the image that corresponds to each text field. The image src is set to 'images/$inputname.gif' because the images are stored in the images directory,

**Fig. 23.21** | Dynamic form. (Part 7 of 7.)

c) The user fills in these fields correctly.

d) The information is submitted to the

database and displayed on the

screen.  

**946** Chapter 23 PHP

and each image shares the name of its corresponding text field and ends with the .gif

extension. Lines 159–160 initialize the input text field. The text field’s name attribute is set to variable $inputname.

In line 160 we encounter the **$$variable** notation for specifying a **variable variable**. A variable variable allows the code to reference variables dynamically. You can use this expression to obtain the value of the variable whose name is equal to the value of $_variable_. PHP first determines the value of $_variable_, then appends this value to the leading $ to form the identifier of the variable you wish to reference dynamically. (The expression $$_variable_ can also be written as ${$_variable_} to convey this procedure.) For example, in lines 154–166, we write $$inputname to reference the value of each form-field variable. During the iteration of the loop, $inputname contains the value "email". Therefore, PHP replaces $inputname in the expression $$inputname with the string "email", forming the expression ${"email"}. The entire expression then evaluates to the value of the variable $email. Thus, the variable $email, which stores the value of the e-mail text field after the form has been submitted, is dynamically referenced. This dynamic variable reference is added to the string as the value of the input field (using the concatenation operator) to maintain data over multiple submissions of the form.

Lines 162–163 add a red asterisk next to the text input fields that were filled out incor- rectly. Lines 168–169 color the phone instructions red if the user entered an invalid phone number by assigning the class error to the span tag surrounding the text.

Lines 186–194 and 206–221 generate options for the book drop-down list and oper- ating-system radio buttons, respectively. Lines 190–191 and 211–214 ensure that the pre- viously selected or checked element (if one exists) remains selected or checked over multiple attempts to correctly fill out the form. If any book was previously selected, lines 190–191 add the string selected = 'true' to its option tag. Lines 211–214 select an oper- ating system radio button under two conditions. First, lines 211–212 select the button if it was previously selected, before an unsuccessful submit operation. Lines 213–214 select the first radio button only if the form has not yet been submitted ($os is not set) and it is the first radio button. This ensures that the form cannot be submitted without a radio button selected.

If the form has been filled out correctly, lines 79–98 place the form information in the MySQL database MailingList using an INSERT statement. Line 82 uses the **quote-**

**meta** function to insert a backslash (\\) before any special characters in the passed string. We must use this function so that MySQL does not interpret the parentheses in the phone number as having a special meaning aside from being part of a value to insert into the data- base. Lines 102–133 generate the web page indicating a successful form submission, which also provides a link to formDatabase.php (Fig. 23.22). This script displays the contents of the MailingList database.

**1** <?php print( '<?xml version = "1.0" encoding = "utf-8"?>' ) ?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 23.22: formDatabase.php --> **6** <!-- Displaying the MailingList database. -->

**Fig. 23.22** | Displaying the MailingList database. (Part 1 of 3.)  

23.7 Dynamic Content **947**

**7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Search Results</title>

**10** <style type = "text/css"> **11** body { font-family: arial, sans-serif; **12** background-color: #F0E68C } **13** h3 { color: blue } **14** table { background-color: #ADD8E6 } **15** td { padding-top: 2px; **16** padding-bottom: 2px; **17** padding-left: 4px; **18** padding-right: 4px; **19** border-width: 1px; **20** border-style: inset } **21** </style> **22** </head> **23** <body> **24** <?php **25** extract( $\_POST ); **26 27** // build SELECT query **28 29 30** // Connect to MySQL **31** if ( !( $database = mysql\_connect( "localhost", **32** "iw3htp4", "iw3htp4" ) ) ) **33** die( "Could not connect to database </body></html>" ); **34 35** // open MailingList database **36** if ( !mysql\_select\_db( "MailingList", $database ) ) **37** die( "Could not open MailingList database </body></html>" ); **38 39** // query MailingList database **40** if ( !( $result = mysql\_query( $query, $database ) ) ) **41** { **42** print( "Could not execute query! <br />" ); **43** die( mysql\_error() . "</body></html>" ); **44** } // end if **45** ?><!-- end PHP script --> **46 47** <h3>Mailing List Contacts</h3> **48** <table> **49** <tr> **50** <td>ID</td> **51** <td>Last Name</td> **52** <td>First Name</td> **53** <td>E-mail Address</td> **54** <td>Phone Number</td> **55** <td>Book</td> **56** <td>Operating System</td> **57** </tr> **58** <?php

**Fig. 23.22** | Displaying the MailingList database. (Part 2 of 3.)

$query = "SELECT \* FROM contacts";  

**948** Chapter 23 PHP

**23.8 Operator Precedence Chart** This section contains the operator precedence chart for PHP. In Fig. 23.23, the operators are shown from top to bottom in decreasing order of precedence.

**59** // fetch each record in result set **60** for ( $counter = 0; $row = mysql\_fetch\_row( $result ); **61** $counter++ ) **62** { **63** // build table to display results **64** print( "<tr>" ); **65 66** foreach ( $row as $key => $value ) **67** print( "<td>$value</td>" ); **68 69** print( "</tr>" ); **70** } // end for **71 72** mysql\_close( $database ); **73** ?><!-- end PHP script --> **74** </table> **75** </body> **76** </html>

Operator Type Associativity

new constructor none

\[\] subscript right to left

~

!

++

\--

\-

@

bitwise not not increment decrement unary negative error control

right to left

**Fig. 23.23** | PHP operator precedence and associativity. (Part 1 of 2.)

**Fig. 23.22** | Displaying the MailingList database. (Part 3 of 3.)  

23.8 Operator Precedence Chart **949**

\*

/

%

multiplication division modulus

left to right

+

\-

.

addition subtraction concatenation

left to right

<<

\>>

bitwise shift left bitwise shift right

left to right

<

\>

<=

\>=

less than greater than less than or equal greater than or equal

none

\==

!=

\===

!==

equal not equal identical not identical

none

& bitwise AND left to right

^ bitwise XOR left to right

| bitwise OR left to right

&& logical AND left to right

|| logical OR left to right

\=

+=

\-=

\*=

/=

&=

|=

^=

.=

<<=

\>>=

assignment addition assignment subtraction assignment multiplication assignment division assignment bitwise AND assignment bitwise OR assignment bitwise exclusive OR assignment concatenation assignment bitwise shift left assignment bitwise shift right assignment

left to right

and logical AND left to right

xor exclusive OR left to right

or logical OR left to right

, list left to right

Operator Type Associativity

**Fig. 23.23** | PHP operator precedence and associativity. (Part 2 of 2.)  

**950** Chapter 23 PHP

**23.9 Wrap-Up** In this chapter, we introduced the popular server-side scripting language PHP. We dis- cussed the basics of how to embed PHP code into XHTML documents, and introduced string processing, regular expressions and form handling, which allow for interaction with users. We also learned how to interact with a database, which allows for full three-tier web application development. We then discussed how to use cookies to store data on the client between sessions, and finished off with a dynamic web page that combines many of the techniques we’ve learned. The next chapter discusses Ruby on Rails, another server-side technology that streamlines the process of creating three-tier web applications.

**23.10 Web Resources** www.deitel.com/PHP/

The Deitel PHP Resource Center contains links to some of the best PHP information on the web. There you’ll find categorized links to PHP tools, code generators, forums, books, libraries, frame- works and more. Also check out the tutorials for all skill levels, from introductory to advanced. Be sure to visit the related Resource Centers on XHTML (www.deitel.com/xhtml/) and CSS 2.1 (www.deitel.com/css21/).

**Summary _Section 23.1 Introduction_** • PHP, or PHP: Hypertext Preprocessor, has become one of the most popular server-side scripting

languages for creating dynamic web pages.

• PHP is open source and platform independent—implementations exist for all major UNIX, Linux, Mac and Windows operating systems. PHP also supports a large number of databases.

**_Section 23.2 PHP Basics_** • The power of the web resides not only in serving content to users, but also in responding to re-

quests from users and generating web pages with dynamic content.

• PHP code is embedded directly into XHTML documents, though these script segments are in- terpreted by a server before being delivered to the client.

• PHP script file names end with .php.

• Although PHP can be used from the command line, a web server is necessary to take full advan- tage of the scripting language.

• In PHP, code is inserted between the scripting delimiters <?php and ?>. PHP code can be placed anywhere in XHTML markup, as long as the code is enclosed in these delimiters.

• Variables are preceded by a $ and are created the first time they are encountered.

• PHP statements terminate with a semicolon (;).

• Single-line comments which begin with two forward slashes (//) or a pound sign (#). Text to the right of the delimiter is ignored by the interpreter. Multiline comments begin with delimiter /\* and end with delimiter \*/.

• When a variable is encountered inside a double-quoted ("") string, PHP interpolates the variable. In other words, PHP inserts the variable’s value where the variable name appears in the string.

• All operations requiring PHP interpolation execute on the server before the XHTML document is sent to the client.  

Summary **951**

• PHP variables are loosely typed—they can contain different types of data at different times.

• Type conversions can be performed using function settype. This function takes two argu- ments—a variable whose type is to be changed and the variable’s new type.

• Variables are automatically converted to the type of the value they are assigned.

• Function gettype returns the current type of its argument.

• Calling function settype can result in loss of data. For example, doubles are truncated when they are converted to integers.

• When converting from a string to a number, PHP uses the value of the number that appears at the beginning of the string. If no number appears at the beginning, the string evaluates to 0.

• Another option for conversion between types is casting (or type casting). Casting does not change a variable’s content—it creates a temporary copy of a variable’s value in memory.

• The concatenation operator (.) combines multiple strings.

• A print statement split over multiple lines prints all the data that is enclosed in its parentheses.

• Function define creates a named constant. It takes two arguments—the name and value of the constant. An optional third argument accepts a boolean value that specifies whether the constant is case insensitive—constants are case sensitive by default.

• Uninitialized variables have the value undef, which has different values, depending on its context. In a numeric context, it evaluates to 0. In a string context, it evaluates to an empty string ("").

• Keywords may not be used as identifiers.

• PHP provides the capability to store data in arrays. Arrays are divided into elements that behave as individual variables. Array names, like other variables, begin with the $ symbol.

• Individual array elements are accessed by following the array’s variable name with an index en- closed in square brackets (\[\]).

• If a value is assigned to an array that does not exist, then the array is created. Likewise, assigning a value to an element where the index is omitted appends a new element to the end of the array.

• Function count returns the total number of elements in the array.

• Function array creates an array that contains the arguments passed to it. The first item in the argument list is stored as the first array element (index 0), the second item is stored as the second array element and so on.

• Arrays with nonnumeric indices are called associative arrays. You can create an associative array using the operator =>, where the value to the left of the operator is the array index and the value to the right is the element’s value.

• PHP provides functions for iterating through the elements of an array. Each array has a built-in internal pointer, which points to the array element currently being referenced. Function reset

sets the internal pointer to the first array element. Function key returns the index of the element currently referenced by the internal pointer, and function next moves the internal pointer to the next element.

• The foreach statement, designed for iterating through arrays, starts with the array to iterate through, followed by the keyword as, followed by two variables—the first is assigned the index of the element and the second is assigned the value of that index. (If only one variable is listed after as, it is assigned the value of the array element.)

**_Section 23.3 String Processing and Regular Expressions_** • A regular expression is a series of characters used for pattern-matching templates in strings, text

files and databases.  

**952** Chapter 23 PHP

• Many string-processing tasks can be accomplished using the equality and relational operators.

• Function strcmp compares two strings. The function returns -1 if the first string alphabetically precedes the second string, 0 if the strings are equal, and 1 if the first string alphabetically follows the second.

• Functions ereg and preg\_match use regular expressions to search a string for a specified pattern.

• If a pattern is found using ereg, it returns the length of the matched string—which evaluates to true in a boolean context.

• Anything enclosed in single quotes in a print statement is not interpolated (unless the single quotes are nested in a double-quoted string literal).

• Function ereg receives a regular expression pattern to search for and the string to search.

• Function eregi performs case-insensitive pattern matches.

• Regular expressions can include metacharacters that specify patterns. For example, the caret (^) metacharacter matches the beginning of a string, while the dollar sign ($) matches the end of a string. The period (.) metacharacter matches any single character.

• Bracket expressions are lists of characters enclosed in square brackets (\[\]) that match any single character from the list. Ranges can be specified by supplying the beginning and the end of the range separated by a dash (-).

• The special bracket expressions \[\[:<:\]\] and \[\[:>:\]\] match the beginning and end of a word, respectively.

• Quantifiers are used in regular expressions to denote how often a particular character or set of characters can appear in a match.

• The optional third argument to function ereg is an array that stores matches to each parenthet- ical statement of the regular expression. The first element stores the string matched for the entire pattern, and the remaining elements are indexed from left to right.

• To find multiple instances of a given pattern, we must make multiple calls to ereg, and remove matched instances before calling the function again by using a function such as ereg\_replace.

• Character classes, or sets of specific characters, are enclosed by the delimiters \[: and :\]. When this expression is placed in another set of brackets, it is a regular expression matching all of the characters in the class.

• A bracketed expression containing two or more adjacent character classes in the class delimiters represents those character sets combined.

• Function ereg\_replace takes three arguments—the pattern to match, a string to replace the matched string and the string to search. The modified string is returned.

**_Section 23.4 Form Processing and Business Logic_** • Superglobal arrays are associative arrays predefined by PHP that hold variables acquired from

user input, the environment or the web server and are accessible in any variable scope.

• The arrays $\_GET and $\_POST retrieve information sent to the server by HTTP get and post re- quests, respectively.

• Using method = "post" appends form data to the browser request that contains the protocol and the requested resource’s URL. Scripts located on the web server’s machine can access the form data sent as part of the request.

• Function extract creates a variable/value pair corresponding to each key/value pair in the asso- ciative array passed as an argument.

• Business logic, or business rules, ensures that only valid information is stored in databases.  

Terminology **953**

• We escape the normal meaning of a character in a string by preceding it with the backslash char- acter (\\).

• Function die terminates script execution. The function’s optional argument is a string, which is printed as the script exits.

**_Section 23.5 Connecting to a Database_** • Function mysql\_connect connects to the MySQL database. It takes three arguments—the serv-

er’s hostname, a username and a password, and returns a database handle—a representation of PHP’s connection to the database, or false if the connection fails.

• Function mysql\_select\_db specifies the database to be queried, and returns a bool indicating whether or not it was successful.

• To query the database, we call function mysql\_query, specifying the query string and the data- base to query. This returns a resource containing the result of the query, or false if the query fails. It can also execute SQL statements such as INSERT or DELETE that do not return results.

• Function mysql\_error returns any error strings from the database.

**_Section 23.6 Using Cookies_** • A cookie is a text file that a website stores on a client’s computer to maintain information about

the client during and between browsing sessions.

• A server can access only the cookies that it has placed on the client.

• Function setcookie takes the name of the cookie to be set as the first argument, followed by the value to be stored in the cookie. The optional third argument indicates the expiration date of the cookie. A cookie without a third argument is known as a session cookie, while one with an expi- ration date is a persistent cookie. If only the name argument is passed to function setcookie, the cookie is deleted from the client’s computer.

• Cookies defined in function setcookie are sent to the client at the same time as the information in the HTTP header; therefore, it needs to be called before any XHTML is printed.

• The current time is returned by function time.

• When using Internet Explorer, cookies are stored in a **Cookies** directory on the client’s machine. In Firefox, cookies are stored in a file named cookies.txt.

• PHP creates the superglobal array $\_COOKIE, which contains all the cookie values indexed by their names.

**_Section 23.7 Dynamic Content_** • Function isset allows you to find out if a variable has a value.

• A variable variable ($$variable) allows the code to reference variables dynamically. You can use this expression to obtain the value of the variable whose name is equal to the value of $variable.

• The quotemeta function inserts a backslash (\\) before any special characters in the passed string.

**Terminology** \- range separator $\_COOKIE

$\_GET

$\_POST

array function as keyword associative array

bracket expressions business logic business rules caret metacharacter (^) casting character classes comparison operators  

**954** Chapter 23 PHP

concatenation operator (.) cookie count function database handle die function dollar-sign metacharacter double data type equality operators ereg function ereg\_replace function eregi function escape sequence foreach statement gettype function internal pointer interpolation isset function iteration through an array key function literal characters metacharacters multiplication assignment operator MySQL

mysql\_close function mysql\_connect function mysql\_error function mysql\_fetch\_row function mysql\_num\_rows function mysql\_query function mysql\_select\_db function named constant next function Perl-compatible regular expressions (PCRE) persistent cookie PHP POSIX extended regular expressions post request type preg\_match function print function quantifier quotemeta function time function type casting variable variables while statement

**Self-Review Exercises 23.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) PHP script is never in the same file as XHTML script. b) PHP variable names are case sensitive. c) The settype function only temporarily changes the type of a variable. d) Conversion between data types happens automatically when a variable is used in a con-

text that requires a different data type. e) The foreach statement is designed specifically for iterating over arrays. f) Relational operators can only be used for numeric comparison. g) The quantifier +, when used in a regular expression, matches any number of the preced-

ing pattern. h) Function die never takes arguments. i) Cookies are stored on the server computer. j) The \* arithmetic operator has higher precedence than the + operator.

**23.2** Fill in the blanks in each of the following statements: a) PHP scripts typically have the file extension . b) The two numeric types that PHP variables can store are and . c) In PHP, uninitialized variables have the value . d) are divided into elements, each of which acts like an individual variable. e) Function returns the total number of elements in an array. f) To use POSIX regular expressions, use the function. g) A(n) in a regular expression matches a predefined set of characters. h) Data submitted through the HTTP post method is stored in array . i) Function terminates script execution. j) can be used to maintain state information on a client’s computer.  

Answers to Self-Review Exercises **955**

**Answers to Self-Review Exercises 23.1** a) False. PHP is directly embedded directly into XHTML. b) True. c) False. Function set-

type permanently changes the type of a variable. d) True. e) True. f) False. Relational operators can also be used for alphabetic comparison. g) False. The quantifier + matches one or more of the pre- ceding pattern. h) False. Function die has an optional argument—a string to be printed as the script exits. i) False. Cookies are stored on the client’s computer. j) True.

**23.2** a) .php. b) int or integer, float or double. c) undef. d) Arrays. e) count. f) ereg. g) character class. h) $\_POST. i) die. j) Cookies.

**Exercises 23.3** Identify and correct the error in each of the following PHP code examples:

a) <?php print( "Hello World" ); > b) <?php

$name = "Paul"; print( "$Name" );

?><!-- end PHP script -->

**23.4** Write a PHP regular expression pattern that matches a string that satisfies the following de- scription: The string must begin with the (uppercase) letter A. Any three alphanumeric characters must follow. After these, the letter B (uppercase or lowercase) must be repeated one or more times, and the string must end with two digits.

**23.5** Describe how input from an XHTML form is retrieved in a PHP program.

**23.6** Describe how cookies can be used to store information on a computer and how the infor- mation can be retrieved by a PHP script. Assume that cookies are not disabled on the client.

**23.7** Write a PHP script named states.php that creates a variable $states with the value "Mis-

sissippi Alabama Texas Massachusetts Kansas". The script should perform the following tasks: a) Search for a word in $states that ends in xas. Store this word in element 0 of an array

named $statesArray. b) Search for a word in $states that begins with k and ends in s. Perform a case-insensitive

comparison. Store this word in element 1 of $statesArray. c) Search for a word in $states that begins with M and ends in s. Store this element in

element 2 of the array. d) Search for a word in $states that ends in a. Store this word in element 3 of the array. e) Search for a word in $states at the beginning of the string that starts with M. Store this

word in element 4 of the array. f) Output the array $statesArray to the screen.

**23.8** Write a PHP script that tests whether an e-mail address is input correctly. Verify that the input begins with series of characters, followed by the @ character, another series of characters, a period (.) and a final series of characters. Test your program, using both valid and invalid e-mail addresses.

**23.9** Write a PHP script that obtains a URL and its description from a user and stores the infor- mation into a database using MySQL. Create and run a SQL script with a database named URL and a table named Urltable. The first field of the table should contain an actual URL, and the second, which is named Description, should contain a description of the URL. Use www.deitel.com as the first URL, and input Cool site! as its description. The second URL should be www.php.net, and the description should be The official PHP site. After each new URL is submitted, print the con- tents of the database in a table.  

24 Ruby on Rails

**O B J E C T I V E S** In this chapter you will learn:

■ Basic Ruby programming.

■ How to use the Rails framework.

■ The Model-View-Controller paradigm.

■ How to use ActiveRecord to model a database.

■ How to construct web applications that interact with a database.

■ How to create a web-based message forum.

■ How to develop Ajax-enabled applications in Ruby on Rails.

■ How to use the built-in Script.aculo.us library to add visual effects to your programs.

**_Convention is the ruler of all._ —Pindar**

**_Where the telescope ends, the microscope begins. Which of the two has the grander view?_ —Victor Hugo**

**_…We grow more partial for the observer’s sake._ —Alexander Pope**

**_Those who cannot remember the past are condemned to repeat it._ —George Santayana**

**_Let’s look at the record._ —Alfred Emanuel Smith**

**_All that matters is that the miraculous become the norm._ —Henry Miller**  

24.1 Introduction **957 O**

**u tl**

**in e**

**24.1 Introduction Ruby on Rails** (also known as **RoR** or just **Rails**) is a framework for developing data-driven web applications using the **Ruby** scripting language. A **web framework** is a set of libraries and useful tools that can be used to build dynamic web applications. Ruby on Rails is dif- ferent from most other programming languages because it takes advantage of many con- ventions to reduce development time. If you follow these conventions, the Rails framework generates substantial functionality and perform many tasks for you. Ruby on Rails has built-in libraries for performing common web development tasks, such as interacting with a database, sending mass e-mails to clients or generating web services. In addition, Rails has built-in libraries that provide Ajax functionality (discussed in Chapter 15), to improve the user experience. Rails is quickly becoming a popular web development environment.

Ruby on Rails was created by David Heinemeier Hansson of the company 37Signals. After developing Basecamp, a web application written in Ruby that allows a business to organize multiple projects. Hansson extracted the reusable components to create the Rails framework. Since then, many developers have enhanced the Rails framework. For more information, visit our Ruby on Rails Resource Center at www.deitel.com/RubyOnRails. Full documentation of the Rails Framework can be found at api.rubyonrails.org.

**24.2 Ruby** The first several examples are simple command-line programs that demonstrate funda- mental Ruby programming concepts. The Ruby scripting language was developed by Yukihiro “Matz” Matsumoto in 1995 to be a flexible, object-oriented scripting language. Ruby’s syntax and conventions are intuitive—they attempt to mimic the way a developer thinks. Ruby is an interpreted language.

**24.1** Introduction **24.2** Ruby **24.3** Rails Framework **24.4** ActionController and ActionView

**24.5** A Database-Driven Web Application **24.6** Case Study: Message Forum

**24.6.1** Logging In and Logging Out **24.6.2** Embellishing the Models **24.6.3** Generating Scaffold Code **24.6.4** Forum Controller and Forum Views **24.6.5** Message Controller and Message Views **24.6.6** Ajax-Enabled Rails Applications

**24.7** Script.aculo.us **24.8** Wrap-Up **24.9** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

**958** Chapter 24 Ruby on Rails

**_Installing Instant Rails_** To run the Ruby scripts in this chapter, Ruby must first be installed on your system. In this chapter we use the **Instant Rails** package to run our applications. Instant Rails in- cludes Ruby, Rails, MySQL, Apache, PHP and other components necessary to create and run Rails applications. PHP is used specifically for **phpMyAdmin**, a web interface to MySQL. Instant Rails is a stand-alone Rails development and testing environment.

To install Instant Rails, download Instant Rails 1.7 from //rubyforge.org/frs/

?group\_id=904. Once the zip file is downloaded, extract its contents to a folder on your hard drive.

After installing Instant Rails, make sure that you stop any existing web servers on your computer such as IIS or Apache— Instant Rails needs port 80 to be available for using **phpMyAdmin** to administer MySQL. If you are not using this tool then you don’t need to stop other web servers on your computer. To run Instant Rails, navigate to the folder where you extracted the contents of the zip file and run **InstantRails.exe**. You should see a window similar to Fig. 24.1.

If you are using Mac OS X, there is an application similar to Instant Rails called Loco- motive. You can download Locomotive from locomotive.raaum.org. Linux users might want to try LinRails (available from linrails.thembid.com). Another program useful for Rails development is Aptana Radrails—a free, open-source IDE. Radrails can be down- loaded from www.aptana.com/download\_rails\_rdt.php.

**_Printing a Line of Text_** Figure 24.2 presents a simple Ruby program that prints the text "Welcome to Ruby!". Lines 1–2 are single-line comments that instruct the interpreter to ignore everything on the current line following the # symbol. Line 3 uses the method **puts** that takes a single parameter (a string) and prints the text to the terminal, followed by a newline. A method can have parentheses surrounding its parameters, but this is not typical in Ruby unless they are used to avoid ambiguity. A line of Ruby code does not have to end with a semicolon, although one can be placed there. The puts method automatically adds a newline escape sequence (\\n) at the end of the string if one is not explicitly added.

**Fig. 24.1** | Instant Rails application running.

**1** \# Fig. 24.2: welcome.rb **2** \# Simple Ruby program. **3**

**Fig. 24.2** | Simple Ruby program. (Part 1 of 2.)

puts "Welcome to Ruby!"  

24.2 Ruby **959**

**_Running a Ruby Script_** A Ruby script can be run several ways. One is to use the **Ruby interpreter**. To do so, launch Instant Rails, click the button in the top-left corner and select **Rails Applications > Open Ruby Console Window** from the drop-down menu (see Fig. 24.3).

In the console, use the cd command to navigate to the directory where welcome.rb is located, then enter ruby welcome.rb. Figure 24.4 shows the Ruby interpreter executing the Ruby file from Fig. 24.2 in the **Ruby Console** window.

Ruby can also execute interactively, using **IRB (Interactive Ruby)**. IRB interprets Ruby code statement by statement. This is useful for debugging code and for experi- menting with Ruby functionality. IRB can be run through Instant Rails by typing IRB in the Ruby Console. Figure 24.5 shows simple Ruby statements interpreted in IRB.

The code after the prompt (irb(main):001:0>) shows the statement that was exe- cuted using the Ruby interpreter in Fig. 24.4. It sends the same string to the output, then returns the value of method puts, which is nil, an object that represents nothing in Ruby.

Welcome to Ruby!

**Fig. 24.3** | Launching the Ruby Interpreter in Instant Rails.

**Fig. 24.4** | Using the Ruby interpreter to run a simple Ruby script.

**Fig. 24.5** | Using Interactive Ruby to execute Ruby statements.

**Fig. 24.2** | Simple Ruby program. (Part 2 of 2.)  

**960** Chapter 24 Ruby on Rails

The code after the second IRB prompt sends the arithmetic expression 2+2 to the interpreter, which evaluates the expression and returns 4. The code after the third prompt requests the class type of the number 4. The interpreter returns **Fixnum**—a class that rep- resents integers in Ruby. Last, the code after the fourth prompt calls the ceil method of 4.5 to round the number up to the next whole-number value. The IRB returns 5. Type exit to quit IRB.

**_Variables and Data Types in Ruby_** Like most scripting languages, Ruby uses **dynamic typing**, which allows changes to a vari- able’s type during runtime. There are several variable types in Ruby, including String and Fixnum. Everything is an object in Ruby, so you can call methods on any piece of data. Figure 24.6 invokes methods on numeric and string data.

Line 3 initializes the variable myvar. Setting myvar to 7.5 temporarily makes it a Float object. The highlighted portion of line 4 is an example of **interpolation** in Ruby. It inserts the object value of the variable inside the braces into the string. Lines 6 and 12 invoke the

**1** \# Fig. 24.6: types.rb **2** \# Method calls on numeric and string data **3** \# binds the value 5.7 to myvar **4** puts "The value of myvar is " **5 6** \# return a rounded value Fixnum **7** puts "The rounded value of myvar is #{myvar}" **8 9** myvar = 5.4 # bind the value 5.4 to myvar

**10** puts "The value of myvar is #{myvar}" **11 12** myvar = myvar.round # return a rounded value Fixnum **13** puts "The rounded value of myvar is #{myvar}" **14 15** \# bind the value 'mystring' to myvar **16** puts "The value of myvar is '#{myvar}'" **17 18** myvar = myvar.capitalize # capitalize the value of myvar **19** puts "The capitalized form of myvar is '#{myvar}'" **20 21** myvar = "my string" # bind the value 'my string' to myvar **22** puts "The value of myvar is '#{myvar}'" **23 24** myvar = myvar.capitalize # capitalize the value of myvar **25** puts "The capitalized form of myvar is '#{myvar}'"

The value of myvar is 5.7 The rounded value of myvar is 6 The value of myvar is 5.4 The rounded value of myvar is 5 The value of myvar is 'mystring' The capitalized form of myvar is 'Mystring' The value of myvar is 'my string' The capitalized form of myvar is 'My string'

**Fig. 24.6** | Method calls on numeric and string data.

myvar = 5.7 #{myvar}

myvar = myvar.round

myvar = "mystring"  

24.2 Ruby **961**

round method on the Float object to demonstrate rounding a value up or down, respec- tively. The type of myvar changes to String in line 15. Lines 18 and 24 changes the first letter of the first word of this String by calling its capitalize method. A list of the avail- able methods for the Ruby types can be found at www.ruby-doc.org/core/.

**_Using Arrays and Hashes_** Ruby provides both **Arrays** and **Hashes** to store data. Each stores a list of objects. In an Array, indices of type Fixnum are used to select an Object from the Array. In a Hash, Ob- jects are mapped to other Objects in key/value pairs. Figure 24.7 shows an example of using both an Array and a Hash to store information.

Line 3 instantiates a Ruby Array. Array elements can be accessed by their index number in square brackets (line 5). You may also traverse Arrays backward by using neg- ative number indices. For example line 6 outputs the last array element. Line 8 reverses the elements in the Array with method **reverse!**. The exclamation point after the method name is a Ruby convention indicating that the object on which the method is called will be modified. Method reverse without an exclamation point returns a copy of the original array with its elements reversed. Many Ruby methods follow this convention.

Line 14 is an example of a Hash. The key/value pairs are separated by commas, and each key points to its corresponding value using the => operator. The value of a hash ele- ment can be found by passing in the key in square brackets, as shown in lines 16–17.

**1** \# Fig. 24.7: arraysAndHashes.rb **2** \# Arrays and hashes in Ruby. **3** \# create an array **4** puts "The length of the fruits array is #{ }" # output length **5** puts "The first fruit is #{ }" # output first element **6** puts "The last fruit is #{ }\\n\\n" # output last element **7 8** fruits.reverse! # reverse the order of the elements in the fruits array **9** puts "The length of the fruits array is #{fruits.length}" # output length

**10** puts "The first fruit is #{fruits\[0\]}" # output first element **11** puts "The last fruit is #{fruits\[-1\]}\\n\\n" # output last element **12 13** \# a simple hash **14 15** puts "The length of the food hash is #{food.length}" # output length **16** puts "A mango is a #{food\["mango"\]}" # output value of key mango **17** puts "An onion is a #{food\["onion"\]}" # output value of key onion

The length of the fruits array is 4 The first fruit is mango the last fruit is pear

The length of the fruits array is 4 The first fruit is pear the last fruit is mango

The length of the food hash is 3 A mango is a fruit An onion is a vegetable

**Fig. 24.7** | Arrays and hashes in Ruby.

fruits = \[ "mango", "orange", "apple", "pear" \] fruits.length

fruits\[0\] fruits\[-1\]

food = { "mango" => "fruit", "banana" => "fruit", "onion" => "vegetable" }  

**962** Chapter 24 Ruby on Rails

**_Conditionals, Loops and Code Blocks_** Like any other programming language, Ruby provides selection and repetition statements. In addition, Ruby has support for **code blocks**—groupings of Ruby statements that can be passed to a method as an argument. Figure 24.8 shows a program that returns a stu- dent’s letter grade based on a numerical grade.

Lines 3–15 of Fig. 24.8 contain a Ruby method definition. Methods must be defined in a program before they are used. All methods start with **def** and end with **end**. Methods do not have to specify parameter types, but they must specify the name of each parameter. Lines 4–14 show a nested if…elsif…else statement that returns an appropriate letter grade based on the numeric value the method receives as an argument. If a method does not include an explicit return statement Ruby returns the last value or variable it encoun- ters when executing the function.

Line 17 defines a Hash of students and their numeric grades. Lines 19–21 show an example of a code block. A method may have a parameter containing a block of code, such as the each method. The block of code appears in brackets directly after the method call. A code block is similar to a method, in that parameters can be passed into it. The param- eters for a code block are given between pipe characters (|) and are separated by commas. The parameters are followed immediately by the code block’s statements. The code block in lines 19–21 outputs a line of text based on the key/value pair of every key in the Hash.

**1** \# Fig. 24.8: controlStatements.rb **2** \# Conditionals, loops, and codeblocks. **3** \# define method letterGrade **4** if x >= 90 # if x is greater than or equal to 90 **5** "A" # grade is A **6** elsif x >= 80 # if x is greater than or equal to 80 **7** "B" # grade is B **8** elsif x >= 70 # if x is greater than or equal to 70 **9** "C" # grade is C

**10** elsif x >= 60 # if x is greater than or equal to 60 **11** "D" # grade is D **12** else # grade is less than 60 **13** "F" # grade is F **14** end # if **15** end # method letterGrade **16 17** students = { "John" => 100, "Sue" => 92, "Tom" => 56, "Jill" => 80 } **18 19** \# display the letter grade for each student **20 21** } # end codeblock

Jill received a B Sue received a A John received a A Tom received a F

**Fig. 24.8** | Conditionals, loops and codeblocks.

def letter\_grade( x )

students.each() { |key, value| puts "#{key} received a #{letter\_grade(value)}"  

24.2 Ruby **963**

**_Classes_** You can create your own classes and instantiate objects. Classes enable you to encapsulate methods and data. Figure 24.9 shows a class named Point that stores _x_\-_y_ coordinates.

Line 3 begins the class definition with the keyword class followed by the class name. The initialize method (lines 7–11), like constructors in other object-oriented lan- guages, is used to declare and initialize an object’s data. When each instance of a class maintains its own copy of a variable, the variable is known as an **instance variable**. Lines 8–9 use the @ symbol to define the instance variables x and y. Classes can also have **class variables** that are shared by all copies of a class. Class variables always begin with @@ (line 4) and are visible to all instances of the class in which they are defined. Line 10 increments @@num\_points every time a new Point is defined.

You can create new classes by inheriting from existing ones and providing your own additional or enhanced functionality. Lines 14–16 override the inherited **to\_s method**, which is a method of all Ruby objects. When an object is concatenated with a string, the to\_s method is implicitly called to convert the object to its string representation. Class Point’s to\_s method for the Point class returns a string containing the _x_\-_y_ coordinates.

**1** \# Fig. 24.9: Classes.rb **2** \# A Ruby class. **3 4** \# initialize numPoints **5 6** \# create a new Point object **7 8** @x = x # initialize x-coordinate **9** @y = y # initialize y-coordinate

**10** \# increment numPoints counter **11** end # method initialize **12 13** \# return a string containing the x-y values **14 15** return "x: #{@x}; y: #{@y}" **16** end # method to\_s **17 18** \# return how many Points have been instantiated **19** def num\_points **20** return @@num\_points **21** end # method numPoints **22** end # class Point **23 24** \# instantiate a Point **25** \# instantiate another Point **26** puts "the value of p is '#{p}'" **27** puts "the value of q is '#{q}'" **28** puts "the number of points created is #{p.num\_points}"

the value of p is 'x: 8; y: 9' the value of q is 'x: 1; y: 1' the number of points created is 2

**Fig. 24.9** | A Ruby class.

class Point @@num\_points = 0

def initialize(x, y)

@@num\_points +=1

def to\_s

p = Point.new( 8, 9 ) q = Point.new( 1, 1 )  

**964** Chapter 24 Ruby on Rails

**24.3 Rails Framework** While users have benefitted from the rise of database-driven web applications, web devel- opers have had to implement rich functionality with technology that was not designed for this purpose. The Rails framework combines the simplicity of Ruby with the ability to rap- idly develop database-driven web applications.

**_Model-View-Controller_** Ruby on Rails is built on the philosophies of **Convention over Configuration** and **Don’t Repeat Yourself (DRY)**. If you follow certain programming idioms, your applications will require minimal configuration, and Rails will generate substantial portions of your web applications for you. One of these conventions is using the **Model-View-Controller (MVC)** design pattern, which splits the application into the business logic aspects handled by the model and the design aspects handled by the view. The controller handles client requests by obtaining information from the model and rendering it to the view.

The MVC architectural pattern separates application data (contained in the **model**) from graphical presentation components (the **view**) and input-processing logic (the **con- troller**). Figure 24.10 shows the relationships between components in MVC.

The controller implements logic for processing user input. The model contains appli- cation data, and the view presents the data from the model. When a user provides input, the controller modifies the model with the given input. When the model changes, the con- troller notifies the view so that it can update its presentation with the changed data.

MVC does not restrict an application to a single view and a single controller. In a more sophisticated program, there might be two views of a document model. One view might display an outline of the document and the other might display the complete doc- ument. An application also might implement multiple controllers—one for handling key- board input and another for handling mouse selections. If either controller makes a change in the model, both the outline view and the print-preview window will show the change immediately when the controller notifies all views of changes.

The primary benefit to the MVC architectural pattern is that developers can modify each component individually without having to modify the others. For example, devel- opers could modify the view that displays the document outline without having to modify either the model or other views or controllers.

**_Overview_** In the following examples, we show how to create a Ruby on Rails application. We show how a controller can be used to send information to the client directly, and how a control-

**Fig. 24.10** | Model-View-Controller architecture.

View

Controller modifies

notifies when changes occur to the model

Model  

24.3 Rails Framework **965**

ler can render a view for a cleaner and more organized design. We then show how to set up a database in a Ruby on Rails application. Finally, we show how to generate a model to be the front end of a database in a dynamic web application.

**_Creating a Rails Application_** The Instant Rails package comes with a full install of Rails that includes ActiveRecord, ActionView, and ActionController. **ActiveRecord** is used to map a database table to an Object. **ActionView** is a set of helper methods to modify user interfaces. **ActionControl- ler** is a set of helper methods to create controllers. To generate an empty Rails application in Instant Rails, click the button and select **Rails Applications > Manage Rails Applica- tions...** from the drop-down menu to display the **Rails Applications** window. In that win- dow click the **Create New Rails App...** button. In the console that appears, type rails

_Application Name_ at the command line to create a directory named _Application Name_ with a prebuilt directory structure inside. For the first example, use Welcome as the application name. Figure 24.11 shows the directory structure that is automatically generated by Rails. The directories that we’ll be primarily concerned with are app\\controllers, app\\models, and app\\views.

**Fig. 24.11** | Rails directory structure for a new Rails application.  

**966** Chapter 24 Ruby on Rails

**24.4 ActionController and ActionView** Ruby on Rails has two classes that work together to process a client request and render a view. These classes are ActionController and ActionView.

**_Rails Controller_** To generate a controller in Rails, you can use the built-in Controller generator. To do that, open the **Ruby Console** window and navigate to the application directory by typing in:

cd _pathToInstantRails_\\rails\_apps\\_applicationName_

To generate a controller for the welcome application type:

ruby script/generate controller Welcome

This creates several files including welcome\_controller.rb, which contains a class named WelcomeController. Figure 24.12 shows a controller for our Welcome example contain- ing only one method.

Line 3 defines a class WelcomeController that inherits from ApplicationCon-

troller. ApplicationController inherits from ActionController::Base, which pro- vides all of the default functionality for a controller. The method in lines 5–7 renders text in XHTML format to the browser using the render method

Line 6 specifies the text parameter of the render variable using a **ruby symbol**. Sym- bols are identifiers preceded by a colon that have a particular value or variable associated with them. When specifying a parameter in a method the notation is as follows:

_parameter\_symbol_ \=> _parameter\_value_

**1** \# Fig. 24.12: app/controllers/welcome\_controller.rb **2** \# Simple controller that renders a message on a web page. **3** class WelcomeController < ApplicationController **4** \# render text in page **5** def index **6 7** end # method index **8** end # class WelcomeController

**Fig. 24.12** | Simple controller that renders a message on the web page.

render :text => "Welcome to Ruby on Rails!"  

24.4 ActionController and ActionView **967**

**_Running Ruby on Rails_** A Ruby on Rails application must be run from a web server. In addition to Apache, Instant Rails comes with a built-in web server named Mongrel, which is easy to use to test Rails applications on the local machine. You can start the Mongrel server through Instant Rails by going to the **Rails Application** window, selecting the **Welcome** application from the list and clicking the **Start with Mongrel** button (Fig. 24.13).

One important feature of Rails is its URL mapping ability. Rails automatically sets up your web application in a tree structure, where the controller’s name in lowercase is the directory, and the method name is the subdirectory. Since the controller name is Welcome and the method name is index, the URL to display the text in Figure 24.12 is http:// localhost:3000/welcome/index. Notice in the screen capture of Figure 24.12 that the URL is simply http://localhost:3000/welcome. The default action called on any con- troller is the one specified by the method index. So, you do not need to explicitly invoke the index in the URL to render the text in line 6.

**_Rendering a View_** When generating output, a controller usually renders a **template**—an XHTML document with embedded Ruby that has the .rhtml filename extension. \[_Note:_ The next version of Rails will use the extension .html.erb rather than .rhtml.\] The embedded Ruby comes from a library named erb. A method in a controller will automatically render a view with the same name by default. For example, an empty hello method would look for a hel-

lo.rhtml view to render. Fig. 24.14 is the Welcome controller with a hello method added. The index method has been removed for simplicity.

The server\_software method (line 6) is called on the **request object**—an object that contains all of the environment variables and other information for that web page. The method **server\_software** returns the name of the server that is running the web applica- tion. This name is stored in an instance variable that will be used by the view. Our hello method looks for a hello.rhtml file in the web application’s app/views/welcome direc- tory. Figure 24.15 shows a sample hello.rhtml file.

The view consists mostly of XHTML. The erb is shown in line 14, surrounded by <%= and %> tags. Everything between these tags is parsed as Ruby code and formatted as text. Ruby delimiters without an equals sign—<% %>—represents statements to execute as Ruby code but not formatted as text. The @server\_name variable is passed in directly from the controller in the view. To run this application, modify the welcome.rb controller file to look like Figure 24.14. Then go to the /app/views/welcome directory, create the

**Fig. 24.13** | Starting the Mongrel web server.  

**968** Chapter 24 Ruby on Rails

hello.rhtml file in Fig. 24.15. Run the welcome application on the Mongrel server (if it is not already running) and direct your browser to the URL http://localhost:3000/

welcome/hello.

**_Using a Layout_** Often, information spans multiple web pages that could be viewed as a header or footer. Rails allows you to add headers and footers with a **layout**—a master view that is displayed by every method in a controller. A layout can refer to a template of the method that is be- ing called, using **yield**. A layout has the same name as the controller, and is placed in the

**1** \# Fig. 24.14: app/controllers/welcome\_controller.rb **2** \# Simple controller that passes a parameter to the view. **3** class WelcomeController < ApplicationController **4** \# set server\_name to server information **5** def hello **6** \# retrieve software of server **7** end # method hello **8** end # class WelcomeController

**Fig. 24.14** | Simple controller that passes a parameter to the view.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.15: app/views/welcome/hello.rhtml --> **6** <!-- View that displays the server name. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>hello</title>

**10** </head> **11** <body style = "background-color: lightyellow"> **12** <strong>Hello from the view!</strong><br /> **13** The server you are coming from is **14** <em> </em> **15** </body> **16** </html>

**Fig. 24.15** | View that displays the name of the server.

@server\_name = request.server\_software

<%= @server\_name %>  

24.5 A Database-Driven Web Application **969**

app/views/layouts directory. Figure 24.16 is a layout for the Welcome controller. To add a layout to the application create a welcome.rhtml file in the apps/views/layouts direc- tory. To run this application, re-load the page from Fig. 24.15.

Line 9 invokes the **action\_name** method on the controller object. This displays the name of the method that is currently being called in the controller. Instance variables defined in the controller are copied to both the layout and the view that the layout renders. Line 14 is a placeholder for the view content (hello.rhtml in this example) that is specific to the action called in the controller.

**24.5 A Database-Driven Web Application** The third tier of a typical Rails application—the model—manages the data used in the ap- plication. In this section, we set up a database and build a fully functional web application using the ActionView and ActionController classes that we introduced in Section 24.4. We create an application that allows the user to browse and edit an employee list. To create this application’s structure, type rails Employees in the **Ruby Console** window.

**_Object Relational Mapping_** Rails makes extensive use of **Object-Relational Mapping (ORM)** in its web framework. ORM maps a table to application objects. The objects that Rails uses to encapsulate a da-

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.16: app/views/layouts/welcome.rhtml --> **6** <!-- Layout that displays a greeting. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title> </title>

**10** </head> **11** <body style = "background-color: lightyellow"> **12** Hello from the Layout!<br /> **13** <hr /> **14** <!-- render template --> **15** </body> **16** </html>

**Fig. 24.16** | Layout that displays a greeting.

<%= controller.action\_name %>

<%= yield %>  

**970** Chapter 24 Ruby on Rails

tabase inherit from **ActiveRecord**. By using ActiveRecord and Rails conventions, you can avoid a lot of explicit configuration.

One ActiveRecord convention is that every model that extends ActiveRecord::Base in an application represents a table in a database. The table that the model represents is, by convention, the lowercase, pluralized form of the model. For example, if there were a messages table in your database, Message would be the name of the model representing it. ActiveRecord follows many standard English pluralization rules as well, which means that a Person model would automatically correspond to a people table. Furthermore, if a people table has a first\_name column, the Person model would have a method named first\_name that returns the value in that column. ActiveRecord does this for you with no additional configuration.

**_Creating the Database_** Before creating a model using ActiveRecord, we need to create the database it will use. You can do that using MySQL’s mysqladmin command. Rails will automatically look for a da- tabase with the name _applicationName_\_development to use as the development database. To create a database for the Employees application, launch the **Ruby Console** and type in mysqladmin -u root create employees\_development. If no error is returned, the database was created successfully in the mysql/data directory of your InstantRails installation.

By default MySQL has the user name root and no password. If your settings are dif- ferent you can modify the appropriate fields database.yml, located in the config folder in your application directory.

**_Creating the Employee Model_** Since Rails separates the model from the rest of the application, we simply need to put the Employee class definition in the models directory. Rails uses a generator to create the mod- el for the employees table, which you use by navigating to your application directory then typing ruby script/generate model employee in the **Ruby Console.** The result is shown in Fig. 24.17.

The last line the console returns is create db/migrate/001\_create\_employees.rb. We have not yet created a table employees, so Ruby automatically generates a script that will create this table when the application launches. We can modify this script to perform additional initial changes to the employees table. Figure 24.19 shows a modification of 001\_create\_employees.rb (located in your application’s db/migrate directory) that cre- ates the table and adds three records to it.

ActiveRecord has a special feature called Migration, which allows you to preform database operations within Rails. Each object that inherits from ActiveRecord::Migra-

**Fig. 24.17** | Creating a model in the Ruby Console.  

24.5 A Database-Driven Web Application **971**

tion must implement two methods—self.up (lines 5–18), which preforms a set of data- base operations, and self.down (lines 21–23), which reverses the database operations performed in self.up. In this case self.up creates the table with three columns and adds data to it, and self.down deletes the table. Line 6 calls the create\_table function passing as a parameter a code block, inside the do, containing the table’s column names and types. Lines 12–17 use ActiveRecord’s built in create method to add data to the Employees

table. ActiveRecord has built-in functionality for many create, retrieve, update, and destroy methods—known in Rails as **CRUD**. These methods represent the trivial opera- tions that you would want to do with a database.

We can execute the migration using Ruby’s rake command. To do so open up the **Ruby Console**, navigate to your application’s directory and type rake db:migrate. This command will call the self.up method of all the migrations located in your db/migrate directory. If you ever want to roll back the migrations you can type in rake db:migrate

VERSION=0, which calls each migration’s self.down method. Specifying a version number other than 0 will call the self.down method of all the migrations whose number is greater then the version number.

**Common Programming Error 24.1** _If the code that comes after the creation of the table in the self.up is erroneous, the migration will fail, and will not be able to execute again because the table will already exist. Also, Rails will not have marked the migration as successfully completed, so the version will still be 0 and the migration cannot be rolled back. One way to prevent this problem is to force the table to be dropped every time before creating it. Another solution is splitting up the migration into smaller discrete migrations, one to create the table and another to insert data in the table._ 24.1

**1** \# Fig. 24.18: db/migrate/001\_create\_employees.rb **2** \# Database migration script modified to add data to the table **3** class CreateEmployees < ActiveRecord::Migration **4** \# create the table with three columns and insert some rows. **5** def self.up **6 7 8 9**

**10** end # do block **11 12 13 14** Employee.create :first\_name => "Meg", :last\_name => "Gold", **15** :job\_title => "Programmer" **16** Employee.create :first\_name => "John", :last\_name => "Gray", **17** :job\_title => "Programmer" **18** end # method self.up **19 20** \# reverse the migration, delete the table that was created **21** def self.down **22 23** end # method self.down **24** end # class CreateEmployees

**Fig. 24.18** | Database migration script modified to add data to the table,

create\_table :employees do |t| t.column :first\_name, :string t.column :last\_name, :string t.column :job\_title, :string

Employee.create :first\_name => "Sue", :last\_name => "Green", :job\_title => "Programmer"

drop\_table :employees  

**972** Chapter 24 Ruby on Rails

Because our model will never be modified by the application, we do not need to add any functionality to it. Figure 24.19, which represents the employee.rb file located in the app/Models directory, contains all the code that is needed to integrate the employees data- base table into the application.

**_Employee Controller_** Next, create the controller with the ruby script/generate controller employees com- mand as shown in Section 24.4. Figure 24.20 shows the example controller for the Em- ployee application. Line 4 calls the **scaffold method**. This is a powerful tool that automatically creates CRUD functionality. It creates methods such as new, edit and list

so you don’t have to create them yourself. It also defines default views for these methods that are rendered when each method is called. You can override the default functionality by defining your own methods. If you override all the CRUD methods you can delete the scaffold method. When you override a method, you must also create the corresponding view. Since we will not modify the new method created by the scaffold you can see the new method’s view with the URL http://localhost:3000/employee/new (Figure 24.21). Line 7–9 override the list method. Line 8 queries the database and returns a list of all of the Employee objects, which gets stored in an @employees instance array. This data will be passed to the view.

**_The list View_** The list template is rendered by the list method from the EmployeeController. Code for the list template is shown in Fig. 24.22. This file should be placed in your applica- tion’s app/views/employee directory. While most of it is just standard XHTML, lines 14– 17 contain Ruby code that iterates through all the employees in the @employees array in- stance variable, and outputs each employee’s first and last name (line 16). A for statement like this in a list view is common in database-driven web applications.

**1** \# Fig. 24.19: employee.rb **2** \# Generated code for an Employee Model. **3** class Employee < ActiveRecord::Base **4** end # class Employee

**Fig. 24.19** | Generated code for an Employee model.

**1** \# Fig. 24.20: app/controllers/employees\_controller.rb **2** \# Provides all of the functionality for the application. **3** class EmployeesController < ApplicationController **4** \# create scaffold code for controller **5 6** \# override scaffold list method **7** def list **8** \# return an array of Employees **9** end # method list

**10** end # class EmployeeController

**Fig. 24.20** | Employee controller provides all of the functionality for the application.

scaffold :employee

@employees = Employee.find( :all )  

24.5 A Database-Driven Web Application **973**

**Fig. 24.21** | View of the new action when generated by the scaffold.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.22 app/views/employees/list.rhtml --> **6** <!-- A view that displays a list of Employees. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>List of Employees</title>

**10** </head> **11** <body style="background-color: lightyellow"> **12** <h1>List of Employees</h1> **13** <ol> **14 15** <!-- create a list item for every employee with his full name --> **16** <li> </li> **17 18** </ol> **19** </body> **20** </html>

**Fig. 24.22** | A view that displays a list of employees.

<% for employee in @employees %>

<%= employee.first\_name %> <%= employee.last\_name %> <% end %>  

**974** Chapter 24 Ruby on Rails

**24.6 Case Study: Message Forum** Our next example uses Ruby on Rails to create a **message forum** website. Message forums enable users to discuss various topics. Common features of message forums include discus- sion groups, questions and answers and general comments. To see some popular message forums, visit messages.yahoo.com, web.eesite.com/forums and groups.google.com. In this example, users can post messages to several different forums, and administrators of the message forum site can create and delete forums.

**_Design_** For our message forum application, we need a table containing all of the messages. This table will be called messages and will contain attributes such as id, title, author, e-mail, created\_on (the date the message was created) and forum\_id (the id of the forum to which the message belongs). In addition, we need a table of all the available forums. This table, called forums, will contain attributes such as id, name, administrator and created\_on (the date the forum was created).

In our message forum application, we want to have the functionality to create and delete forums, but we don’t want everyone who uses our application to be able to do this. Therefore, we will also have a users table, which contains the username/password combi- nations of all the application’s administrators.

Before we implement this design we must create the empty application called mes-

sageboard and the database for this application. Type in rails Messageboard and then mysqladmin -u root create messageboard\_development in the **Ruby Console**.

**24.6.1 Logging In and Logging Out** Use the model generator to generate the User model by typing ruby script/generate

model User into the **Ruby Console** (from the Messageboard directory). Next, create the ta- ble that will be associated with the model. To do that, modify the migration created by the model generator to set up the users table and add some data to it. Figure 24.23 is the 001\_create\_users.rb migration (from the db/migrate directory) which sets up the user table.

The create\_table function call (lines 6–9) specifies the table’s columns. By default a primary key id column is created, so it is not included here. Lines 7–8 create the name

and password columns with appropriate types. Note that the name has a limit of 11 char- acters. Line 11 adds data to the table. To execute this migration type rake db:migrate in the **Ruby Console**.

**1** \# Fig. 24.23: db/migrate/001\_create\_users.rb **2** \# Database migration script modified to add data to the table. **3** class CreateUsers < ActiveRecord::Migration **4** \# create and configure users table **5** def self.up **6 7** t.column :name, :string, :limit => 11 **8** t.column :password, :string **9** end # do block

**Fig. 24.23** | Database migration script modified to add data to the table. (Part 1 of 2.)

create\_table :users do |t|  

24.6 Case Study: Message Forum **975**

**Common Programming Error 24.2** _Creating a column without explicitly specifying a limit on length will cause Rails to truncate the data entered into the database with database-defined limits._ 24.2

Since the users table never changes, nothing needs to be specified in the User model, but one still needs to exist. This will allow the controller to access a User as an ActiveRecord. Figure 24.24 shows the empty model for the users table.

Next, we need to provide user creation, field validation and user logout functionality through the use of a controller (Fig. 24.25). Create this controller by typing ruby script/

generate controller user. When a user logs in, we will keep track of that User object in a **session variable**—a variable that maintains information across multiple pages of a web application. The purpose of the admin method (lines 5–7) is to pass a blank user object into the admin page, which will get filled with information, then render the admin.rhtml

template. The validate method (lines 10–21) checks the user model to determine

**10 11** User.create :name => "user1", :password => "54321" **12** end # method self.up **13 14** \# remove users table **15** def self.down **16** drop\_table :users **17** end # method self.down **18** end # class CreateUsers

**Fig. 24.23** | Database migration script modified to add data to the table. (Part 2 of 2.)

**1** \# Fig. 24.24: app/models/user.rb **2** \# Generated code for the User model. **3** class User < ActiveRecord::Base **4** end # method User

**Fig. 24.24** | Generated code for the User model.

**1** \# Fig. 24.25: app/controllers/users\_controller.rb **2** \# UsersController provides validation functionality for the table. **3** class UsersController < ApplicationController **4** \# create a new User object **5** def admin **6** \# create a new User object **7** end # method admin **8 9** \# validate that user exists

**10 11 12 13 14**

**Fig. 24.25** | UsersController provides validation functionality for the table. (Part 1 of 2.)

@user = User.new

def validate # find a user with the correct name and password @user = User.find\_by\_name\_and\_password( params\[ :user \]\[ :name \],

params\[ :user \]\[ :password \] )  

**976** Chapter 24 Ruby on Rails

whether the username exists, then redirects the application to the next action based on the result of that check.

Rails allows us to generate methods dynamically to serve a specific purpose. Lines 12– 13 call the find\_by\_name\_and\_password method, which searches the model with the name and password, passed as a parameter.

The validate method assigns to an instance variable named @user (line 12) the value of the User that was returned by the find\_by\_name\_and\_password method. If no such User exists, the client is redirected to the admin page and asked to log in again (line 16). If the User does exist, a session variable is created (line 18), and line 19 redirects the client to the index of the forums controller, which we create in Section 24.6.4. The logout

method (lines 24–27) uses the reset\_session method to delete all the user’s session vari- ables, forcing the user to sign in again to use administrative options.

**Performance Tip 24.1** _Storing full objects in the session is inefficient. The user object is one of the rare exceptions, because it doesn’t change very often and is frequently needed in web applications that manage the state information for unique clients._ 24.0

Method admin’s view is a simple login form. The template is shown in Fig. 24.26. It asks the user for a name and password using the **text\_field** (line 6) and **password\_field**

(line 9) helpers, then sends the information to the validate method when the user clicks **Sign In**.

**15 16 17 18 19 20 21 22 23** \# log user out **24** def logout **25 26** " # redirect **27** end # method logout **28** end # class UserController

**Fig. 24.25** | UsersController provides validation functionality for the table. (Part 2 of 2.)

if ( @user == nil ) # if the user dosn’t exist redirect\_to :action => "admin" # redirect to admin action

else # user does exist session\[ :user \] = @user # store the user in a session variable redirect\_to :controller => "forums", :action => "index"

end # if end # method validate

reset\_session # delete all session variables redirect\_to :controller => "forums", :action => "index

**1** <!-- Fig. 24.26: app/views/users/admin.rhtml --> **2** <!-- Login form used to send data to the user controller. --> **3** <h1>Please Log In</h1> **4** <!-- create form tag --> **5** <p><label for="user\_name">Name</label><br/> **6** </p> <!-- create input tag --> **7**

**Fig. 24.26** | Login form used to send data to the user controller. (Part 1 of 2.)

<% form\_tag :action => 'validate' do %>

<%= text\_field 'user', 'name' %>  

24.6 Case Study: Message Forum **977**

Rails **helpers** are methods that generate XHTML content for the view. The password\_field helper method generates a text field that masks the text inside it. Both text\_field and password\_field specify a model and the column. This information is used to determine the validation properties for each column when validating the text typed into these fields. When the user clicks the submit button defined in line 10, the **form\_tag** method (line 4) automatically generates a Hash, where the keys are the names of the input fields and the values are what the user entered, and sends it to the validate action. The link to the validate action is specified by the action option. To display this action, run the Mongrel server and navigate your browser to http://localhost:3000/user/admin.

We define the user controller’s template in Fig. 24.27. Because the user controller has only a single view to render, we could have simply include this XHTML in the view. The benefit of a template is that it allows us to easily add more views in the future that are all based on the same template and adhere to Ruby on Rails’ DRY (Don’t Repeat Yourself) philosophy. Line 9 displays the current action in the title bar. Line 12 is the placeholder for the content of the action’s view.

**8** <p><label for="user\_password">Password</label><br/> **9** </p> <!-- create input tag -->

**10** <!-- create submit tag --> **11** <!-- create an end form tag -->

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.27: app/views/layouts/users.rhtml--> **6** <!-- Display the name of the current action in the title bar --> **7** <html xmlns = "http://www.w3.org/1999/xhtml">

**Fig. 24.27** | Display the name of the current action in the title bar. (Part 1 of 2.)

**Fig. 24.26** | Login form used to send data to the user controller. (Part 2 of 2.)

<%= password\_field 'user', 'password' %> <%= submit\_tag "Sign In" %>

<% end %>  

**978** Chapter 24 Ruby on Rails

**24.6.2 Embellishing the Models** Several methods must be added to the model so that it can be modified from the applica- tion. These methods are all defined by ActiveRecord.

**_Message Model_** First, we must create an empty Message model by typing ruby script/generate model

Message in the **Ruby Console**. Before we make any change to the model we must create the messages table. Figure 24.28 is the migration that creates the messages table and adds data to it. To run this migration, navigate to the messageboard directory and type rake

db:migrate.

**8** <head> **9** <title>Users: <%= controller.action\_name %></title>

**10** </head> **11** <body> **12** <%= yield %> **13** </body> **14** </html>

**1** \# Fig. 24.28: db/migrate/002\_create\_messages.rb **2** \# Database migration script modified to add data to the table. **3** class CreateMessages < ActiveRecord::Migration **4** \# create and configure messages table **5** def self.up **6** create\_table :messages, do |t| **7** t.column :title, :string, :limit => 64 **8** t.column :author, :string, :limit => 20 **9** t.column :created\_on, :timestamp

**10** t.column :email, :string, :limit => 40 **11** t.column :message, :text **12** t.column :forum\_id, :integer **13** end # do block **14 15** Message.create :title => "Welcome to the Fourth Edition", **16** :author => "Bob Green", **17** :email => "noone@deitel.com", **18** :message => "We hope you enjoy the book.", **19** :forum\_id => 2 **20** end # method self.up **21 22** \# remove messages table **23** def self.down **24** drop\_table :messages **25** end # method self.down **26** end # class CreateForums

**Fig. 24.28** | Database migration script modified to add data to the table.

**Fig. 24.27** | Display the name of the current action in the title bar. (Part 2 of 2.)  

24.6 Case Study: Message Forum **979**

The create\_table function call (lines 6–13) specifies the columns of the table. Lines 7–12 create the title, author, created\_on, email, message and forum\_id columns with appropriate variable types and length limits. Lines 15–20 add data to the table. Rails fills the created\_on column value automatically when a new row is created. To apply the migration, type rake db:migrate in the console window.

Figure 24.29 shows the Message model that encapsulates the messages table in the database. Line 4 invokes the belongs\_to method, which defines an association with the forums table that can be used to access elements of the forums table. This method will allow the Message to access the forum to which the given Message belongs simply by calling a method named forum on the Message. This is known as an **association method**.

Lines 7–9 are examples of **validators** that can be applied to an object that inherits from ActiveRecord. These validations occur when the save method is called on a message object in an attempt to store it in the database. If the validations are successful, then the object is saved to the database and the method returns true. If the validations fail, an Errors object associated with the Message object is updated and the method returns false. The method **validates\_presence\_of** ensures that all of the fields specified by its parameters are not empty. The method **validates\_format\_of** matches all of the fields specified by its parameters with a regular expression. The regular expression in line 9 rep- resents a valid e-mail address. This regular expression can be found in the Rails framework documentation at api.rubyonrails.org.

**_Forum Model_** Next, create an empty forum model by typing in ruby script/generate model forum. Then create the forums table in a similar fashion to messages and users. Figure 24.30 is the Migration that sets up the messages table.

The create\_table function call (lines 6–10) specifies the columns of the table. Lines 7–9 create the name, administrator and created\_on columns with appropriate variable types and length limits. Lines 12–16 add data to the table. To apply the migration, type in rake db:migrate.

The model for the forums table (Fig. 24.31) looks similar to the model for the mes-

sages table. We can create an association method that allows a Forum to access every Mes-

sage that is associated with it. Line 4 shows the **has\_many** method, which will create a method called messages for every Forum object. The messages method will return an array of all the messages in the Forum.

**1** \# Fig. 24.29: app/models/message.rb **2** \# Message Model containing validation and initialization functionality. **3** class Message < ActiveRecord::Base **4** \# adds a forum method to Message **5 6** \# validators (validates automatically before ActiveRecord.save) **7 8 9**

**10** end # class Message

**Fig. 24.29** | Message model containing validation and initialization functionality.

belongs\_to :forum

validates\_presence\_of :title, :author, :email, :message validates\_format\_of :email,

:with => /^(\[^@\\s\]+)@((?:\[-a-z0-9\]+\\.)+\[a-z\]{2,})$/i  

**980** Chapter 24 Ruby on Rails

When a forum is deleted, all of that forum’s messages should also be deleted. Line 4 sets the dependent parameter of the has\_many method to :destroy to ensure that when a forum is destroyed all the messages that are associated with it are destroyed as well.

**24.6.3 Generating Scaffold Code** Now that the user can log in and out of our application, we need to create the messages

and forums views and controllers. Since much of this code is standard CRUD, we can use the Rails scaffold generator by typing ruby script/generate scaffold message and ruby script/generate scaffold forum in the **Ruby Console**. The scaffold generator

creates the scaffold code that would be generated using the scaffold method in the con- troller. When using the scaffold method, notice that the controller name and the view directory are both pluralized forms of the name, rather than the singular form that the model generator and controller generator would create.

**1** \# Fig. 24.30 db/migrate/003\_create\_forums.rb **2** \# Database migration script modified to add data to the table. **3** class CreateForums < ActiveRecord::Migration **4** \# Create and configure forums table **5** def self.up **6** create\_table :forums do |t| **7** t.column :name, :string, :limit => 64 **8** t.column :administrator, :string, :limit => 20 **9** t.column :created\_on, :timestamp

**10** end # do block **11 12** Forum.create :name => "Ruby On Rails", **13** :administrator => "user1" **14** Forum.create :name => "Internet and World Wide Web: 4th Edition", **15** :administrator => "user1" **16** end # method self.up **17 18** \# remove forums table **19** def self.down **20** drop\_table :forums **21** end # method self.down **22** end # class CreateForums

**Fig. 24.30** | Database migration script modified to add data to the table.

**1** \# Fig. 24.31: app/models/forum.rb **2** \# Forum model that includes validation and initialization functionality. **3** class Forum < ActiveRecord::Base **4 5** validates\_presence\_of :name **6** end # class Forum

**Fig. 24.31** | Forum model that includes validation and initialization functionality.

has\_many :messages, :dependent => :destroy  

24.6 Case Study: Message Forum **981**

**24.6.4 Forum Controller and Forum Views** The ForumsController (Fig. 24.32), which was initially generated as part of the scaffold- ing, handles all incoming requests from the client. The index, list, new, and delete

methods are all responsible for rendering a view, while the create and destroy methods are responsible for processing incoming data and then redirecting to another action. We will not use the edit or show methods so you may delete the .rhtml view files associated with them.

The verify method call in lines 4–5 is edited scaffold code, which ensures a post

request is used to send data to the server for each request that modifies the database. Whenever a method modifies a database, the arguments should be from a post so that they don’t show up in the URL. The :only argument specifies which actions this verification should be applied (create and destroy in this case). If a call to create or destroy is not made via a post request, line 5 redirects the request to the list action.

**1** \# Fig. 24.32: app/controllers/forums\_controller.rb **2** \# ForumsController implements CRUD functionality. **3** class ForumsController < ApplicationController **4 5 6 7** \# shortcut to the list method **8** def index **9** list

**10** render :action => 'list' **11** end # method index **12 13** \# set up the list web page that lists all forums **14** def list **15** @forums = Forum.find( :all ) **16** end # method list **17 18** \# set up the new web page that adds a new forum **19** def new **20** if ( session\[ :user \] == nil ) # if user is not logged in **21 22** redirect\_to :action => "index" and return **23** end # if **24 25** @forum = Forum.new **26** end # method new **27 28** \# attempt to create a new forum with the parameters passed in **29** def create **30** @forum = Forum.new( params\[ :forum \] ) **31** @forum.administrator = session\[ :user \].name **32 33** if @forum.save # if save method was successful **34 35** redirect\_to :action => 'list'

**Fig. 24.32** | ForumsController implements CRUD functionality. (Part 1 of 2.)

verify :method => :post, :only => \[ :destroy, :create \], :redirect\_to => { :action => :list }

flash\[ :error \] = 'you must be logged in to complete this action'

flash\[ :notice \] = 'Forum was successfully created.'  

**982** Chapter 24 Ruby on Rails

Method index (line 8–11) redirects the client to the list method (lines 14–16), which obtains a list of forums from the database to be displayed on the page. The new

method (lines 19–26) checks whether the user has privileges to create a new forum. If not, lines 21–22 display an error and redirect the user to the index action. The hash called flash in line 21 is used to display messages in the view. Flash is a special type of session storage that is always automatically cleared after every request to the controller. If the user has privileges, line 25 creates a new instance of the forum object which is initialized with data from the user input.

The create method (lines 29–39) is similar to the scaffold code, but differs in that the administrator attribute of the forum being saved must be the name of the user who is logged in. Line 33 attempts to save the forum, and either renders a template if the method returns false (line 37), or redirects to the list method and updates the flash object if the method returns true (lines 34–35). The delete method (lines 42–50) sets up the dele- tion operation by finding all the forums created by the user currently logged in. Once the user picks a forum to delete in the view, the destroy method (lines 53–58) destroys the forum specified by the user (line 55) and re-displays the list (line 56).

**_List View_** Figure 24.33 is the template that is rendered by the list method from the Forum control- ler. \[_Note:_ We replaced the auto-generated list.rhtml from the scaffolding\]. This is also the template rendered by the index method. Line 10 uses the **link\_to** method to create a link with the name of the forum and the list action of its messages, which we build in Section 24.6.5.. Lines 12–13 contain a conditional statement which make the forum ital- icized for five minutes after it has been created by using the minutes.ago method of the

**36** else # save was unsuccessful **37** render :action => 'new' # go to new **38** end # if...else **39** end # method create **40 41** \# set up the delete web page **42** def delete **43** if ( session\[ :user \] == nil ) # if user is not logged in **44** flash\[ :error \] = 'you must be logged in to complete this action' **45** redirect\_to :action => "index" and return **46** else **47 48 49** end # if else **50** end # method delete **51 52** \# delete a forum with a specified parameter **53** def destroy **54** \# find the forum and delete it **55** Forum.destroy( params\[ :forum \]\[ :id \] ) # delete the forum **56** redirect\_to :action => 'list' # redirect to list **57** end # method destroy **58** end # class ForumsController

**Fig. 24.32** | ForumsController implements CRUD functionality. (Part 2 of 2.)

@forums = Forum.find( :all, :conditions => "administrator = '#{ session\[:user\].name }'" )  

24.6 Case Study: Message Forum **983**

Fixnum class. The if statement in lines 17–24 displays the XHTML in lines 19–23 only if there is a user logged in.

**_New View_** Figure 24.34 shows the template for the Forum controller’s new method. This is code gen- erated by the scaffold. Lines 4–7 create a form that is rendered to the page, and indicate

**1** <!-- Fig. 24.33: app/views/forums/list.rhtml --> **2** <!-- Template for the list action that displays a list of forums. --> **3** <h1>Deitel Message Forums</h1> **4** <h2>Available Forums</h2> **5** <ul> **6** <% for forum in @forums %> **7** <!-- create a list item for every forum --> **8** <li> **9** <!-- link to list action in messages -->

**10** <%= link\_to ( forum.name, {:controller => 'messages', **11** :action => 'list', :forum\_id => forum.id}, **12** { :class => (forum.created\_on < 5.minutes.ago ? **13** 'recent': nil ) } ) %> **14** </li> **15** <% end %> <!-- end for --> **16** </ul> **17** <% if ( session\[ :user \] ) then %> **18** <!-- a user is logged in --> **19** <h2>Forum Management</h2> **20** <ul> **21** <li><%= link\_to 'Add a Forum', :action => 'new' %></li> **22** <li><%= link\_to 'Delete a Forum', :action => 'delete' %></li> **23** </ul> **24** <% end %> <!-- end if -->

**Fig. 24.33** | Template for the list action that displays a list of forums.  

**984** Chapter 24 Ruby on Rails

that the action create will be called when the **Create** button is pressed. This template ren- ders a **partial**—a block of HTML and embedded Ruby code stored in another file and in- serted directly into the document. A partial allows the same block of code to be used across multiple documents. In this example, line 5 renders the partial named form, which inserts the file \_form.rhtml at that line of code. A partial filename always begins with an under- score.

Line 6 uses the submit\_tag method to create a submit button that when clicked will create a Hash with the form’s fields as keys and the user’s input as values. Line 9 uses the link\_to function to allow the user to go back to the forums list by redirecting the client to the list action of the forum controller.

The partial in Fig. 24.35 renders the input text field for the form. The administrator and created\_on fields will be generated on the server, so they’ve been deleted from the scaffold’s code. The created\_on field will be automatically set to the time when the forum is created. The administrator field will be set by the controller.

**1** <!-- Fig. 24.34 app/views/forums/new.rhtml --> **2** <!-- Template for a new action that adds a forum to the forums table. --> **3** <h1>New forum</h1> **4** <% form\_tag :action => 'create' do %> **5** <%= render :partial => 'form' %> **6** <%= submit\_tag "Create" %> **7** <% end %> **8 9** <%= link\_to 'Back', :action => 'list' %>

**Fig. 24.34** | Template for a new action that adds a forum to the forums table.

**1** <!-- Fig. 24.35: app/views/forums/\_form.rhtml --> **2** <!-- Partial that contains a form used to add a new forum. --> **3 4** <p><label for="forum\_name">Name</label><br/> **5** <%= text\_field 'forum', 'name' %></p>

**Fig. 24.35** | Partial that contains a form used to add a new forum.

<%= error\_messages\_for 'forum' %>  

24.6 Case Study: Message Forum **985**

**_Delete View_** The delete view (Fig. 24.36) is not generated by the scaffold, so we create it ourselves. It is similar to create in that it renders a form, but uses the collection\_select method to display for that administrator the list of available forums to delete. The **collection\_select** takes five parameters—the type of object to be selected, the field which the options are to be grouped by, the collection from that to obtain the list of ob- jects, the field that will be sent once an option is selected and the field that is to be dis- played on the screen for each option.

**_Forum Layout_** Figure 24.37 is the layout that renders every template for the ForumsController. It has all the necessary XHTML, and contains the login/logout text (lines 13–25). Line 29 auto- matically renders the template of any action that uses the template.

**1** <!-- Fig. 24.36: app/views/forums/delete.rhtml --> **2** <!-- Template for delete action used to delete a Forum. --> **3** <h1>Delete a Forum</h1><br /> **4 5** <% form\_tag :action => :destroy do %> <!-- create from tag --> **6** <p><label for="forum\_id">Forum Name</label><br /> **7** </p> **8** <%= submit\_tag "Delete" %> <!-- create submit tag --> **9** <% end %> <!-- create end form tag -->

**10 11** <%= link\_to 'Back', :action => 'list' %> <!-- link back to list method -->

**Fig. 24.36** | Template for Delete action used to delete a forum.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.37: app/views/layouts/forums.rhtml --> **6** <!-- Layout that displays the logged-in user for every Forums action. -->

**Fig. 24.37** | Layout that displays the logged-in user for every Forums action. (Part 1 of 2.)

<%= collection\_select "forum", "id", @forums, "id", "name" %>  

**986** Chapter 24 Ruby on Rails

If the user is logged in (line 14), lines 16–18 display the username on the page and use the link\_to method to enable the user to log out by redirecting to the logout action. Otherwise, lines 21–23 allow the user to log in, using the link\_to helper method to redi- rect the user to the admin action. Lines 26–27 display any error messages or success mes- sages that result from user interactions.

**24.6.5 Message Controller and Message Views** The MessagesController (Fig. 24.38) is similar to the ForumsController, except that its list method (lines 8–22) doesn’t list all of the messages—it lists only the ones with the specified forum\_id that is passed in as a URL parameter from the Forum list view. Line 10 updates the session variable to match the URL parameter. If no parameter value is specified, the forum\_id session variable is used. If neither of these exists, line 14 displays an error and line 15 redirects the client to the list action of the forum controller. The find method which is called on Message (line 18–19) specifies that the messages should be ordered by their created\_on dates in descending order. Line 20 also calls the find

method to obtain the forum object, which we will need to add messages to the forum. The create method (lines 30–40) replaces the method generated by the scaffold. Line

31 obtains the id of the forum to which the message should be added and line 32 obtains the new message entered by the user. If the message is added to the database successfully, lines 35–36 set the appropriate message to be displayed in the view using the flash object and redirect the client to the list action. Otherwise, line 38 redirects the client to the new action, prompting the user to enter the message again.

**7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Forums: <%= controller.action\_name %></title>

**10** <%= stylesheet\_link\_tag 'scaffold' %> <!-- link to a stylesheet --> **11** </head> **12** <body> **13** <div style = "text-align: right"> **14** <% if ( session\[ :user \] ) then %> <!-- if user is logged on --> **15** <!-- code to display if user is logged on --> **16** <%= "Logged In As #{ session\[ :user \].name }: " %> **17** <%= link\_to 'Log Out', **18** :controller => 'users', :action => 'logout' %> **19** <% else %> <!-- user is not logged on --> **20** <!-- code to display if user is not logged on --> **21** <%= "Not Currently Logged In:" %> **22 23 24** <% end %> <!-- end if --> **25** </div> **26** <p style="color: green"><%= flash\[ :notice \] %></p> **27** <p style="color: red"><%= flash\[ :error \] %></p> **28 29** <%= yield %> <!-- displays template --> **30** </body> **31** </html>

**Fig. 24.37** | Layout that displays the logged-in user for every Forums action. (Part 2 of 2.)

<%= link\_to 'Log In', :controller => 'users', :action => 'admin' %>  

24.6 Case Study: Message Forum **987**

**_List View_** The list view (Fig. 24.39) for the Message controller is similar to the list view for the Forum controller, except that more information is displayed in the messages list view. It uses CSS to format the output. In this view, every message object acts like a Hash—passing a column name as a key returns the corresponding value in the message object. To obtain an a column’s value, include the attribute method’s name in square brackets after the name of the object. For each message in the forum, line 12 displays the title, line 13 displays the author and line 19 displays the message’s text. At line 14, the Ruby Time object that is re- turned by the message\[’created on’\] is formatted using the Ruby Time class formatting

**1** \# Fig. 24.38: app/controllers/messages\_controller.rb **2** \# MessagesController that implements CRUD functionality. **3** class MessagesController < ApplicationController **4** verify :method => :post, :only => \[ :destroy, :create \], **5** :redirect\_to => { :action => :list } **6 7** \# sets up the list web page that lists all messages **8** def list **9** if ( params\[ :forum\_id \] ) # if parameter forum\_id is provided

**10** session\[ :forum\_id \] = params\[ :forum\_id \] **11** end # if **12 13** if ( session\[ :forum\_id \] == nil ) # if no forum\_id is provided **14** flash\[ :notice \] = 'there has been an error.' **15** redirect\_to :controller => "forums", :action => "list" and return **16** end # if **17 18** @messages = Message.find( :all, :order => "created\_on desc", **19** :conditions => "forum\_id = #{ session\[:forum\_id \] }" ) **20** @forum = Forum.find( :first, **21** :conditions => "id = #{ session\[ :forum\_id \] }" ) **22** end # method list **23 24** \# sets up the new web page that creates a message **25** def new **26** @message = Message.new **27** end # method new **28 29** \# attempts to create a new message with the parameters passed in **30** def create **31** @message = Message.new( params\[ :message \] ) **32** @message.forum\_id = session\[ :forum\_id \] **33 34** if @message.save # if save method was successful **35** flash\[ :notice \] = 'Message was successfully created.' **36** redirect\_to :action => 'list' **37** else # save was unsuccessful **38** render :action => 'new' **39** end # if **40** end # method create **41** end # class MessagesController

**Fig. 24.38** | MessagesController that implements CRUD functionality.  

**988** Chapter 24 Ruby on Rails

options. Lines 24–26 use the link\_to method to allow the user to create a message in the current forum or to go back to the list of the forums.

**_New View_** The new template for the Message controller is omitted here because it is scaffold code that is nearly identical to the new template for the Forum controller. The partial shown in Fig. 24.40 for the messages form is also similar. Lines 8, 12 and 16 use the text\_field

helper method to create fields for specifying the title, author and email. Line 20 uses the text\_area helper method to create an input area of a certain size, to be used to input the message. These fields are validated when the Message model’s save method is called. If the model does not deem the data valid, line 3 displays the error messages.

**1** <!-- Fig. 24.39: app/views/messages/list.rhtml --> **2** <!-- Template for the list action that displays a list of Forums. --> **3** <div style = "text-align: center"> **4** <table style = "width: 600px; margin: 0 auto 0 auto"> **5** <tr class="msgHeader"> **6** <td><%= @forum.name %></td> **7** </tr> **8** <% for message in @messages %> **9** <!-- create two table rows for every message -->

**10** <tr class="msgTitle"> **11** <td> **12** <strong><%= message\[ 'title' \] %></strong><br /> **13** by <em><%= message\[ 'author' \] %></em> at **14 15** </td> **16** </tr> **17** <tr class="msgPost"> **18** <!-- message content --> **19** <td><%= message\[ 'message' \] %></td> **20** </tr> **21** <% end %> **22** </table> **23 24** <%= link\_to 'New message', :action => 'new' %> | **25** <%= link\_to 'list forums', **26** :controller => 'forums', :action => 'index' %> **27** </div>

**Fig. 24.39** | Template for the list action that displays a list of messages.

<%= message\[ 'created\_on' \].strftime("%m/%d/%Y at %I:%M%p") %>  

24.6 Case Study: Message Forum **989**

**_Message Layout_** Figure 24.41 shows the layout used to render all Message templates. Line 10 invokes the scaffold.css style sheet, which we changed slightly to improve our page’s presentation. To make the style sheet available for import it must be placed in the public/stylesheets directory of the application. When a forum has been modified, line 14 displays the appro- priate message.

**1** <!-- Fig. 24.40: app/views/messages/\_form.rhtml --> **2** <!-- A form that allows the user to enter a new message. --> **3** <%= error\_messages\_for 'message' %> **4 5** <table> **6** <tr class = "alignRight"> **7** <td>Title</td> **8** <td><%= text\_field 'message', 'title' %></td> **9** </tr>

**10** <tr class = "alignRight"> **11** <td>Author</td> **12** <td><%= text\_field 'message', 'author' %></td> **13** </tr> **14** <tr class = "alignRight"> **15** <td>Email</td> **16** <td><%= text\_field 'message', 'email' %></td> **17** </tr> **18** <tr><td colspan = "2">Message</td></tr> **19** <tr><td colspan = "2"> **20 21** </td></tr> **22** </table>

**Fig. 24.40** | Form that allows the user to enter a new message.

<%= text\_area 'message', 'message', :cols => "30", :rows => "4"%>  

**990** Chapter 24 Ruby on Rails

We have now implemented the basic functionality of the forum application. To test this application execute it on Mongrel and browse to http://localhost:3000/forums. To test the administrative privileges of the forum go to http://localhost:3000/user/

admin and login with the username user1 and password 54321. In the next section we’ll add Ajax capabilities to make our forum more responsive.

**24.6.6 Ajax-Enabled Rails Applications** Adding Ajax functionality to Rails applications is straightforward. Rails includes a Java- Script library called Prototype that contains easy-to-use cross-browser Ajax functions. Figure 24.42 is the modified layout for the forum file, which now links the prototype li- brary to the application. For the application to have the correct look, make sure you insert the modified style sheet, which can be found in our examples folder, into the public/

stylesheets directory of the application.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.41: app/views/layouts/messages.rhtml --> **6** <!-- Message layout that links a style sheet and displays a message. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Messages: <%= controller.action\_name %></title>

**10 11** </head> **12** <body> **13** <% if ( flash\[ :notice \] ) then %> **14** <p style="color: green"><%= flash\[ :notice \] %></p> **15** <% end %> **16** <%= yield %> **17** </body> **18** </html>

**Fig. 24.41** | Message layout that links a style sheet and displays a message.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.42: app/views/layouts/forums.rhtml --> **6** <!-- Forums layout that uses the default JavaScript libraries. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Forums: <%= controller.action\_name %></title>

**10** <%= stylesheet\_link\_tag 'scaffold' %> <!-- link to a stylesheet --> **11 12** </head> **13** <body>

**Fig. 24.42** | Forums layout that uses the default JavaScript libraries. (Part 1 of 2.)

<%= stylesheet\_link\_tag 'scaffold' %>

<%= javascript\_include\_tag :defaults %>  

24.6 Case Study: Message Forum **991**

Line 11 links in the JavaScript library using the **javascript\_include\_tag** helper method. The defaults parameter tells javascript\_include\_tag to link all the defaults

JavaScript Rails libraries including Prototype and Script.aculo.us. The rest of the layout file is the same as in the non-Ajax version.

Figure 24.43 changes the Forum object’s list view to perform Ajax requests rather than load a new page. Now, whenever the user clicks a forum’s name, the page loads the forum’s messages to the right of the forums list with a partial page update.

**14** <div style = "text-align: right"> **15** <% if ( session\[ :user \] ) then %> <!-- if user is logged on --> **16** <!-- code to display if user is logged on --> **17** <%= "Logged In As #{ session\[ :user \].name }: " %> **18** <%= link\_to 'Log Out', **19** :controller => 'users', :action => 'logout' %> **20** <% else %> <!-- user is not logged on --> **21** <!-- code to display if user is not logged on --> **22** <%= "Not Currently Logged In:" %> **23** <%= link\_to 'Log In', **24** :controller => 'users', :action => 'admin' %> **25** <% end %> <!-- end if --> **26** </div> **27** <p style="color: green"><%= flash\[ :notice \] %></p> **28** <p style="color: red"><%= flash\[ :error \] %></p> **29 30** <%= yield %> <!-- displays template --> **31** </body> **32** </html>

**1** <!-- Fig. 24.43: app/views/forums/list.rhtml --> **2** <!-- Displaying a list of messages without reloading the page. --> **3** <h1>Deitel Message Forums</h1> **4** <div class = "forumList"> **5** <h2>Available Forums</h2> **6** <ul> **7** <% for forum in @forums %> **8** <li> **9**

**10 11 12 13 14 15** </li> **16** <% end %> **17** </ul> **18** <% if ( session\[ :user \] ) then %> **19** <h2>Forum Management</h2> **20** <ul>

**Fig. 24.43** | Displaying a list of messages without reloading the page. (Part 1 of 2.)

**Fig. 24.42** | Forums layout that uses the default JavaScript libraries. (Part 2 of 2.)

<%= link\_to\_remote ( forum.name, { :url => { :controller => 'messages', :action => 'list', :forum\_id => forum.id }, :update => 'currentForum' }, { :class => ( forum.created\_on < 5.minutes.ago ? 'recent': nil ) } ) %>  

**992** Chapter 24 Ruby on Rails

The key change is lines 9–12, which have been changed to call the link\_to\_remote

helper method instead of the link\_to helper method. The link\_to\_remote method allows us to link to JavaScript that we included in the layout file. By specifying the url and update parameters inside the link\_to\_remote method we are telling Rails to convert these tags into **prototype Ajax.Updater objects** that will update the page asynchronously. The url argument (line 10) specifies the controller in which to look for the action. The action parameter (line 11) specifies the action to invoke. The forum\_id parameter (line 11) specifies the id to pass to the action. Line 12 specifies currentForum as the id of the placeholder div in the page that needs to be updated. Lines 26–27 define the placeholder div element where the list of messages will be inserted. The rest of the code is the same as in the non-Ajax version of this application.

In similar fashion, we modify the list and new views of the message object, to be able to add a message to a forum without reloading the page. First we include all the default JavaScript libraries in the message.rhtml layout file (not shown here), ensuring all the views in the message object have access to Prototype. After that we modify all the calls to other actions to be asynchronous. Figure 24.44 is the updated list.rhtml.

**21** <li><%= link\_to 'Add a Forum', :action => 'new' %></li> **22** <li><%= link\_to 'Delete a Forum', :action => 'delete' %></li> **23** </ul> **24** <% end %> **25** </div> **26 27**

**1** <!-- Fig. 24.44: app/views/messages/list.rhtml --> **2** <!-- Forum that allows the user to add a message on the same page. --> **3** <div class = "messageList"> **4** <table style = "width: 400"> **5** <tr class="msgHeader">

**Fig. 24.44** | Forum that allows the user to add a message on the same page. (Part 1 of 2.)

**Fig. 24.43** | Displaying a list of messages without reloading the page. (Part 2 of 2.)

<div id = 'currentForum' class = "ajaxComponent"> </div>  

24.6 Case Study: Message Forum **993**

**6** <td><%= @forum.name %></td> **7** </tr> **8** <% for message in @messages %> **9** <tr class="msgTitle">

**10** <td> **11** <strong><%= message.title %></strong><br/> **12** by <em><%= message.author %></em> at **13** <%= message.created\_on.strftime( "%m/%d/%Y at %I:%M%p" ) %> **14** </td> **15** </tr> **16** <tr class="msgPost"> **17** <td><%= message.message %></td> **18** </tr> **19** <% end %> **20** </table> **21 22 23 24 25** </div>

**Fig. 24.44** | Forum that allows the user to add a message on the same page. (Part 2 of 2.)

<%= link\_to\_remote 'New message', :url => { :action => 'new' }, :update => 'currentForum'%>  

**994** Chapter 24 Ruby on Rails

Lines 22–24 use the link\_to\_remote helper method to allow the user to add new messages without reloading the page. The url is the new action, which returns the form and the placeholder to update is currentForum, defined in the list.rhtml view of the forum object (Fig. 24.43). The new view is also modified, so that once the user submits the new message, the updated div named currentForum is shown without reloading the page. Figure 24.45 shows the modified new.rhtml.

Lines 3–7 have been changed to use the **form\_remote\_tag** helper method, which redirects the client to the next action without reloading the page. Once the user clicks the **Submit** button, generated by submit\_tag (line 6), the form will generate a Prototype Ajax.Updater object that will send the data to the action specified and display the result in the specified placeholder. This placeholder is set to currentForum, the same element inside which this forum will be displayed. When the user finishes adding the new message, a new forum will replace this form, without reloading the page. Lines 8–9 provide the user a way to cancel the new-message operation, in which case the original forum displays.

**1** <!-- Fig. 24.45: app/views/messages/new.rhtml --> **2** <!-- Allows the user to add a new message without reloading the page. --> **3 4 5** <%= render :partial => 'form' %> **6** <%= submit\_tag "Create" %> **7** <%= end\_form\_tag %> **8 9**

**Fig. 24.45** | Adding a new message without reloading the page. (Part 1 of 2.)

<%= form\_remote\_tag :url=> { :action => 'create' }, :update => 'currentForum' %>

<%= link\_to\_remote 'Cancel', :url=> { :action => 'list' }, :update => 'currentForum' %>  

24.7 Script.aculo.us **995**

**24.7 Script.aculo.us _Visual Effects_** Rails includes the **Script.aculo.us JavaScript library**, which allows you to easily create vi- sual effects similar to those in Adobe Flash and Microsoft Silverlight. The library provides many pre-defined effects, as well as the ability to create your own effects from the pre- defined ones. The following example demonstrates many of the effects provided by this library. Figure 24.46 demonstrates the Fade effect. When the user clicks the link above the

**Fig. 24.46** | Script.aculo.us’s Fade effect.

**Fig. 24.45** | Adding a new message without reloading the page. (Part 2 of 2.)  

**996** Chapter 24 Ruby on Rails

image, the effect named in the link will be applied to the image. Once you start the appli- cation with Mongrel, open http://localhost:3000/scriptaculous\_demo/ in your web browser.

To create this application, first type rails scriptaculous\_demo in the Ruby console. Next, create the controller by executing

ruby script/generate controller ScriptaculousDemo

In app/controllers/scriptaculous\_demo\_controller.rb (Fig. 24.47), add the index

method. This method sets to 0 the currentEffect instance variable, which keeps track of which effect the application is currently playing. Next, add the PlayEffect method (lines 4–6), which will be called when the user clicks to show the next effect.

Now, create application.rhtml (Fig. 24.48) in app/view/layouts. This acts as the default layout. Content from render :partial commands replaces line 13.

Next, create index.rhtml (Fig. 24.49) in app/views/scriptaculous\_demo. This is the application’s default view. The "link" div (lines 3–8) contains a link\_to\_remote

(lines 4–7) that initially is labeled 'Shrink', calls playEffect with a effect\_index

parameter of 0, updates itself and plays an effect on the before event. The effect is created using the visual\_effect method (lines 6–7). The parameters of this method call are the effect name, the name of the element the effect should apply to, the duration and the loca-

**1** <!-- Fig. 24.47: app/views/scriptaculous\_demo/index.rhtml --> **2** <!-- Default view for Script.aculo.us demo. --> **3** <div id = "link"> **4 5 6 7 8** </div> **9**

**10** <div id = "image" style = "width: 244px; height: 320px;"> **11** <%= image\_tag "jhtp7medium.jpg" %> **12** </div>

**Fig. 24.47** | Default view for Script.aculo.us demo.

**1** \# Fig. 24.48: app/controllers/scriptaculous\_demo\_controller.rb **2** \# Script.aculo.us Demo controller **3** class ScriptaculousDemoController < ApplicationController **4** def index **5** @currentEffect = 0 **6** end **7** def playEffect **8** @currentEffect = params\[ :effect\_index \] **9** render :partial => "link"

**10** end # method playEffect **11** end # class ScriptaculousDemoController

**Fig. 24.48** | Script.aculo.us Demo controller.

<%= link\_to\_remote 'Shrink', :url => {:action => 'playEffect', :effect\_index => 0}, :update => "link", :before => visual\_effect(

:Shrink, 'image', :duration => 1.0, :queue => 'end') %>  

24.7 Script.aculo.us **997**

tion in the queue. The queue is set to end so that any new effects will be played after all the others are complete. The image in line 11 must be in the public/images directory.

The playEffect method (lines 7–10, Fig. 24.47) sets the currentEffect instance variable to the effect\_index parameter, then renders the link view in the link div. In app/views/scriptaculous\_demo/\_link.rhtml (Fig. 24.50), the application demon- strates several Script.aculo.us effects by using nested if statements to check the current-

Effect, apply it, then increment currentEffect after each effect with the effect\_index

parameter. The link text corresponds to the name of the effect the link activates.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.49: app/views/layouts/application.rhtml --> **6** <!-- Default layout of Script.aculo.us demo. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Script.aculo.us Effects Demo</title>

**10** <%= javascript\_include\_tag :defaults %> **11** </head> **12** <body> **13** <%= yield %> **14** </body> **15** </html>

**Fig. 24.49** | Default layout of Script.aculo.us demo.

**1** <!-- Fig. 24.50: app/views/scriptaculous\_demo/\_link.rhtml --> **2** <!-- link partial view for Script.aculo.us demo --> **3** <!-- Grow effect --> **4** <% if @currentEffect == '0' %> **5** <%= link\_to\_remote 'Grow', :url => { :action => 'playEffect', **6** :effect\_index => 1 }, :update => "link", **7** :before => ( visual\_effect( **8** :Grow, 'image', :duration => 1.0, :queue => 'end' ) ) %> **9**

**10** <!-- Fade effect --> **11** <% elsif @currentEffect == '1' %> **12** <%= link\_to\_remote 'Fade', :url => { :action => 'playEffect', **13** :effect\_index => 2 }, :update => "link", **14** :before => ( visual\_effect( **15** :Fade, 'image', :duration => 1.0, :queue => 'end' ) ) %> **16 17** <!-- Appear effect --> **18** <% elsif @currentEffect == '2' %> **19** <%= link\_to\_remote 'Appear', :url => {:action => 'playEffect', **20** :effect\_index => 3 }, :update => "link", **21** :before => ( visual\_effect( **22** :Appear, 'image', :duration => 1.0, :queue => 'end' ) ) %>

**Fig. 24.50** | link partial view for Script.aculo.us demo. (Part 1 of 3.)  

**998** Chapter 24 Ruby on Rails

**23 24** <!-- BlindUp effect --> **25** <% elsif @currentEffect == '3' %> **26** <%= link\_to\_remote 'BlindUp', :url => { :action => 'playEffect', **27** :effect\_index => 4 }, :update => "link", **28** :before => ( visual\_effect( **29** :BlindUp, 'image', :duration => 1.0, :queue => 'end' ) ) %> **30 31** <!-- BlindDown effect --> **32** <% elsif @currentEffect == '4' %> **33** <%= link\_to\_remote 'BlindDown', :url => { :action => 'playEffect', **34** :effect\_index => 5 }, :update => "link", **35** :before => ( visual\_effect( **36** :BlindDown, 'image', :duration => 1.0, :queue => 'end' ) ) %> **37 38** <!-- Puff effect --> **39** <% elsif @currentEffect == '5' %> **40** <%= link\_to\_remote 'Puff', :url => { :action => 'playEffect', **41** :effect\_index => 6 }, :update => "link", **42** :before => ( visual\_effect( **43** :Puff, 'image', :duration => 1.0, :queue => 'end' ) ) %> **44 45** <!-- SwitchOff effect --> **46** <% elsif @currentEffect == '6' %> **47** <%= link\_to\_remote 'SwitchOff', :url => { :action => 'playEffect', **48** :effect\_index => 7 }, :update => "link", **49** :before => ( visual\_effect( **50** :SwitchOff, 'image', :duration => 1.0, :queue => 'end' ) ) %> **51 52** <!-- SlideUp effect --> **53** <% elsif @currentEffect == '7' %> **54** <%= link\_to\_remote 'SlideUp', :url => { :action => 'playEffect', **55** :effect\_index => 8 }, :update => "link", **56** :before => ( visual\_effect( **57** :SlideUp, 'image', :duration => 1.0, :queue => 'end' ) ) %> **58 59** <!-- SlideDown effect --> **60** <% elsif @currentEffect == '8' %> **61** <%= link\_to\_remote 'SlideDown', :url => { :action => 'playEffect', **62** :effect\_index => 9 }, :update => "link", **63** :before => ( visual\_effect( **64** :SlideDown, 'image', :duration => 1.0, :queue => 'end' ) ) %> **65 66** <!-- Shake effect --> **67** <% elsif @currentEffect == '9' %> **68** <%= link\_to\_remote 'Shake', :url => { :action => 'playEffect', **69** :effect\_index => 10 }, :update => "link", **70** :before => ( visual\_effect( **71** :Shake, 'image', :duration => 1.0, :queue => 'end' ) ) %> **72 73** <!-- Pulsate effect --> **74** <% elsif @currentEffect == '10' %> **75** <%= link\_to\_remote 'Pulsate', :url => { :action => 'playEffect',

**Fig. 24.50** | link partial view for Script.aculo.us demo. (Part 2 of 3.)  

24.7 Script.aculo.us **999**

**76** :effect\_index => 11 }, :update => "link", **77** :before => ( visual\_effect( **78** :Pulsate, 'image', :duration => 1.0, :queue => 'end' ) ) %> **79 80** <!-- Squish effect --> **81** <% elsif @currentEffect == '11' %> **82** <%= link\_to\_remote 'Squish', :url => { :action => 'playEffect', **83** :effect\_index => 12 }, :update => "link", **84** :before => ( visual\_effect( **85** :Squish, 'image', :duration => 1.0, :queue => 'end' ) ) %> **86 87** <!-- Grow effect --> **88** <% elsif @currentEffect == '12' %> **89** <%= link\_to\_remote 'Grow', :url => { :action => 'playEffect', **90** :effect\_index => 13 }, :update => "link", **91** :before => ( visual\_effect( **92** :Grow, 'image', :duration => 1.0, :queue => 'end' ) ) %> **93 94** <!-- Fold effect --> **95** <% elsif @currentEffect == '13' %> **96** <%= link\_to\_remote 'Fold', :url => { :action => 'playEffect', **97** :effect\_index => 14 }, :update => "link", **98** :before => ( visual\_effect( **99** :Fold, 'image', :duration => 1.0, :queue => 'end' ) ) %> **100 101** <!-- Grow effect --> **102** <% elsif @currentEffect == '14' %> **103** <%= link\_to\_remote 'Grow', :url => { :action => 'playEffect', **104** :effect\_index => 15 }, :update => "link", **105** :before => ( visual\_effect( **106** :Grow, 'image', :duration => 1.0, :queue => 'end' ) ) %> **107 108** <!-- DropOut effect --> **109** <% elsif @currentEffect == '15' %> **110** <%= link\_to\_remote 'DropOut', :url => { :action => 'playEffect', **111** :effect\_index => 16 }, :update => "link", **112** :before => ( visual\_effect( **113** :DropOut, 'image', :duration => 1.0, :queue => 'end' ) ) %> **114 115** <!-- Grow effect --> **116** <% elsif @currentEffect == '16' %> **117** <%= link\_to\_remote 'Grow', :url => { :action => 'playEffect', **118** :effect\_index => 17 }, :update => "link", **119** :before => ( visual\_effect( **120** :Grow, 'image', :duration => 1.0, :queue => 'end' ) ) %> **121 122** <!-- Shrink effect --> **123** <% elsif @currentEffect == '17' %> **124** <%= link\_to\_remote 'Shrink', :url => { :action => 'playEffect', **125** :effect\_index => 0 }, :update => "link", **126** :before => ( visual\_effect( **127** :Shrink, 'image', :duration => 1.0, :queue => 'end' ) ) %> **128** <% end %>

**Fig. 24.50** | link partial view for Script.aculo.us demo. (Part 3 of 3.)  

**1000** Chapter 24 Ruby on Rails

**_Other Script.aculo.us Features_** The Script.aculo.us library also brings other features to Rails. It provides drag-and-drop capability through the draggable\_element and drop\_receiving\_element methods. A live example of this can be found at demo.script.aculo.us/shop.

Script.aculo.us also provides the sortable\_element method which allows you to describe a list that allows the user to drag and drop list items to reorder them. A live example of this can be found at demo.script.aculo.us/ajax/sortable\_elements.

Another intereresting capability is the text\_field\_with\_auto\_complete method, which enables server-side auto completion of a text field. A live example of this can be found at demo.script.aculo.us/ajax/autocompleter.

**_Flickr Photo Viewer with Effects_** The Script.aculo.us library’s effects are useful for adding a desktop-like feel to a web page. In the following example (Fig. 24.51), the user can search for photos with specific tags and can specify the number of images for each search to return. The application uses the Script.aculo.us sliding effect to show when the thumbnails for the specified tags have fin- ished loading from Flickr. The application also uses the grow effect when the user clicks an image to display the full-size version of the image.

After creating the FlickrPhotoViewer application, you must install the Flickr library for Ruby. This library can be installed by executing gem install flickr in the Ruby con- sole. More information about this library is available at redgreenblu.com/flickr/. Once

**Fig. 24.51** | Flickr Photo Viewer showing search results for **bugs**.  

24.7 Script.aculo.us **1001**

installed, you must configure the library to use your own Flickr API key. You can sign up for a free API key at www.flickr.com/services/api/misc.api\_keys.html. Once you receive your API key, you _must_ replace the key in flickr.rb with your own. If you are using Instant Rails, flickr.rb will be located in the Instant Rails directory, in the folder If you are running Mac OS X, or otherwise have installed Ruby system-wide, this file will be harder to find. If you cannot locate it with a normal search in Mac OS X, open **Terminal** and use find / -name flickr.rb to locate it. The API key to replace should be located at line 57, in the initialize method. Finally, you must tell the application to include the Flickr library by adding require 'flickr' to the end of config/environment.rb.

Create the controller with ruby script/generate controller flickr. In app/

views/flickr/index.rhtml (Fig. 24.52), we create the application’s main view. Be sure to copy the flickrPhotoViewer.css file from this chapter’s folder into the public/

stylesheets/ directory. Lines 15–31 contain a form\_remote\_tag element that imple- ments the application’s photo tag search functionality. Line 17 creates a BlindDown

visual\_effect for the thumbs div (line 32) when the search action is complete. Lines 18–19 create the corresponding BlindUp visual\_effect for the loading div (lines 28– 29). Lines 20–21 hide the loading div on failure and success events, respectively. The fullsizeImage div (line 33) will be populated later with an img element.

**1** <?xml version = "1.0" encoding = "utf-8"?> **2** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" **3** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> **4 5** <!-- Fig. 24.52: app/view/flickr/index.rhtml --> **6** <!-- Main view for Flickr Photo Viewer. --> **7** <html xmlns = "http://www.w3.org/1999/xhtml"> **8** <head> **9** <title>Flickr Photo Viewer</title>

**10** <%= javascript\_include\_tag :defaults %> **11** <%= stylesheet\_link\_tag 'flickrPhotoViewer' %> **12** </head> **13** <body> **14** <!-- Form to search for tags --> **15 16 17 18 19 20 21 22** <div id = "search"> **23** Tags: **24** <%= text\_field\_tag "tags" %> **25** #: **26** <%= text\_field\_tag "numImages", "8", :size => "3" %> **27** <%= submit\_tag "Search" %> **28** <div id = "loading" **29** style = "display: none">Loading...</div> **30** </div>

**Fig. 24.52** | Main view for Flickr Photo Viewer. (Part 1 of 2.)

<%= form\_remote\_tag :url => { :action => 'search' }, :update => 'thumbs', :complete => visual\_effect( :BlindDown, 'thumbs' ), :before => { visual\_effect( :BlindUp, 'thumbs' ),

%( Element.show( 'loading' ) ) }, :failure => %( Element.hide( 'loading' ) ), :success => %( Element.hide( 'loading' ) ) %>  

**1002** Chapter 24 Ruby on Rails

The controller located at app/controllers/flickr\_controller.rb (Fig. 24.53) handles the search action called by the form in line 15 of Fig. 24.52 and the fullsize-

Image action called by the link\_to\_remote in lines 3–9 of Fig. 24.54. In the search

method, line 6 creates the flickr object using the Flickr class we installed previously. Lines 7–9 use the flickr object to populate thumbs with photos, supplying as arguments the tags and numImages values from the corresponding text\_field\_tags in lines 24 and 26 of Fig. 24.52. The fullsizeImage method (lines 13–15) takes the imageURL param- eter’s value and uses it to set the currentURL variable.

The thumbs view (Fig. 24.54) defines each thumbnail as a link\_to\_remote with an image\_tag as the link’s contents. The source of the image is retrieved from the thumbs col- lection that was passed by line 8 of Fig. 24.53. The first index, 0, specifies the image size to be the smallest provided by Flickr. In lines 5–6 of Fig. 24.54, we specify that the url should

**31** <%= end\_form\_tag %> **32** <div id = "thumbs"></div> **33** <div id = "fullsizeImage"></div> **34** </body> **35** </html>

**1** \# Fig. 24.53: app/controllers/flickr\_controller.rb **2** \# Controller for Flickr Photo Viewer. **3** class FlickrController < ApplicationController **4** \# handle the search request **5** def search **6 7 8 9**

**10** end # method search **11 12** \# handle the thumbnail click, sets the currentURL variable **13** def fullsizeImage **14 15** end # method fullsizeImage **16** end # class FlickrController

**Fig. 24.53** | Controller for Flickr Photo Viewer.

**1** <!-- Fig. 24.54: app/views/flickr/\_thumbs.rhtml --> **2** <!-- thumbs view of Flickr Photo Viewer. --> **3 4 5 6 7 8 9**

**Fig. 24.54** | thumbs view of Flickr photo viewer.

**Fig. 24.52** | Main view for Flickr Photo Viewer. (Part 2 of 2.)

flickr = Flickr.new render :partial => "thumbs",

:collection => flickr.photos( :tags => params\[ :tags \], :per\_page => params\[ :numImages \] )

@currentURL = params\[ :imageURL \]

<%= link\_to\_remote image\_tag( thumbs.sizes\[ 0 \]\[ 'source' \], :class => "image" ),

:url => { :action => 'fullsizeImage', :imageURL => thumbs.sizes\[ 3 \]\[ 'source' \] },

:update => "fullsizeImage", :success => visual\_effect( :grow, 'fullsizeImage',

:queue => 'last' ) %>  

24.8 Wrap-Up **1003**

activate the fullsizeImage action and pass an imageURL parameter. This parameter is set to the source of the image’s large version. Lines 8–9 apply the grow visual\_effect to fullsizeImage.

The fullsizeImage view (Fig. 24.55) fills the fullsizeImage div in line 33 of Fig. 24.52 with an image\_tag. The source of this image is set to the currentURL variable. Try the program out with different tag searches and numbers of images.

**24.8 Wrap-Up** In this chapter, you first learned basic Ruby programming concepts, including classes, control structures, and data types such as Fixnum, String, Array and Hash. Next, you learned how to develop web applications using the Rails framework. You installed Instant Rails, an all-in-one environment for building and testing Rails applications. We then dis- cussed the MVC (Model-View-Controller) design pattern that is used by Rails applica- tions, and the many conventions that allow Rails to generate a significant amount of functionality for you. This included using the controller generator to create an applica- tion’s controller, using the scaffold generator to quickly generate a user interface to view and modify a database, and combining Ruby script and HTML into RHTML files that define an application’s view. You learned how to include rich AJAX functionality (such as partial page updates, advanced controls, and visual effects) in Rails applications through the use of the built-in Prototype and Script.aculo.us libraries. These libraries allow for Ajax functionality such as In the next chapter, we discuss how to build web applications using Microsoft’s ASP.NET 2.0.

**24.9 Web Resources** www.deitel.com/Ruby/ www.deitel.com/RubyOnRails/

The Deitel Ruby and Ruby on Rails Resource Centers contain links to some of the best Ruby and Rails resources on the web. There you’ll find categorized links to forums, conferences, blogs, books, open source projects, videos, podcasts, webcasts and more. Also check out the tutorials for all skill levels, from introductory to advanced.

**1** <!-- Fig. 24.55: app/views/flickr/fullsizeImage.rhtml --> **2** <!-- fullsizeImage view of Flickr Photo Viewer. --> **3**

**Fig. 24.55** | fullsizeImage view of Flickr Photo Viewer.

<%= image\_tag( @currentURL, :class => "image" ) %>

**Summary _Section 24.1 Introduction_** • Ruby on Rails (also known as RoR or just Rails) is a framework for developing data-driven web

applications.

• A web framework is a set of libraries and useful tool that can be used to build dynamic web ap- plications.  

**1004** Chapter 24 Ruby on Rails

• Ruby on Rails is different from most other programming languages because it takes advantage of many conventions to reduce development time. If you follow these conventions, the Rails frame- work generates substantial functionality and perform many tasks for you.

• Ruby on Rails has built-in libraries for performing common web development tasks, such as in- teracting with a database, sending mass e-mails to clients or generating web services.

• Rails has built-in libraries that provide Ajax functionality, improving the user experience. Rails is quickly becoming a popular environment for web development.

• Ruby on Rails was created by David Heinemeier Hansson of the company 37Signals.

**_Section 24.2 Ruby_** • The Ruby scripting language was developed by Yukihiro “Matz” Matsumoto in 1995 to be a flex-

ible, object-oriented scripting language.

• Ruby’s syntax and conventions are intuitive—they attempt to mimic the way a developer thinks. Ruby is an interpreted language.

• Instant Rails is a stand-alone Rails development and testing environment that includes Ruby, Rails, MySQL, Apache, PHP and other components necessary to create and run Rails applica- tions.

• If you are using Mac OS X, there is an application similar to Instant Rails called Locomotive.

• The method puts prints the text to the terminal, followed by a newline.

• A method can have parentheses surrounding its parameters, but this is not typical in Ruby unless they are used to avoid ambiguity.

• A line of Ruby code does not have to end with a semicolon, although one can be placed there.

• One way to run a Ruby script is to use the Ruby interpreter.

• IRB (Interactive Ruby) can be used to interpret Ruby code statement by statement.

• Ruby uses dynamic typing, which allows changes to a variable’s type at execution time.

• Everything is an object in Ruby, so you can call methods on any piece of data.

• Hash Objects are mapped to other Objects in key/value pairs.

• The exclamation point after a method name is a Ruby convention indicating that the object on which the method is called will be modified.

• Ruby has support for code blocks—groupings of Ruby statements that can be passed to a method as an argument.

• The initialize method acts like a constructor in other object-oriented languages—it is used to declare and initialize an object’s data.

• When each instance of a class maintains its own copy of a variable, the variable is known as an instance variable and is declared in Ruby using the @ symbol.

• Classes can also have class variables, declared using the @@ symbol, that are shared by all copies of a class.

• When an object is concatenated with a string, the object’s to\_s method is called to convert the object to its string representation.

**_Section 24.3 Rails Framework_** • While users have benefitted from the rise of database-driven web applications, web developers

have had to implement rich functionality with technology that was not designed for this purpose.

• The Rails framework combines the simplicity of development that has become associated with Ruby with the ability to rapidly develop database-driven web applications.  

Summary **1005**

• Ruby on Rails is built on the philosophy of convention over configuration—if you follow certain programming idioms, your applications will require little or no configuration and Rails will gen- erate substantial portions of the applications for you.

• The Model-View-Controller (MVC) architectural pattern separates application data (contained in the model) from graphical presentation components (the view) and input-processing logic (the controller).

• ActiveRecord is used to map a database table to an object.

• ActionView is a set of helper methods to modify user interfaces.

• ActionController is a set of helper methods to create controllers.

**_Section 24.4 ActionController and ActionView_** • Ruby on Rails has two classes, ActionController and ActionView, that work together to process

a client request and render a view.

• To generate a controller in Rails, you can use the built-in Controller generator by typing ruby

script/generate controller _name_.

• A Ruby on Rails application must be run from a web server

• Instant Rails comes with a built-in web server named Mongrel, which is easy to use to test Rails applications on the local machine.

• When generating output, a controller usually renders a template—an XHTML document with embedded Ruby that has the .rhtml filename extension.

• The request object contains the environment variables and other information for a web page.

• Erb (embedded Ruby) that is located between the <%= %> tags in rhtml files is parsed as Ruby code and formatted as text.

• A set of Ruby tags without an equals sign—<% %>—represents statements to execute as Ruby code but not formatted as text.

• Rails allows you to add headers and footers with a layout—a master view that is displayed by ev- ery method in a controller.

• A layout can generate a template for a specific method using yield.

**_Section 24.5 A Database-Driven Web Application_** • Rails makes extensive use of Object-Relational Mapping (ORM) that maps a database to appli-

cation objects.

• The objects that Rails uses to encapsulate a database inherit from ActiveRecord.

• One ActiveRecord convention is that every model that extends ActiveRecord::Base in an appli- cation represents a table in a database.

• By convention, the table that the model represents has a name which is the lowercase, pluralized form of the model’s name.

• Rails uses a generator to create the Employee model. You use a generator by typing ruby script/

server model employee in the **Ruby Console**, after navigating to your application directory**.**

• The ActiveRecord object has a special feature called Migration, which allows you to perform da- tabase operations within Rails.

• ActiveRecord has built-in functionality for many create, retrieve, update and destroy methods known in Rails as CRUD.

• We can execute the migration using Ruby’s rake command by typing in rake db:migrate, which will call the self.up method of all the migrations located in your db/migrate directory.  

**1006** Chapter 24 Ruby on Rails

• If you ever want to roll back the migrations, you can type in rake db:migrate VERSION=0, which calls each migration’s self.down method.

• The scaffold method is a powerful tool that automatically creates CRUD functionality. It creates methods such as new, edit and list so you don’t have to create them yourself.

**_Section 24.6 Case Study: Message Forum_** • Validators that will be called when the database is modified, can be applied to an object that in-

herits from ActiveRecord.

• The method validates\_presence\_of ensures that all the fields specified by its parameters are not empty.

• The method validates\_format\_of matches all the fields specified by its parameters with a regu- lar expression.

• The link\_to method is used to link to an action in the controller and pass arguments to it.

• A partial is a block of HTML and embedded Ruby code stored in another file and inserted di- rectly into the document.

• Rails includes a JavaScript library called Prototype that contains easy-to-use cross-browser Ajax functions.

• The javascript\_include\_tag helper method is used to link in JavaScript libraries.

• The link\_to\_remote method allows us to link to JavaScript that we included in the layout file.

• Specifying the url and update parameters inside the link\_to\_remote method tells Rails to con- vert these tags into prototype Ajax.Updater objects that will update the page asynchronously.

**_Section 24.7 Script.aculo.us._** • Script.aculo.us also provides the text\_field\_with\_auto\_complete method, which enables serv-

er-side autocompletion of a text field.

**Terminology** ActionController

ActionView

ActiveRecord

Ajax Apache ApplicationController

arrays association before\_create

before\_destroy

belongs\_to

class variable code block comments controller generator Convention over Configuration CRUD def

Don’t Repeat Yourself (DRY) draggable\_element method

drop\_recieving\_element method dynamic typing embedded Ruby (erb) end Errors Object escape sequence find\_all

Fixnum

Gem Hash

initialize instance variable Instant Rails IRB layout link\_to method link\_to\_remote method message forum Model-View-Controller Mongrel  

Self-Review Exercises **1007**

MySQL Object Relational Mapping partial password\_field method PHP Prototype JavaScript Library puts

relational integrity reset\_session

request object Rails RoR Ruby Ruby interpreter Ruby on Rails scaffold scaffold generator

Script.aculo.us JavaScript library session variable sortable\_element method String

template text\_field method text\_field\_with\_autocomplete method to\_s method validate

validates\_format\_of

validates\_presence\_of

validations verify web framework web server web services

**Self-Review Exercises 24.1** Fill in the blanks in each of the following statements:

a) is a stand-alone Rails development and testing environment for Windows. b) Ruby on Rails is built on the philosophy of . c) The architectural pattern separates application data from graphical presenta-

tion components and input processing. d) The objects that Rails uses to encapsulate a database inherit from class . e) A(n) is a master view that is displayed by every method in a controller. f) The method automatically creates CRUD functionality in Ruby on Rails. g) The helper method creates a link in HTML that calls a partial page update. h) The helper method calls effects from the Script.aculo.us library.

**24.2** State whether each of the following is _true_ or _false_. If _false_, explain why. a) Every line in Ruby must end with a semicolon. b) Rails is a programming language. c) Rails makes creating database-driven Internet applications easy. d) The name of the model must be the same as the name of the table that is associated with

it. e) By following Ruby on Rails naming conventions you can build a Rails application with

no configuration. f) Each controller in Ruby has one layout file which is rendered for every action of that

controller. g) Embedded Ruby located between the <% %> delimiters is evaluated and rendered on the

page. h) Rails implements Ajax functionality using the JavaScript Prototype library.

**Answers to Self-Review Exercises 24.1** a) Instant Rails. b) convention over configuration. c) Model-View-Controller. d) Active- Record. e) layout. f) scaffold method. g) link\_to\_remote. h) playEffect.

**24.2** a) False. A line of Ruby code does not have to end with a semicolon, although one can be placed there.  

**1008** Chapter 24 Ruby on Rails

b) False. Rails is a framework for internet applications built in the Ruby programming lan- guage.

c) True. d) False. The name of the table must be the plural version of the Model associated with it. e) True. f) True. g) False. The Ruby between the <% %> tags is evaluated but is _not_ rendered on the page.

Only the Ruby between the <%= %> tags is evaluated then rendered on the page. h) True.

**Exercises 24.3** Write a series of ActiveRecord::Migration scripts to set up the structure for a book catalog database. The book catalog should have two tables—Books and Authors. The Authors table should have fields containing the author ID (the primary key for the table) the first name and the last name. The Books table should have fields containing the book’s id (primary key for the table) the title, the author’s ID that corresponds to an id in the authors table, the most current edition number and the year the most current edition was released. The migration scripts should also add a few rows of data to both tables.

**24.4** Assume you have a book catalog database with tables Books and Authors. Write down the Ruby commands you would put in the **Command Prompt** to set up a structure for a Book Catalog application. Do not create your own directories or files—let the scripts do that for you. Both Books

and Authors should have a model, a view and a controller component associated with them. There should be a structure set up for CRUD functionality associated with them.

**24.5** Add code to the employee catalog example from Fig. 24.21 and 24.22 to make it a fully functional application. Make sure the user can add new employees, edit existing employees and de- lete existing employees.

**24.6** Modify the Forum case study to be completely Ajax enabled. Make the Create Forum and Delete Forum links open up on the same page instead of linking to a different page. You will have to modify the list.rhtml, new.rhtml and delete.rhtml files in the Forum section of the View direc- tory.

**24.7** Add Script.aculo.us effects to the Ajax version of the Forum example. Pick an effect and have it play when the Forum is selected or gets updated.

**24.8** Create an Address Book application like the one in Fig. 15.9. Enable the user to expand and contract, add and remove address-book entries.  

25 ASP.NET 2.0 and ASP.NET Ajax

**O B J E C T I V E S** In this chapter you will learn:

■ Web application development using Active Server Pages .NET (ASP.NET).

■ To create Web Forms.

■ To create ASP.NET applications consisting of multiple Web Forms.

■ To maintain state information about a user with session tracking and cookies.

■ To use the **Web Site Administration Tool** to modify web application configuration settings.

■ To control user access to web applications using forms authentication and ASP.NET login controls.

■ To use databases in ASP.NET applications.

■ To design a master page and content pages to create a uniform look-and-feel for a website.

**_If any man will draw up his case, and put his name at the foot of the first page, I will give him an immediate reply. Where he compels me to turn over the sheet, he must wait my leisure._ —Lord Sandwich**

**_Rule One: Our client is always right. Rule Two: If you think our client is wrong, see Rule One._ —Anonymous**

**_A fair question should be followed by a deed in silence._ —Dante Alighieri**

**_You will come here and get books that will open your eyes, and your ears, and your curiosity, and turn you inside out or outside in._ —Ralph Waldo Emerson**  

**1010** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax **O**

**u tl**

**in e**

**25.1 Introduction** This chapter introduces **web application development** with Microsoft’s **Active Server Pages .NET (ASP.NET) 2.0** technology. Web-based applications create web content for web-browser clients. This web content includes Extensible HyperText Markup Language (XHTML), client-side scripting, images and binary data. If you are not familiar with XHTML, you should read Chapter 4 before studying this chapter. \[_Note:_ This chapter as- sumes that you know Visual Basic and are familiar with the .NET platform version 2.0. To learn more about Visual Basic, check out _Visual Basic 2005 How to Program, Third Edi- tion_, or visit our Visual Basic Resource Center at www.deitel.com/visualbasic.\]

We present several examples that demonstrate web application development using **Web Forms**, **web controls** (also called **ASP.NET server controls**) and Visual Basic pro- gramming. We also introduce ASP.NET Ajax and use it to enhance one of the earlier exam- ples. Web Form files have the filename extension **.aspx** and contain the web page’s GUI. You customize Web Forms by adding web controls including labels, text boxes, images, buttons and other GUI components. The Web Form file generates the web page that is sent to the client browser. From this point onward, we refer to Web Form files as **ASPX files**.

**25.2** Creating and Running a Simple Web Form Example **25.2.1** Examining an ASPX File **25.2.2** Examining a Code-Behind File **25.2.3** Relationship Between an ASPX File and a Code-Behind File **25.2.4** How the Code in an ASP.NET Web Page Executes **25.2.5** Examining the XHTML Generated by an ASP.NET Application **25.2.6** Building an ASP.NET Web Application

**25.3** Web Controls **25.3.1** Text and Graphics Controls **25.3.2** AdRotator Control **25.3.3** Validation Controls

**25.4** Session Tracking **25.4.1** Cookies **25.4.2** Session Tracking with HttpSessionState

**25.5** Case Study: Connecting to a Database in ASP.NET **25.5.1** Building a Web Form That Displays Data from a Database **25.5.2** Modifying the Code-Behind File for the Guestbook Application

**25.6** Case Study: Secure Books Database Application **25.6.1** Examining the Completed Secure Books Database Application **25.6.2** Creating the Secure Books Database Application

**25.7** ASP.NET Ajax **25.8** Wrap-Up **25.9** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

25.2 Creating and Running a Simple Web Form Example **1011**

An ASPX file created in Visual Studio is implemented as a class written in a .NET language, such as Visual Basic. This class contains event handlers, initialization code, utility methods and other supporting code. The file that contains this class is called the **code-behind file** and provides the ASPX file’s programmatic implementation.

To develop the code and GUIs in this chapter, we used Microsoft Visual Web Devel- oper 2005 Express—an IDE designed for developing ASP.NET web applications. Visual Web Developer and Visual Basic 2005 Express share many common features and visual programming tools that simplify building complex applications, such as those that access a database (Sections 25.5–25.6). The full version of Visual Studio 2005 includes the func- tionality of Visual Web Developer, so the instructions we present for Visual Web Devel- oper also apply to Visual Studio 2005. Note that you must install either Visual Web Developer 2005 Express (available from msdn.microsoft.com/vstudio/express/vwd/

default.aspx) or a complete version of Visual Studio 2005 to implement the programs in this chapter.

**25.2 Creating and Running a Simple Web Form Example** Our first example displays the web server’s time of day in a browser window. When run, this program displays the text A Simple Web Form Example, followed by the web server’s time. As mentioned previously, the program consists of two related files—an ASPX file (Fig. 25.1) and a Visual Basic code-behind file (Fig. 25.2), which we’ll discuss in Section 25.2.5. We first display the markup, code and output, then we carefully guide you through the step-by-step process of creating this program. \[_Note:_ The markup in Fig. 25.1 and other ASPX file listings in this chapter is the same as the markup that appears in Visual Web Developer, but we’ve reformatted it for presentation purposes to make the code more readable.\]

Visual Web Developer generates all the markup shown in Fig. 25.1 when you set the web page’s title, type text in the Web Form, drag a Label onto the Web Form and set the properties of the page’s text and the Label. We discuss these steps in Section 25.2.6.

**1** <%-- Fig. 25.1: WebTime.aspx --%> **2** <%-- A page that displays the current time in a Label. --%> **3 4 5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head > **11** <title>A Simple Web Form Example</title> **12** </head> **13** <body> **14** <form id="form1" > **15** <div> **16** <h2> **17** Current time on the Web server:</h2>

**Fig. 25.1** | ASPX file that displays the web server’s time. (Part 1 of 2.)

<%@ Page Language="VB" AutoEventWireup="false" CodeFile="WebTime.aspx.vb" Inherits="WebTime" EnableSessionState="False" %>

runat="server"

runat="server"  

**1012** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**25.2.1 Examining an ASPX File** The ASPX file contains other information in addition to XHTML. Lines 1–2 are **ASP.NET comments** that indicate the figure number, the filename and the purpose of the file. ASP.NET comments begin with **<%--** and terminate with **\--%>**. We added these com- ments to the file. ASP.NET comments are not output as part of the XHTML sent to the client. Lines 3–4 use a **Page** directive (in an ASPX file a **directive** is delimited by **<%@** and **%>**) to specify information needed by ASP.NET to process this file. The **Language** at- tribute of the Page directive specifies the language of the code-behind file as Visual Basic ("VB"); the code-behind file (i.e., the **CodeFile**) is WebTime.aspx.vb. A code-behind file- name usually consists of the full ASPX filename (e.g., WebTime.aspx) followed by a filena- me extension indicating the programming language (.vb in this chapter’s examples).

The **AutoEventWireup** attribute (line 3) determines how Web Form events are han- dled. When AutoEventWireup is set to true, ASP.NET determines which methods in the class are called in response to events generated in the Page. For example, ASP.NET will call methods Page\_Init and Page\_Load in the code-behind file to handle the Page’s Init and Load events, respectively. AutoEventWireup requires the event-handling methods to follow specific naming copnventions. (We discuss these events later in the chapter.)

The **Inherits** attribute (line 4) specifies the page’s class name—in this case, WebTime. We say more about Inherits momentarily. \[_Note:_ We explicitly set the **EnableSession-**

**State** attribute (line 4) to False. We explain the significance of this attribute later in the chapter. The IDE sometimes generates attribute values (e.g., true and false) and control names (as you will see later in the chapter) that do not adhere to our standard code capi- talization conventions (i.e., True and False). Like Visual Basic, ASP.NET markup is not case sensitive, so using a different case is not problematic. To remain consistent with the code generated by the IDE, we do not modify these values in our code listings or in our accompanying discussions.\]

For this first ASPX file, we provide a brief discussion of the XHTML markup. For more information on XHTML, see Chapter 4. Lines 6–7 contain the document type dec- laration, which specifies the document element name (HTML) and the PUBLIC Uniform Resource Identifier (URI) for the DTD that defines the XHTML vocabulary.

Lines 9–10 contain the <html> and <head> start tags, respectively. XHTML docu- ments have the root element html and mark up information about the document in the head element. Also note that the html element specifies the XML namespace of the docu- ment using the xmlns attribute (see Section 14.4).

**18** <p> **19 20 21 22** </p> **23** </div> **24** </form> **25** </body> **26** </html>

**Fig. 25.1** | ASPX file that displays the web server’s time. (Part 2 of 2.)

<asp:Label ID="timeLabel" runat="server" BackColor="Black" EnableViewState="False" Font-Size="XX-Large" ForeColor="Yellow"></asp:Label>  

25.2 Creating and Running a Simple Web Form Example **1013**

Notice the **runat** attribute in line 10, which is set to **"server"**. This attribute indi- cates that when a client requests this ASPX file, ASP.NET processes the head element and its nested elements on the server and generates the corresponding XHTML, which is then sent to the client. In this case, the XHTML sent to the client will be identical to the markup in the ASPX file. However, as you will see, ASP.NET can generate complex XHTML markup from simple elements in an ASPX file.

Line 11 sets the title of this web page. We demonstrate how to set the title through a property in the IDE shortly. Line 13 contains the <body> start tag, which begins the body of the XHTML document; the body contains the main content that the browser displays. The form that contains our XHTML text and controls is defined in lines 14–24. Again, the runat attribute in the form element indicates that this element executes on the server, which generates equivalent XHTML and sends it to the client. Lines 15–23 contain a div element that groups the elements of the form in a block of markup.

**Software Engineering Observation 25.1** _Most ASP.NET controls must be placed in a form element in which the <form> tag has the runat="server" attribute._ 25.1

Lines 16–17 are an XHTML h2 heading element. As we demonstrate shortly, the IDE generates this element in response to typing text directly in the Web Form and selecting the text as a second-level heading.

Lines 18–22 contain a p element to mark up a paragraph of content in the browser. Lines 19–21 mark up a Label web control. The properties that we set in the **Properties** window, such as Font-Size and BackColor (i.e., background color), are attributes here. The **ID** attribute (line 19) assigns a name to the control so that it can be manipulated pro- grammatically in the code-behind file. We set the control’s **EnableViewState** attribute (line 20) to False. We explain the significance of this attribute later in the chapter.

The **asp: tag prefix** in the declaration of the **Label** tag (line 19) indicates that the label is an ASP.NET web control, not an XHTML element. Each web control maps to a corresponding XHTML element (or group of elements)—when processing a web control on the server, ASP.NET generates XHTML markup that will be sent to the client to rep- resent that control in a web browser.

**Portability Tip 25.1** _The same web control can map to different XHTML elements, depending on the client browser and the web control’s property settings._ 25.1

In this example, the asp:Label control maps to the XHTML **span** element (i.e., ASP.NET creates a span element to represent this control in the client’s web browser). A span element particular element is used because span elements allow formatting styles to be applied to text. Several of the property values that were applied to our label are repre- sented as part of the style attribute of the span element. You will soon see what the gen- erated span element’s markup looks like.

The web control in this example contains the runat="server" attribute–value pair (line 19), because this control must be processed on the server so that the server can trans- late the control into XHTML that can be rendered in the client browser. If this attribute pair is not present, the asp:Label element is written as text to the client (i.e., the control is not converted into a span element and does not render properly).  

**1014** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**25.2.2 Examining a Code-Behind File** Figure 25.2 presents the code-behind file. Recall that the ASPX file in Fig. 25.1 references WebTime.aspx.vb in line 3.

Line 3 (Fig. 25.2) begins the declaration of class WebTime. A class declaration can span multiple source-code files, and the separate portions of the class declaration in each file are known as partial classes. The Partial modifier in line 3 indicates that the code-behind file is a partial class. We discuss the remainder of this class shortly.

Line 4 indicates that WebTime inherits from class **Page** in namespace **System.Web.UI**. This namespace contains classes and controls that assist in building web-based applica- tions. Class Page provides events and objects necessary for creating web-based applica- tions. In addition to class Page, System.Web.UI also includes class **Control**—the base class that provides common functionality for all web controls.

Lines 7–11 define method **Page\_Init**, which handles the page’s **Init** event. This event indicates that all the controls on the page have been created and initialized and addi- tional application-specific initialization can now be performed. The only initialization required for this page is setting timeLabel’s Text property to the time on the server (i.e., the computer on which this code executes). The statement in line 10 retrieves the current time and formats it as _hh_:_mm_:_ss_. For example, 9 AM is formatted as 09:00:00, and 2:30 PM is formatted as 14:30:00. Notice that the code-behind file can access timeLabel (the ID of the Label in the ASPX file) programmatically, even though the file does not contain a declaration for a variable named timeLabel. You will learn why momentarily.

**1** ' Fig. 25.5: WebTime.aspx.vb **2** ' Code-behind file for a page that displays the current time. **3** Partial Class WebTime **4** Inherits System.Web.UI.Page **5 6** ' initializes the contents of the page **7** Protected Sub Page\_Init(ByVal sender As Object, \_ **8** ByVal e As System.EventArgs) Handles Me.Init **9**

**10 11** End Sub ' Page\_Init **12** End Class ' WebTime

**Fig. 25.2** | Code-behind file for a page that displays the web server’s time.

' display the server's current time in timeLabel timeLabel.Text = DateTime.Now.ToString("hh:mm:ss")  

25.2 Creating and Running a Simple Web Form Example **1015**

**25.2.3 Relationship Between an ASPX File and a Code-Behind File** How are the ASPX and code-behind files used to create the web page that is sent to the client? First, recall that class WebTime is the base class specified in line 4 of the ASPX file (Fig. 25.1). This class (partially declared in the code-behind file) inherits from Page, which defines general web page functionality. Partial class WebTime inherits this function- ality and defines some of its own (i.e., displaying the current time). The code in the code- behind file displays the time, whereas the code in the ASPX file defines the GUI.

When a client requests an ASPX file, ASP.NET creates two partial classes behind the scenes. The code-behind file contains one partial class named WebTime and ASP.NET gen- erate another partial class containing the remainder of class WebTime, based on the markup in the ASPX file. For example, WebTime.aspx contains a **Label** web control with ID time-

Label, so the generated partial class would contain a declaration for a variable named timeLabel of type System.Web.UI.WebControls.Label. Class Label represents a web control for displaying text. It is defined in namespace **System.Web.UI.WebControls**, which contains web controls for designing a page’s user interface. Web controls in this namespace derive from class **WebControl**. When compiled, the partial class that declares timeLabel combines with the code-behind file’s partial class declaration to form the com- plete WebTime class. This explains why line 10 in Fig. 25.2 can access timeLabel, which is created in lines 19–21 of WebTime.aspx (Fig. 25.1)—method Page\_Init and control timeLabel are actually members of the same class, but defined in separate partial classes.

The partial class generated by ASP.NET is based on the ASPX file that defines the page’s visual representation. This partial class is combined with the one in Fig. 25.2, which defines the page’s logic. The first time the web page is requested, this class is compiled and an instance is created. This instance represents the page and creates the XHTML that is sent to the client. The assembly created from the compiled partial classes is placed in a sub- directory of

C:\\WINDOWS\\Microsoft.NET\\Framework\\_VersionNumber_\\ Temporary ASP.NET Files\\WebTime

where _VersionNumber_ is the version number of the .NET Framework (e.g., v2.0.50727) installed on your computer.

Once the web page has been compiled, no recompilation is required on subsequent requeses. New instances of the web page class will be created to serve each request. The project will be recompiled only when you modify the application; changes are detected by the runtime environment, and the application is recompiled to reflect the altered content.

**25.2.4 How the Code in an ASP.NET Web Page Executes** Let’s look briefly at how the code for our web page executes. When an instance of the page is created, the **PreInit** event occurs first, invoking method **Page\_PreInit**, which can be used to set a page’s theme and look-and-feel (and perform other tasks that are beyond this chapter’s scope). The Init event occurs next, invoking method Page\_Init. Method Page\_Init is used to initialize objects and other aspects of the page. After Page\_Init exe- cutes, the **Load** event occurs, and the **Page\_Load** event handler executes. Although not present in this example, the PreInit and Load events are inherited from class Page. You will see examples of the Page\_Load event handler later in the chapter. After the Load event handler finishes executing, the page processes events that are generated by the page’s con-  

**1016** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

trols, such as user interactions with the GUI. When the user’s request is considered fully processed, an **Unload** event occurs, which calls the **Page\_Unload** event handler. This event, too, is inherited from class Page. Page\_Unload typically contains code that releases re- sources used by the page. Other events occur as well, but are typically used only by ASP.NET controls to generate XHTML to render client-side controls. You can learn more about a Page’s event life cycle at msdn2.microsoft.com/en-US/library/ms178472.aspx.

**25.2.5 Examining the XHTML Generated by an ASP.NET Application** Figure 25.3 shows the XHTML generated by ASP.NET when a client browser requests WebTime.aspx (Fig. 25.1). To view this code, select **View > Source** in Internet Explorer. We added the comments in lines 1–2 and reformatted the XHTML for readability.

The markup in this page is similar to the ASPX file. Lines 7–9 define a document header comparable to that in Fig. 25.1. Lines 10–25 define the document’s body. Line 11 begins the form, a mechanism for collecting user information and sending it to the web server. In this particular program, the user does not submit data to the web server for pro- cessing; however, processing user data is a crucial part of many applications that is facili- tated by forms. We demonstrate how to submit form data to the server in later examples.

XHTML forms can contain visual and nonvisual components. Visual components include buttons and other GUI components with which users interact. Nonvisual compo- nents, called **hidden inputs**, store data, such as e-mail addresses, that the document author specifies. A hidden input is defined in lines 13–14. We discuss the precise meaning of this

**1** <!-- Fig. 25.3: WebTime.html --> **2** <!-- The XHTML generated when WebTime.aspx is loaded. --> **3** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" **4** "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"> **5 6** <html xmlns="http://www.w3.org/1999/xhtml" > **7** <head> **8** <title>A Simple Web Form Example</title> **9** </head>

**10** <body> **11** <form name="form1" method="post" action="WebTime.aspx" id="form1"> **12** <div> **13 14 15** </div> **16 17** <div> **18** <h2>Current time on the Web server:</h2> **19** <p> **20 21 22** </p> **23** </div> **24** </form> **25** </body> **26** </html>

**Fig. 25.3** | XHTML response when the browser requests WebTime.aspx.

<input type="hidden" name="\_\_VIEWSTATE" id="\_\_VIEWSTATE" value= "/wEPDwUJODExMDE5NzY5ZGSzVbs789nqEeoNueQCnCJQEUgykw==" />

<span id="timeLabel" style="color:Yellow; background-color:Black;font-size:XX-Large;">13:51:12</span>  

25.2 Creating and Running a Simple Web Form Example **1017**

hidden input later in the chapter. Attribute **method** of the form element (line 11) specifies the method by which the web browser submits the form to the server. The **action**

attribute identifies the name and location of the resource that will be requested when this form is submitted—in this case, WebTime.aspx. Recall that the ASPX file’s form element contained the runat="server" attribute–value pair (line 14 of Fig. 25.1). When the form is processed on the server, the runat attribute is removed. The method and action

attributes are added, and the resulting XHTML form is sent to the client browser. In the ASPX file, the form’s Label (i.e., timeLabel) is a web control. Here, we are

viewing the XHTML created by our application, so the form contains a span element (lines 20–21 of Fig. 25.3) to represent the text in the label. In this particular case, ASP.NET maps the Label web control to an XHTML span element. The formatting options that were specified as properties of timeLabel, such as the font size and color of the text in the Label, are now specified in the style attribute of the span element.

Notice that only those elements in the ASPX file marked with the runat="server"

attribute–value pair or specified as web controls are modified or replaced when the file is processed by the server. The pure XHTML elements, such as the h2 in line 18, are sent to the browser as they appear in the ASPX file.

**25.2.6 Building an ASP.NET Web Application** Now that we have presented the ASPX file, the code-behind file and the resulting web page sent to the web browser, we show the steps we used to create this application in Visual Web Developer.

**_Step 1: Creating the Website_** In Visual Web Developer, select **File > New Web Site...** to display the **New Web Site** dialog (Fig. 25.4). In this dialog, select **ASP.NET Web Site** in the **Templates** pane. Below this pane, there are two fields in which you can specify the type and location of the web appli-

**Fig. 25.4** | Creating an **ASP.NET Web Site** in Visual Web Developer.  

**1018** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

cation you are creating. If it is not already selected, select **HTTP** from the drop-down list closest to **Location**. This indicates that the web application should be configured to run as an IIS application using HTTP (either on your computer or on a remote computer). We want our project to be located in http://localhost, which is the URL for IIS’s root di- rectory (this URL normally corresponds to the C:\\InetPub\\wwwroot directory on your machine). The name **localhost** indicates that the server resides on local computer. If the web server were located on a different computer, localhost would be replaced with the appropriate IP address or hostname. By default, Visual Web Developer sets the location where the website will be created to http://localhost/WebSite, which we change to http://localhost/WebTime.

If you do not have IIS on your computer or do not have permission to access it, you can select **File System** from the drop-down list next to **Location** to create the web applica- tion in a folder on your computer. You will be able to test the application using Visual Web Developer’s internal ASP.NET Development Server, but you will not be able to access the application remotely over the Internet.

The **Language** drop-down list in the **New Web Site** dialog allows you to specify the language (i.e., Visual Basic, Visual C# or Visual J#) in which you will write the code- behind file(s) for the web application. Change the setting to Visual Basic. Click **OK** to create the website. This creates the directory C:\\Inetpub\\wwwroot\\WebTime (in IIS) and makes it accessible through the URL http://localhost/WebTime. This action also creates a WebTime directory in the directory My Documents\\Visual Studio 2005\\Projects in which the project’s solution files (e.g., WebTime.sln) are stored.

**_Step 2: Examining the Solution Explorer of the Newly Created Project_** The next several figures describe the new project’s content, beginning with the **Solution Explorer** shown in Fig. 25.5. Like Visual Basic 2005 Express, Visual Web Developer cre- ates several files when you create a new project. It creates an ASPX file (i.e., Web Form) named Default.aspx for each new **ASP.NET Web Site** project. This file is open by default in the Web Forms Designer in **Source** mode when the project first loads (we discuss this momentarily). As mentioned previously, a code-behind file is included as part of the project. Visual Web Developer creates a code-behind file named Default.aspx.vb. To open the ASPX file’s code-behind file, right click the ASPX file and select **View Code** or click the **View Code** button ( ) at the top of the **Solution Explorer**. Alternatively, you can

**Fig. 25.5** | **Solution Explorer** window for project WebTime.

ASPX file Code-behind file

**View Code**

**Properties**

**Refresh**

**Nest Related Files View Designer**

**ASP.NET Configuration**

**Copy Web Site**  

25.2 Creating and Running a Simple Web Form Example **1019**

expand the node for the ASPX file to reveal the node for the code-behind file (see Fig. 25.5). You can also choose to list all the files in the project individually (instead of nested) by clicking the **Nest Related Files** button—this option is turned on by default, so clicking the button toggles the option off.

The **Properties** and **Refresh** buttons in Visual Web Developer’s **Solution Explorer** behave like those in Visual Basic 2005 Express. Visual Web Developer’s **Solution Explorer** also contains the buttons **View Designer**, **Copy Web Site** and **ASP.NET Configuration**. The **View Designer** button allows you to open the Web Form in **Design** mode, which we discuss shortly. The **Copy Web Site** button opens a dialog that allows you to move the files in this project to another location, such as a remote web server. This is useful if you are devel- oping the application on your local computer, but want to make it available to the public from a different location. Finally, the **ASP.NET Configuration** button takes you to a web page called the **Web Site Administration Tool**, where you can manipulate various settings and security options for your application. We discuss this tool in greater detail in Section 25.6.

**_Step 3: Examining the Toolbox in Visual Web Developer_** Figure 25.6 shows the **Toolbox** displayed in the IDE when the project loads. Figure 25.6(a) displays the beginning of the **Standard** list of web controls, and Fig. 25.6(b) displays the remaining web controls, and the list of **Data** controls used in ASP.NET. We discuss specific controls in Fig. 25.6 as they are used throughout the chapter. Notice that some controls in the **Toolbox** are similar to Windows controls.

**Fig. 25.6** | **Toolbox** in Visual Web Developer.

(a) (b)  

**1020** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**_Step 4: Examining the Web Forms Designer_** Figure 25.7 shows the Web Forms Designer in **Source** mode, which appears in the center of the IDE. When the project loads for the first time, the Web Forms Designer displays the autogenerated ASPX file (i.e., Default.aspx) in **Source** mode, which allows you to view and edit the markup that comprises the web page. The markup listed in Fig. 25.7 was created by the IDE and serves as a template that we will modify shortly. Clicking the **De- sign** button in the lower-left corner of the Web Forms Designer switches to **Design** mode (Fig. 25.8), which allows you to drag and drop controls from the **Toolbox** onto the Web Form and see the controls. You can also type at the current cursor location to add text to the web page. We demonstrate this shortly. In response to such actions, the IDE generates the appropriate markup in the ASPX file. Notice that **Design** mode indicates the XHTML element where the cursor is currently located. Clicking the **Source** button returns the Web Forms Designer to **Source** mode, where you can see the generated markup.

**Fig. 25.7** | **Source** mode of the Web Forms Designer.

**Fig. 25.8** | **Design** mode of the Web Forms Designer.

**Design** mode button

**Source** mode button

Cursor

Cursor’s current location in the document  

25.2 Creating and Running a Simple Web Form Example **1021**

**_Step 5: Examining the Code-Behind File in the IDE_** The next figure (Fig. 25.9) displays Default.aspx.vb—the code-behind file generated by Visual Web Developer for Default.aspx. Right click the ASPX file in the **Solution Explor- er** and select **View Code** to open the code-behind file. When it is first created, this file con- tains nothing more than a partial class declaration. We will add the Page\_Init event handler to this code momentarily.

**_Step 6: Renaming the ASPX File_** Now that you’ve seen the contents of the default ASPX and code-behind files, let’s rename these files. Right click the ASPX file in the **Solution Explorer** and select **Rename**. Enter the new filename WebTime.aspx and press _Enter_. This updates the name of both the ASPX file and the code-behind file. The IDE also updates the Page directive’s CodeFile attribute in WebTime.aspx.

**_Step 7: Renaming the Class in the Code-Behind File and Updating the ASPX File_** Although renaming the ASPX file causes the name of the code-behind file to change, this action does not affect the name of the partial class declared in the code-behind file. Open the code-behind file and change the class name from \_Default (line 2 in Fig. 25.9) to WebTime, so the partial class declaration appears as in line 3 of Fig. 25.2. Recall that this class is also referenced by the Page directive in the ASPX file. Using the Web Forms De- signer’s **Source** mode, modify the Inherits attribute of the Page directive in WebTime.as-

px, so it appears as in line 4 of Fig. 25.1. The value of the Inherits attribute and the class name in the code-behind file must be identical; otherwise, you’ll get errors when you build the web application.

**_Step 8: Changing the Title of the Page_** Before designing the content of the Web Form, we change its title from the default Unti- tled Page (line 9 of Fig. 25.7) to A Simple Web Form Example. To do so, open the ASPX file in **Source** mode and modify the text in the title element—i.e., the text between the tags <title> and </title>. Alternatively, you can open the ASPX file in **Design** mode and modify the Web Form’s **Title** property in the **Properties** window. To view the Web Form’s properties, select DOCUMENT from the drop-down list in the **Properties** window; **DOCUMENT** represents the Web Form in the **Properties** window.

**_Step 9: Designing the Page_** Designing a Web Form is as simple as designing a Windows Form. To add controls to the page, drag-and-drop them from the **Toolbox** onto the Web Form in **Design** mode. Like the

**Fig. 25.9** | Code-behind file for Default.aspx generated by Visual Web Developer.  

**1022** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Web Form itself, each control is an object that has properties, methods and events. You can set these properties and events visually using the **Properties** window or programmati- cally in the code-behind file. However, unlike working with a Windows Form, you can type text directly on a Web Form at the cursor location or insert XHTML elements from the **Toolbox**.

Controls and other elements are placed sequentially on a Web Form, much as text and images are placed in a document using word-processing software like Microsoft Word. Controls are placed one after another in the order in which you drag-and-drop them onto the Web Form. The cursor indicates the point at which text and XHTML elements will be inserted. If you want to position a control between existing text or controls, you can drop the control at a specific position within the existing elements. You can also rearrange existing controls using drag-and-drop actions. By default, controls flow based on the width of the page. An alternate type of layout is known as **absolute positioning**, in which con- trols are located exactly where they are dropped on the Web Form. You can enable abso- lute positioning in **Design** mode by selecting **Layout > Position > Auto-position Options…**., clicking the first checkbox in the **Positioning options** pane of the **Options** dialog that appears, then selecting the appropriate positioning option from the drop-down menu.

**Portability Tip 25.2** _Absolute positioning is discouraged, because pages designed in this manner may not render cor- rectly on computers with different screen resolutions and font sizes. This could cause absolutely positioned elements to overlap each other or display off-screen, requiring the client to scroll to see the full page content._ 25.2

In this example, we use one piece of text and one Label. To add the text to the Web Form, click the blank Web Form in **Design** mode and type Current time on the Web

server:. Visual Web Developer is a **WYSIWYG** (**What You See Is What You Get**) editor—whenever you make a change to a Web Form in **Design** mode, the IDE creates the markup (visible in **Source** mode) necessary to achieve the desired visual effects seen in **Design** mode. After adding the text to the Web Form, switch to **Source** mode. You should see that the IDE added this text to the div element that appears in the ASPX file by default. Back in **Design** mode, highlight the text you added. From the **Block Format** drop- down list (see Fig. 25.10), choose **Heading 2** to format this text as a heading that will appear bold in a font slightly larger than the default. This action encloses the text in an h2

element. Finally, click to the right of the text and press the _Enter_ key to start a new para- graph. This action generates a p (paragraph) element in the ASPX file’s markup. The IDE should now look like Fig. 25.10.

You can place a Label on a Web Form either by dragging-and-dropping or by double clicking the **Toolbox**’s **Label** control. Ensure that the cursor is in the new paragraph, then add a Label that will be used to display the time. Using the **Properties** window, set the (ID) property of the Label to timeLabel. In the Text property, delete timeLabel’s text— this text will be set programmatically in the code-behind file. When a Label does not con- tain text, its name is displayed in square brackets in the Web Forms Designer (Fig. 25.11) as a placeholder for design and layout purposes. This text is not displayed at execution time. We set timeLabel’s BackColor, ForeColor and Font-Size properties to Black, Yellow and XX-Large, respectively. To change the Label’s font properties, select the Label, expand the Font node in the **Properties** window and change each relevant property.  

25.2 Creating and Running a Simple Web Form Example **1023**

As the Label’s properties are set, Visual Web Developer updates the ASPX file’s contents. Figure 25.11 shows the IDE after setting these properties.

Next, set the Label’s EnableViewState property to False. Finally, select DOCUMENT from the drop-down list in the **Properties** window and set the Web Form’s EnableSes- sionState property to False. We discuss both of these properties later in the chapter.

**Fig. 25.10** | WebTime.aspx after inserting text and a new paragraph.

**Fig. 25.11** | WebTime.aspx after adding a Label and setting its properties.

**Block Format** drop-down list Cursor position after inserting a new paragraph by pressing _Enter_

Label  

**1024** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**_Step 10: Adding Page Logic_** Now that you’ve designed the user interface, you’ll add Visual Basic code to the code-be- hind file to obtain the server’s time. Open WebTime.aspx.vb by double clicking its node in the **Solution Explorer**. In this example, we add a Page\_Init event handler (lines 7–11 of Fig. 25.2) to the code-behind file. Recall that Page\_Init handles the Init event and con- tains code to initialize the page. The statement in line 10 of Fig. 25.2 sets timeLabel’s text to the server’s current time.

**_Step 11: Running the Program_** After creating the Web Form, you can view it several ways. First, you can select **Debug > Start Without Debugging**, which runs the application by opening it in a browser window. If you created the application on your local IIS server (as we did in this example), the URL shown in the browser will be http://localhost/WebTime/WebTime.aspx (Fig. 25.2), in- dicating that the web page (the ASPX file) is located within the virtual directory WebTime

on the local IIS web server. IIS must be running to test the website in a browser. IIS can be started by executing inetmgr.exe from **Start > Run...**, right clicking **Default Web Site** and selecting **Start**. \[_Note:_ You might need to expand the node representing your computer to display the **Default Web Site**.\]

If you created the ASP.NET application on the local file system, the URL shown in the browser will be http://localhost:_PortNumber_/WebTime/WebTime.aspx, where _Port- Number_ is the number of the randomly assigned port on which Visual Web Developer’s built-in test server runs. The IDE assigns the port number on a per-solution basis. This URL indicates that the WebTime project folder is being accessed through the root directory of the test server running at localhost:_PortNumber_. When you select **Debug > Start Without Debugging**, a tray icon appears near the bottom-right of your screen next to the computer’s date and time to show that the **ASP.NET Development Server** is running. The test server stops when you exit Visual Web Developer.

To debug your application, you can select **Debug > Start Debugging** to view the web page in a web browser with debugging enabled. You cannot debug a web application unless debugging is explicitly enabled by the **Web.config** file—a file that stores configura- tion settings for an ASP.NET web application. You will rarely need to manually create or modify Web.config. The first time you select **Debug > Start Debugging** in a project, a dialog appears and asks whether you want the IDE to modify the Web.config file to enable debugging. After you click **OK**, the IDE enters **Running** mode. You can exit **Running** mode by selecting **Debug > Stop Debugging** in Visual Web Developer or by closing the browser window in which the ASPX file is displayed.

To view a specific ASPX file, you can right click either the Web Forms Designer or the ASPX filename (in the **Solution Explorer**) and select **View In Browser** to load the page in a web browser. Right clicking the ASPX file in the **Solution Explorer** and selecting **Browse With…** also opens the page in a browser, but first allows you to specify the web browser that should display the page and its screen resolution.

Finally, you can run your application by opening a browser window and typing the web page’s URL in the **Address** field. When testing an ASP.NET application on the same computer running IIS, type http://localhost/_ProjectFolder_/_PageName_.aspx, where _ProjectFolder_ is the folder in which the page resides (usually the name of the project), and _PageName_ is the name of the ASP.NET page. If your application resides on the local file system, you must first start the **ASP.NET Development Server** by running the application  

25.3 Web Controls **1025**

using one of the methods described above. Then you can type the URL (including the _PortNumber_ found in the test server’s tray icon) in the browser to execute the application.

Note that all of these methods of running the application compile the project for you. In fact, ASP.NET compiles your web page whenever it changes between HTTP requests. For example, suppose you browse the page, then modify the ASPX file or add code to the code-behind file. When you reload the page, ASP.NET recompiles the page on the server before returning the HTTP response to the browser. This important new behavior of ASP.NET 2.0 ensures that clients always see the latest version of the page. You can man- ually compile a web page or an entire website by selecting **Build Page** or **Build Site**, respec- tively, from the **Build** menu in Visual Web Developer.

**_Windows Firewall Settings_** If you would like to test your web application over a network, you may need to change your Windows Firewall settings. For security reasons, Windows Firewall does not allow remote access to a web server on your local computer by default. To change this, open the Windows Firewall utility in the Windows Control Panel. In Windows XP, Click the **Ad- vanced** tab and select your network connection from the **Network Connection Settings** list, then click **Settings…**. On the **Services** tab of the **Advanced Settings** dialog, ensure that **Web Server (HTTP)** is checked. In Windows Vista click the **Change settings** link, then click **Continue** in dialog that appears. Select the **Exceptions** tab and place a check next to **World Wide Web Services (HTTP)**.

**25.3 Web Controls** This section introduces some of the web controls located in the **Standard** section of the **Toolbox** (Fig. 25.6). Figure 25.12 summarizes some of the web controls used in the chap- ter examples.

**25.3.1 Text and Graphics Controls** Figure 25.13 depicts a simple form for gathering user input. This example uses all the con- trols listed in Fig. 25.12, except Label, which you used in Section 25.2. The code in

Web control Description

Label Displays text that the user cannot edit.

TextBox Gathers user input and displays text.

Button Triggers an event when clicked.

HyperLink Displays a hyperlink.

DropDownList Displays a drop-down list of choices from which you can select an item.

RadioButtonList Groups radio buttons.

Image Displays images (e.g., GIF and JPG).

**Fig. 25.12** | Commonly used web controls.  

**1026** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Fig. 25.13 was generated by Visual Web Developer in response to dragging controls onto the page in **Design** mode. To begin, create an ASP.NET website named WebControls. \[_Note:_ This example does not contain any functionality—i.e., no action occurs when the user clicks **Register**. We ask you to provide the functionality as an exercise. In subsequent examples, we demonstrate how to add functionality to many of these web controls.\]

**1** <%-- Fig. 25.13: WebControls.aspx --%> **2** <%-- Registration form that demonstrates Web controls. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="WebControls.aspx.vb" Inherits="WebControls" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml">

**10** <head runat="server"> **11** <title>Web Controls Demonstration</title> **12** </head> **13** <body> **14** <form id="form1" runat="server"> **15** <div> **16** <h3>This is a sample registration form.</h3> **17** <p> **18** <em>Please fill in all fields and click Register.</em></p> **19** <p> **20 21 22 23 24** </p> **25** <table id="TABLE1"> **26** <tr> **27** <td style="width: 230px; height: 21px" valign="top"> **28** <asp:Image ID="firstNameImage" runat="server" **29** EnableViewState="False" ImageUrl="~/Images/fname.png" /> **30 31 32** </td> **33** <td style="width: 231px; height: 21px" valign="top"> **34** <asp:Image ID="lastNameImage" runat="server" **35** EnableViewState="False" ImageUrl="~/Images/lname.png" /> **36** <asp:TextBox ID="lastNameTextBox" runat="server" **37** EnableViewState="False"></asp:TextBox> **38** </td> **39** </tr> **40** <tr> **41** <td style="width: 230px" valign="top"> **42** <asp:Image ID="emailImage" runat="server" **43** EnableViewState="False" ImageUrl="~/Images/email.png" /> **44** <asp:TextBox ID="emailTextBox" runat="server" **45** EnableViewState="False"></asp:TextBox> **46** </td>

**Fig. 25.13** | Web Form that demonstrates web controls. (Part 1 of 3.)

<asp:Image ID="userInformationImage" runat="server" EnableViewState="False" ImageUrl="~/Images/user.png" /> &nbsp;

<span style="color: teal"> Please fill out the fields below.</span>

<asp:TextBox ID="firstNameTextBox" runat="server" EnableViewState="False"></asp:TextBox>  

25.3 Web Controls **1027**

**47** <td style="width: 231px" valign="top"> **48** <asp:Image ID="phoneImage" runat="server" **49** EnableViewState="False" ImageUrl="~/Images/phone.png" /> **50** <asp:TextBox ID="phoneTextBox" runat="server" **51** EnableViewState="False"></asp:TextBox> **52** Must be in the form (555) 555-5555. **53** </td> **54** </tr> **55** </table> **56** <p> **57** <asp:Image ID="publicationsImage" runat="server" **58** EnableViewState="False" **59** ImageUrl="~/Images/publications.png" /> &nbsp; **60** <span style="color: teal"> **61** Which book would you like information about?</span> **62** </p> **63** <p> **64 65 66 67 68 69 70 71 72 73 74** </p> **75** <p> **76 77 78 79 80 81** </p> **82** <p> **83** <asp:Image ID="osImage" runat="server" EnableViewState="False" **84** ImageUrl="~/Images/os.png" /> &nbsp; **85** <span style="color: teal"> **86** Which operating system are you using?</span> **87** </p> **88** <p> **89 90 91 92 93 94 95 96 97** </p> **98** <p>

**Fig. 25.13** | Web Form that demonstrates web controls. (Part 2 of 3.)

<asp:DropDownList ID="booksDropDownList" runat="server" EnableViewState="False"> <asp:ListItem>Visual Basic 2005 How to Program 3e

</asp:ListItem> <asp:ListItem>Visual C# 2005 How to Program 2e

</asp:ListItem> <asp:ListItem>Java How to Program 6e</asp:ListItem> <asp:ListItem>C++ How to Program 5e</asp:ListItem> <asp:ListItem>XML How to Program 1e</asp:ListItem>

</asp:DropDownList>

<asp:HyperLink ID="booksHyperLink" runat="server" EnableViewState="False" NavigateUrl="http://www.deitel.com" Target="\_blank"> Click here to view more information about our books

</asp:HyperLink>

<asp:RadioButtonList ID="operatingSystemRadioButtonList" runat="server" EnableViewState="False"> <asp:ListItem>Windows XP</asp:ListItem> <asp:ListItem>Windows 2000</asp:ListItem> <asp:ListItem>Windows NT</asp:ListItem> <asp:ListItem>Linux</asp:ListItem> <asp:ListItem>Other</asp:ListItem>

</asp:RadioButtonList>  

**1028** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Before discussing the web controls used in this ASPX file, we explain the XHTML that creates the layout seen in Fig. 25.13. The page contains an h3 heading element (line 16), followed by a series of additional XHTML blocks. We place most of the web controls inside p elements (i.e., paragraphs), but we use an XHTML table element (lines 25–55) to organize the Image and TextBox controls in the user information section of the page. In the preceding section, we described how to add heading elements and paragraphs visually without manipulating any XHTML in the ASPX file directly. Visual Web Developer allows you to add a table in a similar manner.

**99 100 101** </p> **102** </div> **103** </form> **104** </body> **105** </html>

**Fig. 25.13** | Web Form that demonstrates web controls. (Part 3 of 3.)

<asp:Button ID="registerButton" runat="server" EnableViewState="False" Text="Register" />

Image control

TextBox control

DropDownList control

HyperLink control

RadioButtonList control

Button control  

25.3 Web Controls **1029**

**_Adding an XHTML Table to a Web Form_** To create a table with two rows and two columns in **Design** mode, select the **Insert Table** command from the **Layout** menu. In the **Insert Table** dialog that appears, select the **Custom** radio button. In the **Layout** group box, change the values of **Rows** and **Columns** to 2. By default, the contents of a table cell are aligned vertically in the middle of the cell. We changed the vertical alignment of all cells in the table by clicking the **Cell Properties…** but- ton, then selecting **top** from the **Vertical align** combo box in the resulting dialog. This caus- es the content of each table cell to align with the top of the cell. Click **OK** to close the **Cell Properties** dialog, then click **OK** to close the **Insert Table** dialog and create the table. Once a table is created, controls and text can be added to particular cells to create a neatly orga- nized layout.

**_Setting the Color of Text on a Web Form_** Notice that some of the instructions to the user on the form appear in a teal color. To set the color of a specific piece of text, highlight the text and select **Format > Foreground col- or…**. In the **Color Picker** dialog, click the **Named Colors** tab and choose a color. Click **OK** to apply the color. Note that the IDE places the colored text in an XHTML span element (e.g., lines 22–23) and applies the color using the span’s style attribute.

**_Examining Web Controls on a Sample Registration Form_** Lines 20–21 of Fig. 25.13 define an **Image** control, which inserts an image into a web page. The images used in this example are located in the chapter’s examples directory. You can download the examples from www.deitel.com/books/iw3htp4. Before an image can be displayed on a web page using an Image web control, the image must first be added to the project. We added an Images folder to this project (and to each example project in the chapter that uses images) by right clicking the location of the project in the **Solution Explor- er**, selecting **New Folder** and entering the folder name Images. We then added each of the images used in the example to this folder by right clicking the folder, selecting **Add Existing Item…** and browsing for the files to add. You can also drag a folder full of images onto the project’s location in the **Solution Explorer** to add the folder and all the images to the project.

The **ImageUrl** property (line 21) specifies the location of the image to display in the Image control. To select an image, click the ellipsis next to the ImageUrl property in the **Properties** window and use the **Select Image** dialog to browse for the desired image in the project’s Images folder. When the IDE fills in the ImageUrl property based on your selec- tion, it includes a tilde and forward slash (~/) at the beginning of the ImageUrl—this indi- cates that the Images folder is in the root directory of the project.

Lines 25–55 contain the table element created by the steps discussed previously. Each td element contains an Image control and a **TextBox** control, which allows you to obtain text from the user and display text to the user. For example, lines 30–31 define a TextBox control used to collect the user’s first name.

Lines 64–73 define a **DropDownList**. This control is similar to the XHTML select

control. When a user clicks the drop-down list, it expands and displays a list from which the user can make a selection. Each item in the drop-down list is defined by a **ListItem**

element (lines 66–72). After dragging a DropDownList control onto a Web Form, you can add items to it using the **ListItem Collection Editor**. This process is similar to customizing a ListBox in a Windows application. In Visual Web Developer, you can access the **ListItem Collection Editor** by clicking the ellipsis next to the Items property of the DropDownList,  

**1030** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

or by using the **DropDownList Tasks** menu. You can open this menu by clicking the small arrowhead that appears in the upper-right corner of the control in **Design** mode (Fig. 25.14). This menu is called a **smart tag menu**. Visual Web Developer displays smart tag menus for many ASP.NET controls to facilitate common tasks. Clicking **Edit Items...** in the **DropDownList Tasks** menu opens the **ListItem Collection Editor**, which allows you to add ListItem elements to the DropDownList.

The **HyperLink** control (lines 76–80 of Fig. 25.13) adds a hyperlink to a web page. The **NavigateUrl** property (line 77) of this control specifies the resource (i.e., http:// www.deitel.com) that is requested when a user clicks the hyperlink. Setting the **Target**

property to \_blank specifies that the requested web page should open in a new browser window. By default, HyperLink controls cause pages to open in the same browser window.

Lines 89–96 define a **RadioButtonList** control, which provides a series of radio but- tons from which the user can select only one. Like options in a DropDownList, individual radio buttons are defined by ListItem elements. Note that, like the **DropDownList Tasks** smart tag menu, the **RadioButtonList Tasks** smart tag menu also provides an **Edit Items…** link to open the **ListItem Collection Editor**.

The final web control in Fig. 25.13 is a **Button** (lines 99–100). A Button web control represents a button that triggers an action when clicked. This control typically maps to an XHTML input element with attribute type set to "submit". As stated earlier, clicking the **Register** button in this example does not do anything.

**25.3.2 AdRotator Control** Web pages often contain product or service advertisements, which usually consist of im- ages. Although website authors want to include as many sponsors as possible, web pages can display only a limited number of advertisements. To address this problem, ASP.NET provides the **AdRotator** web control for displaying advertisements. Using advertisement data located in an XML file, an AdRotator randomly selects an image to display and gen- erates a hyperlink to the web page associated with that image. Browsers that do not support images display alternate text that is specified in the XML document. If a user clicks the image or substituted text, the browser loads the web page associated with that image.

**_Demonstrating the AdRotator Web Control_** Figure 25.15 demonstrates the AdRotator web control. In this example, the “advertise- ments” that we rotate are the flags of 10 countries. When a user clicks the displayed flag image, the browser is redirected to a web page containing information about the country that the flag represents. If a user refreshes the browser or requests the page again, one of the 10 flags is again chosen at random and displayed.

The ASPX file in Fig. 25.15 is similar to that in Fig. 25.1. However, instead of XHTML text and a Label, this page contains XHTML text (the h3 element in line 16)

**Fig. 25.14** | **DropDownList Tasks** smart tag menu.  

25.3 Web Controls **1031**

and an AdRotator control named countryRotator (lines 18–19). This page also contains an XmlDataSource control (lines 20–22), which supplies the data to the AdRotator con- trol. The background attribute of the page’s body element (line 13) is set to the image background.png, located in the project’s Images folder. To specify this file, click the ellipsis provided next to the Background property of DOCUMENT in the **Properties** window and use the resulting dialog to select background.png from the Images folder. The images and XML file used in this example are both located in the chapter’s examples directory.

You do not need to add any code to the code-behind file, because the AdRotator con- trol “does all the work.” The output depicts two different requests. Figure 25.15(a) shows

**1** <%-- Fig. 25.15: FlagRotator.aspx --%> **2** <%-- A Web Form that displays flags using an AdRotator control. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="FlagRotator.aspx.vb" Inherits="FlagRotator" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head runat="server"> **11** <title>Flag Rotator</title> **12** </head> **13** <body background="Images/background.png"> **14** <form id="form1" runat="server"> **15** <div> **16** <h3>AdRotator Example</h3> **17** <p> **18 19 20 21 22 23** </p> **24** </div> **25** </form> **26** </body> **27** </html>

**Fig. 25.15** | Web Form that demonstrates the AdRotator web control. (Part 1 of 2.)

<asp:AdRotator ID="countryRotator" runat="server" DataSourceID="adXmlDataSource" />

<asp:XmlDataSource ID="adXmlDataSource" runat="server" DataFile="~/App\_Data/AdRotatorInformation.xml">

</asp:XmlDataSource>

(a) (b)

AlternateText displayed in a tooltip

AdRotator image  

**1032** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

the first time the page is requested, when the American flag is shown. In the second request, as shown in Fig. 25.15(b), the French flag is displayed. Figure 25.15(c) depicts the web page that loads when the French flag is clicked.

**_Connecting Data to an AdRotator Control_** An AdRotator control accesses an XML file (presented shortly) to determine what adver- tisement (i.e., flag) image, hyperlink URL and alternate text to display and include in the page. To connect the AdRotator control to the XML file, we create an **XmlDataSource**

control—one of several ASP.NET data controls (found in the **Data** section of the **Toolbox**) that encapsulate data sources and make such data available for web controls. An XmlData-

Source references an XML file containing data that will be used in an ASP.NET applica- tion. Later in the chapter, you will learn more about data-bound web controls, as well as the SqlDataSource control, which retrieves data from a SQL Server database, and the ObjectDataSource control, which encapsulates an object that makes data available.

To build this example, we first add the XML file AdRotatorInformation.xml to the project. Each project created in Visual Web Developer contains an App\_Data folder, which is intended to store all the data used by the project. Right click this folder in the **Solution Explorer** and select **Add Existing Item…**, then browse for AdRotatorInformation.xml on your computer. We provide this file in the chapter’s examples directory in the subdirectory named exampleXMLFiles.

After adding the XML file to the project, drag an AdRotator control from the **Toolbox** to the Web Form. The **AdRotator Tasks** smart tag menu will open automatically. From this menu, select **<New Data Source…>** from the **Choose Data Source** drop-down list to start the **Data Source Configuration Wizard**. Select **XML File** as the data-source type. This causes the wizard to create an XmlDataSource with the ID specified in the bottom half of the wizard dialog. We set the ID of the control to adXmlDataSource. Click **OK** in the **Data Source Configuration Wizard** dialog. The **Configure Data Source - adXmlDataSource** dialog appears next. In this dialog’s **Data File** section, click **Browse…** and, in the **Select XML File**

**Fig. 25.15** | Web Form that demonstrates the AdRotator web control. (Part 2 of 2.)

(c)  

25.3 Web Controls **1033**

dialog, locate and select the XML file you added to the App\_Data folder. Click **OK** to exit this dialog, then click **OK** to exit the **Configure Data Source - adXmlDataSource** dialog. After completing these steps, the AdRotator is configured to use the XML file to deter- mine which advertisements to display.

**_Examining an XML File Containing Advertisement Information_** XML document AdRotatorInformation.xml (Fig. 25.16)—or any XML document used with an AdRotator control—must contain one **Advertisements** root element (lines 4– 94). Within that element can be several **Ad** elements (e.g., lines 5–12), each of which pro- vides information about a different advertisement. Element **ImageUrl** (line 6) specifies the path (location) of the advertisement’s image, and element **NavigateUrl** (lines 7–9) speci- fies the URL for the web page that loads when a user clicks the advertisement. Note that we reformatted this file for presentation purposes. The actual XML file cannot contain any whitespace before or after the URL in the NavigateUrl element, or the whitespace will be considered part of the URL, and the page will not load properly.

The **AlternateText** element (line 10) nested in each Ad element contains text that displays in place of the image when the browser cannot locate or render the image for some reason (i.e., the file is missing, or the browser is not capable of displaying it), or to assist the visually impaired. The AlternateText element’s text is also a tooltip that Internet Explorer displays when a user places the mouse pointer over the image (Fig. 25.15). The **Impressions** element (line 11) specifies how often a particular image appears, relative to the other images. An advertisement that has a higher Impressions value displays more fre- quently than an advertisement with a lower value. In our example, the advertisements dis- play with equal probability, because the value of each Impressions element is set to 1.

**1** <?xml version="1.0" encoding="utf-8"?> **2** <!-- Fig. 25.16: AdRotatorInformation.xml --> **3** <!-- XML file containing advertisement information. --> **4** <Advertisements> **5** <Ad> **6** <ImageUrl>Images/france.png</ImageUrl> **7** <NavigateUrl>http://www.cia.gov/library/publications/ **8** the-world-factbook/geos/fr.html **9** </NavigateUrl>

**10** <AlternateText>France Information</AlternateText> **11** <Impressions>1</Impressions> **12** </Ad> **13 14** <Ad> **15** <ImageUrl>Images/germany.png</ImageUrl> **16** <NavigateUrl>http://www.cia.gov/library/publications/ **17** the-world-factbook/geos/gm.html **18** </NavigateUrl> **19** <AlternateText>Germany Information</AlternateText> **20** <Impressions>1</Impressions> **21** </Ad> **22**

**Fig. 25.16** | XML file containing advertisement information used in AdRotator example. (Part 1 of 3.)  

**1034** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**23** <Ad> **24** <ImageUrl>Images/italy.png</ImageUrl> **25** <NavigateUrl>http://www.cia.gov/library/publications/ **26** the-world-factbook/geos/it.html **27** </NavigateUrl> **28** <AlternateText>Italy Information</AlternateText> **29** <Impressions>1</Impressions> **30** </Ad> **31 32** <Ad> **33** <ImageUrl>Images/spain.png</ImageUrl> **34** <NavigateUrl>http://www.cia.gov/library/publications/ **35** the-world-factbook/geos/sp.html **36** </NavigateUrl> **37** <AlternateText>Spain Information</AlternateText> **38** <Impressions>1</Impressions> **39** </Ad> **40 41** <Ad> **42** <ImageUrl>Images/latvia.png</ImageUrl> **43** <NavigateUrl>http://www.cia.gov/library/publications/ **44** the-world-factbook/geos/lg.html **45** </NavigateUrl> **46** <AlternateText>Latvia Information</AlternateText> **47** <Impressions>1</Impressions> **48** </Ad> **49 50** <Ad> **51** <ImageUrl>Images/peru.png</ImageUrl> **52** <NavigateUrl>http://www.cia.gov/library/publications/ **53** the-world-factbook/geos/pe.html **54** </NavigateUrl> **55** <AlternateText>Peru Information</AlternateText> **56** <Impressions>1</Impressions> **57** </Ad> **58 59** <Ad> **60** <ImageUrl>Images/senegal.png</ImageUrl> **61** <NavigateUrl>http://www.cia.gov/library/publications/ **62** the-world-factbook/geos/sg.html **63** </NavigateUrl> **64** <AlternateText>Senegal Information</AlternateText> **65** <Impressions>1</Impressions> **66** </Ad> **67 68** <Ad> **69** <ImageUrl>Images/sweden.png</ImageUrl> **70** <NavigateUrl>http://www.cia.gov/library/publications/ **71** the-world-factbook/geos/sw.html **72** </NavigateUrl> **73** <AlternateText>Sweden Information</AlternateText>

**Fig. 25.16** | XML file containing advertisement information used in AdRotator example. (Part 2 of 3.)  

25.3 Web Controls **1035**

**25.3.3 Validation Controls** This section introduces a different type of web control, called a **validation control** (or **val- idator**), which determines whether the data in another web control is in the proper format. For example, validators could determine whether a user has provided information in a re- quired field or whether a zip-code field contains exactly five digits. Validators provide a mechanism for validating user input on the client. When the XHTML for our page is cre- ated, the validator is converted into JavaScript that performs the validation. However, some clients do not support scripting or disable scripting. So, for security reasons, validation is always performed on the server too—whether or not scripting is enabled on the client. For this example, we assume the client has JavaScript enabled.

**_Validating Input in a Web Form_** The example in this section prompts the user to enter a name, e-mail address and phone number. A website could use a form like this to collect contact information from site vis- itors. After the user enters any data, but before the data is sent to the web server, validators ensure that the user entered a value in each field and that the e-mail address and phone number values are in an acceptable format. In this example, (555) 123-4567, 555-123- 4567 and 123-4567 are all considered valid phone numbers. Once the data is submitted, the web server responds by displaying an appropriate message and an XHTML table re- peating the submitted information. Note that a real business application would typically store the submitted data in a database or in a file on the server. We simply send the data back to the form to demonstrate that the server received the data.

Figure 25.17 presents the ASPX file. Like the Web Form in Fig. 25.13, this Web Form uses a table to organize the page’s contents. Lines 24–25, 36–37 and 58–59 define

**74** <Impressions>1</Impressions> **75** </Ad> **76 77** <Ad> **78** <ImageUrl>Images/thailand.png</ImageUrl> **79** <NavigateUrl>http://www.cia.gov/library/publications/ **80** the-world-factbook/geos/th.html **81** </NavigateUrl> **82** <AlternateText>Thailand Information</AlternateText> **83** <Impressions>1</Impressions> **84** </Ad> **85 86** <Ad> **87** <ImageUrl>Images/unitedstates.png</ImageUrl> **88** <NavigateUrl>http://www.cia.gov/library/publications/ **89** the-world-factbook/geos/us.html **90** </NavigateUrl> **91** <AlternateText>United States Information</AlternateText> **92** <Impressions>1</Impressions> **93** </Ad> **94** </Advertisements>

**Fig. 25.16** | XML file containing advertisement information used in AdRotator example. (Part 3 of 3.)  

**1036** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

TextBoxes for retrieving the user’s name, e-mail address and phone number, respectively, and line 78 defines a **Submit** button. Lines 80–82 create a Label named outputLabel that displays the response from the server when the user successfully submits the form. Notice that outputLabel’s **Visible** property is initially set to False (line 81), so the Label does not appear in the client’s browser when the page loads for the first time.

**_Using RequiredFieldValidator Controls_** In this example, we use three **RequiredFieldValidator** controls (found in the **Validation** section of the **Toolbox**) to ensure that the name, e-mail address and phone number Text- Boxes are not empty when the form is submitted. A RequiredFieldValidator makes an input control a required field. If such a field is empty, validation fails. For example, lines 26–30 define RequiredFieldValidator nameInputValidator, which confirms that nameTextBox is not empty. Line 28 associates nameTextBox with nameInputValidator by setting the validator’s **ControlToValidate** property to nameTextBox. This indicates that nameInputValidator verifies the nameTextBox’s contents. We set the value of this prop- erty (and the validator’s other properties) by selecting the validator in **Design** mode and using the **Properties** window to specify property values. Property **ErrorMessage**’s text (line 29) is displayed on the Web Form if the validation fails. If the user does not input any data in nameTextBox and attempts to submit the form, the ErrorMessage text is displayed in red. Because we set the validator’s **Display** property to Dynamic (line 28), the validator is displayed on the Web Form only when validation fails. Space is allocated dynamically when validation fails, causing the controls below the validator to shift downward to ac- commodate the ErrorMessage, as seen in Fig. 25.17(a)–(c).

**_Using RegularExpressionValidator Controls_** This example also uses **RegularExpressionValidator** controls to match the e-mail ad- dress and phone number entered by the user against regular expressions. These controls de- termine whether the e-mail address and phone number were each entered in a valid format. For example, lines 44–51 create a RegularExpressionValidator named emailFormat-

Validator. Line 46 sets property ControlToValidate to emailTextBox to indicate that emailFormatValidator verifies the emailTextBox’s contents.

**1** <%-- Fig. 25.17: Validation.aspx --%> **2** <%-- Form that demonstrates using validators to validate user input. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="Validation.aspx.vb" Inherits="Validation" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head runat="server"> **11** <title>Demonstrating Validation Controls</title> **12** </head> **13** <body> **14** <form id="form1" runat="server"> **15** <div>

**Fig. 25.17** | Form that demonstrates using validators to validate user input. (Part 1 of 4.)  

25.3 Web Controls **1037**

**16** Please fill out the following form.<br /><em>All fields are **17** required and must contain valid information.</em><br /> **18** <br /> **19** <table> **20** <tr> **21** <td style="width: 100px" valign="top"> **22** Name:</td> **23** <td style="width: 450px" valign="top"> **24** <asp:TextBox ID="nameTextBox" runat="server"> **25** </asp:TextBox><br /> **26 27 28 29 30 31** </td> **32** </tr> **33** <tr> **34** <td style="width: 100px" valign="top">E-mail address:</td> **35** <td style="width: 450px" valign="top"> **36** <asp:TextBox ID="emailTextBox" runat="server"> **37** </asp:TextBox> **38** &nbsp;e.g., user@domain.com<br /> **39 40 41 42 43 44 45 46 47 48 49 50 51 52** </td> **53** </tr> **54** <tr> **55** <td style="width: 100px; height: 21px" valign="top"> **56** Phone number:</td> **57** <td style="width: 450px; height: 21px" valign="top"> **58** <asp:TextBox ID="phoneTextBox" runat="server"> **59** </asp:TextBox> **60** &nbsp;e.g., (555) 555-1234<br /> **61 62 63 64 65 66 67 68**

**Fig. 25.17** | Form that demonstrates using validators to validate user input. (Part 2 of 4.)

<asp:RequiredFieldValidator ID="nameInputValidator" runat="server" ControlToValidate="nameTextBox" Display="Dynamic" ErrorMessage="Please enter your name.">

</asp:RequiredFieldValidator>

<asp:RequiredFieldValidator ID="emailInputValidator" runat="server" ControlToValidate="emailTextBox" Display="Dynamic" ErrorMessage="Please enter your e-mail address.">

</asp:RequiredFieldValidator> <asp:RegularExpressionValidator

ID="emailFormatValidator" runat="server" ControlToValidate="emailTextBox" Display="Dynamic" ErrorMessage=

"Please enter an e-mail address in a valid format." ValidationExpression=

"\\w+(\[-+.'\]\\w+)\*@\\w+(\[-.\]\\w+)\*\\.\\w+(\[-.\]\\w+)\*"> </asp:RegularExpressionValidator>

<asp:RequiredFieldValidator ID="phoneInputValidator" runat="server" ControlToValidate="phoneTextBox" Display="Dynamic" ErrorMessage="Please enter your phone number.">

</asp:RequiredFieldValidator> <asp:RegularExpressionValidator

ID="phoneFormatValidator" runat="server" ControlToValidate="phoneTextBox" Display="Dynamic"  

**1038** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**69 70 71 72 73 74** </td> **75** </tr> **76** </table> **77** <br /> **78** <asp:Button ID="submitButton" runat="server" Text="Submit" /><br /> **79** <br /> **80** <asp:Label ID="outputLabel" runat="server" **81** Text="Thank you for your submission." Visible="False"> **82** </asp:Label> **83** </div> **84** </form> **85** </body> **86** </html>

**Fig. 25.17** | Form that demonstrates using validators to validate user input. (Part 3 of 4.)

ErrorMessage= "Please enter a phone number in a valid format."

ValidationExpression= "((\\(\\d{3}\\) ?)|(\\d{3}-))?\\d{3}-\\d{4}">

</asp:RegularExpressionValidator>

(a)

(b)  

25.3 Web Controls **1039**

A RegularExpressionValidator’s **ValidationExpression** property specifies the reg- ular expression that validates the ControlToValidate’s contents. Clicking the ellipsis next to property ValidationExpression in the **Properties** window displays the **Regular Expres- sion Editor** dialog, which contains a list of **Standard expressions** for phone numbers, zip codes and other formatted information. You can also write your own custom expression. For the emailFormatValidator, we selected the standard expression **Internet e-mail address**, which uses the validation expression

\\w+(\[-+.'\]\\w+)\*@\\w+(\[-.\]\\w+)\*\\.\\w+(\[-.\]\\w+)\*

**Fig. 25.17** | Form that demonstrates using validators to validate user input. (Part 4 of 4.)

(c)

(d)  

**1040** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

This regular expression indicates that an e-mail address is valid if the part of the address before the @ symbol contains one or more word characters (i.e., alphanumeric characters or underscores), followed by zero or more strings comprised of a hyphen, plus sign, period or apostrophe and additional word characters. After the @ symbol, a valid e-mail address must contain one or more groups of word characters potentially separated by hyphens or periods, followed by a required period and another group of one or more word characters potentially separated by hyphens or periods. For example, bob.white@email.com, bob- white@my-email.com and bob's-personal.email@white.email.com are all valid e-mail addresses. If the user enters text in the emailTextBox that does not have the correct format and either clicks in a different text box or attempts to submit the form, the ErrorMessage text is displayed in red. You can learn more about regular expressions at www.regular- expressions.info.

We also use RegularExpressionValidator phoneFormatValidator (lines 66–73) to ensure that the phoneTextBox contains a valid phone number before the form is sub- mitted. In the **Regular Expression Editor** dialog, we select **U.S. phone number**, which assigns

((\\(\\d{3}\\) ?)|(\\d{3}-))?\\d{3}-\\d{4}

to the ValidationExpression property. This expression indicates that a phone number can contain a three-digit area code either in parentheses and followed by an optional space or without parentheses and followed by required hyphen. After an optional area code, a phone number must contain three digits, a hyphen and another four digits. For example, (555) 123-4567, 555-123-4567 and 123-4567 are all valid phone numbers.

If all five validators are successful (i.e., each TextBox is filled in, and the e-mail address and phone number provided are valid), clicking the **Submit** button sends the form’s data to the server. As shown in Fig. 25.17(d), the server then responds by displaying the sub- mitted data in the outputLabel (lines 80–82).

**_Examining the Code-Behind File for a Web Form That Receives User Input_** Figure 25.18 depicts the code-behind file for the ASPX file in Fig. 25.17. Notice that this code-behind file does not contain any implementation related to the validators. We say more about this soon.

**1** ' Fig. 25.18: Validation.aspx.vb **2** ' Code-behind file for the form demonstrating validation controls. **3** Partial Class Validation **4** Inherits System.Web.UI.Page **5 6** ' Page\_Load event handler executes when the page is loaded **7** Protected Sub Page\_Load(ByVal sender As Object, \_ **8** ByVal e As System.EventArgs) Handles Me.Load **9** ' if this is not the first time the page is loading

**10** ' (i.e., the user has already submitted form data) **11** If IsPostBack Then **12** ' retrieve the values submitted by the user **13** Dim name As String = nameTextBox.Text **14** Dim email As String = emailTextBox.Text

**Fig. 25.18** | Code-behind file for the form demonstrating validation controls. (Part 1 of 2.)  

25.3 Web Controls **1041**

Web programmers using ASP.NET often design their web pages so that the current page reloads when the user submits the form; this enables the program to receive input, process it as necessary and display the results in the same page when it is loaded the second time. These pages usually contain a form that, when submitted, sends the values of all the controls to the server and causes the current page to be requested again. This event is known as a **postback**. Line 11 uses the **IsPostBack** property of class Page to determine whether the page is being loaded due to a postback. The first time that the web page is requested, IsPostBack is False, and the page displays only the form for user input. When the postback occurs (from the user clicking **Submit**), IsPostBack is True.

Lines 13–15 retrieve the values of nameTextBox, emailTextBox and phoneTextBox. When data is posted to the web server, the XHTML form’s data is accessible to the web application through the properties of the ASP.NET controls. Lines 18–24 append to out-

putLabel’s Text a line break, an additional message and an XHTML table containing the submitted data, so the user knows that the server received the data correctly. In a real busi- ness application, the data would be stored in a database or file at this point in the applica- tion. Line 25 sets the outputLabel’s Visible property to True, so the user can see the thank you message and submitted data.

**_Examining the Client-Side XHTML for a Web Form with Validation_** Figure 25.19 shows the XHTML and ECMAScript sent to the client browser when Val-

idation.aspx loads after the postback. (We added the comments in lines 1–2.) To view this code, select **View > Source** in Internet Explorer. Lines 27–55, lines 126–190 and lines 196–212 contain the ECMAScript that provides the implementation for the validation controls and for performing the postback. ASP.NET generates this ECMAScript. You do not need to be able to create or even understand ECMAScript—the functionality defined for the controls in our application is converted to working ECMAScript for us.

The EnableViewState attribute determines whether a web control’s value is retained when a postback occurs. Previously, we explicitly set this attribute to False. The default value, True, indicates that the control’s value is retained. In Fig. 25.17(d), notice that the user input is retained after the postback occurs. A hidden input in the XHTML document (lines 17–25 of Fig. 25.19) contains the data of the controls on this page. This element is always named **\_\_VIEWSTATE** and stores the controls’ data as an encoded string.

**15** Dim phone As String = phoneTextBox.Text **16 17** ' create a table indicating the submitted values **18** outputLabel.Text &= \_ **19** "<br />We received the following information:" & \_ **20** "<table style=""background-color: yellow"">" & \_ **21** "<tr><td>Name: </td><td>" & name & "</td></tr>" & \_ **22** "<tr><td>E-mail address: </td><td>" & email & "</td></tr>" & \_ **23** "<tr><td>Phone number: </td><td>" & phone & "</td></tr>" & \_ **24** "<table>" **25** outputLabel.Visible = True ' display the output message **26** End If **27** End Sub ' Page\_Load **28** End Class ' Validation

**Fig. 25.18** | Code-behind file for the form demonstrating validation controls. (Part 2 of 2.)  

**1042** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**1** <!-- Fig. 25.19 --> **2** <!-- The XHTML and ECMAScript generated for Validation.aspx --> **3** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **4** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **5** <html xmlns="http://www.w3.org/1999/xhtml" > **6** <head> **7** <title>Demonstrating Validation Controls</title> **8** </head> **9** <body>

**10** <form name="form1" method="post" action="Validation.aspx" **11** onsubmit="javascript:return WebForm\_OnSubmit();" id="form1"> **12** <div> **13** <input type="hidden" name="\_\_EVENTTARGET" id="\_\_EVENTTARGET" **14** value="" /> **15** <input type="hidden" name="\_\_EVENTARGUMENT" id="\_\_EVENTARGUMENT" **16** value="" /> **17 18 19 20 21 22 23 24 25 26** </div> **27** <script type="text/javascript"> **28** <!-- **29** var theForm = document.forms\['form1'\]; **30** if (!theForm) { **31** theForm = document.form1; **32** } **33** function \_\_doPostBack(eventTarget, eventArgument) { **34** if (!theForm.onsubmit || (theForm.onsubmit() != false)) { **35** theForm.\_\_EVENTTARGET.value = eventTarget; **36** theForm.\_\_EVENTARGUMENT.value = eventArgument; **37** theForm.submit(); **38** } **39** } **40** // --> **41** </script> **42** <script src="/Validation/WebResource.axd?d=g4BXOwpt2-0jwFwNi7BCNQ2 **43** &amp;t=632670465355304640" type="text/javascript"></script> **44** <script src="/Validation/WebResource.axd?d=ZlFGPYdc0paOPqraRf9s2PN8QeuH **45** PzQxnkR5mPVtAVc1&amp;t=632670465355304640" **46** type="text/javascript"></script> **47** <script type="text/javascript"> **48** <!-- **49** function WebForm\_OnSubmit() { **50** if (typeof(ValidatorOnSubmit) == "function" && **51** ValidatorOnSubmit() == false) return false;

**Fig. 25.19** | XHTML and ECMAScript generated by ASP.NET and sent to the browser when Validation.aspx is requested. (Part 1 of 5.)

<input type="hidden" name="\_\_VIEWSTATE" id="\_\_VIEWSTATE" value="/wEPDwUJMzg4NDI1NzgzD2QWAgIDD2QWAgITDw8WBB4EVGV4dAWVAlRoY W5rIHlvdSBmb3IgeW91ciBzdWJtaXNzaW9uLjxiciAvPldlIHJlY2VpdmVkIHRoZ SBmb2xsb3dpbmcgaW5mb3JtYXRpb246PHRhYmxlIHN0eWxlPSJiYWNrZ3JvdW5kL WNvbG9yOiB5ZWxsb3ciPjx0cj48dGQ+TmFtZTogPC90ZD48dGQ+Qm9iIFdoaXRlP C90ZD48L3RyPjx0cj48dGQ+RS1tYWlsIGFkZHJlc3M6IDwvdGQ+PHRkPmJ3aGl0

ZUBlbWFpbC5jb208L3RkPjwvdHI+PHRyPjx0ZD5QaG9uZSBudW1iZXI6IDwvdGQ+ PHRkPig1NTUpIDU1NS0xMjM0PC90ZD48L3RyPjx0YWJsZT4eB1Zpc2libGVnZGRk qbjgKg1/lLZfogqihtkd1C7nmSk=" />  

25.3 Web Controls **1043**

**52** return true; **53** } **54** // --> **55** </script> **56** <div> **57** Please fill out the following form.<br /> **58** <em>All fields are required and must contain valid information. **59** </em><br /> **60** <br /> **61** <table> **62** <tr> **63** <td style="width: 100px" valign="top"> Name:</td> **64** <td style="width: 450px" valign="top"> **65** <input name="nameTextBox" type="text" value="Bob White" **66** id="nameTextBox" /> **67** <br /> **68** <span id="nameInputValidator" **69** style="color:Red;display:none;"> **70** Please enter your name.</span> </td> **71** </tr> **72** <tr> **73** <td style="width: 100px" valign="top">E-mail address:</td> **74** <td style="width: 450px" valign="top"> **75** <input name="emailTextBox" type="text" **76** value="bwhite@email.com" id="emailTextBox" /> **77** &nbsp;e.g., user@domain.com<br /> **78** <span id="emailInputValidator" **79** style="color:Red;display:none;"> **80** Please enter your e-mail address.</span> **81** <span id="emailFormatValidator" **82** style="color:Red;display:none;">Please enter an e-mail **83** address in a valid format.</span> </td> **84** </tr> **85** <tr> **86** <td style="width: 100px; height: 21px" valign="top"> **87** Phone number:</td> **88** <td style="width: 450px; height: 21px" valign="top"> **89** <input name="phoneTextBox" type="text" **90** value="(555) 555-1234" id="phoneTextBox" /> **91** &nbsp;e.g., (555) 555-1234<br /> **92** <span id="phoneInputValidator" **93** style="color:Red;display:none;"> **94** Please enter your phone number.</span> **95** <span id="phoneFormatValidator" **96** style="color:Red;display:none;">Please enter a phone **97** number in a valid format.</span> </td> **98** </tr> **99** </table> **100** <br /> **101** <input type="submit" name="submitButton" value="Submit" **102** onclick="javascript:WebForm\_DoPostBackWithOptions(

**Fig. 25.19** | XHTML and ECMAScript generated by ASP.NET and sent to the browser when Validation.aspx is requested. (Part 2 of 5.)  

**1044** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**103** new WebForm\_PostBackOptions(&quot;submitButton&quot;, **104** &quot;&quot;, true, &quot;&quot;, &quot;&quot;, false, **105** false))" id="submitButton" /> **106** <br /> **107** <br /> **108** <span id="outputLabel">Thank you for your submission.<br /> **109** We received the following information: **110** <table style="background-color: yellow"> **111** <tr> **112** <td>Name: </td> **113** <td>Bob White</td> **114** </tr> **115** <tr> **116** <td>E-mail address: </td> **117** <td>bwhite@email.com</td> **118** </tr> **119** <tr> **120** <td>Phone number: </td> **121** <td>(555) 555-1234</td> **122** </tr> **123** <table> **124** </span> **125** </div> **126** <script type="text/javascript"> **127** <!-- **128** var Page\_Validators = new Array( **129** document.getElementById("nameInputValidator"), **130** document.getElementById("emailInputValidator"), **131** document.getElementById("emailFormatValidator"), **132** document.getElementById("phoneInputValidator"), **133** document.getElementById("phoneFormatValidator")); **134** // --> **135** </script> **136** <script type="text/javascript"> **137** <!-- **138** var nameInputValidator = document.all ? **139** document.all\["nameInputValidator"\] : **140** document.getElementById("nameInputValidator"); **141** nameInputValidator.controltovalidate = "nameTextBox"; **142** nameInputValidator.errormessage = "Please enter your name."; **143** nameInputValidator.display = "Dynamic"; **144** nameInputValidator.evaluationfunction = **145** "RequiredFieldValidatorEvaluateIsValid"; **146** nameInputValidator.initialvalue = ""; **147** var emailInputValidator = document.all ? **148** document.all\["emailInputValidator"\] : **149** document.getElementById("emailInputValidator"); **150** emailInputValidator.controltovalidate = "emailTextBox"; **151** emailInputValidator.errormessage = **152** "Please enter your e-mail address."; **153** emailInputValidator.display = "Dynamic";

**Fig. 25.19** | XHTML and ECMAScript generated by ASP.NET and sent to the browser when Validation.aspx is requested. (Part 3 of 5.)  

25.3 Web Controls **1045**

**154** emailInputValidator.evaluationfunction = **155** "RequiredFieldValidatorEvaluateIsValid"; **156** emailInputValidator.initialvalue = ""; **157** var emailFormatValidator = document.all ? **158** document.all\["emailFormatValidator"\] : **159** document.getElementById("emailFormatValidator"); **160** emailFormatValidator.controltovalidate = "emailTextBox"; **161** emailFormatValidator.errormessage = **162** "Please enter an e-mail address in a valid format."; **163** emailFormatValidator.display = "Dynamic"; **164** emailFormatValidator.evaluationfunction = **165** "RegularExpressionValidatorEvaluateIsValid"; **166** emailFormatValidator.validationexpression = **167** "\\\\w+(\[-+.\\'\]\\\\w+)\*@\\\\w+(\[-.\]\\\\w+)\*\\\\.\\\\w+(\[-.\]\\\\w+)\*"; **168** var phoneInputValidator = document.all ? **169** document.all\["phoneInputValidator"\] : **170** document.getElementById("phoneInputValidator"); **171** phoneInputValidator.controltovalidate = "phoneTextBox"; **172** phoneInputValidator.errormessage = **173** "Please enter your phone number."; **174** phoneInputValidator.display = "Dynamic"; **175** phoneInputValidator.evaluationfunction = **176** "RequiredFieldValidatorEvaluateIsValid"; **177** phoneInputValidator.initialvalue = ""; **178** var phoneFormatValidator = document.all ? **179** document.all\["phoneFormatValidator"\] : **180** document.getElementById("phoneFormatValidator"); **181** phoneFormatValidator.controltovalidate = "phoneTextBox"; **182** phoneFormatValidator.errormessage = **183** "Please enter a phone number in a valid format."; **184** phoneFormatValidator.display = "Dynamic"; **185** phoneFormatValidator.evaluationfunction = **186** "RegularExpressionValidatorEvaluateIsValid"; **187** phoneFormatValidator.validationexpression = **188** "((\\\\(\\\\d{3}\\\\) ?)|(\\\\d{3}-))?\\\\d{3}-\\\\d{4}"; **189** // --> **190** </script> **191** <div> **192** <input type="hidden" name="\_\_EVENTVALIDATION" id="\_\_EVENTVALIDATION" **193** value="/wEWBQL6jZCbCAKLsYSOBwKCkfPgDAKE8IO1CQKSuuDUC0eNO370TaQqZQ **194** 0WPApD0KktGC5N" /> **195** </div> **196** <script type="text/javascript"> **197** <!-- **198** var Page\_ValidationActive = false; **199** if (typeof(ValidatorOnLoad) == "function") { **200** ValidatorOnLoad(); **201** } **202 203** function ValidatorOnSubmit() { **204** if (Page\_ValidationActive) {

**Fig. 25.19** | XHTML and ECMAScript generated by ASP.NET and sent to the browser when Validation.aspx is requested. (Part 4 of 5.)  

**1046** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**Performance Tip 25.1** _Setting EnableViewState to False reduces the amount of data passed to the web server with each request._ 25.1

**Software Engineering Observation 25.2** _Client-side validation cannot be trusted by the server because there are too many ways top circumvent client-side validation. For this reason, all important validation should be peformed on the server._ 25.2

**25.4 Session Tracking** Originally, critics accused the Internet and e-businesses of failing to provide the kind of customized service typically experienced in “brick-and-mortar” stores. To address this problem, e-businesses began to establish mechanisms by which they could personalize us- ers’ browsing experiences, tailoring content to individual users while enabling them to by- pass irrelevant information. Businesses achieve this level of service by tracking each customer’s movement through the Internet and combining the collected data with infor- mation provided by the consumer, including billing information, personal preferences, in- terests and hobbies.

**_Personalization_ Personalization** makes it possible for e-businesses to communicate effectively with their customers and also improves users’ ability to locate desired products and services. Compa- nies that provide content of particular interest to users can establish relationships with cus- tomers and build on those relationships over time. Furthermore, by targeting consumers with personal offers, recommendations, advertisements, promotions and services, e-busi- nesses create customer loyalty. Websites can use sophisticated technology to allow visitors to customize home pages to suit their individual needs and preferences. Similarly, online shopping sites often store personal information for customers, tailoring notifications and special offers to their interests. Such services encourage customers to visit sites more fre- quently and make purchases more regularly.

**205** return ValidatorCommonOnSubmit(); **206** } **207** else { **208** return true; **209** } **210** } **211** // --> **212** </script> **213** </form> **214** </body> **215** </html>

**Fig. 25.19** | XHTML and ECMAScript generated by ASP.NET and sent to the browser when Validation.aspx is requested. (Part 5 of 5.)  

25.4 Session Tracking **1047**

**_Privacy_** A trade-off exists, however, between personalized e-business service and protection of pri- vacy. Some consumers embrace the idea of tailored content, but others fear the possible adverse consequences if the info they provide to e-businesses is released or collected by tracking technologies. Consumers and privacy advocates ask: What if the e-business to which we give personal data sells or gives that information to another organization without our knowledge? What if we do not want our actions on the Internet—a supposedly anon- ymous medium—to be tracked and recorded by unknown parties? What if unauthorized parties gain access to sensitive private data, such as credit card numbers or medical history? All of these are questions that must be debated and addressed by programmers, consumers, e-businesses and lawmakers alike.

**_Recognizing Clients_** To provide personalized services to consumers, e-businesses must be able to recognize cli- ents when they request information from a site. As we have discussed, the request/response system on which the web operates is facilitated by HTTP. Unfortunately, HTTP is a state- less protocol. This means that web servers cannot determine whether a request comes from a particular client or whether the same or different clients generate a series of requests.

To circumvent this problem, sites can use the concept of a “session” to identify indi- vidual clients. A session represents a unique client on a website. If the client leaves a site and then returns later, the client will still be recognized as the same user. To help the server distinguish among clients, each client must identify itself to the server. Tracking indi- vidual clients, known as **session tracking**, can be achieved in a number of ways. One pop- ular technique uses cookies (Section 25.4.1); another uses ASP.NET’s HttpSessionState object (Section 25.4.2). Additional session-tracking techniques include the use of input form elements of type "hidden" and URL rewriting. Using "hidden" form elements, a Web Form can write session-tracking data into a form in the web page that it returns to the client in response to a prior request. When the user submits the form in the new web page, all the form data, including the "hidden" fields, is sent to the form handler on the web server. When a website performs URL rewriting, the Web Form embeds session- tracking information directly in the URLs of hyperlinks that the user clicks to send subse- quent requests to the web server.

Note that our previous examples set the Web Form’s EnableSessionState property to False. However, because we wish to use session tracking in the following examples, we keep this property’s default setting—True.

**25.4.1 Cookies Cookies** provide web developers with a tool for identifying and tracking web users. A cookie is a piece of data stored in a small text file on the user’s computer. A cookie main- tains information about the client during and between browser sessions. The first time a user visits the website, the user’s computer might receive a cookie; this cookie is then re- trieved each time the user revisits that site. The collected information is intended to be an anonymous record containing data that is used to personalize the user’s future visits to the site. For example, cookies in a shopping application might store unique identifiers for us- ers. When a user adds items to an online shopping cart or performs another task resulting in a request to the web server, the server receives a cookie containing the user’s unique  

**1048** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

identifier. The server then uses the unique identifier to locate the shopping cart and per- form any necessary processing.

In addition to identifying users, cookies also can indicate users’ shopping preferences. When a web server receives a request from a client, the server can examine the cookie(s) it sent to the client during previous communications, identify the users’s preferences and immediately return products of interest to the client.

Every HTTP-based interaction between a client and a server includes a header con- taining information either about the request (when the communication is from the client to the server) or about the response (when the communication is from the server to the client). When a web server receives a request, the header includes information such as the request type (e.g., Get) and any cookies that have been sent previously from the server to be stored on the client machine. When the server formulates its response, the header infor- mation contains any cookies the server wants to store on the client computer and other information, such as the MIME type of the response.

The **expiration date** of a cookie determines how long the cookie remains on the client’s computer. If you do not set an expiration date for a cookie, the web browser main- tains the cookie for the duration of the browsing session. Otherwise, the Web browser maintains the cookie until the expiration date occurs. When the browser requests a resource from a web server, cookies previously sent to the client by that Web server are returned to the web server as part of the request formulated by the browser. Cookies are deleted when they **expire**.

**Portability Tip 25.3** _Users may disable cookies in their browsers to ensure that their privacy is protected. Such users will experience difficulty using sites that depend on cookies to maintain state information._ 25.3

**_Using Cookies to Provide Book Recommendations_** The next web application demonstrates the use of cookies. The example contains two pages. In the first page (Figs. 25.20–25.21), users select a favorite programming language from a group of radio buttons and submit the XHTML form to the web server for pro- cessing. The web server responds by creating a cookie that stores a record of the chosen language, as well as the ISBN number for a book on that topic. The server then returns an XHTML document to the browser, allowing the user either to select another favorite pro- gramming language or to view the second page in our application (Figs. 25.22–25.23), which lists recommended books pertaining to the programming language that the user se- lected previously. When the user clicks the hyperlink, the cookies previously stored on the client are read and used to form the list of book recommendations.

The ASPX file in Fig. 25.20 contains five radio buttons (lines 20–26) with the values **Visual Basic 2005**, **Visual C# 2005**, **C**, **C++**, and **Java**. Recall that you can set the values of radio buttons via the **ListItem Collection Editor**, which you open either by clicking the RadioButtonList’s Items property in the **Properties** window or by clicking the **Edit Items…** link in the **RadioButtonList Tasks** smart tag menu. The user selects a programming language by clicking one of the radio buttons. When the user clicks **Submit**, we’ll create a cookie containing the selected language. Then, we’ll add this cookie to the HTTP response header, so the cookie will be stored on the user’s computer. Each time the user chooses a language and clicks **Submit**, a cookie is written to the client. Each time the client requests information from our web application, the cookies are sent back to the server.  

25.4 Session Tracking **1049**

When the postback occurs, certain controls are hidden and others are displayed. The Label, RadioButtonList and Button used to select a language are hidden. Toward the bottom of the page, a Label and two HyperLinks are displayed. One link requests this page (lines 32–35), and the other requests Recommendations.aspx (lines 37–40). Clicking the first hyperlink (the one that requests the current page) does not cause a postback to occur. The file Options.aspx is specified in the NavigateUrl property of the hyperlink. When the hyperlink is clicked, a new request for this page occurs. Recall that earlier in the chapter, we set NavigateUrl to a remote website (http://www.deitel.com). To set this property to a page within the same ASP.NET application, click the ellipsis button next to the NavigateUrl property in the **Properties** window to open the **Select URL** dialog. Use this dialog to select a page within your project as the destination for the HyperLink.

**1** <%-- Fig. 25.20: Options.aspx --%> **2** <%-- Allows client to select programming languages and access --%> **3** <%-- book recommendations. --%> **4** <%@ Page Language="VB" AutoEventWireup="false" **5** CodeFile="Options.aspx.vb" Inherits="Options" %> **6 7** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **8** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **9**

**10** <html xmlns="http://www.w3.org/1999/xhtml" > **11** <head runat="server"> **12** <title>Cookies</title> **13** </head> **14** <body> **15** <form id="form1" runat="server"> **16** <div> **17** <asp:Label ID="promptLabel" runat="server" Font-Bold="True" **18** Font-Size="Large" Text="Select a programming language:"> **19** </asp:Label> **20 21 22 23 24 25 26 27** <asp:Button ID="submitButton" runat="server" Text="Submit" /> **28** <asp:Label ID="responseLabel" runat="server" Font-Bold="True" **29** Font-Size="Large" Text="Welcome to cookies!" Visible="False"> **30** </asp:Label><br /> **31** <br /> **32 33 34 35 36** <br /> **37 38**

**Fig. 25.20** | ASPX file that presents a list of programming languages. (Part 1 of 2.)

<asp:RadioButtonList ID="languageList" runat="server"> <asp:ListItem>Visual Basic 2005</asp:ListItem> <asp:ListItem>Visual C# 2005</asp:ListItem> <asp:ListItem>C</asp:ListItem> <asp:ListItem>C++</asp:ListItem> <asp:ListItem>Java</asp:ListItem>

</asp:RadioButtonList>

<asp:HyperLink ID="languageLink" runat="server" NavigateUrl="~/Options.aspx" Visible="False"> Click here to choose another language

</asp:HyperLink><br />

<asp:HyperLink ID="recommendationsLink" runat="server" NavigateUrl="~/Recommendations.aspx" Visible="False">  

**1050** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**_Adding and Linking to a New Web Form_** Setting the NavigateUrl property to a page in the current application requires that the destination page exist already. Thus, to set the NavigateUrl property of the second link (the one that requests the page with book recommendations) to Recommendations.aspx, you must first create this file by right clicking the project location in the **Solution Explorer** and selecting **Add New Item…** from the menu that appears. In the **Add New Item** dialog, select **Web Form** from the **Templates** pane and change the name of the file to Recommen-

dations.aspx. Finally, check the box labeled **Place code in separate file** to indicate that the IDE should create a code-behind file for this ASPX file. Click **Add** to create the file. (We discuss the contents of this ASPX file and code-behind file shortly.) Once the Recom- mendations.aspx file exists, you can select it as the NavigateUrl value for a HyperLink in the **Select URL** dialog.

**39 40 41** </div> **42** </form> **43** </body> **44** </html>

**Fig. 25.20** | ASPX file that presents a list of programming languages. (Part 2 of 2.)

Click here to get book recommendations </asp:HyperLink>

(a) (b)

(c) (d)  

25.4 Session Tracking **1051**

**_Writing Cookies in a Code-Behind File_** Figure 25.21 presents the code-behind file for Options.aspx (Fig. 25.20). This file con- tains the code that writes a cookie to the client machine when the user selects a program- ming language. The code-behind file also modifies the appearance of the page in response to a postback.

**1** ' Fig. 25.21: Options.aspx.vb **2** ' Processes user's selection of a programming language **3** ' by displaying links and writing a cookie to the user's machine. **4** Partial Class Options **5** Inherits System.Web.UI.Page **6 7 8 9** ' initializes the Hashtable of values to be stored as cookies

**10** Protected Sub Page\_Init(ByVal sender As Object, \_ **11** ByVal e As System.EventArgs) Handles Me.Init **12 13 14 15 16 17** End Sub ' Page\_Init **18 19** ' if postback, hide form and display links to make additional **20** ' selections or view recommendations **21** Protected Sub Page\_Load(ByVal sender As Object, \_ **22** ByVal e As System.EventArgs) Handles Me.Load **23 24** If IsPostBack Then **25** ' user has submitted information, so display message **26** ' and appropriate hyperlinks **27** responseLabel.Visible = True **28** languageLink.Visible = True **29** recommendationsLink.Visible = True **30 31** ' hide other controls used to make language selection **32** promptLabel.Visible = False **33** languageList.Visible = False **34** submitButton.Visible = False **35 36 37 38 39 40 41 42 43** End If **44** End Sub ' Page\_Load **45**

**Fig. 25.21** | Code-behind file that writes a cookie to the client. (Part 1 of 2.)

' stores values to represent books as cookies Private books As New System.Collections.Hashtable()

books.Add("Visual Basic 2005", "0-13-186900-0") books.Add("Visual C# 2005", "0-13-152523-9") books.Add("C", "0-13-142644-3") books.Add("C++", "0-13-185757-6") books.Add("Java", "0-13-148398-6")

' if the user made a selection, display it in responseLabel If languageList.SelectedItem IsNot Nothing Then

responseLabel.Text &= " You selected " & \_ languageList.SelectedItem.Text.ToString()

Else responseLabel.Text &= " You did not select a language."

End If  

**1052** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Line 7 creates variable books as a **Hashtable** (namespace System.Collections)—a data structure that stores **key–value pairs**. A program uses the key to store and retrieve the associated value in the Hashtable. In this example, the keys are strings containing the programming languages’ names, and the values are strings containing the ISBN numbers for the recommended books. Class Hashtable provides method **Add**, which takes as argu- ments a key and a value. A value that is added via method Add is placed in the Hashtable

at a location determined by the key. The value for a specific Hashtable entry can be deter- mined by indexing the Hashtable with that value’s key. The expression

_HashtableName_(_keyName_)

returns the value in the key–value pair in which _keyName_ is the key. For example, the ex- pression books(language) in line 54 returns the value that corresponds to the key con- tained in language.

Clicking the **Submit** button creates a cookie if a language is selected and causes a post- back to occur. In the submitButton\_Click event handler (lines 47–62), a new cookie object (of type **HttpCookie**) is created to store the language and its corresponding ISBN

number (line 57). This cookie is then Added to the **Cookies** collection sent as part of the HTTP response header (line 60). The postback causes the condition in the If statement of Page\_Load (line 24) to evaluate to True, and lines 27–42 execute. Lines 27–29 reveal the initially hidden controls responseLabel, languageLink and recommendationsLink. Lines 32–34 hide the controls used to obtain the user’s language selection. Line 37 deter- mines whether the user selected a language. If so, that language is displayed in response-

Label (lines 38–39). Otherwise, text indicating that a language was not selected is displayed in responseLabel (line 41).

**_Displaying Book Recommendations Based on Cookie Values_** After the postback of Options.aspx, the user may request a book recommendation. The book recommendation hyperlink forwards the user to Recommendations.aspx

(Fig. 25.22) to display the recommendations based on the user’s language selections.

**46** ' write a cookie to record the user's selection **47** Protected Sub submitButton\_Click(ByVal sender As Object, \_ **48** ByVal e As System.EventArgs) Handles submitButton.Click **49** ' if the user made a selection **50** If languageList.SelectedItem IsNot Nothing Then **51** Dim language As String = languageList.SelectedItem.ToString() **52 53 54 55 56 57 58 59 60 61** End If **62** End Sub ' submitButton\_Click **63** End Class ' Options

**Fig. 25.21** | Code-behind file that writes a cookie to the client. (Part 2 of 2.)

' get ISBN number of book for the given language Dim ISBN As String = books(language).ToString()

' create cookie using language-ISBN name-value pair Dim cookie As New HttpCookie(language, ISBN)

' add cookie to response to place it on the user's machine Response.Cookies.Add(cookie)  

25.4 Session Tracking **1053**

Recommendations.aspx contains a Label (lines 16–18), a ListBox (lines 20–21) and a HyperLink (lines 23–26). The Label displays the text **Recommendations** if the user selects one or more languages; otherwise, it displays **No Recommendations**. The ListBox

**1** <%-- Fig. 25.22: Recommendations.aspx --%> **2** <%-- Displays book recommendations using cookies. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="Recommendations.aspx.vb" Inherits="Recommendations" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head runat="server"> **11** <title>Book Recommendations</title> **12** </head> **13** <body> **14** <form id="form1" runat="server"> **15** <div> **16** <asp:Label ID="recommendationsLabel" runat="server" **17** Font-Bold="True" Font-Size="X-Large" Text="Recommendations"> **18** </asp:Label><br /> **19** <br /> **20 21 22** <br /> **23** <asp:HyperLink ID="languageLink" runat="server" **24** NavigateUrl="~/Options.aspx"> **25** Click here to choose another language **26** </asp:HyperLink>&nbsp;</div> **27** </form> **28** </body> **29** </html>

**Fig. 25.22** | ASPX file that displays book recommendations based on cookies.

<asp:ListBox ID="booksListBox" runat="server" Height="125px" Width="450px"></asp:ListBox><br />  

**1054** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

displays the recommendations specified by the code-behind file (Fig. 25.23). The Hyper-

Link allows the user to return to Options.aspx to select additional languages.

**_Code-Behind File That Creates Book Recommendations from Cookies_** In the code-behind file (Fig. 25.23), method Page\_Init (lines 7–28) retrieves the cookies from the client, using the Request object’s **Cookies** property (line 10). This returns a col- lection of type **HttpCookieCollection**, containing cookies that have previously been writ- ten to the client. Cookies can be read by an application only if they were created in the domain in which the application is running—a web server can never access cookies created outside the domain associated with that server. For example, a cookie created by a web server in the deitel.com domain cannot be read by a web server in any other domain. \[_Note:_ Depending on the settings in web.config and whether other pages store cookies, other cookie values may be displayed by this web application.\]

Line 13 determines whether at least one cookie exists. Lines 14–17 add the informa- tion in the cookie(s) to the booksListBox. The loop retrieves the name and value of each cookie using i, the loop’s control variable, to determine the current value in the cookie collection. The **Name** and **Value** properties of class HttpCookie, which contain the lan- guage and corresponding ISBN, respectively, are concatenated with " How to Program.

**1** ' Fig. 25.23: Recommendations.aspx.vb **2** ' Creates book recommendations based on cookies. **3** Partial Class Recommendations **4** Inherits System.Web.UI.Page **5 6** ' read cookies and populate ListBox with any book recommendations **7** Protected Sub Page\_Init(ByVal sender As Object, \_ **8** ByVal e As System.EventArgs) Handles Me.Init **9**

**10 11 12** ' if there are cookies, list the appropriate books and ISBN numbers **13** If <> 0 Then **14** For i As Integer = 0 To - 1 **15 16 17** Next **18** Else **19** ' if there are no cookies, then no language was chosen, so **20** ' display appropriate message and clear and hide booksListBox **21** recommendationsLabel.Text = "No Recommendations" **22** booksListBox.Items.Clear() **23** booksListBox.Visible = False **24 25** ' modify languageLink because no language was selected **26** languageLink.Text = "Click here to choose a language" **27** End If **28** End Sub ' Page\_Init **29** End Class ' Recommendations

**Fig. 25.23** | Reading cookies from a client to determine book recommendations.

' retrieve client's cookies Dim cookies As HttpCookieCollection = Request.Cookies

cookies.Count cookies.Count

booksListBox.Items.Add(cookies(i).Name & \_ " How to Program. ISBN#: " & cookies(i).Value)  

25.4 Session Tracking **1055**

ISBN# " and added to the ListBox. Lines 21–26 execute if no language was selected. We summarize some commonly used HttpCookie properties in Fig. 25.24.

**25.4.2 Session Tracking with HttpSessionState** Session-tracking capabilities are provided by the FCL class **HttpSessionState**. To dem- onstrate basic session-tracking techniques, we modified the example of Figs. 25.20–25.23 to use HttpSessionState objects. Figures 25.25–25.26 present the ASPX file and code- behind file for Options.aspx. Figures 25.28–25.29 present the ASPX file and code-be- hind file for Recommendations.aspx. Options.aspx is similar to the version presented in Fig. 25.20, but Fig. 25.25 contains two additional Labels (lines 32–33 and lines 35–36), which we discuss shortly.

Every Web Form includes an HttpSessionState object, which is accessible through property **Session** of class Page. Throughout this section, we use property Session to manipulate our page’s HttpSessionState object. When the web page is requested, an HttpSessionState object is created and assigned to the Page’s Session property. As a result, we often refer to property Session as the Session object.

**_Adding Session Items_** When the user presses **Submit** on the Web Form, submitButton\_Click is invoked in the code-behind file (Fig. 25.26, lines 55–66). Method submitButton\_Click responds by adding a key–value pair to our Session object, specifying the language chosen and the ISBN number for a book on that language. These key–value pairs are often referred to as

Properties Description

Domain Returns a String containing the cookie’s domain (i.e., the domain of the web server running the application that wrote the cookie). This determines which web servers can receive the cookie. By default, cookies are sent to the web server that originally sent the cookie to the client. Changing the Domain property causes the cookie to be returned to a web server other than the one that origi- nally wrote it.

Expires Returns a DateTime object indicating when the browser can delete the cookie.

Name Returns a String containing the cookie’s name.

Path Returns a String containing the path to a directory on the server (i.e., the Domain) to which the cookie applies. Cookies can be “targeted” to specific direc- tories on the web server. By default, a cookie is returned only to applications operating in the same directory as the application that sent the cookie or a sub- directory of that directory. Changing the Path property causes the cookie to be returned to a directory other than the one from which it was originally written.

Secure Returns a Boolean value indicating whether the cookie should be transmitted through a secure protocol. The value True causes a secure protocol to be used.

Value Returns a String containing the cookie’s value.

**Fig. 25.24** | HttpCookie properties.  

**1056** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**session items**. Next, a postback occurs. Each time the user clicks **Submit**, submitButton\_Click adds a new session item to the HttpSessionState object. Because much of this example is identical to the last example, we concentrate on the new features.

**1** <%-- Fig. 25.25: Options.aspx --%> **2** <%-- Allows client to select programming languages and access --%> **3** <%-- book recommendations. --%> **4** <%@ Page Language="VB" AutoEventWireup="false" **5** CodeFile="Options.aspx.vb" Inherits="Options" %> **6 7** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **8** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **9**

**10** <html xmlns="http://www.w3.org/1999/xhtml" > **11** <head id="Head1" runat="server"> **12** <title>Sessions</title> **13** </head> **14** <body> **15** <form id="form1" runat="server"> **16** <div> **17** <asp:Label ID="promptLabel" runat="server" Font-Bold="True" **18** Font-Size="Large" Text="Select a programming language:"> **19** </asp:Label> **20** <asp:RadioButtonList ID="languageList" runat="server"> **21** <asp:ListItem>Visual Basic 2005</asp:ListItem> **22** <asp:ListItem>Visual C# 2005</asp:ListItem> **23** <asp:ListItem>C</asp:ListItem> **24** <asp:ListItem>C++</asp:ListItem> **25** <asp:ListItem>Java</asp:ListItem> **26** </asp:RadioButtonList> **27** <asp:Button ID="submitButton" runat="server" Text="Submit" /> **28** <asp:Label ID="responseLabel" runat="server" Font-Bold="True" **29** Font-Size="Large" Text="Welcome to sessions!" Visible="False"> **30** </asp:Label><br /> **31** <br /> **32 33 34** <br /> **35 36 37** <br /> **38** <asp:HyperLink ID="languageLink" runat="server" **39** NavigateUrl="~/Options.aspx" Visible="False"> **40** Click here to choose another language **41** </asp:HyperLink><br /> **42** <br /> **43** <asp:HyperLink ID="recommendationsLink" runat="server" **44** NavigateUrl="~/Recommendations.aspx" Visible="False"> **45** Click here to get book recommendations **46** </asp:HyperLink> **47** </div> **48** </form>

**Fig. 25.25** | ASPX file that presents a list of programming languages. (Part 1 of 2.)

<asp:Label ID="idLabel" runat="server" Visible="False"> </asp:Label><br />

<asp:Label ID="timeoutLabel" runat="server" Visible="False"> </asp:Label><br />  

25.4 Session Tracking **1057**

**Software Engineering Observation 25.3** _A Web Form should not use instance variables to maintain client state information, because each new request or postback is handled by a new instance of the page. Instead, maintain client state information in HttpSessionState objects, because such objects are specific to each client._ 25.3

Like a cookie, an HttpSessionState object can store name–value pairs. These session items are placed in an HttpSessionState object by calling method **Add**. Line 64 calls Add to place the language and its corresponding recommended book’s ISBN number in the HttpSessionState object. If the application calls method Add to add an attribute that has the same name as an attribute previously stored in a session, the object associated with that attribute is replaced.

**Software Engineering Observation 25.4** _A benefit of using HttpSessionState objects (rather than cookies) is that HttpSessionState objects can store any type of object (not just Strings) as attribute values. This provides you with increased flexibility in determining the type of state information to maintain for clients._ 25.4

**49** </body> **50** </html>

**Fig. 25.25** | ASPX file that presents a list of programming languages. (Part 2 of 2.)

(a) (b)

(c) (d)  

**1058** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**1** ' Fig. 25.26: Options.aspx.vb **2** ' Processes user's selection of a programming language **3** ' by displaying links and writing information in a Session object. **4** Partial Class Options **5** Inherits System.Web.UI.Page **6** ' stores values to represent books **7** Private books As New System.Collections.Hashtable() **8 9** ' initializes the Hashtable of values to be stored in a Session

**10** Protected Sub Page\_Init(ByVal sender As Object, \_ **11** ByVal e As System.EventArgs) Handles Me.Init **12** books.Add("Visual Basic 2005", "0-13-186900-0") **13** books.Add("Visual C# 2005", "0-13-152523-9") **14** books.Add("C", "0-13-142644-3") **15** books.Add("C++", "0-13-185757-6") **16** books.Add("Java", "0-13-148398-6") **17** End Sub ' Page\_Init **18 19** ' if postback, hide form and display links to make additional **20** ' selections or view recommendations **21** Protected Sub Page\_Load(ByVal sender As Object, \_ **22** ByVal e As System.EventArgs) Handles Me.Load **23 24** If IsPostBack Then **25** ' user has submitted information, so display message **26** ' and appropriate hyperlinks **27** responseLabel.Visible = True **28** idLabel.Visible = True **29** timeoutLabel.Visible = True **30** languageLink.Visible = True **31** recommendationsLink.Visible = True **32 33** ' hide other controls used to make language selection **34** promptLabel.Visible = False **35** languageList.Visible = False **36** submitButton.Visible = False **37 38** ' if the user made a selection, display it in responseLabel **39** If languageList.SelectedItem IsNot Nothing Then **40** responseLabel.Text &= " You selected " & \_ **41** languageList.SelectedItem.Text.ToString() **42** Else **43** responseLabel.Text &= " You did not select a language." **44** End If **45 46 47 48 49 50 51** End If **52** End Sub ' Page\_Load

**Fig. 25.26** | Processes user's selection of a programming language by displaying links and writing information in a Session object. (Part 1 of 2.)

' display session ID idLabel.Text = "Your unique session ID is: " & Session.SessionID

' display the timeout timeoutLabel.Text = "Timeout: " & Session.Timeout & " minutes."  

25.4 Session Tracking **1059**

The application handles the postback event (lines 24–51) in method Page\_Load. Here, we retrieve information about the current client’s session from the Session object’s properties and display this information in the web page. The ASP.NET application con- tains information about the HttpSessionState object for the current client. Property **SessionID** (line 47) contains the **unique session ID**—a sequence of random letters and numbers. The first time a client connects to the web server, a unique session ID is created for that client and a temporary cookie is written to the client so the server can identify the client on subsequent requests. When the client makes additional requests, the client’s ses- sion ID from that temporary cookie is compared with the session IDs stored in the web server’s memory to retrieve the client’s HttpSessionState object. Recall that clients may disable cookies in their web browsers to ensure that their privacy is protected. Such clients will experience difficulty using web applications that depend on HttpSessionState

objects and cookies to maintain state information. The HttpSessionStrate property IsCookieless indicates whether URL rewriting or cookies are used for session tracking. Property **Timeout** (line 50) specifies the maximum amount of time that an Http-

SessionState object can be inactive before it is discarded. Figure 25.27 lists some common HttpSessionState properties.

**53 54** ' record the user's selection in the Session **55** Protected Sub submitButton\_Click(ByVal sender As Object, \_ **56** ByVal e As System.EventArgs) Handles submitButton.Click **57** ' if the user made a selection **58** If languageList.SelectedItem IsNot Nothing Then **59** Dim language As String = languageList.SelectedItem.ToString() **60 61** ' get ISBN number of book for the given language **62** Dim ISBN As String = books(language).ToString() **63 64 65** End If **66** End Sub ' submitButton\_Click **67** End Class ' Options

Properties Description

Count Specifies the number of key–value pairs in the Session object.

IsNewSession Indicates whether this is a new session (i.e., whether the session was cre- ated during loading of this page).

IsReadOnly Indicates whether the Session object is read-only.

**Fig. 25.27** | HttpSessionState properties. (Part 1 of 2.)

**Fig. 25.26** | Processes user's selection of a programming language by displaying links and writing information in a Session object. (Part 2 of 2.)

Session.Add(language, ISBN) ' add name/value pair to Session  

**1060** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**_Displaying Recommendations Based on Session Values_** As in the cookies example, this application provides a link to Recommendations.aspx

(Fig. 25.28), which displays a list of book recommendations based on the user’s language selections. Lines 20–21 define a ListBox web control that is used to present the recom- mendations to the user.

Keys Returns a collection containing the Session object’s keys.

SessionID Returns the session’s unique ID.

Timeout Specifies the maximum number of minutes during which a session can be inactive (i.e., no requests are made) before the session expires. By default, this property is set to 20 minutes.

**1** <%-- Fig. 25.28: Recommendations.aspx --%> **2** <%-- Displays book recommendations using a Session object. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="Recommendations.aspx.vb" Inherits="Recommendations" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head id="Head1" runat="server"> **11** <title>Book Recommendations</title> **12** </head> **13** <body> **14** <form id="form1" runat="server"> **15** <div> **16** <asp:Label ID="recommendationsLabel" runat="server" **17** Font-Bold="True" Font-Size="X-Large" Text="Recommendations"> **18** </asp:Label><br /> **19** <br /> **20** <asp:ListBox ID="booksListBox" runat="server" Height="125px" **21** Width="450px"></asp:ListBox><br /> **22** <br /> **23** <asp:HyperLink ID="languageLink" runat="server" **24** NavigateUrl="~/Options.aspx"> **25** Click here to choose another language **26** </asp:HyperLink>&nbsp;</div> **27** </form> **28** </body> **29** </html>

**Fig. 25.28** | Session-based book recommendations displayed in a ListBox. (Part 1 of 2.)

Properties Description

**Fig. 25.27** | HttpSessionState properties. (Part 2 of 2.)  

25.4 Session Tracking **1061**

**_Code-Behind File That Creates Book Recommendations from a Session_** Figure 25.29 presents the code-behind file for Recommendations.aspx. Event handler Page\_Init (lines 7–30) retrieves the session information. If a user has not selected a lan- guage on Options.aspx, our Session object’s **Count** property will be 0. This property pro- vides the number of session items contained in a Session object. If Session object’s Count property is 0 (i.e., no language was selected), then we display the text **No Recommendations** and update the Text of the HyperLink back to Options.aspx.

**1** ' Fig. 25.29: Recommendations.aspx.vb **2** ' Creates book recommendations based on a Session object. **3** Partial Class Recommendations **4** Inherits System.Web.UI.Page **5 6** ' read Session items and populate ListBox with any book recommendations **7** Protected Sub Page\_Init(ByVal sender As Object, \_ **8** ByVal e As System.EventArgs) Handles Me.Init **9** ' determine whether Session contains any information

**10** If <> 0 Then **11** For i As Integer = 0 To Session.Count - 1 **12 13 14 15 16 17 18 19** Next **20** Else

**Fig. 25.29** | Session data used to provide book recommendations to the user. (Part 1 of 2.)

**Fig. 25.28** | Session-based book recommendations displayed in a ListBox. (Part 2 of 2.)

Session.Count

' get current key name from Session object Dim keyName As String = Session.Keys(i)

' use keyName to display one of Session's name-value pairs booksListBox.Items.Add(keyName & \_

" How to Program. ISBN#: " & \_ Session(keyName).ToString())  

**1062** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

If the user has chosen a language, the loop in lines 11–19 iterates through our Session object’s session items, temporarily storing each key name (line 13). The value in a key– value pair is retrieved from the Session object by indexing the Session object with the key name, using the same process by which we retrieved a value from our Hashtable in the preceding section.

Line 13 accesses the **Keys** property of class HttpSessionState, which returns a col- lection containing all the keys in the session. Line 13 indexes this collection to retrieve the current key. Lines 16–18 concatenate keyName’s value to the String " How to Program.

ISBN#: " and the value from the Session object for which keyName is the key. This String is the recommendation that appears in the ListBox.

**25.5 Case Study: Connecting to a Database in ASP.NET** Many websites allow users to provide feedback about the website in a **guestbook**. Typical- ly, users click a link on the website’s home page to request the guestbook page. This page usually consists of an XHTML form that contains fields for the user’s name, e-mail ad- dress, message/feedback and so on. Data submitted on the guestbook form is then stored in a database located on the web server’s machine.

In this section, we create a guestbook Web Form application. This example’s GUI is slightly more complex than that of earlier examples. It contains a **GridView** ASP.NET data control, as shown in Fig. 25.30, which displays all the entries in the guestbook in tabular format. We explain how to create and configure this data control shortly. Note that the GridView displays **abc** in **Design** mode to indicate string data that will be retrieved from a data source at runtime.

The XHTML form presented to the user consists of a name field, an e-mail address field and a message field. The form also contains a **Submit** button to send the data to the server and a **Clear** button to reset each of the fields on the form. The application stores the guestbook information in a SQL Server database called Guestbook.mdf located on the web server. (We provide this database in the examples directory for this chapter. You can download the examples from www.deitel.com/books/iw3htp4.) Below the XHTML form, the GridView displays the data (i.e., guestbook entries) in the database’s Messages table.

**21** ' if there are no session items, no language was chosen, so **22** ' display appropriate message and clear and hide booksListBox **23** recommendationsLabel.Text = "No Recommendations" **24** booksListBox.Items.Clear() **25** booksListBox.Visible = False **26 27** ' modify languageLink because no language was selected **28** languageLink.Text = "Click here to choose a language" **29** End If **30** End Sub ' Page\_Init **31** End Class ' Recommendations

**Fig. 25.29** | Session data used to provide book recommendations to the user. (Part 2 of 2.)  

25.5 Case Study: Connecting to a Database in ASP.NET **1063**

**25.5.1 Building a Web Form That Displays Data from a Database** We now explain how to build this GUI and set up the data binding between the GridView control and the database. We present the ASPX file generated from the GUI later in the section, and we discuss the related code-behind file in the next section. To build the guest- book application, perform the following steps:

**_Step 1: Creating the Project_** Create an **ASP.NET Web Site** named Guestbook and name the ASPX file Guestbook.aspx. Rename the class in the code-behind file Guestbook, and update the Page directive in the ASPX file accordingly.

**_Step 2: Creating the Form for User Input_** In **Design** mode for the ASPX file, add the text Please leave a message in our guest-

book: formatted as an h2 header. As discussed in Section 25.3.1, insert an XHTML table with two columns and four rows, configured so that the text in each cell aligns with the top of the cell. Place the appropriate text (see Fig. 25.30) in the top three cells in the table’s left column. Then place TextBoxes named nameTextBox, emailTextBox and message-

TextBox in the top three table cells in the right column. Set messageTextBox to be a mul- tiline TextBox. Finally, add Buttons named submitButton and clearButton to the bottom-right table cell. Set the buttons’ Text properties to Submit and Clear, respectively. We discuss the buttons’ event handlers when we present the code-behind file.

**_Step 3: Adding a GridView Control to the Web Form_** Add a GridView named messagesGridView that will display the guestbook entries. This control appears in the **Data** section of the **Toolbox**. The colors for the GridView are speci- fied through the **Auto Format...** link in the **GridView Tasks** smart tag menu that opens when you place the GridView on the page. Clicking this link causes an **Auto Format** dialog to

**Fig. 25.30** | Guestbook application GUI in **Design** mode.

GridView control  

**1064** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

open with several choices. In this example, we chose **Simple**. We soon show how to set the GridView’s data source (i.e., where it gets the data to display in its rows and columns).

**_Step 4: Adding a Database to an ASP.NET Web Application_** To use a SQL Server 2005 Express database in an ASP.NET web application, it is easiest to first add it to the project’s App\_Data folder. Right click this folder in the **Solution Ex- plorer** and select **Add Existing Item…**. Locate the Guestbook.mdf file in the exampleData-

bases subdirectory of the chapter’s examples directory, then click **Add**.

**_Step 5: Binding the GridView to the Messages Table of the Guestbook Database_** Now that the database is part of the project, we can configure the GridView to display its data. Open the **GridView Tasks** smart tag menu, then select **<New data source...>** from the **Choose Data Source** drop-down list. In the **Data Source Configuration Wizard** that appears, select **Database**. In this example, we use a **SqlDataSource** control that allows the applica- tion to interact with the Guestbook database. Set the ID of the data source to messagesSql-

DataSource and click **OK** to begin the **Configure Data Source** wizard. In the **Choose Your Data Connection** screen, select Guestbook.mdf from the drop-down list (Fig. 25.31), then click **Next >** twice to continue to the **Configure the Select Statement** screen.

The **Configure the Select Statement** screen (Fig. 25.32) allows you to specify which data the SqlDataSource should retrieve from the database. Your choices on this page design a SELECT statement, shown in the bottom pane of the dialog. The **Name** drop-down list identifies a table in the database. The Guestbook database contains only one table named Messages, which is selected by default. In the **Columns** pane, click the checkbox marked with an asterisk (**\***) to indicate that you want to retrieve the data from all the col- umns in the **Message** table. Click the **Advanced** button, then check the box next to **Gen-**

**Fig. 25.31** | **Configure Data Source** dialog in Visual Web Developer.  

25.5 Case Study: Connecting to a Database in ASP.NET **1065**

**erate UPDATE, INSERT and DELETE statements**. This configures the SqlDataSource

control to allow us to change data in, insert new data into and delete data from the data- base. We discuss inserting new guestbook entries based on users’ form submissions shortly. Click **OK**, then click **Next >** to continue the **Configure Data Source** wizard.

The next screen of the wizard allows you to test the query that you just designed. Click **Test Query** to preview the data that will be retrieved by the SqlDataSource (shown in Fig. 25.33).

Finally, click **Finish** to complete the wizard. Notice that a control named messages-

SqlDataSource now appears on the Web Form directly below the GridView (Fig. 25.34). This control is represented in **Design** mode as a gray box containing its type and name. This control will _not_ appear on the web page—the gray box simply provides a way to manipulate the control visually through **Design** mode. Also notice that the GridView now has column headers that correspond to the columns in the Messages table and that the rows each contain either a number (which signifies an autoincremented column) or **abc** (which indicates string data). The actual data from the Guestbook database file will appear in these rows when the ASPX file is executed and viewed in a web browser.

**_Step 6: Modifying the Columns of the Data Source Displayed in the GridView_** It is not necessary for site visitors to see the MessageID column when viewing past guest- book entries—this column is merely a unique primary key required by the Messages table within the database. Thus, we modify the GridView so that this column does not display

**Fig. 25.32** | Configuring the SELECT statement used by the SqlDataSource to retrieve data.  

**1066** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**Fig. 25.33** | Previewing the data retrieved by the SqlDataSource.

**Fig. 25.34** | **Design** mode displaying SqlDataSource control for a GridView.

SqlDataSource control  

25.5 Case Study: Connecting to a Database in ASP.NET **1067**

on the Web Form. In the **GridView Tasks** smart tag menu, click **Edit Columns**. In the re- sulting **Fields** dialog (Fig. 25.35), select **MessageID** in the **Selected fields** pane, then click the **X**. This removes the MessageID column from the GridView. Click **OK** to return to the main IDE window. The GridView should now appear as in Fig. 25.30.

**_Step 7: Modifying the Way the SqlDataSource Control Inserts Data_** When you create a SqlDataSource in the manner described here, it is configured to permit INSERT SQL operations against the database table from which it gathers data. You must specify the values to insert either programmatically or through other controls on the Web Form. In this example, we wish to insert the data entered by the user in the nameTextBox, emailTextBox and messageTextBox controls. We also want to insert the current date— we will specify the date to insert programmatically in the code-behind file, which we present shortly.

To configure the SqlDataSource to allow such an insertion, select the messagesSql- DataSource control then click the ellipsis button next to the control’s **InsertQuery** prop- erty of the messagesSqlDataSource control in the **Properties** window. The **Command and Parameter Editor** (Fig. 25.36) that appears displays the INSERT command used by the Sql- DataSource control. This command contains parameters @Date, @Name, @Email and @Mes-

sage. You must provide values for these parameters before they are inserted into the database. Each parameter is listed in the **Parameters** section of the **Command and Param- eter Editor**. Because we will set the **Date** parameter programmatically, we do not modify it here. For each of the remaining three parameters, select the parameter, then select **Control** from the **Parameter source** drop-down list. This indicates that the value of the parameter should be taken from a control. The **ControlID** drop-down list contains all the controls on the Web Form. Select the appropriate control for each parameter, then click **OK**. Now the SqlDataSource is configured to insert the user’s name, e-mail address and message in the

**Fig. 25.35** | Removing the MessageID column from the GridView.  

**1068** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Messages table of the Guestbook database. We show how to set the date parameter and initiate the insert operation when the user clicks **Submit** shortly.

**_ASPX File for a Web Form That Interacts with a Database_** The ASPX file generated by the guestbook GUI (and messagesSqlDataSource control) is shown in Fig. 25.37. This file contains a large amount of generated markup. We discuss only those parts that are new or noteworthy for the current example. Lines 19–58 contain the XHTML and ASP.NET elements that comprise the form that gathers user input. The GridView control appears in lines 60–85. The <asp:GridView> start tag (lines 60–63) contains properties that set various aspects of the GridView’s appearance and behavior, such as whether grid lines should be displayed between rows and columns. The **DataSourceID** property identifies the data source that is used to fill the GridView with data at runtime.

Lines 66–75 define the Columns that appear in the GridView. Each column is repre- sented as a **BoundField**, because the values in the columns are bound to values retrieved from the data source (i.e., the Messages table of the Guestbook database). The DataField property of each BoundField identifies the column in the data source to which the column in the GridView is bound. The HeaderText property indicates the text that appears as the column header. By default, this is the name of the column in the data source, but you can change this property as desired. Lines 76–84 contain nested elements that define the styles used to format the GridView’s rows. The IDE configured these styles based on your selec- tion of the **Simple** style in the **Auto Format** dialog for the GridView.

The messagesSqlDataSource is defined by the markup in lines 86–115 in Fig. 25.37. Line 87 contains a **ConnectionString** property, which indicates the connection through

**Fig. 25.36** | Setting up INSERT parameters based on control values.  

25.5 Case Study: Connecting to a Database in ASP.NET **1069**

which the SqlDataSource control interacts with the database. The value of this property uses an **ASP.NET expression**, delimited by **<%$** and **%>**, to access the Guestbook-

ConnectionString stored in the ConnectionStrings section of the application’s Web.config configuration file. Recall that we created this connection string earlier in this section using the **Configure Data Source** wizard.Lines 88–95 define the **DeleteCommand**, **InsertCommand**, **SelectCommand** and **UpdateCommand** properties, which contain the DELETE, INSERT, SELECT and UPDATE SQL statements, respectively. These were generated by the **Configure Data Source** wizard. In this example, we use only the InsertCommand. We discuss invoking this command shortly.

**1** <%-- Fig. 25.37: Guestbook.aspx --%> **2** <%-- Guestbook Web application with a form for users to submit --%> **3** <%-- guestbook entries and a GridView to view existing entries. --%> **4** <%@ Page Language="VB" AutoEventWireup="false" **5** CodeFile="Guestbook.aspx.vb" Inherits="Guestbook" %> **6 7** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **8** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **9**

**10** <html xmlns="http://www.w3.org/1999/xhtml" > **11** <head runat="server"> **12** <title>Guestbook</title> **13** </head> **14** <body> **15** <form id="form1" runat="server"> **16** <div> **17** <h2> **18** Please leave a message in our guestbook:</h2> **19** <table> **20** <tr> **21** <td style="width: 130px; height: 21px" valign="top"> **22** Your name:<br /> **23** </td> **24** <td style="width: 300px; height: 21px" valign="top"> **25** <asp:TextBox ID="nameTextBox" runat="server" **26** Width="300px"></asp:TextBox> **27** </td> **28** </tr> **29** <tr> **30** <td style="width: 130px" valign="top"> **31** Your e-mail address:<br /> **32** </td> **33** <td style="width: 300px" valign="top"> **34** <asp:TextBox ID="emailTextBox" runat="server" **35** Width="300px"></asp:TextBox> **36** </td> **37** </tr> **38** <tr> **39** <td style="width: 130px" valign="top"> **40** Tell the world:<br /> **41** </td>

**Fig. 25.37** | ASPX file for the guestbook application. (Part 1 of 4.)  

**1070** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**42** <td style="width: 300px" valign="top"> **43** <asp:TextBox ID="messageTextBox" runat="server" **44** Height="100px" Rows="8" Width="300px"> **45** </asp:TextBox> **46** </td> **47** </tr> **48** <tr> **49** <td style="width: 130px" valign="top"> **50** </td> **51** <td style="width: 300px" valign="top"> **52** <asp:Button ID="submitButton" runat="server" **53** Text="Submit" /> **54** <asp:Button ID="clearButton" runat="server" **55** Text="Clear" /> **56** </td> **57** </tr> **58** </table> **59** <br /> **60 61** AutoGenerateColumns="False" CellPadding="4" **62** DataKeyNames="MessageID" **63** ForeColor="#333333" GridLines="None" Width="600px"> **64** <FooterStyle BackColor="#1C5E55" Font-Bold="True" **65** ForeColor="White" /> **66 67 68 69 70 71 72 73 74 75 76** <RowStyle BackColor="#E3EAEB" /> **77** <EditRowStyle BackColor="#7C6F57" /> **78** <SelectedRowStyle BackColor="#C5BBAF" Font-Bold="True" **79** ForeColor="#333333" /> **80** <PagerStyle BackColor="#666666" ForeColor="White" **81** HorizontalAlign="Center" /> **82** <HeaderStyle BackColor="#1C5E55" Font-Bold="True" **83** ForeColor="White" /> **84** <AlternatingRowStyle BackColor="White" /> **85** </asp:GridView> **86 87 88** DeleteCommand="DELETE FROM \[Messages\] WHERE \[MessageID\] = **89** @MessageID" InsertCommand="INSERT INTO \[Messages\] **90** (\[Date\], \[Name\], \[Email\], \[Message\]) **91** VALUES (@Date, @Name, @Email, @Message)" **92** UpdateCommand= **93** "UPDATE \[Messages\] SET \[Date\] = @Date, \[Name\] = @Name, **94** \[Email\] = @Email, \[Message\] = @Message

**Fig. 25.37** | ASPX file for the guestbook application. (Part 2 of 4.)

<asp:GridView ID="messagesGridView" runat="server"

DataSourceID="messagesSqlDataSource"

<Columns> <asp:BoundField DataField="Date" HeaderText="Date"

SortExpression="Date" /> <asp:BoundField DataField="Name" HeaderText="Name"

SortExpression="Name" /> <asp:BoundField DataField="Email" HeaderText="Email"

SortExpression="Email" /> <asp:BoundField DataField="Message" HeaderText="Message"

SortExpression="Message" /> </Columns>

<asp:SqlDataSource ID="messagesSqlDataSource" runat="server" ConnectionString="<%$ ConnectionStrings:ConnectionString %>"

SelectCommand="SELECT \* FROM \[Messages\]"  

25.5 Case Study: Connecting to a Database in ASP.NET **1071**

**95** WHERE \[MessageID\] = @MessageID"> **96** <DeleteParameters> **97** <asp:Parameter Name="MessageID" Type="Int32" /> **98** </DeleteParameters> **99** <UpdateParameters> **100** <asp:Parameter Name="Date" Type="String" /> **101** <asp:Parameter Name="Name" Type="String" /> **102** <asp:Parameter Name="Email" Type="String" /> **103** <asp:Parameter Name="Message" Type="String" /> **104** <asp:Parameter Name="MessageID" Type="Int32" /> **105** </UpdateParameters> **106 107 108 109 110 111 112 113 114 115** </asp:SqlDataSource> **116** </div> **117** </form> **118** </body> **119** </html>

**Fig. 25.37** | ASPX file for the guestbook application. (Part 3 of 4.)

<InsertParameters> <asp:Parameter Name="Date" Type="String" /> <asp:ControlParameter ControlID="nameTextBox" Name="Name"

PropertyName="Text" Type="String" /> <asp:ControlParameter ControlID="emailTextBox" Name="Email"

PropertyName="Text" Type="String" /> <asp:ControlParameter ControlID="messageTextBox"

Name="Message" PropertyName="Text" Type="String" /> </InsertParameters>

(a)  

**1072** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Notice that the SQL commands used by the SqlDataSource contain several parame- ters (prefixed with @). Lines 96–114 contain elements that define the name, the type and, for some parameters, the source of the parameter. Parameters that are set programmatically are defined by **Parameter** elements containing Name and Type properties. For example, line 107 defines the Date parameter of Type String. This corresponds to the @Date parameter in the InsertCommand (line 91). Parameters that obtain their values from controls are defined by **ControlParameter** elements. Lines 108–113 contain markup that sets up the relationships between the INSERT parameters and the Web Form’s TextBoxes. We estab- lished these relationships in the **Command and Parameter Editor** (Fig. 25.36). Each ControlParameter contains a ControlID property indicating the control from which the parameter gets its value. The PropertyName specifies the property that contains the actual value to be used as the parameter value. The IDE sets the PropertyName based on the type of control specified by the ControlID (indirectly via the **Command and Parameter Editor**). In this case, we use only TextBoxes, so the PropertyName of each ControlParameter is Text (e.g., the value of parameter @Name comes from nameTextBox.Text). However, if we were using a DropDownList, for example, the PropertyName would be SelectedValue.

**25.5.2 Modifying the Code-Behind File for the Guestbook Application** After building the Web Form and configuring the data controls used in this example, dou- ble click the **Submit** and **Clear** buttons in **Design** view to create their corresponding Click

event handlers in the Guestbook.aspx.vb code-behind file (Fig. 25.38). The IDE generates empty event handlers, so we must add the appropriate code to make these but-

**Fig. 25.37** | ASPX file for the guestbook application. (Part 4 of 4.)

(b)  

25.5 Case Study: Connecting to a Database in ASP.NET **1073**

tons work properly. The event handler for clearButton (lines 33–38) clears each TextBox

by setting its Text property to an empty string. This resets the form for a new guestbook submission.

Lines 8–30 contain the event-handling code for submitButton, which adds the user’s information to the Messages table of the Guestbook database. Recall that we configured messagesSqlDataSource’s INSERT command to use the values of the TextBoxes on the Web Form as the parameter values inserted into the database. We have not yet specified the date value to be inserted, though. Lines 11–12 assign a String representation of the current date (e.g., "3/27/06") to a new object of type Parameter. This Parameter object is identified as "Date" and is given the current date as a default value. The SqlData-

**1** ' Fig. 25.38: Guestbook.aspx.vb **2** ' Code-behind file that defines event handlers for the guestbook. **3** Partial Class Guestbook **4** Inherits System.Web.UI.Page **5 6** ' Submit Button adds a new guestbook entry to the database, **7** ' clears the form and displays the updated list of guestbook entries **8** Protected Sub submitButton\_Click(ByVal sender As Object, \_ **9** ByVal e As System.EventArgs) Handles submitButton.Click

**10 11 12 13 14 15 16 17 18 19 20 21 22 23** ' clear the TextBoxes **24** nameTextBox.Text = "" **25** emailTextBox.Text = "" **26** messageTextBox.Text = "" **27 28** ' update the GridView with the new database table contents **29** messagesGridView.DataBind() **30** End Sub ' submitButton\_Click **31 32** ' Clear Button clears the Web Form's TextBoxes **33** Protected Sub clearButton\_Click(ByVal sender As Object, \_ **34** ByVal e As System.EventArgs) Handles clearButton.Click **35** nameTextBox.Text = "" **36** emailTextBox.Text = "" **37** messageTextBox.Text = "" **38** End Sub ' clearButton\_Click **39** End Class ' Guestbook

**Fig. 25.38** | Code-behind file for the guestbook application.

' create a date parameter to store the current date Dim currentDate As New System.Web.UI.WebControls.Parameter( \_

"Date", TypeCode.String, DateTime.Now.ToShortDateString())

' set the @Date parameter to the date parameter messagesSqlDataSource.InsertParameters.RemoveAt(0) messagesSqlDataSource.InsertParameters.Add(currentDate)

' execute an INSERT SQL statement to add a new row to the ' Messages table in the Guestbook database that contains the ' current date and the user's name, e-mail address and message messagesSqlDataSource.Insert()  

**1074** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Source’s InsertParameters collection contains an item named Date (at position 0), which we Remove in line 15 and replace in line 16 by Adding our currentDate parameter. Invoking SqlDataSource method Insert in line 21 executes the INSERT command against the database, thus adding a row to the Messages table. After the data is inserted into the database, lines 24–26 clear the TextBoxes, and line 29 invokes messagesGridView’s Data- Bind method to refresh the data that the GridView displays. This causes messagesSql-

DataSource (the data source of the GridView) to execute its SELECT command to obtain the Messages table’s newly updated data.

**25.6 Case Study: Secure Books Database Application** This case study presents a web application in which a user logs into a secure website to view a list of publications by an author of the user’s choosing. The application consists of several ASPX files. Section 25.6.1 presents the application and explains the purpose of each of its web pages. Section 25.6.2 provides step-by-step instructions to guide you through building the application and presents the markup in the ASPX files.

**25.6.1 Examining the Completed Secure Books Database Application** This example uses a technique known as **forms authentication** to protect a page so that only users known to the website can access it. Such users are known as the site’s members. Authentication is a crucial tool for sites that allow only members to enter the site or a por- tion of the site. In this application, website visitors must log in before they are allowed to view the publications in the Books database. The first page that a user would typically re- quest is Login.aspx (Fig. 25.39). You will soon learn to create this page using a Login con- trol, one of several **ASP.NET login controls** that help create secure applications using authentication. These controls are found in the **Login** section of the **Toolbox**.

The Login.aspx page allows a site visitor to enter an existing user name and password to log into the website. A first-time visitor must click the link below the **Log In** button to create a new user before logging in. Doing so redirects the visitor to CreateNewUser.aspx

**Fig. 25.39** | Login.aspx page of the secure books database application.  

25.6 Case Study: Secure Books Database Application **1075**

(Fig. 25.40), which contains a CreateUserWizard control that presents the visitor with a user registration form. We discuss the CreateUserWizard control in detail in Section 25.6.2. In Fig. 25.40, we use the password pa$$word for testing purposes—as you will learn, the CreateUserWizard requires that the password contain special characters for security purposes. Clicking **Create User** establishes a new user account. After creating the account, the user is automatically logged in and shown a success message (Fig. 25.41).

**Fig. 25.40** | CreateNewUser.aspx page of the secure books database application.

**Fig. 25.41** | Message displayed to indicate that a user account was created successfully.  

**1076** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Clicking the **Continue** button on the confirmation page sends the user to Books.aspx

(Fig. 25.42), which provides a drop-down list of authors and a table containing the ISBNs, titles, edition numbers and copyright years of books in the database. By default, all the books by Harvey Deitel are displayed. Links appear at the bottom of the table that allow you to access additional pages of data. When the user chooses an author, a postback occurs, and the page is updated to display information about books written by the selected author (Fig. 25.43).

**Fig. 25.42** | Books.aspx displaying books by Harvey Deitel (by default).

**Fig. 25.43** | Books.aspx displaying books by Andrew Goldberg.  

25.6 Case Study: Secure Books Database Application **1077**

Note that once the user creates an account and is logged in, Books.aspx displays a welcome message customized for the particular logged-in user. As you will soon see, a Log- inName control provides this functionality. After you add this control to the page, ASP.NET handles the details of determining the user name.

Clicking the **Click here to log out** link logs the user out, then sends the user back to Login.aspx (Fig. 25.44). This link is created by a LoginStatus control, which handles the log out details. After logging out, the user would need to log in through Login.aspx to view the book listing again. The Login control on this page receives the user name and password entered by a visitor. ASP.NET compares these values with user names and pass- words stored in a database on the server. If there is a match, the visitor is **authenticated** (i.e., the user’s identity is confirmed). We explain the authentication process in detail in Section 25.6.2. When an existing user is successfully authenticated, Login.aspx redirects the user to Books.aspx (Fig. 25.42). If the user’s login attempt fails, an appropriate error message is displayed (Fig. 25.45).

**Fig. 25.44** | Logging in using the Login control.

**Fig. 25.45** | Error message displayed for an unsuccessful login attempt.  

**1078** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Notice that Login.aspx, CreateNewUser.aspx and Books.aspx share the same page header containing the logo image from the fictional company Bug2Bug. Instead of placing this image at the top of each page, we use a **master page** to achieve this. As we demonstrate shortly, a master page defines common GUI elements that are inherited by each page in a set of **content pages**. Just as Visual Basic classes can inherit instance variables and methods from existing classes, content pages inherit elements from master pages—this is known as **visual inheritance**.

**25.6.2 Creating the Secure Books Database Application** Now that you are familiar with how this application behaves, you’ll learn how to create it from scratch. Thanks to the rich set of login and data controls provided by ASP.NET, you will not have to write _any_ code to create this application. In fact, the application does not contain any code-behind files. All of the functionality is specified through properties of controls, many of which are set through wizards and other visual programming tools. ASP.NET hides the details of authenticating users against a database of user names and passwords, displaying appropriate success or error messages and redirecting the user to the correct page based on the authentication results. We now discuss the steps you must per- form to create the secure books database application.

**_Step 1: Creating the Website_** Create a new **ASP.NET Web Site** at http://localhost/Bug2Bug as described previously. We will explicitly create each of the ASPX files that we need in this application, so delete the IDE-generated Default.aspx file (and its corresponding code-behind file) by selecting Default.aspx in the **Solution Explorer** and pressing the _Delete_ key. Click **OK** in the confir- mation dialog to delete these files.

**_Step 2: Setting Up the Website’s Folders_** Before building the pages in the website, we create folders to organize its contents. First, create an Images folder by right clicking the location of the website in the **Solution Explorer** and selecting **New Folder**, then add the bug2bug.png file to it. This image can be found in the examples directory for this chapter. Next, add the Books.mdf database file (located in the exampleDatabases subdirectory of the chapter’s examples directory) to the project’s App\_Data folder. We show how to retrieve data from this database later in the section.

**_Step 3: Configuring the Application’s Security Settings_** In this application, we want to ensure that only authenticated users are allowed to access Books.aspx (created in _Step 9_ and _Step 10_) to view the information in the database. Pre- viously, we created all of our ASPX pages in the web application’s root directory (e.g., http://localhost/_ProjectName_). By default, any website visitor (regardless of whether the visitor is authenticated) can view pages in the root directory. ASP.NET allows you to restrict access to particular folders of a website. We do not want to restrict access to the root of the website, however, because all users must be able to view Login.aspx and CreateNewUser.aspx to log in and create user accounts, respectively. Thus, if we want to restrict access to Books.aspx, it must reside in a directory other than the root directory. Create a folder named Secure. Later in the section, we will create Books.aspx in this fold- er. First, let’s enable forms authentication in our application and configure the Secure

folder to restrict access to authenticated users only.  

25.6 Case Study: Secure Books Database Application **1079**

Select **Website > ASP.NET Configuration** to open the **Web Site Administration Tool** in a web browser (Fig. 25.46). This tool allows you to configure various options that deter- mine how your application behaves. Click either the **Security** link or the **Security** tab to open a web page in which you can set security options (Fig. 25.47), such as the type of authentication the application should use. In the **Users** column, click **Select authentication type**. On the resulting page (Fig. 25.48), select the radio button next to **From the internet** to indicate that users will log in via a form on the website in which the user can enter a username and password (i.e., the application will use forms authentication). The default setting—**From a local network**—relies on users’ Windows user names and passwords for authentication purposes. Click the **Done** button to save this change.

Now that forms authentication is enabled, the **Users** column on the main page of the **Web Site Administration Tool** (Fig. 25.49) provides links to create and manage users. As you saw in Section 25.6.1, our application provides the CreateNewUser.aspx page in which users can create their own accounts. Thus, while it is possible to create users through the **Web Site Administration Tool**, we do not do so here.

Even though no users exist at the moment, we configure the Secure folder to grant access only to authenticated users (i.e., deny access to all unauthenticated users). Click the **Create access rules** link in the **Access Rules** column of the **Web Site Administration Tool** (Fig. 25.49) to view the **Add New Access Rule** page (Fig. 25.50). This page is used to create an **access rule**—a rule that grants or denies access to a particular web application directory for a specific user or group of users. Click the Secure directory in the left column of the page to identify the directory to which our access rule applies. In the middle column, select the radio button marked **Anonymous users** to specify that the rule applies to users who

**Fig. 25.46** | **Web Site Administration Tool** for configuring a web application.  

**1080** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**Fig. 25.47** | **Security** page of the **Web Site Administration Tool**.

**Fig. 25.48** | Choosing the type of authentication used by an ASP.NET web application.  

25.6 Case Study: Secure Books Database Application **1081**

**Fig. 25.49** | Main page of the **Web Site Administration Tool** after enabling forms authentication.

**Fig. 25.50** | **Add New Access Rule** page used to configure directory access.  

**1082** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

have not been authenticated. Finally, select **Deny** in the right column, labeled **Permission**, then click **OK**. This rule indicates that **anonymous users** (i.e., users who have not identi- fied themselves by logging in) should be denied access to any pages in the Secure directory (e.g., Books.aspx). By default, anonymous users who attempt to load a page in the Secure directory are redirected to the Login.aspx page so that they can identify themselves. Note that because we did not set up any access rules for the Bug2Bug root directory, anonymous users may still access pages there (e.g., Login.aspx, CreateNewUser.aspx). We create these pages momentarily.

**_Step 4: Examining the Autogenerated Web.config Files_** We have now configured the application to use forms authentication and created an access rule to ensure that only authenticated users can access the Secure folder. Before creating the website’s content, we examine how the changes made through the **Web Site Adminis- tration Tool** appear in the IDE. Recall that Web.config is an XML file used for application configuration, such as enabling debugging or storing database connection strings. Visual Web Developer generates two Web.config files in response to our actions using the **Web Site Administration Tool**—one in the application’s root directory and one in the Secure

folder. \[_Note:_ You may need to click the **Refresh** button in the **Solution Explorer** to see these files.\] In an ASP.NET application, a page’s configuration settings are determined by the current directory’s Web.config file. The settings in this file take precedence over the set- tings in the root directory’s Web.config file.

After setting the authentication type for the web application, the IDE generates a Web.config file at http://localhost/Bug2Bug/Web.config, which contains an **authen-**

**tication** element

<authentication mode="Forms" />

This element appears in the root directory’s Web.config file, so the setting applies to the entire website. The value "Forms" of the **mode** attribute specifies that we want to use forms authentication. Had we left the authentication type set to **From a local network** in the **Web Site Administration Tool**, the mode attribute would be set to "Windows".

After creating the access rule for the Secure folder, the IDE generates a second Web.config file in that folder. This file contains an **authorization** element that indicates who is, and who is not, authorized to access this folder over the web. In this application, we want to allow only authenticated users to access the contents of the Secure folder, so the authorization element appears as

<authorization> <deny users="?" />

</authorization>

Rather than grant permission to each individual authenticated user, we deny access to those who are not authenticated (i.e., those who have not logged in). The **deny** element inside the authorization element specifies the users to whom we wish to deny access. When the users attribute’s value is set to "?", all anonymous (i.e., unauthenticated) users are denied access to the folder. Thus, an unauthenticated user will not be able to load http://localhost/Bug2Bug/Secure/Books.aspx. Instead, such a user will be redirected to the Login.aspx page—when a user is denied access to a part of a site, ASP.NET by de- fault sends the user to a page named Login.aspx in the application’s root directory.  

25.6 Case Study: Secure Books Database Application **1083**

**_Step 5: Creating a Master Page_** Now that you have established the application’s security settings, you can create the appli- cation’s web pages. We begin with the master page, which defines the elements we want to appear on each page. A master page is like a base class in a visual inheritance hierarchy, and content pages are like derived classes. The master page contains placeholders for cus- tom content created in each content page. The content pages visually inherit the master page’s content, then add content in place of the master page’s placeholders.

For example, you might want to include a **navigation bar** (i.e., a series of buttons for navigating a website) on every page of a site. If the site encompasses a large number of pages, adding markup to create the navigation bar for each page can be time consuming. Moreover, if you subsequently modify the navigation bar, every page on the site that uses it must be updated. By creating a master page, you can specify the navigation bar markup in one file and have it appear on all the content pages, with only a few lines of markup. If the navigation bar changes, only the master page changes—any content pages that use it are updated the next time the page is requested.

In this example, we want the Bug2Bug logo to appear as a header at the top of every page, so we will place an Image control in the master page. Each subsequent page we create will be a content page based on this master page and thus will include the header. To create a master page, right click the location of the website in the **Solution Explorer** and select **Add New Item…**. In the **Add New Item** dialog, select **Master Page** from the template list and specify Bug2Bug.master as the filename. Master pages have the filename extension **.master** and, like Web Forms, can optionally use a code-behind file to define additional functionality. In this example, we do not need to specify any code for the master page, so leave the box labeled **Place code in a separate file** unchecked. Click **Add** to create the page.

The IDE opens the master page in **Source** mode (Fig. 25.51) when the file is first cre- ated. \[_Note:_ We added a line break in the DOCTYPE element for presentation purposes.\] The

**Fig. 25.51** | Master page in **Source** mode.  

**1084** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

markup for a master page is almost identical to that of a Web Form. One difference is that a master page contains a **Master** directive (line 1 in Fig. 25.51), which specifies that this file defines a master page using the indicated Language for any code. Because we chose not to use a code-behind file, the master page also contains a **script** element (lines 6–8). Code that would usually be placed in a code-behind file can be placed in a script element. However, we remove the script element from this page, because we do not need to write any additional code. After deleting this block of markup, set the title of the page to Bug2Bug. Finally, notice that the master page contains a **ContentPlaceHolder** control (lines 17–18 of Fig. 25.51). This control serves as a placeholder for content that will be defined by a content page. You will see how to define content to replace the Content-

PlaceHolder shortly. At this point, you can edit the master page in **Design** mode (Fig. 25.52) as if it were

an ASPX file. Notice that the ContentPlaceHolder control appears as a large rectangle with a gray bar indicating the control’s type and ID. Using the **Properties** window, change the ID of this control to bodyContent.

To create a header in the master page that will appear at the top of each content page, we insert a table into the master page. Place the cursor to the left of the ContentPlace-

Holder and select **Layout > Insert Table**. In the **Insert Table** dialog, click the **Template** radio button, then select **Header** from the drop-down list of available table templates. Click **OK** to create a table that fills the page and contains two rows. Drag and drop the Content-

PlaceHolder into the bottom table cell. Change the valign property of this cell to top, so the ContentPlaceHolder vertically aligns with the top of the cell. Next, set the Height

of the top table cell to 130. Add to this cell an Image control named headerImage with its ImageUrl property set to the bug2bug.png file in the project’s Images folder. Figure 25.53 shows the markup and **Design** view of the completed master page. As you will see in _Step_

**Fig. 25.52** | Master page in **Design** mode.

**1** <%-- Fig. 25.53: Bug2bug.master --%> **2** <%-- Master page that defines common features of all pages in the --%> **3** <%-- secure book database application. --%>

**Fig. 25.53** | Bug2Bug.master page that defines a logo image header for all pages in the secure book database application. (Part 1 of 2.)  

25.6 Case Study: Secure Books Database Application **1085**

**4** <%@ Master Language="VB" %> **5 6** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **7** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **8 9** <html xmlns="http://www.w3.org/1999/xhtml" >

**10** <head runat="server"> **11** <title>Bug2Bug</title> **12** </head> **13** <body> **14** <form id="form1" runat="server"> **15** <div> **16** <table border="0" cellpadding="0" cellspacing="0" **17** style="width: 100%; height: 100%"> **18** <tr> **19** <td height="130" style="width: 887px"> **20 21 22** </td> **23** </tr> **24** <tr> **25** <td style="width: 887px" valign="top"> **26 27 28** </td> **29** </tr> **30** </table> **31** &nbsp; **32** </div> **33** </form> **34** </body> **35** </html>

**Fig. 25.53** | Bug2Bug.master page that defines a logo image header for all pages in the secure book database application. (Part 2 of 2.)

<asp:Image ID="headerImage" runat="server" ImageUrl="~/Images/bug2bug.png" />

<asp:contentplaceholder id="bodyContent" runat="server"> </asp:contentplaceholder>  

**1086** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

_6_, a content page based on this master page displays the logo image defined here, as well as the content designed for that specific page (in place of the ContentPlaceHolder).

**_Step 6: Creating a Content Page_** We now create a content page based on Bug2Bug.master. We begin by building Create-

NewUser.aspx. To create this file, right click the master page in the **Solution Explorer** and select **Add Content Page**. This action causes a Default.aspx file, configured to use the master page, to be added to the project. Rename this file CreateNewUser.aspx, then open it in **Source** mode (Fig. 25.54). Note that this file contains a Page directive with a Lan-

guage property, a MasterPageFile property and a Title property. The Page directive in- dicates the **MasterPageFile** that is used as a starting point for this new page’s design. In this case, the MasterPageFile property is set to "~/Bug2Bug.master" to indicate that the current file is based on the master page we just created. The **Title** property specifies the title that will be displayed in the web browser’s title bar when the content page is loaded. This value, which we set to Create a New User, replaces the value (i.e., Bug2Bug) set in the title element of the master page.

Because CreateNewUser.aspx’s Page directive specifies Bug2Bug.master as the page’s MasterPageFile, the content page implicitly contains the contents of the master page, such as the DOCTYPE, html and body elements. The content page file does not duplicate the XHTML elements found in the master page. Instead, the content page contains a **Content** control (lines 3–5 in Fig. 25.54), in which we will place page-specific content that will replace the master page’s ContentPlaceHolder when the content page is requested. The ContentPlaceHolderID property of the Content control identifies the ContentPlace-

Holder in the master page that the control should replace—in this case, bodyContent. The relationship between a content page and its master page is more evident in **Design**

mode (Fig. 25.55). The gray shaded region contains the contents of the master page Bug2Bug.master as they will appear in CreateNewUser.aspx when rendered in a web browser. The only editable part of this page is the Content control, which appears in place of the master page’s ContentPlaceHolder.

**_Step 7: Adding a CreateUserWizard Control to a Content Page_** Recall from Section 25.6.1 that CreateNewUser.aspx is the page in our website that al- lows first-time visitors to create user accounts. To provide this functionality, we use a **CreateUserWizard** control. Place the cursor inside the Content control in **Design** mode and double click CreateUserWizard in the **Login** section of the **Toolbox** to add it to the

**Fig. 25.54** | Content page CreateNewUser.aspx in **Source** mode.  

25.6 Case Study: Secure Books Database Application **1087**

page at the current cursor position. You can also drag-and-drop the control onto the page. To change the CreateUserWizard’s appearance, open the **CreateUserWizard Tasks** smart tag menu, and click **Auto Format**. Select the **Professional** color scheme.

As discussed previously, a CreateUserWizard provides a registration form that site vis- itors can use to create a user account. ASP.NET creates a SQL Server database (named ASPNETDB.MDF and located in the App\_Data folder) to store the user names, passwords and other account information of the application’s users. ASP.NET also enforces a default set of requirements for filling out the form. Each field on the form is required, the password must contain at least seven characters (including at least one nonalphanumeric character) and the two passwords entered must match. The form also asks for a security question and answer that can be used to identify a user in case the user needs to reset or recover the account’s password.

After the user fills in the form’s fields and clicks the **Create User** button to submit the account information, ASP.NET verifies that all the form’s requirements were fulfilled and attempts to create the user account. If an error occurs (e.g., the user name already exists), the CreateUserWizard displays a message below the form. If the account is created suc- cessfully, the form is replaced by a confirmation message and a button that allows the user to continue. You can view this confirmation message in **Design** mode by selecting **Com- plete** from the **Step** drop-down list in the **CreateUserWizard Tasks** smart tag menu.

When a user account is created, ASP.NET automatically logs the user into the site (we say more about the login process shortly). At this point, the user is authenticated and allowed to access the Secure folder. After we create Books.aspx later in this section, we set the CreateUserWizard’s ContinueDestinationPageUrl property to ~/Secure/

Books.aspx to indicate that the user should be redirected to Books.aspx after clicking the **Continue** button on the confirmation page.

Figure 25.56 presents the completed CreateNewUser.aspx file (reformatted for read- ability). Inside the Content control, the CreateUserWizard control is defined by the markup in lines 7–36. The start tag (lines 7–10) contains several properties that specify

**Fig. 25.55** | Content page CreateNewUser.aspx in **Design** mode.  

**1088** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

formatting styles for the control, as well as the ContinueDestinationPageUrl property, which you will set later in the chapter. Lines 11–16 specify the wizard’s two steps— CreateUserWizardStep and CompleteWizardStep—in a WizardSteps element. Create- UserWizardStep and CompleteWizardStep are classes that encapsulate the details of cre- ating a user and issuing a confirmation message. Finally, lines 17–35 contain elements that define additional styles used to format specific parts of the control.

The sample outputs in Fig. 25.56(a) and Fig. 25.56(b) demonstrate successfully cre- ating a user account with CreateNewUser.aspx. We use the password pa$$word for testing purposes. This password satisfies the minimum length and special character requirement imposed by ASP.NET, but in a real application, you should use a password that is more difficult for someone to guess. Figure 25.56(c) illustrates the error message that appears when you attempt to create a second user account with the same user name—ASP.NET requires that each user name be unique.

**1** <%-- Fig. 25.56: CreateNewUser.aspx --%> **2** <%-- Content page using a CreateUserWizard control to register users. --%> **3 4 5 6 7 8 9**

**10 11 12 13 14 15 16 17** <SideBarStyle BackColor="#5D7B9D" BorderWidth="0px" **18** Font-Size="0.9em" VerticalAlign="Top" /> **19** <TitleTextStyle BackColor="#5D7B9D" Font-Bold="True" **20** ForeColor="White" /> **21** <SideBarButtonStyle BorderWidth="0px" Font-Names="Verdana" **22** ForeColor="White" /> **23** <NavigationButtonStyle BackColor="#FFFBFF" BorderColor="#CCCCCC" **24** BorderStyle="Solid" BorderWidth="1px" Font-Names="Verdana" **25** ForeColor="#284775" /> **26** <HeaderStyle BackColor="#5D7B9D" BorderStyle="Solid" **27** Font-Bold="True" Font-Size="0.9em" **28** ForeColor="White" HorizontalAlign="Center" /> **29** <CreateUserButtonStyle BackColor="#FFFBFF" BorderColor="#CCCCCC" **30** BorderStyle="Solid" BorderWidth="1px" Font-Names="Verdana" **31** ForeColor="#284775" /> **32** <ContinueButtonStyle BackColor="#FFFBFF" BorderColor="#CCCCCC" **33** BorderStyle="Solid" BorderWidth="1px" Font-Names="Verdana" **34** ForeColor="#284775" />

**Fig. 25.56** | CreateNewUser.aspx content page that provides a user registration form. (Part 1 of 2.)

<%@ Page Language="VB" MasterPageFile="~/Bug2Bug.master" Title="Create a New User" %>

<asp:Content ID="Content1" ContentPlaceHolderID="bodyContent" Runat="Server"> <asp:CreateUserWizard ID="CreateUserWizard1" runat="server"

BackColor="#F7F6F3" BorderColor="#E6E2D8" BorderStyle="Solid" BorderWidth="1px" Font-Names="Verdana" Font-Size="0.8em" ContinueDestinationPageUrl="~/Secure/Books.aspx"> <WizardSteps>

<asp:CreateUserWizardStep runat="server"> </asp:CreateUserWizardStep> <asp:CompleteWizardStep runat="server"> </asp:CompleteWizardStep>

</WizardSteps>  

25.6 Case Study: Secure Books Database Application **1089**

**35** <StepStyle BorderWidth="0px" /> **36 37**

**Fig. 25.56** | CreateNewUser.aspx content page that provides a user registration form. (Part 2 of 2.)

</asp:CreateUserWizard> </asp:Content>

(a) (b)

(c)  

**1090** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**_Step 8: Creating a Login Page_** Recall from Section 25.6.1 that Login.aspx is the page in our website that allows return- ing visitors to log into their user accounts. To create this functionality, add another con- tent page named Login.aspx and set its title to Login. In **Design** mode, drag a **Login**

control (located in the **Login** section of the **Toolbox**) to the page’s Content control. Open the **Auto Format** dialog from the **Login Tasks** smart tag menu and set the control’s color scheme to **Professional**.

Next, configure the Login control to display a link to the page for creating new users. Set the Login control’s CreateUserUrl property to CreateNewUser.aspx by clicking the ellipsis button to the property’s right in the **Properties** window and selecting the Create-

NewUser.aspx file in the dialog. Then set the CreateUserText property to Click here to

create a new user. These property values cause a link to appear in the Login control. Finally, change the value of the Login control’s DisplayRememberMe property to

False. By default, the control displays a checkbox and the text Remember me next time. This can be used to allow a user to remain authenticated beyond a single browser session on the user’s current computer. However, we want to require that users log in each time they visit the site, so we disable this option.

The Login control encapsulates the details of logging a user into a web application (i.e., authenticating a user). When a user enters a user name and password, then clicks the **Log In** button, ASP.NET determines whether the items provided match those of an account in the membership database (i.e., ASPNETDB.MDF created by ASP.NET). If they match, the user is authenticated (i.e., the user’s identity is confirmed), and the browser is redirected to the page specified by the Login control’s DestinationPageUrl property. We set this property to the Books.aspx page after creating it in the next section. If the user’s identity cannot be confirmed (i.e., the user is not authenticated), the Login control dis- plays an error message (see Fig. 25.57), and the user can attempt to log in again.

**1** <%-- Fig. 25.57: Login.aspx --%> **2** <%-- Content page using a Login control that authenticates users. --%> **3 4** <asp:Content ID="Content1" ContentPlaceHolderID="bodyContent" **5** Runat="Server"> **6 7 8 9**

**10 11 12** <TitleTextStyle BackColor="#5D7B9D" Font-Bold="True" **13** Font-Size="0.9em" ForeColor="White" /> **14** <InstructionTextStyle Font-Italic="True" ForeColor="Black" /> **15** <TextBoxStyle Font-Size="0.8em" /> **16** <LoginButtonStyle BackColor="#FFFBFF" BorderColor="#CCCCCC" **17** BorderStyle="Solid" BorderWidth="1px" Font-Names="Verdana" **18** Font-Size="0.8em" ForeColor="#284775" /> **19 20** </asp:Content>

**Fig. 25.57** | Login.aspx content page using a Login control. (Part 1 of 2.)

<%@ Page Language="VB" MasterPageFile="~/Bug2Bug.master" Title="Login" %>

<asp:Login ID="Login1" runat="server" BackColor="#F7F6F3" BorderColor="#E6E2D8" BorderPadding="4" BorderStyle="Solid" BorderWidth="1px" CreateUserText="Click here to create a new user" CreateUserUrl="~/CreateNewUser.aspx" DisplayRememberMe="False" Font-Names="Verdana" Font-Size="0.8em" ForeColor="#333333" DestinationPageUrl="~/Secure/Books.aspx">

</asp:Login>  

25.6 Case Study: Secure Books Database Application **1091**

Figure 25.57 presents the completed Login.aspx file. Note that, as in CreateNew-

User.aspx, the Page directive indicates that this content page inherits content from Bug2Bug.master. In the Content control that replaces the master page’s ContentPlace- Holder with ID bodyContent, lines 6–19 create a Login control. Note the CreateUser-

Text and CreateUserUrl properties (lines 8–9) that we set using the **Properties** window. Line 11 in the start tag for the Login control contains the DestinationPageUrl (you will set this property in the next step). The elements in lines 12–18 define various formatting styles applied to parts of the control. Note that all of the functionality related to actually logging the user in or displaying error messages is completely hidden from you.

When a user enters the user name and password of an existing user account, ASP.NET authenticates the user and writes to the client an **encrypted** cookie containing information about the authenticated user. Encrypted data is data translated into a code that only the sender and receiver can understand—thereby keeping it private. The encrypted cookie contains a String user name and a Boolean value that specifies whether this cookie should persist (i.e., remain on the client’s computer) beyond the current session. Our application authenticates the user only for the current session.

**_Step 9: Creating a Content Page That Only Authenticated Users Can Access_** A user who has been authenticated will be redirected to Books.aspx. We now create the Books.aspx file in the Secure folder—the folder for which we set an access rule denying access to anonymous users. If an unauthenticated user requests this file, the user will be redirected to Login.aspx. From there, the user can either log in or a create a new account, both of which will authenticate the user, thus allowing the user to return to Books.aspx.

To create Books.aspx, right click the Secure folder in the **Solution Explorer** and select **Add New Item…**. In the resulting dialog, select **Web Form** and specify the filename Books.aspx. Check the box **Select Master Page** to indicate that this Web Form should be created as a content page that references a master page, then click **Add**. In the **Select a Master Page** dialog, select Bug2Bug.master and click **OK**. The IDE creates the file and

**Fig. 25.57** | Login.aspx content page using a Login control. (Part 2 of 2.)

(b)(a)  

**1092** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

opens it in **Source** mode. Change the Title property of the Page directive to Book Infor-

mation.

**_Step 10: Customizing the Secure Page_** To customize the Books.aspx page for a particular user, we add a welcome message con- taining a **LoginName** control, which displays the current authenticated user name. Open Books.aspx in **Design** mode. In the Content control, type Welcome followed by a comma and a space. Then drag a LoginName control from the **Toolbox** onto the page. When this page executes on the server, the text \[UserName\] that appears in this control in **Design** mode will be replaced by the current user name. In **Source** mode, type an exclamation point (!) directly after the LoginName control (with no spaces in between). \[_Note:_ If you add the exclamation point in **Design** mode, the IDE may insert extra spaces or a line break between this character and the preceding control. Entering the ! in **Source** mode ensures that it appears adjacent to the user’s name.\]

Next, add a LoginStatus control, which will allow the user to log out of the website when finished viewing the listing of books in the database. A **LoginStatus** control renders on a web page in one of two ways—by default, if the user is not authenticated, the control displays a hyperlink with the text Login; if the user is authenticated, the control displays a hyperlink with the text Logout. Each link performs the stated action. Add a LoginStatus control to the page by dragging it from the **Toolbox** onto the page. In this example, any user who reaches this page must already be authenticated, so the control will always render as a Logout link. The **LoginStatus Tasks** smart tag menu allows you switch between the control’s **Views**. Select the **Logged In** view to see the Logout link. To change the actual text of this link, modify the control’s LogoutText property to Click here to log out. Next, set the LogoutAction property to RedirectToLoginPage.

**_Step 11: Connecting the CreateUserWizard and Login Controls to the Secure Page_** Now that we have created Books.aspx, we can specify that this is the page to which the CreateUserWizard and Login controls redirect users after they are authenticated. Open CreateNewUser.aspx in **Design** mode and set the CreateUserWizard control’s Continue- DestinationPageUrl property to Books.aspx. Next, open Login.aspx and select Books.aspx as the DestinationPageUrl of the Login control.

At this point, you can run the web application by selecting **Debug > Start Without Debugging**. First, create a user account on CreateNewUser.aspx, then notice how the LoginName and LoginStatus controls appear on Books.aspx. Next, log out of the site and log back in using Login.aspx.

**_Step 12: Generating a DataSet Based on the Books.mdf Database_** Now, let’s add the content (i.e., book information) to the secure page Books.aspx. This page will provide a DropDownList containing authors’ names and a GridView displaying information about books written by the author selected in the DropDownList. A user will select an author from the DropDownList to cause the GridView to display information about only the books written by the selected author. As you will see, we create this func- tionality entirely in **Design** mode without writing any code.

To work with the Books database, we use an approach slightly different than in the preceding case study, in which we accessed the Guestbook database using a SqlDataSource control. Here we use an **ObjectDataSource** control, which encapsulates an object that  

25.6 Case Study: Secure Books Database Application **1093**

provides access to a data source. An ObjectDataSource can encapsulate a TableAdapter

and use its methods to access the data in the database. This helps separate the data-access logic from the presentation logic. As you will see shortly, the SQL statements used to retrieve data do not appear in the ASPX page when using an ObjectDataSource.

The first step in accessing data using an ObjectDataSource is to create a DataSet that contains the data from the Books database required by the application. In Visual Basic 2005 Express, this occurs automatically when you add a data source to a project. In Visual Web Developer, however, you must explicitly generate the DataSet. Right click the project’s location in the **Solution Explorer** and select **Add New Item…**. In the resulting dialog, select **DataSet** and specify BooksDataSet.xsd as the filename, then click **Add**. A dialog will appear that asks you whether the DataSet should be placed in an App\_Code

folder—a folder whose contents are compiled and made available to all parts of the project. Click **Yes** for the IDE to create this folder to store BooksDataSet.xsd.

**_Step 13: Creating and Configuring an AuthorsTableAdapter_** Once the DataSet is added, the **Dataset Designer** will appear, and the **TableAdapter Con- figuration Wizard** will open. This wizard allows you to configure a TableAdapter for filling a DataTable in a DataSet with data from a database. The Books.aspx page requires two sets of data—a list of authors that will be displayed in the page’s DropDownList (created shortly) and a list of books written by a specific author. We focus on the first set of data here—the authors. Thus, we use the **TableAdapter Configuration Wizard** first to configure an AuthorsTableAdapter. In the next step, we will configure a TitlesTableAdapter.

In the **TableAdapter Configuration Wizard**, select Books.mdf from the drop-down list. Then click **Next >** twice to save the connection string in the application’s Web.config file and move to the **Choose a Command Type** screen.

In the wizard’s **Choose a Command Type** screen, select **Use SQL statements** and click **Next >**. The next screen allows you to enter a SELECT statement for retrieving data from the database, which will then be placed in an Authors DataTable within the Books-

DataSet. Enter the SQL statement

SELECT AuthorID, FirstName + ' ' + LastName AS Name FROM Authors

in the text box on the **Enter a SQL Statement** screen. This query selects the AuthorID of each row. This query’s result will also contain the column Name that is created by concat- enating each row’s FirstName and LastName, separated by a space. The **AS** SQL keyword allows you to generate a column in a query result—called an **alias**—that contains a SQL expression’s result (e.g., FirstName + ' ' + LastName). You’ll soon see how we use this que- ry’s result to populate the DropDownList with items containing the authors’ full names.

After entering the SQL statement, click the **Advanced Options…** button and uncheck **Generate Insert, Update and Delete statements**, since this application does not need to modify the database’s contents. Click **OK** to close the **Advanced Options** dialog. Click **Next >** to advance to the **Choose Methods to Generate** screen. Leave the default names and click **Finish**. Notice that the **DataSet Designer** (Fig. 25.58) now displays a DataTable

named Authors with AuthorID and Name members, and Fill and GetData methods.

**_Step 14: Creating and Configuring a TitlesTableAdapter_** Books.aspx needs to access a list of books by a specific author and a list of authors. Thus we must create a TitlesTableAdapter that will retrieve the desired information from the  

**1094** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

database’s Titles table. Right click the **Dataset Designer** and from the menu that appears, select **Add > TableAdapter…** to launch the **TableAdapter Configuration Wizard**. Make sure the BooksConnectionString is selected as the connection in the wizard’s first screen, then click **Next >**. Choose **Use SQL statements** and click **Next >**.

In the **Enter a SQL Statement** screen, open the **Advanced Options** dialog and uncheck **Generate Insert, Update and Delete statements**, then click **OK**. Our application allows users to filter the books displayed by the author’s name, so we need to build a query that takes an AuthorID as a parameter and returns the rows in the Titles table for books written by that author. To build this complex query, click the **Query Builder…** button.

In the **Add Table** dialog that appears, select **AuthorISBN** and click **Add**. Then **Add** the **Titles** table, too. Our query requires access to data in both of these tables. Click **Close** to exit the **Add Table** dialog. In the **Query Builder** window’s top pane (Fig. 25.59), check the box marked **\* (All Columns)** in the **Titles** table. Next, in the middle pane, add a row with **Column** set to AuthorISBN.AuthorID. Uncheck the **Output** box, because we do not want

**Fig. 25.58** | Authors DataTable in the **Dataset Designer**.

**Fig. 25.59** | **Query Builder** for designing a query that selects books written by a particular author.  

25.6 Case Study: Secure Books Database Application **1095**

the **AuthorID** to appear in our query result. Add an @authorID parameter in this row’s **Filter** column. The SQL statement generated by these actions retrieves information about all books written by the author specified by parameter @authorID. The statement first merges the data from the AuthorISBN and Titles tables. The INNER JOIN clause specifies that the ISBN columns of each table are compared to determine which rows are merged. The INNER JOIN results in a temporary table containing the columns of both tables. The WHERE clause of the SQL statement restricts the book information from this temporary table to a specific author (i.e., all rows in which the AuthorID column is equal to @authorID).

Click **OK** to exit the **Query Builder**, then in the **TableAdapter Configuration Wizard**, click **Next >**. On the **Choose Methods to Generate** screen, enter FillByAuthorID and Get-

DataByAuthorID as the names of the two methods to be generated for the TitlesTable-

Adapter. Click **Finish** to exit the wizard. You should now see a Titles DataTable in the **Dataset Designer** (Fig. 25.60).

**_Step 15: Adding a DropDownList Containing Authors’ First and Last Names_** Now that we have created a BooksDataSet and configured the necessary TableAdapters, we add controls to Books.aspx that will display the data on the web page. We first add the DropDownList from which users can select an author. Open Books.aspx in **Design** mode, then add the text Author: and a DropDownList control named authorsDropDownList in the page’s Content control, below the existing content. The DropDownList initially dis- plays the text \[Unbound\]. We now bind the list to a data source, so the list displays the author information placed in the BooksDataSet by the AuthorsTableAdapter. In the **DropDownList Tasks** smart tag menu, click **Choose Data Source…** to start the **Data Source Configuration Wizard**. Select **<New data source…>** from the **Select a data source** drop- down list in the first screen of the wizard. Doing so opens the **Choose a Data Source Type** screen. Select **Object** and set the ID to authorsObjectDataSource, then click **OK**.

An ObjectDataSource accesses data through another object, often called a **business object**. Recall that the middle tier of a three-tier application contains business logic that controls the way an application’s top-tier user interface (in this case, Books.aspx) accesses the bottom tier’s data (in this case, the Books.mdf database file). Thus, a business object represents the middle tier of an application and mediates interactions between the other two tiers. In an ASP.NET web application, a TableAdapter typically serves as the business object that retrieves the data from the bottom-tier database and makes it available to the top-tier user interface through a DataSet. In the **Choose a Business Object** screen of the **Configure Data Source** wizard (Fig. 25.61), select BooksDataSetTableAdapters.Authors- TableAdapter. \[_Note:_ You may need to save the project to see the AuthorsTableAdapter.\]

**Fig. 25.60** | **Dataset Designer** after adding the TitlesTableAdapter.  

**1096** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

BooksDataSetTableAdapters is a namespace declared by the IDE when you create Books- DataSet. Click **Next >** to continue.

The **Define Data Methods** screen (Fig. 25.62) allows you to specify which of the busi- ness object’s methods (in this case, AuthorsTableAdapter) should be used to obtain the data accessed through the ObjectDataSource. You can choose only methods that return data, so the only choice is method GetData, which returns an AuthorsDataTable. Click **Finish** to close the **Configure Data Source** wizard and return to the **Data Source Configura- tion Wizard** for the DropDownList (Fig. 25.63). The new data source (i.e., authorsObject-

**Fig. 25.61** | Choosing a business object for an ObjectDataSource.

**Fig. 25.62** | Choosing a data method of a business object for use with an ObjectDataSource.  

25.6 Case Study: Secure Books Database Application **1097**

DataSource) should be selected in the top drop-down list. The other two drop-down lists on this screen allow you to configure how the DropDownList control uses the data from the data source. Set Name as the data field to display and AuthorID as the data field to use as the value. Thus, when authorsDropDownList is rendered in a web browser, the list items display the author names, but the underlying values associated with each item are the author AuthorIDs. Finally, click **OK** to bind the DropDownList to the specified data.

The last step in configuring the DropDownList on Books.aspx is to set the control’s **AutoPostBack** property to True. This property indicates that a postback occurs each time the user selects an item in the DropDownList. As you will see shortly, this causes the page’s GridView (created in the next step) to display new data.

**_Step 16: Creating a GridView to Display the Selected Author’s Books_** We now add a GridView to Books.aspx for displaying the book information by the author selected in the authorsDropDownList. Add a GridView named titlesGridView below the other controls in the page’s Content control.

To bind the GridView to data from the Books database, select **<New data source…>** from the **Choose Data Source** drop-down list in the **GridView Tasks** smart tag menu. When the **Data Source Configuration Wizard** opens, select **Object** and set the ID of the data source to titlesObjectDataSource, then click **OK**. In the **Choose a Business Object** screen, select the BooksDataSetTableAdapters.TitlesTableAdapter from the drop-down list to indi- cate the object that will be used to access the data. Click **Next >**. In the **Define Data Methods** screen, leave the default selection of GetDataByAuthorID as the method that will be invoked to obtain the data for display in the GridView. Click **Next >**.

Recall that TitlesTableAdapter method GetDataByAuthorID requires a parameter to indicate the AuthorID for which data should be retrieved. The **Define Parameters** screen (Fig. 25.64) allows you to specify where to obtain the value of the @authorID parameter in the SQL statement executed by GetDataByAuthorID. Select **Control** from the **Parameter source** drop-down list. Select authorsDropDownList as the **ControlID** (i.e., the ID of the

**Fig. 25.63** | Choosing a data source for a DropDownList.  

**1098** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

parameter source control). Next, enter 1 as the **DefaultValue**, so books by Harvey Deitel (who has AuthorID 1 in the database) display when the page first loads (i.e., before the user has made any selections using the authorsDropDownList). Finally, click **Finish** to exit the wizard. The GridView is now configured to display the data retrieved by TitlesTable-

Adapter.GetDataByAuthorID, using the value of the current selection in authorsDrop-

DownList as the parameter. Thus, when the user selects a new author and a postback occurs, the GridView displays a new set of data.

Now that the GridView is tied to a data source, we modify several of the control’s properties to adjust its appearance and behavior. Set the GridView’s CellPadding property to 5, set the BackColor of the AlternatingRowStyle to LightYellow, and set the Back-

Color of the HeaderStyle to LightGreen. Change the Width of the control to 600px to accommodate long data values.

Next, in the **GridView Tasks** smart tag menu, check **Enable Sorting**. This causes the column headings in the GridView to turn into hyperlinks that allow users to sort the data in the GridView. For example, clicking the Titles heading in the web browser will cause the displayed data to appear sorted in alphabetical order. Clicking this heading a second time will cause the data to be sorted in reverse alphabetical order. ASP.NET hides the details required to achieve this functionality.

Finally, in the **GridView Tasks** smart tag menu, check **Enable Paging**. This causes the GridView to split across multiple pages. The user can click the numbered links at the bottom of the GridView control to display a different page of data. GridView’s **PageSize** property determines the number of entries per page. Set the PageSize property to 4 using the **Prop- erties** window so that the GridView displays only four books per page. This technique for displaying data makes the site more readable and enables pages to load more quickly (because less data is displayed at one time). Note that, as with sorting data in a GridView, you do not

**Fig. 25.64** | Choosing the data source for a parameter in a business object’s data method.  

25.6 Case Study: Secure Books Database Application **1099**

need to add any code to achieve paging functionality. Figure 25.65 displays the completed Books.aspx file in **Design** mode.

**_Step 17: Examining the Markup in Books.aspx_** Figure 25.66 presents the markup in Books.aspx (reformatted for readability). Aside from the exclamation point in line 8, which we added manually in **Source** mode, all the remain- ing markup was generated by the IDE in response to the actions we performed in **Design** mode. The Content control (lines 5–53) defines page-specific content that will replace the ContentPlaceHolder named bodyContent. Recall that this control is located in the master page specified in line 3. Line 8 creates the LoginName control, which displays the authen- ticated user’s name when the page is requested and viewed in a browser. Lines 9–11 create the LoginStatus control. Recall that this control is configured to redirect the user to the login page after logging out (i.e., clicking the hyperlink with the LogoutText).

Lines 15–18 define the DropDownList that displays the names of the authors in the Books database. Line 16 contains the control’s AutoPostBack property, which indicates that changing the selected item in the list causes a postback to occur. The DataSourceID

property in line 16 specifies that the DropDownList’s items are created based on the data obtained through the authorsObjectDataSource (defined in lines 19–23). Line 21 spec- ifies that this ObjectDataSource accesses the Books database by calling method GetData

of the BooksDataSet’s AuthorsTableAdapter (line 22). Lines 26–42 create the GridView that displays information about the books written

by the selected author. The start tag (lines 26–29) indicates that paging (with a page size of 4) and sorting are enabled in the GridView. The AutoGenerateColumns property indi- cates whether the columns in the GridView are generated at runtime based on the fields in the data source. This property is set to False, because the IDE-generated Columns element

**Fig. 25.65** | Completed Books.aspx in **Design** mode.  

**1100** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**1** <%-- Fig. 25.66: Books.aspx --%> **2** <%-- Displays information from the Books database. --%> **3** <%@ Page Language="VB" MasterPageFile="~/Bug2Bug.master" **4** Title="Book Information" %> **5** <asp:Content ID="Content1" ContentPlaceHolderID="bodyContent" **6** Runat="Server"> **7** Welcome, **8 9**

**10 11 12** <br /> **13** <br /> **14** Author: **15** <asp:DropDownList ID="authorsDropDownList" runat="server" **16 17 18** </asp:DropDownList> **19 20 21 22 23 24** <br /> **25** <br /> **26 27 28 29 30** <Columns> **31** <asp:BoundField DataField="ISBN" HeaderText="ISBN" **32** ReadOnly="True" SortExpression="ISBN" /> **33** <asp:BoundField DataField="Title" HeaderText="Title" **34** SortExpression="Title" /> **35** <asp:BoundField DataField="EditionNumber" **36** HeaderText="EditionNumber" SortExpression="EditionNumber" /> **37** <asp:BoundField DataField="Copyright" HeaderText="Copyright" **38** SortExpression="Copyright" /> **39** </Columns> **40** <HeaderStyle BackColor="LightGreen" /> **41** <AlternatingRowStyle BackColor="LightYellow" /> **42** </asp:GridView> **43 44 45 46 47** <SelectParameters> **48 49 50 51** </SelectParameters> **52** </asp:ObjectDataSource> **53** </asp:Content>

**Fig. 25.66** | Markup for the completed Books.aspx file. (Part 1 of 2.)

<asp:LoginName ID="LoginName1" runat="server" />! <asp:LoginStatus ID="LoginStatus1" runat="server"

LogoutAction="RedirectToLoginPage" LogoutText="Click here to log out" />

AutoPostBack="True" DataSourceID="authorsObjectDataSource" DataTextField="Name" DataValueField="AuthorID">

<asp:ObjectDataSource ID="authorsObjectDataSource" runat="server" OldValuesParameterFormatString="original\_{0}" SelectMethod="GetData" TypeName="BooksDataSetTableAdapters.AuthorsTableAdapter">

</asp:ObjectDataSource>

<asp:GridView ID="titlesGridView" runat="server" AllowPaging="True" AllowSorting="True" AutoGenerateColumns="False" CellPadding="5" DataKeyNames="ISBN" DataSourceID="titlesObjectDataSource" PageSize="4" Width="600px">

<asp:ObjectDataSource ID="titlesObjectDataSource" runat="server" OldValuesParameterFormatString="original\_{0}" SelectMethod="GetDataByAuthorID" TypeName="BooksDataSetTableAdapters.TitlesTableAdapter">

<asp:ControlParameter ControlID="authorsDropDownList" DefaultValue="1" Name="authorID" PropertyName="SelectedValue" Type="Int32" />  

25.6 Case Study: Secure Books Database Application **1101**

**Fig. 25.66** | Markup for the completed Books.aspx file. (Part 2 of 2.)

(a)

(b)

(c)  

**1102** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

(lines 30–39) already specifies the columns for the GridView using BoundFields. Lines 43–52 define the ObjectDataSource used to fill the GridView with data. Recall that we configured titlesObjectDataSource to use method GetDataByAuthorID of the Books-

DataSet’s TitlesTableAdapter for this purpose. The ControlParameter in lines 48–50 specifies that the value of method GetDataByAuthorID’s parameter comes from the SelectedValue property of the authorsDropDownList.

Figure 25.66(a) depicts the default appearance of Books.aspx in a web browser. Because the DefaultValue property (line 49) of the ControlParameter for the titles-

ObjectDataSource is set to 1, books by the author with AuthorID 1 (i.e., Harvey Deitel) are displayed when the page first loads. Note that the GridView displays paging links below the data, because the number of rows of data returned by GetDataByAuthorID is greater than the page size. Figure 25.66(b) shows the GridView after clicking the 2 link to view the second page of data. Figure 25.66(c) presents Books.aspx after the user selects a dif- ferent author from the authorsDropDownList. The data fits on one page, so the GridView does not display paging links.

**25.7 ASP.NET Ajax** In this section, we introduce how you can use **ASP.NET Ajax** to quickly and easily add Ajax functionality to existing ASP.NET web applications. You can download the latest version of ASP.NET Ajax from www.asp.net/ajax/downloads. Run the.msi installer you downloaded and follow the on-screen instructions to install the **Ajax Extensions package**.

The Ajax Extensions package implements basic Ajax functionality. Microsoft also provides the **ASP.NET Ajax Control Toolkit**, which contains rich, Ajax-enabled GUI controls. There is also a link to the download the latest version of the Ajax Control Toolkit from the ASP.NET Ajax download page listed above. The toolkit does not come with an installer, so you must extract the contents of the toolkit’s ZIP file to your hard drive.

To make using the ASP.NET Ajax Control Toolkit more convenient, you’ll want to add its controls to the **Toolbox** in Visual Web Developer (or in Visual Studio) so you can drag and drop controls onto your Web Forms. To do so, right click the **Toolbox** and choose **Add Tab.** Type Ajax Toolkit in the new tab. Then right click the tab and select **Choose Items**. Navigate to the folder in which you extracted the Ajax Control Toolkit and select AjaxControlToolkit.dll from the SampleWebSite\\Bin folder. A list of available Ajax controls will appear under the **Ajax Toolkit** tab when you are in **Design** mode.

To demonstrate ASP.NET Ajax capabilities we’ll enhance the Validation application from Fig. 25.17. The only modifications to this application will appear in its .aspx file. This application was not initially set up to support Ajax functionality, so we must first modify the web.config file. First, in Visual Web Developer select **File > New Website…** to display the **New Website** dialog. Then, create an empty **ASP.NET Ajax-Enabled Website**. Open the web.config file in this new application and copy its contents. Next, open the Validation application and replace the contents of its web.config file with the contents of the web.config file you just copied. The new web.config file adds the system.web.extensions, httpHandlers and httpModules sections, which specify the set- tings for running scripts that enable Ajax functionality. If you’d like to learn more about the details of these web.config modifications, please visit the site www.asp.net/ajax/doc- umentation/live/configuringASPNETAJAX.aspx.  

25.7 ASP.NET Ajax **1103**

We’ll now use Ajax-enabled controls to add Ajax features to this application. Figure 25.67 is a modified validation.aspx file that enhances the application by using the ToolkitScriptManager, UpdatePanel and ValidatorCalloutExtender controls.

**1** <%-- Fig. 25.67: Validation.aspx --%> **2** <%-- Validation application enhanced by ASP.NET Ajax. --%> **3** <%@ Page Language="VB" AutoEventWireup="false" **4** CodeFile="Validation.aspx.vb" Inherits="Validation" %> **5 6 7 8** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **9** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

**10 11** <html xmlns="http://www.w3.org/1999/xhtml" > **12** <head runat="server"> **13** <title>Demonstrating Validation Controls</title> **14** </head> **15** <body> **16** <form id="form1" runat="server"> **17** <div> **18 19 20 21** &nbsp;Please fill out the following form.<br /><em>All fields are **22** required and must contain valid information.</em><br /><br /> **23** <table> **24** <tr> **25** <td style="width: 100px" valign="top"> **26** Name:</td> **27** <td style="width: 450px" valign="top"> **28** <asp:TextBox ID="nameTextBox" runat="server"> **29** </asp:TextBox> **30** <br /> **31** <asp:RequiredFieldValidator **32** ID="nameInputValidator" runat="server" **33** ControlToValidate="nameTextBox" **34** ErrorMessage="Please enter your name."> **35** </asp:RequiredFieldValidator> **36 37 38** </td> **39** </tr> **40** <tr> **41** <td style="width: 100px" valign="top">E-mail address:</td> **42** <td style="width: 450px" valign="top"> **43** <asp:TextBox ID="emailTextBox" runat="server"> **44** </asp:TextBox> **45** &nbsp;e.g., user@domain.com<br /> **46** <asp:RequiredFieldValidator **47** ID="emailInputValidator" runat="server"

**Fig. 25.67** | Validation application enhanced by ASP.NET Ajax. (Part 1 of 3.)

<%@ Register Assembly="AjaxControlToolkit" Namespace="AjaxControlToolkit" TagPrefix="ajax" %>

<ajax:ToolkitScriptManager ID="ToolkitScriptManager1" runat="server">

</ajax:ToolkitScriptManager>

Display="None"

<ajax:ValidatorCalloutExtender ID="nameInputCallout" runat="server" TargetControlID="nameInputValidator"/>  

**1104** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

**48** ControlToValidate="emailTextBox" **49** ErrorMessage="Please enter your e-mail address."> **50** </asp:RequiredFieldValidator> **51 52 53** <asp:RegularExpressionValidator **54** ID="emailFormatValidator" runat="server" **55** ControlToValidate="emailTextBox" **56** ErrorMessage= **57** "Please enter an e-mail address in a valid format." **58** ValidationExpression= **59** "\\w+(\[-+.'\]\\w+)\*@\\w+(\[-.\]\\w+)\*\\.\\w+(\[-.\]\\w+)\*"> **60** </asp:RegularExpressionValidator> **61 62 63 64** </td> **65** </tr> **66** <tr> **67** <td style="width: 100px; height: 21px" valign="top"> **68** Phone number:</td> **69** <td style="width: 450px; height: 21px" valign="top"> **70** <asp:TextBox ID="phoneTextBox" runat="server"> **71** </asp:TextBox> **72** &nbsp;e.g., (555) 555-1234<br /> **73** <asp:RequiredFieldValidator **74** ID="phoneInputValidator" runat="server" **75** ControlToValidate="phoneTextBox" **76** ErrorMessage="Please enter your phone number."> **77** </asp:RequiredFieldValidator> **78 79 80** <asp:RegularExpressionValidator **81** ID="phoneFormatValidator" runat="server" **82** ControlToValidate="phoneTextBox" **83** ErrorMessage= **84** "Please enter a phone number in a valid format." **85** ValidationExpression= **86** "((\\(\\d{3}\\) ?)|(\\d{3}-))?\\d{3}-\\d{4}"> **87** </asp:RegularExpressionValidator> **88 89 90 91** </td> **92** </tr> **93** </table> **94 95 96 97 98 99 100**

**Fig. 25.67** | Validation application enhanced by ASP.NET Ajax. (Part 2 of 3.)

Display="None"

<ajax:ValidatorCalloutExtender ID="emailInputCallout" runat="server" TargetControlID="emailInputValidator"/>

Display="None"

<ajax:ValidatorCalloutExtender ID="emailFormatCallout" runat="server" TargetControlID="emailFormatValidator"/>

Display="None"

<ajax:ValidatorCalloutExtender ID="phoneInputCallout" runat="server" TargetControlID="phoneInputValidator"/>

Display="None"

<ajax:ValidatorCalloutExtender ID="PhoneFormatCallout" runat="server" TargetControlID="phoneFormatValidator"/>

<asp:UpdatePanel ID="UpdatePanel1" runat="server"> <ContentTemplate>

<asp:Button ID="submitButton" runat="server" Text="Submit" /> <br /><br /><br />&nbsp; <asp:Label ID="outputLabel" runat="server"

Text="Thank you for your submission." Visible="False"> </asp:Label>  

25.7 ASP.NET Ajax **1105**

**_ScriptManager Control_** The key control in every ASP.NET Ajax-enabled application is the **ScriptManager**, which manages the client-side scripts that enable asynchronous Ajax functionality. There can be only one ScriptManager per page. To incorporate controls from the Ajax Control Toolkit you should use the **ToolkitScriptManager** that comes with the toolkit contorls, rather than the ScriptManager from the ASP.NET Ajax Extensions. The ToolkitScriptManager

**101 102 103** </div> **104** </form> **105** </body> **106** </html>

**Fig. 25.67** | Validation application enhanced by ASP.NET Ajax. (Part 3 of 3.)

</ContentTemplate> </asp:UpdatePanel>

a) The user enters an e-mail address in an incorrect format and presses _Tab_ to move to the next input field. A callout appears informing the user to enter an e-mail address in a valid format.

b) After the user fills out the form

properly and clicks the **Submit** button, the

submitted data is displayed at the

bottom of the page with a partial page

update.  

**1106** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

bundles all the scripts associated with ASP. NET Ajax Toolkit controls to optimize the ap- plication’s performance. Drag the ToolkitScriptManager from the **Ajax Toolkit** tab in the toolbox to the top of the page—a script manager must appear before any controls that use the scripts it manages. This generates lines 5–6 and lines 18–20. Lines 5–6 associate the AjaxControlToolkit assembly with the tag prefix ajax, allowing us to put Ajax Control Toolkit elements on the page. Lines 18–20 load the ToolkitScriptManager on the page.

**Common Programming Error 25.1** _Putting more than one instance of the ScriptManager control on a Web Form causes the appli- cation to throw an InvalidOperationException when the page is initialized._ 25.1

**_Partial Page Updates Using the UpdatePanel Control_** The **UpdatePanel control** eliminates full-page refreshes by isolating a section of a page for a partial-page update. To implement a partial-page update, drag the UpdatePanel control from the **Ajax Extensions** tab in the **Toolbox** to your form. Then, drag into the UpdatePan- el the control to update and the control that triggers the update. For this example, drag the outputLabel and submitButton elements into the UpdatePanel. The components that are managed by the UpdatePanel are placed in the ContentTemplate element (lines 95–101) of the UpdatePanel (lines 94–102). When the user clicks the **Submit** button, the UpdatePanel intercepts the request and makes an asynchronous request to the server in- stead. Then the response is inserted in the outputLabel element, and the UpdatePanel re- loads the label to display the new text without refreshing the entire page.

**_Adding Ajax Functionality to ASP.NET Validation Controls Using Ajax Extenders_** Several controls in the Ajax Control Toolkit are **extenders**—components that enhance regular ASP.NET controls. Lines 36–37, 51–52, 61–63, 78–79 and 88–90 define **Vali-**

**datorCalloutExtender controls** that display error messages in small yellow callouts next to the input fields. Line 37 sets the targetControlID property, which indicates the vali- dator control from which the ValidatorCalloutExtender should obtain the error mes- sage to display. The ValidatorCalloutExtenders display error messages with a nicer look and feel, so we no longer need the validator controls to display these messages on their own. For this reason, line 33 sets the Display property of the first validator to None. The remaining control extenders and validator controls are configured similarly.

**_Additional ASP.NET Information_** The Ajax Control Toolkit contains many other extenders and independent controls. You can check them out using the sample website included with the toolkit. The live version of the sample website can be found at www.asp.net/ajax/control-toolkit/live/. For more information on ASP.NET Ajax, check out our ASP.NET Ajax Resource Center at www.deitel.com/aspdotnetajax.

**25.8 Wrap-Up** In this chapter, we introduced web application development using ASP.NET and Visual Web Developer 2005 Express. We began by discussing the simple HTTP transactions that take place when you request and receive a web page through a web browser. You then learned about the three tiers (i.e., the client or top tier, the business logic or middle tier and the information or bottom tier) that comprise most web applications.  

25.9 Web Resources **1107**

Next, we explained the role of ASPX files (i.e., Web Form files) and code-behind files, and the relationship between them. We discussed how ASP.NET compiles and executes web applications so that they can be displayed as XHTML in a web browser. You also learned how to build an ASP.NET web application using Visual Web Developer.

The chapter demonstrated several common ASP.NET web controls used for dis- playing text and images on a Web Form. You learned how to use an AdRotator control to display randomly selected images. We also discussed validation controls, which allow you to ensure that user input on a web page satisfies certain requirements.

We discussed the benefits of maintaining a user’s state information across multiple pages of a website. We then demonstrated how you can include such functionality in a web application using either cookies or session tracking with HttpSessionState objects.

We presented two case studies on building ASP.NET applications that interact with databases. First, we showed how to build a guestbook application that allows users to submit comments about a website. You learned how to save the user input in a SQL Server database and how to display past submissions on the web page.

Finally, we introduced ASP.NET Ajax and the Ajax Control Toolkit. You learned how to add Ajax functionality to an existing application by using the ToolkitScript-

Manager and the UpdatePanel. You also learned how to use validation extenders. The second case study presented a secure web application that requires users to log in

before accessing information from the Books database. You used the **Web Site Administra- tion Tool** to configure the application to use forms authentication and prevent anonymous users from accessing the book information. This case study explained how to use the new ASP.NET 2.0 Login, CreateUserWizard, LoginName and LoginStatus controls to sim- plify user authentication. You also learned to create a uniform look-and-feel for a website using a master page and several content pages. In the next chapter, you will learn about similar web application development techniques with JavaServer Faces, which is imple- mented with the Java programming language.

**25.9 Web Resources** www.deitel.com/aspdotnet/

The Deitel ASP.NET Resource Center focuses on the vast amount of free ASP.NET content avail- able online, plus some for-sale items. Start your search here for tools, downloads, text and video tu- torials, webcasts, podcasts, wikis, documentation, reference manuals, conferences, FAQs, books, e- books, sample chapters, articles, newsgroups, forums, downloads from CNET’s download.com, jobs and contract opportunities, and more that will help you develop ASP.NET-based applications. Keep track of ASP.NET blogs for the latest news and developments, or sign up for RSS feeds to be notified promptly of each new development. Also, download free open-source ASP.NET projects.

**Summary _Section 25.1 Introduction_** • Microsoft’s ASP.NET technology is used for web application development.

• Web-based applications create web content for web-browser clients. This web content includes XHTML, client-side scripting, images and binary data.

• A Web Form file generates a web page that is sent to the client browser. Web Form files have the filename extension .aspx and contain a web page’s GUI. You customize Web Forms by adding web controls.  

**1108** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

• Every ASPX file created in Visual Studio has a corresponding class written in a .NET language. The file that contains this class is called the code-behind file and provides the ASPX file’s pro- grammatic implementation.

**_Section 25.2 Creating and Running a Simple Web Form Example_** • An ASP.NET Web Form typically consists of an ASPX file and a code-behind file.

• Visual Web Developer generates markup when you change a Web Form’s properties and when you add text or controls to a Web Form.

**_Section 25.2.1 Examining an ASPX File_** • ASP.NET comments begin with <%-- and terminate with --%>.

• A Page directive (delimited by <%@ and %>) specifies information needed by ASP.NET to process an ASPX file. The CodeFile attribute of the Page directive indicates the name of the correspond- ing code-behind file. The Language attribute specifies the .NET language used in this file.

• When a control’s runat attribute is set to "server", the control is processed by ASP.NET on the server, generating an XHTML equivalent.

• The asp: tag prefix in a control declaration indicates that a control is an ASP.NET web control.

• Each web control maps to a corresponding XHTML element (or group of elements)—when pro- cessing a web control on the server, ASP.NET generates XHTML markup that will be sent to the client to represent that control in a web browser.

**_Section 25.2.2 Examining a Code-Behind File_** • The code-behind file is a partial class.

• Namespace System.Web.UI contains classes for the creation of web applications and controls.

• Class Page defines a standard web page, providing events and objects necessary for creating Web- based applications. All web pages directly or indirectly inherit from class Page.

• Class Control is the base class that provides common functionality for all web controls.

• Method Page\_Init handles the Init event, which indicates that a page is initialized and ready to execute application-specific initialization code..

**_Section 25.2.3 Relationship Between an ASPX File and a Code-Behind File_** • When a client requests an ASPX file, ASP.NET combines two partial classes—the one defined

in the code-behind file and the one that ASP.NET generates based on the markup in the ASPX file that defines the page’s GUI.

• ASP.NET compiles the combined partial classes and creates a class that represents the page. An instance of this class creates the XHTML that is sent to the client.

• Namespace System.Web.UI.WebControls contains web controls (derived from class WebControl) for designing a page’s user interface.

**_Section 25.2.4 How the Code in an ASP.NET Web Page Executes_** • When an instance of a page is created, the PreInit event occurs first, invoking method

Page\_PreInit. The Init event occurs next, invoking method Page\_Init. Then the Load event occurs, invoking method Page\_Load.

• After Page\_Load finishes executing, the page processes any events raised by the page’s controls.

• When a Web Form object completes the response to the user, an Unload event occurs. Event han- dler Page\_Unload is inherited from class Page and contains any code that releases resources.  

Summary **1109**

**_Section 25.2.5 Examining the XHTML Generated by an ASP.NET Application_** • A form is a mechanism for collecting user information and sending it to the web server.

• XHTML forms can contain visual and nonvisual components.

• Nonvisual components in an XHTML form, called hidden inputs, store any data that the doc- ument author specifies.

**_Section 25.2.6 Building an ASP.NET Web Application_** • The name localhost indicates that the server resides on the local computer. If the web server

were located on a different computer, localhost would be replaced with the appropriate IP ad- dress or hostname.

• DOCUMENT is the name used to represent a Web Form in the **Properties** window.

• The Web Forms Designer’s **Source** mode allows you to view the markup that represents the user interface of a page. The **Design** mode allows you to view the page as it will look and modify it by dragging and dropping controls from the **Toolbox** onto the Web Form.

• Controls and other elements are placed sequentially on a Web Form, much as text and images are placed in a document using word-processing software like Microsoft Word. The positions of controls and other elements flow based on the width of the page by default.

• An alternate type of layout is known as absolute positioning, in which controls are located exactly where they are dropped on the Web Form.

• Visual Web Developer is a WYSIWYG (What You See Is What You Get) editor—whenever you make a change to a Web Form in **Design** mode, the IDE creates the markup (visible in **Source** mode) necessary to achieve the desired visual effects seen in **Design** mode.

• Web.config is a file that stores configuration settings for an ASP.NET web application.

**_Section 25.3 Web Controls_** • The **Standard** section of the **Toolbox** in Visual Web Developer contains several web controls.

**_Section 25.3.1 Text and Graphics Controls_** • The **Insert Table** command from the **Layout** menu in **Design** mode allows you to add an XHTML

table to a Web Form.

• An Image control inserts an image into a web page. The ImageUrl property specifies the file lo- cation of the image to display.

• A TextBox control allows the you to obtain text from the user and display text to the user.

• A DropDownList control provides a list of options to the user. Each item in the drop-down list is defined by a ListItem element.

• Visual Web Developer displays smart tag menus for many ASP.NET controls to facilitate per- forming common tasks. A smart tag menu is opened by clicking the small arrowhead that appears in the upper-right corner of the control in **Design** mode.

• A HyperLink control adds a hyperlink to a web page. The NavigateUrl property of this control specifies the resource that is requested when a user clicks the hyperlink.

• A RadioButtonList control provides a series of radio buttons for the user.

**_Section 25.3.2 AdRotator Control_** • ASP.NET provides the AdRotator web control for displaying advertisements (or any other imag-

es). Using data from an XML file, the AdRotator control randomly selects an image to display and generates a hyperlink to the web page associated with that image.  

**1110** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

• An XmlDataSource references an XML file containing data that will be used in an ASP.NET ap- plication. The **AdRotator Tasks** smart tag menu allows you to create a new XmlDataSource that retrieves advertisement data from an XML file.

• The advertisement file used for an AdRotator control contains Ad elements, each of which pro- vides information about a different advertisement.

• Element ImageUrl in an advertisement file specifies the path (location) of the advertisement’s im- age, and element NavigateUrl specifies the URL that loads when a user clicks the advertisement.

• The AlternateText element contains text that displays in place of the image when the browser cannot locate or render the image for some reason, or to assist the visually impaired.

• Element Impressions specifies how often an image appears, relative to the other images.

**_Section 25.3.3 Validation Controls_** • A validation control (or validator) determines whether the data in another web control is in the

proper format. Validators provide a mechanism for validating user input on the client.

• When the XHTML for a page is created, a validator is converted into ECMAScript, scripting language that enhances the functionality and appearance of Web pages.

• The Visible property of a control indicates whether the control appears in the client’s browser.

• A RequiredFieldValidator ensures that a control receives user input before a form is submitted.

• A validator’s ControlToValidate property indicates which control will be validated.

• A validator’s ErrorMessage property contains text to be displayed if the validation fails.

• A RegularExpressionValidator matches a web control’s content against a regular expression. The regular expression that validates the input is assigned to property ValidationExpression.

• Web programmers using ASP.NET often design their web pages so that the current page reloads when the user submits the form. This event is known as a postback.

• A Page’s IsPostBack property determines whether the page is being loaded due to a postback.

• When data is posted to the web server, the XHTML form’s data is accessible to the web applica- tion through properties of the ASP.NET controls.

• The EnableViewState attribute determines whether a web control’s state persists (i.e., is retained) when a postback occurs.

**_Section 25.4 Session Tracking_** • Personalization makes it possible for e-businesses to communicate effectively with their custom-

ers and also improves users’ ability to locate desired products and services.

• To provide personalized services to consumers, e-businesses must be able to recognize clients when they request information from a site.

• The request/response system on which the web operates is facilitated by HTTP.

• HTTP is a stateless protocol.

• A session represents a unique client on a website. If the client leaves a site and then returns later, the client will still be recognized as the same user. To help the server distinguish among clients, each client must identify itself to the server.

• Tracking individual clients is known as session tracking.

**_Section 25.4.1 Cookies_** • A cookie is a piece of data stored in a small text file on the user’s computer. A cookie maintains

information about the client during and between browser sessions.  

Summary **1111**

• A cookie object is of type HttpCookie. Properties Name and Value of class HttpCookie can be used to retrieve the key and value in a key–value pair (both strings) in a cookie.

• Cookies are sent and received as a collection of type HttpCookieCollection. An application on a server can write cookies to a client using the Response object’s Cookies property. Cookies can be accessed programmatically using the Request object’s Cookies property. Cookies can be read by an application only if they were created in the domain in which the application is running.

• When a Web Form receives a request, the header includes information such as the request type and any cookies that have been sent previously from the server to be stored on the client machine.

• When the server formulates its response, the header information includes any cookies the server wants to store on the client computer.

• The expiration date of a cookie determines how long the cookie remains on the client’s comput- er. If you do not set an expiration date for a cookie, the web browser maintains the cookie for the duration of the browsing session.

• Clients can disable cookies. If they do, they may not be able to use certain web applications.

**_Section 25.4.2 Session Tracking with HttpSessionState_** • Session-tracking capabilities are provided by FCL class HttpSessionState. Every Web Form in-

cludes an HttpSessionState object, which is accessible through property Session of class Page.

• When the web page is requested, an HttpSessionState object is created and assigned to the Page’s Session property. A unique session ID is created for that client, and a temporary cookie is written to the client so the server can identify the client on subsequent requests. Recall that clients may disable cookies in their web browsers to ensure that their privacy is protected. Such clients will experience difficulty using web applications that depend on HttpSessionState ob- jects to maintain state information, unless HttpSessionState is configured to use URL rewriting.

• The Page’s Session property is often referred to as the Session object.

• The Session object’s key–value pairs are often referred to as session items.

• Session items are placed into an HttpSessionState object by calling method Add.

• HttpSessionState objects can store any type of object (not just strings) as attribute values. This provides increased flexibility in maintaining client state information.

• Property SessionID contains the unique session ID. The first time a client connects to the web server, a unique session ID is created for that client. When the client makes additional requests, the client’s session ID is compared with the session IDs stored in the web server’s memory to retrieve the HttpSessionState object for that client.

• Property Timeout specifies the maximum amount of time that an HttpSessionState object can be inactive before it is discarded.

• Property Count provides the number of session items contained in a Session object.

• Indexing the Session object with a key name retrieves the corresponding value.

• Property Keys of class HttpSessionState returns a collection containing all the session’s keys.

**_Section 25.5 Case Study: Connecting to a Database in ASP.NET_** • A GridView ASP.NET data control displays data on a Web Form in a tabular format.

**_Section 25.5.1 Building a Web Form That Displays Data from a Database_** • A GridView’s colors can be set using the **Auto Format…** link in the **GridView Tasks** smart tag menu.

• A SQL Server 2005 Express database used by an ASP.NET website should be located in the project’s App\_Data folder.  

**1112** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

• A SqlDataSource control allows a web application to interact with a database.

• When a SqlDataSource is configured to perform INSERT SQL operations against the database ta- ble from which it gathers data, you must specify the values to insert either programmatically or through other controls on the Web Form.

• The **Command and Parameter Editor**, accessed by clicking the ellipsis next to a SqlDataSource’s InsertQuery property, allows you to specify that parameter values come from controls.

• Each column in a GridView is represented as a BoundField.

• SqlDataSource property ConnectionString indicates the connection through which the Sql-

DataSource control interacts with the database.

• An ASP.NET expression, delimited by <%$ and %>, can be used to access a connection string stored in an application’s Web.config configuration file.

**_Section 25.5.2 Modifying the Code-Behind File for the Guestbook Application_** • A SqlDataSource’s InsertParameters collection contains an item corresponding to each param-

eter in the SqlDataSource’s INSERT command.

• SqlDataSource method Insert executes the control’s INSERT command against the database.

• GridView method DataBind refreshes the information displayed in the GridView.

**_Section 25.6.1 Examining the Completed Secure Books Database Application_** • Forms authentication is a technique that protects a page so that only users known to the website

can access it. Such users are known as the site’s members.

• ASP.NET login controls help create secure applications using authentication. These controls are found in the **Login** section of the **Toolbox**.

• When a user’s identity is confirmed, the user is said to have been authenticated.

• A master page defines common GUI elements that are inherited by each page in a set of content pages. Just as Visual Basic classes can inherit instance variables and methods from existing classes, content pages inherit elements from master pages—this is known as visual inheritance.

**_Section 25.6.2 Creating the Secure Books Database Application_** • ASP.NET hides the details of authenticating users, displaying appropriate success or error mes-

sages and redirecting the user to the correct page based on the authentication results.

• The **Web Site Administration Tool** allows you to configure an application’s security settings, add site users and create access rules that determine who is allowed to access the site.

• By default, anonymous users who attempt to load a page in a directory to which they are denied access are redirected to a page named Login.aspx so that they can identify themselves.

• In an ASP.NET application, a page’s configuration settings are determined by the current direc- tory’s Web.config file. The settings in this file take precedence over the settings in the root direc- tory’s Web.config file.

• A master page contains placeholders for custom content created in a content page, which visually inherits the master page’s content, then adds content in place of the placeholders.

• Master pages have the filename extension .master and, like Web Forms, can optionally use a code-behind file to define additional functionality.

• A Master directive in an ASPX file specifies that the file defines a master page.

• A ContentPlaceHolder control serves as a placeholder for page-specific content defined by a con- tent page using a Content control. The Content control will appear in place of the master page’s ContentPlaceHolder when the content page is requested.  

Terminology **1113**

• A CreateUserWizard control provides a registration form that site visitors can use to create a user account. ASP.NET handles the details of creating a SQL Server database to store the user names, passwords and other account information of the application’s users.

• A Login control encapsulates the details of logging a user into a web application (i.e., authenti- cating a user by comparing the provided user name and password with those of an account in the ASP.NET-created membership database). If the user is authenticated, the browser is redirected to the page specified by the Login control’s DestinationPageUrl property. If the user is not au- thenticated, the Login control displays an error message.

• ASP.NET writes to the client an encrypted cookie containing data about an authenticated user.

• Encrypted data is data translated into a code that only the sender and receiver can understand.

• A LoginName control displays the current authenticated user name on a Web Form.

• A LoginStatus control renders on a web page in one of two ways—by default, if the user is not authenticated (the **Logged Out** view), the control displays a hyperlink with the text Login; if the user is authenticated (the **Logged In** view), the control displays a hyperlink with the text Logout. The LogoutText determines the text of the link in the **Logged In** view.

• An ObjectDataSource control encapsulates a business object that provides access to a data source. A business object (e.g., a TableAdapter) represents the middle tier of an application and mediates interactions between the bottom tier and the top tier.

• The AS SQL keyword allows you to generate a column in a query result—called an alias—that contains the result of a SQL expression.

• A DropDownList’s AutoPostBack property indicates whether a postback occurs each time the user selects an item.

• When you **Enable Sorting** for a GridView, the column headings in the GridView turn into hyper- links that allow users to sort the data it displays.

• When you **Enable Paging** for a GridView, the GridView divides its data among multiple pages. The user can click the numbered links at the bottom of the GridView control to display a different page of data. GridView’s PageSize property determines the number of entries per page.

**_Section 25.7 ASP.NET Ajax_** • ASP.NET Ajax is an extension of ASP.NET that provides a fast and simple way to create Ajax-

enabled applications.

• The ASP.NET Ajax Control Toolkit contains rich controls that implement Ajax functionality.

• The key part of every ASP.NET Ajax-enabled application is the ScriptManager control, which manages the client-side scripts that enable asynchronous functionality.

• The ToolkitScriptManager bundles all the scripts associated with ASP. NET Ajax Toolkit con- trols to optimize the application’s performance.

• The UpdatePanel control eliminates full-page refreshes by isolating a section of a page for a par- tial-page update.

• The components that an UpdatePanel reloads are placed in the ContentTemplate element.

• Several controls in the Ajax Control Toolkit are extenders—components that enhance regular ASP.NET controllers.

**Terminology** <%-- --%> ASP.NET comment delimiters <%$ %> ASP.NET expression delimiters

<%@ %> ASP.NET directive delimiters absolute positioning  

**1114** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

access rule in ASP.NET action attribute of XHTML element form Ad XML element in an AdRotator

advertisement file Add method of class Hashtable Add method of class HttpSessionState AdRotator ASP.NET web control Advertisements XML element in an AdRotator

advertisement file Ajax Control Toolkit Ajax Control Toolkit TooklitScriptManager

control Ajax Control Toolkit

ValidatorCalloutExtender control alias in SQL AlternateText element in an AdRotator

advertisement file AS SQL keyword asp: tag prefix ASP.NET 20 ASP.NET Ajax ASP.NET Ajax extender ASP.NET Ajax ScriptManager control ASP.NET Ajax UpdatePanel control ASP.NET comment ASP.NET expression ASP.NET login control ASP.NET server control **ASP.NET Web Site** in Visual Web Developer ASPX file .aspx filename extension authenticating a user authentication element in Web.config

authorization element in Web.config

AutoEventWireup attribute of ASP.NET page AutoPostBack property of a DropDownList

bottom tier BoundField ASP.NET element **Build Page** command in Visual Web Developer **Build Site** command in Visual Web Developer business logic business object business rule Button ASP.NET Web control client tier code-behind file CodeFile attribute in a Page directive ConnectionString property of a SqlDataSource Content ASP.NET control content page in ASP.NET

ContentPlaceHolder ASP.NET control Control class controller logic ControlParameter ASP.NET element ControlToValidate property of a

validation control cookie Cookies collection of the Response object Cookies property of class Request Count property of class HttpSessionState CreateUserWizard ASP.NET login control data tier DataSourceID property of a GridView

DeleteCommand property of a SqlDataSource

deny element in Web.config

**Design** mode in Visual Web Developer directive in ASP.NET Display property of a validation control DNS (domain name system) server DNS lookup DOCUMENT property of a Web Form domain name system (DNS) server DropDownList ASP.NET web control ECMAScript **Enable Paging** setting for a GridView

**Enable Sorting** setting for a GridView

EnableSessionState property of a Web Form EnableViewState property of a web control encrypted data ErrorMessage property of a validation control expiration date of a cookie forms authentication GET HTTP request GridView ASP.NET data control guestbook on a website hidden input in an XHTML form host hostname HTTP (Hypertext Transfer Protocol) HTTP header HTTP method HttpCookie class HttpCookieCollection class HttpSessionState class hyperlink HyperLink ASP.NET web control hypertext ID attribute of an ASP.NET web control IIS (Internet Information Services) Image ASP.NET web control  

Terminology **1115**

ImageUrl element in an AdRotator

advertisement file ImageUrl property of an Image web control Impressions element in an AdRotator

advertisement file information tier Inherits attribute of an ASP.NET page Init event of an ASP.NET Web page InsertCommand property of a SqlDataSource

InsertQuery property of a SqlDataSource

IP address IsPostBack property of class Page JavaScript key–value pair Keys property of HttpSessionState class Label ASP.NET Web control Language attribute in a Page directive ListItem ASP.NET control Load event of an ASP.NET web page localhost

Login ASP.NET control LoginName ASP.NET login control LoginStatus ASP.NET login control Master directive .master filename extension master page in ASP.NET MasterPageFile property of a Page directive method attribute of XHTML element form middle tier MIME (Multipurpose Internet Mail

Extensions) mode attribute of element authentication in

Web.config

multitier application _n_\-tier application Name property of class HttpCookie NavigateUrl element in an AdRotator

advertisement file NavigateUrl property of a HyperLink control navigation bar on a website ObjectDataSource ASP.NET data control Page class Page directive in ASP.NET Page\_Init event handler Page\_Load event handler Page\_PreInit event handler Page\_Unload event handler PageSize property of a GridView

Parameter ASP.NET element personalization

postback event of an ASP.NET page PreInit event of an ASP.NET web page presentation logic RadioButtonList ASP.NET web control RegularExpressionValidator ASP.NET

validation control relative positioning rendering XHTML in a web browser Request object in ASP.NET RequiredFieldValidator ASP.NET validation

control runat ASP.NET attribute script element in ASP.NET SelectCommand property of a SqlDataSource

server server control session item Session property of class Page session tracking SessionID property of class HttpSessionState smart tag menu in Visual Web Developer **Source** mode in Visual Web Developer span XHTML element SqlDataSource ASP.NET data control System.Web.UI namespace System.Web.UI.WebControls namespace Target property of a HyperLink control TextBox ASP.NET web control tier in a multitier application Timeout property of class HttpSessionState Title property of a Page directive Title property of a Web Form title XHTML element top tier unique session ID of an ASP.NET client Unload event of an ASP.NET page UpdateCommand property of a SqlDataSource

validation control ValidationExpression property of a

RegularExpressionValidator control validator Value property of class HttpCookie **View In Browser** command in Visual Web

Developer \_\_VIEWSTATE hidden input virtual directory Visible property of an ASP.NET Web control visual inheritance web application development web control  

**1116** Chapter 25 ASP.NET 2.0 and ASP.NET Ajax

Web Form **Web Site Administration Tool** Web.config ASP.NET configuration file WebControl class WYSIWYG (What You See Is What You Get)

editor

XHTML markup XHTML tag XmlDataSource ASP.NET data control

**Self-Review Exercises 25.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) Web Form filenames end in .aspx. b) App.config is a file that stores configuration settings for an ASP.NET web application. c) A maximum of one validation control can be placed on a Web Form. d) If no expiration date is set for a cookie, that cookie will be destroyed at the end of the

browser session. e) A LoginStatus control displays the current authenticated user name on a Web Form. f) ASP.NET directives are delimited by <%@ and %>. g) An AdRotator control always displays all ads with equal frequency. h) Each web control maps to exactly one corresponding XHTML element. i) A SqlDataSource control allows a web application to interact with a database.

**25.2** Fill in the blanks in each of the following statements: a) Web applications contain three basic tiers: , , and . b) A control which ensures that the data in another control is in the correct format is called

a(n) . c) A(n) occurs when a page requests itself. d) Every ASP.NET page inherits from class . e) When a page loads, the event occurs first, followed by the event. f) The file contains the functionality for an ASP.NET page. g) A(n) control provides a registration form that site visitors can use to create a

user account. h) A(n) defines common GUI elements that are inherited by each page in a set

of . i) In a multitier application, the tier controls interactions between the applica-

tion’s clients and the application’s data.

**Answers to Self-Review Exercises 25.1** a) True. b) False. Web.config is the file that stores configuration settings for an ASP.NET web application. c) False. An unlimited number of validation controls can be placed on a Web Form. d) True. e) False. A LoginName control displays the current authenticated user name on a Web Form. A LoginStatus control displays a link to either log in or log out, depending on whether the user is currently authenticated. f) True. g) False. The frequency with which the AdRotator displays ads is specified in the AdvertisementFile. h) False. A web control can map to a group of XHTML elements—ASP.NET can generate complex XHTML markup from simple elements in an ASPX file. i) True.

**25.2** a) bottom (information), middle (business logic), top (client). b) validator. c) postback. d) Page. e) PreInit, Init. f) code-behind. g) CreateUserWizard. h) master page, content pages. i) middle.  

Exercises **1117**

**Exercises 25.3** _(WebTime Modification)_ Modify the WebTime example to contain drop-down lists that allow the user to modify such Label properties as BackColor, ForeColor and Font-Size. Configure these drop-down lists so that a postback occurs whenever the user makes a selection. When the page re- loads, it should reflect the specified changes to the properties of the Label displaying the time.

**25.4** _(Page Hit Counter)_ Create an ASP.NET page that uses a persistent cookie (i.e., a cookie with a distant expiration date) to keep track of how many times the client computer has visited the page. Set the HttpCookie object’s Expires property to DateTime.Now.AddMonths(1) to cause the cookie to remain on the client’s computer for one month. Display the number of page hits (i.e., the cookie’s value) every time the page loads.

**25.5** _(WebControls Modification)_ Provide the following functionality for the example in Section 25.3.1: When users click **Register**, store their information in the Users table of the Regis-

tration.mdf database (provided in the chapter’s examples directory). On postback, thank the user for providing the information.

**25.6** _(Guestbook Application Modification)_ Add validation to the guestbook application in Section 25.5. Use validation controls to ensure that the user provides a name, a valid e-mail address and a message.

**25.7** Modify the WebTime example to asynchronously update the label every second. To do so, use the UpdatePanel and Timer ASP.NET Ajax controls. The Timer control refreshes the Update-

Panel each time its Tick even occurs. The interval property of the Timer control determines how often the UpdatePanel should be refreshed.  

26 JavaServer™ Faces Web Applications

**O B J E C T I V E S** In this chapter you will learn:

■ Web application development using Java Technologies and Netbeans.

■ To create JavaServer Pages with JavaServer Faces components.

■ To create web applications consisting of multiple pages.

■ To validate user input on a web page.

■ To maintain state information about a user with session tracking and cookies.

**_If any man will draw up his case, and put his name at the foot of the first page, I will give him an immediate reply. Where he compels me to turn over the sheet, he must wait my leisure._ —Lord Sandwich**

**_Rule One: Our client is always right. Rule Two: If you think our client is wrong, see Rule One._ —Anonymous**

**_A fair question should be followed by a deed in silence._ —Dante Alighieri**

**_You will come here and get books that will open your eyes, and your ears, and your curiosity, and turn you inside out or outside in._ —Ralph Waldo Emerson**  

26.1 Introduction **1119 O**

**u tl**

**in e**

**26.1 Introduction** In this chapter, we introduce web application development with Java-based technology. Web-based applications create web content for web browser clients. This web content in- cludes Extensible HyperText Markup Language (XHTML), client-side scripting, images and binary data. If you are not familiar with XHTML, you should read Chapter 4 before studying this chapter. \[_Note:_ This chapter assumes that you know Java. To learn more about Java, check out _Java How to Program, Seventh Edition_, or visit our Java Resource Centers at www.deitel.com/ResourceCenters.html.\]

This chapter begins with an overview of multitier application architecture and Java’s web technologies for implementing multitier applications. We then present several exam- ples that demonstrate web application development. The first example introduces you to Java web development. In the second example, we build a web application that simply shows the look-and-feel of several web application GUI components. Next, we demon- strate how to use validation components and custom validation methods to ensure that user input is valid before it is submitted for processing on the server. The chapter finishes with two examples of customizing a user’s experience with session tracking.

In Chapter 27, we continue our discussion of Java web application development with more advanced concepts, including the AJAX-enabled components from Sun’s Java Blue- Prints. AJAX helps web-based applications provide the interactivity and responsiveness that users typically expect of desktop applications.

**26.1** Introduction **26.2** Java Web Technologies

**26.2.1** Servlets **26.2.2** JavaServer Pages **26.2.3** JavaServer Faces **26.2.4** Web Technologies in Netbeans

**26.3** Creating and Running a Simple Application in Netbeans **26.3.1** Examining a JSP File **26.3.2** Examining a Page Bean File **26.3.3** Event-Processing Life Cycle **26.3.4** Relationship Between the JSP and Page Bean Files **26.3.5** Examining the XHTML Generated by a Java Web Application **26.3.6** Building a Web Application in Netbeans

**26.4** JSF Components **26.4.1** Text and Graphics Components **26.4.2** Validation Using Validator Components and Custom Validators

**26.5** Session Tracking **26.5.1** Cookies **26.5.2** Session Tracking with the SessionBean Object

**26.6** Wrap-Up **26.7** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

**1120** Chapter 26 JavaServer™ Faces Web Applications

Throughout this chapter and Chapter 27, we use the **Netbeans 5.5.1** IDE, its **Visual Web Pack** and the **Sun Java System Application Server (SJSAS)**. The Visual Web Pack helps you build web applications using Java technologies such as JavaServer Pages and JavaServer Faces. To implement the examples presented in this chapter, you must install all three software products. A bundle of Netbeans 5.5.1 and SJSAS is available at

www.netbeans.info/downloads/index.php?rs=22&p=3

The Visual Web Pack is available at

www.netbeans.org/products/visualweb/

**26.2 Java Web Technologies** Java web technologies continually evolve to provide developers with higher levels of ab- straction and greater separation of the application’s tiers. This separation makes web ap- plications more maintainable and extensible. It also allows for an effective division of labor. A graphic designer can build the application’s user interface without concern for the underlying page logic, which will be handled by a programmer. Meanwhile, the program- mer is free to focus on the application’s business logic, leaving the details of building an attractive and easy-to-use application to the designer. Netbeans is the latest step in this evolution, allowing you to develop a web application’s GUI in a drag-and-drop design tool, while handling the business logic in separate Java classes.

Java multitier applications are typically implemented using the features of Java Enter- prise Edition (Java EE). The technologies we use to develop web applications in Chapters 26–27 are part of Java EE 5 (java.sun.com/javaee).

**26.2.1 Servlets** Servlets are the lowest-level view of web development technologies in Java that we will dis- cuss in this chapter. They use the HTTP request/response model of communication be- tween client and server.

**Servlets** extend a server’s functionality by allowing it to generate dynamic content. For instance, servlets can dynamically generate custom XHTML documents, help provide secure access to a website, interact with databases on behalf of a client and maintain unique session information for each client. A web server component called the **servlet container** executes and interacts with servlets. Packages **javax.servlet** and **javax.servlet.http**

provide the classes and interfaces to define servlets. The servlet container receives HTTP requests from a client and directs each request to the appropriate servlet. The servlet pro- cesses the request and returns an appropriate response to the client—usually in the form of an XHTML or XML (Extensible Markup Language) document to display in the browser. XML is a language used to exchange structured data on the web.

Architecturally, all servlets must implement the **Servlet** interface of package javax.servlet, which ensures that each servlet can execute in the framework provided by the servlet container. Interface Servlet declares methods used by the servlet container to manage the servlet’s life cycle. A servlet’s life cycle begins when the servlet container loads it into memory—usually in response to the first request for the servlet. Before the servlet can handle that request, the container invokes the servlet’s init method, which is called only once during a servlet’s life cycle to initialize the servlet. After init completes execu- tion, the servlet is ready to respond to its first request. All requests are handled by a servlet’s  

26.2 Java Web Technologies **1121**

**service method**, which is the key method in defining a servlet’s functionality. The ser-

vice method receives the request, processes it and sends a response to the client. During a servlet’s life cycle, service is called once per request. Each new request is typically han- dled in a separate thread of execution (managed by the servlet container), so each servlet must be thread safe. When the servlet container terminates the servlet (e.g. when the servlet container needs more memory or when it is shut down), the servlet’s destroy

method is called to release any resources held by the servlet.

**26.2.2 JavaServer Pages JavaServer Pages** (**JSP**) technology is an extension of servlet technology. Each JSP is trans- lated by the JSP container into a servlet. Unlike servlets, JSPs help you separate presenta- tion from content. JavaServer Pages enable web application programmers to create dynamic content by reusing predefined components and by interacting with components using server-side scripting. JSP programmers can use special software components called JavaBeans and custom tag libraries that encapsulate complex, dynamic functionality. A **JavaBean** is a reusable component that follows certain conventions for class design. For example, JavaBeans classes that allow reading and writing of instance variables must pro- vide appropriate _get_ and _set_ methods. The complete set of class design conventions is discussed in the JavaBeans specification (java.sun.com/products/javabeans/glasgow/ index.html).

**_Custom Tag Libraries_ Custom tag libraries** are a powerful feature of JSP that allows Java developers to hide code for database access and other complex operations in **custom tags**. To use such capabilities, you simply add the custom tags to the page. This simplicity enables web-page designers who are not familiar with Java to enhance web pages with powerful dynamic content and dynamic processing capabilities. The JSP classes and interfaces are located in the packages javax.servlet.jsp and javax.servlet.jsp.tagext.

**_JSP Components_** There are four key components to JSPs—directives, actions, scripting elements and tag li- braries. **Directives** are messages to the **JSP container**—the web server component that ex- ecutes JSPs. Directives enable you to specify page settings, to include content from other resources and to specify custom tag libraries for use in JSPs. **Actions** encapsulate function- ality in predefined tags that programmers can embed in JSPs. Actions often are performed based on the information sent to the server as part of a particular client request. They also can create Java objects for use in JSPs. **Scripting elements** enable you to insert Java code that interacts with components in a JSP (and possibly other web application components) to perform request processing. **Tag libraries** are part of the **tag extension mechanism** that enables programmers to create custom tags. Such tags enable web-page designers to ma- nipulate JSP content without prior Java knowledge. The **JavaServer Pages Standard Tag Library** (**JSTL**) provides the functionality for many common web application tasks, such as iterating over a collection of objects and executing SQL statements.

**_Static Content_** JSPs can contain other static content. For example, JSPs normally include XHTML or XML markup. Such markup is known as **fixed-template data** or **fixed-template text**. Any  

**1122** Chapter 26 JavaServer™ Faces Web Applications

literal text or XHTML markup in a JSP is translated to a String literal in the servlet rep- resentation of the JSP.

**_Processing a JSP Request_** When a JSP-enabled server receives the first request for a JSP, the JSP container translates the JSP into a servlet that handles the current request and future requests to the JSP. JSPs thus rely on the same request/response mechanism as servlets to process requests from and send responses to clients.

**Performance Tip 26.1** _Some JSP containers translate JSPs into servlets at the JSP’s deployment time (i.e., when the ap- plication is placed on a web server). This eliminates the translation overhead for the first client that requests each JSP, as the JSP will be translated before it is ever requested by a client._ 26.1

**26.2.3 JavaServer Faces JavaServer Faces (JSF)** is a web application framework (similar to ASP.NET) that simpli- fies the design of an application’s user interface and further separates a web application’s presentation from its business logic. A **framework** simplifies application development by providing libraries and sometimes software tools to help you organize and build your ap- plications. Though the JSF framework can use many technologies to define the pages in web applications, this chapter focuses on JSF applications that use JavaServer Pages. JSF provides a set of user interface components, or **JSF components**, that simplify web-page design. These components are similar to the Swing components used to build GUI appli- cations. JSF provides two JSP custom tag libraries for adding these components to a JSP page. JSF also includes APIs for handling component events (such as processing compo- nent state changes and validating user input), navigating between web application pages and more. You design the look-and-feel of a page with JSF by adding tags to a JSP file and manipulating their attributes. You define the page’s behavior separately in a related Java source-code file.

Though the standard JSF components are sufficient for most basic web applications, you can also write custom component libraries. Additional component libraries are avail- able through the **Java BluePrints** project—which shows best practices for developing Java applications. Many other vendors provide JSF component libraries. For example, Oracle provides almost 100 components in its ADF Faces library. In the next chapter, we discuss one such component library, the BluePrints AJAX components library, which can be found at blueprints.dev.java.net/ajaxcomponents.html.

**26.2.4 Web Technologies in Netbeans** Netbeans web applications consist of one or more JSP web pages built in the JavaServer Faces framework. These JSP files have the filename extension **.jsp** and contain the web pages’ GUI elements. The JSPs can also contain JavaScript to add functionality to the page. JSPs can be customized in Netbeans by adding JSF components, including labels, text fields, images, buttons and other GUI components. The IDE allows you to design pages visually by dragging and dropping these components onto a page; you can also cus- tomize a web page by editing the .jsp file manually.  

26.3 Creating and Running a Simple Application in Netbeans **1123**

Every JSP file created in Netbeans represents a web page and has a corresponding JavaBean class called the **page bean**. A JavaBean class must have a default (or no-argument) constructor, and _get_ and _set_ methods for all of the bean’s properties (i.e., instance vari- ables). The page bean defines properties for each of the page’s elements. The page bean also contains event handlers and page life-cycle methods for managing tasks such as page initialization and rendering, and other supporting code for the web application.

Every Netbeans web application has three other JavaBeans. The **RequestBean** object is maintained in **request scope**—this object exists only for an HTTP request’s duration. A **SessionBean** object has **session scope**—the object exists throughout a user’s browsing ses- sion or until the session times out. There is a unique SessionBean object for each user. Finally, the **ApplicationBean** object has **application scope**—this object is shared by all instances of an application and exists as long as the application remains deployed on a web server. This object is used for application-wide data storage or processing; only one instance exists for the application, regardless of the number of open sessions.

**26.3 Creating and Running a Simple Application in Netbeans** Our first example displays the web server’s time of day in a browser window. When run, this program displays the text "Current Time on the Web Server", followed by the web server’s time. The application contains a single web page and, as mentioned previously, consists of two related files—a JSP file (Fig. 26.1) and a supporting page bean file (Fig. 26.3). The application also has the three scoped data beans for request, session, and application scopes. Since this application does not store data, these beans are not used in this example. We first discuss the markup in the JSP file, the code in the page bean file and the application output, then we provide step-by-step instructions for creating the pro- gram. \[_Note:_ The markup in Fig. 26.1 and other JSP file listings in this chapter is the same as the markup that appears in Netbeans, but we have reformatted these listings for presen- tation purposes to make the code more readable.\]

**1** <?xml version = "1.0" encoding = "UTF-8"?> **2 3** <!-- Fig. 26.1: Time.jsp --> **4** <!-- JSP file generated by Netbeans that displays --> **5** <!-- the current time on the web server --> **6 7 8 9**

**10 11** <jsp:directive.page contentType = "text/html;charset=UTF-8" **12** pageEncoding = "UTF-8" /> **13** <f:view> **14** <webuijsf:page binding = "#{Time.page1}" id = "page1"> **15** <webuijsf:html binding = "#{Time.html1}" id = "html1">

**Fig. 26.1** | JSP file generated by Netbeans that displays the current time on the web server. (Part 1 of 2.)

<jsp:root version = "1.2" xmlns:f = "http://java.sun.com/jsf/core" xmlns:h = "http://java.sun.com/jsf/html" xmlns:jsp = "http://java.sun.com/JSP/Page" xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">  

**1124** Chapter 26 JavaServer™ Faces Web Applications

Netbeans generates all the markup shown in Fig. 26.1 when you set the web page’s title, drag two **Static Text** components onto the page and set the properties of the **Static Text** components. **Static Text** components display text that cannot be edited by the user. We show these steps shortly.

**26.3.1 Examining a JSP File** The JSP files used in this and the following examples are generated almost entirely by Net- beans, which provides a Visual Editor that allows you to build a page’s GUI by dragging and dropping components onto a design area. The IDE generates a JSP file in response to your interactions. Line 1 of Fig. 26.1 is the XML declaration, indicating the fact that the JSP is expressed in XML syntax and the version of XML that is used. Lines 3–5 are com- ments that we added to the JSP to indicate its figure number, filename and purpose.

Line 6 begins the JSP’s root element. All JSPs must have this **jsp:root** element, which has a version attribute to indicate the JSP version being used (line 6) and one or more xmlns attributes (lines 7–10). Each **xmlns attribute** specifies a prefix and a URL for a tag library, allowing the page to use tags from that library. For example, line 9 allows the page to use the standard JSP elements. To use these elements, each element’s tag must be preceded by the jsp prefix. All JSPs generated by Netbeans include the tag libraries spec- ified in lines 7–10 (the JSF core components library, the JSF HTML components library, the JSP standard components library and the JSF user interface components library).

Lines 11–12 are the **jsp:directive.page** element. Its contentType attribute speci- fies the MIME type (text/html) and the character set (UTF-8) the page uses. The page-

**16 17 18 19 20 21 22** <webuijsf:body binding = "#{Time.body1}" id = "body1" **23** style = "-rave-layout: grid"> **24** <webuijsf:form binding = "#{Time.form1}" id = "form1"> **25 26 27 28 29** <webuijsf:staticText binding = "#{Time.clockText}" **30** id = "clockText" style = "background-color: black; **31** color: yellow; font-size: 18px; left: 24px; **32** top: 48px; position: absolute" /> **33** </webuijsf:form> **34** </webuijsf:body> **35** </webuijsf:html> **36** </webuijsf:page> **37** </f:view> **38** </jsp:root>

**Fig. 26.1** | JSP file generated by Netbeans that displays the current time on the web server. (Part 2 of 2.)

<webuijsf:head binding = "#{Time.head1}" id = "head1" title = "Web Time: A Simple Example"> <webuijsf:link binding = "#{Time.link1}" id = "link1"

url = "/resources/stylesheet.css"/> <webuijsf:meta content = "60" httpEquiv = "refresh" />

</webuijsf:head>

<webuijsf:staticText binding = "#{Time.timeHeader}" id = "timeHeader" style = "font-size: 18px;

left: 24px; top: 24px; position: absolute" text = "Current time on the web server:" />  

26.3 Creating and Running a Simple Application in Netbeans **1125**

Encoding attribute specifies the character encoding used by the page source. These attributes help the client (typically a web browser) determine how to render the content.

All pages containing JSF components are represented in a **component tree** (Fig. 26.2) with the root JSF element **f:view**, which is of type **UIViewRoot**. This component tree structure is represented in a JSP by enclosing all JSF component tags inside the f:view

element (lines 13–37). Lines 14–21 begin the JSP’s definition with the **webuijsf:page**, **webuijsf:html** and

**webuijsf::head** tags, all from the webuijsf (JSF user interface components) tag library. These and many other webuijsf page elements have a binding attribute. For example, the webuijsf:head element (line 16) has the attribute binding = "#{Time.head1}." This attribute uses **JSF Expression Language** notation (i.e., #{Time.head1}) to reference the head1 property in the Time class that represents the page bean (you’ll see this class in Fig. 26.3). You can bind an attribute of a JSP element to a property in any of the web appli- cation’s JavaBeans. For instance, the text attribute of a **webuijsf:label** component can be bound to a String property in the application’s SessionBean (shown in Section 26.5.2).

The webuijsf:head element (lines 16–21) has a title attribute that specifies the page’s title. This element also contains a **webuijsf:link** element (lines 18–19) that spec- ifies the CSS stylesheet used by the page, and a **webuijsf:meta** element (line 20) that spec- ifies the page’s refresh rate. The **webuijsf:body** element (lines 22–34) contains a **webuijsf:form** element (lines 24–33), which contains two **webuijsf:staticText** com- ponents (lines 25–28 and 29–32) that display the page’s text. The timeHeader component (lines 25–28) has a text attribute (line 28) that specifies the text to display (i.e., "Current time on the web server"). The clockText component (lines 29–32) does not specify a text attribute because this component’s text will be set programmatically.

i

**Fig. 26.2** | Sample JSF component tree.

jsp:root

f:viewjsp:directive

webuijsf:link (provides stylesheet)

webuijsf:Button

webuijsf:head

webuijsf:html

webuijsf:body (children are visible components)

webuijsf:StaticText  

**1126** Chapter 26 JavaServer™ Faces Web Applications

For the markup in this file to be displayed in a browser, all the JSP’s elements are auto- matically mapped to XHTML elements that the browser recognizes. The same web com- ponent can map to different XHTML elements, depending on the client browser and the component’s property settings. In this example, the webuijsf:staticText components (lines 25–28, 29–32) map to XHTML **span** elements. A span element contains text that is displayed on a web page and is typically used to control the formatting of the text. The style attributes of a JSP’s webuijsf:staticText element will be represented as part of the corresponding span element’s style attribute when the browser renders the page. We show momentarily the XHTML document that results when Time.jsp is requested by a browser.

**26.3.2 Examining a Page Bean File** Figure 26.3 presents the page bean file. Line 3 indicates that this class belongs to package webtime. This line is autogenerated and specifies the project’s name as the package name. Line 18 begins class Time’s declaration and indicates that it inherits from class **Abstract- PageBean** (from package **com.sun.rave.web.ui.appbase**). All page bean classes that sup- port JSP files with JSF components must inherit from the abstract class AbstractPageBean, which provides page life-cycle methods. Note that the IDE makes the class name match the page name. Package **com.sun.webui.jsf.component** includes classes for many of the basic JSF components (see the import statements at lines 6–13).

**1** // Fig. 26.3: Time.java **2** // Page bean file that sets clockText to the time on the Web server. **3** package webtime; **4 5** import com.sun.rave.web.ui.appbase.AbstractPageBean; **6** import com.sun.webui.jsf.component.Body; **7** import com.sun.webui.jsf.component.Form; **8** import com.sun.webui.jsf.component.Head; **9** import com.sun.webui.jsf.component.Html;

**10** import com.sun.webui.jsf.component.Link; **11** import com.sun.webui.jsf.component.Meta; **12** import com.sun.webui.jsf.component.Page; **13** import com.sun.webui.jsf.component.StaticText; **14** import java.text.DateFormat; **15** import java.util.Date; **16** import javax.faces.FacesException; **17 18** public class Time extends AbstractPageBean **19** { **20** private int \_\_placeholder; **21 22** // auto-generated component initialization method. **23** private void \_init() throws Exception **24** { **25** } // end method \_init **26 27** private Page page1 = new Page(); **28**

**Fig. 26.3** | Page bean file that sets clockText to the time on the web server. (Part 1 of 5.)  

26.3 Creating and Running a Simple Application in Netbeans **1127**

**29** public Page getPage1() **30** { **31** return page1; **32** } // end method getPage1 **33 34** public void setPage1( Page p ) **35** { **36** this.page1 = p; **37** } // end method setPage1 **38 39** private Html html1 = new Html(); **40 41** public Html getHtml1() **42** { **43** return html1; **44** } // end method getHtml1 **45 46** public void setHtml1( Html h ) **47** { **48** this.html1 = h; **49** } // end method setHtml1 **50 51** private Head head1 = new Head(); **52 53** public Head getHead1() **54** { **55** return head1; **56** } // end method getHead1 **57 58** public void setHead1( Head h ) **59** { **60** this.head1 = h; **61** } // end method setHead1 **62 63** private Link link1 = new Link(); **64 65** public Link getLink1() **66** { **67** return link1; **68** } // end method getLink1 **69 70** public void setLink1( Link l ) **71** { **72** this.link1 = l; **73** } // end method setLink1 **74 75** private Body body1 = new Body(); **76 77** public Body getBody1() **78** { **79** return body1; **80** } // end method getBody1 **81**

**Fig. 26.3** | Page bean file that sets clockText to the time on the web server. (Part 2 of 5.)  

**1128** Chapter 26 JavaServer™ Faces Web Applications

**82** public void setBody1( Body b ) **83** { **84** this.body1 = b; **85** } // end method setBody1 **86 87** private Form form1 = new Form(); **88 89** public Form getForm1() **90** { **91** return form1; **92** } // end method getForm1 **93 94** public void setForm1( Form f ) **95** { **96** this.form1 = f; **97** } // end method setForm1 **98 99** private StaticText timeHeader = new StaticText(); **100 101** public StaticText getTimeHeader() **102** { **103** return timeHeader; **104** } // end method getTimeHeader **105 106** public void setTimeHeader( StaticText st ) **107** { **108** this.timeHeader = st; **109** } // end method setTimeHeader **110 111 112 113** public StaticText getClockText() **114** { **115** return clockText; **116** } // end method getClockText **117 118 119** { **120** this.clockText = st; **121** } // end method setClockText **122 123** private Meta meta1 = new Meta(); **124 125** public Meta getMeta1() **126** { **127** return meta1; **128** } // end method getMeta1 **129 130** public void setMeta1( Meta m ) **131** { **132** this.meta1 = m; **133** } // end method setMeta1 **134**

**Fig. 26.3** | Page bean file that sets clockText to the time on the web server. (Part 3 of 5.)

private StaticText clockText = new StaticText();

public void setClockText( StaticText st )  

26.3 Creating and Running a Simple Application in Netbeans **1129**

**135** public Time() **136** { **137** } // end Time constructor **138 139** // initializes page content **140** public void init() **141** { **142** super.init(); **143 144** try **145** { **146** \_init(); **147** } // end try **148** catch ( Exception e ) **149** { **150** log( "Time Initialization Failure", e ); **151** throw e instanceof FacesException ? ( FacesException ) e : **152** new FacesException( e ); **153** } // end catch **154** } // end method init **155 156** // method called when postback occurs **157** public void preprocess() **158** { **159** } // end method preprocess **160 161** // method called before the page is rendered **162** public void prerender() **163** { **164 165 166** } // end method prerender **167 168** // method called after rendering completes, if init was called **169** public void destroy() **170** { **171** } // end method destroy **172 173** // return a reference to the scoped data bean **174** protected SessionBean1 getSessionBean1() **175** { **176** return ( SessionBean1 ) getBean( "SessionBean1" ); **177** } // end method getSessionBean1 **178 179** // return a reference to the scoped data bean **180** protected ApplicationBean1 getApplicationBean1() **181** { **182** return ( ApplicationBean1 ) getBean( "ApplicationBean1" ); **183** } // end method getApplicationBean1 **184 185** // return a reference to the scoped data bean **186** protected RequestBean1 getRequestBean1() **187** {

**Fig. 26.3** | Page bean file that sets clockText to the time on the web server. (Part 4 of 5.)

clockText.setValue( DateFormat.getTimeInstance( DateFormat.LONG ).format( new Date() ) );  

**1130** Chapter 26 JavaServer™ Faces Web Applications

This page bean file provides _get_ and _set_ methods for every element of the JSP file of Fig. 26.1. These methods are generated automatically by the IDE. We included the com- plete page bean file in this first example, but in future examples these properties and their _get_ and _set_ methods will be omitted to save space. Lines 99–109 and 111–121 of the page bean file define the two **Static Text** components that we dropped onto the page and their _get_ and _set_ methods. These components are objects of class StaticText in package com.sun.webui.jsf.component.

The only logic required in this page is to set the clockText component’s text to read the current time on the server. We do this in the prerender method (lines 162–166). The meaning of this and other page bean methods will be discussed shortly. Lines 164–165 fetch and format the time on the server and set the value of clockText to that time.

**26.3.3 Event-Processing Life Cycle** Netbeans’s application model places several methods in the page bean that tie into the JSF **event-processing life cycle**. These methods represent four major stages—initialization, preprocessing, prerendering and destruction. Each corresponds to a method in the page bean class—init, preprocess, prerender and destroy, respectively. Netbeans automat- ically creates these methods, but you can customize them to handle life-cycle processing tasks, such as rendering an element on a page only if a user clicks a button.

The **init method** (Fig. 26.3, lines 140–154) is called by the JSP container the first time the page is requested and on postbacks. A **postback** occurs when form data is sub- mitted, and the page and its contents are sent to the server to be processed. Method init

invokes its superclass version (line 142) then tries to call the method \_init (declared in lines 23–25). The \_init method is also automatically generated and handles component initial- ization tasks (if there are any), such as setting the options for a group of radio buttons.

The **preprocess method** (lines 157–159) is called after init, but only if the page is processing a postback. The **prerender method** (lines 162–166) is called just before a page is rendered (i.e., displayed) by the browser. This method should be used to set component properties; properties that are set sooner (such as in method init) may be overwritten before the page is actually rendered by the browser. For this reason, we set the value of clockText in the prerender method.

**188** return ( RequestBean1 ) getBean( "RequestBean1" ); **189** } // end method getRequestBean1 **190** } // end class Time

**Fig. 26.3** | Page bean file that sets clockText to the time on the web server. (Part 5 of 5.)  

26.3 Creating and Running a Simple Application in Netbeans **1131**

Finally, the **destroy method** (lines 169–171) is called after the page has been ren- dered, but only if the init method was called. This method handles tasks such as freeing resources used to render the page.

**26.3.4 Relationship Between the JSP and Page Bean Files** The page bean has a property for every element that appears in the JSP file of Fig. 26.1, from the html element to the two Static Text components. Recall that the elements in the JSP file were explicitly bound to these properties by each element’s binding attribute using a JSF Expression Language statement. Because this is a JavaBean class, _get_ and _set_ methods for each of these properties are also included (lines 27–133). This code is auto- matically generated by the IDE for every web application project.

**26.3.5 Examining the XHTML Generated by a Java Web Application** Figure 26.4 shows the XHTML generated when Time.jsp (Fig. 26.1) is requested by a cli- ent web browser. To view this XHTML, select **View > Source** in Internet Explorer or **View > Page Source** in Firefox. \[_Note:_ We reformatted the XHTML to conform to our coding conventions.\]

**1** <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" **2** "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> **3** <html xmlns = "http://www.w3.org/1999/xhtml" **4** xmlns:wairole = "http://www.w3.org/2005/01/wai-rdf/GUIRoleTaxonomy#" **5** xmlns:waistate = "http://www.w3.org/2005/07/aaa"> **6** <head> **7** <meta content = "no-cache" http-equiv = "Pragma" /> **8** <meta content = "no-cache" http-equiv = "Cache-Control" /> **9** <meta content = "no-store" http-equiv = "Cache-Control" />

**10** <meta content = "max-age=0" http-equiv = "Cache-Control" /> **11** <meta content = "1" http-equiv = "Expires" /> **12** <title>Web Time: A Simple Example</title> **13** <link rel = "stylesheet" type = "text/css" href = "/WebTime/theme/ **14** com/sun/webui/jsf/suntheme/css/css\_master.css" /> **15** <link rel = "stylesheet" type = "text/css" href = "/WebTime/theme/ **16** com/sun/webui/jsf/suntheme/css/ie7.css" /> **17** <script type = "text/javascript"> **18** djConfig = { **19** "isDebug": false, **20** "parseWidgets": false, **21** "debugAtAllCosts": false **22** }; **23** </script> **24** <script type = "text/javascript" **25** src = "/WebTime/theme/META-INF/dojo/dojo.js"></script> **26** <script type = "text/javascript" **27** src = "/WebTime/theme/META-INF/json/json.js"></script> **28** <script type = "text/javascript" **29** src = "/WebTime/theme/META-INF/prototype/prototype.js"></script> **30** <script type = "text/javascript" **31** src = "/WebTime/theme/META-INF/com\_sun\_faces\_ajax.js"></script>

**Fig. 26.4** | XHTML response generated when the browser requests Time.jsp. (Part 1 of 2.)  

**1132** Chapter 26 JavaServer™ Faces Web Applications

The XHTML document in Fig. 26.4 is similar in structure to the JSP file of Fig. 26.1. Lines 1–2 are the document type declaration, which declares this document to be an XHTML

1.0 Transitional document. The XHTML meta tags in lines 7–11 are equivalent to HTTP headers and are used to control browser behavior.

Lines 41–60 define the body of the document. Lines 42–55 define an XHTML form. In this particular program, the user does not submit data to the web server for processing. We demonstrate how to submit data to the server in later examples. Attribute method of the form element (line 42) specifies the method by which the web browser submits the form to the server. By default, JSPs use the post method. The form’s action attribute (line 43) identifies the resource that will be requested when this form is submitted—in this case, /WebTime/faces/Time.jsp.

Note that the two **Static Text** components (i.e., timeHeader and clockText) are rep- resented by two span elements in the XHTML document (lines 45–47, 48–50) as previ- ously discussed. The formatting options that were specified as properties of timeHeader and clockText, such as the font size and text color in the components, are now specified in each span element’s style attribute.

**32** <script type = "text/javascript"> **33** dojo.hostenv.setModulePrefix( "webui.suntheme", **34** "/WebTime/theme/com/sun/webui/jsf/suntheme/javascript" ); **35** dojo.require( 'webui.suntheme.\*' ); **36** </script> **37** <link id = "link1" rel = "stylesheet" type = "text/css" **38** href = "/WebTime/resources/stylesheet.css" /> **39** <meta id = "j\_id\_id7" http-equiv = "refresh" content = "60" /> **40** </head> **41** <body id = "body1" style = "-rave-layout:grid" onload="" onunload=""> **42** <form id = "form1" class = "form" method = "post" **43** action = "/WebTime/faces/Time.jsp" **44** enctype = "application/x-www-form-urlencoded"> **45 46 47 48 49 50 51** <input id = "form1\_hidden" name = "form1\_hidden" **52** value = "form1\_hidden" type = "hidden" /> **53** <input type = "hidden" name = "javax.faces.ViewState" **54** id = "javax.faces.ViewState" value = "j\_id173:j\_id174" /> **55** </form> **56** <script type = "text/javascript"> **57** webui.suntheme.common.body = new webui.suntheme.body( **58** '/Time.jsp', '/WebTime/faces/Time.jsp', null, null, **59** 'com\_sun\_webui\_util\_FocusManager\_focusElementId');</script> **60** </body> **61** </html>

**Fig. 26.4** | XHTML response generated when the browser requests Time.jsp. (Part 2 of 2.)

<span id = "form1:timeHeader" style = "font-size: 18px; left: 24px; top: 24px; position: absolute">Current time on the web server:

</span> <span id = "form1:clockText" style = "background-color: black;

color: yellow; font-size: 18px; left: 24px; top: 48px; position: absolute">12:30:49 PM EDT</span>  

26.3 Creating and Running a Simple Application in Netbeans **1133**

**26.3.6 Building a Web Application in Netbeans** Now that we have presented the JSP file, the page bean file and the resulting XHTML web page sent to the web browser, we discuss the steps to create this application. To build the WebTime application, perform the following steps in Netbeans:

**_Step 1: Creating the Web Application Project_** Select **File > New Project...** to display the **New Project** dialog. In this dialog, select **Web** in the **Categories** pane, **Visual Web Application** in the **Projects** pane and click **Next**. Change the project name to WebTime. In the **Project Location** field, specify where you’d like to store the project. These settings will create a WebTime directory to store the project’s files in the parent directory you specified. Keep the other default settings and click **Finish** to create the web application project.

**_Step 2: Examining the Visual Editor Window of the New Project_** The next several figures describe important features of the IDE, beginning with the **Visual Editor** window (Fig. 26.5). Netbeans creates a single web page named Page1 when a new project is created. This page is open by default in the Visual Editor in **Design mode** when the project first loads. As you drag and drop new components onto the page, **Design** mode allows you to see how your page will be rendered in the browser. The JSP file for this page, named Page1.jsp, can be viewed by clicking the **JSP** button at the top of the visual editor or by right clicking anywhere in the Visual Editor and selecting **Edit JSP Source**. As men- tioned previously, each web page is supported by a page bean file. Netbeans creates a file named Page1.java when a new project is created. To open this file, click the **Java** button at the top of the Visual Editor or right click anywhere in the Visual Editor and select **Edit Java Source**.

The **Preview in Browser** button at the top of the Visual Editor window allows you to view your pages in a browser without having to build and run the application. The **Refresh** button redraws the page in the Visual Editor. The **Show Virtual Forms** button allows you to see which form elements are participating in virtual forms (we discuss this concept in Chapter 27). The **Target Browser Size** drop-down list lets you specify the optimal browser

**Fig. 26.5** | Visual Editor window in **Design** mode.

**Preview in Browser… Refresh Show Virtual Forms Target Browser Size**

**Design** mode

View JSP file

View Java page bean file  

**1134** Chapter 26 JavaServer™ Faces Web Applications

resolution for viewing the page and lets you see what the page will look like in different screen resolutions.

**_Step 3: Examining the Palette in Netbeans_** Figure 26.6 shows the **Palette** displayed in the IDE when the project loads. Part (a) dis- plays the beginning of the **Basic** list of web components, and part (b) displays the remain- ing **Basic** components, as well as the list of **Layout** components. We discuss specific components in Fig. 26.6 as they are used throughout the chapter.

**_Step 4: Examining the Projects Window_** Figure 26.7 displays the **Projects** window, which appears in the upper-left corner of the IDE. This window displays the hierarchy of all files included in the project. The JSP files for each page are listed under the **Web Pages** node. This node also includes the **resources** folder, which contains the CSS stylesheet for the project and any other files the pages may need to display properly, such as image files. All of the Java source code, including the page bean file for each web page and the application, session and request scope beans, can be found under the **Source Packages** node. Another useful file displayed in the project win- dow is the **Page Navigation** file, which defines rules for navigating the project’s pages based on the outcome of some user-initiated event, such as clicking a button or a link. The **Page Navigation** file can also be accessed by right clicking in the Visual Editor while in **Design** mode and selecting **Page Navigation**.

**_Step 5: Examining the JSP and Java Files in the IDE_** Figure 26.8 displays Page1.jsp—the JSP file generated by Netbeans for Page1. \[_Note:_ We reformatted the code to match our coding conventions.\] Click the **JSP** button at the top

**Fig. 26.6** | **Palette** in Netbeans.

(a) (b)  

26.3 Creating and Running a Simple Application in Netbeans **1135**

of the Visual Editor to open the JSP file. When it is first created, this file contains some tags for setting up the page, including linking to the page’s style sheet and defining the necessary JSF libraries. Otherwise, the JSP file’s tags are empty, as no components have been added to the page yet.

Figure 26.9 displays part of Page1.java—the page bean file generated by Netbeans for Page1. Click the **Java** button at the top of the Visual Editor to open the page bean file.

**Fig. 26.7** | **Projects** window for the WebTime project.

**Fig. 26.8** | JSP file generated for Page1 by Netbeans.

CSS stylesheet, images and other

page resources

JSP file

Page Navigation definition file

Java page bean file  

**1136** Chapter 26 JavaServer™ Faces Web Applications

This file contains a Java class with the same name as the page (i.e., Page1), which extends the class AbstractPageBean. As previously mentioned, AbstractPageBean has several methods that manage the page’s life cycle. Four of these methods—init, preprocess, prerender and destroy—are overridden by Page1.java. Other than method init, these methods are initially empty. They serve as placeholders for you to customize the behavior of your web application. The page bean file also includes _get_ and _set_ methods for all of the page’s elements—page, html, head, body and link to start. You can view these _get_ and _set_ methods by clicking the plus (**+**) sign on the line that says **Managed Component Definition**.

**_Step 6: Renaming the JSP and JSF Files_** Typically, you’ll want to rename the JSP and Java files in your project, so that their names are relevant to your application. Right click the Page1.jsp file in the **Projects Window** and select **Rename…** to display the **Rename Class Page1** dialog. Enter the new filename Time. If **Preview All Changes** is checked, the **Refactoring Window** will appear at the bottom of the IDE when you click **Next >**. **Refactoring** is the process of modifying source code to im- prove its readability and reusability without changing its behavior—for example, by re- naming methods or variables, or breaking long methods into shorter ones. Netbeans has built-in refactoring tools that automate some refactoring tasks. Using these tools to re- name the project files updates the name of both the JSP file and the page bean file. The refactoring tool also changes the class name in the page bean file and all of the attribute bindings in the JSP file to reflect the new class name. Note that none of these changes will be made until you click **Do Refactoring** in the **Refactoring Window**. If you do not preview the changes, refactoring occurs when you click **Next >** in the **Rename Class Page1** dialog.

**Fig. 26.9** | Page bean file for Page1.jsp generated by Netbeans.

Click this plus (+) sign to display the hidden generated

code  

26.3 Creating and Running a Simple Application in Netbeans **1137**

**_Step 7: Changing the Title of the Page_** Before designing the content of the web page, we give it the title "Web Time: A Simple Ex- ample". By default, the page does not have a title when it is generated by the IDE. To add a title, open the JSP file in **Design** mode. In the **Properties** window, enter the new title next to the **Title** property and press _Enter_. View the JSP to see that the attribute title = "Web

Time: A Simple Example" was automatically added to the webuijsf:head tag.

**_Step 8: Designing the Page_** Designing a web page is simple in Netbeans. To add components to the page, you can drag and drop them from the **Palette** onto the page in **Design** mode. Like the web page itself, each component is an object that has properties, methods and events. You can set these properties and events visually using the **Properties** window or programmatically in the page bean file. _Get_ and _set_ methods are automatically added to the page bean file for each component you add to the page.

The IDE generates the JSP tags for the components you drag and drop using a grid layout, as specified in the webuijsf:body tag. The components are rendered using **absolute positioning**—they appear exactly where they are dropped on the page. As you add compo- nents, the style attribute in each component’s JSP element will include the number of pixels from the top and left margins of the page at which the component is positioned.

This example uses two **Static Text** components. To add the first one to the page, drag and drop it from the **Palette**’s **Basic** components list to the page in **Design** mode. Edit the component’s text by typing "Current time on the web server:" directly into the compo- nent. The text can also be edited by changing the component’s text property in the **Prop- erties** window. Netbeans is a WYSIWYG (What You See Is What You Get) editor— whenever you make a change to a web page in **Design** mode, the IDE creates the markup (visible in **JSP** mode) necessary to achieve the desired visual effects seen in **Design** mode. After adding the text to the web page, switch to **JSP** mode. You should see that the IDE added a webuijsf:staticText element to the page body, which is bound to the object staticText1, in the page bean file and whose text attribute matches the text you just entered. Back in **Design** mode, click the **Static Text** component to select it. In the **Proper- ties** window, click the ellipsis button next to the style property to open a dialog box to edit the text’s style. Select 18 px for the font size and click **OK**. Again in the **Properties** window, change the id property to timeHeader. Setting the id property also changes the name of the component’s corresponding property in the page bean and updates its binding attribute in the JSP accordingly. Notice that font-size: 18 px has been added to the style attribute and the id attribute has been changed to timeHeader in the com- ponent’s tag in the JSP file. The IDE should now appear as in Fig. 26.10.

Drop a second **Static Text** component onto the page and set its id to clockText. Edit its style property so that the font size is 18 px, the text color is yellow, and the back- ground color is black. Do not edit the component’s text, as this will be set programmat- ically in the page bean file. The component will display with the text **_Static Text_** in the IDE, but will not display any text at runtime unless the text is set programmatically. Figure 26.11 shows the IDE after the second component is added.

**_Step 9: Adding Page Logic_** After designing the user interface, you can modify the page bean file to set the text of the clockText element. In this example, we add a statement to method prerender (lines 170–  

**1138** Chapter 26 JavaServer™ Faces Web Applications

174 of Fig. 26.3). Recall that we use method prerender to ensure that clockText will be updated each time the page is refreshed. Lines 164–165 of Fig. 26.3 programmatically set the text of clockText to the current time on the server. For this statement to work, you’ll also need the two imports shown in lines 14–15 of Fig. 26.3.

We would like this page to refresh automatically to display an up-to-date time. To accomplish this, add <webuijsf:meta content = "60" httpEquiv = "refresh" /> to the JSP file, before the end of the webuijsf:head tag. This tag tells the browser to reload the

**Fig. 26.10** | Time.jsp after inserting the first **Static Text** component.

**Fig. 26.11** | Time.jsp after adding the second StaticText component.  

26.3 Creating and Running a Simple Application in Netbeans **1139**

page automatically every 60 seconds. You can also add this tag by dragging a **Meta** com- ponent from the **Advanced** section of the **Palette** to your page, then setting the compo- nent’s content attribute to 60 and its httpEquiv attribute to refresh. If you do this, the **Meta** component will show up in the **Outline** window.

**_Step 10: Examining the Outline Window_** Figure 26.12 displays the **Outline window** in Netbeans. The **Time** node representing the page bean file is expanded and shows the contents of the component tree. The request, session and application scope beans are collapsed by default, as we have not added any properties to these beans in this example. Clicking an item in the page’s component tree selects the item in the Visual Editor.

**_Step 11: Running the Application_** After creating the web page, you can view it several ways. First, you can select **Build > Build Main Project**, and after the build completes, select **Run > Run Main Project**, to run the appli- cation in a browser window. You can run a project that has already been built by pressing the **Run Main Project** icon ( ) in the toolbar at the top of the IDE. Note that if changes are made to a project, the project must be rebuilt before they will be reflected when the ap- plication is viewed in a browser. Because this application was built on the local file system, the URL displayed in the address bar of the browser when the application is run will be http://localhost:8080/WebTime/ (Fig. 26.3), where 8080 is the port number on which the test server—**Sun Java System Application Server (SJSAS)**—runs by default. \[_Note:_ The port number will depend on the server to which you deploy your web application.\]

Alternatively, you can press _F5_ to build the application, then run it in debug mode— the Netbeans built-in debugger can help you troubleshoot applications. If you type _F6_, the program executes without debugging enabled.

**Error-Prevention Tip 26.1** _If you have trouble building your project due to errors in the Netbeans-generated XML files used for building, try cleaning the project and building again. You can do this by selecting **Build > Clean and Build Main Project** or by pressing_ Shift + F11**.** 26.1

Finally, you can run your built application by opening a browser window and typing the web page’s URL in the **Address** field. Since your application resides on the local file system, you must first start the Sun Java System Application Server. If you have previously run the application using one of the methods above, the server will already be started. Oth-

**Fig. 26.12** | **Outline** window in Netbeans.  

**1140** Chapter 26 JavaServer™ Faces Web Applications

erwise, you can start the server from the IDE by opening the **Runtime** tab (located in the same panel as the **Projects**), expanding the **Servers** node, right clicking **Sun Java System Application Server 9** and selecting **Start**. Then you can type the URL (including the port number for the application server, 8080) in the browser to execute the application. For this example it is not necessary to type the entire URL, http://localhost:8080/

WebTime/faces/Time.jsp. The path to the file Time.jsp (i.e., faces/Time.jsp) can be omitted, because this file was set by default as the project’s start page. For projects with multiple pages, you can change the start page by right clicking the desired page in the **Projects** window and selecting **Set As Start Page**. The start page is indicated by a green arrow next to the page’s name in the **Projects** window.

**26.4 JSF Components** This section introduces some of the JSF components featured in the **Palette** (Fig. 26.6). Figure 26.13 summarizes some of the JSF components used in the chapter examples.

**26.4.1 Text and Graphics Components** Figure 26.14 displays a simple form for gathering user input. This example uses all the components listed in Fig. 26.13, except Label, which you will see in later examples. All the code in Fig. 26.14 was generated by Netbeans in response to actions performed in **De- sign** mode. This example does not perform any tasks when the user clicks **Register**. We ask you to add functionality to this example as an exercise. In successive examples, we demon- strate how to add functionality to many of these JSF components.

Before discussing the JSF components used in this JSP file, we explain the XHTML that creates the layout in Fig. 26.14. As discussed previously, Netbeans uses absolute posi- tioning, so components are rendered wherever they were dropped in the Visual Editor. In this example, in addition to absolute positioning, we use a **Grid Panel** component (lines 37–61) from the **Palette**’s **Layout** component group. The h: prefix indicates that it can be found in the JSF HTML tag library. This component, an object of class HtmlPanelGrid in package javax.faces.component.html, controls the positioning of the components it

JSF component Description

**Label** Displays text that can be associated with an input element.

**Static Text** Displays text that the user cannot edit.

**Text Field** Gathers user input and displays text.

**Button** Triggers an event when clicked.

**Hyperlink** Displays a hyperlink.

**Drop Down List** Displays a drop-down list of choices.

**Radio Button Group** Groups radio buttons.

**Image** Displays images (e.g., GIF and JPG).

**Fig. 26.13** | Commonly used JSF components.  

26.4 JSF Components **1141**

contains. The **Grid Panel** component allows the designer to specify the number of columns the grid should contain. Components may then be dropped anywhere inside the panel, and they will automatically be repositioned into evenly spaced columns in the order in which they are dropped. When the number of components exceeds the number of col- umns, the panel moves the additional components to a new row. In this way, the **Grid Panel** behaves like an XHTML table, and is in fact rendered to the browser as an XHTML table. In this example, we use the **Grid Panel** to control the positions of the **Image** and **Text Field** components in the user information section of the page.

**1** <?xml version = "1.0" encoding = "UTF-8" ?> **2 3** <!-- Fig. 26.14: WebComponents.jsp --> **4** <!-- Registration form that demonstrates JSF components --> **5** <jsp:root version = "1.2" **6** xmlns:f = "http://java.sun.com/jsf/core" **7** xmlns:h = "http://java.sun.com/jsf/html" **8** xmlns:jsp = "http://java.sun.com/JSP/Page" **9** xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType = "text/html;charset=UTF-8" **11** pageEncoding = "UTF-8" /> **12** <f:view> **13** <webuijsf:page binding = "#{WebComponents.page1}" id = "page1"> **14** <webuijsf:html binding = "#{WebComponents.html1}" id = "html1"> **15** <webuijsf:head binding = "#{WebComponents.head1}" id = "head1" **16** title = "Sample Registration Form"> **17** <webuijsf:link binding = "#{WebComponents.link1}" **18** id = "link1" url = "/resources/stylesheet.css" /> **19** </webuijsf:head> **20** <webuijsf:body binding = "#{WebComponents.body1}" id = "body1" **21** style = "-rave-layout: grid"> **22** <webuijsf:form binding = "#{WebComponents.form1}" **23** id = "form1"> **24** <webuijsf:staticText binding = "#{WebComponents.header}" **25** id = "header" style = "font-size: 18px; left: 24px; **26** top: 24px; position: absolute; width: 264px" **27** text = "This is a sample registration form" /> **28** <webuijsf:staticText **29** binding = "#{WebComponents.instructions}" **30** id = "instructions" style = "font-size: 12px; **31** font-style: italic; left: 24px; top: 48px; **32** position: absolute" **33** text = "Please fill in all fields and click Register"/> **34 35 36 37 38 39 40 41** <webuijsf:image binding = "#{WebComponents.image1}" **42** id = "image1" url = "/resources/fname.JPG" />

**Fig. 26.14** | Registration form that demonstrates JSF components. (Part 1 of 3.)

<webuijsf:image binding = "#{WebComponents.userImage}" id = "userImage" style = "left: 24px; top: 72px; position: absolute" url = "/resources/user.JPG" />

<h:panelGrid binding = "#{WebComponents.gridPanel}" columns = "4" id = "gridPanel" style = "height: 96px; left: 24px; top: 96px; position: absolute" width = "576">  

**1142** Chapter 26 JavaServer™ Faces Web Applications

**43 44 45 46** <webuijsf:image binding = "#{WebComponents.image2}" **47** id = "image2" url = "/resources/lname.JPG" /> **48** <webuijsf:textField **49** binding = "#{WebComponents.lastNameTextField}" **50** id = "lastNameTextField" /> **51** <webuijsf:image binding = "#{WebComponents.image4}" **52** id = "image4" url = "/resources/email.JPG" /> **53** <webuijsf:textField **54** binding = "#{WebComponents.emailTextField}" **55** id = "emailTextField" /> **56** <webuijsf:image binding = "#{WebComponents.image3}" **57** id = "image3" url = "/resources/phone.JPG" /> **58** <webuijsf:textField **59** binding = "#{WebComponents.phoneTextField}" **60** id = "phoneTextField" /> **61** </h:panelGrid> **62** <webuijsf:image binding = "#{WebComponents.image5}" **63** id = "image5" style = "left: 24px; top: 216px; **64** position: absolute" **65** url = "/resources/publications.JPG" /> **66** <webuijsf:staticText **67** binding = "#{WebComponents.publicationLabel}" **68** id = "publicationLabel" style = "font-size: 12px; **69** left: 216px; top: 216px; position: absolute" **70** text = "Which book would you like information about?"/> **71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89** <webuijsf:image binding = "#{WebComponents.image6}" **90** id = "image6" style = "left: 24px; top: 312px; **91** position: absolute" url = "/resources/os.JPG" /> **92** <webuijsf:staticText binding = "#{WebComponents.osLabel}" **93** id = "osLabel" style = "font-size: 12px; left: 216px; **94** top: 312px; position: absolute" **95** text = "What operating system are you using?" />

**Fig. 26.14** | Registration form that demonstrates JSF components. (Part 2 of 3.)

<webuijsf:textField binding = "#{WebComponents.firstNameTextField}" id = "firstNameTextField" />

<webuijsf:dropDown binding = "#{WebComponents.booksDropDown}" id = "booksDropDown" items = "#{WebComponents.booksDropDownDefaultOptions.options}" selected= "#{WebComponents.booksDropDownDefaultOptions. selectedValue}" style = "left: 24px; top: 240px; position: absolute" />

<webuijsf:radioButtonGroup binding = "#{WebComponents.osRadioGroup}" id = "osRadioGroup" items = "#{WebComponents.osRadioGroupDefaultOptions.options}" selected = "#{WebComponents.osRadioGroupDefaultOptions. selectedValue}" style = "left: 24px; top: 336px; position: absolute" />

<webuijsf:button binding = "#{WebComponents.registerButton}" id = "registerButton" style = "left: 23px; top: 480px; position: absolute; width: 100px" text = "Register" />  

26.4 JSF Components **1143**

**_Adding a Formatting Component to a Web Page_** To create the layout for the **User Information** section of the form shown in Fig. 26.14, drag a **Grid Panel** component onto the page. In the **Properties** window, change the component’s id to gridPanel and set the component’s columns property to 4. The component also has properties to control the cell padding, cell spacing and other elements of the component’s appearance. In this case, accept the defaults for these properties. Now you can simply drag the **Image**s and **Text Field**s for user information into the **Grid Panel**. The **Grid Panel** will manage their spacing and their organization into rows and columns.

**96 97 98 99 100 101 102** </webuijsf:form> **103** </webuijsf:body> **104** </webuijsf:html> **105** </webuijsf:page> **106** </f:view> **107** </jsp:root>

**Fig. 26.14** | Registration form that demonstrates JSF components. (Part 3 of 3.)

<webuijsf:hyperlink binding = "#{WebComponents.deitelHyperlink}" id = "deitelHyperlink" style = "left: 24px; top: 264px; position: absolute" target = "\_blank" text = "Click here to learn more about our books" url = "http://www.deitel.com" />

**Drop Down List**

**Radio Button Group**

**Text Field**

**Image**

**Button**  

**1144** Chapter 26 JavaServer™ Faces Web Applications

**_Examining Web Components on a Sample Registration Form_** Lines 34–36 of Fig. 26.14 define an **Image** component, an object of class ImageComponent which inserts an image into a web page. The images used in this example are located in this chapter’s examples directory. Images to be displayed on a web page must be placed in the project’s resources folder. To add images to the project, drop an **Image** component onto the page and click the ellipsis button next to the **url** property in the **Properties** win- dow. This opens a dialog in which you can select the image to display. Since no images have been added to the resources folder yet, click the **Add File** button, locate the image on your computer’s file system and click **Add File**. This copies the file you selected into the project’s resources directory. Now you can select the image from the list of files in the resources folder and click **OK** to insert the image into the page.

Lines 37–61 contain an h:panelGrid element representing the **Grid Panel** compo- nent. Within this element, there are eight **Image** and **Text Field** components. **Text Field**s allow you to obtain text input from the user. For example, lines 43–45 define a **Text Field** control used to collect the user’s first name. You can label a **Text Field** by setting its label property, which places text directly above the **Text Field**. Alternatively, you can label a **Text Field** by dragging and dropping a **Label** component onto the page, which allows you to customize the **Label**’s position and style. In this example, we are using images to indicate the purpose of each **Text Field**.

The order in which **Text Fields** are dragged to the page is important, because their JSP tags are added to the JSP file in that order. When a user presses the _Tab_ key to navigate between input fields, they will navigate the fields in the order in which the JSP tags occur in the JSP file. To specify the navigation order, you should drag components onto the page in that order. Alternatively, you can set each input field’s tabIndex property in the **Prop- erties** window to control the order in which the user will tab through the fields. A compo- nent with a tab index of 1 will be the first in the tab sequence.

Lines 71–77 define a **Drop Down List**. When a user clicks the drop-down list, it expands and displays a list from which the user can make a selection. This component is an object of class DropDown and is bound to the object booksDropDownDefaultOptions, a SingleSelectOptionsList object that controls the list of options. This object can be con- figured automatically by right clicking the drop-down list in **Design** mode and selecting **Configure Default Options…**, which opens the **Options Customizer** dialog box to add options to the list. Each option consists of a display String that will represent the option in the browser and a value String that will be returned when programmatically retrieving the user’s selection from the drop-down list. Netbeans constructs the SingleSelectOp-

tionsList object in the page bean file based on the display-value pairs entered in the **Options Customizer** dialog box. To view the code that constructs the object, close the dialog box by clicking **OK**, open the page bean file, and expand the **Creator-managed Com- ponent Definition** node near the top of the file. The object is constructed in the \_init

method, which is called from method init the first time the page loads. Lines 78–84 define a **Radio Button Group** component of class RadioButtonGroup,

which provides a series of radio buttons from which the user can select only one. Like **Drop Down List**, a **Radio Button Group** is bound to a SingleSelectOptionList object. The options can be edited by right clicking the component and selecting **Configure Default Options…**. Also like the drop-down list, the SingleSelectOptionsList is automatically generated by the IDE and placed in the \_init method of the page bean class.  

26.4 JSF Components **1145**

Lines 85–88 define a **Button** component of class Button that triggers an action when clicked. A **Button** component typically maps to an input XHTML element with attribute type set to submit. As stated earlier, clicking the **Register** button in this example does not do anything.

The **Hyperlink** component (lines 96–101) of class Hyperlink adds a link to a web page. The url property of this component specifies the resource (http://www.deitel.com in this case) that is requested when a user clicks the hyperlink. Setting the target property to \_blank specifies that the requested web page should open in a new browser window. By default, **Hyperlink** components cause pages to open in the same browser window.

**26.4.2 Validation Using Validator Components and Custom Validators** This section introduces form **validation**. Validating user input is an important step in col- lecting information from users. Validation helps prevent processing errors due to incom- plete or improperly formatted user input. For example, you may perform validation to ensure that all required fields have been filled out or that a zip-code field contains exactly five digits. Netbeans provides three validator components. A **Length Validator** determines whether a field contains an acceptable number of characters. **Double Range Validators** and **Long Range Validators** determine whether numeric input falls within acceptable ranges. Package **javax.faces.validators** contains the classes for these validators. Netbeans also allows custom validation with validator methods in the page bean file. The following ex- ample demonstrates validation using both a validator component and custom validation.

**_Validating Form Data in a Web Application_** The example in this section prompts the user to enter a name, e-mail address and phone number. After the user enters any data, but before the data is sent to the web server, vali- dation ensures that the user entered a value in each field, that the entered name does not exceed 30 characters, and that the e-mail address and phone number values are in an ac- ceptable format. If the client does not have JavaScript enabled, then the validation would be performed on the server. In this example, (555) 123-4567, 555-123-4567 and 123- 4567 are all considered valid phone numbers. Once the data is submitted, the web server responds by displaying an appropriate message and a **Grid Panel** component repeating the submitted information. Note that a real business application would typically store the sub- mitted data in a database or in a file on the server. We simply send the data back to the page to demonstrate that the server received the data.

**_Building the Web Page_** This web application introduces two additional JSF components—**Label** and **Message** from the **Basic** section of the **Palette**. Each of the page’s three text fields should have its own label and message. **Label** components describe other components and can be associ- ated with user input fields by setting their for property. **Message** components display er- ror messages when validation fails. This page requires three **Text Field**s, three **Label**s and three **Message**s, as well as a submit **Button**. To associate the **Label** components and **Mes- sage** components with their corresponding **Text Field** components, hold the _Ctrl_ and _Shift_ keys, then drag the label or message to the appropriate **Text Field**. In the **Properties** win- dow, notice that each **Label** and **Message** component’s for property is set to the appro- priate **Text Field**.  

**1146** Chapter 26 JavaServer™ Faces Web Applications

You should also add a **Static Text** component to display a validation success message at the bottom of the page. Set the text to "Thank you for your submission.<br/>We received the following information:" and change the component’s id to resultText. In the **Properties** window, unset the component’s rendered and escaped properties. The **rendered** property controls whether the component will be displayed the first time the page loads. Setting **escaped** to false enables the browser to recognize the <br/> tag so it can start a new line of text rather than display the characters "<br/>" in the web page.

Finally, add a **Grid Panel** component below the resultText component. The panel should have two columns, one for displaying **Static Text** components that label the user’s validated data, and one for displaying **Static Text** components that echo back that data. The panel’s rendered property should be set to false so that it is not initialially displayed.

The JSP file for this page is displayed in Fig. 26.15. Lines 34–40, 48–52 and 60–64 define webuijsf:textFields for retrieving the user’s name, e-mail address and phone number, respectively. Lines 31–33, 45–47 and 57–59 define webuijsf:labels for each of these text fields. Lines 41–44, 53–56 and 65–68 define the text fields’ **webuijsf:message** elements. Lines 69–73 define a **Submit** webuijsf:button. Lines 74–78 create a webuijsf:staticText named resultText that displays the response from the server when the user successfully submits the form, and lines 79–99 define a webuijsf:panelGrid that contains components for echoing validated user input to the browser.

**1** <?xml version = "1.0" encoding = "UTF-8"?> **2 3** <!-- Fig. 26.15: Validation.jsp --> **4** <!-- JSP that demonstrates validation of user input. --> **5** <jsp:root version = "1.2" **6** xmlns:f = "http://java.sun.com/jsf/core" **7** xmlns:h = "http://java.sun.com/jsf/html" **8** xmlns:jsp = "http://java.sun.com/JSP/Page" **9** xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType = "text/html;charset=UTF-8" **11** pageEncoding = "UTF-8"/> **12** <f:view> **13** <webuijsf:page binding = "#{Validation.page1}" id = "page1"> **14** <webuijsf:html binding = "#{Validation.html1}" id = "html1"> **15** <webuijsf:head binding = "#{Validation.head1}" id = "head1"> **16** <webuijsf:link binding = "#{Validation.link1}" id = "link1" **17** url = "/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding = "#{Validation.body1}" id = "body1" **20** style = "-rave-layout: grid"> **21** <webuijsf:form binding = "#{Validation.form1}" id = "form1"> **22** <webuijsf:staticText binding = "#{Validation.headerText}" **23** id = "headerText" style = "font-size: 14px; font-weight: **24** bold; left: 24px; top: 24px; position: absolute" **25** text = "Please fill out the following form:"/> **26** <webuijsf:staticText binding = **27** "#{Validation.instructionText}" id = "instructionText" **28** style = "font-size: 12px; font-style: italic; left:

**Fig. 26.15** | JSP that demonstrates validation of user input. (Part 1 of 4.)  

26.4 JSF Components **1147**

**29** 24px; top: 48px; position: absolute" text = "All fields **30** are required and must contain valid information."/> **31** <webuijsf:label binding = "#{Validation.nameLabel}" for = **32** "nameTextField" id = "nameLabel" style = "left: 24px; **33** top: 75px; position: absolute" text = "Name:"/> **34** <webuijsf:textField binding = "#{Validation.nameTextField}" **35** id = "nameTextField" required = "true" style = "left: **36** 96px; top: 72px; position: absolute; width: 216px" **37 38 39** valueChangeListenerExpression = **40** "#{Validation.nameTextField\_processValueChange}"/> **41** <webuijsf:message binding = "#{Validation.nameMessage}" **42** for = "nameTextField" id = "nameMessage" showDetail = **43** "false" showSummary = "true" **44** style = "left: 336px; top: 74px; position: absolute"/> **45** <webuijsf:label binding = "#{Validation.emailLabel}" for = **46** "emailTextField" id = "emailLabel" style = "left: 24px; **47** top: 109px; position: absolute" text = "E-Mail:"/> **48** <webuijsf:textField binding = **49** "#{Validation.emailTextField}" id = "emailTextField" **50** required = "true" style = "left: 96px; top: 106px; **51** position: absolute; width: 216px" **52** /> **53** <webuijsf:message binding = "#{Validation.emailMessage}" **54** for = "emailTextField" id = "emailMessage" showDetail = **55** "false" showSummary = "true" style = "left: 336px; top: **56** 108px; position: absolute"/> **57** <webuijsf:label binding = "#{Validation.phoneLabel}" for = **58** "phoneTextField" id = "phoneLabel" style = "left: 24px; **59** top: 143px; position: absolute" text = "Phone:"/> **60** <webuijsf:textField binding = **61** "#{Validation.phoneTextField}" id = "phoneTextField" **62** required = "true" style = "left: 96px; top: 140px; **63** position: absolute; width: 216px" **64** /> **65** <webuijsf:message binding = "#{Validation.phoneMessage}" **66** for = "phoneTextField" id = "phoneMessage" showDetail = **67** "false" showSummary = "true" style = "left: 336px; top: **68** 142px; position: absolute"/> **69** <webuijsf:button **70** binding = **71** "#{Validation.submitButton}" id = "submitButton" style = **72** "left: 23px; top: 192px; position: absolute; width: **73** 100px" text = "Submit"/> **74** <webuijsf:staticText binding = "#{Validation.resultText}" **75** escape = "false" id = "resultText" rendered = "false" **76** style = "left: 24px; top: 216px; position: absolute" **77** text = "Thank you for your submission.&lt;br/&gt;We **78** received the following information:"/> **79** <h:panelGrid binding = "#{Validation.resultGridPanel}" **80** columns = "2" id = "resultGridPanel" rendered = "false" **81** style = "border-width: 1px; border-style: solid;

**Fig. 26.15** | JSP that demonstrates validation of user input. (Part 2 of 4.)

validatorExpression = "#{Validation.nameLengthValidator.validate}"

validatorExpression = "#{Validation.emailTextField\_validate}"

validatorExpression = "#{Validation.phoneTextField\_validate}"

actionExpression = "#{Validation.submitButton\_action}"  

**1148** Chapter 26 JavaServer™ Faces Web Applications

**82** background-color: #ffff99; height: 96px; left: 24px; **83** top: 264px; position: absolute" width = "288"> **84** <webuijsf:staticText binding = **85** "#{Validation.nameResultLabel}" **86** id = "nameResultLabel" text = "Name:"/> **87** <webuijsf:staticText binding = **88** "#{Validation.nameResult}" id = "nameResult"/> **89** <webuijsf:staticText binding = **90** "#{Validation.emailResultLabel}" **91** id = "emailResultLabel" text = "E-Mail:"/> **92** <webuijsf:staticText binding = **93** "#{Validation.emailResult}" id = "emailResult"/> **94** <webuijsf:staticText binding = **95** "#{Validation.phoneResultLabel}" **96** id = "phoneResultLabel" text = "Phone:"/> **97** <webuijsf:staticText binding = **98** "#{Validation.phoneResult}" id = "phoneResult"/> **99** </h:panelGrid> **100** </webuijsf:form> **101** </webuijsf:body> **102** </webuijsf:html> **103** </webuijsf:page> **104** </f:view> **105** </jsp:root>

**Fig. 26.15** | JSP that demonstrates validation of user input. (Part 3 of 4.)

(a)

(b)  

26.4 JSF Components **1149**

**_Setting the Required Property of an Input Component_** Ensuring that the user has made a selection or entered some text in a required input ele- ment is a basic type of validation. This is accomplished by checking the **required** box in the element’s **Properties** window. If you add a validator component or custom validator method to an input field, the field’s required property must be set to true for validation to occur. Notice that each of the three input webuijsf:textFields in this example has its required property set to true. Also note in the Visual Editor that the label for a required field is automatically marked by a red asterisk. If a user submits this form with empty text fields, the default error message for a required field will be displayed in the empty field’s associated webuijsf:message component. To customize the error message, you must pro- vide a custom validator.

**Fig. 26.15** | JSP that demonstrates validation of user input. (Part 4 of 4.)

(c)

(d)  

**1150** Chapter 26 JavaServer™ Faces Web Applications

**_Using the LengthValidator Component_** In this example, we use the **Length Validator** component (found in the **Validators** section of the **Palette**) to ensure that the length of the user’s name does not exceed 30 characters. This might be useful to ensure that a value will fit in a particular database field.

To add a **Length Validator** to a component, simply drag the validator from the **Palette** and drop it onto the field to validate. A **lengthValidator1** node will appear in the **Outline** window. To edit the validation component’s properties, click this node and set the max-

imum and minimum properties to the desired number of characters in the **Properties** window. Here, we set only the maximum property to 30. We also changed the component’s id to nameLengthValidator. Notice that the nameTextField’s validationExpression

property has been bound to the nameLengthValidator’s validate method in the page bean file (lines 37–38). Remember that most client-side validation can be circumvented, so important validation should always be performed on the server.

This validator allows users to type as much text in the field as they wish, and if they exceed the limit, the default length validation error message will be displayed in the field’s webuijsf:message component after the user clicks the **Submit** button. It is possible to limit the length of user input without using validation. By setting a **Text Field**’s maxLength property, the **Text Field**’s cursor will not advance beyond the maximum allowable number of characters, so the user cannot submit data that exceeds the length limit.

**_Using Regular Expressions to Perform Custom Validation_** Some of the most common validation tasks involve checking user input for appropriate formatting. For instance, it may be necessary to check user-entered e-mail addresses and telephone numbers to ensure that they conform to the standard formatting for valid e-mail addresses and phone numbers. Matching user input against a regular expression is an ef- fective way to ensure that the input is properly formatted. Netbeans does not provide com- ponents for validation using regular expressions, so we will add our own custom validator methods to the page bean file. To add a custom validator to an input component, right click the component and select **Edit Event Handler > validate**. This creates a validation method for the component with an empty body in the page bean file. We’ll add code to this method shortly. Note that both emailTextField and phoneTextField’s validate at- tributes are bound to their respective custom validation methods in the page bean file (lines 51–52 and 63–64).

**_Examining the Page Bean File for a Form That Receives User Input_** Figure 26.16 contains the page bean file for the JSP file in Fig. 26.15. Line 31 sets the maximum length for the nameLengthValidator, which is a property of this page bean. Re- call that the name text field was bound to this property in the JSP file. Method emailTextField\_validate (lines 410–422) and phoneTextField\_validate (lines 426– 438) are the custom validator methods that verify the user-entered e-mail address and phone number, respectively. The submitButton\_action method (lines 441–452) echoes the data back to the user if validation succeeds. The validator methods are called before the event handler, so if validation fails, submitButton\_action will not be called and the user input will not be echoed.

The two custom validator methods in this page bean file validate a text field’s contents against a regular expression using the String method match, which takes a regular expres- sion as an argument and returns true if the String conforms to the specified format.  

26.4 JSF Components **1151**

**1** // Fig. 26.16: Validation.java **2** // Validating user input. **3** package validation; **4 5** import com.sun.rave.web.ui.appbase.AbstractPageBean; **6** import com.sun.webui.jsf.component.Body; **7** import com.sun.webui.jsf.component.Button; **8** import com.sun.webui.jsf.component.Form; **9** import com.sun.webui.jsf.component.Head;

**10** import com.sun.webui.jsf.component.Html; **11** import com.sun.webui.jsf.component.Label; **12** import com.sun.webui.jsf.component.Link; **13** import com.sun.webui.jsf.component.Message; **14** import com.sun.webui.jsf.component.Page; **15** import com.sun.webui.jsf.component.StaticText; **16** import com.sun.webui.jsf.component.TextField; **17** import javax.faces.FacesException; **18** import javax.faces.application.FacesMessage; **19** import javax.faces.component.UIComponent; **20** import javax.faces.component.html.HtmlPanelGrid; **21** import javax.faces.context.FacesContext; **22** import javax.faces.validator.LengthValidator; **23** import javax.faces.validator.ValidatorException; **24 25** public class Validation extends AbstractPageBean **26** { **27** private int \_\_placeholder; **28 29** private void \_init() throws Exception **30** { **31** nameLengthValidator.setMaximum( 30 ); **32** } // end method \_init **33 34 35 36 408** // validates entered email address against the regular expression **409** // that represents the form of a valid email address. **410** public void emailTextField\_validate( FacesContext context, **411** UIComponent component, Object value ) **412** { **413** String email = String.valueOf( value ); **414 415** // if entered email address is not in a valid format **416 417 418 419 420 421 422** } // end method emailTextField\_validate **423**

**Fig. 26.16** | Page bean for validating user input and redisplaying that input if valid. (Part 1 of 2.)

// To save space, we omitted the code in lines 34-407. The complete // source code is provided with this chapter's examples.

if ( !email.matches( "\\\\w+(\[-+.'\]\\\\w+)\*@\\\\w+(\[-.\]\\\\w+)\*\\\\.\\\\w+(\[-.\]\\\\w+)\*" ) )

{ throw new ValidatorException( new FacesMessage(

"Enter a valid email address, e.g. user@domain.com" ) ); } // end if  

**1152** Chapter 26 JavaServer™ Faces Web Applications

For the emailTextField\_validate method, we use the validation expression

\\w+(\[-+.'\]\\w+)\*@\\w+(\[-.\]\\w+)\*\\.\\w+(\[-.\]\\w+)\*

Note that each backslash in the regular expression String (line 417) must be escaped with another backslash (as in \\\\), because the backslash character normally represents the beginning of an escape sequence in Java. This regular expression indicates that an e-mail address is valid if the part before the @ symbol contains one or more word characters (i.e., alphanumeric characters or underscores), followed by zero or more Strings comprised of a hyphen, plus sign, period or apostrophe and additional word characters. After the @ sym- bol, a valid e-mail address must contain one or more groups of word characters potentially separated by hyphens or periods, followed by a required period and another group of one or more word characters potentially separated by hyphens or periods. For example, the e- mail addresses bob's-personal.email@white.email.com, bob-white@my-email.com and bob.white@email.com are all valid. If the user enters text in emailTextField that does not have the correct format and attempts to submit the form, lines 419–420 throw a Valida-

torException. The Message component catches this exception and displays the message in red.

**424** // validates entered phone number against the regular expression **425** // that represents the form of a valid phone number. **426** public void phoneTextField\_validate( FacesContext context, **427** UIComponent component, Object value ) **428** { **429** String phone = String.valueOf( value ); **430 431** // if entered phone number is not in a valid format **432 433 434 435 436 437 438** } // end method phoneTextField\_validate **439 440** // displays the values the user entered **441** public String submitButton\_action() **442** { **443** String name = String.valueOf( nameTextField.getValue() ); **444** String email = String.valueOf( emailTextField.getValue() ); **445** String phone = String.valueOf( phoneTextField.getValue() ); **446** nameResult.setValue( name ); **447** emailResult.setValue( email ); **448** phoneResult.setValue( phone ); **449** resultGridPanel.setRendered( true ); **450** resultText.setRendered( true ); **451** return null; **452** } // end method submitButton\_action **453** } // end class Validation

**Fig. 26.16** | Page bean for validating user input and redisplaying that input if valid. (Part 2 of 2.)

if ( !phone.matches( "((\\\\(\\\\d{3}\\\\) ?)|(\\\\d{3}-))?\\\\d{3}-\\\\d{4}" ) )

{ throw new ValidatorException( new FacesMessage(

"Enter a valid phone number, e.g. (555) 555-1234" ) ); } // end if  

26.5 Session Tracking **1153**

The regular expression in phoneTextField\_validate ensures that the phoneTextBox

contains a valid phone number before the form is submitted. The user input is matched against the regular expression

((\\(\\d{3}\\) ?)|(\\d{3}-))?\\d{3}-\\d{4}

(Again, each backslash is escaped in the regular expression String in line 433.) This ex- pression indicates that a phone number can contain a three-digit area code either in pa- rentheses and followed by an optional space or without parentheses and followed by a required hyphen. After an optional area code, a phone number must contain three digits, a hyphen and another four digits. For example, (555) 123-4567, 555-123-4567 and 123-

4567 are all valid phone numbers. If a user enters an invalid phone number, lines 435–436 throw a ValidatorException The Message component catches this exception and dis- plays the error message in red.

If all six validators are successful (i.e., each TextField contains data, the name is less than 30 characters and the e-mail address and phone number are valid), clicking the **Submit** button sends the form’s data to the server. As shown in Fig. 26.15(d), the submitButton\_action method displays the submitted data in a gridPanel (lines 446– 449) and a success message in resultsText (line 450).

**26.5 Session Tracking** In the early days of the Internet, e-businesses could not provide the kind of customized service typically experienced in “brick-and-mortar” stores. To address this problem, e- businesses began to establish mechanisms by which they could personalize users’ browsing experiences, tailoring content to individual users while enabling them to bypass irrelevant information. Businesses achieve this level of service by tracking each customer’s movement through their websites and combining the collected data with information provided by the consumer, including billing information, personal preferences, interests and hobbies.

**_Personalization_ Personalization** makes it possible for e-businesses to communicate effectively with their customers and also improves the user’s ability to locate desired products and services. Companies that provide content of particular interest to users can establish relationships with customers and build on those relationships over time. Furthermore, by targeting con- sumers with personal offers, recommendations, advertisements, promotions and services, e-businesses create customer loyalty. Websites can use sophisticated technology to allow visitors to customize home pages to suit their individual needs and preferences. Similarly, online shopping sites often store personal information for customers, tailoring notifica- tions and special offers to their interests. Such services encourage customers to visit sites and make purchases more frequently.

**_Privacy_** A trade-off exists, however, between personalized e-business service and protection of pri- vacy. Some consumers embrace the idea of tailored content, but others fear the possible adverse consequences if the info they provide to e-businesses is released or collected by tracking technologies. Consumers and privacy advocates ask: What if the e-business to which we give personal data sells or gives that information to another organization without  

**1154** Chapter 26 JavaServer™ Faces Web Applications

our knowledge? What if we do not want our actions on the Internet—a supposedly anon- ymous medium—to be tracked and recorded by unknown parties? What if unauthorized parties gain access to sensitive private data, such as credit card numbers or medical history? All of these are questions that must be debated and addressed by programmers, consumers, e-businesses and lawmakers alike.

**_Recognizing Clients_** To provide personalized services to consumers, e-businesses must be able to recognize cli- ents when they request information from a site. As we have discussed, the request/response system on which the web operates is facilitated by HTTP. Unfortunately, HTTP is a state- less protocol—it does not support persistent connections that would enable web servers to maintain state information regarding particular clients. So, web servers cannot determine whether a request comes from a particular client or whether a series of requests comes from one or several clients. To circumvent this problem, sites can provide mechanisms to iden- tify individual clients. A session represents a unique client on a website. If the client leaves a site and then returns later, the client will still be recognized as the same user. To help the server distinguish among clients, each client must identify itself to the server.

Tracking individual clients, known as **session tracking**, can be achieved in a number of ways in JSPs. One popular technique uses cookies (Section 26.5.1); another uses the SessionBean object (Section 26.5.2). Additional session-tracking techniques include using input form elements of type "hidden" and URL rewriting. With "hidden" form ele- ments, a Web Form can write session-tracking data into a form in the web page that it returns to the client in response to a prior request. When the user submits the form in the new web page, all the form data, including the "hidden" fields, is sent to the form handler on the web server. With URL rewriting, the web server embeds session-tracking informa- tion directly in the URLs of hyperlinks that the user clicks to send subsequent requests to the web server.

**26.5.1 Cookies Cookies** provide web developers with a tool for personalizing web pages. A cookie is a piece of data typically stored in a text file on the user’s computer. A cookie maintains in- formation about the client during and between browser sessions. The first time a user visits the website, the user’s computer might receive a cookie; this cookie is then reactivated each time the user revisits that site. The aim is to create an anonymous record containing data that is used to personalize the user’s future visits to the site. For example, cookies in a shop- ping application might store unique identifiers for users. When a user adds items to an on- line shopping cart or performs another task resulting in a request to the web server, the server receives a cookie from the client containing the user’s unique identifier. The server then uses the unique identifier to locate the shopping cart and perform any necessary pro- cessing.

In addition to identifying users, cookies also can indicate clients’ shopping prefer- ences. When a web server receives a request from a client, the server can examine the cookie(s) it sent to the client during previous communications, identify the client’s pref- erences and immediately display products of interest to the client.

Every HTTP-based interaction between a client and a server includes a header con- taining information either about the request (when the communication is from the client  

26.5 Session Tracking **1155**

to the server) or about the response (when the communication is from the server to the client). When a page receives a request, the header includes information such as the request type (e.g., GET or POST) and any cookies that have been sent previously from the server to be stored on the client machine. When the server formulates its response, the header infor- mation contains any cookies the server wants to store on the client computer and other information, such as the MIME type of the response.

The **expiration date** of a cookie determines how long the cookie remains on the client’s computer. If you do not set an expiration date for a cookie, the web browser main- tains the cookie for the duration of the browsing session. Otherwise, the web browser maintains the cookie until the expiration date occurs. When the browser requests a resource from a web server, cookies previously sent to the client by that web server are returned to the web server as part of the request formulated by the browser. Cookies are deleted when they **expire**.

**Portability Tip 26.1** _Clients may disable cookies in their web browsers for more privacy. When such clients use web applications that depend on cookies to maintain state information, the applications will not ex- ecute correctly._ 26.1

**_Using Cookies to Provide Book Recommendations_** The next web application shows how to use cookies. The example contains two pages. In the first page (Figs. 26.17 and 26.19), users select a favorite programming language from a group of radio buttons and submit the form to the web server for processing. The web server responds by creating a cookie that stores the selected language and the ISBN num- ber for a recommended book on that topic. The server then renders new components in the browser that allow the user either to select another favorite programming language or to view the second page in our application (Figs. 26.20–26.21), which lists recommended books pertaining to the programming language(s) that the user selected. When the user clicks the hyperlink, the cookies previously stored on the client are read and used to form the list of book recommendations.

The JSP file in Fig. 26.17 contains a **Radio Button Group** (lines 26–30) with the options **Java**, **C++**, **Visual Basic 2005**, **Visual C# 2005** and **Internet & Web** (set in the page bean). Recall that you can set the display and value Strings of radio buttons by right clicking the **Radio Button Group** and selecting **Configure Default Options…**. The user selects a programming language by clicking a radio button. When the user presses **Submit**, the web application creates a cookie containing the selected language. This cookie is added to the HTTP response header and sent to the client as part of the response.

**1** <?xml version = "1.0" encoding = "UTF-8"?> **2 3** <!-- Fig. 26.17: Options.jsp --> **4** <!-- JSP file that allows the user to select a programming language --> **5** <jsp:root version = "1.2" **6** xmlns:f = "http://java.sun.com/jsf/core"

**Fig. 26.17** | JSP file that allows the user to select a programming language. (Part 1 of 4.)  

**1156** Chapter 26 JavaServer™ Faces Web Applications

**7** xmlns:h = "http://java.sun.com/jsf/html" **8** xmlns:jsp = "http://java.sun.com/JSP/Page" **9** xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType = "text/html;charset=UTF-8" **11** pageEncoding = "UTF-8"/> **12** <f:view> **13** <webuijsf:page binding = "#{Options.page1}" id = "page1"> **14** <webuijsf:html binding = "#{Options.html1}" id = "html1"> **15** <webuijsf:head binding = "#{Options.head1}" id = "head1"> **16** <webuijsf:link binding = "#{Options.link1}" id = "link1" **17** url = "/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding = "#{Options.body1}" id = "body1" **20** style = "-rave-layout: grid"> **21** <webuijsf:form binding = "#{Options.form1}" id = "form1"> **22** <webuijsf:staticText binding = "#{Options.instructionText}" **23** id = "instructionText" style = "font-size: 18px; **24** left: 24px; top: 24px; position: absolute" **25** text = "Select a programming language:"/> **26** <webuijsf:radioButtonGroup binding = **27** "#{Options.languageRadioGroup}" id = **28** "languageRadioGroup" items = **29** "#{Options.languageRadioGroupDefaultOptions.options}" **30** style = "left: 24px; top: 48px; position: absolute"/> **31** <webuijsf:button actionExpression = **32** "#{Options.submitButton\_action}" binding = **33** "#{Options.submitButton}" id = "submitButton" style = **34** "left: 23px; top: 192px; position: absolute; **35** width: 100px" text = "Submit"/> **36** <webuijsf:staticText binding = "#{Options.responseText}" **37** id = "responseText" rendered = "false" style = **38** "font-size: 18px; left: 24px; top: 24px; **39** position: absolute"/> **40** <webuijsf:hyperlink actionExpression = **41** "#{Options.languagesLink\_action}" binding = **42** "#{Options.languagesLink}" id = "languagesLink" **43** rendered = "false" style = "left: 24px; top: 72px; **44** position: absolute" text = **45** "Click here to choose another language."/> **46** <webuijsf:hyperlink actionExpression = **47** "#{Options.recommendationsLink\_action}" binding = **48** "#{Options.recommendationsLink}" id = **49** "recommendationsLink" rendered = "false" style = **50** "left: 24px; top: 96px; position: absolute" **51** text = "Click here to get book recommendations." **52** url = "/faces/Recommendations.jsp"/> **53** </webuijsf:form> **54** </webuijsf:body> **55** </webuijsf:html> **56** </webuijsf:page> **57** </f:view> **58** </jsp:root>

**Fig. 26.17** | JSP file that allows the user to select a programming language. (Part 2 of 4.)  

26.5 Session Tracking **1157**

**Fig. 26.17** | JSP file that allows the user to select a programming language. (Part 3 of 4.)

(a)

(b)

(c)  

**1158** Chapter 26 JavaServer™ Faces Web Applications

When the user clicks **Submit**, the webuijsf:staticText, webuijsf:radioButton- Group and webuijsf:button elements used to select a language are hidden, and a webuijsf:staticText and two webuijsf:hyperlink elements are displayed. One webuijsf:staticText and both webuijsf:hyperlinks initially have their rendered prop- erties set to false (lines 37, 43, and 49). This indicates that these components are not vis- ible the first time the page loads, as we want the user’s first view of the page to include only the components for selecting a programming language and submitting the selection.

The first hyperlink (lines 40–45) requests this page, and the second (lines 46–52) requests Recommendations.jsp. The url property is not set for the first link; we discuss this momentarily. The second link’s url property is set to /faces/Recommendations.jsp. Recall that earlier in the chapter, we set a url property to a remote website (http:// www.deitel.com). To set this property to a page within the current application, you can click the ellipsis button next to the url property in the **Properties** window to open a dialog. You can then use this dialog to select a page within your project as the link’s destination.

**_Adding and Linking to a New Web Page_** Setting the url property to a page in the current application requires that the destination page already exists. To set the url property of a link to Recommendations.jsp, you must first create this page. Right click the **Web Pages** node in the **Projects** window and select **New > Page…** from the menu that appears. In the **New Page** dialog, change the name of the page to Recommendations and click **Finish** to create the files Recommendations.jsp and Recommendations.java. (We discuss the contents of these files shortly.) Once the Recom- mendations.jsp file exists, you can select it as the url value for recommendationsLink.

For Options.jsp, rather than setting the languagesLink’s url property, we will add an action handler for this component to the page bean. The action handler will enable us to show and hide components of the page without redirecting the user to another page. Specifying a destination url would override the component’s action handler and redirect the user to the specified page, so it is important that we do not set the url property in this case. Since we use this link to reload the current page, we simply return null from the action handler, causing Options.jsp to reload.

To add an action handler to a hyperlink that should also direct the user to another page, you must add a rule to the **Page Navigation** file (Fig. 26.18). To edit this file, right

**Fig. 26.17** | JSP file that allows the user to select a programming language. (Part 4 of 4.)

(d)  

26.5 Session Tracking **1159**

click anywhere in the Visual Designer and select **Page Navigation**. Click Options.jsp in the navigation designer to display its components that might cause the page to request another page. Locate the link whose navigation rule you would like to set (recommenda- tionsLink in this case) and drag it to the destination page. Now the link can direct the user to a new page (Recommendations.jsp) without overriding its action handler. Editing the **Page Navigation** file is also useful when you would like action elements that cannot specify a url property, such as buttons, to direct users to another page. You’ll configure a link from Recommendations.asp to Options.jsp later in this section.

Figure 26.19 contains the code that writes a cookie to the client machine when the user selects a programming language. The file also determines which components appear on the page, displaying either the components for choosing a language or the links for nav- igating the application, depending on the user’s actions.

**Fig. 26.18** | Editing the **Page Navigation** file.

**1** // Fig. 26.19: Options.java **2** // Page bean that stores user's language selection as a client cookie. **3** package sessiontrackingcookies; **4 5** import com.sun.rave.web.ui.appbase.AbstractPageBean; **6** import com.sun.webui.jsf.component.Body; **7** import com.sun.webui.jsf.component.Button; **8** import com.sun.webui.jsf.component.Form; **9** import com.sun.webui.jsf.component.Head;

**10** import com.sun.webui.jsf.component.Html; **11** import com.sun.webui.jsf.component.Hyperlink; **12** import com.sun.webui.jsf.component.Link; **13** import com.sun.webui.jsf.component.Page; **14** import com.sun.webui.jsf.component.RadioButtonGroup; **15** import com.sun.webui.jsf.component.StaticText; **16** import com.sun.webui.jsf.model.SingleSelectOptionsList; **17** import java.util.Properties; **18** import javax.faces.FacesException; **19** import javax.servlet.http.Cookie; **20** import javax.servlet.http.HttpServletResponse; **21**

**Fig. 26.19** | Page bean that stores the user’s language selection in a client cookie. (Part 1 of 3.)  

**1160** Chapter 26 JavaServer™ Faces Web Applications

**22** public class Options extends AbstractPageBean **23** { **24** private int \_\_placeholder; **25 26** private void \_init() throws Exception **27** { **28** languageRadioGroupDefaultOptions.setOptions( **29** new com.sun.webui.jsf.model.Option\[\] { **30** new com.sun.webui.jsf.model.Option( "Java", "Java" ), **31** new com.sun.webui.jsf.model.Option( "C++", "C++" ), **32** new com.sun.webui.jsf.model.Option( "Visual-Basic-2005", **33** "Visual Basic 2005" ), **34** new com.sun.webui.jsf.model.Option( "Visual-C#-2005", **35** "Visual C# 2005" ), **36** new com.sun.webui.jsf.model.Option( "Internet-&-Web", **37** "Internet & Web" ) **38** } // end array initializer **39** ); // end call to setOptions **40** } // end method \_init **41 42 43 44 200** private Properties books = new Properties(); **201 202** // Construct a new page bean instance and initialize the properties **203** // that map languages to ISBN numbers of recommended books. **204** public Options() **205** { **206** // initialize the Properties object of values to be stored as **207** // cookies. **208** books.setProperty( "Java", "0132222205" ); **209** books.setProperty( "C++", "0136152503" ); **210** books.setProperty( "Visual Basic 2005", "0131869000" ); **211** books.setProperty( "Visual C# 2005", "0131525239" ); **212** books.setProperty( "Internet & Web", "0131752421" ); **213** } // end Options constructor **214 215 216 217 258** // Action handler for the Submit button. Checks whether a language **259** // was selected and, if so, registers a cookie for that language and **260** // sets the responseText to indicate the chosen language. **261** public String submitButton\_action() **262** { **263** String msg = "Welcome to Cookies! You "; **264 265** // if the user made a selection **266** if ( languageRadioGroup.getSelected() != null ) **267** { **268** String language = languageRadioGroup.getSelected().toString(); **269** msg += "selected " + language.replace( '-', ' ' ) + ".";

**Fig. 26.19** | Page bean that stores the user’s language selection in a client cookie. (Part 2 of 3.)

// To save space, we omitted the code in lines 42-199. The complete // source code is provided with this chapter's examples.

// To save space, we omitted the code in lines 215-257. The complete // source code is provided with this chapter's examples.  

26.5 Session Tracking **1161**

As mentioned previously, the \_init method handles component initialization. Since this page contains a RadioButtonGroup object that requires initialization, method \_init

(lines 26–40) constructs an array of Option objects to be displayed by the buttons. Lines 208–212 in the constructor initialize a Properties object—a data structure

that stores String key/value pairs. The application uses the key to store and retrieve the associated value in the Properties object. In this example, the keys are Strings con- taining the programming language names, and the values are Strings containing the ISBN numbers for the recommended books. Class Properties provides method set-

Property, which takes as arguments a key and a value. A value that is added via method setProperty is placed in the Properties at a location determined by the key. The value for a specific Properties entry can be determined by invoking the method getProperty

on the Properties object with that value’s key as an argument.

**270 271** // get ISBN number of book for the given language **272** String ISBN = books.getProperty( language ); **273 274 275 276 277 278 279 280 281** } // end if **282** else **283** msg += "did not select a language."; **284 285** responseText.setValue( msg ); **286** languageRadioGroup.setRendered( false ); **287** instructionText.setRendered( false ); **288** submitButton.setRendered( false ); **289** responseText.setRendered( true ); **290** languagesLink.setRendered( true ); **291** recommendationsLink.setRendered( true ); **292** return null; // reloads the page **293** } // end method submitButton\_action **294 295** // redisplay the components for selecting a language **296** public String languagesLink\_action() **297** { **298** responseText.setRendered( false ); **299** languagesLink.setRendered( false ); **300** recommendationsLink.setRendered( false ); **301** languageRadioGroup.setRendered( true ); **302** instructionText.setRendered( true ); **303** submitButton.setRendered( true ); **304** return null; **305** } // end method languagesLink\_action **306** } // end class Options

**Fig. 26.19** | Page bean that stores the user’s language selection in a client cookie. (Part 3 of 3.)

// create cookie using language-ISBN name-value pair Cookie cookie = new Cookie( language, ISBN );

// add cookie to response header to place it on user's machine HttpServletResponse response =

( HttpServletResponse ) getExternalContext().getResponse(); response.addCookie( cookie );  

**1162** Chapter 26 JavaServer™ Faces Web Applications

**Software Engineering Observation 26.1** _Netbeans can automatically import any missing packages your Java file needs. For example, after adding the Properties object to Options.java, you can right click in the Java editor window and select **Fix Imports** to automatically import java.util.Properties._ 26.1

Clicking **Submit** invokes the event handler submitButton\_action (lines 261–293), which displays a message indicating the selected language in the responseText element and adds a new cookie to the response. If a language was selected (line 266), the selected item is retrieved (line 268). Line 269 adds the selected language to the results message.

Line 272 retrieves the ISBN for the selected language from the books Properties

objectc. Then line 275 creates a new Cookie object (in package javax.servlet.http), using the selected language as the cookie’s name and a corresponding ISBN as the cookie’s value. This cookie is added to the HTTP response header in lines 278–280. An object of class HttpServletResponse (from package javax.servlet.http) represents the response. This object can be accessed by invoking the method getExternalContext on the page bean, then invoking getResponse on the resulting object. If a language was not selected, line 283 sets the results message to indicate that no selection was made.

Lines 285–291 control the appearance of the page after the user clicks **Submit**. Line 285 sets the responseText to display the String msg. Since the user has just submitted a language selection, the components used to collect the selection are hidden (lines 286– 288) and responseText and the links used to navigate the application are displayed (lines 289–291). The action handler returns null at line 292, which reloads Options.jsp.

Lines 296–305 contain the languagesLink’s event handler. When the user clicks this link, responseText and the two links are hidden (lines 298–300), and the components that allow the user to select a language are redisplayed (lines 301–303). The method returns null at line 304, causing Options.jsp to reload.

**_Displaying Book Recommendations Based on Cookie Values_** After clicking **Submit**, the user may request a book recommendation. The book recom- mendations hyperlink forwards the user to Recommendations.jsp (Fig. 26.20) to display recommendations based on the user’s language selections.

**1** <?xml version = "1.0" encoding = "UTF-8"?> **2 3** <!-- Fig. 26.20: Recommendations.jsp --> **4** <!-- Displays book recommendations using cookies --> **5** <jsp:root version = "1.2" **6** xmlns:f = "http://java.sun.com/jsf/core" **7** xmlns:h = "http://java.sun.com/jsf/html" **8** xmlns:jsp = "http://java.sun.com/JSP/Page" **9** xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType = "text/html;charset=UTF-8" **11** pageEncoding = "UTF-8"/> **12** <f:view> **13** <webuijsf:page binding = "#{Recommendations.page1}" id = "page1"> **14** <webuijsf:html binding = "#{Recommendations.html1}" id = "html1"> **15** <webuijsf:head binding = "#{Recommendations.head1}" id = "head1">

**Fig. 26.20** | JSP file that displays book recommendations based on cookies. (Part 1 of 2.)  

26.5 Session Tracking **1163**

Recommendations.jsp contains a **Label** (lines 23–27), a **Listbox** (lines 28–33) and a **Hyperlink** (lines 34–38). The **Label** displays the text Recommendations at the top of the page. A **Listbox** component displays a list of options from which a user can make multiple selections. The **Listbox** in this example displays the recommendations created by the Rec- ommendations.java page bean (Fig. 26.21), or the text "No Recommendations. Please

**16** <webuijsf:link binding = "#{Recommendations.link1}" **17** id = "link1" url = "/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding = "#{Recommendations.body1}" **20** id = "body1" style = "-rave-layout: grid"> **21** <webuijsf:form binding = "#{Recommendations.form1}" **22** id = "form1"> **23** <webuijsf:label binding = **24** "#{Recommendations.recommendationsLabel}" for = **25** "recommendationsListbox" id = "recommendationsLabel" **26** style = "font-size: 18px; left: 24px; top: 24px; **27** position: absolute" text = "Recommendations"/> **28** <webuijsf:listbox binding = **29** "#{Recommendations.recommendationsListbox}" id = **30** "recommendationsListbox" items = "#{Recommendations. **31** recommendationsListboxDefaultOptions.options}" **32** style = "height: 96px; left: 24px; top: 48px; **33** position: absolute; width: 360px"/> **34** <webuijsf:hyperlink actionExpression = **35** "#{Recommendations.optionsLink\_action}" binding = **36** "#{Recommendations.optionsLink}" id = "optionsLink" **37** style = "left: 24px; top: 168px; position: absolute" **38** text = "Click here to choose another language."/> **39** </webuijsf:form> **40** </webuijsf:body> **41** </webuijsf:html> **42** </webuijsf:page> **43** </f:view> **44** </jsp:root>

**Fig. 26.20** | JSP file that displays book recommendations based on cookies. (Part 2 of 2.)  

**1164** Chapter 26 JavaServer™ Faces Web Applications

select a language." The **Hyperlink** allows the user to return to Options.jsp to select additional languages. You can configure this hyperlink using the **Page Navigation** file as described earlier in this section.

**_Page Bean That Creates Book Recommendations from Cookies_** In Recommendations.java (Fig. 26.21), method prerender (lines 180–210) retrieves the cookies from the client, using the request object’s getCookies method (lines 183–185). An object of class HttpServletRequest (from package javax.servlet.http) represents the request. This object can be obtained by invoking method getExternalContext on the page bean, then invoking getRequest on the resulting object. The call to getCookies re- turns an array of the cookies previously written to the client. Cookies can be read by an application only if they were created by a server in the domain in which the application is running—a web server cannot access cookies created by servers in other domains. For ex- ample, a cookie created by a web server in the deitel.com domain cannot be read by a web server in any other domain.

**1** // Fig. 26.21: Recommendations.java **2** // Displays book recommendations based on cookies storing user's selected **3** // programming languages. **4** package sessiontrackingcookies; **5 6** import com.sun.rave.web.ui.appbase.AbstractPageBean; **7** import com.sun.webui.jsf.component.Body; **8** import com.sun.webui.jsf.component.Form; **9** import com.sun.webui.jsf.component.Head;

**10** import com.sun.webui.jsf.component.Html; **11** import com.sun.webui.jsf.component.Hyperlink; **12** import com.sun.webui.jsf.component.Label; **13** import com.sun.webui.jsf.component.Link; **14** import com.sun.webui.jsf.component.Listbox; **15** import com.sun.webui.jsf.component.Page; **16** import com.sun.webui.jsf.component.StaticText; **17** import com.sun.webui.jsf.model.DefaultOptionsList; **18** import com.sun.webui.jsf.model.Option; **19** import javax.faces.FacesException; **20** import javax.servlet.http.Cookie; **21** import javax.servlet.http.HttpServletRequest; **22 23** public class Recommendations extends AbstractPageBean **24** { **25** private int \_\_placeholder; **26 27** private void \_init() throws Exception **28** { **29** recommendationsListboxDefaultOptions.setOptions( **30** new com.sun.webui.jsf.model.Option\[\] {} ); **31** } **32**

**Fig. 26.21** | Page bean that displays book recommendations based on cookies storing user’s selected languages. (Part 1 of 2.)  

26.5 Session Tracking **1165**

Line 191 determines whether at least one cookie exists. Lines 195–200 add the infor- mation in the cookie(s) to an Option array. Arrays of Option objects can be displayed as a list of items in a **Listbox** component. The loop retrieves the name and value of each cookie,

**33 34 35 179** // displays the book recommendations in the Listbox **180** public void prerender() **181** { **182 183 184 185 186 187** // if there are cookies, store the corresponding books and ISBN **188** // numbers in an array of Options **189** Option \[\] recommendations; **190 191** if ( cookies.length > 1 ) **192** { **193** recommendations = new Option\[ cookies.length - 1 \]; **194 195** for ( int i = 0; i < cookies.length - 1; i++ ) **196** { **197** String language = .replace( '-', ' ' ); **198** recommendations\[ i \] = new Option( language + **199** " How to Program. ISBN#: " + ); **200** } // end for **201** } // end if **202** else **203** { **204** recommendations = new Option\[ 1 \]; **205** recommendations\[ 0 \] = new Option( **206** "No recommendations. Please select a language." ) ; **207** } // end else **208 209** recommendationsListbox.setItems( recommendations ); **210** } // end method prerender **211 212 213 214 231** // redirects user to Options.jsp **232** public String optionsLink\_action() **233** { **234** return "case1"; // returns to Options.jsp **235** } // end method optionsLink\_action **236** } // end class Recommendations

**Fig. 26.21** | Page bean that displays book recommendations based on cookies storing user’s selected languages. (Part 2 of 2.)

// To save space, we omitted the code in lines 33-178. The complete // source code is provided with this chapter's examples.

// retrieve client's cookies HttpServletRequest request =

( HttpServletRequest ) getExternalContext().getRequest(); Cookie \[\] cookies = request.getCookies();

cookies\[ i \].getName()

cookies\[ i \].getValue()

// To save space, we omitted the code in lines 212-230. The complete // source code is provided with this chapter's examples.  

**1166** Chapter 26 JavaServer™ Faces Web Applications

using the control variable to determine the current value in the cookie array. If no language was selected, lines 204–206 add to an Options array a message instructing the user to select a language. Line 209 sets recommendationsListBox to display the resulting Options array. We summarize commonly used Cookie methods in Fig. 26.22.

**26.5.2 Session Tracking with the SessionBean Object** You can also perform session tracking with the SessionBean class that is provided in each web application created with Netbeans. When a web page in the project is requested, a SessionBean object is created. Properties of this object can be accessed throughout a browser session by invoking the method getSessionBean on the page bean. To demon- strate session-tracking techniques using the SessionBean, we modified the page bean files in Figs. 26.19 and 26.21 so that they use the SessionBean to store the user’s selected languages. We begin with the updated Options.jsp file (Fig. 26.23). Figure 26.26 pre- sents the SessionBean.java file, and Fig. 26.27 presents the modified page bean file for Options.jsp.

The Options.jsp file in Fig. 26.23 is similar to that presented in Fig. 26.17 for the cookies example. Lines 40–48 define two webuijsf:staticText elements that were not present in the cookies example. The first element displays the text "Number of selections so far:". The second element’s text attribute is bound to property numSelections in the SessionBean (line 48). We discuss how to bind the text attribute to a SessionBean prop- erty momentarily.

Method Description

getDomain Returns a String containing the cookie’s domain (i.e., the domain from which the cookie was written). This determines which web servers can receive the cookie. By default, cookies are sent to the web server that originally sent the cookie to the client. Changing the Domain property causes the cookie to be returned to a web server other than the one that originally wrote it.

getMaxAge Returns an int indicating how many seconds the cookie will persist on the browser. This is –1 by default, meaning the cookie will persist until the browser is shut down.

getName Returns a String containing the cookie’s name.

getPath Returns a String containing the path to a directory on the server to which the cookie applies. Cookies can be “targeted” to specific directories on the web server. By default, a cookie is returned only to applications operating in the same directory as the application that sent the cookie or a subdirectory of that directory. Changing the Path property causes the cookie to be returned to a directory other than the one from which it was originally written.

getSecure Returns a bool value indicating whether the cookie should be transmitted through a secure protocol. The value true causes a secure protocol to be used.

getValue Returns a String containing the cookie’s value.

**Fig. 26.22** | javax.servlet.http.Cookie methods.  

26.5 Session Tracking **1167**

**1** <?xml version = "1.0" encoding = "UTF-8"?> **2 3** <!-- Fig. 26.23: Options.jsp --> **4** <!-- JSP file that allows the user to select a programming language --> **5** <jsp:root version = "1.2" **6** xmlns:f = "http://java.sun.com/jsf/core" **7** xmlns:h = "http://java.sun.com/jsf/html" **8** xmlns:jsp = "http://java.sun.com/JSP/Page" **9** xmlns:webuijsf = "http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType = "text/html;charset=UTF-8" **11** pageEncoding = "UTF-8"/> **12** <f:view> **13** <webuijsf:page binding = "#{Options.page1}" id = "page1"> **14** <webuijsf:html binding = "#{Options.html1}" id = "html1"> **15** <webuijsf:head binding = "#{Options.head1}" id = "head1"> **16** <webuijsf:link binding = "#{Options.link1}" id = "link1" **17** url = "/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding = "#{Options.body1}" id = "body1" **20** style = "-rave-layout: grid"> **21** <webuijsf:form binding = "#{Options.form1}" id = "form1"> **22** <webuijsf:staticText binding = "#{Options.instructionText}" **23** id = "instructionText" style = "font-size: 18px; **24** left: 24px; top: 24px; position: absolute" **25** text = "Select a programming language:"/> **26** <webuijsf:radioButtonGroup binding = **27** "#{Options.languageRadioGroup}" id = **28** "languageRadioGroup" items = **29** "#{Options.languageRadioGroupDefaultOptions.options}" **30** style = "left: 24px; top: 48px; position: absolute"/> **31** <webuijsf:button actionExpression = **32** "#{Options.submitButton\_action}" binding = **33** "#{Options.submitButton}" id = "submitButton" style = **34** "left: 23px; top: 192px; position: absolute; **35** width: 100px" text = "Submit"/> **36** <webuijsf:staticText binding = "#{Options.responseText}" **37** id = "responseText" rendered = "false" style = **38** "font-size: 18px; left: 24px; top: 24px; **39** position: absolute"/> **40** <webuijsf:staticText binding = "#{Options.selectionsText}" **41** id = "selectionsText" rendered = "false" style = **42** "position: absolute; left: 24px; top: 72px" text = **43** "Number of selections so far:"/> **44** <webuijsf:staticText binding = **45** "#{Options.selectionsValueText}" id = **46** "selectionsValueText" rendered = "false" style = **47** "left: 168px; top: 72px; position: absolute" **48** /> **49** <webuijsf:hyperlink actionExpression = **50** "#{Options.languagesLink\_action}" binding = **51** "#{Options.languagesLink}" id = "languagesLink" **52** rendered = "false" style = "left: 24px; top: 120px;

**Fig. 26.23** | JSP file that allows the user to select a programming language. (Part 1 of 3.)

text = "#{SessionBean1.numSelections}"  

**1168** Chapter 26 JavaServer™ Faces Web Applications

**53** position: absolute" **54** text = "Click here to choose another language."/> **55** <webuijsf:hyperlink actionExpression = **56** "#{Options.recommendationsLink\_action}" binding = **57** "#{Options.recommendationsLink}" id = **58** "recommendationsLink" rendered = "false" style = **59** "left: 24px; top: 144px; position: absolute" **60** text = "Click here to get book recommendations." **61** url = "/faces/Recommendations.jsp"/> **62** </webuijsf:form> **63** </webuijsf:body> **64** </webuijsf:html> **65** </webuijsf:page> **66** </f:view> **67** </jsp:root>

**Fig. 26.23** | JSP file that allows the user to select a programming language. (Part 2 of 3.)

(a)

(b)  

26.5 Session Tracking **1169**

**_Adding Properties to the SessionBean_** In this example, we use session tracking to store not only the user’s selected languages, but also the number of selections made. To store this information in the SessionBean, we add properties to the SessionBean class.

To add a property that will store the number of selections so far, right click the SessionBean1 node in the **Outline** window and select **Add > Property** to display the **New Property Pattern** dialog (Fig. 26.24). This dialog allows you to add primitive, String or primitive type-wrapper (e.g., Integer, Double) properties to the SessionBean. Add an int

property named numSelections and click **OK** to accept the default settings for this prop- erty. Open the SessionBean file, and at the bottom of the source code you’ll see a new property definition, a _get_ method and _set_ method for numSelections.

Property numSelections is manipulated in the page bean file to store the number of languages the user selected. To display the value of this property in the selectionsValue- Text element in the JSP file, right click the element in the **Outline** window and select **Bind to Data…**. In the **Bind to Data** dialog (Fig. 26.25), select the **Bind to an Object** tab, locate property numSelections under the SessionBean1 node and click **OK**. The **Static Text** ele- ment will now always display the value of SessionBean1’s numSelections property. If the

**Fig. 26.23** | JSP file that allows the user to select a programming language. (Part 3 of 3.)

(c)

(d)  

**1170** Chapter 26 JavaServer™ Faces Web Applications

property’s value changes, the text changes as well, so that you need not programmatically set the text in the page bean file.

Now that we’ve added a property to store the number of selections in the SessionBean1, we must add a second property to store the selections themselves. We’d like to store selections as key/value pairs of the selected language and the ISBN number of a related book, similar to the way selections were stored using cookies. To do this, we add a Properties object named selectedLanguages to the SessionBean. We manually added this property to the SessionBean file, but you can add it using the **New Property** dialog in Fig. 26.24. Simply type java.util.Properties in the **Type** drop-down list’s field, con- figure the property and click **OK**. The modified SessionBean file (after the two properties have been added) is displayed in Fig. 26.26.

**Fig. 26.24** | **New Property** dialog for adding a property to the SessionBean.

**Fig. 26.25** | **Bind to Data** dialog.  

26.5 Session Tracking **1171**

Line 54 declares the numSelections property, and lines 57–60 and 63–66 declare its _get_ and _set_ methods, respectively. This portion of the code was generated automatically when we used the **New Property** dialog. Lines 69–70 define the Properties object selectedLanguages that will store user selections. Lines 73–76 and 79–83 are the _get_ and _set_ methods for this property.

**1** // Fig. 26.26: SessionBean.java **2** // SessionBean file for storing language selections. **3** package sessiontrackingsessions; **4 5** import com.sun.rave.web.ui.appbase.AbstractSessionBean; **6** import javax.faces.FacesException; **7 8** public class SessionBean1 extends AbstractSessionBean **9** {

**10 11 12 53** // holds value of property numSelections **54 55 56** // returns value of numSelections **57** public int getNumSelections() **58** { **59** return this.numSelections; **60** } // end method getNumSelections **61 62** // sets new value of numSelections **63** public void setNumSelections(int numSelections) **64** { **65** this.numSelections = numSelections; **66** } // end method setNumSelections **67 68** // holds value of property selectedLanguages **69 70 71 72** // returns selectedLanguages **73** public java.util.Properties getSelectedLanguages() **74** { **75** return this.selectedLanguages; **76** } // end method getSelectedLanguages **77 78** // sets new value of property selectedLanguages **79** public void setSelectedLanguages( **80** java.util.Properties selectedLanguages ) **81** { **82** this.selectedLanguages = selectedLanguages; **83** } // end method setSelectedLanguages **84** } // end class SessionBean1

**Fig. 26.26** | SessionBean file for storing language selections.

// To save space, we omitted the code in lines 10-52. The complete // source code is provided with this chapter's examples.

private int numSelections;

private java.util.Properties selectedLanguages = new java.util.Properties();  

**1172** Chapter 26 JavaServer™ Faces Web Applications

**_Manipulating SessionBean Properties in a Page Bean File_** The page bean file for the Options.jsp page is displayed in Fig. 26.27. Because much of this example is identical to the preceding one, we concentrate on the new features.

**1** // Fig. 26.27: Options.java **2** // Page bean that stores language selections in a SessionBean property. **3** package sessiontrackingsessions; **4 5** import com.sun.rave.web.ui.appbase.AbstractPageBean; **6** import com.sun.webui.jsf.component.Body; **7** import com.sun.webui.jsf.component.Button; **8** import com.sun.webui.jsf.component.Form; **9** import com.sun.webui.jsf.component.Head;

**10** import com.sun.webui.jsf.component.Html; **11** import com.sun.webui.jsf.component.Hyperlink; **12** import com.sun.webui.jsf.component.Link; **13** import com.sun.webui.jsf.component.Page; **14** import com.sun.webui.jsf.component.RadioButtonGroup; **15** import com.sun.webui.jsf.component.StaticText; **16** import com.sun.webui.jsf.model.SingleSelectOptionsList; **17** import java.util.Properties; **18** import javax.faces.FacesException; **19** import javax.servlet.http.Cookie; **20** import javax.servlet.http.HttpServletResponse; **21 22** public class Options extends AbstractPageBean **23** { **24** private int \_\_placeholder; **25 26** private void \_init() throws Exception **27** { **28** languageRadioGroupDefaultOptions.setOptions( **29** new com.sun.webui.jsf.model.Option\[\] { **30** new com.sun.webui.jsf.model.Option( "Java", "Java" ), **31** new com.sun.webui.jsf.model.Option( "C++", "C++" ), **32** new com.sun.webui.jsf.model.Option( "Visual Basic 2005", **33** "Visual Basic 2005" ), **34** new com.sun.webui.jsf.model.Option( "Visual C# 2005", **35** "Visual C# 2005" ), **36** new com.sun.webui.jsf.model.Option( "Internet & Web", **37** "Internet & Web") **38** } // end array initializer **39** ); // end call to setOptions **40** } // end method \_init **41 42 43 44 226** // Construct a new page bean instance and initialize the properties **227** // that map languages to ISBN numbers of recommended books. **228** public Options() **229** {

**Fig. 26.27** | Page bean that stores language selections in a SessionBean property. (Part 1 of 3.)

// To save space, we omitted the code in lines 42-225. The complete // source code is provided with this chapter's examples.  

26.5 Session Tracking **1173**

**230** // initialize the Properties object of values to be stored **231** // in the session **232** books.setProperty( "Java", "0132222205" ); **233** books.setProperty( "C++", "0136152503" ); **234** books.setProperty( "Visual Basic 2005", "0131869000" ); **235** books.setProperty( "Visual C# 2005", "0131525239" ); **236** books.setProperty( "Internet & Web", "0131752421" ); **237** } // end Options constructor **238 239 240 241 282** // Action handler for the Submit button. Checks whether a language **283** // was selected and, if so, registers a cookie for that language and **284** // sets the responseText to indicate the chosen language. **285** public String submitButton\_action() **286** { **287** String msg = "Welcome to sessions! You "; **288 289** // if the user made a selection **290** if ( getLanguageRadioGroup().getSelected() != null ) **291** { **292** String language = languageRadioGroup.getSelected().toString(); **293** msg += "selected " + language + "."; **294 295** // get ISBN number of book for the given language. **296** String ISBN = books.getProperty( language ); **297 298 299 300 301 302** // increment numSelections in the SessionBean and update **303** // selectedLanguages if user has not made this selection before **304** if ( result == null ) **305** { **306 307 308** } // end if **309** } // end if **310** else **311** msg += "did not select a language."; **312 313** responseText.setValue( msg ); **314** languageRadioGroup.setRendered( false ); **315** instructionText.setRendered( false ); **316** submitButton.setRendered( false ); **317** responseText.setRendered( true ); **318** selectionsText.setRendered( true ); **319** selectionsValueText.setRendered( true ); **320** languagesLink.setRendered( true ); **321** recommendationsLink.setRendered( true );

**Fig. 26.27** | Page bean that stores language selections in a SessionBean property. (Part 2 of 3.)

// To save space, we omitted the code in lines 239-281. The complete // source code is provided with this chapter's examples.

// add the selection to the SessionBean's Properties object Properties selections = getSessionBean1().getSelectedLanguages(); Object result = selections.setProperty( language, ISBN );

int numSelected = getSessionBean1().getNumSelections(); getSessionBean1().setNumSelections( ++numSelected );  

**1174** Chapter 26 JavaServer™ Faces Web Applications

The submitButton’s action handler (lines 285–323) stores the user’s selections in the SessionBean and increments the number of selections made, if necessary. Line 299 retrieves from the SessionBean the Properties object that contains the user’s selections. Line 300 adds the current selection to the Properties object. Method setProperty

returns the value previously associated with the new key, or null if this key was not already stored in the Properties object. If adding the new property returns null, then the user has made a new selection. In this case, lines 306–307 increment the numSelections prop- erty in the SessionBean. Lines 313–321 and the languaguesLink action handler (lines 326–337) control the components that are displayed, just as in the cookies examples.

**Software Engineering Observation 26.2** _A benefit of using SessionBean properties (rather than cookies) is that they can store any type of object (not just Strings) as attribute values. This provides you with increased flexibility in maintaining client-state information._ 26.2

**_Displaying Recommendations Based on Session Values_** As in the cookies example, this application provides a link to Recommendations.jsp, which displays a list of book recommendations based on the user’s language selections. Since this JSP is identical to the version in Fig. 26.20, we show only the sample output of this page in Fig. 26.28.

**_Page Bean That Creates Book Recommendations from a SessionBean Property_** Figure 26.29 presents the page bean for Recommendations.jsp. Again, much of it is sim- ilar to the page bean used in the cookies example. We discuss only the new features.

**322** return null; // reloads the page **323** } // end method submitButton\_action **324 325** // redisplay the components for selecting a language **326** public String languagesLink\_action() **327** { **328** responseText.setRendered( false ); **329** selectionsText.setRendered( false ); **330** selectionsValueText.setRendered( false ); **331** languagesLink.setRendered( false ); **332** recommendationsLink.setRendered( false ); **333** languageRadioGroup.setRendered( true ); **334** instructionText.setRendered( true ); **335** submitButton.setRendered( true ); **336** return null; **337** } // end method languagesLink\_action **338 339** // forwards user to Recommendations.jsp **340** public String recommendationsLink\_action() **341** { **342** return "case1"; **343** } // end method recommendationsLink\_action **344** } // end class Options

**Fig. 26.27** | Page bean that stores language selections in a SessionBean property. (Part 3 of 3.)  

26.5 Session Tracking **1175**

**Fig. 26.28** | JSP file that displays book recommendations based on language selections stored in session scope.

**1** // Fig. 26.29: Recommendations.java **2** // Page bean that displays book recommendations based on a SessionBean **3** // property. **4** package sessiontrackingsessions; **5 6** import com.sun.rave.web.ui.appbase.AbstractPageBean; **7** import com.sun.webui.jsf.component.Body; **8** import com.sun.webui.jsf.component.Form; **9** import com.sun.webui.jsf.component.Head;

**10** import com.sun.webui.jsf.component.Html; **11** import com.sun.webui.jsf.component.Hyperlink; **12** import com.sun.webui.jsf.component.Label; **13** import com.sun.webui.jsf.component.Link; **14** import com.sun.webui.jsf.component.Listbox; **15** import com.sun.webui.jsf.component.Page; **16** import com.sun.webui.jsf.model.DefaultOptionsList; **17** import com.sun.webui.jsf.model.Option; **18** import java.util.Enumeration; **19** import java.util.Properties; **20** import javax.faces.FacesException; **21 22** public class Recommendations extends AbstractPageBean **23** { **24 25 26 178** // displays the book recommendations in the Listbox **179** public void prerender() **180** { **181 182 183**

**Fig. 26.29** | Displays book recommendations based on a SessionBean property. (Part 1 of 2.)

// To save space, we omitted the code in lines 24-177. The complete // source code is provided with this chapter's examples.

// retrieve user's selections and number of selections made Properties languages = getSessionBean1().getSelectedLanguages(); Enumeration selectionsEnum = languages.propertyNames();  

**1176** Chapter 26 JavaServer™ Faces Web Applications

Line 182 retrieves the Properties object containing the user’s selections from the SessionBean, and line 183 gets an enumeration of all of the keys in that Properties

object. Line 184 retrieves the number of selections made from the SessionBean. If any selections were made, line 191 constructs an appropriately sized Option array to display the selections in the webuijsf:listBox element of Recommendations.jsp. Lines 193–199 add each of the user’s selections to this Option array. Line 195 gets the next key from the enumeration of keys, and lines 196–198 add a recommendation to the Option array.

**26.6 Wrap-Up** In this chapter, we introduced web application development using JavaServer Pages and JavaServer Faces in Netbeans. We began by discussing the simple HTTP transactions that take place when you request and receive a web page through a web browser. We then dis-

**184 185 186** Option \[\] recommendations; **187 188** // if at least one selection was made **189** if ( numSelected > 0 ) **190** { **191** recommendations = new Option\[ numSelected \]; **192 193** for ( int i = 0; i < numSelected; i++ ) **194** { **195 196 197 198 199** } // end for **200** } // end if **201** else **202** { **203** recommendations = new Option\[ 1 \]; **204** recommendations\[ 0 \] = new Option( **205** "No recommendations. Please select a language." ); **206** } // end else **207 208** recommendationsListbox.setItems( recommendations ); **209** } // end method prerender **210 211 212 213 230** // redirects user to Options.jsp **231** public String optionsLink\_action() **232** { **233** return "case1"; // returns to Options.jsp **234** } // end method optionsLink\_action **235** } // end class Recommendations

**Fig. 26.29** | Displays book recommendations based on a SessionBean property. (Part 2 of 2.)

int numSelected = getSessionBean1().getNumSelections();

String language = (String) selectionsEnum.nextElement(); recommendations\[ i \] = new Option( language +

" How to Program. ISBN#: " + languages.getProperty( language ) );

// To save space, we omitted the code in lines 211-229. The complete // source code is provided with this chapter's examples.  

26.7 Web Resources **1177**

cussed the three tiers (i.e., the client or top tier, the business logic or middle tier and the information or bottom tier) that comprise most web applications.

You learned the role of JSP files and page bean files, and the relationship between them. You learned how to use Netbeans to visually build web applications using Net- beans’s drag-and-drop capabilities, then you compiled and executed them.

We demonstrated several common JSF components used for displaying text and images on web pages. We also discussed validation components and custom validator methods, which allow you to ensure that user input satisfies certain requirements.

We discussed the benefits of maintaining user information across multiple pages of a website. We then demonstrated how you can include such functionality in a web applica- tion using either cookies or properties in the SessionBean class. In the next chapter, we continue our discussion of web application development. You’ll learn how to access a data- base from a JSF web application, how to use several of the AJAX-enabled JSF components from Sun’s Java Blueprints and how to use virtual forms.

**26.7 Web Resources** Our Java Resource Centers focus on the enormous amount of free Java content available online. We currently provide six Java-related Resource Centers:

www.deitel.com/java/ www.deitel.com/JavaCertification/ www.deitel.com/JavaDesignPatterns/ www.deitel.com/JavaEE5/ www.deitel.com/JavaFX/ www.deitel.com/JavaSE6Mustang/

You can view our complete list of Resource Centers at

www.deitel.com/ResourceCenters.html

**Summary _Section 26.1 Introduction_** • Web-based applications create web content for web browser clients.

• AJAX helps web-based applications provide the interactivity and responsiveness that users typi- cally expect of desktop applications.

**_Section 26.2 Java Web Technologies_** • Java web technologies continually evolve to provide developers with higher levels of abstraction

and greater separation of the application’s tiers. This separation makes web applications more maintainable and extensible.

• Netbeans allows you to develop a web application’s GUI in a drag-and-drop design tool, while handling the business logic in separate Java classes.

**_Section 26.2.1 Servlets_** • Servlets use the HTTP request/response model of communication between client and server.

• Servlets extend a server’s functionality by allowing the server to generate dynamic content. A servlet container executes and interacts with servlets.  

**1178** Chapter 26 JavaServer™ Faces Web Applications

• Packages javax.servlet and javax.servlet.http contain the servlet classes and interfaces.

• The servlet container receives HTTP requests from a client and directs each request to the ap- propriate servlet. The servlet processes the request and returns an appropriate response to the cli- ent—usually in the form of an XHTML or XML document.

• All servlets implement the Servlet interface of package javax.servlet, which ensures that each servlet can execute in the framework provided by the servlet container. Interface Servlet declares methods used by the servlet container to manage the servlet’s life cycle.

• A servlet’s life cycle begins when the servlet container loads it into memory. The container in- vokes the servlet’s init method, which is called only once during a servlet’s life cycle to initialize the servlet. After init completes execution, the servlet is ready to respond to requests. Requests are handled by a servlet’s service method, which receives the request, processes it and sends a response. Method service is called once per request. When the servlet container terminates the servlet, the servlet’s destroy method is called to release any resources held by the servlet.

**_Section 26.2.2 JavaServer Pages_** • JavaServer Pages (JSP) are an extension of servlet technology. Each JSP is translated by the JSP

container into a servlet.

• Unlike servlets, JSPs help you separate presentation from content.

• JavaServer Pages enable web application programmers to create dynamic content by reusing pre- defined components and by interacting with components using server-side scripting.

• JSP programmers can use special software components called JavaBeans and custom tag libraries that encapsulate complex, dynamic functionality.

• Custom tag libraries allow Java developers to hide code for database access and other complex operations in custom tags. To use such capabilities, you simply add the custom tags to the page. This simplicity enables web-page designers who are not familiar with Java to enhance web pages with powerful dynamic content and processing capabilities.

• The JSP classes and interfaces are located in packages javax.servlet.jsp and javax.serv-

let.jsp.tagext.

• There are four key components to JSPs—directives, actions, scripting elements and tag libraries.

• Directives are messages to the JSP container that enable you to specify page settings, to include content from other resources and to specify custom tag libraries for use in JSPs.

• Actions encapsulate functionality in predefined tags that programmers can embed in JSPs. Ac- tions often are performed based on the information sent to the server as part of a particular client request. They also can create Java objects for use in JSPs.

• Scripting elements enable you to insert Java code that interacts with components in a JSP.

• Tag libraries enable programmers to create custom tags and web-page designers to manipulate JSP content without prior Java knowledge.

• The JavaServer Pages Standard Tag Library (JSTL) provides the functionality for many common web application tasks.

• JSPs can contain static content such as XHTML or XML markup, which is known as fixed-tem- plate data or fixed-template text. Any literal text or XHTML markup in a JSP is translated to a String literal in the servlet representation of the JSP.

• When a JSP-enabled server receives the first request for a JSP, the JSP container translates the JSP into a servlet that handles the current request and future requests to the JSP.

• JSPs rely on the same request/response mechanism as servlets to process requests from and send responses to clients.  

Summary **1179**

**_Section 26.2.3 JavaServer Faces_** • JavaServer Faces (JSF) is a web application framework that simplifies the design of an applica-

tion’s user interface and further separates a web application’s presentation from its business logic.

• A framework simplifies application development by providing libraries and sometimes software tools to help you organize and build your applications.

• JSF provides custom tag libraries containing user interface components that simplify web-page design. JSF also includes a set of APIs for handling component events.

• You design the look-and-feel of a page with JSF by adding custom tags to a JSP file and manip- ulating their attributes. You define the page’s behavior in a separate Java source-code file.

**_Section 26.2.4 Web Technologies in Netbeans_** • Netbeans web applications consist of one or more JSPs built in the JavaServer Faces framework.

Each has the filename extension .jsp and contains the web page’s GUI elements.

• Netbeans allows you to design pages visually by dragging and dropping JSF components onto a page; you can also customize a web page by editing its .jsp file manually.

• Every JSP file created in Netbeans represents a web page and has a corresponding JavaBean class called the page bean.

• A JavaBean class must have a default (or no-argument) constructor, and _get_ and _set_ methods for all of its properties.

• The page bean defines properties for each of the page’s elements, and contains event handlers, page life-cycle methods and other supporting code for the web application.

• Every web application built with Netbeans has a page bean, a RequestBean, a SessionBean and an ApplicationBean.

• The RequestBean object is maintained in request scope—this object exists only for the duration of an HTTP request.

• A SessionBean object has session scope—the object exists throughout a user’s browsing session or until the session times out. There is a unique SessionBean object for each user.

• The ApplicationBean object has application scope—this object is shared by all instances of an application and exists as long as the application remains deployed on a web server. This object is used for applicationwide data storage or processing; only one instance exists for the application, regardless of the number of open sessions.

**_Section 26.3.1 Examining a JSP File_** • Netbeans generates a JSP file in response to your interactions with the Visual Editor.

• All JSPs have a jsp:root element with a version attribute to indicate the version of JSP being used and one or more xmlns attributes. Each xmlns attribute specifies a prefix and a URL for a tag library, allowing the page to use tags specified in that library.

• All JSPs generated by Netbeans include the tag libraries for the JSF core components library, the JSF HTML components library, the JSP standard components library and the JSP user interface components library.

• The jsp:directive.page element’s contentType attribute specifies the MIME type and the character set the page uses. The pageEncoding attribute specifies the character encoding used by the page source. These attributes help the client determine how to render the content.

• All pages containing JSF components are represented in a component tree with the root JSF el- ement f:view (of type UIViewRoot). All JSF component elements are placed in this element.  

**1180** Chapter 26 JavaServer™ Faces Web Applications

• Many ui page elements have a binding attribute to bind their values to properties in the web ap- plication’s JavaBeans. JSF Expression Language is used to perform these bindings.

• The webuijsf:head element has a title attribute that specifies the page’s title.

• A webuijsf:link element can be used to specify the CSS style sheet used by a page.

• A webuijsf:body element defines the body of the page.

• A webuijsf:form element defines a form in a page.

• A webuijsf:staticText component displays text that does not change.

• JSP elements are mapped to XHTML elements for rendering in a browser. The same JSP element can map to different XHTML elements, depending on the client browser and the component’s property settings.

• A webuijsf:staticText component typically maps to an XHTML span element. A span ele- ment contains text that is displayed on a web page and is used to control the formatting of the text. The style attribute of a webuijsf:staticText element will be represented as part of the corresponding span element’s style attribute when the browser renders the page.

**_Section 26.3.2 Examining a Page Bean File_** • Page bean classes inherit from class AbstractPageBean (package com.sun.rave.web.ui.app-

base), which provides page life-cycle methods.

• Package com.sun.webui.jsf.component includes classes for many basic JSF components.

• A webuijsf:staticText component is a StaticText object (package com.sun.webui.jsf.com-

ponent).

**_Section 26.3.3 Event-Processing Life Cycle_** • Netbeans’s application model places several methods (init, preprocess, prerender and de-

stroy) in the page bean that tie into the JSF event-processing life cycle. These methods represent four major stages—initialization, preprocessing, prerendering and destruction.

• The init method is called by the JSP container the first time the page is requested and on post- backs. A postback occurs when form data is submitted, and the page and its contents are sent to the server to be processed.

• Method init invokes its superclass version, then tries to call the method \_init, which handles component initialization tasks.

• The preprocess method is called after init, but only if the page is processing a postback. The prerender method is called just before a page is rendered by the browser. This method should be used to set component properties; properties that are set sooner (such as in method init) may be overwritten before the page is actually rendered by the browser.

• The destroy method is called after the page has been rendered, but only if the init method was called. This method handles tasks such as freeing resources used to render the page.

**_Section 26.3.4 Relationship Between the JSP and Page Bean Files_** • The page bean has a property for every element that appears in the JSP file.

**_Section 26.3.6 Building a Web Application in Netbeans_** • To create a new web application, select **File > New Project…** to display the **New Project** dialog. In

this dialog, select **Web** in the **Categories** pane, **Visual Web Application** in the **Projects** pane and click **Next**. Specify the project name and location. Click **Finish** to create the web application project.

• Netbeans creates a single web page named Page1 when you create a new project. This page is open by default in the Visual Editor in **Design** mode when the project first loads. As you drag  

Summary **1181**

and drop new components onto the page, **Design** mode allows you to see how your page will be rendered in the browser. The JSP file for this page, named Page1.jsp, can be viewed by clicking the **JSP** button at the top of the Visual Editor or by right clicking anywhere in the Visual Editor and selecting **Edit JSP Source**.

• To open the corresponding page bean file, click the **Java** button at the top of the Visual Editor or right click anywhere in the Visual Editor and select **Edit Java Source**.

• The **Preview in Browser** button at the top of the Visual Editor window allows you to view your pages in a browser without having to build and run the application.

• The **Refresh** button redraws the page in the Visual Editor.

• The **Target Browser Size** drop-down list allows you to specify the optimal browser resolution for viewing the page and allows you to see what the page will look like in different screen resolutions.

• The **Projects** window in the upper-left corner of the IDE displays the hierarchy of all the project’s files. The **Web Pages** node contains the JSP files and includes the **resources** folder, which con- tains the project’s CSS style sheet and any other files the pages may need to display properly (e.g., images). The Java source code, including the page bean file for each web page and the applica- tion, session and request scope beans, can be found under the **Source Packages** node.

• The **Page Navigation** file defines rules for navigating the project’s pages based on the outcome of user-initiated events, such as clicking a button or a link. This file can also be accessed by right clicking in the Visual Editor while in **Design** mode and selecting **Page Navigation**.

• Methods init, preprocess, prerender and destroy are overridden in each page bean. Other than method init, these methods are initially empty. They serve as placeholders for you to cus- tomize the behavior of your web application.

• Typically, you’ll want to rename the JSP and Java files in your project, so that their names are relevant to your application. To do so, right click the JSP file in the **Projects Window** and select **Rename** to display the **Rename** dialog. Enter the new filename. If **Preview All Changes** is checked, the **Refactoring Window** will appear at the bottom of the IDE when you click **Next >**. No changes will be made until you click **Do Refactoring** in the **Refactoring Window**. If you do not preview the changes, refactoring occurs when you click **Next >** in the **Rename** dialog.

• Refactoring is the process of modifying source code to improve its readability and reusability without changing its behavior. Netbeans has built-in refactoring tools that automate some refac- toring tasks.

• To add a title, open the JSP file in **Design** mode. In the **Properties** window, enter the new title next to the **Title** property and press _Enter_.

• To add components to a page, drag and drop them from the **Palette** onto the page in **Design** mode. Each component is an object that has properties, methods and events. You can set these properties and events in the **Properties** window or programmatically in the page bean file. _Get_ and _set_ methods are added to the page bean file for each component you add to the page.

• Components are rendered by default using absolute positioning, so that they appear exactly where they are dropped on the page.

• Netbeans is a WYSIWYG (What You See Is What You Get) editor—whenever you make a change to a web page in **Design** mode, the IDE creates the markup (visible in **JSP** mode) neces- sary to achieve the desired visual effects seen in **Design** mode.

• After designing the user interface, you can modify the page bean to add your business logic.

• The **Outline** window displays the page bean and the request, session and application scope beans. Clicking an item in the page bean’s component tree selects the item in the Visual Editor.

• Select **Build > Build Main Project** then **Run > Run Main Project** to run the application.  

**1182** Chapter 26 JavaServer™ Faces Web Applications

• You can run a project that has already been built by pressing the **Run Main Project** icon ( ) in the toolbar at the top of the IDE.

• If changes are made to a project, the project must be rebuilt before the changes will be reflected when the application is viewed in a browser.

• Press _F5_ to build the application, then run it in debug mode. If you type _F6_, the program exe- cutes without debugging enabled.

**_Section 26.4.1 Text and Graphics Components_** • The **Grid Panel** component allows the designer to specify the number of columns the grid should

contain. Components may then be dropped anywhere inside the panel, and they will automati- cally be repositioned into evenly spaced columns in the order in which they are dropped. When the number of components exceeds the number of columns, the panel moves the additional com- ponents to a new row.

• An **Image** component (of class ImageComponent) inserts an image into a web page. Images to be displayed on a web page must be placed in the project’s resources folder. To add images to the project, drop an **Image** component onto the page and click the ellipsis button next to the **url** prop- erty in the **Properties** window. This opens a dialog in which you can select the image to display.

• **Text Field**s allow you to obtain text input from the user.

• Note that the order in which components are dragged to the page is important, because their JSP tags will be added to the JSP file in that order. Tabbing between components navigates the com- ponents in the order in which the JSP tags occur in the JSP file. If you would like the user to navigate the components in a certain order, you should drag them onto the page in that order. Alternatively, you can set each input field’s tabIndex property in the **Properties** window. A com- ponent with a tab index of 1 will be the first in the tab sequence.

• A **Drop Down List** displays a list from which the user can make a selection. This object can be con- figured by right clicking the drop-down list in **Design** mode and selecting **Configure Default Op- tions**, which opens the **Options Customizer** dialog box to add options to the list.

• A **Hyperlink** component of class Hyperlink adds a link to a web page. The url property of this component specifies the resource that is requested when a user clicks the hyperlink.

• A **Radio Button Group** component of class RadioButtonGroup provides a series of radio buttons from which the user can select only one. The options can be edited by right clicking the compo- nent and selecting **Configure Default Options**.

• A **Button** is a JSF component of class Button that triggers an action when clicked. A **Button** com- ponent typically maps to an input XHTML element with attribute type set to submit.

**_Section 26.4.2 Validation Using Validator Components and Custom Validators_** • Validation helps prevent processing errors due to incomplete or improperly formatted user input.

• A **Length Validator** determines whether a field contains an acceptable number of characters.

• **Double Range Validator**s and **Long Range Validator**s determine whether numeric input falls within acceptable ranges.

• Package javax.faces.validators contains the classes for these validators.

• **Label** components describe other components and can be associated with user input fields by set- ting their for property.

• **Message** components display error messages when validation fails.

• To associate a **Label** or **Message** component with another component, hold the _Ctrl_ and _Shift_ keys, then drag the label or message to the appropriate component.  

Summary **1183**

• Set the required property of a component to true to ensure that the user enters data for it.

• If you add a validator component or custom validator method to an input field, the field’s re- quired property must be set to true for validation to occur.

• In the Visual Editor the label for a required field is automatically marked by a red asterisk.

• If a user submits a form with an empty text field for which a value is required, the default error message for that field will be displayed in its associated webuijsf:message component.

• To edit a **Double Range Validator**’s or a **Long Range Validator**’s properties, click its node in the **Out- line** window in **Design** mode and set the maximum and minimum properties in the **Properties** win- dow.

• It is possible to limit the length of user input without using validation by setting a **Text Field**’s maxLength property.

• Matching user input against a regular expression is an effective way to ensure that the input is properly formatted.

• Netbeans does not provide components for validation using regular expressions, but you can add your own custom validator methods to the page bean file.

• To add a custom validator method to an input component, right click the component and select **Edit Event Handler > validate** to create the component’s validation method in the page bean file.

**_Section 26.5 Session Tracking_** • Personalization makes it possible for e-businesses to communicate effectively with their custom-

ers and also improves the user’s ability to locate desired products and services.

• A trade-off exists between personalized e-business service and protection of privacy. Some con- sumers embrace the idea of tailored content, but others fear the possible adverse consequences if the information they provide to e-businesses is released or collected by tracking technologies.

• To provide personalized services to consumers, e-businesses must be able to recognize clients when they request information from a site. Unfortunately, HTTP is a stateless protocol—it does not support persistent connections that would enable web servers to maintain state information regarding particular clients. So, web servers cannot determine whether a request comes from a particular client or whether a series of requests comes from one or several clients.

• To help the server distinguish among clients, each client must identify itself to the server. Track- ing individual clients, known as session tracking, can be achieved in a number of ways. One pop- ular technique uses cookies; another uses the SessionBean object.

• With "hidden" form elements, a web form can write session-tracking data into a form in the web page that it returns to the client in response to a prior request. When the user submits the form in the new web page, all the form data, including the "hidden" fields, is sent to the form handler on the web server. With URL rewriting, the web server embeds session-tracking information di- rectly in the URLs of hyperlinks that the user clicks to send subsequent requests.

**_Section 26.5.1 Cookies_** • A cookie is a piece of data typically stored in a text file on the user’s computer. A cookie maintains

information about the client during and between browser sessions.

• The first time a user visits the website, the user’s computer might receive a cookie; this cookie is then reactivated each time the user revisits that site. The aim is to create an anonymous record containing data that is used to personalize the user’s future visits to the site.

• Every HTTP-based interaction between a client and a server includes a header containing infor- mation either about the request (when the communication is from the client to the server) or about the response (when the communication is from the server to the client).  

**1184** Chapter 26 JavaServer™ Faces Web Applications

• When a page receives a request, the header includes information such as the request type and any cookies that have been sent previously from the server to be stored on the client machine. When the server formulates its response, the header information contains any cookies the server wants to store on the client computer and other information, such as the MIME type of the response.

• A cookie’s expiration date determines how long the cookie remains on the client’s computer. If you do not set a cookie’s expiration date, the web browser maintains the cookie for the browsing session’s duration. Otherwise, it maintains the cookie until the expiration date.

• Setting the action handler for a **Hyperlink** enables you to respond to a click without redirecting the user to another page.

• To add an action handler to a **Hyperlink** that should also direct the user to another page, you must add a rule to the **Page Navigation** file. To edit this file, right click in the Visual Designer and select **Page Navigation…**, then drag the appropriate **Hyperlink** to the destination page.

• A cookie object is an instance of class Cookie in package javax.servlet.http.

• An object of class HttpServletResponse (from package javax.servlet.http) represents the re- sponse. This object can be accessed by invoking the method getExternalContext on the page bean, then invoking getResponse on the resulting object.

• An object of class HttpServletRequest (from package javax.servlet.http) represents the re- quest. This object can be obtained by invoking method getExternalContext on the page bean, then invoking getRequest on the resulting object.

• HttpServletRequest method getCookies returns an array of the cookies previously written to the client.

• HttpServletResponse method AddCookie adds a cookie to the response to the client.

• A web server cannot access cookies created by servers in other domains.

**_Section 26.5.2 Session Tracking with the SessionBean Object_** • You can perform session tracking with the SessionBean class that is provided in each web appli-

cation created with Netbeans. When a new client requests a web page in the project, a Session- Bean object is created.

• The SessionBean can be accessed throughout a session by invoking the method getSessionBean

on the page bean. You can then use the SessionBean object to access stored session properties.

• To store information in the SessionBean, add properties to the SessionBean class. To add a property, right click the SessionBean node in the **Outline** window and select **Add > Property** to display the **New Property Pattern** dialog. Configure the property and click **OK** to create it.

**Terminology** absolute positioning AbstractPageBean

action attribute of XHTML element form action in a JSP ApplicationBean

**Button** JSF component com.sun.webui.jsf.component

component tree controller logic cookie custom tag library custom tag

**Design** mode destroy event-processing life-cycle method directive in a JSP **Double Range Validator** JSF component **Drop Down List** JSF component end tag escaped property event-processing life cycle expiration date of a cookie fixed-template data fixed-template text framework  

Self-Review Exercises **1185**

**Grid Panel** JSF component hidden input in an XHTML form **Hyperlink** JSF component **Image** JSF component init event-processing life-cycle method IP address JavaBeans Java BluePrints javax.servlet package javax.servlet.http package JSF (JavaServer Faces) JSF components JSF Expression Language JSP (JavaServer Pages) .jsp filename extension JSP container JSTL (JSP Standard Tag Library) **Label** JSF component **Length Validator** JSF component **Listbox** JSF component **Long Range Validator** JSF component **Message** JSF component method attribute of XHTML element form Netbeans **Outline** window page bean **Palette** personalization postback preprocess event-processing life-cycle method

prerender event-processing life-cycle method **Radio Button Group** JSF component refactoring rendered property rendering XHTML in a web browser RequestBean

required property scripting element in a JSP service method of Interface Servlet

servlet Servlet interface servlet container SessionBean

session tracking span element start tag **Static Text** JSF component Sun Java System Application Server tag extension mechanism tag library **Text Field** JSF component title XHTML element validation virtual directory Visual Editor web application development WYSIWYG (What You See Is What You Get)

editor xmlns attributes

**Self-Review Exercises 26.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) Every JSP web page created in Netbeans has its own ApplicationBean, SessionBean, and RequestBean files.

b) Event-processing life-cycle method init is invoked every time a page loads. c) Every component on a JSP web page is bound to a property in the Java page bean file. d) A single JSF component may have multiple validation components placed on it. e) If no expiration date is set for a cookie, that cookie will be destroyed at the end of the

browser session. f) Each JSF component maps to exactly one corresponding XHTML element. g) Expressions in the JSF Expression Language syntax are delimited by <!-- and -->. h) The SessionBean can store only primitive properties and properties of type String.

**26.2** Fill in the blanks in each of the following statements: a) The JSF component is used to display error messages if validation fails. b) A component that checks the input in another component before submitting that input

to the server is called a(n) . c) Every page bean class inherits from class . d) When a page loads the first time, the event occurs first, followed by the

event.  

**1186** Chapter 26 JavaServer™ Faces Web Applications

e) The file contains the functionality for a JSP. f) A(n) can be used in a custom validator method to validate the format of user

input. g) The array of Cookie objects stored on the client can be obtained by calling getCookies

on the object.

**Answers to Self-Review Exercises 26.1** a) False. If an application contains multiple JSPs, those JSPs will share the scoped data beans. b) False. init is invoked the first time the page is requested, but not on page refreshes. c) True. d) True. e) True. f) False. A web component can map to a group of XHTML elements— JSPs can generate complex XHTML markup from simple components. g) False. #{ and } delimit JSF Expression Language statements. h) False. The scoped data beans may store any type of prop- erty.

**26.2** a) **Message**. b) validator. c) AbstractPageBean. d) init, prerender. e) page bean. f) reg- ular expression. g) Request (HttpServletRequest).

**Exercises 26.3** _(WebTime Modification)_ Modify the WebTime example to contain drop-down lists that allow the user to modify such **Static Text** component properties as background-color, color and font-

size. Configure these drop-down lists so that the page refreshes whenever the user makes a selec- tion. When the page reloads, it should reflect the specified changes to the properties of the **Static Text** displaying the time.

**26.4** _(Registration Form Modification)_ Modify the WebComponents application to add functionality to the **Register** button. When the user clicks **Submit**, validate all input fields to make sure the user has filled out the form completely and entered a valid e-mail address and phone number. Then, di- rect the user to another page that displays a message indicating successful registration and echoes back the user’s registration information.

**26.5** _(Page Hit Counter with Cookies)_ Create a JSP that uses a persistent cookie (i.e., a cookie with an expiration date in the future) to keep track of how many times the client computer has visited the page. Use the setMaxAge method to cause the cookie to remain on the client’s computer for one month. Display the number of page hits (i.e., the cookie’s value) every time the page loads.

**26.6** _(Page Hit Counter with **ApplicationBean**)_ Create a JSP that uses the ApplicationBean to keep track of how many times a page has been visited. \[_Note:_ If you were to deploy this page on the web, it would count the number of times that any computer requested the page, unlike in the pre- vious exercise.\] Display the number of page hits (i.e., the value of an int property in the Applica-

tionBean) every time the page loads.  

27 Ajax-Enabled JavaServer™ Faces Web Applications

**O B J E C T I V E S** In this chapter you will learn:

■ To use data providers to access databases from web applications built in Netbeans.

■ To include Ajax-enabled JSF components in a Netbeans web application project.

■ To configure virtual forms that enable subsets of a form’s input components to be submitted to the server.

**_Whatever is in any way beautiful hath its source of beauty in itself, and is complete in itself; praise forms no part of it._ —Marcus Aurelius Antoninus**

**_There is something in a face, An air, and a peculiar grace, Which boldest painters cannot trace._ —William Somerville**

**_Cato said the best way to keep good acts in memory was to refresh them with new._ —Francis Bacon**

**_I never forget a face, but in your case I’ll make an exception._ —Groucho Marx**

**_Painting is only a bridge linking the painter’s mind with that of the viewer._ —Eugéne Delacroix**  

**1188** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications **O**

**u tl**

**in e**

**27.1 Introduction** This chapter continues our discussion of web application development with several ad- vanced concepts. We discuss accessing, updating and searching databases in a web appli- cation, adding virtual forms to web pages to enable subsets of a form’s input components to be submitted to the server, and using Ajax-enabled component libraries to improve ap- plication performance and component responsiveness. \[_Note:_ This chapter assumes that you know Java. To learn more about Java, check out _Java How to Program, Seventh Edition_, or visit our Java Resource Centers at www.deitel.com/ResourceCenters.html.\]

We present a single address book application developed in three stages to illustrate these concepts. The application is backed by a Java DB database for storing the contact names and their addresses.

The address book application presents a form that allows the user to enter a new name and address to store in the address book and displays the contents of the address book in table format. It also provides a search form that allows the user to search for a contact and, if found, display the contact’s address on a map. The first version of this application dem- onstrates how to add contacts to the database and how to display the list of contacts in a JSF **Table** component. In the second version, we add an Ajax-enabled **AutoComplete Text Field** component and enable it to suggest a list of contact names as the user types. The last version allows you to search the address book for a contact and display the corresponding address on a map using the Ajax-enabled **Map Viewer** component that is powered by Google Maps (maps.google.com).

As in Chapter 26, this chapter’s examples were developed in Netbeans. We installed a supplementary component library—the **Java BluePrints Ajax component library**— which provides the Ajax-enabled components used in the address book application.

**27.1** Introduction **27.2** Accessing Databases in Web Applications

**27.2.1** Building a Web Application That Displays Data from a Database **27.2.2** Modifying the Page Bean File for the AddressBook Application

**27.3** Ajax-Enabled JSF Components **27.4 AutoComplete Text Field** and Virtual Forms

**27.4.1** Configuring Virtual Forms **27.4.2** JSP File with Virtual Forms and an **AutoComplete Text Field**

**27.4.3** Providing Suggestions for an **AutoComplete Text Field**

**27.5** Google Maps **Map Viewer** Component **27.5.1** Obtaining a Google Maps API Key **27.5.2** Adding a **Map Viewer** Component to a Page **27.5.3** JSP File with a **Map Viewer** Component **27.5.4** Page Bean That Displays a Map in the **Map Viewer** Component

**27.6** Wrap-Up **27.7** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

27.2 Accessing Databases in Web Applications **1189**

Instructions for installing this library are included in Section 27.3. These Ajax-enabled components use the Dojo Toolkit (which we introduced in Chapter 15) on the client side.

**27.2 Accessing Databases in Web Applications** Many web applications access databases to store and retrieve persistent data. In this sec- tion, we build a web application that uses a Java DB database to store contacts in the ad- dress book and display contacts from the address book on a web page.

The web page enables the user to enter new contacts in a form. This form consists of **Text Field** components for the contact’s first name, last name, street address, city, state and zip code. The form also has a **Submit** button to send the data to the server and a **Clear** button to reset the form’s fields. The application stores the address book information in a database named AddressBook, which has a single table named Addresses. (We provide this database in the examples directory for this chapter. You can download the examples from www.deitel.com/books/iw3htp4/). This example also introduces the **Table** JSF component, which displays the addresses from the database in tabular format. We show how to configure the **Table** component shortly.

**27.2.1 Building a Web Application That Displays Data from a Database** We now explain how to build the AddressBook application’s GUI and set up a data bind- ing that allows the **Table** component to display information from the database. We present the generated JSP file later in the section, and we discuss the related page bean file in Section 27.2.2. To build the AddressBook application, perform the following steps:

**_Step 1: Creating the Project_** In Netbeans, create a **Visual Web Application** project named AddressBook. Rename the JSP and page bean files to AddressBook using the refactoring tools.

**_Step 2: Creating the Form for User Input_** In **Design** mode, add a **Static Text** component to the top of the page that reads "Add a con- tact to the address book:" and use the component’s style property to set the font size to 18px. Add six **Text Field** components to the page and rename them fnameTextField, lnameTextField, streetTextField, cityTextField, stateTextField and zipText-

Field. Set each **Text Field**’s required property to true by selecting the **Text Field**, then clicking the required property’s checkbox. Label each **Text Field** with a **Label** component and associate the **Label** with its corresponding **Text Field**. Finally, add a **Submit** and a **Clear** button. Set the **Submit** button’s **primary** property to true to make it stand out more on the page than the **Clear** button and to allow the user to submit a new contact by pressing _Enter_ rather than by clicking the **Submit** button. Set the **Clear** button’s **reset** property to true to prevent validation when the user clicks the **Clear** button. Since we are clearing the fields, we don’t need to ensure that they contain information. We discuss the action han- dler for the **Submit** button after we present the page bean file. The **Clear** button does not need an action-handler method, because setting the reset property to true automatically configures the button to reset all of the page’s input fields. When you have finished these steps, your form should look like Fig. 27.1.  

**1190** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**_Step 3: Adding a Table Component to the Page_** Drag a **Table** component from the **Basic** section of the **Palette** to the page and place it just below the two **Button** components. Name it addressesTable. The **Table** component for- mats and displays data from database tables. In the **Properties** window, change the **Table**’s title property to Contacts. We show how to configure the **Table** to interact with the AddressBook database shortly.

**_Step 4: Creating a Java DB Database_** This example uses a database called AddressBook to store the address information. To cre- ate this database, perform the following steps:

**1\.** Select **Tools > Java DB Database > Create Java DB Database…**.

**2\.** Enter the name of the database to create (AddressBook), a username (iw3htp4) and a password (iw3htp4), then click **OK** to create the database.

In the Netbeans **Runtime** tab (to the right of the **Projects** and **Files** tabs), the preceding steps create a new entry in the **Databases** node showing the URL of the database (jdbc:derby://localhost:1527/AddressBook). This URL indicates that the database re- sides on the local machine and accepts connections on port 1527.

**_Step 5: Adding a Table and Data to the AddressBook Database_** You can use the **Runtime** tab to create tables and to execute SQL statements that populate the database with data:

**1\.** Click the **Runtime** tab and expand the **Databases** node.

**2\.** Netbeans must be connected to the database to execute SQL statements. If Net- beans is already connected, proceed to _Step 3_. If Netbeans is not connected to the database, the icon appears next to the database’s URL (jdbc:derby:// localhost:1527/AddressBook). In this case, right click the icon and click **Con- nect…**. Once connected, the icon changes to .

**3\.** Expand the node for the AddressBook database, right click the **Tables** node and select **Execute Command…** to open a **SQL Command** editor in Netbeans. We pro- vided the file AddressBook.sql in this chapter’s examples folder. Open that file in a text editor, copy the SQL statements and paste them into the **SQL Command** editor in Netbeans. Then, highlight all the SQL commands, right click inside the **SQL Command** editor and select **Run Selection**. This will create the Addresses ta- ble with the sample data shown in Fig. 27.2. You may need to refresh the **Tables** node of the **Runtime** tab to see the new table.

**Fig. 27.1** | AddressBook application form for adding a contact.  

27.2 Accessing Databases in Web Applications **1191**

**_Step 6: Binding the Table Component to the Addresses Table of the AddressBook Database_** Now that we’ve configured a data source for the Addresses database table, we can configure the **Table** component to display the AddressBook data. Simply drag the database table from the **Servers** tab and drop it on the **Table** component to create the binding.

To select specific columns to display, right click the **Table** component and select **Bind to Data** to display the **Bind to Data** dialog containing the list of the columns in the Addresses database table (Fig. 27.3). The items under the **Selected** heading will be dis- played in the **Table**. To remove a column, select it and click the **<** button. We’d like to display all the columns in this example, so you should simply click **OK** to exit the dialog.

By default, the **Table** uses the database table’s column names in all uppercase letters as headings. To change these headings, select a column and edit its headerText property in the **Properties** window. To select a column, click the column’s name in the **Design** mode. We also changed the id property of each column to make the variable names in the code more readable. In **Design** mode, your **Table**’s column heads should appear as in Fig. 27.4.

FirstName LastName Street City State Zip

Bob Green 5 Bay St. San Francisco CA 94133

Liz White 100 5th Ave. New York NY 10011

Mike Brown 3600 Delmar Blvd. St. Louis MO 63108

Mary Green 300 Massachusetts Ave. Boston MA 02115

John Gray 500 South St. Philadelphia PA 19147

Meg Gold 1200 Stout St. Denver CO 80204

James Blue 1000 Harbor Ave. Seattle WA 98116

Sue Black 1000 Michigan Ave. Chicago IL 60605

**Fig. 27.2** | Addresses table data.

**Fig. 27.3** | Dialog for binding to the Addresses table.  

**1192** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

An address book might contain many contacts, so we’d like to display only a few at a time. Clicking the checkbox next to the table’s paginationControls property in the **Prop- erties** window configures this **Table** for automatic pagination. This adds buttons to the bottom of the **Table** for moving forward and backward between groups of contacts. You may use the **Table Layout** dialog’s **Options** tab to select the number of rows to display at a time. To view this tab, right click the **Table**, select **Table Layout…**, then click the **Options** tab. For this example, we set the **Page Size** property to 5.

Next, set the addressesTable’s internalVirtualForm property. Virtual forms allow subsets of a form’s input components to be submitted to the server. Setting this property prevents the pagination control buttons on the **Table** from submitting the **Text Field**s on the form every time the user wishes to view the next group of contacts. Virtual forms are discussed in Section 27.4.1.

Binding the **Table** to a data provider added a new addressesDataProvider object (an instance of class **CachedRowSetDataProvider**) to the **AddressBook** node in the **Outline** window. A CachedRowSetDataProvider provides a scrollable RowSet that can be bound to a **Table** component to display the RowSet’s data. This data provider is a wrapper for a CachedRowSet object. If you click the **addressesDataProvider** element in the **Outline** window, you’ll see in the **Properties** window that its CachedRowSet property is set to addressesRowSet, an object (in the session bean) that implements interface CachedRowSet.

**_Step 7: Modifying addressesRowSet’s SQL Statement_** The CachedRowSet object wrapped by our addressesDataProvider is configured by de- fault to execute a SQL query that selects all the data in the Addresses table of the Ad-

dressBook database. You can edit this SQL query by expanding the SessionBean node in the **Outline** window and double clicking the addressesRowSet element to open the query editor window (Fig. 27.5). We’d like to edit the SQL statement so that records with du- plicate last names are sorted by last name, then by first name. To do this, click in the **Sort Type** column next to the **LASTNAME** row and select **Ascending**. Then, repeat this for the **FIRSTNAME** row. Notice that the expression

ORDER BY IW3HTP4.ADDRESSES.LASTNAME ASC, IW3HTP4.ADDRESSES.FIRSTNAME ASC

was added to the SQL statement at the bottom of the editor.

**_Step 8: Adding Validation_** It is important to validate the form data on this page to ensure that the data can be suc- cessfully inserted into the AddressBook database. All of the database’s columns are of type varchar (except the ID column) and have length restrictions. For this reason, you should

**Fig. 27.4** | Table component after binding it to a database table and editing its column names for display purposes.  

27.2 Accessing Databases in Web Applications **1193**

either add a **Length Validator** to each **Text Field** component or set each **Text Field** compo- nent’s maxLength property. We chose to set the maxLength property of each. The first name, last name, street, city, state and zip code **Text Field** components may not exceed 30, 30, 150, 30, 2 and 5 characters, respectively.

Finally, drag a **Message Group** component onto your page to the right of the **Text Field**s. A **Message Group** component displays system messages. We use this component to display an error message when an attempt to add a contact to the database fails. Set the **Message Group**’s showGlobalOnly property to true to prevent component-level valida- tion error messages from being displayed here.

**_JSP File for a Web Page That Interacts with a Database_** The JSP file for the application is shown in Fig. 27.6. This file contains a large amount of generated markup for components you learned in Chapter 26. We discuss the markup for only the components that are new in this example.

**Fig. 27.5** | Editing addressesRowSet’s SQL statement.

**1** <?xml version="1.0" encoding="UTF-8"?> **2** <!-- Fig. 27.6: AddressBook.jsp --> **3** <!-- AddressBook JSP with an add form and a Table JSF component. --> **4** <jsp:root version="1.2" **5** xmlns:f="http://java.sun.com/jsf/core" **6** xmlns:h="http://java.sun.com/jsf/html" **7** xmlns:jsp="http://java.sun.com/JSP/Page" **8** xmlns:webuijsf="http://www.sun.com/webui/webuijsf"> **9** <jsp:directive.page contentType="text/html;charset=UTF-8"

**10** pageEncoding="UTF-8"/>

**Fig. 27.6** | AddressBook JSP with an add form and a **Table** JSF component (Part 1 of 5.)  

**1194** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**11** <f:view> **12** <webuijsf:page binding="#{AddressBook.page1}" id="page1"> **13** <webuijsf:html binding="#{AddressBook.html1}" id="html1"> **14** <webuijsf:head binding="#{AddressBook.head1}" id="head1"> **15** <webuijsf:link binding="#{AddressBook.link1}" id="link1" **16** url="/resources/stylesheet.css"/> **17** </webuijsf:head> **18** <webuijsf:body binding="#{AddressBook.body1}" id="body1" **19** style="-rave-layout: grid"> **20** <webuijsf:form binding="#{AddressBook.form1}" id="form1"> **21** <webuijsf:staticText binding="#{AddressBook.staticText1}" **22** id="staticText1" style="font-size: 18px; left: 24px; **23** top: 24px; position: absolute" **24** text="Add a contact to the address book:"/> **25** <webuijsf:label binding="#{AddressBook.fnameLabel}" **26** for="fnameTextField" id="fnameLabel" style= **27** "position: absolute; left: 24px; top: 72px" **28** text="First name:"/> **29** <webuijsf:textField binding="#{AddressBook.fnameTextField}" **30** id="fnameTextField" maxLength="30" required="true" **31** style="left: 100px; top: 72px; position: absolute; **32** width: 192px"/> **33** <webuijsf:label binding="#{AddressBook.lnameLabel}" **34** for="lnameTextField" id="lnameLabel" style="left: 312px; **35** top: 72px; position: absolute" text="Last name:"/> **36** <webuijsf:textField binding="#{AddressBook.lnameTextField}" **37** id="lnameTextField" maxLength="30" required="true" **38** style="left: 390px; top: 72px; position: absolute; **39** width: 214px"/> **40** <webuijsf:label binding="#{AddressBook.streetLabel}" **41** for="streetTextField" id="streetLabel" style="position: **42** absolute; left: 24px; top: 96px" text="Street:"/> **43** <webuijsf:textField binding= **44** "#{AddressBook.streetTextField}" id="streetTextField" **45** maxLength="150" required="true" style="left: 100px; **46** top: 96px; position: absolute; width: 504px"/> **47** <webuijsf:label binding="#{AddressBook.cityLabel}" **48** for="cityTextField" id="cityLabel" style="left: 24px; **49** top: 120px; position: absolute" text="City:"/> **50** <webuijsf:textField binding="#{AddressBook.cityTextField}" **51** id="cityTextField" maxLength="30" required="true" **52** style="left: 100px; top: 120px; position: absolute; **53** width: 240px"/> **54** <webuijsf:label binding="#{AddressBook.stateLabel}" **55** for="stateTextField" id="stateLabel" style="left: 360px; **56** top: 120px; position: absolute" text="State:"/> **57** <webuijsf:textField binding="#{AddressBook.stateTextField}" **58** id="stateTextField" maxLength="2" required="true" **59** style="left: 412px; top: 120px; position: absolute; **60** width: 48px"/> **61** <webuijsf:label binding="#{AddressBook.zipLabel}" **62** for="zipTextField" id="zipLabel" style="left: 490px; **63** top: 120px; position: absolute" text=" Zip:"/>

**Fig. 27.6** | AddressBook JSP with an add form and a **Table** JSF component (Part 2 of 5.)  

27.2 Accessing Databases in Web Applications **1195**

**64** <webuijsf:textField binding="#{AddressBook.zipTextField}" **65** id="zipTextField" maxLength="5" required="true" **66** style="left: 534px; top: 120px; position: absolute; **67** width: 70px"/> **68** <webuijsf:button actionExpression= **69** "#{AddressBook.submitButton\_action}" binding= **70** "#{AddressBook.submitButton}" id="submitButton" **71** primary="true" style="left: 100px; top: 168px; **72** position: absolute; width: 100px" text="Submit"/> **73** <webuijsf:button binding="#{AddressBook.clearButton}" **74** id="clearButton" reset="true" style="left: 215px; top: **75** 168px; position: absolute; width: 100px" text="Clear"/> **76** <webuijsf:messageGroup binding= **77** "#{AddressBook.messageGroup1}" id="messageGroup1" **78** showGlobalOnly="true" style="left: 624px; top: 72px; **79** position: absolute"/> **80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99** <webuijsf:tableColumn binding= **100** "#{AddressBook.lnameColumn}" **101** headerText="Last Name" id="lnameColumn" **102** sort="ADDRESSES.LASTNAME"> **103** <webuijsf:staticText binding= **104** "#{AddressBook.staticText3}" id="staticText3" **105** text="#{currentRow.value\[ **106** 'ADDRESSES.LASTNAME'\]}"/> **107** </webuijsf:tableColumn> **108** <webuijsf:tableColumn binding= **109** "#{AddressBook.streetColumn}" headerText="Street" **110** id="streetColumn" sort="ADDRESSES.STREET"> **111** <webuijsf:staticText binding= **112** "#{AddressBook.staticText4}" id="staticText4" **113** text="#{currentRow.value\[ **114** 'ADDRESSES.STREET'\]}"/> **115** </webuijsf:tableColumn>

**Fig. 27.6** | AddressBook JSP with an add form and a **Table** JSF component (Part 3 of 5.)

<webuijsf:table augmentTitle="false" binding= "#{AddressBook.addressesTable}" id="addressesTable" paginateButton="true" paginationControls="true" style="left: 24px; top: 216px; position: absolute" title="Contacts" width="816"> <webuijsf:tableRowGroup binding=

"#{AddressBook.tableRowGroup1}" id="tableRowGroup1" rows="5" sourceData="#{AddressBook.addressesDataProvider}" sourceVar="currentRow"> <webuijsf:tableColumn binding=

"#{AddressBook.fnameColumn}" headerText= "First Name" id="fnameColumn" sort="ADDRESSES.FIRSTNAME"> <webuijsf:staticText binding=

"#{AddressBook.staticText2}" id="staticText2" text="#{currentRow.value\[ 'ADDRESSES.FIRSTNAME'\]}"/>

</webuijsf:tableColumn>  

**1196** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**116** <webuijsf:tableColumn binding= **117** "#{AddressBook.cityColumn}" headerText="City" **118** id="cityColumn" sort="ADDRESSES.CITY"> **119** <webuijsf:staticText binding= **120** "#{AddressBook.staticText5}" id="staticText5" **121** text="#{currentRow.value\['ADDRESSES.CITY'\]}"/> **122** </webuijsf:tableColumn> **123** <webuijsf:tableColumn binding= **124** "#{AddressBook.stateColumn}" headerText="State" **125** id="stateColumn" sort="ADDRESSES.STATE"> **126** <webuijsf:staticText binding= **127** "#{AddressBook.staticText6}" id="staticText6" **128** text="#{currentRow.value\['ADDRESSES.STATE'\]}"/> **129** </webuijsf:tableColumn> **130** <webuijsf:tableColumn binding= **131** "#{AddressBook.zipColumn}" headerText="Zip" **132** id="zipColumn" sort="ADDRESSES.ZIP" width="106"> **133** <webuijsf:staticText binding= **134** "#{AddressBook.staticText7}" id="staticText7" **135** text="#{currentRow.value\['ADDRESSES.ZIP'\]}"/> **136** </webuijsf:tableColumn> **137** </webuijsf:tableRowGroup> **138** </webuijsf:table> **139** </webuijsf:form> **140** </webuijsf:body> **141** </webuijsf:html> **142** </webuijsf:page> **143** </f:view> **144** </jsp:root>

**Fig. 27.6** | AddressBook JSP with an add form and a **Table** JSF component (Part 4 of 5.)

a)  

27.2 Accessing Databases in Web Applications **1197**

Lines 21–75 contain the JSF components for the form that gathers user input. Lines 80–138 define the **Table** element (webuijsf:table) that displays address information from the database. JSF **Table**s may have multiple groups of rows displaying different data. This **Table** has a single webuijsf:tableRowGroup with a start tag in lines 85–89. The row group’s sourceData attribute is bound to our addressesDataProvider and given the vari- able name currentRow. The row group also defines the **Table**’s columns. Each webuijsf:tableColumn element (e.g., lines 90–98) contains a webuijsf:staticText ele- ment with its text attribute bound to a column in the data provider currentRow. These webuijsf:staticText elements enable the **Table** to display each row’s data.

**_Session Bean for the AddressBook Application_** Figure 27.7 displays the SessionBean1.java file generated by Netbeans for the Address- Book application. The CachedRowSet that the **Table** component’s data provider uses to ac- cess the AddressBook database is a property of this class (lines 31–41).

**1** // Fig. 27.7: SessionBean1.java **2** // Session bean that initializes the data source for the **3** // AddressBook database. **4** package addressbook; **5 6** import com.sun.rave.web.ui.appbase.AbstractSessionBean; **7** import com.sun.sql.rowset.CachedRowSetXImpl; **8** import javax.faces.FacesException;

**Fig. 27.7** | Session Bean that initializes the data source for the AddressBook database. (Part 1 of 2.)

**Fig. 27.6** | AddressBook JSP with an add form and a **Table** JSF component (Part 5 of 5.)

b)  

**1198** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

The \_init method (lines 14–29) configures addressesRowSet to interact with the AddressBook database (lines 16–28). Lines 16–17 connect the row set to the database. Lines 18–27 set addressesRowSet’s SQL command to the query configured in Fig. 27.5. Line 28 sets the RowSet’s table name.

**27.2.2 Modifying the Page Bean File for the AddressBook Application** After building the web page and configuring the components used in this example, double click the **Submit** button to create an action event handler for this button in the page bean file. The code to insert a contact into the database will be placed in this method. The page bean with the completed event handler is shown in Fig. 27.8 below.

**9 10** public class SessionBean1 extends AbstractSessionBean **11** { **12** private int \_\_placeholder; **13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31** private CachedRowSetXImpl addressesRowSet = new CachedRowSetXImpl(); **32 33** public CachedRowSetXImpl getAddressesRowSet() **34** { **35** return addressesRowSet; **36** } **37 38** public void setAddressesRowSet( CachedRowSetXImpl crsxi ) **39** { **40** this.addressesRowSet = crsxi; **41** } **42 43 44 79** } // end class SessionBean1

**Fig. 27.7** | Session Bean that initializes the data source for the AddressBook database. (Part 2 of 2.)

private void \_init() throws Exception {

addressesRowSet.setDataSourceName( "java:comp/env/jdbc/dataSource" );

addressesRowSet.setCommand( "SELECT ALL IW3HTP4.ADDRESSES.FIRSTNAME, \\n" + "IW3HTP4.ADDRESSES.LASTNAME, \\n" + "IW3HTP4.ADDRESSES.STREET, \\n" + "IW3HTP4.ADDRESSES.CITY, \\n" + "IW3HTP4.ADDRESSES.STATE, \\n" + "IW3HTP4.ADDRESSES.ZIP \\n" + "FROM IW3HTP4.ADDRESSES\\n" + "ORDER BY IW3HTP4.ADDRESSES.LASTNAME ASC, \\n" + "IW3HTP4.ADDRESSES.FIRSTNAME ASC " );

addressesRowSet.setTableName( "ADDRESSES" ); } // end method \_init

// To save space, we omitted the code in lines 42-78. The complete // source code is provided with this chapter's examples.  

27.2 Accessing Databases in Web Applications **1199**

**1** // Fig. 27.8: AddressBook.java **2** // Page bean for AddressBook.jsp. **3** package addressbook; **4 5** import com.sun.data.provider.RowKey; **6** import com.sun.data.provider.impl.CachedRowSetDataProvider; **7** import com.sun.rave.web.ui.appbase.AbstractPageBean; **8** import com.sun.webui.jsf.component.Body; **9** import com.sun.webui.jsf.component.Button;

**10** import com.sun.webui.jsf.component.Form; **11** import com.sun.webui.jsf.component.Head; **12** import com.sun.webui.jsf.component.Html; **13** import com.sun.webui.jsf.component.Label; **14** import com.sun.webui.jsf.component.Link; **15** import com.sun.webui.jsf.component.MessageGroup; **16** import com.sun.webui.jsf.component.Page; **17** import com.sun.webui.jsf.component.StaticText; **18** import com.sun.webui.jsf.component.Table; **19** import com.sun.webui.jsf.component.TableColumn; **20** import com.sun.webui.jsf.component.TableRowGroup; **21** import com.sun.webui.jsf.component.TextField; **22** import com.sun.webui.jsf.model.DefaultTableDataProvider; **23** import javax.faces.FacesException; **24 25** public class AddressBook extends AbstractPageBean **26** { **27** private int \_\_placeholder; **28 29** private void \_init() throws Exception **30** { **31** addressesDataProvider.setCachedRowSet( **32** ( javax.sql.rowset.CachedRowSet ) getValue( **33** "#{SessionBean1.addressesRowSet}" ) ); **34** addressesTable.setInternalVirtualForm( true ); **35** } // end method \_init **36 37 38 39 506** public void prerender() **507** { **508 509** } // end method prerender **510 511** public void destroy() **512** { **513 514** } // end method destroy **515 516 517 518**

**Fig. 27.8** | Page bean for adding a contact to the address book. (Part 1 of 2.)

// To save space, we omitted the code in lines 37-505. The complete // source code is provided with this chapter's examples.

addressesDataProvider.refresh();

addressesDataProvider.close();

// To save space, we omitted the code in lines 516-530. The complete // source code is provided with this chapter's examples.  

**1200** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

Lines 533–572 contain the event-handling code for the **Submit** button. Line 535 determines whether a new row can be appended to the data provider. If so, a new row is appended at line 539. Every row in a CachedRowSetDataProvider has its own key; method **appendRow** returns the key for the new row. Line 540 sets the data provider’s cursor to the new row, so that any changes we make to the data provider affect that row. Lines 542–553 set each of the row’s columns to the values entered by the user in the cor-

**531** // action handler that adds a contact to the AddressBook database **532** // when the user clicks Submit **533** public String submitButton\_action() **534** { **535** if ( addressesDataProvider.canAppendRow() ) **536** { **537** try **538** { **539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556** // reset text fields **557** lnameTextField.setValue( "" ); **558** fnameTextField.setValue( "" ); **559** streetTextField.setValue( "" ); **560** cityTextField.setValue( "" ); **561** stateTextField.setValue( "" ); **562** zipTextField.setValue( "" ); **563** } // end try **564** catch ( Exception ex ) **565** { **566** error( "The address book was not updated. " + **567** ex.getMessage() ); **568** } // end catch **569** } // end if **570 571** return null; **572** } // end method submitButton\_action **573** } // end class AddressBook

**Fig. 27.8** | Page bean for adding a contact to the address book. (Part 2 of 2.)

RowKey rk = addressesDataProvider.appendRow(); addressesDataProvider.setCursorRow( rk );

addressesDataProvider.setValue( "ADDRESSES.FIRSTNAME", fnameTextField.getValue() );

addressesDataProvider.setValue( "ADDRESSES.LASTNAME", lnameTextField.getValue() );

addressesDataProvider.setValue( "ADDRESSES.STREET", streetTextField.getValue() );

addressesDataProvider.setValue( "ADDRESSES.CITY", cityTextField.getValue() );

addressesDataProvider.setValue( "ADDRESSES.STATE", stateTextField.getValue() );

addressesDataProvider.setValue( "ADDRESSES.ZIP", zipTextField.getValue() );

addressesDataProvider.commitChanges();  

27.3 Ajax-Enabled JSF Components **1201**

responding **Text Field**s. Line 554 stores the new contact by calling method **commitChanges**

of class CachedRowSetDataProvider to insert the new row into the AddressBook database. Lines 557–562 clear the form’s **Text Field**s. If these lines are omitted, the fields will

retain their current values after the database is updated and the page reloads. Also, the **Clear** button will not work properly if the **Text Field**s are not cleared. Rather than emptying the **Text Field**s, it resets them to the values they held the last time the form was submitted.

Lines 564–568 catch any exceptions that might occur while updating the Address-

Book database. Lines 566–567 display a message indicating that the database was not updated as well as the exception’s error message in the page’s MessageGroup component.

In method prerender, line 508 calls CachedRowSetDataProvider method **refresh**. This re-executes the wrapped CachedRowSet’s SQL statement and re-sorts the **Table**’s rows so that the new row is displayed in the proper order. If you do not call refresh, the new address is displayed at the end of the **Table** (since we appended the new row to the end of the data provider). The IDE automatically generated code to free resources used by the data provider (line 513) in the destroy method.

**27.3 Ajax-Enabled JSF Components** The **Java BluePrints Ajax component library** provides **Ajax-enabled JSF components**. These components rely on Ajax technology to deliver the feel and responsiveness of a desk- top application over the web. Figure 27.9 summarizes the current set of components that you can download and use with Netbeans. We demonstrate the **AutoComplete Text Field** and **Map Viewer** components in the next two sections.

Component Description

**AutoComplete Text Field**

Makes Ajax requests to display a list of suggestions as the user types in the text field.

**Buy Now Button** Initiates a transaction through the PayPal website.

**Map Viewer** Uses the Google Maps API to display a map that pans, zooms, and can display markers for locations of interest.

**Popup Calendar** Provides a calendar that enables a user to scroll between months and years. Fills a **Text Field** with a formatted date when the user selects a day.

**Progress Bar** Visually displays the progress of a long-running operation. Uses a pro- grammer-supplied calculation to determine the progress percentage.

**Rating** Provides a customizable five-star rating bar that can display messages as the user moves the mouse over the ratings.

**Rich Textarea Editor**

Provides an editable text area that allows the user to format text with fonts, colors, hyperlinks and backgrounds.

**Select Value Text Field**

Displays a list of suggestions in a drop-down list as the user types, similar to the **AutoComplete Text Field**.

**Fig. 27.9** | Java BluePrints component library’s Ajax-enabled components.  

**1202** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**_Downloading the Java BluePrints Ajax-Enabled Components_** To use the Java BluePrints Ajax-enabled components in Netbeans, you must download and import them. The IDE provides a wizard for installing this group of components (In- ternet access is required). To access it, choose **Tools > Update Center** to display the **Update Center Wizard** dialog. Click **Next >** to search for available updates. In the **Available Updates and New Modules** area of the dialog, locate and select **BluePrints AJAX Components** then click the **Add >** button to add them to the list of items you’d like to install. Click **Next >** and follow the prompts to accept the terms of use and download the components. When the download completes, click **Next >** then click **Finish**. Click **OK** to restart the IDE.

**_Importing the Java BluePrints Ajax-Enabled Components into the Netbeans Palette_** Next, you must import the components into the **Palette**. Select **Tools > Component Library Manager**, then click **Import…**. Click **Browse…** in the **Component Library Manager** dialog that appears. Select the ui.complib file and click **Open**. Click **OK** to import both the **Blue- Prints AJAX Components** and the **BluePrints AJAX Support Beans**. Close the **Component Li- brary Manager** to return to the IDE.

To see the new components in the **Palette**, you must add the **BluePrints AJAX Com- ponents** library to your visual web application. To do so, make sure your application’s node is expanded in the **Projects** tab. Right click the **Component Libraries** node and select **Add Component Library**. In the **Add Component Library** dialog box, select the **BluePrints AJAX Components library** and click **Add Component Library**. You should now see two new nodes in the **Palette**. The first, **BluePrints AJAX Components**, provides the eight compo- nents listed in Fig. 27.9. The second, **BluePrints AJAX Support Beans**, includes compo- nents that support the Ajax components. You can now build high-performance Ajax web applications by dragging, dropping and configuring the component’s properties, just as you do with other components in the **Palette**.

**27.4 AutoComplete Text Field and Virtual Forms** We demonstrate the **AutoComplete Text Field** component from the BluePrints catalog by modifying the form in our AddressBook application. The **AutoComplete Text Field** pro- vides a list of suggestions as the user types. It obtains the suggestions from a data source, such as a database or web service. Eventually, the new form will allow users to search the address book by last name, then first name. If the user selects a contact, the application will display the contact’s name and address on a map of the neighborhood. We build this form in two stages. First, we’ll add the **AutoComplete Text Field** that will display sugges- tions as the user types a contact’s last name. Then we’ll add the search functionality and map display in the next step.

**_Adding Search Components to the AddressBook.jsp Page_** Using the AddressBook application from Section 27.2, drop a **Static Text** component named searchHeader below addressesTable. Change its text to "Search the address

book by last name:" and change its font size to 18px. Now drag an **AutoComplete Text Field** component to the page and name it nameAutoComplete. Set this field’s required

property to true. Add a **Label** named nameSearchLabel containing the text "Last name:" to the left of the **AutoComplete Text Field**. Finally, add a button called lookUpButton with the text Look Up to the right of the **AutoComplete Text Field**.  

27.4 **AutoComplete Text Field** and Virtual Forms **1203**

**27.4.1 Configuring Virtual Forms Virtual forms** are used when you would like a button to submit a subset of the page’s input fields to the server. Recall that the **Table**’s internal virtual forms were enabled so that click- ing the pagination buttons would not submit any of the data in the **Text Field**s used to add a contact to the AddressBook database. Virtual forms are particularly useful for displaying multiple forms on the same page. They allow you to specify a **submitter** component and one or more **participant** components for a form. When the virtual form’s submitter com- ponent is clicked, only the values of its participant components will be submitted to the server. We use virtual forms in our AddressBook application to separate the form for add- ing a contact to the AddressBook database from the form for searching the database.

To add virtual forms to the page, right click the **Submit** button on the upper form and choose **Configure Virtual Forms…** from the popup menu to display the **Configure Virtual Forms** dialog. Click **New** to add a virtual form, then click in the **Name** column and change the new form’s name to addForm. Double click the **Submit** column and change the option to **Yes** to indicate that this button should be used to submit the addForm virtual form. Click **OK** to exit the dialog. Next, select all the **Text Field**s used to enter a contact’s infor- mation in the upper form. You can do this by holding the _Ctrl_ key while you click each **Text Field**. Right click one of the selected **Text Field**s and choose **Configure Virtual Forms…**. In the **Participate** column of the addForm, change the option to **Yes** to indicate that the values in these **Text Field**s should be submitted to the server when the form is submitted. Click **OK** to exit.

Repeat the process described above to create a second virtual form named searchForm

for the lower form. Figure 27.10 shows the **Configure Virtual Forms** dialog after both virtual forms have been added. The **Look Up** Button should submit the searchForm, and nameAu-

toComplete should participate in the searchForm. Next, return to **Design** mode and click the **Show Virtual Forms** button ( ) at the top of the Visual Designer panel to display a legend of the virtual forms on the page. Your virtual forms should be configured as in Fig. 27.11. The **Text Field**s outlined in blue participate in the virtual form addForm. Those outlined in green participate in the virtual form searchForm. The components outlined with a dashed line submit their respective forms. A color key is provided at the bottom right of the **Design** area so that you know which components belong to each virtual form.

**Fig. 27.10** | **Configure Virtual Forms** dialog.  

**1204** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**27.4.2 JSP File with Virtual Forms and an AutoComplete Text Field**

Figure 27.12 presents the JSP file generated by Netbeans for this stage of the AddressBook application. A new tag library is specified in the root element (xmlns:bp="http:// java.sun.com/blueprints/ui/14"; line 5). This is the BluePrints catalog library that provides Ajax-enabled components such as the **AutoComplete Text Field** component. We focus only on the new features of this JSP.

Lines 22–25 configure the virtual forms for this page. Lines 147–151 define the **Auto- Complete Text Field** component. This component’s completionMethod attribute is bound to the page bean’s nameAutoComplete\_complete method (discussed in Section 27.4.3), which provides the list of options the **AutoComplete Text Field** component should suggest. To create this method, right click the nameAutoComplete component in **Design** view and select **Edit Event Handler > complete**. Notice that the **Look Up** button (lines 155–157) does not specify an action-handler method binding; we’ll add this in Section 27.5.

**Fig. 27.11** | Virtual forms legend.

**1** <?xml version="1.0" encoding="UTF-8"?> **2** <!-- Fig. 27.12: AddressBook.jsp --> **3** <!-- AddressBook JSP with an add form and a Table JSF component. --> **4** <jsp:root version="1.2" **5 6** xmlns:f="http://java.sun.com/jsf/core" **7** xmlns:h="http://java.sun.com/jsf/html" **8** xmlns:jsp="http://java.sun.com/JSP/Page" **9** xmlns:webuijsf="http://www.sun.com/webui/webuijsf">

**Fig. 27.12** | AddressBook JSP with an **AutoComplete Text Field** component. (Part 1 of 5.)

**Show Virtual Forms** button

xmlns:bp="http://java.sun.com/blueprints/ui/14"  

27.4 **AutoComplete Text Field** and Virtual Forms **1205**

**10** <jsp:directive.page contentType="text/html;charset=UTF-8" **11** pageEncoding="UTF-8"/> **12** <f:view> **13** <webuijsf:page binding="#{AddressBook.page1}" id="page1"> **14** <webuijsf:html binding="#{AddressBook.html1}" id="html1"> **15** <webuijsf:head binding="#{AddressBook.head1}" id="head1"> **16** <webuijsf:link binding="#{AddressBook.link1}" id="link1" **17** url="/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding="#{AddressBook.body1}" id="body1" **20** style="-rave-layout: grid"> **21** <webuijsf:form binding="#{AddressBook.form1}" id="form1" **22 23 24 25 26** <webuijsf:staticText binding="#{AddressBook.staticText1}" **27** id="staticText1" style="font-size: 18px; left: 24px; **28** top: 24px; position: absolute" **29** text="Add a contact to the address book:"/> **30** <webuijsf:label binding="#{AddressBook.fnameLabel}" **31** for="fnameTextField" id="fnameLabel" style="position: **32** absolute; left: 24px; top: 72px" text="First name:"/> **33** <webuijsf:textField binding="#{AddressBook.fnameTextField}" **34** id="fnameTextField" maxLength="30" required="true" **35** style="left: 100px; top: 72px; position: absolute; **36** width: 192px"/> **37** <webuijsf:label binding="#{AddressBook.lnameLabel}" **38** for="lnameTextField" id="lnameLabel" style="left: 312px; **39** top: 72px; position: absolute" text="Last name:"/> **40** <webuijsf:textField binding="#{AddressBook.lnameTextField}" **41** id="lnameTextField" maxLength="30" required="true" **42** style="left: 390px; top: 72px; position: absolute; **43** width: 214px"/> **44** <webuijsf:label binding="#{AddressBook.streetLabel}" **45** for="streetTextField" id="streetLabel" style="position: **46** absolute; left: 24px; top: 96px" text="Street:"/> **47** <webuijsf:textField binding= **48** "#{AddressBook.streetTextField}" id="streetTextField" **49** maxLength="150" required="true" style="left: 100px; **50** top: 96px; position: absolute; width: 504px"/> **51** <webuijsf:label binding="#{AddressBook.cityLabel}" **52** for="cityTextField" id="cityLabel" style="left: 24px; **53** top: 120px; position: absolute" text="City:"/> **54** <webuijsf:textField binding="#{AddressBook.cityTextField}" **55** id="cityTextField" maxLength="30" required="true" **56** style="left: 100px; top: 120px; position: absolute; **57** width: 240px"/> **58** <webuijsf:label binding="#{AddressBook.stateLabel}" **59** for="stateTextField" id="stateLabel" style="left: 360px; **60** top: 120px; position: absolute" text="State:"/>

**Fig. 27.12** | AddressBook JSP with an **AutoComplete Text Field** component. (Part 2 of 5.)

virtualFormsConfig="addForm | zipTextField lnameTextField fnameTextField streetTextField cityTextField stateTextField | submitButton , searchForm | nameAutoComplete | lookUpButton">  

**1206** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**61** <webuijsf:textField binding="#{AddressBook.stateTextField}" **62** id="stateTextField" maxLength="2" required="true" **63** style="left: 412px; top: 120px; position: absolute; **64** width: 48px"/> **65** <webuijsf:label binding="#{AddressBook.zipLabel}" **66** for="zipTextField" id="zipLabel" style="left: 490px; **67** top: 120px; position: absolute" text="Zip:"/> **68** <webuijsf:textField binding="#{AddressBook.zipTextField}" **69** id="zipTextField" maxLength="5" required="true" **70** style="left: 534px; top: 120px; position: absolute; **71** width: 70px"/> **72** <webuijsf:button actionExpression= **73** "#{AddressBook.submitButton\_action}" binding= **74** "#{AddressBook.submitButton}" id="submitButton" primary= **75** "true" style="left: 100px; top: 168px; position: **76** absolute; width: 100px" text="Submit"/> **77** <webuijsf:button binding="#{AddressBook.clearButton}" **78** id="clearButton" reset="true" style="left: 215px; top: **79** 168px; position: absolute; width: 100px" text="Clear"/> **80** <webuijsf:messageGroup binding= **81** "#{AddressBook.messageGroup1}" id="messageGroup1" **82** showGlobalOnly="true" style="left: 624px; top: 72px; **83** position: absolute"/> **84** <webuijsf:table augmentTitle="false" binding= **85** "#{AddressBook.addressesTable}" id="addressesTable" **86** paginateButton="true" paginationControls="true" **87** style="left: 24px; top: 216px; position: absolute" **88** title="Contacts" width="816"> **89** <webuijsf:tableRowGroup binding= **90** "#{AddressBook.tableRowGroup1}" id="tableRowGroup1" **91** rows="5" sourceData= **92** "#{AddressBook.addressesDataProvider}" **93** sourceVar="currentRow"> **94** <webuijsf:tableColumn binding= **95** "#{AddressBook.fnameColumn}" headerText= **96** "First Name" id="fnameColumn" **97** sort="ADDRESSES.FIRSTNAME"> **98** <webuijsf:staticText binding= **99** "#{AddressBook.staticText2}" id="staticText2" **100** text="#{currentRow.value\[ **101** 'ADDRESSES.FIRSTNAME'\]}"/> **102** </webuijsf:tableColumn> **103** <webuijsf:tableColumn binding= **104** "#{AddressBook.lnameColumn}" **105** headerText="Last Name" id="lnameColumn" **106** sort="ADDRESSES.LASTNAME"> **107** <webuijsf:staticText binding= **108** "#{AddressBook.staticText3}" id="staticText3" **109** text="#{currentRow.value\[ **110** 'ADDRESSES.LASTNAME'\]}"/> **111** </webuijsf:tableColumn>

**Fig. 27.12** | AddressBook JSP with an **AutoComplete Text Field** component. (Part 3 of 5.)  

27.4 **AutoComplete Text Field** and Virtual Forms **1207**

**112** <webuijsf:tableColumn binding= **113** "#{AddressBook.streetColumn}" headerText="Street" **114** id="streetColumn" sort="ADDRESSES.STREET"> **115** <webuijsf:staticText binding= **116** "#{AddressBook.staticText4}" id="staticText4" **117** text="#{currentRow.value\[ **118** 'ADDRESSES.STREET'\]}"/> **119** </webuijsf:tableColumn> **120** <webuijsf:tableColumn binding= **121** "#{AddressBook.cityColumn}" headerText="City" **122** id="cityColumn" sort="ADDRESSES.CITY"> **123** <webuijsf:staticText binding= **124** "#{AddressBook.staticText5}" id="staticText5" **125** text="#{currentRow.value\['ADDRESSES.CITY'\]}"/> **126** </webuijsf:tableColumn> **127** <webuijsf:tableColumn binding= **128** "#{AddressBook.stateColumn}" headerText="State" **129** id="stateColumn" sort="ADDRESSES.STATE"> **130** <webuijsf:staticText binding= **131** "#{AddressBook.staticText6}" id="staticText6" **132** text="#{currentRow.value\['ADDRESSES.STATE'\]}"/> **133** </webuijsf:tableColumn> **134** <webuijsf:tableColumn binding= **135** "#{AddressBook.zipColumn}" headerText="Zip" **136** id="zipColumn" sort="ADDRESSES.ZIP" width="106"> **137** <webuijsf:staticText binding= **138** "#{AddressBook.staticText7}" id="staticText7" **139** text="#{currentRow.value\['ADDRESSES.ZIP'\]}"/> **140** </webuijsf:tableColumn> **141** </webuijsf:tableRowGroup> **142** </webuijsf:table> **143** <webuijsf:staticText binding="#{AddressBook.searchHeader}" **144** id="searchHeader" style="font-size: 18px; left: 24px; **145** top: 420px; position: absolute" **146** text="Search the address book by last name:"/> **147 148 149 150 151 152** <webuijsf:label binding="#{AddressBook.label1}" **153** for="nameAutoComplete" id="label1" style="left: 24px; **154** top: 447px; position: absolute" text="Last name:"/> **155** <webuijsf:button binding="#{AddressBook.lookUpButton}" **156** id="lookUpButton" style="left: 288px; top: 446px; **157** position: absolute; width: 100px" text="Look Up"/> **158** </webuijsf:form> **159** </webuijsf:body> **160** </webuijsf:html> **161** </webuijsf:page> **162** </f:view> **163** </jsp:root>

**Fig. 27.12** | AddressBook JSP with an **AutoComplete Text Field** component. (Part 4 of 5.)

<bp:autoComplete binding="#{AddressBook.nameAutoComplete}" completionMethod= "#{AddressBook.nameAutoComplete\_complete}" id="nameAutoComplete" style="left: 96px; top: 444px; position: absolute"/>  

**1208** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**27.4.3 Providing Suggestions for an AutoComplete Text Field**

Figure 27.13 displays the page bean file for the JSP in Fig. 27.12. It includes the method nameAutoComplete\_complete, which provides the functionality for the **AutoComplete Text Field**. Otherwise, this page bean is identical to the one in Fig. 27.8.

**1** // Fig. 27.13: AddressBook.java **2** // Page bean for AddressBook.jsp. **3** package addressbook; **4 5** import com.sun.data.provider.RowKey; **6** import com.sun.data.provider.impl.CachedRowSetDataProvider; **7** import com.sun.j2ee.blueprints.ui.autocomplete.AutoCompleteComponent; **8** import com.sun.j2ee.blueprints.ui.autocomplete.CompletionResult; **9** import com.sun.rave.web.ui.appbase.AbstractPageBean;

**10** import com.sun.webui.jsf.component.Body; **11** import com.sun.webui.jsf.component.Button; **12** import com.sun.webui.jsf.component.Form; **13** import com.sun.webui.jsf.component.Head; **14** import com.sun.webui.jsf.component.Html; **15** import com.sun.webui.jsf.component.Label;

**Fig. 27.13** | Page bean that suggests names in the **AutoComplete Text Field**. (Part 1 of 3.)

**Fig. 27.12** | AddressBook JSP with an **AutoComplete Text Field** component. (Part 5 of 5.)  

27.4 **AutoComplete Text Field** and Virtual Forms **1209**

**16** import com.sun.webui.jsf.component.Link; **17** import com.sun.webui.jsf.component.MessageGroup; **18** import com.sun.webui.jsf.component.Page; **19** import com.sun.webui.jsf.component.StaticText; **20** import com.sun.webui.jsf.component.Table; **21** import com.sun.webui.jsf.component.TableColumn; **22** import com.sun.webui.jsf.component.TableRowGroup; **23** import com.sun.webui.jsf.component.TextField; **24** import com.sun.webui.jsf.model.DefaultTableDataProvider; **25** import javax.faces.FacesException; **26** import javax.faces.context.FacesContext; **27 28** public class AddressBook extends AbstractPageBean **29** { **30 31 32 626** // action handler for the autocomplete box that fetches names **627** // from the address book whose prefixes match the letters typed so far **628** // and displays them in a suggestion list. **629** public void nameAutoComplete\_complete( **630** FacesContext context, String prefix, CompletionResult result ) **631** { **632** try **633** { **634 635 636** while ( hasNext ) **637** { **638 639 640 641 642 643 644 645** // if the name in the database starts with the prefix, **646 647 648 649 650 651** else **652** { **653** // terminate the loop if the rest of the names are **654** // alphabetically less than the prefix **655** if ( prefix.compareTo( name ) < 0 ) **656** { **657** break; **658** } // end if **659** } // end else **660**

**Fig. 27.13** | Page bean that suggests names in the **AutoComplete Text Field**. (Part 2 of 3.)

// To save space, we omitted the code in lines 30-625. The complete // source code is provided with this chapter's examples.

boolean hasNext = addressesDataProvider.cursorFirst();

// get a name from the database String name =

(String) addressesDataProvider.getValue( "ADDRESSES.LASTNAME" ) + ", " + (String) addressesDataProvider.getValue( "ADDRESSES.FIRSTNAME" ) ;

// add it to the list of suggestions if ( name.toLowerCase().startsWith( prefix.toLowerCase() ) ) {

result.addItem( name ); } // end if  

**1210** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

Method nameAutoComplete\_complete (lines 629–669) is invoked after every key- stroke in the **AutoComplete Text Field** to update the list of suggestions based on the text the user has typed so far. The method receives a string (prefix) containing the text the user has entered and a CompletionResult object (result) that is used to display sugges- tions to the user. The method loops through the rows of the addressesDataProvider, retrieves the name from each row, checks whether the name begins with the letters typed so far and, if so, adds the name to result. Line 634 sets the cursor to the first row in the data provider. Line 636 determines whether there are more rows in the data provider. If so, lines 639–643 retrieve the last name and first name from the current row and create a String in the format _last name, first name_. Line 647 compares the lowercase versions of name and prefix to determine whether the name starts with the characters typed so far. If so, the name is a match and line 649 adds it to result.

Recall that the data provider wraps a CachedRowSet object that contains a SQL query which returns the rows in the database sorted by last name, then first name. This allows us to stop iterating through the data provider once we reach a row whose name comes alphabetically after the text entered by the user—names in the rows beyond this will all be alphabetically greater and thus are not potential matches. If the name does not match the text entered so far, line 655 tests whether the current name is alphabetically greater than the prefix. If so, line 657 terminates the loop.

**Performance Tip 27.1** _When using database columns to provide suggestions in an **AutoComplete Text Field**, sorting the columns eliminates the need to check every row in the database for potential matches. This significantly improves performance when dealing with a large database._ 27.1

If the name is neither a match nor alphabetically greater than prefix, then line 662 moves the cursor to the next row in the data provider. If there is another row, the loop iterates again, checking whether the name in the next row matches the prefix and should be added to results.

Lines 665–668 catch any exceptions generated while searching the database. Line 667 adds text to the suggestion box indicating the error to the user.

**27.5 Google Maps Map Viewer Component** We now complete the AddressBook application by adding functionality to the **Look Up Button**. When the user clicks this **Button**, the name in the **AutoComplete Text Field** is used

**661 662 663** } // end while **664** } // end try **665** catch ( Exception ex ) **666** { **667** result.addItem( "Exception getting matching names." ); **668** } // end catch **669** } // end method nameAutoComplete\_complete **670** } // end class AddressBook

**Fig. 27.13** | Page bean that suggests names in the **AutoComplete Text Field**. (Part 3 of 3.)

// move cursor to next row of database hasNext = addressesDataProvider.cursorNext();  

27.5 Google Maps **Map Viewer** Component **1211**

to search the AddressBook database. We also add a **Map Viewer** Ajax-enabled JSF compo- nent to the page to display a map of the area for the address. A **Map Viewer** uses the **Google Maps API** web service to find and display maps. (The details of web services are covered in Chapter 28.) In this example, using the Google Maps API is analogous to making or- dinary method calls on a **Map Viewer** object and its supporting bean in the page bean file. When a contact is found, we display a map of the neighborhood with a **Map Marker** that points to the location and indicates the contact’s name and address.

**27.5.1 Obtaining a Google Maps API Key** To use the **Map Viewer** component, you must have an account with Google. Visit the site https://www.google.com/accounts/ManageAccount to register for a free account if you do not have one. Once you have logged in to your account, you must obtain a key to use the Google Maps API from www.google.com/apis/maps. The key you receive will be spe- cific to this web application and will limit the number of maps the application can display per day. When you sign up for the key, you will be asked to enter the URL for the appli- cation that will be using the Google Maps API. If you are deploying the application only on Sun Java System Application Server, enter http://localhost:8080/ as the URL.

After you accept Google’s terms and conditions, you’ll be redirected to a page con- taining your new Google Maps API key. Save this key in a text file in a convenient location for future reference.

**27.5.2 Adding a Map Viewer Component to a Page** Now that you have a key to use the Google Maps API, you are ready to complete the Ad-

dressBook application. With AddressBook.jsp open in **Design** mode, add a **Map Viewer** component named mapViewer below the nameAutoComplete. In the **Properties** window, set the **Map Viewer**’s key property to the key you obtained for accessing the Google Maps API. Set the rendered property to false so that the map will not be displayed when the user has not yet searched for an address. Set the zoomLevel property to 1 (In) so the user can see the street names on the map.

Drop a **Map Marker** (named mapMarker) from the **BluePrints AJAX Support Beans** sec- tion of the **Palette** anywhere on the page. This component (which is not visible in **Design** view) marks the contact’s location on the map. You must bind the marker to the map so that the marker will display on the map. To do so, right click the **Map Viewer** in the **Outline** tab and choose **Property Bindings…** to display the **Property Bindings** dialog. Select info from the **Select bindable property** column of the dialog, then select mapMarker from the **Select binding target** column. Click **Apply**, then **Close**.

Finally, drop a **Geocoding Service Object** (named geoCoder) from the **BluePrints AJAX Support Beans** section of the **Palette** anywhere on the page. This object (which is not visible in **Design** view) converts street addresses into latitudes and longitudes that the **Map Viewer** component uses to display an appropriate map.

**_Adding a Data Provider to the Page_** To complete this application, you need a second data provider to search the AddressBook database based on the first and last name entered in the **AutoComplete Text Field**. We want to create a new data source rather than reuse the existing one, because the query to search for contacts is different from the query to display all the contacts. On the **Runtime** tab, ex-  

**1212** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

pand the **Databases** node, the **AddressBook** database’s node and its **Tables** node to reveal the **Addresses** table. Drag the **Addresses** table onto the page to create the new data pro- vider. Select the new data provider in the **Navigator** tab and change its id to addresses-

SearchDataProvider. In the **Outline** tab, a new node named addressesRowSet1 has been added to the SessionBean1 node. Change the id of addressesRowSet1 to addresses-

SearchRowSet. Double click the addressesSearchRowSet node to edit the SQL statement for this

RowSet. Since we will use this row set to search the database for a given last and first name, we need to add search parameters to the SELECT statement the RowSet will execute. To do this, enter the text "= ?" in the **Criteria** column of both the first and last name rows in the SQL statement editor table. The number 1 should appear in the **Order** column for first name and 2 should appear for last name. Notice that the lines

WHERE JHTP7.ADDRESSES.FIRSTNAME = ? AND JHTP7.ADDRESSES.LASTNAME = ?

have been added to the SQL statement. This indicates that the RowSet now executes a pa- rameterized SQL statement. The parameters can be set programmatically, with the first name as the first parameter and the last name as the second.

**27.5.3 JSP File with a Map Viewer Component** Figure 27.14 presents the JSP file for the completed address-book application. It is nearly identical to the JSP for the previous two versions of this application. The new feature is the **Map Viewer** component (and its supporting components) used to display a map with the contact’s location. We discuss only the new elements of this file. \[_Note:_ This code will not run until you have specified your own Google Maps key in lines 165–166. You can paste your key into the **Map Viewer** component’s key property in the **Properties** window.\]

Lines 162–168 define the mapViewer component that displays a map of the area sur- rounding the address. The component’s center attribute is bound to the page bean prop- erty mapViewer\_center. This property is manipulated in the page bean file to center the map on the desired address.

**1** <?xml version="1.0" encoding="UTF-8"?> **2** <!-- Fig. 27.14: AddressBook.jsp --> **3** <!-- AddressBook JSP with an add form and a Table JSF component. --> **4 5** <jsp:root version="1.2" **6** xmlns:bp="http://java.sun.com/blueprints/ui/14" **7** xmlns:f="http://java.sun.com/jsf/core" **8** xmlns:h="http://java.sun.com/jsf/html" **9** xmlns:jsp="http://java.sun.com/JSP/Page"

**10** xmlns:webuijsf="http://www.sun.com/webui/webuijsf"> **11** <jsp:directive.page contentType="text/html;charset=UTF-8" **12** pageEncoding="UTF-8"/> **13** <f:view> **14** <webuijsf:page binding="#{AddressBook.page1}" id="page1"> **15** <webuijsf:html binding="#{AddressBook.html1}" id="html1">

**Fig. 27.14** | AddressBook JSP with a **Map Viewer** component. (Part 1 of 5.)  

27.5 Google Maps **Map Viewer** Component **1213**

**16** <webuijsf:head binding="#{AddressBook.head1}" id="head1"> **17** <webuijsf:link binding="#{AddressBook.link1}" id="link1" **18** url="/resources/stylesheet.css"/> **19** </webuijsf:head> **20** <webuijsf:body binding="#{AddressBook.body1}" id="body1" **21** style="-rave-layout: grid"> **22** <webuijsf:form binding="#{AddressBook.form1}" id="form1" **23** virtualFormsConfig="addForm | zipTextField lnameTextField **24** fnameTextField streetTextField cityTextField stateTextField **25** | submitButton , searchForm | nameAutoComplete | **26** lookUpButton"> **27** <webuijsf:staticText binding= **28** "#{AddressBook.staticText1}" id="staticText1" style= **29** "font-size: 18px; left: 24px; top: 24px; position: **30** absolute" text="Add a contact to the address book:"/> **31** <webuijsf:label binding="#{AddressBook.fnameLabel}" **32** for="fnameTextField" id="fnameLabel" style="position: **33** absolute; left: 24px; top: 72px" text="First name:"/> **34** <webuijsf:textField binding="#{AddressBook.fnameTextField}" **35** id="fnameTextField" maxLength="30" required="true" **36** style="left: 100px; top: 72px; position: absolute; **37** width: 192px"/> **38** <webuijsf:label binding="#{AddressBook.lnameLabel}" **39** for="lnameTextField" id="lnameLabel" style="left: 312px; **40** top: 72px; position: absolute" text="Last name:"/> **41** <webuijsf:textField binding="#{AddressBook.lnameTextField}" **42** id="lnameTextField" maxLength="30" required="true" **43** style="left: 390px; top: 72px; position: absolute; **44** width: 214px"/> **45** <webuijsf:label binding="#{AddressBook.streetLabel}" **46** for="streetTextField" id="streetLabel" style="position: **47** absolute; left: 24px; top: 96px" text="Street:"/> **48** <webuijsf:textField binding= **49** "#{AddressBook.streetTextField}" id="streetTextField" **50** maxLength="150" required="true" style="left: 100px; **51** top: 96px; position: absolute; width: 504px"/> **52** <webuijsf:label binding="#{AddressBook.cityLabel}" **53** for="cityTextField" id="cityLabel" style="left: 24px; **54** top: 120px; position: absolute" text="City:"/> **55** <webuijsf:textField binding="#{AddressBook.cityTextField}" **56** id="cityTextField" maxLength="30" required="true" **57** style="left: 100px; top: 120px; position: absolute; **58** width: 240px"/> **59** <webuijsf:label binding="#{AddressBook.stateLabel}" **60** for="stateTextField" id="stateLabel" **61** style="left: 360px; top: 120px; position: absolute" **62** text="State:"/> **63** <webuijsf:textField binding="#{AddressBook.stateTextField}" **64** id="stateTextField" maxLength="2" required="true" **65** style="left: 412px; top: 120px; position: absolute; **66** width: 48px"/> **67** <webuijsf:label binding="#{AddressBook.zipLabel}" **68** for="zipTextField" id="zipLabel" style="left: 490px;

**Fig. 27.14** | AddressBook JSP with a **Map Viewer** component. (Part 2 of 5.)  

**1214** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**69** top: 120px; position: absolute" text="Zip:"/> **70** <webuijsf:textField binding="#{AddressBook.zipTextField}" **71** id="zipTextField" maxLength="5" required="true" **72** style="left: 534px; top: 120px; position: absolute; **73** width: 70px"/> **74** <webuijsf:button actionExpression= **75** "#{AddressBook.submitButton\_action}" binding= **76** "#{AddressBook.submitButton}" id="submitButton" **77** primary="true" style="left: 100px; top: 168px; position: **78** absolute; width: 100px" text="Submit"/> **79** <webuijsf:button binding="#{AddressBook.clearButton}" **80** id="clearButton" reset="true" style="left: 215px; top: **81** 168px; position: absolute; width: 100px" text="Clear"/> **82** <webuijsf:messageGroup binding= **83** "#{AddressBook.messageGroup1}" id="messageGroup1" **84** showGlobalOnly="true" style="left: 624px; top: 72px; **85** position: absolute"/> **86** <webuijsf:table augmentTitle="false" binding= **87** "#{AddressBook.addressesTable}" id="addressesTable" **88** paginateButton="true" paginationControls="true" **89** style="left: 24px; top: 216px; position: absolute" **90** title="Contacts" width="816"> **91** <webuijsf:tableRowGroup binding= **92** "#{AddressBook.tableRowGroup1}" id="tableRowGroup1" **93** rows="5" sourceData= **94** "#{AddressBook.addressesDataProvider}" **95** sourceVar="currentRow"> **96** <webuijsf:tableColumn binding= **97** "#{AddressBook.fnameColumn}" **98** headerText="First Name" id="fnameColumn" **99** sort="ADDRESSES.FIRSTNAME"> **100** <webuijsf:staticText binding= **101** "#{AddressBook.staticText2}" id="staticText2" **102** text="#{currentRow.value\[ **103** 'ADDRESSES.FIRSTNAME'\]}"/> **104** </webuijsf:tableColumn> **105** <webuijsf:tableColumn binding= **106** "#{AddressBook.lnameColumn}" **107** headerText="Last Name" id="lnameColumn" **108** sort="ADDRESSES.LASTNAME"> **109** <webuijsf:staticText binding= **110** "#{AddressBook.staticText3}" id="staticText3" **111** text="#{currentRow.value\[ **112** 'ADDRESSES.LASTNAME'\]}"/> **113** </webuijsf:tableColumn> **114** <webuijsf:tableColumn binding= **115** "#{AddressBook.streetColumn}" headerText="Street" **116** id="streetColumn" sort="ADDRESSES.STREET"> **117** <webuijsf:staticText binding= **118** "#{AddressBook.staticText4}" id="staticText4" **119** text="#{currentRow.value\[ **120** 'ADDRESSES.STREET'\]}"/> **121** </webuijsf:tableColumn>

**Fig. 27.14** | AddressBook JSP with a **Map Viewer** component. (Part 3 of 5.)  

27.5 Google Maps **Map Viewer** Component **1215**

**122** <webuijsf:tableColumn binding= **123** "#{AddressBook.cityColumn}" headerText="City" **124** id="cityColumn" sort="ADDRESSES.CITY"> **125** <webuijsf:staticText binding= **126** "#{AddressBook.staticText5}" id="staticText5" **127** text="#{currentRow.value\['ADDRESSES.CITY'\]}"/> **128** </webuijsf:tableColumn> **129** <webuijsf:tableColumn binding= **130** "#{AddressBook.stateColumn}" headerText="State" **131** id="stateColumn" sort="ADDRESSES.STATE"> **132** <webuijsf:staticText binding= **133** "#{AddressBook.staticText6}" id="staticText6" **134** text="#{currentRow.value\['ADDRESSES.STATE'\]}"/> **135** </webuijsf:tableColumn> **136** <webuijsf:tableColumn binding= **137** "#{AddressBook.zipColumn}" headerText="Zip" **138** id="zipColumn" sort="ADDRESSES.ZIP" width="106"> **139** <webuijsf:staticText binding= **140** "#{AddressBook.staticText7}" id="staticText7" **141** text="#{currentRow.value\['ADDRESSES.ZIP'\]}"/> **142** </webuijsf:tableColumn> **143** </webuijsf:tableRowGroup> **144** </webuijsf:table> **145** <webuijsf:staticText binding="#{AddressBook.searchHeader}" **146** id="searchHeader" style="font-size: 18px; left: 24px; **147** top: 420px; position: absolute" **148** text="Search the address book by last name:"/> **149** <bp:autoComplete binding= **150** "#{AddressBook.nameAutoComplete}" completionMethod= **151** "#{AddressBook.nameAutoComplete\_complete}" **152** id="nameAutoComplete" **153** style="left: 96px; top: 444px; position: absolute"/> **154** <webuijsf:label binding="#{AddressBook.label1}" **155** for="nameAutoComplete" id="label1" style="left: 24px; **156** top: 447px; position: absolute" text="Last name:"/> **157** <webuijsf:button actionExpression= **158** "#{AddressBook.lookUpButton\_action}" **159** binding="#{AddressBook.lookUpButton}" id="lookUpButton" **160** style="left: 288px; top: 446px; position: absolute; **161** width: 100px" text="Look Up"/> **162 163 164 165** key="XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX **166** XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" **167** style="height: 550px; left: 24px; top: 480px; **168** position: absolute; width: 814px" zoomLevel="4"/> **169** </webuijsf:form> **170** </webuijsf:body> **171** </webuijsf:html> **172** </webuijsf:page> **173** </f:view> **174** </jsp:root>

**Fig. 27.14** | AddressBook JSP with a **Map Viewer** component. (Part 4 of 5.)

<bp:mapViewer binding="#{AddressBook.mapViewer}" center="#{AddressBook.mapViewer\_center}" id="mapViewer" info="#{AddressBook.mapMarker}"  

**1216** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

The **Look Up** Button’s action attribute is now bound to method lookUpButton\_action

in the page bean (lines 157–158). This action handler searches the AddressBook database for the name entered in the **AutoComplete Text Field** and displays the contact’s name and address on a map of the contact’s location. We discuss this method in Section 27.5.4.

**27.5.4 Page Bean That Displays a Map in the Map Viewer Component** Figure 27.15 presents the page bean for the completed AddressBook application. Most of this file is identical to the page beans for the first two versions of this application. We dis- cuss only the new action-handler method, lookUpButton\_action.

**1** // Fig. 27.15: AddressBook.java **2** // Page bean for AddressBook.jsp. **3** package addressbook; **4 5** import com.sun.data.provider.RowKey; **6** import com.sun.data.provider.impl.CachedRowSetDataProvider;

**Fig. 27.15** | Page bean that gets a map to display in the **Map Viewer** component. (Part 1 of 3.)

**Fig. 27.14** | AddressBook JSP with a **Map Viewer** component. (Part 5 of 5.)  

27.5 Google Maps **Map Viewer** Component **1217**

**7** import com.sun.j2ee.blueprints.ui.autocomplete.AutoCompleteComponent; **8** import com.sun.j2ee.blueprints.ui.autocomplete.CompletionResult; **9** import com.sun.j2ee.blueprints.ui.geocoder.GeoCoder;

**10** import com.sun.j2ee.blueprints.ui.geocoder.GeoPoint; **11** import com.sun.j2ee.blueprints.ui.mapviewer.MapComponent; **12** import com.sun.j2ee.blueprints.ui.mapviewer.MapMarker; **13** import com.sun.j2ee.blueprints.ui.mapviewer.MapPoint; **14** import com.sun.rave.web.ui.appbase.AbstractPageBean; **15** import com.sun.webui.jsf.component.Body; **16** import com.sun.webui.jsf.component.Button; **17** import com.sun.webui.jsf.component.Form; **18** import com.sun.webui.jsf.component.Head; **19** import com.sun.webui.jsf.component.Html; **20** import com.sun.webui.jsf.component.Label; **21** import com.sun.webui.jsf.component.Link; **22** import com.sun.webui.jsf.component.MessageGroup; **23** import com.sun.webui.jsf.component.Page; **24** import com.sun.webui.jsf.component.StaticText; **25** import com.sun.webui.jsf.component.Table; **26** import com.sun.webui.jsf.component.TableColumn; **27** import com.sun.webui.jsf.component.TableRowGroup; **28** import com.sun.webui.jsf.component.TextField; **29** import javax.faces.FacesException; **30** import javax.faces.context.FacesContext; **31 32** public class AddressBook extends AbstractPageBean **33** { **34** private int \_\_placeholder; **35 36** private void \_init() throws Exception **37** { **38** addressesDataProvider.setCachedRowSet( **39** ( javax.sql.rowset.CachedRowSet ) getValue( **40** "#{SessionBean1.addressesRowSet}" ) ); **41** addressesTable.setInternalVirtualForm( true ); **42 43 44 45 46** } // end method \_init **47 48 49 50 742** // action handler for the lookUpButton that searches the address book **743** // database and displays the requested address on a corresponding map. **744** public String lookUpButton\_action() **745** { **746** // split text in autocomplete field into first and last name **747** String name = String.valueOf( nameAutoComplete.getValue() ); **748** int splitIndex = name.indexOf( "," ); **749** String lname = name.substring( 0, splitIndex ); **750** String fname = name.substring( splitIndex + 2 );

**Fig. 27.15** | Page bean that gets a map to display in the **Map Viewer** component. (Part 2 of 3.)

mapViewer.setRendered( false ); addressesSearchDataProvider.setCachedRowSet(

( javax.sql.rowset.CachedRowSet ) getValue( "#{SessionBean1.addressesSearchRowSet}" ) );

// To save space, we omitted the code in lines 48-741. The complete // source code is provided with this chapter's examples.  

**1218** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**751 752** try **753** { **754** // set the parameters for the addressesSearchDataProvider **755 756 757 758 759 760** String street = (String) addressesSearchDataProvider.getValue( **761** "ADDRESSES.STREET" ); **762** String city = (String) addressesSearchDataProvider.getValue( **763** "ADDRESSES.CITY" ); **764** String state = (String) addressesSearchDataProvider.getValue( **765** "ADDRESSES.STATE" ); **766** String zip = (String) addressesSearchDataProvider.getValue( **767** "ADDRESSES.ZIP" ); **768 769** // format the address for Google Maps **770** String googleAddress = street + ", " + city + ", " + state + **771** " " + zip; **772 773** // get the geopoints for the address **774 775 776** // if Google Maps cannot find the address **777** if ( points == null ) **778** { **779** error( "Map for " + googleAddress + " could not be found" ); **780 781** return null; **782** } // end if **783 784** // center the map for the given address **785 786 787 788** // create a marker for the address and set its display text **789 790 791 792 793 794 795** } // end try **796** catch ( Exception e ) **797** { **798** error( "Error processing search. " + e.getMessage() ); **799** } // end catch **800 801** return null; **802** } // end method lookUpButton\_action **803** } // end class AddressBook

**Fig. 27.15** | Page bean that gets a map to display in the **Map Viewer** component. (Part 3 of 3.)

addressesSearchDataProvider.getCachedRowSet().setObject( 1, fname );

addressesSearchDataProvider.getCachedRowSet().setObject( 2, lname );

addressesSearchDataProvider.refresh();

GeoPoint points\[\] = geoCoder.geoCode( googleAddress );

mapViewer.setRendered( false ); // hide map

mapViewer\_center.setLatitude( points\[0\].getLatitude() ); mapViewer\_center.setLongitude( points\[0\].getLongitude() );

mapMarker.setLatitude( points\[0\].getLatitude() ); mapMarker.setLongitude( points\[0\].getLongitude() ); mapMarker.setMarkup( fname + " " + lname + "<br/>" + street +

"<br/>" + city + ", " + state + " " + zip );

mapViewer.setRendered( true ); // show map  

27.6 Wrap-Up **1219**

Method lookUpButton\_action (lines 744–802) is invoked when the user clicks the **Look Up** button in the lower form on the page. Lines 747–750 retrieve the name from the **AutoComplete Text Field** and split it into Strings for the first and last name. Lines 755– 758 obtain the addressesSearchDataProvider’s CachedRowSet, then use its method setObject to set the parameters for the query to the first and last name. The setObject

method replaces a parameter in the SQL query with a specified string. Line 759 refreshes the data provider, which executes the wrapped RowSet’s query with the new parameters. The result set now contains only rows that match the first and last name from the **Auto- Complete Text Field**. Lines 760–767 fetch the street address, city, state and zip code for this contact from the database. Note that in this example, we assume there are not multiple entries in the address book for the same first and last name, as we fetch only the address information for the first row in the data provider. Any additional rows that match the first and last name are ignored.

Lines 770–771 format the address as a String for use with the Google Maps API. Line 774 calls the **Geocoding Service Object**’s geoCode method with the address as an argu- ment. This method returns an array of GeoPoint objects representing locations that match the address parameter. GeoPoint objects provide the latitude and longitude of a given loca- tion. We supply a complete address with a street, city, state and zip code as an argument to geoCode, so the returned array will contain just one GeoPoint object. Line 777 deter- mines whether the array of GeoPoint objects is null. If so, the address could not be found, and lines 779–781 display a message in the **Message Group** informing the user of the search error, hide the **Map Viewer** and return null to terminate the processing.

Lines 785–786 set the latitude and longitude of the **Map Viewer**’s center to those of the GeoPoint that represents the selected address. Lines 789–792 set the **Map Marker**’s lat- itude and longitude, and set the text to display on the marker. Line 794 displays the recen- tered map containing the **Map Marker** that indicates the contact’s location.

Lines 796–799 catch any exceptions generated throughout the method body and dis- play an error message in the **Message Group**. If the user has simply selected a name from the list of selections in the **AutoComplete Text Field**, there will be no errors in searching the database, as the name is guaranteed to be in the proper _last name, first name_ format and included in the AddressBook database. We did not include any special error-handling code for cases in which the user types a name that cannot be found in the AddressBook or for improperly formatted names.

**27.6 Wrap-Up** In this chapter, we presented a three-part case study on building a web application that interacts with a database and provides rich user interaction using Ajax-enabled JSF com- ponents. We first showed how to build an AddressBook application that allows a user to add addresses to the AddressBook and browse its contents. Through this example, you learned how to insert user input into a Java DB database and how to display the contents of a database on a web page using a **Table** JSF component.

You learned how to download and import the Java BluePrints Ajax-enabled compo- nent library. We then extended the AddressBook application to include an **AutoComplete Text Field** component. We showed how to use a database to display suggestions in the **AutoComplete Text Field**. You also learned how to use virtual forms to submit subsets of a form’s input components to the server for processing.  

**1220** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

Finally, we completed the third part of the AddressBook application by adding func- tionality to the search form. You learned how to use a **Map Viewer**, a **Map Marker** and a **Geocoding Service Object** from the Java BluePrints Ajax-enabled component library to display a Google map that shows a contact’s location.

**27.7 Web Resources** Our Java Resource Centers focus on the enormous amount of free Java content available online. We currently provide six Java-related Resource Centers:

www.deitel.com/java/ www.deitel.com/JavaCertification/ www.deitel.com/JavaDesignPatterns/ www.deitel.com/JavaEE5/ www.deitel.com/JavaFX/ www.deitel.com/JavaSE6Mustang/

You can view our complete list of Resource Centers at

www.deitel.com/ResourceCenters.html

**Summary _Section 27.2 Accessing Databases in Web Applications_** • Many web applications access databases to store and retrieve persistent data. In this section, we

build a web application that uses a Java DB database to store contacts in the address book and display contacts from the address book on a web page.

• The **Table** component formats and displays data from database tables.

• Change the **Table**’s title property to specify the text displayed at the top of the **Table**.

• To create a database, select **Tools > Java DB Database > Create Java DB Database…**. Next, enter the name of the database to create a username and a password, then click **OK** to create the data- base.

• You can use the **Runtime** tab (to the right of the **Projects** and **Files** tabs) to create tables and to execute SQL statements that populate the database with data. To do so, click the **Runtime** tab and expand the **Databases** node.

• Netbeans must be connected to the database to execute SQL statements. If it is not, the icon appears next to the database’s URL. In this case, right click the icon and click **Connect…**. Once connected, the icon changes to .

• To add a table to the database using SQL, expand the database’s node, right click the **Tables** node and select **Execute Command…** to open a **SQL Command** editor in Netbeans. Paste the SQL code into the **SQL Command** editor in Netbeans. Then, highlight all the SQL commands, right click inside the **SQL Command** editor and select **Run Selection**.

• To configure a **Table** component to display a table’s data, simply drag the database table from the **Servers** tab and drop it on the **Table** component to create the binding.

• To select specific columns to display, right click the **Table** component and select **Bind to Data** to display the **Bind to Data** dialog containing the list of the columns in the database table. The items under the **Selected** heading will be displayed in the **Table**. To remove a column, select it and click the **<** button.  

Summary **1221**

• By default, the **Table** uses the database table’s column names in all uppercase letters as headings. To change these headings, select a column and edit its headerText property in the **Properties** win- dow. To select a column, click the column’s name in the **Design** mode.

• Clicking the checkbox next to the table’s paginationControls property in the **Properties** window configures this **Table** for automatic pagination. This adds buttons to the bottom of the **Table** for moving forward and backward between groups of contacts. You may use the **Table Layout** dialog’s **Options** tab to select the number of rows to display at a time. To view this tab, right click the **Table**, select **Table Layout…**, then click the **Options** tab.

• Virtual forms allow subsets of a form’s input components to be submitted to the server. Setting the internalVirtualForm property prevents the pagination control buttons on the **Table** from submitting other form components every time the user wishes to view the next group of records from the database.

• A CachedRowSetDataProvider provides a scrollable RowSet that can be bound to a **Table** compo- nent to display the RowSet’s data.

• Every row in a CachedRowSetDataProvider has its own key; method appendRow, which adds a new row to the CachedRowSet, returns the key for the new row.

• Method commitChanges of class CachedRowSetDataProvider applies any changes to the Cached-

RowSet to the database.

• CachedRowSetDataProvider method refresh re-executes the wrapped CachedRowSet’s SQL.

**_Section 27.3 Ajax-Enabled JSF Components_** • The Java BluePrints Ajax component library provides Ajax-enabled JSF components.

• To use the Java BluePrints Ajax-enabled components in Netbeans, you must download and im- port them. The IDE provides a wizard for installing this group of components (Internet access is required). To access it, choose **Tools > Update Center** to display the **Update Center Wizard** dialog. Click **Next >** to search for available updates. In the **Available Updates and New Modules** area of the dialog, locate and select **BluePrints AJAX Components**, then click the **Add >** button to add them to the list of items you’d like to install. Click **Next >** and follow the prompts to accept the terms of use and download the components. When the download completes, click **Next >**, then click **Finish**. Click **OK** to restart the IDE.

• You must import the components into the **Palette**. Select **Tools > Component Library Manager**, then click **Import…**. Click **Browse…** in the **Component Library Manager** dialog that appears. Select the ui.complib file and click **Open**. Click **OK** to import both the **BluePrints AJAX Components** and the **BluePrints AJAX Support Beans**. Close the **Component Library Manager** to return to the IDE.

• To see the new components in the **Palette**, you must add the **BluePrints AJAX Components** library to your visual web application. To do so, make sure your application’s node is expanded in the **Projects** tab. Right click the **Component Libraries** node and select **Add Component Library**. In the **Add Component Library** dialog box, select the **BluePrints AJAX Components library** and click **Add Component Library**.

**_Section 27.4 AutoComplete Text Field and Virtual Forms_** • The **AutoComplete Text Field** provides a list of suggestions from a data source (such as a database

or web service) as the user types.

• Virtual forms are used when you would like a button to submit a subset of the page’s input fields to the server.

• Virtual forms enable you to display multiple forms on the same page. They allow you to specify a submitter and one or more participants for each form. When the virtual form’s submitter com- ponent is clicked, only the values of its participant components will be submitted to the server.  

**1222** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

• To add virtual forms to a page, right click the submitter component on the form and choose **Con- figure Virtual Forms…** from the pop-up menu to display the **Configure Virtual Forms** dialog. Click **New** to add a virtual form, then click in the **Name** column and specify the new form’s name. Dou- ble click the **Submit** column and change the option to **Yes** to indicate that this button should be used to submit the virtual form. Click **OK** to exit the dialog. Next, select all the input components that will participate in the virtual form. Right click one of the selected components and choose **Configure Virtual Forms…**. In the **Participate** column of the appropriate virtual form, change the option to **Yes** to indicate that the values in these components should be submitted to the server when the form is submitted.

• To see the virtual forms in the **Design** mode, click the **Show Virtual Forms** button ( ) at the top of the Visual Designer panel to display a legend of the virtual forms on the page.

• An **AutoComplete Text Field** component’s completionMethod attribute is bound to a page bean’s complete event handler. To create this method, right click the **AutoComplete Text Field** compo- nent in **Design** view and select **Edit Event Handler > complete**.

• The complete event handler is invoked after every keystroke in an **AutoComplete Text Field** to up- date the list of suggestions based on the text the user has typed so far. The method receives a string containing the text the user has entered and a CompletionResult object that is used to dis- play suggestions to the user.

**_Section 27.5 Google Maps Map Viewer Component_** • A **Map Viewer** Ajax-enabled JSF component uses the Google Maps API web service to find and

display maps. A **Map Marker** points to a location on a map.

• To use the **Map Viewer** component, you must have an account with Google. Register for a free account at https://www.google.com/accounts/ManageAccount. You must obtain a key to use the Google Maps API from www.google.com/apis/maps. The key you receive will be specific to your web application and will limit the number of maps the application can display per day. When you sign up for the key, you will be asked to enter the URL for the application that will be using the Google Maps API.

• To use a **Map Viewer**, set its key property to the Google Maps API key you obtained.

• A **Map Marker** (from the **BluePrints AJAX Support Beans** section of the **Palette**) marks a location on a map. You must bind the marker to the map so that the marker will display on the map. To do so, right click the **Map Viewer** in **Design** mode component and choose **Property Bindings…** to display the **Property Bindings** dialog. Select info from the **Select bindable property** column of the dialog, then select the **Map Marker** from the **Select binding target** column. Click **Apply**, then **Close**.

• A **Geocoding Service Object** (from the **BluePrints AJAX Support Beans** section of the **Palette**) con- verts street addresses into latitudes and longitudes that the **Map Viewer** component uses to display an appropriate map.

• The **Map Viewer**’s center attribute is bound to the page bean property mapViewer\_center. This property is manipulated in the page bean file to center the map on the desired address.

• The **Geocoding Service Object**’s geoCode method receives an address as an argument and returns an array of GeoPoint objects representing locations that match the address parameter. GeoPoint objects provide the latitude and longitude of a given location.

**Terminology** Ajax Ajax-enabled JSF components **AutoComplete Text Field** JSF component binding a JSF **Table** to a database table

bundled database server **Button** JSF component **Buy Now Button** JSF component CachedRowSet interface  

Self-Review Exercises **1223**

CachedRowSetDataProvider class commitChanges method of classCachedRowSet-

DataProvider

data provider event-processing life cycle **Geocoding Service Object** geoCode method of a **Geocoding Service Object** Google Maps Google Maps API Java BluePrints Java BluePrints Ajax component library Java DB JavaServer Faces (JSF) JSF element **Map Marker** JSF component **Map Viewer** JSF component **Message Group** JSF component

participant component in a virtual form **Popup Calendar** JSF component primary property of a JSF **Button Progress Bar** JSF component **Rating** JSF component refresh method of

classCachedRowSetDataProvider

reset property of a JSF **Button Rich Textarea Editor** JSF component **Select Value Text Field** JSF component submitter component in a virtual form **Table** JSF component virtual form webuijsf:staticText JSF element webuijsf:table JSF element webuijsf:tableRowGroup JSF element

**Self-Review Exercises 27.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) The **Table** JSF component allows you to lay out other components and text in tabular format.

b) Virtual forms allow multiple forms, each with its own submitter component and par- ticipant components, to be displayed on the same web page.

c) A CachedRowSetDataProvider is stored in the SessionBean and executes SQL queries to provide Table components with data to display.

d) The complete event handler for an **AutoComplete Text Field** is called after every key- stroke in the text field to provide a list of suggestions based on what has already been typed.

e) A data provider automatically re-executes its SQL command to provide updated data- base information at every page refresh.

f) To recenter a **Map Viewer** component, you must set the longitude and latitude of the map’s center.

**27.2** Fill in the blanks in each of the following statements. a) Method of class updates a database to reflect any changes made

in the database’s data provider. b) A(n) is a supporting component used to translate addresses into latitudes and

longitudes for display in a **Map Viewer** component. c) A virtual form specifies that certain JSF components are whose data will be

submitted when the submitter component is clicked. d) Ajax components for JSF such as the **AutoComplete Text Field** and **Map Viewer** are pro-

vided by the .

**Answers to Self-Review Exercises 27.1** a) False. Table components are used to display data from databases. b) True. c) False. The CachedRowSetDataProvider is a property of the page bean. It wraps a CachedRowSet, which is stored in the SessionBean and executes SQL queries. d) True. e) False. You must call method refresh on the data provider to re-execute the SQL command. f) True.  

**1224** Chapter 27 Ajax-Enabled JavaServer™ Faces Web Applications

**27.2** a) commitChanges, CachedRowSetDataProvider. b) **Geocoding Service Object**. c) partici- pants. d) Java BluePrints Ajax component library.

**Exercises 27.3** _(Guestbook Application)_ Create a JSF web page that allows users to sign and view a guest- book. Use the Guestbook database (provided in the examples directory for this chapter) to store guestbook entries. The Guestbook database has a single table, Messages, which has four columns: date, name, email and message. The database already contains a few sample entries. On the web page, provide **Text Field**s for the user’s name and e-mail address and a **Text Area** for the message. Add a **Submit Button** and a **Table** component and configure the **Table** to display guestbook entries. Use the **Submit Button**’s action-handler method to insert a new row containing the user’s input and to- day’s date into the Guestbook database.

**27.4** _(AddressBook Application Modification)_ Modify the AddressBook application so that users enter searches in the **AutoComplete Text Field** in the format _first name last name_. You will need to add a new data provider (or modify the existing one) to sort the rows in the AddressBook database by first name, then last name.

**27.5** _(Map Search Application)_ Create a JSF web page that allows users to obtain a map of any address. Recall that a search for a location using the Google Maps API returns an array of GeoPoint objects. Search for locations a user enters in a **Text Field** and display a map of the first location in the resulting GeoPoint array. To handle multiple search results, display all results in a **Listbox** compo- nent. You can obtain a string representation of each result by invoking method toString on a GeoPoint object. Add a **Button** that allows users to select a result from the **Listbox** and displays a map for that result with a **Map Marker** showing the location on the map. Finally, use a **Message Group** to display messages regarding search errors. In case of an error, and when the page loads for the first time, recenter the map on a default location of your choosing.  

28 Web Services

**O B J E C T I V E S** In this chapter you will learn:

■ What a web service is.

■ How to publish and consume Java web services in Netbeans.

■ The elements that comprise web services, such as service descriptions and classes that implement web services.

■ How to create client desktop and web applications that invoke web service methods.

■ The important part that XML and the Simple Object Access Protocol (SOAP) play in enabling web services.

■ How to use session tracking in web services to maintain client state information.

■ How to connect to databases from web services.

■ How to pass objects of user-defined types to and return them from a web service.

■ How to build a REST-based web service in ASP.NET.

**_A client is to me a mere unit, a factor in a problem._ —Sir Arthur Conan Doyle**

**_They also serve who only stand and wait._ —John Milton**

**_...if the simplest things of nature have a message that you understand, rejoice, for your soul is alive._ —Eleonora Duse**

**_Protocol is everything_ —Francoise Giuliani**  

**1226** Chapter 28 Web Services **O**

**u tl**

**in e**

**28.1 Introduction** This chapter introduces web services, which promote software portability and reusability in applications that operate over the Internet. A **web service** is a software component stored on one computer that can be accessed via method calls by an application (or other software component) on another computer over a network. Web services communicate using such technologies as XML and HTTP. Several Java APIs facilitate web services. In this chapter, we’ll be dealing with Java APIs that are based on the **Simple Object Access Protocol (SOAP)**—an XML-based protocol that allows web services and clients to com- municate, even if the client and the web service are written in different languages. There are other web services technologies, such as Representational State Transfer (REST), which we cover in the contect of ASP.NET web services in Section 28.9. For information on web services, see the web resources in Section 28.11 and visit our Web Services Re- source Center at www.deitel.com/WebServices.The Web Services Resource Center in-

**28.1** Introduction **28.2** Java Web Services Basics **28.3** Creating, Publishing, Testing and Describing a Web Service

**28.3.1** Creating a Web Application Project and Adding a Web Service Class in Netbeans

**28.3.2** Defining the HugeInteger Web Service in Netbeans **28.3.3** Publishing the HugeInteger Web Service from Netbeans **28.3.4** Testing the HugeInteger Web Service with Sun Java System Application

Server’s Tester Web Page **28.3.5** Describing a Web Service with the Web Service Description Language

(WSDL) **28.4** Consuming a Web Service

**28.4.1** Creating a Client in Netbeans to Consume the HugeInteger Web Service **28.4.2** Consuming the HugeInteger Web Service

**28.5** SOAP **28.6** Session Tracking in Web Services

**28.6.1** Creating a Blackjack Web Service **28.6.2** Consuming the Blackjack Web Service

**28.7** Consuming a Database-Driven Web Service from a Web Application **28.7.1** Configuring Java DB in Netbeans and Creating the Reservation Database **28.7.2** Creating a Web Application to Interact with the Reservation Web Service

**28.8** Passing an Object of a User-Defined Type to a Web Service **28.9** REST-Based Web Services in ASP.NET

**28.9.1** REST-Based Web Service Functionality **28.9.2** Creating an ASP.NET REST-Based Web Service **28.9.3** Adding Data Components to a Web Service

**28.10** Wrap-Up **28.11** Web Resources

Summary | Terminology | Self-Review Exercises | Answers to Self-Review Exercises | Exercises  

28.1 Introduction **1227**

cludes information on designing and implementing web services in many languages, and information about web services offered by companies such as Google, Amazon and eBay. You’ll also find many additional tools for publishing and consuming web services. \[_Note:_ This chapter assumes that you know Java for Sections 28.2–28.8. To learn more about Ja- va, check out _Java How to Program, Seventh Edition_, or visit our Java Resource Centers at www.deitel.com/ResourceCenters.html. For Section 28.9, the chapter assumes you know Visual Basic and ASP.NET. To learn more about Visual Basic and ASP.NET, check out our book _Visual Basic 2005 How to Program, Third Edition_ or visit our Visual Basic Resource Center (www.deitel.com/visualbasic/) and our ASP.NET Resource Center (www.deitel.com/aspdotnet/).\]

Web services have important implications for **business-to-business** (**B2B**) **transac- tions**. They enable businesses to conduct transactions via standardized, widely available web services rather than relying on proprietary applications. Web services and SOAP are platform and language independent, so companies can collaborate via web services without worrying about the compatibility of their hardware, software and communica- tions technologies. Companies such as Amazon, Google, eBay, PayPal and many others are using web services to their advantage by making their server-side applications available to partners via web services.

By purchasing web services and using extensive free web services that are relevant to their businesses, companies can spend less time developing new applications and can create innovative new applications. E-businesses can use web services to provide their cus- tomers with enhanced shopping experiences. Consider an online music store. The store’s website links to information about various CDs, enabling users to purchase the CDs, to learn about the artists, to find more titles by those artists, to find other artists’ music they may enjoy, and more. Another company that sells concert tickets provides a web service that displays upcoming concert dates for various artists and allows users to buy tickets. By consuming the concert-ticket web service on its site, the online music store can provide an additional service to its customers, increase its site traffic and perhaps earn a commission on concert-ticket sales. The company that sells concert tickets also benefits from the busi- ness relationship by selling more tickets and possibly by receiving revenue from the online music store for the use of the web service.

Any Java programmer with a knowledge of web services can write applications that can “consume” web services. The resulting applications would call web service methods of objects running on servers that could be thousands of miles away. To learn more about Java web services read the Java Technology and Web Services Overview at java.sun.com/ webservices/overview.html.

**_Netbeans_** Netbeans—developed by Sun—is one of the many tools that enable programmers to “publish” and/or “consume” web services. We demonstrate how to use Netbeans to im- plement web services and invoke them from client applications. For each example, we pro- vide the web service’s code, then present a client application that uses the web service. Our first examples build web services and client applications in Netbeans. Then we demon- strate web services that use more sophisticated features, such as manipulating databases with JDBC and manipulating class objects. For information on downloading and install- ing the Netbeans 5.5.1 IDE, its Visual Web Pack and the Sun Java System Application Server (SJSAS), see Section 26.1.  

**1228** Chapter 28 Web Services

**28.2 Java Web Services Basics** A web service normally resides on a **server**. The application (i.e., the client) that accesses the web service sends a method call over a network to the remote machine, which processes the call and returns a response over the network to the application. This kind of distribut- ed computing is beneficial in many applications. For example, a client application without direct access to a database on a remote server might be able to retrieve the data via a web service. Similarly, an application lacking the processing power to perform specific compu- tations could use a web service to take advantage of another system’s superior resources.

In Java, a web service is implemented as a class. In previous chapters, all the pieces of an application resided on one machine. The class that represents the web service resides on a server—it’s not part of the client application.

Making a web service available to receive client requests is known as **publishing a web service**; using a web service from a client application is known as **consuming a web service**. An application that consumes a web service consists of two parts—an object of a **proxy class** for interacting with the web service and a client application that consumes the web service by invoking methods on the object of the proxy class. The client code invokes methods on the proxy object, which handles the details of communicating with the web service (such as passing method arguments to the web service and receiving return values from the web service) on the client’s behalf. This communication can occur over a local network, over the Internet or even with a web service on the same computer. The web ser- vice performs the corresponding task and returns the results to the proxy object, which then returns the results to the client code. Figure 28.1 depicts the interactions among the client code, the proxy class and the web service. As you’ll soon see, Netbeans creates these proxy classes for you in your client applications.

Requests to and responses from web services created with **JAX-WS 2.0** (one of many different web service frameworks) are typically transmitted via SOAP. Any client capable of generating and processing SOAP messages can interact with a web service, regardless of the language in which the web service is written. We discuss SOAP in Section 28.5.

**28.3 Creating, Publishing, Testing and Describing a Web Service** The following subsections demonstrate how to create, publish and test a HugeInteger web service that performs calculations with positive integers up to 100 digits long (maintained as arrays of digits). Such integers are much larger than Java’s integral primitive types can represent. The HugeInteger web service provides methods that take two “huge integers”

**Fig. 28.1** | Interaction between a web service client and a web service.

ServerClient

Client code

Proxy class

Web service

Internetobject  

28.3 Creating, Publishing, Testing and Describing a Web Service **1229**

(represented as Strings) and determine their sum, their difference, which is larger, which is smaller or whether the two numbers are equal. These methods will be services available to other applications via the web—hence the term web services.

**28.3.1 Creating a Web Application Project and Adding a Web Service Class in Netbeans** When you create a web service in Netbeans, you focus on the web service’s logic and let the IDE handle the web service’s infrastructure. To create a web service in Netbeans, you first create a **Web Application** project. Netbeans uses this project type for web services that are invoked by other applications.

**_Creating a Web Application Project in Netbeans_** To create a web application, perform the following steps:

**1\.** Select **File > New Project** to open the **New Project** dialog.

**2\.** Select **Web** from the dialog’s **Categories** list, then select **Web Application** from the **Projects** list. Click **Next >**.

**3\.** Specify the name of your project (HugeInteger) in the **Project Name** field and specify where you’d like to store the project in the **Project Location** field. You can click the **Browse** button to select the location.

**4\.** Select **Sun Java System Application Server 9** from the **Server** drop-down list.

**5\.** Select **Java EE 5** from the **J2EE Version** drop-down list.

**6\.** Click **Finish** to dismiss the **New Project** dialog.

This creates a web application that will run in a web browser, similar to the **Visual Web Application** projects used in Chapters 26 and 27. Netbeans generates additional files to support the web application. This chapter discusses only the web-service-specific files.

**_Adding a Web Service Class to a Web Application Project_** Perform the following steps to add a web service class to the project:

**1\.** In the **Projects** tab in Netbeans, right click the **HugeInteger** project’s node and se- lect **New > Web Service…** to open the **New Web Service** dialog.

**2\.** Specify HugeInteger in the **Web Service Name** field.

**3\.** Specify com.deitel.iw3htp4.ch28.hugeinteger in the **Package** field.

**4\.** Click **Finish** to dismiss the **New Web Service** dialog.

The IDE generates a sample web service class with the name you specified in _Step 2_. You can find this class in the **Projects** tab under the **Web Services** node. In this class, you’ll de- fine the methods that your web service makes available to client applications. When you eventually build your application, the IDE will generate other supporting files (which we’ll discuss shortly) for your web service.

**28.3.2 Defining the HugeInteger Web Service in Netbeans** Figure 28.2 contains the HugeInteger web service’s code. You can implement this code yourself in the HugeInteger.java file created in Section 28.3.1, or you can simply replace the code in HugeInteger.java with a copy of our code from this example’s folder. You  

**1230** Chapter 28 Web Services

can find this file in the project’s src\\java\\com\\deitel\\iw3htp4\\ch28\\hugeinteger

folder. The book’s examples can be downloaded from www.deitel.com/books/iw3htp4/.

**1** // Fig. 28.2: HugeInteger.java **2** // HugeInteger web service that performs operations on large integers. **3** package com.deitel.iw3htp4.ch28.hugeinteger; **4 5 6 7 8 9**

**10 11 12** public class HugeInteger **13** { **14** private final static int MAXIMUM = 100; // maximum number of digits **15** public int\[\] number = new int\[ MAXIMUM \]; // stores the huge integer **16 17** // returns a String representation of a HugeInteger **18** public String toString() **19** { **20** String value = ""; **21 22** // convert HugeInteger to a String **23** for ( int digit : number ) **24** value = digit + value; // places next digit at beginning of value **25 26** // locate position of first non-zero digit **27** int length = value.length(); **28** int position = -1; **29 30** for ( int i = 0; i < length; i++ ) **31** { **32** if ( value.charAt( i ) != '0' ) **33** { **34** position = i; // first non-zero digit **35** break; **36** } **37** } // end for **38 39** return ( position != -1 ? value.substring( position ) : "0" ); **40** } // end method toString **41 42** // creates a HugeInteger from a String **43** public static HugeInteger parseHugeInteger( String s ) **44** { **45** HugeInteger temp = new HugeInteger(); **46** int size = s.length(); **47 48** for ( int i = 0; i < size; i++ ) **49** temp.number\[ i \] = s.charAt( size - i - 1 ) - '0';

**Fig. 28.2** | HugeInteger web service that performs operations on large integers. (Part 1 of 3.)

import javax.jws.WebService; // program uses the annotation @WebService import javax.jws.WebMethod; // program uses the annotation @WebMethod import javax.jws.WebParam; // program uses the annotation @WebParam

@WebService( // annotates the class as a web service name = "HugeInteger", // sets class name serviceName = "HugeIntegerService" ) // sets the service name  

28.3 Creating, Publishing, Testing and Describing a Web Service **1231**

**50 51** return temp; **52** } // end method parseHugeInteger **53 54** // WebMethod that adds huge integers represented by String arguments **55 56 57 58** { **59** int carry = 0; // the value to be carried **60** HugeInteger operand1 = HugeInteger.parseHugeInteger( first ); **61** HugeInteger operand2 = HugeInteger.parseHugeInteger( second ); **62** HugeInteger result = new HugeInteger(); // stores addition result **63 64** // perform addition on each digit **65** for ( int i = 0; i < MAXIMUM; i++ ) **66** { **67** // add corresponding digits in each number and the carried value; **68** // store result in the corresponding column of HugeInteger result **69** result.number\[ i \] = **70** ( operand1.number\[ i \] + operand2.number\[ i \] + carry ) % 10; **71 72** // set carry for next column **73** carry = **74** ( operand1.number\[ i \] + operand2.number\[ i \] + carry ) / 10; **75** } // end for **76 77** return result.toString(); **78** } // end WebMethod add **79 80** // WebMethod that subtracts integers represented by String arguments **81 82 83 84** { **85** HugeInteger operand1 = HugeInteger.parseHugeInteger( first ); **86** HugeInteger operand2 = HugeInteger.parseHugeInteger( second ); **87** HugeInteger result = new HugeInteger(); // stores difference **88 89** // subtract bottom digit from top digit **90** for ( int i = 0; i < MAXIMUM; i++ ) **91** { **92** // if the digit in operand1 is smaller than the corresponding **93** // digit in operand2, borrow from the next digit **94** if ( operand1.number\[ i \] < operand2.number\[ i \] ) **95** operand1.borrow( i ); **96 97** // subtract digits **98** result.number\[ i \] = operand1.number\[ i \] - operand2.number\[ i \]; **99** } // end for **100 101** return result.toString(); **102** } // end WebMethod subtract

**Fig. 28.2** | HugeInteger web service that performs operations on large integers. (Part 2 of 3.)

@WebMethod( operationName = "add" ) public String add( @WebParam( name = "first" ) String first,

@WebParam( name = "second" ) String second )

@WebMethod( operationName = "subtract" ) public String subtract( @WebParam( name = "first" ) String first,

@WebParam( name = "second" ) String second )  

**1232** Chapter 28 Web Services

Lines 5–7 import the annotations used in this example. By default, each new web ser- vice class created with the JAX-WS APIs is a **POJO (plain old Java object)**, meaning that—unlike prior Java web service APIs—you do not need to extend a class or implement an interface to create a web service. When you compile a class that uses these JAX-WS 2.0 annotations, the compiler creates all the **server-side artifacts** that support the web ser-

**103 104** // borrow 1 from next digit **105** private void borrow( int place ) **106** { **107** if ( place >= MAXIMUM ) **108** throw new IndexOutOfBoundsException(); **109** else if ( number\[ place + 1 \] == 0 ) // if next digit is zero **110** borrow( place + 1 ); // borrow from next digit **111 112** number\[ place \] += 10; // add 10 to the borrowing digit **113** \--number\[ place + 1 \]; // subtract one from the digit to the left **114** } // end method borrow **115 116** // WebMethod that returns true if first integer is greater than second **117 118 119 120** { **121** try // try subtracting first from second **122** { **123** String difference = subtract( first, second ); **124** return !difference.matches( "^\[0\]+$" ); **125** } // end try **126** catch ( IndexOutOfBoundsException e ) // first is less than second **127** { **128** return false; **129** } // end catch **130** } // end WebMethod bigger **131 132** // WebMethod that returns true if the first integer is less than second **133 134 135 136** { **137** return bigger( second, first ); **138** } // end WebMethod smaller **139 140** // WebMethod that returns true if the first integer equals the second **141 142 143 144** { **145** return !( bigger( first, second ) || smaller( first, second ) ); **146** } // end WebMethod equals **147** } // end class HugeInteger

**Fig. 28.2** | HugeInteger web service that performs operations on large integers. (Part 3 of 3.)

@WebMethod( operationName = "bigger" ) public boolean bigger( @WebParam( name = "first" ) String first,

@WebParam( name = "second" ) String second )

@WebMethod( operationName = "smaller" ) public boolean smaller( @WebParam( name = "first" ) String first,

@WebParam( name = "second" ) String second )

@WebMethod( operationName = "equals" ) public boolean equals( @WebParam( name = "first" ) String first,

@WebParam( name = "second" ) String second )  

28.3 Creating, Publishing, Testing and Describing a Web Service **1233**

vice—that is, the compiled code framework that allows the web service to wait for client requests and respond to those requests once the service is deployed on an application server. Popular application servers that support Java web services include the Sun Java System Application Server (www.sun.com/software/products/appsrvr/index.xml), GlassFish (glassfish.dev.java.net), Apache Tomcat (tomcat.apache.org), BEA Weblogic Server (www.bea.com) and JBoss Application Server (www.jboss.org/ products/jbossas). We use Sun Java System Application Server in this chapter.

Lines 9–11 contain a @WebService annotation (imported at line 5) with properties name and serviceName. The **@WebService annotation** indicates that class HugeInteger

implements a web service. The annotation is followed by a set of parentheses containing optional elements. The annotation’s **name element** (line 10) specifies the name of the proxy class that will be generated for the client. The annotation’s **serviceName element** (line 11) specifies the name of the class that the client uses to obtain an object of the proxy class. \[_Note:_ If the serviceName element is not specified, the web service’s name is assumed to be the class name followed by the word Service.\] Netbeans places the @WebService

annotation at the beginning of each new web service class you create. You can then add the name and serviceName properties in the parentheses following the annotation.

Line 14 declares the constant MAXIMUM that specifies the maximum number of digits for a HugeInteger (i.e., 100 in this example). Line 15 creates the array that stores the digits in a huge integer. Lines 18–40 declare method toString, which returns a String repre- sentation of a HugeInteger without any leading 0s. Lines 43–52 declare static method parseHugeInteger, which converts a String into a HugeInteger. The web service’s methods add, subtract, bigger, smaller and equals use parseHugeInteger to convert their String arguments to HugeIntegers for processing.

HugeInteger methods add, subtract, bigger, smaller and equals are tagged with the **@WebMethod annotation** (lines 55, 81, 117, 133 and 141) to indicate that they can be called remotely. Any methods that are not tagged with @WebMethod are not accessible to clients that consume the web service. Such methods are typically utility methods within the web service class. Note that the @WebMethod annotations each use the **operationName**

element to specify the method name that is exposed to the web service’s client.

**Common Programming Error 28.1** _Failing to expose a method as a web method by declaring it with the @WebMethod annotation prevents clients of the web service from accessing the method._ 28.1

**Common Programming Error 28.2** _Methods with the @WebMethod annotation cannot be static. An object of the web service class must exist for a client to access the service’s web methods._ 28.2

Each web method in class HugeInteger specifies parameters that are annotated with the **@WebParam annotation** (e.g., lines 56–57 of method add). The optional @WebParam ele- ment **name** indicates the parameter name that is exposed to the web service’s clients.

Lines 55–78 and 81–102 declare HugeInteger web methods add and subtract. We assume for simplicity that add does not result in overflow (i.e., the result will be 100 digits or fewer) and that subtract’s first argument will always be larger than the second. The subtract method calls method borrow (lines 105–114) when it is necessary to borrow 1 from the next digit to the left in the first argument—that is, when a particular digit in the  

**1234** Chapter 28 Web Services

left operand is smaller than the corresponding digit in the right operand. Method borrow

adds 10 to the appropriate digit and subtracts 1 from the next digit to the left. This utility method is not intended to be called remotely, so it is not tagged with @WebMethod.

Lines 117–130 declare HugeInteger web method bigger. Line 123 invokes method subtract to calculate the difference between the numbers. If the first number is less than the second, this results in an exception. In this case, bigger returns false. If subtract does not throw an exception, then line 124 returns the result of the expression

!difference.matches( "^\[0\]+$" )

This expression calls String method matches to determine whether the String differ-

ence matches the regular expression "^\[0\]+$", which determines if the String consists only of one or more 0s. The symbols ^ and $ indicate that matches should return true

only if the entire String difference matches the regular expression. We then use the log- ical negation operator (!) to return the opposite boolean value. Thus, if the numbers are equal (i.e., their difference is 0), the preceding expression returns false—the first number is not greater than the second. Otherwise, the expression returns true.

Lines 133–146 declare methods smaller and equals. Method smaller returns the result of invoking method bigger (line 137) with the arguments reversed—if first is less than second, then second is greater than first. Method equals invokes methods bigger and smaller (line 145). If either bigger or smaller returns true, line 145 returns false, because the numbers are not equal. If both methods return false, the numbers are equal and line 145 returns true.

**28.3.3 Publishing the HugeInteger Web Service from Netbeans** Now that we’ve created the HugeInteger web service class, we’ll use Netbeans to build and publish (i.e., deploy) the web service so that clients can consume its services. Netbeans handles all the details of building and deploying a web service for you. This includes cre- ating the framework required to support the web service. Right click the project name (HugeInteger) in the Netbeans **Projects** tab to display the pop-up menu shown in Fig. 28.3. To determine if there are any compilation errors in your project, select the **Build Project** option. When the project compiles successfully, you can select **Deploy Project** to deploy the project to the server you selected when you set up the web application in Section 28.3.1. If the code in the project has changed since the last build, selecting **Deploy Project** also builds the project. Selecting **Run Project** executes the web application. If the web application was not previously built or deployed, this option performs these tasks first. Note that both the **Deploy Project** and **Run Project** options also start the application server (in our case Sun Java System Application Server) if it is not already running. To ensure that all source-code files in a project are recompiled during the next build operation, you can use the **Clean Project** or **Clean and Build Project** options. If you have not already done so, select **Deploy Project** now.

**28.3.4 Testing the HugeInteger Web Service with Sun Java System Application Server’s Tester Web page** The next step is to test the HugeInteger web service. We previously selected the Sun Java System Application Server to execute this web application. This server can dynamically  

28.3 Creating, Publishing, Testing and Describing a Web Service **1235**

create a web page for testing a web service’s methods from a web browser. To enable this capability:

**1\.** Right click the project name (HugeInteger) in the Netbeans **Projects** tab and se- lect **Properties** from the pop-up menu to display the **Project Properties** dialog.

**2\.** Click **Run** under **Categories** to display the options for running the project.

**3\.** In the **Relative URL** field, type /HugeIntegerService?Tester.

**4\.** Click **OK** to dismiss the **Project Properties** dialog.

The **Relative URL** field specifies what should happen when the web application executes. If this field is empty, then the web application’s default JSP displays when you run the project. When you specify /HugeIntegerService?Tester in this field, then run the project, Sun Java System Application Server builds the Tester web page and loads it into your web browser. Figure 28.4 shows the Tester web page for the HugeInteger web ser- vice. Once you’ve deployed the web service, you can also type the URL

http://localhost:8080/HugeInteger/HugeIntegerService?Tester

in your web browser to view the Tester web page. Note that HugeIntegerService is the name (specified in line 11 of Fig. 28.2) that clients, including the Tester web page, use to access the web service.

To test HugeInteger’s web methods, type two positive integers into the text fields to the right of a particular method’s button, then click the button to invoke the web method and see the result. Figure 28.5 shows the results of invoking HugeInteger’s add method with the values 99999999999999999 and 1. Note that the number 99999999999999999 is larger than primitive type long can represent.

**Fig. 28.3** | Pop-up menu that appears when you right click a project name in the Netbeans **Projects** tab.

Deletes all .class files in the project, then

compiles the project’s files

Compiles the project’s files

Deletes all .class files in the project

Runs the project

Deploys the project to the application server  

**1236** Chapter 28 Web Services

Note that you can access the web service only when the application server is running. If Netbeans launches the application server for you, it will automatically shut it down when you close Netbeans. To keep the application server up and running, you can launch it independently of Netbeans before you deploy or run web applications in Netbeans. For Sun Java System Application Server running on Windows, you can do this by selecting

**Fig. 28.4** | Tester web page created by Sun Java System Application Server for the HugeInteger web service.

‘

**Fig. 28.5** | Testing HugeInteger’s add method. (Part 1 of 2.)

a) Invoking the HugeInteger web service’s add method.  

28.3 Creating, Publishing, Testing and Describing a Web Service **1237**

**Start > All Programs > Sun Microsystems > Application Server PE 9 > Start Default Server**. To shut down the application server, you can select the **Stop Default Server** option from the same location.

**_Testing the HugeInteger Web Service from Another Computer_** If your computer is connected to a network and allows HTTP requests, then you can test the web service from another computer on the network by typing the following URL (where _host_ is the hostname or IP address of the computer on which the web service is de- ployed) into a browser on another computer:

http://_host_:8080/HugeInteger/HugeIntegerService?Tester

**_Note to Windows XP Service Pack 2 and Windows Vista Users_** For security reasons, computers running Windows XP Service Pack 2 or Windows Vista do not allow HTTP requests from other computers by default. If you wish to allow other computers to connect to your computer using HTTP, perform the following steps on Windows XP SP2:

**1\.** Select **Start > Control Panel** to open your system’s **Control Panel** window, then double click **Windows Firewall** to view the **Windows Firewall** settings dialog.

**2\.** In the **Windows Firewall** dialog, click the **Exceptions** tab, then click **Add Port…** and add port 8080 with the name SJSAS.

**3\.** Click **OK** to dismiss the **Windows Firewall** settings dialog.

To allow other computers to connect to your Windows Vista computer using HTTP, per- form the following steps:

**1\.** Open the **Control Panel**, switch to **Classic View** and double click **Windows Firewall** to open the **Windows Firewall** dialog.

**Fig. 28.5** | Testing HugeInteger’s add method. (Part 2 of 2.)

b) Results of calling the HugeInteger web service’s add method with "99999999999999999" and "1".  

**1238** Chapter 28 Web Services

**2\.** In the **Windows Firewall** dialog click the **Change Settings…** link.

**3\.** In the **Windows Firewall** dialog, click the **Exceptions** tab, then click **Add Port…** and add port 8080 with the name SJSAS.

**4\.** Click **OK** to dismiss the **Windows Firewall** settings dialog.

**28.3.5 Describing a Web Service with the Web Service Description Language (WSDL)** Once you implement a web service, compile it and deploy it on an application server, a client application can consume the web service. To do so, however, the client must know where to find the web service and must be provided with a description of how to interact with the web service—that is, what methods are available, what parameters they expect and what each method returns. For this purpose, JAX-WS uses the **Web Service Descrip- tion Language (WSDL)**—a standard XML vocabulary for describing web services in a platform-independent manner.

You do not need to understand the details of WSDL to take advantage of it—the application server software (SJSAS) generates a web service’s WSDL dynamically for you, and client tools can parse the WSDL to help create the client-side proxy class that a client uses to access the web service. Since the WSDL is created dynamically, clients always receive a deployed web service’s most up-to-date description. To view the WSDL for the HugeInteger web service (Fig. 28.6), enter the following URL in your browser:

http://localhost:8080/HugeInteger/HugeIntegerService?WSDL

or click the **WSDL File** link in the Tester web page (shown in Fig. 28.4).

**Fig. 28.6** | A portion of the .wsdl file for the HugeInteger web service.  

28.4 Consuming a Web Service **1239**

**_Accessing the HugeInteger Web Service’s WSDL from Another Computer_** Eventually, you’ll want clients on other computers to use your web service. Such clients need access to the web service’s WSDL, which they would access with the following URL:

http://_host_:8080/HugeInteger/HugeIntegerService?WSDL

where _host_ is the hostname or IP address of the computer on which the web service is de- ployed. As we discussed in Section 28.3.4, this will work only if your computer allows HTTP connections from other computers—as is the case for publicly accessible web and application servers.

**28.4 Consuming a Web Service** Now that we’ve defined and deployed our web service, we can consume it from a client application. A web service client can be any type of application or even another web ser- vice. You enable a client application to consume a web service by **adding a web service reference** to the application. This process defines the proxy class that allows the client to access the web service.

**28.4.1 Creating a Client in Netbeans to Consume the HugeInteger Web Service** In this section, you’ll use Netbeans to create a client Java desktop GUI application, then you’ll add a web service reference to the project so the client can access the web service. When you add the web service reference, the IDE creates and compiles the **client-side ar- tifacts**—the framework of Java code that supports the client-side proxy class. The client then calls methods on an object of the proxy class, which uses the rest of the artifacts to interact with the web service.

**_Creating a Desktop Application Project in Netbeans_** Before performing the steps in this section, ensure that the HugeInteger web service has been deployed and that the Sun Java System Application Server is running (see Section 28.3.3). Perform the following steps to create a client Java desktop application in Netbeans:

**1\.** Select **File > New Project…** to open the **New Project** dialog.

**2\.** Select **General** from the **Categories** list and **Java Application** from the **Projects** list, then click **Next >**.

**3\.** Specify the name UsingHugeInteger in the **Project Name** field and uncheck the **Create Main Class** checkbox. In a moment, you’ll add a subclass of JFrame that contains a main method.

**4\.** Click **Finish** to create the project.

**_Adding a Web Service Reference to an Application_** Next, you’ll add a web service reference to your application so that it can interact with the HugeInteger web service. To add a web service reference, perform the following steps.

**1\.** Right click the project name (UsingHugeInteger) in the Netbeans **Projects** tab.

**2\.** Select **New > Web Service Client…** from the pop-up menu to display the **New Web Service Client** dialog (Fig. 28.7).  

**1240** Chapter 28 Web Services

**3\.** In the **WSDL URL** field, specify the URL http://localhost:8080/HugeInteger/

HugeIntegerService?WSDL (Fig. 28.7). This URL tells the IDE where to find the web service’s WSDL description. \[_Note:_ If the Sun Java System Application Serv- er is located on a different computer, replace localhost with the hostname or IP address of that computer.\] The IDE uses this WSDL description to generate the client-side artifacts that compose and support the proxy. Note that the **New Web Service Client** dialog enables you to search for web services in several locations. Many companies simply distribute the exact WSDL URLs for their web services, which you can place in the **WSDL URL** field.

**4\.** In the **Package** field, specify com.deitel.iw3htp4.ch28.usinghugeinteger as the package name.

**5\.** Click **Finish** to dismiss the **New Web Service Client** dialog.

In the Netbeans **Projects** tab, the UsingHugeInteger project now contains a Web Ser- vice References folder with the HugeInteger web service’s proxy (Fig. 28.8). Note that the proxy’s name is listed as HugeIntegerService, as we specified in line 11 of Fig. 28.2.

When you specify the web service you want to consume, Netbeans accesses the web service’s WSDL information and copies it into a file in your project (named HugeInte-

gerService.wsdl in this example). You can view this file from the Netbeans **Files** tab by expanding the nodes in the UsingHugeInteger project’s xml-resources folder as shown in Fig. 28.9. If the web service changes, the client-side artifacts and the client’s copy of the WSDL file can be regenerated by right clicking the HugeIntegerService node shown in Fig. 28.8 and selecting **Refresh Client**.

**Fig. 28.7** | **New Web Service Client** dialog.  

28.4 Consuming a Web Service **1241**

You can view the IDE-generated client-side artifacts by selecting the Netbeans **Files** tab and expanding the UsingHugeInteger project’s **build** folder as shown in Fig. 28.10.

**Fig. 28.8** | Netbeans **Project** tab after adding a web service reference to the project.

**Fig. 28.9** | Locating the HugeIntegerService.wsdl file in the Netbeans **Files** tab.

**Fig. 28.10** | Viewing the HugeInteger web service’s client-side artifacts generated by Netbeans.

Folder created when you add a web service client to your project in Netbeans.

WSDL file for the HugeInteger web service

Client-side artifacts generated by Netbeans to support the web

service proxy object  

**1242** Chapter 28 Web Services

**28.4.2 Consuming the HugeInteger Web Service** For this example, we use a GUI application to interact with the web service HugeInteger

web service. To build the client application’s GUI, you must first add a subclass of JFrame to the project. To do so, perform the following steps:

**1\.** Right click the project name in the Netbeans **Project** tab.

**2\.** Select **New > JFrame Form…** to display the **New JFrame Form** dialog.

**3\.** Specify UsingHugeIntegerJFrame in the **Class Name** field.

**4\.** Specify com.deitel.iw3htp4.ch28.hugeintegerclient in the **Package** field.

**5\.** Click **Finish** to close the **New JFrame Form** dialog.

Next, use the Netbeans GUI design tools to build the GUI shown in the sample screen captures at the end of Fig. 28.11.

The application in Fig. 28.11 uses the HugeInteger web service to perform compu- tations with positive integers up to 100 digits long. To save space, we do not show the Net- beans autogenerated initComponents method, which contains the code that builds the GUI components, positions them and registers their event handlers. To view the complete source code, open the UsingHugeIntegerJFrame.java file in this example’s folder under src\\java\\com\\deitel\\iw3htp4\\ch28\\hugeintegerclient. Netbeans places the GUI component instance-variable declarations at the end of the class (lines 326–335). Java allows instance variables to be declared anywhere in a class’s body as long as they are placed outside the class’s methods. We continue to declare our own instance variables at the top of the class.

Lines 6–7 import the classes HugeInteger and HugeIntegerService that enable the client application to interact with the web service. We include these import declarations only for documentation purposes here. These classes are in the same package as Using- HugeIntegerJFrame, so these import declarations are not necessary. Notice that we do not have import declarations for most of the GUI components used in this example. When you create a GUI in Netbeans, it uses fully qualified class names (such as javax.swing.JFrame in line 11), so import declarations are unnecessary.

Lines 13–14 declare the variables of type HugeIntegerService and HugeInteger, respectively. Line 24 in the constructor creates an object of type HugeIntegerService. Line 25 uses this object’s getHugeIntegerPort method to obtain the HugeInteger proxy object that the application uses to invoke the web service’s method.

Lines 165–166, 189–190, 213–214, 240–241 and 267–268 in the various JButton event handlers invoke the HugeInteger web service’s web methods. Note that each call is made on the local proxy object that is referenced by hugeIntegerProxy. The proxy object then communicates with the web service on the client’s behalf.

The user enters two integers, each up to 100 digits long. Clicking any of the five JBut- tons causes the application to invoke a web method to perform the corresponding task and return the result. Our client application cannot process 100-digit numbers directly. Instead the client passes String representations of these numbers to the web service’s web methods, which perform tasks for the client. The client application then uses the return value of each operation to display an appropriate message.  

28.4 Consuming a Web Service **1243**

**1** // Fig. 28.11: UsingHugeIntegerJFrame.java **2** // Client desktop application for the HugeInteger web service. **3** package com.deitel.iw3htp4.ch28.hugeintegerclient; **4 5 6 7 8 9** import javax.swing.JOptionPane; // used to display errors to the user

**10 11** public class UsingHugeIntegerJFrame extends javax.swing.JFrame **12** { **13 14 15 16** // no-argument constructor **17** public UsingHugeIntegerJFrame() **18** { **19** initComponents(); **20 21** try **22** { **23** // create the objects for accessing the HugeInteger web service **24 25 26** } **27** catch ( Exception exception ) **28** { **29** exception.printStackTrace(); **30** } **31** } // end UsingHugeIntegerJFrame constructor **32 33 34 35 36 37 154** // invokes HugeInteger web service's add method to add HugeIntegers **155** private void addJButtonActionPerformed( **156** java.awt.event.ActionEvent evt ) **157** { **158** String firstNumber = firstJTextField.getText(); **159** String secondNumber = secondJTextField.getText(); **160 161** if ( isValid( firstNumber ) && isValid( secondNumber ) ) **162** { **163** try **164** { **165 166 167** } // end try **168** catch ( Exception e ) **169** {

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 1 of 6.)

// import classes for accessing HugeInteger web service's proxy import com.deitel.iw3htp4.ch28.hugeintegerclient.HugeInteger; import com.deitel.iw3htp4.ch28.hugeintegerclient.HugeIntegerService;

private HugeIntegerService hugeIntegerService; // used to obtain proxy private HugeInteger hugeIntegerProxy; // used to access the web service

hugeIntegerService = new HugeIntegerService(); hugeIntegerProxy = hugeIntegerService.getHugeIntegerPort();

// The initComponents method is autogenerated by Netbeans and is called // from the constructor to initialize the GUI. This method is not shown // here to save space. Open UsingHugeIntegerJFrame.java in this // example's folder to view the complete generated code (lines 37-153).

resultsJTextArea.setText( hugeIntegerProxy.add( firstNumber, secondNumber ) );  

**1244** Chapter 28 Web Services

**170** JOptionPane.showMessageDialog( this, e.toString(), **171** "Add method failed", JOptionPane.ERROR\_MESSAGE ); **172** e.printStackTrace(); **173** } // end catch **174** } // end if **175** } // end method addJButtonActionPerformed **176 177** // invokes HugeInteger web service's subtract method to subtract the **178** // second HugeInteger from the first **179** private void subtractJButtonActionPerformed( **180** java.awt.event.ActionEvent evt ) **181** { **182** String firstNumber = firstJTextField.getText(); **183** String secondNumber = secondJTextField.getText(); **184 185** if ( isValid( firstNumber ) && isValid( secondNumber ) ) **186** { **187** try **188** { **189 190 191** } // end try **192** catch ( Exception e ) **193** { **194** JOptionPane.showMessageDialog( this, e.toString(), **195** "Subtract method failed", JOptionPane.ERROR\_MESSAGE ); **196** e.printStackTrace(); **197** } // end catch **198** } // end if **199** } // end method subtractJButtonActionPerformed **200 201** // invokes HugeInteger web service's bigger method to determine whether **202** // the first HugeInteger is greater than the second **203** private void biggerJButtonActionPerformed( **204** java.awt.event.ActionEvent evt ) **205** { **206** String firstNumber = firstJTextField.getText(); **207** String secondNumber = secondJTextField.getText(); **208 209** if ( isValid( firstNumber ) && isValid( secondNumber ) ) **210** { **211** try **212** { **213 214 215** resultsJTextArea.setText( String.format( "%s %s %s %s", **216** firstNumber, ( result ? "is" : "is not" ), "greater than", **217** secondNumber ) ); **218** } // end try **219** catch ( Exception e ) **220** { **221** JOptionPane.showMessageDialog( this, e.toString(), **222** "Bigger method failed", JOptionPane.ERROR\_MESSAGE );

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 2 of 6.)

resultsJTextArea.setText( hugeIntegerProxy.subtract( firstNumber, secondNumber ) );

boolean result = hugeIntegerProxy.bigger( firstNumber, secondNumber );  

28.4 Consuming a Web Service **1245**

**223** e.printStackTrace(); **224** } // end catch **225** } // end if **226** } // end method biggerJButtonActionPerformed **227 228** // invokes HugeInteger web service's smaller method to determine **229** // whether the first HugeInteger is less than the second **230** private void smallerJButtonActionPerformed( **231** java.awt.event.ActionEvent evt ) **232** { **233** String firstNumber = firstJTextField.getText(); **234** String secondNumber = secondJTextField.getText(); **235 236** if ( isValid( firstNumber ) && isValid( secondNumber ) ) **237** { **238** try **239** { **240 241 242** resultsJTextArea.setText( String.format( "%s %s %s %s", **243** firstNumber, ( result ? "is" : "is not" ), "less than", **244** secondNumber ) ); **245** } // end try **246** catch ( Exception e ) **247** { **248** JOptionPane.showMessageDialog( this, e.toString(), **249** "Smaller method failed", JOptionPane.ERROR\_MESSAGE ); **250** e.printStackTrace(); **251** } // end catch **252** } // end if **253** } // end method smallerJButtonActionPerformed **254 255** // invokes HugeInteger web service's equals method to determine whether **256** // the first HugeInteger is equal to the second **257** private void equalsJButtonActionPerformed( **258** java.awt.event.ActionEvent evt ) **259** { **260** String firstNumber = firstJTextField.getText(); **261** String secondNumber = secondJTextField.getText(); **262 263** if ( isValid( firstNumber ) && isValid( secondNumber ) ) **264** { **265** try **266** { **267 268 269** resultsJTextArea.setText( String.format( "%s %s %s %s", **270** firstNumber, ( result ? "is" : "is not" ), "equal to", **271** secondNumber ) ); **272** } // end try **273** catch ( Exception e ) **274** {

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 3 of 6.)

boolean result = hugeIntegerProxy.smaller( firstNumber, secondNumber );

boolean result = hugeIntegerProxy.equals( firstNumber, secondNumber );  

**1246** Chapter 28 Web Services

**275** JOptionPane.showMessageDialog( this, e.toString(), **276** "Equals method failed", JOptionPane.ERROR\_MESSAGE ); **277** e.printStackTrace(); **278** } // end catch **279** } // end if **280** } // end method equalsJButtonActionPerformed **281 282** // checks the size of a String to ensure that it is not too big **283** // to be used as a HugeInteger; ensure only digits in String **284** private boolean isValid( String number ) **285** { **286** // check String's length **287** if ( number.length() > 100 ) **288** { **289** JOptionPane.showMessageDialog( this, **290** "HugeIntegers must be <= 100 digits.", "HugeInteger Overflow", **291** JOptionPane.ERROR\_MESSAGE ); **292** return false; **293** } // end if **294 295** // look for nondigit characters in String **296** for ( char c : number.toCharArray() ) **297** { **298** if ( !Character.isDigit( c ) ) **299** { **300** JOptionPane.showMessageDialog( this, **301** "There are nondigits in the String", **302** "HugeInteger Contains Nondigit Characters", **303** JOptionPane.ERROR\_MESSAGE ); **304** return false; **305** } // end if **306** } // end for **307 308** return true; // number can be used as a HugeInteger **309** } // end method validate **310 311** // main method begins execution **312** public static void main( String args\[\] ) **313** { **314** java.awt.EventQueue.invokeLater( **315** new Runnable() **316** { **317** public void run() **318** { **319** new UsingHugeIntegerJFrame().setVisible( true ); **320** } // end method run **321** } // end anonymous inner class **322** ); // end call to java.awt.EventQueue.invokeLater **323** } // end method main **324 325** // Variables declaration - do not modify **326** private javax.swing.JButton addJButton;‘

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 4 of 6.)  

28.4 Consuming a Web Service **1247**

**327** private javax.swing.JButton biggerJButton; **328** private javax.swing.JLabel directionsJLabel; **329** private javax.swing.JButton equalsJButton; **330** private javax.swing.JTextField firstJTextField; **331** private javax.swing.JScrollPane resultsJScrollPane; **332** private javax.swing.JTextArea resultsJTextArea; **333** private javax.swing.JTextField secondJTextField; **334** private javax.swing.JButton smallerJButton; **335** private javax.swing.JButton subtractJButton; **336** // End of variables declaration **337** } // end class UsingHugeIntegerJFrame

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 5 of 6.)  

**1248** Chapter 28 Web Services

**28.5 SOAP** SOAP (Simple Object Access Protocol) is a platform-independent protocol that uses XML to facilitate remote procedure calls, typically over HTTP. SOAP is one common protocol for passing information between web service clients and web services. The protocol that transmits request-and-response messages is also known as the web service’s **wire format** or **wire protocol**, because it defines how information is sent “along the wire.”

Each request and response is packaged in a **SOAP message** (also known as a **SOAP envelope**)—an XML “wrapper” containing the information that a web service requires to process the message. SOAP messages are written in XML so that they are platform inde- pendent. Many **firewalls**—security barriers that restrict communication among net- works—are configured to allow HTTP traffic to pass through so that clients can browse websites on web servers behind firewalls. Thus, XML and HTTP enable computers on dif- ferent platforms to send and receive SOAP messages with few limitations.

The wire format used to transmit requests and responses must support all data types passed between the applications. Web services also use SOAP for the many data types it supports. SOAP supports primitive types (e.g., int) and their wrapper types (e.g., Integer), as well as Date, Time and others. SOAP can also transmit arrays and objects of user-defined types (as you’ll see in Section 28.8). For more SOAP information, visit www.w3.org/TR/soap/.

When a program invokes a web method, the request and all relevant information are packaged in a SOAP message and sent to the server on which the web service resides. The web service processes the SOAP message’s contents (contained in a SOAP envelope), which specify the method that the client wishes to invoke and the method’s arguments. This process of interpreting a SOAP message’s contents is known as **parsing a SOAP mes- sage**. After the web service receives and parses a request, the proper method is called with any specified arguments, and the response is sent back to the client in another SOAP mes- sage. The client-side proxy parses the response, which contains the result of the method call, and returns the result to the client application.

Figure 28.5 used the HugeInteger web service’s Tester web page to show the result of invoking HugeInteger’s add method with the values 99999999999999999 and 1. The Tester web page also shows the SOAP request and response messages (which were not previously shown). Figure 28.12 shows the SOAP messages in the Tester web page from Fig. 28.5 after the calculation. In the request message from Fig. 28.12, the text

<ns1:add> <first>99999999999999999</first>

**Fig. 28.11** | Client desktop application for the HugeInteger web service. (Part 6 of 6.)  

28.6 Session Tracking in Web Services **1249**

<second>1</second> </ns1:add>

specifies the method to call (add), the method’s arguments (first and second) and the arguments’ values (99999999999999999 and 1). Similarly, the text

<ns1:addResponse> <return>100000000000000000</return> </ns1:addResponse>

from the response message in Fig. 28.12 specifies the return value of method add. As with the WSDL for a web service, the SOAP messages are generated for you auto-

matically, so you don’t need to understand the details of SOAP or XML to take advantage of it when publishing and consuming web services.

**28.6 Session Tracking in Web Services** Section 26.5 described the advantages of using session tracking to maintain client state in- formation so you can personalize the users’ browsing experiences. Now we’ll incorporate

**Fig. 28.12** | SOAP messages for the HugeInteger web service’s add method as shown by the Sun Java System Application Server’s Tester web page.  

**1250** Chapter 28 Web Services

session tracking into a web service. Suppose a client application needs to call several meth- ods from the same web service, possibly several times each. In such a case, it can be bene- ficial for the web service to maintain state information for the client, thus eliminating the need for client information to be passed between the client and the web service multiple times. For example, a web service that provides local restaurant reviews could store the cli- ent user’s street address during the initial request, then use it to return personalized, local- ized results in subsequent requests. Storing session information also enables a web service to distinguish between clients.

**28.6.1 Creating a Blackjack Web Service** Our next example is a web service that assists you in developing a blackjack card game. The Blackjack web service (Fig. 28.13) provides web methods to shuffle a deck of cards, deal a card from the deck and evaluate a hand of cards. After presenting the web service, we use it to serve as the dealer for a game of blackjack (Fig. 28.14). The Blackjack web service uses an HttpSession object to maintain a unique deck of cards for each client ap- plication. Several clients can use the service at the same time, but web method calls made by a specific client use only the deck of cards stored in that client’s session. Our example uses the following blackjack rules:

_Two cards each are dealt to the dealer and the player. The player’s cards are dealt face up. Only the first of the dealer’s cards is dealt face up. Each card has a value. A card numbered 2 through 10 is worth its face value. Jacks, queens and kings each count as 10. Aces can count as 1 or 11—whichever value is more beneficial to the player (as we will soon see). If the sum of the player’s two initial cards is 21 (i.e., the player was dealt a card valued at 10 and an ace, which counts as 11 in this situation), the player has “blackjack” and immediately wins the game—if the dealer does not also have blackjack (which would result in a “push”—i.e., a tie). Otherwise, the player can begin taking additional cards one at a time. These cards are dealt face up, and the player decides when to stop taking cards. If the player “busts” (i.e., the sum of the player’s cards exceeds 21), the game is over, and the player loses. When the player is sat- isfied with the current set of cards, the player “stands” (i.e., stops taking cards), and the dealer’s hidden card is revealed. If the dealer’s total is 16 or less, the dealer must take another card; otherwise, the dealer must stand. The dealer must continue taking cards until the sum of the dealer’s cards is greater than or equal to 17. If the dealer exceeds 21, the player wins. Otherwise, the hand with the higher point total wins. If the dealer and the player have the same point total, the game is a “push,” and no one wins. Note that the value of an ace for a dealer depends on the dealer’s other card(s) and the casino’s house rules. A dealer typically must hit for totals of 16 or less and must stand for totals of 17 or more. However, for a “soft 17”—a hand with a total of 17 with one ace counted as 11—some casinos require the dealer to hit and some require the dealer to stand (we require the dealer to stand). Such a hand is known as a “soft 17” because taking another card cannot bust the hand._

The web service (Fig. 28.13) stores each card as a String consisting of a number, 1– 13, representing the card’s face (ace through king, respectively), followed by a space and a digit, 0–3, representing the card’s suit (hearts, diamonds, clubs or spades, respectively). For example, the jack of clubs is represented as "11 2", and the two of hearts is represented as "2 0". To create and deploy this web service, follow the steps presented in Sections 28.3.2–28.3.3 for the HugeInteger service.  

28.6 Session Tracking in Web Services **1251**

**1** // Fig. 28.13: Blackjack.java **2** // Blackjack web service that deals cards and evaluates hands **3** package com.deitel.iw3htp4.ch28.blackjack; **4 5** import java.util.ArrayList; **6** import java.util.Random; **7 8** import javax.jws.WebService; **9** import javax.jws.WebMethod;

**10** import javax.jws.WebParam; **11 12 13 14 15 16** @WebService( name = "Blackjack", serviceName = "BlackjackService" ) **17** public class Blackjack **18** { **19 20 21 22 23 24** // deal one card **25** @WebMethod( operationName = "dealCard" ) **26** public String dealCard() **27** { **28** String card = ""; **29 30 31 32 33** card = deck.get( 0 ); // get top card of deck **34** deck.remove( 0 ); // remove top card of deck **35 36** return card; **37** } // end WebMethod dealCard **38 39** // shuffle the deck **40** @WebMethod( operationName = "shuffle" ) **41** public void shuffle() **42** { **43 44 45 46 47 48** // populate deck of cards **49** ArrayList< String > deck = new ArrayList< String >(); **50 51** for ( int face = 1; face <= 13; face++ ) // loop through faces **52** for ( int suit = 0; suit <= 3; suit++ ) // loop through suits **53** deck.add( face + " " + suit ); // add each card to deck

**Fig. 28.13** | Blackjack web service that deals cards and evaluates hands. (Part 1 of 3.)

import javax.annotation.Resource;

import javax.servlet.http.HttpSession; import javax.servlet.http.HttpServletRequest; import javax.xml.ws.WebServiceContext; import javax.xml.ws.handler.MessageContext;

// use @Resource to create a WebServiceContext for session tracking private @Resource WebServiceContext webServiceContext; private MessageContext messageContext; // used in session tracking private HttpSession session; // stores attributes of the session

ArrayList< String > deck = ( ArrayList< String > ) session.getAttribute( "deck" );

// obtain the HttpSession object to store deck for current client messageContext = webServiceContext.getMessageContext(); session = ( ( HttpServletRequest ) messageContext.get(

MessageContext.SERVLET\_REQUEST ) ).getSession();  

**1252** Chapter 28 Web Services

**54 55** String tempCard; // holds card temporarily during swapping **56** Random randomObject = new Random(); // generates random numbers **57** int index; // index of randomly selected card **58 59** for ( int i = 0; i < deck.size() ; i++ ) // shuffle **60** { **61** index = randomObject.nextInt( deck.size() - 1 ); **62 63** // swap card at position i with randomly selected card **64** tempCard = deck.get( i ); **65** deck.set( i, deck.get( index ) ); **66** deck.set( index, tempCard ); **67** } // end for **68 69 70 71** } // end WebMethod shuffle **72 73** // determine a hand's value **74** @WebMethod( operationName = "getHandValue" ) **75** public int getHandValue( @WebParam( name = "hand" ) String hand ) **76** { **77** // split hand into cards **78** String\[\] cards = hand.split( "\\t" ); **79** int total = 0; // total value of cards in hand **80** int face; // face of current card **81** int aceCount = 0; // number of aces in hand **82 83** for ( int i = 0; i < cards.length; i++ ) **84** { **85** // parse string and get first int in String **86** face = Integer.parseInt( **87** cards\[ i \].substring( 0, cards\[ i \].indexOf( " " ) ) ); **88 89** switch ( face ) **90** { **91** case 1: // if ace, increment aceCount **92** ++aceCount; **93** break; **94** case 11: // jack **95** case 12: // queen **96** case 13: // king **97** total += 10; **98** break; **99** default: // otherwise, add face **100** total += face; **101** break; **102** } // end switch **103** } // end for **104**

**Fig. 28.13** | Blackjack web service that deals cards and evaluates hands. (Part 2 of 3.)

// add this deck to user's session session.setAttribute( "deck", deck );  

28.6 Session Tracking in Web Services **1253**

**_Session Tracking in Web Services_** The Blackjack web service client first calls method shuffle (lines 40–71) to shuffle the deck of cards. This method also places the deck of cards into an HttpSession object that is specific to the client that called shuffle. To use session tracking in a Web service, you must include code for the resources that maintain the session state information. In the past, you had to write the sometimes tedious code to create these resources. JAX-WS, how- ever, handles this for you via the **@Resource annotation**. This annotation enables tools like Netbeans to “inject” complex support code into your class, thus allowing you to focus on your business logic rather than the support code. The concept of using annotations to add code that supports your classes is known as **dependency injection**. Annotations like @Web- Service, @WebMethod and @WebParam also perform dependency injection.

Line 20 injects a WebServiceContext object into your class. A **WebServiceContext**

object enables a web service to access and maintain information for a specific request, such as session state. As you look through the code in Fig. 28.13, you’ll notice that we never create the WebServiceContext object. All of the code necessary to create it is injected into the class by the @Resource annotation. Line 21 declares a variable of interface type **MessageContext** that the web service will use to obtain an HttpSession object for the cur- rent client. Line 22 declares the HttpSession variable that the web service will use to manipulate the session state information.

Line 44 in method shuffle uses the WebServiceContext object that was injected in line 20 to obtain a MessageContext object. Lines 45–46 then use the MessageContext

object’s get method to obtain the HttpSession object for the current client. Method get

receives a constant indicating what to get from the MessageContext. In this case, the con- stant MessageContext.SERVLET\_REQUEST indicates that we’d like to get the HttpServlet- Request object for the current client. We then call method getSession to get the HttpSession object from the HttpServletRequest object.

Lines 49–70 generate an ArrayList representing a deck of cards, shuffle the deck and store the deck in the client’s session object. Lines 51–53 use nested loops to generate Strings in the form "_face suit_" to represent each possible card in the deck. Lines 59–67 shuffle the deck by swapping each card with another card selected at random. Line 70 inserts the ArrayList in the session object to maintain the deck between method calls from a particular client.

**105** // calculate optimal use of aces **106** if ( aceCount > 0 ) **107** { **108** // if possible, count one ace as 11 **109** if ( total + 11 + aceCount - 1 <= 21 ) **110** total += 11 + aceCount - 1; **111** else // otherwise, count all aces as 1 **112** total += aceCount; **113** } // end if **114 115** return total; **116** } // end WebMethod getHandValue **117** } // end class Blackjack

**Fig. 28.13** | Blackjack web service that deals cards and evaluates hands. (Part 3 of 3.)  

**1254** Chapter 28 Web Services

Lines 25–37 define method dealCard as a web method. Lines 30–31 use the session object to obtain the "deck" session attribute that was stored in line 70 of method shuffle. Method getAttribute takes as a parameter a String that identifies the Object to obtain from the session state. The HttpSession can store many Objects, provided that each has a unique identifier. Note that method shuffle must be called before method dealCard is called the first time for a client—otherwise, an exception occurs at line 33 because get-

Attribute returns null at lines 30–31. After obtaining the user’s deck, dealCard gets the top card from the deck (line 33), removes it from the deck (line 34) and returns the card’s value as a String (line 36). Without using session tracking, the deck of cards would need to be passed back and forth with each method call. Session tracking makes the dealCard

method easy to call (it requires no arguments) and eliminates the overhead of sending the deck over the network multiple times.

Method getHandValue (lines 74–116) determines the total value of the cards in a hand by trying to attain the highest score possible without going over 21. Recall that an ace can be counted as either 1 or 11, and all face cards count as 10. This method does not use the session object because the deck of cards is not used in this method.

As you’ll soon see, the client application maintains a hand of cards as a String in which each card is separated by a tab character. Line 78 tokenizes the hand of cards (rep- resented by hand) into individual cards by calling String method split and passing to it a String containing the delimiter characters (in this case, just a tab). Method split uses the delimiter characters to separate tokens in the String. Lines 83–103 count the value of each card. Lines 86–87 retrieve the first integer—the face—and use that value in the switch statement (lines 89–102). If the card is an ace, the method increments variable aceCount. We discuss how this variable is used shortly. If the card is an 11, 12 or 13 (jack, queen or king), the method adds 10 to the total value of the hand (line 97). If the card is anything else, the method increases the total by that value (line 100).

Because an ace can have either of two values, additional logic is required to process aces. Lines 106–113 of method getHandValue process the aces after all the other cards. If a hand contains several aces, only one ace can be counted as 11. The condition in line 109 determines whether counting one ace as 11 and the rest as 1 will result in a total that does not exceed 21. If this is possible, line 110 adjusts the total accordingly. Otherwise, line 112 adjusts the total, counting each ace as 1.

Method getHandValue maximizes the value of the current cards without exceeding 21. Imagine, for example, that the dealer has a 7 and receives an ace. The new total could be either 8 or 18. However, getHandValue always maximizes the value of the cards without going over 21, so the new total is 18.

**28.6.2 Consuming the Blackjack Web Service** The blackjack application in Fig. 28.14 keeps track of the player’s and dealer’s cards, and the web service tracks the cards that have been dealt. The constructor (lines 34–83) sets up the GUI (line 36), changes the window’s background color (line 40) and creates the Blackjack web service’s proxy object (lines 46–47). In the GUI, each player has 11 JLa-

bels—the maximum number of cards that can be dealt without automatically exceeding 21 (i.e., four aces, four twos and three threes). These JLabels are placed in an ArrayList

of JLabels, (lines 59–82), so we can index the ArrayList during the game to determine the JLabel that will display a particular card image.  

28.6 Session Tracking in Web Services **1255**

With JAX-WS 2.0, the client application must indicate whether it wants to allow the web service to maintain session information. Lines 50–51 in the constructor perform this task. We first cast the proxy object to interface type BindingProvider. A **BindingPro-**

**vider** enables the client to manipulate the request information that will be sent to the server. This information is stored in an object that implements interface **RequestContext**. The BindingProvider and RequestContext are part of the framework that is created by the IDE when you add a web service client to the application. Next, lines 50–51 invoke the BindingProvider’s **getRequestContext method** to obtain the RequestContext

object. Then the RequestContext’s **put method** is called to set the property BindingPro-

vider.SESSION\_MAINTAIN\_PROPERTY to true, which enables session tracking from the client side so that the web service knows which client is invoking the service’s web methods.

**1** // Fig. 28.14: BlackjackGameJFrame.java **2** // Blackjack game that uses the Blackjack Web Service **3** package com.deitel.iw3htp4.ch28.blackjackclient; **4 5** import java.awt.Color; **6** import java.util.ArrayList; **7** import javax.swing.ImageIcon; **8** import javax.swing.JLabel; **9** import javax.swing.JOptionPane;

**10 11 12 13 14** public class BlackjackGameJFrame extends javax.swing.JFrame **15** { **16** private String playerCards; **17** private String dealerCards; **18** private ArrayList< JLabel > cardboxes; // list of card image JLabels **19** private int currentPlayerCard; // player's current card number **20** private int currentDealerCard; // blackjackProxy's current card number **21 22 23 24** // enumeration of game states **25** private enum GameStatus **26** { **27** PUSH, // game ends in a tie **28** LOSE, // player loses **29** WIN, // player wins **30** BLACKJACK // player has blackjack **31** } // end enum GameStatus **32 33** // no-argument constructor **34** public BlackjackGameJFrame() **35** { **36** initComponents(); **37**

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 1 of 10.)

import javax.xml.ws.BindingProvider; import com.deitel.iw3htp4.ch28.blackjackclient.Blackjack; import com.deitel.iw3htp4.ch28.blackjackclient.BlackjackService;

private BlackjackService blackjackService; // used to obtain proxy private Blackjack blackjackProxy; // used to access the web service  

**1256** Chapter 28 Web Services

**38** // due to a bug in Netbeans, we must change the JFrame's background **39** // color here rather than in the designer **40** getContentPane().setBackground( new Color( 0, 180, 0 ) ); **41 42** // initialize the blackjack proxy **43** try **44** { **45 46 47 48 49 50 51 52** } // end try **53** catch ( Exception e ) **54** { **55** e.printStackTrace(); **56** } // end catch **57 58** // add JLabels to cardBoxes ArrayList for programmatic manipulation **59** cardboxes = new ArrayList< JLabel >(); **60 61** cardboxes.add( 0, dealerCard1JLabel ); **62** cardboxes.add( dealerCard2JLabel ); **63** cardboxes.add( dealerCard3JLabel ); **64** cardboxes.add( dealerCard4JLabel ); **65** cardboxes.add( dealerCard5JLabel ); **66** cardboxes.add( dealerCard6JLabel ); **67** cardboxes.add( dealerCard7JLabel ); **68** cardboxes.add( dealerCard8JLabel ); **69** cardboxes.add( dealerCard9JLabel ); **70** cardboxes.add( dealerCard10JLabel ); **71** cardboxes.add( dealerCard11JLabel ); **72** cardboxes.add( playerCard1JLabel ); **73** cardboxes.add( playerCard2JLabel ); **74** cardboxes.add( playerCard3JLabel ); **75** cardboxes.add( playerCard4JLabel ); **76** cardboxes.add( playerCard5JLabel ); **77** cardboxes.add( playerCard6JLabel ); **78** cardboxes.add( playerCard7JLabel ); **79** cardboxes.add( playerCard8JLabel ); **80** cardboxes.add( playerCard9JLabel ); **81** cardboxes.add( playerCard10JLabel ); **82** cardboxes.add( playerCard11JLabel ); **83** } // end no-argument constructor **84 85** // play the dealer’s hand **86** private void dealerPlay() **87** { **88** try **89** {

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 2 of 10.)

// create the objects for accessing the Blackjack web service blackjackService = new BlackjackService(); blackjackProxy = blackjackService.getBlackjackPort();

// enable session tracking ( ( BindingProvider ) blackjackProxy ).getRequestContext().put(

BindingProvider.SESSION\_MAINTAIN\_PROPERTY, true );  

28.6 Session Tracking in Web Services **1257**

**90** // while the value of the dealer's hand is below 17 **91** // the dealer must continue to take cards **92** String\[\] cards = dealerCards.split( "\\t" ); **93 94** // display dealer's cards **95** for ( int i = 0; i < cards.length; i++ ) **96** displayCard( i, cards\[ i \]); **97 98 99** { **100 101** dealerCards += "\\t" + newCard; // deal new card **102** displayCard( currentDealerCard, newCard ); **103** ++currentDealerCard; **104** JOptionPane.showMessageDialog( this, "Dealer takes a card", **105** "Dealer's turn", JOptionPane.PLAIN\_MESSAGE ); **106** } // end while **107 108 109 110 111** // if dealer busted, player wins **112** if ( dealersTotal > 21 ) **113** { **114** gameOver( GameStatus.WIN ); **115** return; **116** } // end if **117 118** // if dealer and player are below 21 **119** // higher score wins, equal scores is a push **120** if ( dealersTotal > playersTotal ) **121** gameOver( GameStatus.LOSE ); **122** else if ( dealersTotal < playersTotal ) **123** gameOver( GameStatus.WIN ); **124** else **125** gameOver( GameStatus.PUSH ); **126** } // end try **127** catch ( Exception e ) **128** { **129** e.printStackTrace(); **130** } // end catch **131** } // end method dealerPlay **132 133** // displays the card represented by cardValue in specified JLabel **134** public void displayCard( int card, String cardValue ) **135** { **136** try **137** { **138** // retrieve correct JLabel from cardBoxes **139** JLabel displayLabel = cardboxes.get( card ); **140**

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 3 of 10.)

while ( blackjackProxy.getHandValue( dealerCards ) < 17 )

String newCard = blackjackProxy.dealCard();

int dealersTotal = blackjackProxy.getHandValue( dealerCards ); int playersTotal = blackjackProxy.getHandValue( playerCards );  

**1258** Chapter 28 Web Services

**141** // if string representing card is empty, display back of card **142** if ( cardValue.equals( "" ) ) **143** { **144** displayLabel.setIcon( new ImageIcon( getClass().getResource( **145** "/com/deitel/iw3htp4/ch28/blackjackclient/" + **146** "blackjack\_images/cardback.png" ) ) ) ; **147** return; **148** } // end if **149 150** // retrieve the face value of the card **151** String face = cardValue.substring( 0, cardValue.indexOf( " " ) ); **152 153** // retrieve the suit of the card **154** String suit = **155** cardValue.substring( cardValue. indexOf( " " ) + 1 ); **156 157** char suitLetter; // suit letter used to form image file **158 159** switch ( Integer.parseInt( suit ) ) **160** { **161** case 0: // hearts **162** suitLetter = 'h'; **163** break; **164** case 1: // diamonds **165** suitLetter = 'd'; **166** break; **167** case 2: // clubs **168** suitLetter = 'c'; **169** break; **170** default: // spades **171** suitLetter = 's'; **172** break; **173** } // end switch **174 175** // set image for displayLabel **176** displayLabel.setIcon( new ImageIcon( getClass().getResource( **177** "/com/deitel/iw3htp4/ch28/blackjackclient/blackjack\_images/" + **178** face + suitLetter + ".png" ) ) ); **179** } // end try **180** catch ( Exception e ) **181** { **182** e.printStackTrace(); **183** } // end catch **184** } // end method displayCard **185 186** // displays all player cards and shows appropriate message **187** public void gameOver( GameStatus winner ) **188** { **189** String\[\] cards = dealerCards.split( "\\t" ); **190 191** // display blackjackProxy's cards **192** for ( int i = 0; i < cards.length; i++ ) **193** displayCard( i, cards\[ i \]);

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 4 of 10.)  

28.6 Session Tracking in Web Services **1259**

**194 195** // display appropriate status image **196** if ( winner == GameStatus.WIN ) **197** statusJLabel.setText( "You win!" ); **198** else if ( winner == GameStatus.LOSE ) **199** statusJLabel.setText( "You lose." ); **200** else if ( winner == GameStatus.PUSH ) **201** statusJLabel.setText( "It's a push." ); **202** else // blackjack **203** statusJLabel.setText( "Blackjack!" ); **204 205** // display final scores **206 207 208** dealerTotalJLabel.setText( "Dealer: " + dealersTotal ); **209** playerTotalJLabel.setText( "Player: " + playersTotal ); **210 211** // reset for new game **212** standJButton.setEnabled( false ); **213** hitJButton.setEnabled( false ); **214** dealJButton.setEnabled( true ); **215** } // end method gameOver **216 217 218 219 220 221 532** // handles standJButton click **533** private void standJButtonActionPerformed( **534** java.awt.event.ActionEvent evt ) **535** { **536** standJButton.setEnabled( false ); **537** hitJButton.setEnabled( false ); **538** dealJButton.setEnabled( true ); **539** dealerPlay(); **540** } // end method standJButtonActionPerformed **541 542** // handles hitJButton click **543** private void hitJButtonActionPerformed( **544** java.awt.event.ActionEvent evt ) **545** { **546** // get player another card **547 548** playerCards += "\\t" + card; // add card to hand **549 550** // update GUI to display new card **551** displayCard( currentPlayerCard, card ); **552** ++currentPlayerCard; **553 554** // determine new value of player's hand **555 556**

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 5 of 10.)

int dealersTotal = blackjackProxy.getHandValue( dealerCards ); int playersTotal = blackjackProxy.getHandValue( playerCards );

// The initComponents method is autogenerated by Netbeans and is called // from the constructor to initialize the GUI. This method is not shown // here to save space. Open BlackjackGameJFrame.java in this // example's folder to view the complete generated code (lines 221-531)

String card = blackjackProxy.dealCard(); // deal new card

int total = blackjackProxy.getHandValue( playerCards );  

**1260** Chapter 28 Web Services

**557** if ( total > 21 ) // player busts **558** gameOver( GameStatus.LOSE ); **559** if ( total == 21 ) // player cannot take any more cards **560** { **561** hitJButton.setEnabled( false ); **562** dealerPlay(); **563** } // end if **564** } // end method hitJButtonActionPerformed **565 566** // handles dealJButton click **567** private void dealJButtonActionPerformed( **568** java.awt.event.ActionEvent evt ) **569** { **570** String card; // stores a card temporarily until it's added to a hand **571 572** // clear card images **573** for ( int i = 0; i < cardboxes.size(); i++ ) **574** cardboxes.get( i ).setIcon( null ); **575 576** statusJLabel.setText( "" ); **577** dealerTotalJLabel.setText( "" ); **578** playerTotalJLabel.setText( "" ); **579 580** // create a new, shuffled deck on remote machine **581 582 583** // deal two cards to player **584 585** displayCard( 11, playerCards ); // display first card **586 587** displayCard( 12, card ); // display second card **588** playerCards += "\\t" + card; // add second card to hand **589 590** // deal two cards to blackjackProxy, but only show first **591 592** displayCard( 0, dealerCards ); // display first card **593 594** displayCard( 1, "" ); // display back of card **595** dealerCards += "\\t" + card; // add second card to hand **596 597** standJButton.setEnabled( true ); **598** hitJButton.setEnabled( true ); **599** dealJButton.setEnabled( false ); **600 601** // determine the value of the two hands **602 603 604 605** // if hands both equal 21, it is a push **606** if ( playersTotal == dealersTotal && playersTotal == 21 ) **607** gameOver( GameStatus.PUSH ); **608** else if ( dealersTotal == 21 ) // blackjackProxy has blackjack **609** gameOver( GameStatus.LOSE );

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 6 of 10.)

blackjackProxy.shuffle();

playerCards = blackjackProxy.dealCard(); // add first card to hand

card = blackjackProxy.dealCard(); // deal second card

dealerCards = blackjackProxy.dealCard(); // add first card to hand

card = blackjackProxy.dealCard(); // deal second card

int dealersTotal = blackjackProxy.getHandValue( dealerCards ); int playersTotal = blackjackProxy.getHandValue( playerCards );  

28.6 Session Tracking in Web Services **1261**

**610** else if ( playersTotal == 21 ) // blackjack **611** gameOver( GameStatus.BLACKJACK ); **612 613** // next card for blackjackProxy has index 2 **614** currentDealerCard = 2; **615 616** // next card for player has index 13 **617** currentPlayerCard = 13; **618** } // end method dealJButtonActionPerformed **619 620** // begins application execution **621** public static void main( String args\[\] ) **622** { **623** java.awt.EventQueue.invokeLater( **624** new Runnable() **625** { **626** public void run() **627** { **628** new BlackjackGameJFrame().setVisible(true); **629** } **630** } **631** ); // end call to java.awt.EventQueue.invokeLater **632** } // end method main **633 634** // Variables declaration - do not modify **635** private javax.swing.JButton dealJButton; **636** private javax.swing.JLabel dealerCard10JLabel; **637** private javax.swing.JLabel dealerCard11JLabel; **638** private javax.swing.JLabel dealerCard1JLabel; **639** private javax.swing.JLabel dealerCard2JLabel; **640** private javax.swing.JLabel dealerCard3JLabel; **641** private javax.swing.JLabel dealerCard4JLabel; **642** private javax.swing.JLabel dealerCard5JLabel; **643** private javax.swing.JLabel dealerCard6JLabel; **644** private javax.swing.JLabel dealerCard7JLabel; **645** private javax.swing.JLabel dealerCard8JLabel; **646** private javax.swing.JLabel dealerCard9JLabel; **647** private javax.swing.JLabel dealerJLabel; **648** private javax.swing.JLabel dealerTotalJLabel; **649** private javax.swing.JButton hitJButton; **650** private javax.swing.JLabel playerCard10JLabel; **651** private javax.swing.JLabel playerCard11JLabel; **652** private javax.swing.JLabel playerCard1JLabel; **653** private javax.swing.JLabel playerCard2JLabel; **654** private javax.swing.JLabel playerCard3JLabel; **655** private javax.swing.JLabel playerCard4JLabel; **656** private javax.swing.JLabel playerCard5JLabel; **657** private javax.swing.JLabel playerCard6JLabel; **658** private javax.swing.JLabel playerCard7JLabel; **659** private javax.swing.JLabel playerCard8JLabel; **660** private javax.swing.JLabel playerCard9JLabel; **661** private javax.swing.JLabel playerJLabel; **662** private javax.swing.JLabel playerTotalJLabel;

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 7 of 10.)  

**1262** Chapter 28 Web Services

**663** private javax.swing.JButton standJButton; **664** private javax.swing.JLabel statusJLabel; **665** // End of variables declaration **666** } // end class BlackjackGameJFrame

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 8 of 10.)

a) Dealer and player hands after the user clicks the **Deal** JButton.

b) Dealer and player hands after the user clicks **Hit** twice, then clicks **Stand**. In this case, the player wins.  

28.6 Session Tracking in Web Services **1263**

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 9 of 10.)

c) Dealer and player hands after the user clicks **Stand** based on the initial hand. In this case, the player loses.

d) Dealer and player hands after the user is dealt blackjack.  

**1264** Chapter 28 Web Services

Method gameOver (lines 187–215) displays all the dealer’s cards, shows the appro- priate message in statusJLabel and displays the final point totals of both the dealer and the player. Method gameOver receives as an argument a member of the GameStatus enu- meration (defined in lines 25–31). The enumeration represents whether the player tied, lost or won the game; its four members are PUSH, LOSE, WIN and BLACKJACK.

When the player clicks the **Deal** JButton, method dealJButtonActionPerformed

(lines 567–618) clears all of the JLabels that display cards or game status information. Next, the deck is shuffled (line 581), and the player and dealer receive two cards each (lines 584–595). Lines 602–603 then total each hand. If the player and the dealer both obtain scores of 21, the program calls method gameOver, passing GameStatus.PUSH (line 607). If only the dealer has 21, the program passes GameStatus.LOSE to method gameOver (line 609). If only the player has 21 after the first two cards are dealt, the program passes GameStatus.BLACKJACK to method gameOver (line 611).

If dealJButtonActionPerformed does not call gameOver, the player can take more cards by clicking the **Hit** JButton, which calls hitJButtonActionPerformed in lines 543– 564. Each time a player clicks **Hit**, the program deals the player one more card and displays it in the GUI. If the player exceeds 21, the game is over and the player loses. If the player has exactly 21, the player is not allowed to take any more cards, and method dealerPlay

(lines 86–131) is called, causing the dealer to take cards until the dealer’s hand has a value of 17 or more (lines 98–106). If the dealer exceeds 21, the player wins (line 114); other- wise, the values of the hands are compared, and gameOver is called with the appropriate argument (lines 120–125).

Clicking the **Stand** JButton indicates that a player does not want to be dealt another card. Method standJButtonActionPerformed (lines 533–540) disables the **Hit** and **Stand** buttons, enables the **Deal** button, then calls method dealerPlay.

**Fig. 28.14** | Blackjack game that uses the Blackjack web service. (Part 10 of 10.)

e) Dealer and player hands after the dealer is dealt blackjack.  

28.7 Consuming a Database-Driven Web Service from a Web Application **1265**

Method displayCard (lines 134–184) updates the GUI to display a newly dealt card. The method takes as arguments an integer index for the JLabel in the ArrayList that must have its image set and a String representing the card. An empty String indicates that we wish to display the card face down. If method displayCard receives a String that’s not empty, the program extracts the face and suit from the String and uses this informa- tion to display the correct image. The switch statement (lines 159–173) converts the number representing the suit to an integer and assigns the appropriate character to suit-

Letter (h for hearts, d for diamonds, c for clubs and s for spades). The character in suit-

Letter is used to complete the image’s filename (lines 176–178). In this example, you learned how to set up a web service to support session handling

so that you could keep track of each client’s session state. You also learned how to indicate from a desktop client application that it wishes to take part in session tracking. You’ll now learn how to access a database from a web service and how to consume a web service from a client web application.

**28.7 Consuming a Database-Driven Web Service from a Web Application** Our prior examples accessed web services from desktop applications created in Netbeans. However, we can just as easily use them in web applications created with Netbeans. In fact, because web-based businesses are becoming increasingly prevalent, it is common for web applications to consume web services. In this section, we present an airline reservation web service that receives information regarding the type of seat a customer wishes to reserve and makes a reservation if such a seat is available. Later in the section, we present a web appli- cation that allows a customer to specify a reservation request, then uses the airline reserva- tion web service to attempt to execute the request.

**28.7.1 Configuring Java DB in Netbeans and Creating the Reservation Database** In this example, our web service uses a Reservation database containing a single table named Seats to locate a seat matching a client’s request. To build the Reservation data- base, review the steps presented in Section 27.2.1 for building the AddressBook database. This chapters examples directory contains a SQL script to build the Seats table and pop- ulate it with sample data. The sample data is shown in Fig. 28.15.

**Number Location Class Taken**

1 Aisle Economy 0

2 Aisle Economy 0

3 Aisle First 0

4 Middle Economy 0

5 Middle Economy 0

**Fig. 28.15** | Seats table’s data. (Part 1 of 2.)  

**1266** Chapter 28 Web Services

**_Creating the Reservation Web Service_** You can now create a web service that uses the Reservation database (Fig. 28.16). The airline reservation web service has a single web method—reserve (lines 26–78)—which searches the Seats table to locate a seat matching a user’s request. The method takes two arguments—a String representing the desired seat type (i.e., "Window", "Middle" or "Aisle") and a String representing the desired class type (i.e., "Economy" or "First"). If it finds an appropriate seat, method reserve updates the database to make the reservation and returns true; otherwise, no reservation is made, and the method returns false. Note that the statements at lines 34–39 and lines 44–48 that query and update the database use objects of JDBC types ResultSet and PreparedStatement.

**Software Engineering Observation 28.1** _Using PreparedStatements to create SQL statements is highly recommended to secure against so-called SQL injection attacks in which executable code is inserted SQL code. The site www.owasp.org/index.php/Preventing\_SQL\_Injection\_in\_Java provides a summary of SQL injection attacks and ways to mitigate against them.._ 28.1

Our database contains four columns—the seat number (i.e., 1–10), the seat type (i.e., Window, Middle or Aisle), the class type (i.e., Economy or First) and a column containing either 1 (true) or 0 (false) to indicate whether the seat is taken. Lines 34–39 retrieve the seat numbers of any available seats matching the requested seat and class type. This state- ment fills the resultSet with the results of the query

SELECT "NUMBER" FROM "SEATS" WHERE ("TAKEN" = 0) AND ("TYPE" = _type_) AND ("CLASS" = _class_)

The parameters _type_ and _class_ in the query are replaced with values of method reserve’s seatType and classType parameters. When you use the Netbeans tools to create a data- base table and its columns, the Netbeans tools automatically place the table and column names in double quotes. For this reason, you must place the table and column names in double quotes in the SQL statements that interact with the Reservation database.

If resultSet is not empty (i.e., at least one seat is available that matches the selected criteria), the condition in line 42 is true and the web service reserves the first matching seat number. Recall that ResultSet method next returns true if a nonempty row exists, and positions the cursor on that row. We obtain the seat number (line 44) by accessing

6 Middle First 0

7 Window Economy 0

8 Window Economy 0

9 Window First 0

10 Window First 0

**Number Location Class Taken**

**Fig. 28.15** | Seats table’s data. (Part 2 of 2.)  

28.7 Consuming a Database-Driven Web Service from a Web Application **1267**

resultSet’s first column (i.e., resultSet.getInt(1)—the first column in the row). Then lines 45–48 configure a PreparedStatement and execute the SQL:

UPDATE "SEATS" SET "TAKEN" = 1 WHERE ("NUMBER" = _number_)

which marks the seat as taken in the database. The parameter _number_ is replaced with the value of seat. Method reserve returns true (line 49) to indicate that the reservation was successful. If there are no matching seats, or if an exception occurred, method reserve re- turns false (lines 52, 57, 62 and 75) to indicate that no seats matched the user’s request.

**1** // Fig. 28.16: Reservation.java **2** // Airline reservation web service. **3** package com.deitel.iw3htp4.ch28.reservation; **4 5 6 7 8 9**

**10** import javax.jws.WebService; **11** import javax.jws.WebMethod; **12** import javax.jws.WebParam; **13 14** @WebService( name = "Reservation", serviceName = "ReservationService" ) **15** public class Reservation **16** { **17 18 19 20 21 22 23 24 25** // a WebMethod that can reserve a seat **26** @WebMethod( operationName = "reserve" ) **27** public boolean reserve( @WebParam( name = "seatType" ) String seatType, **28** @WebParam( name = "classType" ) String classType ) **29** { **30** try **31** { **32 33 34 35 36 37 38 39**

**Fig. 28.16** | Airline reservation web service. (Part 1 of 2.)

import java.sql.Connection; import java.sql.PreparedStatement; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.SQLException;

private static final String DATABASE\_URL = "jdbc:derby://localhost:1527/Reservation";

private static final String USERNAME = "iw3htp4"; private static final String PASSWORD = "iw3htp4"; private Connection connection; private PreparedStatement lookupSeat; private PreparedStatement reserveSeat;

connection = DriverManager.getConnection( DATABASE\_URL, USERNAME, PASSWORD );

lookupSeat = connection.prepareStatement( "SELECT \\"NUMBER\\" FROM \\"SEATS\\" WHERE (\\"TAKEN\\" = 0) " + "AND (\\"LOCATION\\" = ?) AND (\\"CLASS\\" = ?)" );

lookupSeat.setString( 1, seatType ); lookupSeat.setString( 2, classType ); ResultSet resultSet = lookupSeat.executeQuery();  

**1268** Chapter 28 Web Services

**28.7.2 Creating a Web Application to Interact with the Reservation Web Service** This section presents a ReservationClient web application that consumes the Reserva-

tion web service. The application allows users to select seats based on class ("Economy" or "First") and location ("Aisle", "Middle" or "Window"), then submit their requests to the airline reservation web service. If the database request is not successful, the application in- structs the user to modify the request and try again. The application presented here was built using the techniques presented in Chapters 26–27. We assume that you’ve already

**40 41** // if requested seat is available, reserve it **42** if ( resultSet.next() ) **43** { **44 45 46 47 48 49** return true; **50** } // end if **51 52** return false; **53** } // end try **54** catch ( SQLException e ) **55** { **56** e.printStackTrace(); **57** return false; **58** } // end catch **59** catch ( Exception e ) **60** { **61** e.printStackTrace(); **62** return false; **63** } // end catch **64** finally **65** { **66** try **67** { **68** lookupSeat.close(); **69** reserveSeat.close(); **70** connection.close(); **71** } // end try **72** catch ( Exception e ) **73** { **74** e.printStackTrace(); **75** return false; **76** } // end catch **77** } // end finally **78** } // end WebMethod reserve **79** } // end class Reservation

**Fig. 28.16** | Airline reservation web service. (Part 2 of 2.)

int seat = resultSet.getInt( 1 ); reserveSeat = connection.prepareStatement(

"UPDATE \\"SEATS\\" SET \\"TAKEN\\"=1 WHERE \\"NUMBER\\"=?" ); reserveSeat.setInt( 1, seat ); reserveSeat.executeUpdate();  

28.7 Consuming a Database-Driven Web Service from a Web Application **1269**

read those chapters, and thus know how to build a web application’s GUI, create event handlers and add properties to a web application’s session bean (Section 27.2.1).

**_Reserve.jsp_** Reserve.jsp (Fig. 28.17) defines two DropDownLists and a Button. The seatTypeDrop-

Down (lines 26–31) displays all the seat types from which users can select. The classType- DropDownList (lines 32–37) provides choices for the class type. Users click the reserveButton (lines 38–42) to submit requests after making selections from the Drop-

DownLists. The page also defines three Labels—instructionLabel (lines 22–25) to dis- play instructions, errorLabel (lines 43–47) to display an appropriate message if no seat matching the user’s selection is available and successLabel (lines 48–51) to indicate a suc- cessful reservation. The page bean file (Fig. 28.18) attaches event handlers to seatType-

DropDown, classTypeDropDown and reserveButton.

**1** <?xml version="1.0" encoding="UTF-8"?> **2 3** <!-- Fig. 28.17 Reserve.jsp --> **4** <!-- JSP that allows a user to select a seat --> **5** <jsp:root version="1.2" **6** xmlns:f="http://java.sun.com/jsf/core" **7** xmlns:h="http://java.sun.com/jsf/html" **8** xmlns:jsp="http://java.sun.com/JSP/Page" **9** xmlns:webuijsf="http://www.sun.com/webui/webuijsf">

**10** <jsp:directive.page contentType="text/html;charset=UTF-8" **11** pageEncoding="UTF-8"/> **12** <f:view> **13** <webuijsf:page binding="#{Reserve.page1}" id="page1"> **14** <webuijsf:html binding="#{Reserve.html1}" id="html1"> **15** <webuijsf:head binding="#{Reserve.head1}" id="head1"> **16** <webuijsf:link binding="#{Reserve.link1}" id="link1" **17** url="/resources/stylesheet.css"/> **18** </webuijsf:head> **19** <webuijsf:body binding="#{Reserve.body1}" id="body1" **20** style="-rave-layout: grid"> **21** <webuijsf:form binding="#{Reserve.form1}" id="form1"> **22** <webuijsf:label binding="#{Reserve.instructionLabel}" **23** id="instructionLabel" style="left: 24px; top: 24px; **24** position: absolute" text="Please select the seat type **25** and class to reserve:"/> **26** <webuijsf:dropDown binding="#{Reserve.seatTypeDropDown}" **27** id="seatTypeDropDown" items= **28** "#{Reserve.seatTypeDropDownDefaultOptions.options}" **29** style="left: 310px; top: 21px; position: absolute" **30** valueChangeListenerExpression= **31** "#{Reserve.seatTypeDropDown\_processValueChange}"/> **32** <webuijsf:dropDown binding="#{Reserve.classTypeDropDown}" **33** id="classTypeDropDown" items= **34** "#{Reserve.classTypeDropDownDefaultOptions.options}" **35** style="left: 385px; top: 21px; position: absolute" **36** valueChangeListenerExpression= **37** "#{Reserve.classTypeDropDown\_processValueChange}"/>

**Fig. 28.17** | JSP that allows a user to select a seat. (Part 1 of 3.)  

**1270** Chapter 28 Web Services

**38** <webuijsf:button actionExpression= **39** "#{Reserve.reserveButton\_action}" binding= **40** "#{Reserve.reserveButton}" id="reserveButton" style= **41** "height: 20px; left: 460px; top: 21px; position: **42** absolute; width: 100px" text="Reserve"/> **43** <webuijsf:label binding="#{Reserve.errorLabel}" **44** id="errorLabel" rendered="false" style="color: red; **45** left: 24px; top: 48px; position: absolute" text="This **46** type of seat is not available. Please modify your **47** request and try again."/> **48** <webuijsf:label binding="#{Reserve.successLabel}" **49** id="successLabel" rendered="false" style="left: 24px; **50** top: 24px; position: absolute" **51** text="Your reservation has been made. Thank you!"/> **52** </webuijsf:form> **53** </webuijsf:body> **54** </webuijsf:html> **55** </webuijsf:page> **56** </f:view> **57** </jsp:root>

**Fig. 28.17** | JSP that allows a user to select a seat. (Part 2 of 3.)

a) Selecting a seat:

b) Seat reserved successfully:

c) Attempting to reserve another window seat in economy when there are no such seats available:  

28.7 Consuming a Database-Driven Web Service from a Web Application **1271**

**_Reserve.java_** Figure 28.18 contains the page bean code that provides the logic for Reserve.jsp. As dis- cussed in Section 26.5.2, the class that represents the page’s bean extends AbstractPage- Bean. When the user selects a value in one of the DropDownLists, the corresponding event handler—classTypeDropDown\_processValueChange (lines 262–267) or seatTypeDrop- Down\_processValueChange (lines 270–275)—is called to set the session properties seat- Type and classType, which we added to the web application’s session bean. The values of these properties are used as the arguments in the call to the web service’s reserve method. When the user clicks **Reserve** in the JSP, the event handler reserveButton\_action (lines 278–311) executes. Lines 282–284 use the proxy object (created in lines 38–39) to invoke the web service’s reserve method, passing the selected seat type and class type as argu- ments. If reserve returns true, lines 288–293 hide the GUI components in the JSP and display the successLabel (line 292) to thank the user for making a reservation; otherwise, lines 297–302 ensure that the GUI components remain displayed and display the error- Label (line 302) to notify the user that the requested seat type is not available and instruct the user to try again.

**1** // Fig. 28.18: Reserve.java **2** // Page scope backing bean class for seat reservation client **3** package com.deitel.iw3htp4.ch28.reservationclient; **4 5** import com.sun.rave.web.ui.appbase.AbstractPageBean; **6** import com.sun.webui.jsf.component.Body; **7** import com.sun.webui.jsf.component.Button; **8** import com.sun.webui.jsf.component.DropDown; **9** import com.sun.webui.jsf.component.Form;

**10** import com.sun.webui.jsf.component.Head; **11** import com.sun.webui.jsf.component.Html; **12** import com.sun.webui.jsf.component.Label; **13** import com.sun.webui.jsf.component.Link; **14** import com.sun.webui.jsf.component.Page; **15** import com.sun.webui.jsf.model.SingleSelectOptionsList; **16** import javax.faces.FacesException; **17** import javax.faces.event.ValueChangeEvent;

**Fig. 28.18** | Page scope backing bean class for seat reservation client. (Part 1 of 3.)

**Fig. 28.17** | JSP that allows a user to select a seat. (Part 3 of 3.)

d) No seats match the requested seat type and class:  

**1272** Chapter 28 Web Services

**18 19 20 21** public class Reserve extends AbstractPageBean **22** { **23** private int \_\_placeholder; **24 25 26 27** private void \_init() throws Exception **28** { **29** seatTypeDropDownDefaultOptions.setOptions( **30** new com.sun.webui.jsf.model.Option\[\] { **31** new com.sun.webui.jsf.model.Option( "Aisle", "Aisle" ), **32** new com.sun.webui.jsf.model.Option( "Middle", "Middle" ), **33** new com.sun.webui.jsf.model.Option( "Window", "Window" ) } ); **34** classTypeDropDownDefaultOptions.setOptions( **35** new com.sun.webui.jsf.model.Option\[\] { **36** new com.sun.webui.jsf.model.Option( "Economy", "Economy" ), **37** new com.sun.webui.jsf.model.Option( "First", "First" ) } ); **38 39 40** } // end method **41 42 43 44 261** // store selected class in session bean **262** public void classTypeDropDown\_processValueChange( **263** ValueChangeEvent event ) **264** { **265 266 267** } // end method classTypeDropDown\_processValueChange **268 269** // store selected seat type in session bean **270** public void seatTypeDropDown\_processValueChange( **271** ValueChangeEvent event ) **272** { **273 274 275** } // end method seatTypeDropDown\_processValueChange **276 277** // invoke the web service when the user clicks Reserve button **278** public String reserveButton\_action() **279** { **280** try **281** { **282 283 284 285**

**Fig. 28.18** | Page scope backing bean class for seat reservation client. (Part 2 of 3.)

import reservationservice.ReservationService; import reservationservice.Reservation;

private ReservationService reservationService; // reference to service private Reservation reservationServiceProxy; // reference to proxy

reservationService = new ReservationService(); reservationServiceProxy = reservationService.getReservationPort();

// Lines 42-260 of the autogenerated code have been removed to save // space. The complete code is available in this example’s folder.

getSessionBean1().setClassType( ( String ) classTypeDropDown.getSelected() );

getSessionBean1().setSeatType( ( String ) seatTypeDropDown.getSelected() );

boolean reserved = reservationServiceProxy.reserve( getSessionBean1().getSeatType(), getSessionBean1().getClassType() );  

28.8 Passing an Object of a User-Defined Type to a Web Service **1273**

**28.8 Passing an Object of a User-Defined Type to a Web Service** The web methods we’ve demonstrated so far each receive and return only primitive values or Strings. Web services also can receive and return objects of user-defined types—known as **custom types**. This section presents an EquationGenerator web service that generates random arithmetic questions of type Equation. The client is a math-tutoring desktop ap- plication in which the user selects the type of mathematical question to attempt (addition, subtraction or multiplication) and the skill level of the user—level 1 uses one-digit num- bers in each question, level 2 uses two-digit numbers and level 3 uses three-digit numbers. The client passes this information to the web service, which then generates an Equation

consisting of random numbers with the proper number of digits. The client application receives the Equation, displays the sample question to the user in a Java application, allows the user to provide an answer and checks the answer to determine whether it is correct.

**_Serialization of User-Defined Types_** We mentioned earlier that all types passed to and from SOAP web services must be sup- ported by SOAP. How, then, can SOAP support a type that is not even created yet? Cus- tom types that are sent to or from a web service are serialized into XML format. This process is referred to as **XML serialization**. The process of serializing objects to XML and deserializing objects from XML is handled for you automatically.

**286** if ( reserved ) // display successLabel; hide all others **287** { **288** instructionLabel.setRendered( false ); **289** seatTypeDropDown.setRendered( false ); **290** classTypeDropDown.setRendered( false ); **291** reserveButton.setRendered( false ); **292** successLabel.setRendered( true ); **293** errorLabel.setRendered( false ); **294** } // end if **295** else // display all but successLabel **296** { **297** instructionLabel.setRendered( true ); **298** seatTypeDropDown.setRendered( true ); **299** classTypeDropDown.setRendered( true ); **300** reserveButton.setRendered( true ); **301** successLabel.setRendered( false ); **302** errorLabel.setRendered( true ); **303** } // end else **304** } // end try **305** catch ( Exception e ) **306** { **307** e.printStackTrace(); **308** } // end catch **309 310** return null; **311** } // end method reserveButton\_action **312** } // end class Reserve

**Fig. 28.18** | Page scope backing bean class for seat reservation client. (Part 3 of 3.)  

**1274** Chapter 28 Web Services

**_Requirements for User-Defined Types Used with Web Methods_** A class that is used to specify parameter or return types in web methods must meet several requirements:

**1\.** It must provide a public default or no-argument constructor. When a web ser- vice or web service consumer receives an XML serialized object, the JAX-WS 2.0 Framework must be able to call this constructor when deserializing the object (i.e., converting it from XML back to a Java object).

**2\.** Instance variables that should be serialized in XML format must have public _set_ and _get_ methods to access the private instance variables (recommended), or the instance variables must be declared public (not recommended).

**3\.** Non-public instance variables that should be serialized must provide both _set_ and _get_ methods (even if they have empty bodies); otherwise, they are not serial- ized.

Any instance variable that is not serialized simply receives its default value (or the value provided by the no-argument constructor) when an object of the class is deserialized.

**Common Programming Error 28.3** _A runtime error occurs if an attempt is made to deserialize an object of a class that does not have a default or no-argument constructor._ 28.3

**_Defining Class Equation_** Figure 28.19 defines class Equation. Lines 18–31 define a constructor that takes three ar- guments—two ints representing the left and right operands and a String that represents the arithmetic operation to perform. The constructor sets the leftOperand, rightOperand and operationType instance variables, then calculates the appropriate result. The no-ar- gument constructor (lines 13–16) calls the three-argument constructor (lines 18–31) and passes default values. We do not use the no-argument constructor explicitly, but the XML serialization mechanism uses it when objects of this class are deserialized. Because we pro- vide a constructor with parameters, we must explicitly define the no-argument constructor in this class so that objects of the class can be passed to or returned from web methods.

**1** // Fig. 28.19: Equation.java **2** // Class Equation that contains information about an equation **3** package com.deitel.iw3htp4.generator; **4 5** public class Equation **6** { **7** private int leftOperand; **8** private int rightOperand; **9** private int resultValue;

**10** private String operationType; **11 12** // required no-argument constructor **13** public Equation() **14** {

**Fig. 28.19** | Class Equation that stores information about an equation. (Part 1 of 3.)  

28.8 Passing an Object of a User-Defined Type to a Web Service **1275**

**15** this( 0, 0, "+" ); **16** } // end no-argument constructor **17 18** public Equation( int leftValue, int rightValue, String type ) **19** { **20** leftOperand = leftValue; **21** rightOperand = rightValue; **22** operationType = type; **23 24** //determine resultValue **25** if ( operationType.equals( "+" ) ) // addition **26** resultValue = leftOperand + rightOperand; **27** else if ( operationType.equals( "-" ) ) // subtraction **28** resultValue = leftOperand - rightOperand; **29** else // multiplication **30** resultValue = leftOperand \* rightOperand; **31** } // end three argument constructor **32 33** // method that overrides Object.toString() **34** public String toString() **35** { **36** return leftOperand + " " + operationType + " " + **37** rightOperand + " = " + resultValue; **38** } // end method toString **39 40** // returns the left hand side of the equation as a String **41** public String getLeftHandSide() **42** { **43** return leftOperand + " " + operationType + " " + rightOperand; **44** } // end method getLeftHandSide **45 46** // returns the right hand side of the equation as a String **47** public String getRightHandSide() **48** { **49** return "" + resultValue; **50** } // end method getRightHandSide **51 52** // gets the leftOperand **53** public int getLeftOperand() **54** { **55** return leftOperand; **56** } // end method getLeftOperand **57 58** // gets the rightOperand **59** public int getRightOperand() **60** { **61** return rightOperand; **62** } // end method getRightOperand **63 64** // gets the resultValue **65** public int getReturnValue() **66** {

**Fig. 28.19** | Class Equation that stores information about an equation. (Part 2 of 3.)  

**1276** Chapter 28 Web Services

Class Equation defines methods getLeftHandSide and setLeftHandSide (lines 41– 44 and 77–80); getRightHandSide and setRightHandSide (lines 47–50 and 83–86); getLeftOperand and setLeftOperand (lines 53–56 and 89–92); getRightOperand and setRightOperand (lines 59–62 and 95–98); getReturnValue and setReturnValue (lines 65–68 and 101–104); and getOperationType and setOperationType (lines 71–74 and

**67** return resultValue; **68** } // end method getResultValue **69 70** // gets the operationType **71** public String getOperationType() **72** { **73** return operationType; **74** } // end method getOperationType **75 76** // required setter **77** public void setLeftHandSide( String value ) **78** { **79** // empty body **80** } // end setLeftHandSide **81 82** // required setter **83** public void setRightHandSide( String value ) **84** { **85** // empty body **86** } // end setRightHandSide **87 88** // required setter **89** public void setLeftOperand( int value ) **90** { **91** // empty body **92** } // end method setLeftOperand **93 94** // required setter **95** public void setRightOperand( int value ) **96** { **97** // empty body **98** } // end method setRightOperand **99 100** // required setter **101** public void setReturnValue( int value ) **102** { **103** // empty body **104** } // end method setResultOperand **105 106** // required setter **107** public void setOperationType( String value ) **108** { **109** // empty body **110** } // end method setOperationType **111** } // end class Equation

**Fig. 28.19** | Class Equation that stores information about an equation. (Part 3 of 3.)  

28.8 Passing an Object of a User-Defined Type to a Web Service **1277**

107–110). The client of the web service does not need to modify the values of the instance variables. However, recall that a property can be serialized only if it has both a _get_ and a _set_ accessor, or if it is public. So we provided _set_ methods with empty bodies for each of the class’s instance variables. Method getLeftHandSide (lines 41–44) returns a String repre- senting everything to the left of the equals (=) sign in the equation, and getRightHandSide

(lines 47–50) returns a String representing everything to the right of the equals (=) sign. Method getLeftOperand (lines 53–56) returns the integer to the left of the operator, and getRightOperand (lines 59–62) returns the integer to the right of the operator. Method getResultValue (lines 65–68) returns the solution to the equation, and getOperation-

Type (lines 71–74) returns the operator in the equation. The client in this example does not use the rightHandSide property, but we included it so future clients can use it.

**_Creating the EquationGenerator Web Service_** Figure 28.20 presents the EquationGenerator web service, which creates random, cus- tomized Equations. This web service contains only method generateEquation (lines 18– 31), which takes two parameters—the mathematical operation (one of "+", "-" or "\*") and an int representing the difficulty level (1–3).

**1** // Fig. 28.20: Generator.java **2** // Web service that generates random equations **3** package com.deitel.iw3htp4.ch28.equationgenerator; **4 5** import java.util.Random; **6** import javax.jws.WebService; **7** import javax.jws.WebMethod; **8** import javax.jws.WebParam; **9**

**10** @WebService( name = "EquationGenerator", **11** serviceName = "EquationGeneratorService" ) **12** public class EquationGenerator **13** { **14** private int minimum; **15** private int maximum; **16 17** // generates a math equation and returns it as an Equation object **18** @WebMethod( operationName = "generateEquation" ) **19** public generateEquation( **20** @WebParam( name = "operation" ) String operation, **21** @WebParam( name = "difficulty" ) int difficulty ) **22** { **23** minimum = ( int ) Math.pow( 10, difficulty - 1 ); **24** maximum = ( int ) Math.pow( 10, difficulty ); **25 26** Random randomObject = new Random(); **27 28 29 30 31** } // end method generateEquation **32** } // end class EquationGenerator

**Fig. 28.20** | Web service that generates random equations.

Equation

return new Equation( randomObject.nextInt( maximum - minimum ) + minimum, randomObject.nextInt( maximum - minimum ) + minimum, operation );  

**1278** Chapter 28 Web Services

**_Testing the EquationGenerator Web Service_** Figure 28.21 shows the result of testing the EquationGenerator service with the Tester

web page. In _Part b_ of the figure, note that the web method’s return value is XML encoded. However, this example differs from previous ones in that the XML specifies the values for all the data of the returned XML serialized object returned. The proxy class receives this return value and deserializes it into an object of class Equation, then passes it to the client.

Note that an Equation object is _not_ being passed between the web service and the client. Rather, the information in the object is being sent as XML-encoded data. Clients created using Java will take the information and create a new Equation object. Clients cre- ated on other platforms, however, may use the information differently. Readers creating clients on other platforms should check the web services documentation for the specific platform they are using, to see how their clients may process custom types.

**_Details of the EquationGenerator Web Service_** Let’s examine web method generateEquation more closely. Lines 23–24 of Fig. 28.20 de- fine the upper and lower bounds of the random numbers that the method uses to generate an Equation. To set these limits, the program first calls static method pow of class Math— this method raises its first argument to the power of its second argument. Variable mini-

mum’s value is determined by raising 10 to a power one less than difficulty (line 23). This calculates the smallest number with difficulty digits. If difficulty is 1, minimum is 1; if difficulty is 2, minimum is 10; and if difficulty is 3, minimum is 100. To calculate the value of maximum (the upper bound for numbers used to form an Equation), the program raises 10 to the power of the specified difficulty argument (line 24). If difficulty is 1, maximum is 10; if difficulty is 2, maximum is 100; and if difficulty is 3, maximum is 1000.

Lines 28–30 create and return a new Equation object consisting of two random num- bers and the String operation received by generateEquation. Random method nextInt

returns an int that is less than the specified upper bound. generateEquation generates operand values that are greater than or equal to minimum but less than maximum (i.e., a number with difficulty number of digits).

**Fig. 28.21** | Testing a web method that returns an XML serialized Equation object. (Part 1 of 2.)

a) Using the EquationGenerator web service’s Tester web page to generate an Equation.  

28.8 Passing an Object of a User-Defined Type to a Web Service **1279**

**_Consuming the EquationGenerator Web Service_** The **Math Tutor** application (Fig. 28.22) uses the EquationGenerator web service. The ap- plication calls the web service’s generateEquation method to create an Equation object.

**Fig. 28.21** | Testing a web method that returns an XML serialized Equation object. (Part 2 of 2.)

b) Result of generating an Equation.  

**1280** Chapter 28 Web Services

The tutor then displays the left-hand side of the Equation and waits for user input. Line 9 declares a GeneratorService instance variable that we use to obtain an EquationGener-

ator proxy object. Lines 10–11 declare instance variables of types EquationGenerator

and Equation.

**1** // Fig. 28.22: EquationGeneratorClientJFrame.java **2** // Math tutoring program using web services to generate equations **3** package com.deitel.iw3htp4.ch28.equationgeneratorclient; **4 5** import javax.swing.JOptionPane; **6 7** public class EquationGeneratorClientJFrame extends javax.swing.JFrame **8** { **9** private EquationGeneratorService service; // used to obtain proxy

**10** private EquationGenerator proxy; // used to access the web service **11 12** private int answer; // the user's answer to the question **13** private String operation = "+"; // mathematical operation +, - or \* **14** private int difficulty = 1; // 1, 2 or 3 digits in each number **15 16** // no-argument constructor **17** public EquationGeneratorClientJFrame() **18** { **19** initComponents(); **20 21** try **22** { **23** // create the objects for accessing the EquationGenerator service **24** service = new EquationGeneratorService(); **25** proxy = service.getEquationGeneratorPort(); **26** } // end try **27** catch ( Exception ex ) **28** { **29** ex.printStackTrace(); **30** } // end catch **31** } // end no-argument constructors **32 33 34 35 36 37 38** // obtains the difficulty level selected by the user **39** private void levelJComboBoxItemStateChanged( **40** java.awt.event.ItemEvent evt ) **41** { **42** // indices start at 0, so add 1 to get the difficulty level **43** difficulty = levelJComboBox.getSelectedIndex() + 1; **44** } // end method levelJComboBoxItemStateChanged **45**

**Fig. 28.22** | Math tutoring application. (Part 1 of 4.)

private Equation equation; // represents an equation

// The initComponents method is autogenerated by Netbeans and is called // from the constructor to initialize the GUI. This method is not shown // here to save space. Open EquationGeneratorClientJFrame.java in this // example's folder to view the complete generated code (lines 37-156).  

28.8 Passing an Object of a User-Defined Type to a Web Service **1281**

**46** // obtains the mathematical operation selected by the user **47** private void operationJComboBoxItemStateChanged( **48** java.awt.event.ItemEvent evt ) **49** { **50** String item = ( String ) operationJComboBox.getSelectedItem(); **51 52** if ( item.equals( "Addition" ) ) **53** operation = "+"; // user selected addition **54** else if ( item.equals( "Subtraction" ) ) **55** operation = "-"; // user selected subtraction **56** else **57** operation = "\*"; // user selected multiplication **58** } // end method operationJComboBoxItemStateChanged **59 60** // checks the user's answer **61** private void checkAnswerJButtonActionPerformed( **62** java.awt.event.ActionEvent evt ) **63** { **64** if ( answerJTextField.getText().equals( "" ) ) **65** { **66** JOptionPane.showMessageDialog( **67** this, "Please enter your answer." ); **68** } // end if **69 70** int userAnswer = Integer.parseInt( answerJTextField.getText() ); **71 72** if ( userAnswer == answer ) **73** { **74** equationJLabel.setText( "" ); **75** answerJTextField.setText( "" ); **76** checkAnswerJButton.setEnabled( false ); **77** JOptionPane.showMessageDialog( this, "Correct! Good Job!", **78** "Correct", JOptionPane.PLAIN\_MESSAGE ); **79** } // end if **80** else **81** { **82** JOptionPane.showMessageDialog( this, "Incorrect. Try again.", **83** "Incorrect", JOptionPane.PLAIN\_MESSAGE ); **84** } // end else **85** } // end method checkAnswerJButtonActionPerformed **86 87** // generates a new Equation based on user's selections **88** private void generateJButtonActionPerformed( **89** java.awt.event.ActionEvent evt ) **90** { **91** try **92** { **93 94 95 96** checkAnswerJButton.setEnabled( true ); **97** } // end try

**Fig. 28.22** | Math tutoring application. (Part 2 of 4.)

equation = proxy.generateEquation( operation, difficulty ); answer = equation.getReturnValue(); equationJLabel.setText( equation.getLeftHandSide() + " =" );  

**1282** Chapter 28 Web Services

**98** catch ( Exception e ) **99** { **100** e.printStackTrace(); **101** } // end catch **102** } // end method generateJButtonActionPerformed **103 104** // begins program execution **105** public static void main( String args\[\] ) **106** { **107** java.awt.EventQueue.invokeLater( **108** new Runnable() **109** { **110** public void run() **111** { **112** new EquationGeneratorClientJFrame().setVisible( true ); **113** } // end method run **114** } // end anonymous inner class **115** ); // end call to java.awt.EventQueue.invokeLater **116** } // end method main **117 118** // Variables declaration - do not modify **119** private javax.swing.JLabel answerJLabel; **120** private javax.swing.JTextField answerJTextField; **121** private javax.swing.JButton checkAnswerJButton; **122** private javax.swing.JLabel equationJLabel; **123** private javax.swing.JButton generateJButton; **124** private javax.swing.JComboBox levelJComboBox; **125** private javax.swing.JLabel levelJLabel; **126** private javax.swing.JComboBox operationJComboBox; **127** private javax.swing.JLabel operationJLabel; **128** private javax.swing.JLabel questionJLabel; **129** // End of variables declaration **130** } // end class EquationGeneratorClientJFrame

**Fig. 28.22** | Math tutoring application. (Part 3 of 4.)  

28.9 REST-Based Web Services in ASP.NET **1283**

After displaying an equation, the application waits for the user to enter an answer. The default setting for the difficulty level is **One-digit numbers**, but the user can change this by choosing a level from the **Choose level** JComboBox. Clicking any of the levels invokes levelJComboBoxItemStateChanged (lines 158–163), which sets the variable difficulty

to the level selected by the user. Although the default setting for the question type is **Addi- tion**, the user also can change this by selecting an operation from the **Choose operation** JComboBox. Doing so invokes operationJComboBoxItemStateChanged (lines 166–177), which sets the String operation to the appropriate mathematical symbol.

When the user clicks the **Generate Equation** JButton, method generateButton-

ActionPerformed (lines 207–221) invokes the EquationGenerator web service’s gener- ateEquation (line 212) method. After receiving an Equation object from the web service, the handler displays the left-hand side of the equation in equationJLabel (line 214) and enables the checkAnswerJButton so that the user can submit an answer. When the user clicks the **Check Answer** JButton, method checkAnswerJButtonActionPerformed (lines 180–204) determines whether the user provided the correct answer.

**28.9 REST-Based Web Services in ASP.NET** \[_Note:_ This section assumes you already know ASP.NET (Chapter 25).\] In this section, we discuss how to build ASP.NET REST-based web services. **Representational State Transfer (REST)** (originally proposed in Roy Thomas Fielding’s doctoral dissertation1) refers to an architectural style for implementing web services. Though REST is not a stan- dard, RESTful web services are implemented using web standards, such as HTTP, XML and JSON. Each operation in a RESTful web service is easily identified by a unique URL. So, when the server receives a request, it immediately knows what operation to perform. Such web services can be invoked from a program or directly from a web browser by en- tering the URL in the browser’s address field. In some cases, the results of a particular op- eration may be cached locally by the browser. This can make subsequent requests for the same operation faster by loading the result directly from the browser’s cache.2 Many Web 2.0 web services provide RESTful interfaces.3

1\. Fielding, R. T. “Architectural Styles and the Design of Network-based Software Architectures.” <http://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm>.

2\. Costello, R. “REST Tutorial.” _xFront_, 26 June 2002 <http://www.xfront.com/REST.html>. 3. Richardson, L. and S. Ruby. _RESTful Web Services_. O’Reilly, 2007.

**Fig. 28.22** | Math tutoring application. (Part 4 of 4.)  

**1284** Chapter 28 Web Services

We use ASP.NET here because it provides a simple way to build REST-based web services. We take advantage of the tools provided in Microsoft’s Visual Web Developer 2005 Express, which you can download from msdn.microsoft.com/vstudio/express. The example in this section is the web service that we consumed in our Calendar applica- tion from Fig. 15.11 in the Ajax chapter.

**28.9.1 REST-Based Web Service Functionality** Figure 28.23 presents the code-behind file for the CalendarSevice web service that you’ll build in Section 28.9.2. When creating a web service in Visual Web Developer, you work almost exclusively in the code-behind file. This web service is designed to give the client access to a database of events. A client can access all events that occur on a specific day us- ing the getItemsByDate method or request a specific event using the getItemById meth- od. In addition, the client can modify an event by calling the Save method.

**1** ' Fig. 28.23 CalendarService.vb **2** ' REST-based event web service. **3** Imports System.Web **4** Imports System.Web.Services **5** Imports System.Web.Services.Protocols **6** Imports System.Data ' Used to access a database **7** Imports System.Web.Script.Serialization ' Used to return JSON **8 9** <WebService(Namespace:="http://www.deitel.com/")> \_

**10** <WebServiceBinding(ConformsTo:=WsiProfiles.BasicProfile1\_1)> \_ **11** <Global.Microsoft.VisualBasic.CompilerServices.DesignerGenerated()> \_ **12** Public Class CalendarService **13** Inherits System.Web.Services.WebService **14 15** ' variables used to access the database **16** Private calendarDataSet As New CalendarDataSet() **17** Private eventsTableAdapter As \_ **18** New CalendarDataSetTableAdapters.EventsTableAdapter() **19 20** ' retrieve the event from the database given an id **21** <WebMethod(Description:="Gets a list of events for a given id.")> \_ **22** Public Sub getItemById(ByVal id As Integer) **23** ' set up the data set **24** eventsTableAdapter.FillById(calendarDataSet.Events, id) **25 26** ' insert the data into an Item object. **27** Dim identification As String = calendarDataSet.Events(0).ID **28** Dim description As String = calendarDataSet.Events(0).Description **29** Dim itemObject As New Item(identification, description) **30 31** ' convert the data to JSON and send it back to the client **32** Dim serializer As JavaScriptSerializer = New JavaScriptSerializer() **33** Dim response As String = serializer.Serialize(itemObject) **34** HttpContext.Current.Response.Write(response) ' send to client **35** End Sub ' getItemById **36**

**Fig. 28.23** | REST-based event web service. (Part 1 of 2.)  

28.9 REST-Based Web Services in ASP.NET **1285**

Lines 3–7 import all the necessary libraries for b. Lines 3–5 are generated by Visual Web Developer for every web service. Line 6 enables us to use capabilities for interacting with databases. Line 7 imports the System.Web.Script.Serialization namespace, which provides tools to convert .NET objects into JSON strings.

Line 9 contains a **WebService** attribute. Attaching this attribute to a web service class indicates that the class implements a web service and allows you to specify the web service’s namespace. We specify http://www.deitel.com as the web service’s namespace using the WebService attribute’s **Namespace** property.

Visual Web Developer places line 10 in all newly created web services. This line indi- cates that the web service conforms to the **Basic Profile 1.1** (**BP 1.1**) developed by the **Web Services Interoperability Organization** (**WS-I**), a group dedicated to promoting interoper- ability among web services developed on different platforms with different programming languages. BP 1.1 is a document that defines best practices for various aspects of web service creation and consumption (www.WS-I.org). Setting the **WebServiceBinding** attribute’s **ConformsTo** property to **WsiProfiles.BasicProfile1\_1** instructs Visual Web Developer to perform its “behind-the-scenes” work, such as generating WSDL file and the ASMX file

**37** ' retrieve the list of events that occur on a specific date **38** <WebMethod(Description:="Gets a list of events for a given date.")> \_ **39** Public Sub getItemsByDate(ByVal eventDate As String) **40** eventsTableAdapter.FillByDate(calendarDataSet.Events, eventDate) **41** Dim identification As String ' string used to store the id **42** Dim description As String ' string used to store the description **43** Dim eventRow As DataRow ' used to iterate over the DataSet **44** Dim length As Integer = calendarDataSet.Events.Rows.Count **45** Dim itemObject As = New Item(0 To length - 1) {} ' initialize array **46** Dim count As Integer = 0 **47 48** ' insert the data into an array of Item objects **49** For Each eventRow In calendarDataSet.Events.Rows **50** identification = eventRow.Item("ID") **51** description = eventRow.Item("Description") **52** itemObject(count) = New Item(identification, description) **53** count += 1 **54** Next **55 56** ' convert the data to JSON and send it back to the client **57** Dim serializer As New JavaScriptSerializer() **58** Dim response As String = serializer.Serialize(itemObject) **59** HttpContext.Current.Response.Write(response) **60** End Sub ' getItemsByDate **61 62** ' modify the description of the event with the given id **63** <WebMethod(Description:="Updates an event’s description.")> \_ **64** Public Sub Save(ByVal id As String, ByVal descr As String) **65** eventsTableAdapter.UpdateDescription(descr, id) **66** getItemById(id) **67** End Sub ' Save **68** End Class ' CalendarService

**Fig. 28.23** | REST-based event web service. (Part 2 of 2.)  

**1286** Chapter 28 Web Services

(which provides access to the web service) in conformance with the guidelines laid out in BP 1.1. For more information on web services interoperability and the Basic Profile 1.1, visit the WS-I web site at www.ws-i.org.

By default, each new web service class created in Visual Web Developer inherits from class System.Web.Services.WebService (line 13). Although a web service need not do this, class WebService provides members that are useful in determining information about the client and the web service itself. All methods in class CalendarService are tagged with the **WebMethod attribute** (lines 21, 38 and 63), which exposes a method so that it can be called remotely (similar to Java’s @WebMethod annotation that you learned earlier in this chapter).

**_Accessing the Database_** Lines 16–18 create the calendarDataSet and eventsTableAdapter objects that are used to access the database. The classes CalendarDataSet and CalendarDataSetTableAdapt-

er.EventsTableAdapter are created for you when you use Visual Web Developer’s **DataSet Designer** to add a DataSet to a project. Section 28.9.3 discusses the steps for this.

Our database has one table called Events containing three columns—the numeric ID of an event, the Date on which the event occurs and the event’s Description. Line 24 calls the method FillById, which fills the calendarDataSet with results of the query

SELECT ID, Description FROM Events WHERE (ID = @id)

The parameter @id is replaced with the id that was passed from the client, which we pass as an argument to the FillById method. Lines 27–29 store the results of the query in the variable of class Item, which will be defined shortly. An Item object stores the id and the description of an event. The id and description are obtained by accessing the ID and De-

scription values of the first row of the calendarDataSet. Line 40 calls the method FillByDate which fills the CalendarDataSet with results

of the query

SELECT ID, Description FROM Events WHERE (Date = @date)

The parameter @date is replaced with the eventDate that was passed from the client, which we pass as an argument to the FillByDate method. Lines 49–54 iterate over the rows in the calendarDataSet and store the ID and Description values in an array of Items.

Line 65 calls method UpdateDescription which modifies the database with the UPDATE statement.

UPDATE Events SET Description = @descr WHERE (ID = @id)

The parameters @descr and @id are replaced with arguments passed from the client to the updateDescription method.  

28.9 REST-Based Web Services in ASP.NET **1287**

**_Responses Formatted as JSON_** The web service uses JSON (discussed in Section 15.7) to pass data to the client. To return JSON data, we must first create a class to define objects which will be converted into JSON format. Figure 28.24 defines a simple Item class that contains Description and ID

members, and two constructors. The Description and ID are declared as Public members so that Item objects can be properly converted to JSON.

**Common Programming Error 28.4** _Properties and instance variables that are not public will not be serialized as part of an object’s JSON representation._ 28.4

After the Item objects have been created and initialized with data from the database, lines 33 and 58 in Fig. 28.23 use the JavaScriptSerializer’s Serialize method to con-

**1** ' Fig. 28.24 Item.vb **2** ' A simple class to create objects to be converted into JSON format. **3** Imports Microsoft.VisualBasic **4** Public Class Item **5** Private descriptionValue As String ' the item’s description **6** Private idValue As String ' the item’s id **7 8** ' Default constructor **9** Public Sub New()

**10** End Sub 'New **11 12** ' constructor that initializes id and description **13** Public Sub New(ByVal ident As String, ByVal descr As String) **14** id = ident **15** description = descr **16** End Sub 'New **17 18** ' property that encapsulates the description **19** Public Property description() As String **20** Get **21** Return descriptionValue **22** End Get **23** Set(ByVal value As String) **24** descriptionValue = value **25** End Set **26** End Property ' description **27 28** ' Property that encapsulates the id **29** Public Property id() As String **30** Get **31** Return idValue **32** End Get **33** Set(ByVal value As String) **34** idValue = value **35** End Set **36** End Property ' id. **37** End Class ' Item

**Fig. 28.24** | A simple class to create objects to be converted into JSON format.  

**1288** Chapter 28 Web Services

vert the objects into JSON strings. Then, lines 34 and 59 obtain a response object for the current client, using the Current property of the HttpContext object. Then we use this object to write the newly constructed JSON string as part of the response attribute, initi- ating the server response to the Ajax application in Fig. 15.11. To learn more about JSON visit our JSON Resource Center at www.deitel.com/JSON.

**28.9.2 Creating an ASP.NET REST-Based Web Service** We now show you how to create the CalendarService web service in Visual Web Devel- oper. In the following steps, you’ll create an **ASP.NET Web Service** project that executes on your computer’s local IIS web server. Note that when you run this web service on your local computer the Ajax application from Fig. 15.11 can interact with the service only if it is served from your local computer. We discuss this at the end of this section. To create the CalendarService web service in Visual Web Developer, perform the following steps:

**_Step 1: Creating the Project_** To begin, use Visual Web Developer create a project of type **ASP.NET Web Service**. Select **File > New Web Site…** to display the **New Web Site** dialog (Fig. 28.25). Select **ASP.NET Web Service** in the **Templates** pane. Select **HTTP** from the **Location** drop-down list to indicate that the files should be placed on a web server. By default, Visual Web Developer indicates that it will place the files on the local machine’s IIS web server in a virtual directory named WebSite (http://localhost/WebSite). Replace the name WebSite with CalendarSer-

vice for this example. Next, select **Visual Basic** from the **Language** drop-down list to in- dicate that you will use Visual Basic to build this web service.

**Fig. 28.25** | Creating an **ASP.NET Web Service** in Visual Web Developer  

28.9 REST-Based Web Services in ASP.NET **1289**

**_Step 2: Examining the Newly Created Project_** After you create the project, you should see the code-behind file Service.vb, which con- tains code for a simple web service (Fig. 28.26). If the code-behind file is not open, it can be opened by double clicking the file in the **App\_Code** directory from the **Solution Explor- er**. Visual Web Developer includes three Imports statements that are helpful for develop- ing web services (lines 1–3). By default, a new code-behind file defines a class named Service that is marked with the WebService and WebServiceBinding attributes (lines 5– 6). The class contains a sample web method named HelloWorld (lines 11–14). This meth- od is a placeholder that you will replace with your own method(s).

**_Step 3: Modifying and Renaming the Code-Behind File_** To create the CalendarService web service developed in this section, modify Service.vb

by replacing the sample code provided by Visual Web Developer with the code from the CalendarService code-behind file (Fig. 28.23). Then rename the file CalendarSer-

vice.vb (by right clicking the file in the **Solution Explorer** and choosing **Rename**). This code is provided in the examples directory for this chapter. You can download the exam- ples from www.deitel.com/books/iw3htp4/.

**_Step 4 Creating an Item Class_** Select **File > New File…** to display the **Add New Item** dialog. Select **Class** in the **Templates** pane and change the name of the file to Item.vb. Then paste the code for Item.vb

(Fig. 28.24) into the file.

**Fig. 28.26** | Code view of a web service.  

**1290** Chapter 28 Web Services

**_Step 5: Examining the ASMX File_** The **Solution Explorer** lists a Service.asmx file in addition to the code-behind file. A web service’s ASMX page, when accessed through a web browser, displays information about the web service’s methods and provides access to the web service’s WSDL information. However, if you open the ASMX file on disk, you will see that it actually contains only

<%@ WebService Language="vb" CodeBehind="~/App\_Code/Service.vb" Class="Service" %>

to indicate the programming language in which the web service’s code-behind file is writ- ten, the code-behind file’s location and the class that defines the web service. When you request the ASMX page through IIS, ASP.NET uses this information to generate the con- tent displayed in the web browser (i.e., the list of web methods and their descriptions).

**_Step 6: Modifying the ASMX File_** Whenever you change the name of the code-behind file or the name of the class that de- fines the web service, you must modify the ASMX file accordingly. Thus, after defining class CalendarService in the code-behind file CalendarService.vb, modify the ASMX file to contain the lines

<%@ WebService Language="vb" CodeBehind= "~/App\_Code/CalendarService.vb" Class="CalendarService" %>

**Error-Prevention Tip 28.1** _Update the web service’s ASMX file appropriately whenever the name of a web service’s code- behind file or the class name changes. Visual Web Developer creates the ASMX file, but does not automatically update it when you make changes to other files in the project._ 28.1

**_Step 7: Renaming the ASMX File_** The final step in creating the CalendarService web service is to rename the ASMX file CalendarService.asmx.

**_Step 8: Changing the Web.Config File to allow REST requests._** By default ASP.NET web services communicate with the client using SOAP. To make this service REST-based, we must change web.config file to allow REST requests. Open the web.config file from the **Solution Explorer** and paste the following code as a new element in the system.web element.

<webServices> <protocols>

<add name="HttpGet"/> <add name="HttpPost"/>

</protocols> </webServices>

**_Step 9: Adding the System.Web.Extensions Reference_** The JavaScriptSerializer class that we use to generate JSON strings, is part of the Ajax Extensions package. You can find information on installing and downloading ASP.NET Ajax in Section 25.9. After you have installed ASP.NET Ajax, right click the project name in the solution explorer and select **Add Reference...** to display the **Add Reference** window. Select System.Web.Extensions from the **.NET** tab and click **OK**.  

28.9 REST-Based Web Services in ASP.NET **1291**

**28.9.3 Adding Data Components to a Web Service** Next, you’ll use Visual Web Developer’s tools to configure a DataSet that allows our Web service to interact with the Calendar.mdf SQL Server 2005 Express database file. You can download Calendar.mdf with the rest of the code for this example at www.deitel.com/ books/iw3htp4. You’ll add a new DataSet to the project, then configure the DataSet’s TableAdapter using the **TableAdapter Configuration Wizard**. The wizard allows you to se- lect the data source (Calendar.mdf) and to create the SQL statements necessary to support the database operations discussed in Fig. 28.23’s description.

**_Step 1: Adding a DataSet to the Project_** Add a DataSet named CalendarDataSet to the project. Right click the **App\_Code** folder in the **Solution Explorer** and select **Add New Item…** from the pop-up menu. In the **Add New Item** dialog, select **DataSet**, specify CalendarDataSet.xsd in the **Name** field and click **Add**. This displays the CalendarDataSet in design view and opens the **TableAdapter Configura- tion Wizard**. When you add a DataSet to a project, the IDE creates appropriate Table-

Adapter classes for interacting with the database tables.

**_Step 2: Selecting the Data Source and Creating a Connection_** You’ll use the **TableAdapter Configuration Wizard** in the next several steps to configure a TableAdapter for manipulating the Events table in the Calendar.mdf database. Now, you must select the database. In the **TableAdapter Configuration Wizard**, click the **New Con- nection…** button to display the **Add Connection** dialog. In this dialog, specify **Microsoft SQL Server Database File** as the **Data source**, then click the **Browse…** button to display the **Select SQL Server Database File** dialog. Locate Calendar.mdf on your computer, select it and click the **Open** button to return to the **Add Connection** dialog. Click the **Test Connec- tion** button to test the database connection, then click **OK** to return to the **TableAdapter Configuration Wizard**. Click **Next >**, then click **Yes** when you are asked whether you would like to add the file to your project and modify the connection. Click **Next >** to save the connection string in the application configuration file.

**_Step 3: Opening the Query Builder and Adding the Events Table from Calendar.mdf_** You must specify how the TableAdapter will access the database. In this example, you’ll use SQL statements, so choose **Use SQL Statements**, then click **Next >**. Click **Query Build- er…** to display the **Query Builder** and **Add Table** dialogs. Before building a SQL query, you must specify the table(s) to use in the query. The Calendar.mdf database contains only one table, named Events. Select this table from the **Tables** tab and click **Add**. Click **Close** to close the **Add Table** dialog.

**_Step 4: Configuring a SELECT Query to Obtain a Specific Event_** Now let’s create a query which selects an event with a particular ID. Select **ID** and **Descrip- tion** from the **Events** table at the top of the **Query Builder** dialog. Next, specify the criteria for selecting seats. In the **Filter** column of the **ID** row specify =@id to indicate that this filter value also will be specified as a method argument. The **Query Builder** dialog should now appear as shown in Fig. 28.27. Click **OK** to close the **Query Builder** dialog. Click **Next >** to choose the names of the methods to generate. Name the Fill method FillById. Click the **Finish** button to generate this method.  

**1292** Chapter 28 Web Services

**_Step 5: Adding Another Query to the EventsTableAdapter for the CalendarDataSet_** Now, you’ll create an UPDATE query that modifies a description of a specific event. In the design area for the CalendarDataSet, click **EventsTableAdapter** to select it, then right click it and select **Add Query…** to display the **TableAdapter Query Configuration Wizard**. Select **Use SQL Statements** and click **Next >**. Select **Update** as the query type and click **Next >**. Clear the text field and click **Query Builder…** to display the **Query Builder** and **Add Table** dialogs. Then add the Events table as you did in _Step 3_ and click **Close** to return to the **Query Builder** dialog.

**_Step 6: Configuring an UPDATE Statement to Modify a Description of a Specific Event_** In the **Query Builder** dialog, select the **Description** column from the **Events** table at the top of the dialog. In the middle of the dialog, place the @descr in the **New Value** column for the **Description** row to indicate that the new description will be specified as an argument to the method that implements this query. In the row below **Description**, select **ID** and specify @id as the **Filter** value to indicate that the ID will be specified as an argument to the method that implements this query. The **Query Builder** dialog should now appear as shown in Fig. 28.28. Click **OK** to return to the **TableAdapter Query Configuration Wizard**. Then click **Next >** to choose the name of the update method. Name the method UpdateDe-

scription, then click **Finish** to close the **TableAdapter Query Configuration Wizard**.

**_Step 7: Adding a getItemsByDate Query_** Using similar techniques to _Steps 5–6_, add a query that selects all events that have a spec- ified date. Name the query FillByDate.

**Fig. 28.27** | **QueryBuilder** dialog specifying a SELECT query that selects an event with a specific ID.  

28.9 REST-Based Web Services in ASP.NET **1293**

**_Step 8: Testing the Web Service_** At this point, you can use the CalendarService.asmx page to test the web service’s meth- ods. To do so, select **Start Without Debugging** from the **Debug** menu. Figure 28.29 shows the test page that is displayed for this web service when you run the web service applica- tion.

**Fig. 28.28** | **QueryBuilder** specifying an UPDATE statement used to modify a description.

**Fig. 28.29** | The test page for the CalendarService web service. (Part 1 of 2.)  

**1294** Chapter 28 Web Services

Calling a REST-based web service is simpler than calling SOAP web services demon- strated earlier. Fig. 28.29 shows that you can invoke the web service directly from your browser. For example, if you type the URL http://localhost/calendarService/

calendarService.asmx/getItemById?id=1 the browser will invoke the method get-

ItemById and retrieve the event with the id value 1. The client side interface for this application is implemented in the Ajax chapter, in

Fig 15.11. Because our Calendar application uses the Dojo Toolkit, you must have Dojo installed on your computer. Download Dojo 0.4.3 from dojotoolkit.org/downloads, extract the Dojo directory and rename it to dojo043. Then place the CalendarService

folder that contains your web service, the dojo043 folder that contains the Dojo toolkit and the Calendar.html file in the same directory in the root directory of your web server.

Run the web service and direct your browser to the location of the Calendar.html

file. We populated the database only with events for July 2007, so the calendar is coded to always display July 2007 when the application is loaded. To test whether the web service works click a few dates like the fourth of July, the sixth of July or the twentieth of July for which events exist in the Calendar database

**28.10 Wrap-Up** This chapter introduced JAX-WS 2.0 SOAP-based web services and ASP.NET REST- based web services. You learned that web services promote software portability and reus- ability in applications that operate over the Internet. You also learned that a web service is a software component stored on one computer that can be accessed by an application (or other software component) on another computer over a network, communicating via such technologies as XML, SOAP and HTTP. We discussed several benefits of this kind of dis- tributed computing—e.g., clients can access data on remote machines, clients lacking the processing power to perform specific computations can leverage remote machines’ re- sources and entirely new types of innovative applications can be developed.

We explained how Netbeans and the JAX-WS 2.0 APIs facilitate the creation and consumption of JAX-WS web services. We showed how to set up projects and files in these tools and how the tools manage the web service infrastructure necessary to support the web services you create. You learned how to define web services and web methods, as well as how to consume them both from Java desktop applications and from web applications cre- ated in Netbeans. After explaining the mechanics of web services with our HugeInteger

**Fig. 28.29** | The test page for the CalendarService web service. (Part 2 of 2.)  

28.11 Web Resources **1295**

example, we demonstrated more sophisticated web services that use session tracking in both the server side and the client side, and web services that access databases using JDBC. We also explained XML serialization and showed how to pass objects of user-defined types to web services and return them from web services. Finally, we discussed how to build a REST-based web service in ASP.NET with Microsoft’s Visual Web Developer Express.

**28.11 Web Resources** www.deitel.com/WebServices/

Visit our Web Services Resource Center for information on designing and implementing web ser- vices in many languages, and information about web services offered by companies such as Google, Amazon and eBay. You’ll also find many additional Java tools for publishing and consuming web services. www.deitel.com/java/ www.deitel.com/JavaSE6Mustang/ www.deitel.com/JavaEE5/ www.deitel.com/JavaCertification/ www.deitel.com/JavaDesignPatterns/

Our Java Resource Centers provide Java-specific information, such as books, papers, articles, jour- nals, websites and blogs that cover a broad range of Java topics (including Java web services). www.deitel.com/ResourceCenters.html

Check out our growing list of Resource Centers on programming, Web 2.0, software and other in- teresting topics. java.sun.com/webservices/jaxws/index.jsp

The official site for the Sun Java API for XML Web Services (JAX-WS). Includes the API, docu- mentation, tutorials and other useful links. www.webservices.org

Provides industry-related news, articles and resources for web services. www-130.ibm.com/developerworks/webservices

IBM’s site for service-oriented architecture (SOA) and web services includes articles, downloads, demos and discussion forums regarding web services technology. www.w3.org/TR/wsdl

Provides extensive documentation on WSDL, including a thorough discussion of web services and related technologies such as XML, SOAP, HTTP and MIME types in the context of WSDL. www.w3.org/TR/soap

Provides extensive documentation on SOAP messages, using SOAP with HTTP and SOAP security issues. www.ws-i.org

The Web Services Interoperability Organization’s website provides detailed information regarding building web services based on standards that promote interoperability and true platform indepen- dence. webservices.xml.com/security

Articles about web services security and standard security protocols.

**_REST-Based Web Services_** en.wikipedia.org/wiki/REST

Wikipedia resource explaining Representational State Transfer (REST). www.xfront.com/REST-Web-Services.html

Article entitled “Building Web Services the REST Way.”  

**1296** Chapter 28 Web Services

www.ics.uci.edu/~fielding/pubs/dissertation/rest\_arch\_style.htm

The dissertation that originally proposed the concept of REST-based services. rest.blueoxen.net/cgi-bin/wiki.pl?ShortSummaryOfRest

A short introduction to REST. www.prescod.net/rest

Links to many REST resources.

**Summary _Section 28.1 Introduction_** • A web service is a software component stored on one computer that can be accessed via method

calls by an application (or other software component) on another computer over a network.

• Web services communicate using such technologies as XML and HTTP.

• The Simple Object Access Protocol (SOAP) is an XML-based protocol that allows web services and clients to communicate in a platform-independent manner.

• Web services enable businesses to conduct transactions via standardized, widely available web ser- vices rather than relying on proprietary applications.

• Companies such as Amazon, Google, eBay, PayPal and many others are using web services to their advantage by making their server-side applications available to partners via web services.

• By purchasing web services and using extensive free web services, companies can spend less time developing new applications and can create innovative new applications.

• Netbeans is one of the many tools that enable programmers to “publish” and/or “consume” web services.

**_Section 28.2 Java Web Services Basics_** • The computer on which a web service resides is referred to as a remote machine or server. A client

application that accesses a web service sends a method call over a network to the remote machine, which processes the call and returns a response over the network to the application.

• In Java, a web service is implemented as a class. The class that represents the web service resides on a server—it’s not part of the client application.

• Making a web service available to receive client requests is known as publishing a web service; using a web service from a client application is known as consuming a web service.

• An application that consumes a web service consists of two parts—an object of a proxy class for interacting with the web service and a client application that consumes the web service by invok- ing methods on the proxy object. The proxy object handles the details of communicating with the web service on the client’s behalf.

• Requests to and responses from web services created with JAX-WS 2.0 are typically transmitted via SOAP. Any client capable of generating and processing SOAP messages can interact with a web service, regardless of the language in which the web service is written.

**_Section 28.3.1 Creating a Web Application Project and Adding a Web Service Class in Netbeans_** • When you create a web service in Netbeans, you focus on the logic of the web service and let the

IDE handle the web service’s infrastructure.

• To create a web service in Netbeans, you first create a project of type **Web Application**. Netbeans uses this project type for web applications that execute in browser-based clients and for web ser- vices that are invoked by other applications.  

Summary **1297**

• When you create a **Web Application** in Netbeans, the IDE generates additional files that support the web application.

**_Section 28.3.2 Defining the HugeInteger Web Service in Netbeans_** • By default, each new web service class created with the JAX-WS APIs is a POJO (plain old Java

object)—you do not need to extend a class or implement an interface to create a web service.

• When you compile a class that uses these JAX-WS 2.0 annotations, the compiler creates the com- piled code framework that allows the web service to wait for and respond to client requests.

• The @WebService annotation indicates that a class represents a web service. Optional element name specifies the name of the proxy class that will be generated for the client. Optional element serviceName specifies the name of the class that the client uses to obtain a proxy object.

• Netbeans places the @WebService annotation at the beginning of each new web service class you create. You can add the optional name and serviceName elements in the annotation’s parentheses.

• Methods that are tagged with the @WebMethod annotation can be called remotely.

• Methods that are not tagged with @WebMethod are not accessible to clients that consume the web service. Such methods are typically utility methods within the web service class.

• The @WebMethod annotation has an optional operationName element to specify the method name that is exposed to the web service’s client.

• Parameters of web methods are annotated with the @WebParam annotation. The optional element name indicates the parameter name that is exposed to the web service’s clients.

**_Section 28.3.3 Publishing the HugeInteger Web Service from Netbeans_** • Netbeans handles all the details of building and deploying a web service for you. This includes

creating the framework required to support the web service.

• To determine if there are any compilation errors in your project, right click the project name in the Netbeans **Projects** tab, then select the **Build Project** option.

• Select **Deploy Project** to deploy the project to the server you selected during application setup.

• Select **Run Project** to execute the web application.

• Both the **Deploy Project** and **Run Project** options also build the project if it has changed and start the application server if it is not already running.

• To ensure that all source-code files in a project are recompiled during the next build operation, you can use the **Clean Project** or **Clean and Build Project** options.

**_Section 28.3.4 Testing the HugeInteger Web Service with Sun Java System Applica- tion Server’s Tester Web Page_** • Sun Java System Application Server can dynamically create a Tester web page for testing a web

service’s methods from a web browser. You can enable this feature via the project’s **Run** options.

• To display the Tester web page, run the web application from Netbeans or type the URL of the web service in the browser’s address field followed by ?Tester.

• A client can access a web service only when the application server is running. If Netbeans launch- es the application server for you, the server will shut down when you close Netbeans. To keep the application server up and running, you can launch it independently of Netbeans.

**_Section 28.3.5 Describing a Web Service with the Web Service Description Language (WSDL)_** • To consume a web service, a client must know where to find the web service and must be pro-

vided with the web service’s description.  

**1298** Chapter 28 Web Services

• JAX-WS uses the Web Service Description Language (WSDL)—a standard XML vocabulary for describing web services in a platform-independent manner.

• You do not need to understand WSDL to take advantage of it—the server generates a web ser- vice’s WSDL dynamically for you, and client tools can parse the WSDL to help create the client- side proxy class that a client uses to access the web service.

• Since the WSDL is created dynamically, clients always receive a deployed web service’s most up- to-date description.

• To view the WSDL for a web service, type its URL in the browser’s address field followed by ?WSDL or click the **WSDL File** link in the Sun Java System Application Server’s Tester web page.

**_Section 28.4 Consuming a Web Service_** • A web service client can be any type of application or even another web service.

• In Netbeans, you enable a client application to consume a web service by adding a web service reference to the application, which defines the client-side proxy class.

**_Section 28.4.1 Creating a Client in Netbeans to Consume the HugeInteger Web Service_** • When you add a web service reference, the IDE creates and compiles the client-side artifacts—

the framework of Java code that supports the client-side proxy class.

• The client calls methods on a proxy object, which uses the client-side artifacts to interact with the web service.

• To add a web service reference, right click the client project name in the Netbeans **Projects** tab, then select **New > Web Service Client…**. In the dialog’s **WSDL URL** field, specify the URL of the web service’s WSDL.

• Netbeans uses the WSDL description to generate the client-side proxy class and artifacts.

• When you specify the web service you want to consume, Netbeans copies the web service’s WSDL into a file in your project. You can view this file from the Netbeans **Files** tab by expanding the nodes in the project’s xml-resources folder.

• The client-side artifacts and the client’s copy of the WSDL file can be regenerated by right click- ing the web service’s node in the Netbeans **Projects** tab and selecting **Refresh Client**.

• You can view the IDE-generated client-side artifacts by selecting the Netbeans **Files** tab and ex- panding the project’s build folder.

**_Section 28.5 SOAP_** • SOAP is a commonly used, platform-independent, XML-based protocol that facilitates remote

procedure calls, typically over HTTP.

• The protocol that transmits request-and-response messages is also known as the web service’s wire format or wire protocol, because it defines how information is sent “along the wire.”

• Each request and response is packaged in a SOAP message (also known as a SOAP envelope) con- taining the information that a web service requires to process the message.

• The wire format used to transmit requests and responses must support all types passed between the applications. SOAP supports primitive types and their wrapper types, as well as Date, Time and others. SOAP can also transmit arrays and objects of user-defined types.

• When a program invokes a web method, the request and all relevant information are packaged in a SOAP message and sent to the server on which the web service resides. The web service pro- cesses the SOAP message’s contents, which specify the method to invoke and its arguments. After the web service receives and parses a request, the proper method is called, and the response is sent  

Summary **1299**

back to the client in another SOAP message. The client-side proxy parses the response, which contains the result of the method call, and returns the result to the client application.

• The SOAP messages are generated for you automatically. So you don’t need to understand the details of SOAP or XML to take advantage of it when publishing and consuming web services.

**_Section 28.6 Session Tracking in Web Services_** • Storing session information also enables a web service to distinguish between clients and elimi-

nates the need to pass client information between the client and the web service multiple times.

**_Section 28.6.1 Creating a Blackjack Web Service_** • To use session tracking in a web service, you must include code for the resources that maintain

the session state information. In the past, you had to write the sometimes tedious code to create these resources. JAX-WS, however, handles this for you via the @Resource annotation. This an- notation enables tools like Netbeans to “inject” complex support code into your class, thus al- lowing you to focus on your business logic rather than the support code.

• Using annotations to add code that supports your classes is known as dependency injection. An- notations like @WebService, @WebMethod and @WebParam also perform dependency injection.

• A WebServiceContext object enables a web service to access and maintain information for a spe- cific request, such as session state. The code that creates a WebServiceContext object is injected into the class by an @Resource annotation.

• The WebServiceContext object is used to obtain a MessageContext object. A web service uses a MessageContext to obtain an HttpSession object for the current client.

• The MessageContext object’s get method is used to obtain the HttpSession object for the cur- rent client. Method get receives a constant indicating what to get from the MessageContext. The constant MessageContext.SERVLET\_REQUEST indicates that we’d like to get the HttpServlet-

Request object for the current client. We then call method getSession to get the HttpSession

object from the HttpServletRequest object.

• HttpSession method getAttribute receives a String that identifies the Object to obtain from the session state.

**_Section 28.6.2 Consuming the Blackjack Web Service_** • In the JAX-WS 2.0 framework, the client must indicate whether it wants to allow the web service

to maintain session information. To do this, first cast the proxy object to interface type Binding- Provider. A BindingProvider enables the client to manipulate the request information that will be sent to the server. This information is stored in an object that implements interface Request- Context. The BindingProvider and RequestContext are part of the framework that is created by the IDE when you add a web service client to the application.

• Next, invoke the BindingProvider’s getRequestContext method to obtain the RequestContext

object. Then call the RequestContext’s put method to set the property BindingProvid-

er.SESSION\_MAINTAIN\_PROPERTY to true, which enables session tracking from the client side so that the web service knows which client is invoking the service’s web methods.

**_Section 28.8 Passing an Object of a User-Defined Type to a Web Service_** • Web services can receive and return objects of user-defined types—known as custom types.

• Custom types that are sent to or from a web service using SOAP are serialized into XML format. This process is referred to as XML serialization and is handled for you automatically.

• A class that is used to specify parameter or return types in web methods must provide a public

default or no-argument constructor. Also, any instance variables that should be serialized must have public _set_ and _get_ methods or the instance variables must be declared public.  

**1300** Chapter 28 Web Services

• Any instance variable that is not serialized simply receives its default value (or the value provided by the no-argument constructor) when an object of the class is deserialized.

**Terminology** AbstractPageBean class adding a web service reference to a project in

Netbeans Apache Tomcat server application server B2B (business-to-business) transactions BEA Weblogic Server BindingProvider interface **Build Project** option in Netbeans business-to-business (B2B) transactions **Clean and Build Project** option in Netbeans **Clean Project** option in Netbeans client-side artifacts consume a web service custom type dependency injection **Deploy Project** option in Netbeans deploy a web service get method of interface MessageContext

getRequestContext method of interface BindingProvider

GlassFish server JAX-WS 2.0 JBoss Application Server MessageContext interface Netbeans 5.5 IDE **New Project** dialog in Netbeans **New Web Service Client** dialog in Netbeans **New Web Service** dialog in Netbeans parse a SOAP message POJO (plain old Java object) **Project Properties** dialog in Netbeans proxy class for a web service proxy object handles the details of

communicating with the web service

publish a web service put method of interface RequestContext

remote machine Representational State Transfer (REST) RequestContext interface @Resource annotation REST (Representational State Transfer) **Run Project** option in Netbeans server-side artifacts session tracking in web services SOAP envelope SOAP message SOAP (Simple Object Access Protocol) Sun Java System Application Server Sun Java System Application Server Tester web

page test a web service **Web Application** project in Netbeans Web Service Description Language (WSDL) web service reference Web Services Interoperability Organization

(WS-I) @WebMethod annotation @WebMethod annotation operationName element @WebParam annotation @WebParam annotation name element @WebService annotation @WebService annotation name element @WebService annotation serviceName element WebServiceContext interface wire format wire protocol WS-I Basic Profile 1.1 (BP 1.1) XML serialization

**Self-Review Exercises 28.1** State whether each of the following is _true_ or _false_. If _false_, explain why.

a) All methods of a web service class can be invoked by clients of that web service. b) When consuming a web service in a client application created in Netbeans, you must

create the proxy class that enables the client to communicate with the web service. c) A proxy class communicating with a web service normally uses SOAP to send and re-

ceive messages. d) Session tracking is automatically enabled in a client of a web service. e) Web methods cannot be declared static.  

Answers to Self-Review Exercises **1301**

f) A user-defined type used in a web service must define both _get_ and _set_ methods for any property that will be serialized.

g) RESTful web services are implemented using web standards, such as HTTP, XML and JSON.

**28.2** Fill in the blanks for each of the following statements: a) When messages are sent between an application and a web service using SOAP, each

message is placed in a(n) . b) refers to an architectural style for implementing web services. c) A web service in Java is a(n) —it does not need to implement any interfaces or

extend any classes. d) Web service requests are typically transported over the Internet via the protocol. e) To set the exposed name of a web method, use the element of the @WebMethod

annotation. f) transforms an object into a format that can be sent between a web service and

a client.

**Answers to Self-Review Exercises 28.1** a) False. Only methods declared with the @WebMethod annotation can be invoked by a web service’s clients. b) False. The proxy class is created by Netbeans when you add a web service client to the application. c) True. d) False. In the JAX-WS 2.0 framework, the client must indicate wheth- er it wants to allow the web service to maintain session information. First, you must cast the proxy object to interface type BindingProvider, then use the BindingProvider’s getRequestContext

method to obtain the RequestContext object. Finally, you must use the RequestContext’s put meth- od to set the property BindingProvider.SESSION\_MAINTAIN\_PROPERTY to true. e) True. f) False. You may also declare an instance variable as public. g) true.

**28.2** a) SOAP message or SOAP envelope. b) Representational State Transfer (REST). c) POJO (plain old Java object) d) HTTP. e) operationName. f) XML serialization.

**Exercises 28.3** _(Phone Book Web Service)_ Create a web service that stores phone book entries in the database PhoneBookDB and a web client application that consumes this service. Use the steps in Section 28.7.1 to create the PhoneBook database. The database should contain one table—PhoneBook—with three columns—LastName, FirstName and PhoneNumber—each of type VARCHAR. The LastName and FirstName columns should store up to 30 characters. The PhoneNumber column should support phone numbers of the form (800) 555-1212 that contain 14 characters.

Give the client user the capability to enter a new contact (web method addEntry) and to find contacts by last name (web method getEntries). Pass only Strings as arguments to the web ser- vice. The getEntries web method should return an array of Strings that contains the matching phone book entries. Each String in the array should consist of the last name, first name and phone number for one phone book entry. These values should be separated by commas.

The SELECT query that will find a PhoneBook entry by last name should be:

SELECT LastName, FirstName, PhoneNumber FROM PhoneBook WHERE (LastName = _LastName_)

The INSERT statement that inserts a new entry into the PhoneBook database should be:

INSERT INTO PhoneBook (LastName, FirstName, PhoneNumber) VALUES (_LastName_, _FirstName_, _PhoneNumber_)  

**1302** Chapter 28 Web Services

**28.4** _(Phone Book Web Service Modification)_ Modify Exercise 28.3 so that it uses a class named PhoneBookEntry to represent a row in the database. The client application should provide objects of type PhoneBookEntry to the web service when adding contacts and should receive objects of type PhoneBookEntry when searching for contacts.

**28.5** _(Blackjack Web Service Modification)_ Modify the blackjack web service example in Section 28.6 to include class Card. Modify web method dealCard so that it returns an object of type Card and modify web method getHandValue so that it receives an array of Card objects from the cli- ent. Also modify the client application to keep track of what cards have been dealt by using ArrayLists of Card objects. The proxy class created by Netbeans will treat a web method’s array pa- rameter as a List, so you can pass these ArrayLists of Card objects directly to the getHandValue

method. Your Card class should include _set_ and _get_ methods for the face and suit of the card.